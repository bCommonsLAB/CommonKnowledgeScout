{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"index.html","title":"Common Knowledge Scout Documentation","text":"<p>Welcome to the Common Knowledge Scout documentation.</p>"},{"location":"index.html#quick-start","title":"Quick Start","text":"<ul> <li>Use Cases - Step-by-step guides for common tasks</li> <li>Architecture - System architecture and module structure</li> <li>Reference - Complete file index and API reference</li> </ul>"},{"location":"index.html#documentation-structure","title":"Documentation Structure","text":""},{"location":"index.html#use-cases","title":"Use Cases","text":"<p>Practical guides for end users: - Library Setup - File Transformation (PDF, Audio, Video) - Web Scraping &amp; Event Import - Publishing &amp; Gallery - Chat &amp; Story Mode - Batch Operations</p>"},{"location":"index.html#architecture","title":"Architecture","text":"<p>System design and module documentation: - Module Hierarchy - Dependency Graph</p>"},{"location":"index.html#reference","title":"Reference","text":"<p>Technical reference documentation: - File Index - Module Documentation (Storage, Library, Chat)</p>"},{"location":"index.html#getting-help","title":"Getting Help","text":"<p>For detailed technical information, see the Reference Documentation.</p>"},{"location":"github-branch-protection-setup.html","title":"GitHub Branch Protection Setup - Schritt-f\u00fcr-Schritt Anleitung","text":"<p>Diese Anleitung erkl\u00e4rt, wie du Branch Protection Rules f\u00fcr den <code>master</code>-Branch einrichtest, sodass nur du direkt committen kannst, w\u00e4hrend GitHub Actions weiterhin automatisch pushen k\u00f6nnen.</p>"},{"location":"github-branch-protection-setup.html#voraussetzungen","title":"Voraussetzungen","text":"<ul> <li>\u2705 Repository auf GitHub erstellt</li> <li>\u2705 Repository als \u00f6ffentlich gesetzt</li> <li>\u2705 Lokales Repository mit GitHub verbunden</li> <li>\u2705 Du bist Repository-Owner oder hast Admin-Rechte</li> </ul>"},{"location":"github-branch-protection-setup.html#schritt-1-repository-auf-github-veroffentlichen","title":"Schritt 1: Repository auf GitHub ver\u00f6ffentlichen","text":""},{"location":"github-branch-protection-setup.html#11-repository-erstellen-falls-noch-nicht-vorhanden","title":"1.1 Repository erstellen (falls noch nicht vorhanden)","text":"<ol> <li>Gehe zu GitHub</li> <li>Klicke auf \"+\" (oben rechts) \u2192 \"New repository\"</li> <li>Repository-Name: <code>CommonKnowledgeScout</code></li> <li>Owner: <code>bCommonsLAB</code></li> <li>Beschreibung: \"Common Knowledge Scout - Modern Document Management System\"</li> <li>Wichtig: W\u00e4hle \"Public\" aus</li> <li>NICHT \"Initialize with README\" aktivieren (du hast bereits ein lokales Repo)</li> <li>Klicke auf \"Create repository\"</li> </ol>"},{"location":"github-branch-protection-setup.html#12-lokales-repository-mit-github-verbinden","title":"1.2 Lokales Repository mit GitHub verbinden","text":"<p>Falls noch nicht geschehen, f\u00fchre im Terminal aus:</p> <pre><code># Pr\u00fcfe, ob remote bereits existiert\ngit remote -v\n\n# Falls nicht vorhanden, f\u00fcge GitHub-Repository hinzu\ngit remote add origin https://github.com/bCommonsLAB/CommonKnowledgeScout.git\n\n# Oder falls bereits vorhanden, aktualisiere die URL\ngit remote set-url origin https://github.com/bCommonsLAB/CommonKnowledgeScout.git\n\n# Pushe alle Branches und Tags\ngit push -u origin --all\ngit push -u origin --tags\n</code></pre>"},{"location":"github-branch-protection-setup.html#schritt-2-branch-protection-rules-einrichten","title":"Schritt 2: Branch Protection Rules einrichten","text":""},{"location":"github-branch-protection-setup.html#21-navigation-zu-den-branch-settings","title":"2.1 Navigation zu den Branch Settings","text":"<ol> <li>Gehe zu deinem Repository auf GitHub: <code>https://github.com/bCommonsLAB/CommonKnowledgeScout</code></li> <li>Klicke auf \"Settings\" (oben im Repository-Men\u00fc)</li> <li>Im linken Men\u00fc: \"Branches\" (unter \"Code and automation\")</li> </ol>"},{"location":"github-branch-protection-setup.html#22-branch-protection-rule-erstellen","title":"2.2 Branch Protection Rule erstellen","text":"<ol> <li>Unter \"Branch protection rules\" findest du einen Button \"Add rule\" \u2192 Klicke darauf</li> <li>Im Feld \"Branch name pattern\" gib ein: <code>master</code></li> <li>Es erscheint eine Vorschau: \"This rule will apply to: 1 branch\"</li> </ol>"},{"location":"github-branch-protection-setup.html#23-wichtige-einstellungen-konfigurieren","title":"2.3 Wichtige Einstellungen konfigurieren","text":""},{"location":"github-branch-protection-setup.html#option-1-restrict-who-can-push-to-matching-branches","title":"\u2705 Option 1: \"Restrict who can push to matching branches\"","text":"<p>Das ist die Hauptregel f\u00fcr deinen Anwendungsfall!</p> <ol> <li>Aktiviere das Kontrollk\u00e4stchen: \"Restrict who can push to matching branches\"</li> <li>Klicke auf \"Select people and teams\"</li> <li>Suche nach deinem GitHub-Username (z. B. <code>peter-aichner</code> oder wie auch immer dein GitHub-Username lautet)</li> <li>W\u00e4hle dich selbst aus</li> <li>Klicke auf \"Save changes\"</li> </ol> <p>Ergebnis: Nur du kannst jetzt direkt auf <code>master</code> pushen.</p>"},{"location":"github-branch-protection-setup.html#option-2-github-actions-bypass-einrichten","title":"\u2705 Option 2: GitHub Actions Bypass einrichten","text":"<p>Wichtig: Dein Workflow (<code>ci-main.yml</code>) pusht automatisch auf <code>master</code>. Damit das weiterhin funktioniert:</p> <ol> <li>Scrolle nach unten zu \"Rules applied to everyone including administrators\"</li> <li>Aktiviere: \"Allow specified actors to bypass required pull requests\"</li> <li>Klicke auf \"Select actors\"</li> <li>Suche nach: <code>github-actions[bot]</code></li> <li>W\u00e4hle <code>github-actions[bot]</code> aus</li> <li>Klicke auf \"Save changes\"</li> </ol> <p>Alternative: Falls die Option oben nicht verf\u00fcgbar ist: - Aktiviere: \"Allow force pushes\" \u2192 \"Specify who can force push\" \u2192 <code>github-actions[bot]</code> - Aktiviere: \"Allow deletions\" \u2192 \"Specify who can delete\" \u2192 <code>github-actions[bot]</code></p>"},{"location":"github-branch-protection-setup.html#option-3-do-not-allow-bypassing-the-above-settings","title":"\u2705 Option 3: \"Do not allow bypassing the above settings\"","text":"<p>Sehr wichtig f\u00fcr maximale Sicherheit:</p> <ol> <li>Aktiviere: \"Do not allow bypassing the above settings\"</li> <li>Wichtig: Stelle sicher, dass <code>github-actions[bot]</code> in den Bypass-Regeln enthalten ist, sonst funktionieren deine Workflows nicht mehr!</li> </ol>"},{"location":"github-branch-protection-setup.html#schritt-3-optionale-aber-empfohlene-einstellungen","title":"Schritt 3: Optionale, aber empfohlene Einstellungen","text":""},{"location":"github-branch-protection-setup.html#31-pull-request-requirements","title":"3.1 Pull Request Requirements","text":"<p>Falls du in Zukunft auch Pull Requests nutzen m\u00f6chtest:</p> <ol> <li>Aktiviere: \"Require a pull request before merging\"</li> <li>\"Require approvals\": <code>1</code></li> <li>\"Dismiss stale pull request approvals when new commits are pushed\": \u2705</li> <li>\"Require review from Code Owners\": Optional</li> </ol>"},{"location":"github-branch-protection-setup.html#32-status-checks","title":"3.2 Status Checks","text":"<p>Falls du automatische Checks einrichten m\u00f6chtest:</p> <ol> <li>Aktiviere: \"Require status checks to pass before merging\"</li> <li>\"Require branches to be up to date before merging\": \u2705</li> <li>W\u00e4hle die Checks aus, die durchlaufen m\u00fcssen (z. B. <code>lint-check</code>)</li> </ol>"},{"location":"github-branch-protection-setup.html#33-weitere-optionen","title":"3.3 Weitere Optionen","text":"<ul> <li>\"Require conversation resolution before merging\": \u2705 (empfohlen)</li> <li>\"Require linear history\": Optional</li> <li>\"Require signed commits\": Optional (erfordert GPG-Setup)</li> </ul>"},{"location":"github-branch-protection-setup.html#schritt-4-regel-speichern","title":"Schritt 4: Regel speichern","text":"<ol> <li>Scrolle nach oben oder unten</li> <li>Klicke auf \"Create\" (oder \"Save changes\" falls du eine bestehende Regel bearbeitest)</li> <li>Die Regel ist jetzt aktiv!</li> </ol>"},{"location":"github-branch-protection-setup.html#schritt-5-testen-der-konfiguration","title":"Schritt 5: Testen der Konfiguration","text":""},{"location":"github-branch-protection-setup.html#51-test-direkter-push-sollte-funktionieren","title":"5.1 Test: Direkter Push (sollte funktionieren)","text":"<pre><code># Erstelle einen Test-Commit\necho \"# Test\" &gt;&gt; TEST.md\ngit add TEST.md\ngit commit -m \"Test: Branch Protection\"\ngit push origin master\n</code></pre> <p>Erwartetes Ergebnis: \u2705 Push sollte erfolgreich sein (du bist der erlaubte User)</p>"},{"location":"github-branch-protection-setup.html#52-test-github-actions-sollte-funktionieren","title":"5.2 Test: GitHub Actions (sollte funktionieren)","text":"<ol> <li>Gehe zu \"Actions\" im Repository</li> <li>F\u00fchre den Workflow <code>ci-master</code> manuell aus (falls <code>workflow_dispatch</code> aktiviert ist)</li> <li>Oder pushe einen Commit, der den Workflow triggert</li> </ol> <p>Erwartetes Ergebnis: \u2705 Workflow sollte erfolgreich pushen k\u00f6nnen (dank Bypass-Regel)</p>"},{"location":"github-branch-protection-setup.html#53-test-anderer-user-sollte-fehlschlagen","title":"5.3 Test: Anderer User (sollte fehlschlagen)","text":"<p>Falls du einen zweiten GitHub-Account hast oder jemand anderes testet:</p> <pre><code># Als anderer User versuchen zu pushen\ngit push origin master\n</code></pre> <p>Erwartetes Ergebnis: \u274c Push sollte mit Fehler fehlschlagen: <pre><code>remote: error: GH006: Protected branch update failed for refs/heads/master.\nremote: error: You are not allowed to push code to master in this repository\n</code></pre></p>"},{"location":"github-branch-protection-setup.html#schritt-6-workflow-berechtigungen-prufen","title":"Schritt 6: Workflow-Berechtigungen pr\u00fcfen","text":"<p>Dein Workflow (<code>ci-main.yml</code>) hat bereits die richtigen Berechtigungen:</p> <pre><code>permissions:\n  contents: write  # \u2705 Erlaubt das Pushen\n</code></pre> <p>Das ist korrekt! Keine \u00c4nderungen n\u00f6tig.</p>"},{"location":"github-branch-protection-setup.html#zusammenfassung-der-finalen-konfiguration","title":"Zusammenfassung der finalen Konfiguration","text":"<pre><code>Branch: master\n\n\u2705 Restrict who can push to matching branches\n   \u2192 Nur: [Dein GitHub-Username]\n\n\u2705 Allow specified actors to bypass required pull requests\n   \u2192 github-actions[bot]\n\n\u2705 Do not allow bypassing the above settings\n   \u2192 Aktiviert\n\nOptional:\n\u2705 Require a pull request before merging\n\u2705 Require status checks to pass before merging\n\u2705 Require conversation resolution before merging\n</code></pre>"},{"location":"github-branch-protection-setup.html#troubleshooting","title":"Troubleshooting","text":""},{"location":"github-branch-protection-setup.html#problem-github-actions-konnen-nicht-pushen","title":"Problem: GitHub Actions k\u00f6nnen nicht pushen","text":"<p>L\u00f6sung: 1. Gehe zu Settings \u2192 Branches 2. \u00d6ffne die <code>master</code>-Regel 3. Pr\u00fcfe, ob <code>github-actions[bot]</code> in den Bypass-Regeln enthalten ist 4. Falls nicht, f\u00fcge es hinzu</p>"},{"location":"github-branch-protection-setup.html#problem-do-not-allow-bypassing-blockiert-github-actions","title":"Problem: \"Do not allow bypassing\" blockiert GitHub Actions","text":"<p>L\u00f6sung: - Stelle sicher, dass <code>github-actions[bot]</code> vor dem Aktivieren von \"Do not allow bypassing\" hinzugef\u00fcgt wurde - Die Bypass-Regel muss explizit <code>github-actions[bot]</code> enthalten</p>"},{"location":"github-branch-protection-setup.html#problem-ich-kann-selbst-nicht-pushen","title":"Problem: Ich kann selbst nicht pushen","text":"<p>L\u00f6sung: 1. Pr\u00fcfe, ob dein GitHub-Username korrekt in \"Restrict who can push\" eingetragen ist 2. Pr\u00fcfe, ob du Repository-Admin-Rechte hast 3. Pr\u00fcfe, ob \"Do not allow bypassing\" aktiviert ist und du trotzdem in der Liste stehst</p>"},{"location":"github-branch-protection-setup.html#nachste-schritte","title":"N\u00e4chste Schritte","text":"<p>Nach erfolgreicher Einrichtung:</p> <ol> <li>\u2705 Repository ist \u00f6ffentlich</li> <li>\u2705 Nur du kannst auf <code>master</code> committen</li> <li>\u2705 GitHub Actions k\u00f6nnen weiterhin automatisch pushen</li> <li>\u2705 Andere k\u00f6nnen das Repository forken und Pull Requests erstellen</li> <li>\u2705 Lizenz-Dateien sind vorhanden (LICENSE, LICENSE_CONTENT.txt)</li> </ol> <p>Das Repository ist jetzt bereit f\u00fcr die Open-Source-Ver\u00f6ffentlichung! \ud83c\udf89</p>"},{"location":"github-branch-protection-setup.html#referenzen","title":"Referenzen","text":"<ul> <li>GitHub Docs: About protected branches</li> <li>GitHub Docs: Configuring protected branches</li> <li>GitHub Docs: Bypassing branch protection</li> </ul>"},{"location":"mongodb-indexes.html","title":"MongoDB Indexe f\u00fcr QueryLog Collection","text":""},{"location":"mongodb-indexes.html#ubersicht","title":"\u00dcbersicht","text":"<p>Die <code>queries</code> Collection verwendet mehrere optimierte Indexe f\u00fcr schnelle Cache-Abfragen.</p>"},{"location":"mongodb-indexes.html#indexe","title":"Indexe","text":""},{"location":"mongodb-indexes.html#basis-indexe","title":"Basis-Indexe","text":"<ul> <li><code>queryId_unique</code>: Eindeutiger Index auf <code>queryId</code></li> <li><code>library_createdAt_desc</code>: Index auf <code>libraryId</code> und <code>createdAt</code> (absteigend)</li> <li><code>user_createdAt_desc</code>: Index auf <code>userEmail</code> und <code>createdAt</code> (absteigend)</li> <li><code>sessionId_createdAt_desc</code>: Index auf <code>sessionId</code> und <code>createdAt</code> (absteigend)</li> <li><code>chatId_createdAt_desc</code>: Index auf <code>chatId</code> und <code>createdAt</code> (absteigend)</li> </ul>"},{"location":"mongodb-indexes.html#cache-lookup-indexe-fur-toc-cache-abfragen","title":"Cache-Lookup-Indexe (f\u00fcr TOC-Cache-Abfragen)","text":""},{"location":"mongodb-indexes.html#fur-authentifizierte-nutzer","title":"F\u00fcr authentifizierte Nutzer","text":"<ul> <li><code>cache_lookup_user_toc</code>: Zusammengesetzter Index f\u00fcr vollst\u00e4ndige Cache-Abfragen</li> <li>Felder: <code>libraryId</code>, <code>question</code>, <code>userEmail</code>, <code>queryType</code>, <code>status</code>, <code>targetLanguage</code>, <code>character</code>, <code>socialContext</code>, <code>genderInclusive</code>, <code>retriever</code>, <code>createdAt</code></li> <li> <p>Partial Filter: Nur f\u00fcr Dokumente mit <code>userEmail</code></p> </li> <li> <p><code>cache_lookup_user_basic</code>: Fallback-Index f\u00fcr Basis-Abfragen</p> </li> <li>Felder: <code>libraryId</code>, <code>question</code>, <code>userEmail</code>, <code>queryType</code>, <code>status</code>, <code>createdAt</code></li> <li>Partial Filter: Nur f\u00fcr Dokumente mit <code>userEmail</code></li> </ul>"},{"location":"mongodb-indexes.html#fur-anonyme-nutzer","title":"F\u00fcr anonyme Nutzer","text":"<ul> <li><code>cache_lookup_session_toc</code>: Zusammengesetzter Index f\u00fcr vollst\u00e4ndige Cache-Abfragen</li> <li>Felder: <code>libraryId</code>, <code>question</code>, <code>sessionId</code>, <code>queryType</code>, <code>status</code>, <code>targetLanguage</code>, <code>character</code>, <code>socialContext</code>, <code>genderInclusive</code>, <code>retriever</code>, <code>createdAt</code></li> <li> <p>Partial Filter: Nur f\u00fcr Dokumente mit <code>sessionId</code></p> </li> <li> <p><code>cache_lookup_session_basic</code>: Fallback-Index f\u00fcr Basis-Abfragen</p> </li> <li>Felder: <code>libraryId</code>, <code>question</code>, <code>sessionId</code>, <code>queryType</code>, <code>status</code>, <code>createdAt</code></li> <li>Partial Filter: Nur f\u00fcr Dokumente mit <code>sessionId</code></li> </ul>"},{"location":"mongodb-indexes.html#index-uberprufung","title":"Index-\u00dcberpr\u00fcfung","text":""},{"location":"mongodb-indexes.html#indexe-in-mongodb-anzeigen","title":"Indexe in MongoDB anzeigen","text":"<pre><code>// In MongoDB Shell oder Compass\ndb.queries.getIndexes()\n</code></pre>"},{"location":"mongodb-indexes.html#index-performance-prufen","title":"Index-Performance pr\u00fcfen","text":"<pre><code>// Erkl\u00e4re eine Query, um zu sehen, welche Indexe verwendet werden\ndb.queries.find({\n  libraryId: \"...\",\n  question: \"...\",\n  userEmail: \"...\",\n  queryType: \"toc\",\n  status: { $in: [\"ok\", \"pending\"] }\n}).sort({ createdAt: -1 }).limit(1).explain(\"executionStats\")\n</code></pre>"},{"location":"mongodb-indexes.html#index-statistiken-anzeigen","title":"Index-Statistiken anzeigen","text":"<pre><code>// Zeige Statistiken f\u00fcr alle Indexe\ndb.queries.aggregate([{ $indexStats: {} }])\n</code></pre>"},{"location":"mongodb-indexes.html#performance-optimierung","title":"Performance-Optimierung","text":"<p>Die Cache-Abfragen verwenden: 1. Zusammengesetzte Indexe mit den h\u00e4ufigsten Filter-Feldern 2. Partial Filter Expressions, um Index-Gr\u00f6\u00dfe zu reduzieren 3. <code>limit(50)</code> in der Query, um die Anzahl der geladenen Dokumente zu begrenzen 4. Sortierung nach <code>createdAt: -1</code> f\u00fcr neueste Ergebnisse zuerst</p>"},{"location":"mongodb-indexes.html#wartung","title":"Wartung","text":"<p>Die Indexe werden automatisch beim ersten Zugriff auf die Collection erstellt. Falls Indexe manuell erstellt werden m\u00fcssen:</p> <pre><code>// In MongoDB Shell\ndb.queries.createIndex(\n  { \n    libraryId: 1, \n    question: 1, \n    userEmail: 1, \n    queryType: 1, \n    status: 1, \n    targetLanguage: 1,\n    character: 1,\n    socialContext: 1,\n    genderInclusive: 1,\n    retriever: 1,\n    createdAt: -1 \n  }, \n  { \n    name: 'cache_lookup_user_toc',\n    partialFilterExpression: { userEmail: { $exists: true } }\n  }\n)\n</code></pre>"},{"location":"mongodb-vector-search-index.html","title":"MongoDB Atlas Vector Search Index - Token-Indexe f\u00fcr Facetten","text":""},{"location":"mongodb-vector-search-index.html#problem","title":"Problem","text":"<p>MongoDB Atlas Vector Search ben\u00f6tigt Token-Indexe f\u00fcr Array-Felder (wie <code>authors</code>, <code>speakers</code>, <code>tags</code>), wenn diese in Filtern mit <code>$in</code>-Operatoren verwendet werden.</p> <p>Fehler: <code>Path 'authors' needs to be indexed as token</code></p>"},{"location":"mongodb-vector-search-index.html#losung","title":"L\u00f6sung","text":""},{"location":"mongodb-vector-search-index.html#fur-neue-indexe","title":"F\u00fcr neue Indexe","text":"<p>Neue Vector Search Indexe werden automatisch mit allen ben\u00f6tigten Token-Indexen erstellt. Die folgenden Felder sind standardm\u00e4\u00dfig als Token-Indexe definiert:</p> <p>Basis-Filter-Felder (immer als Token-Indexe): - <code>kind</code> (Token) - F\u00fcr Filterung nach Dokument-Typ - <code>libraryId</code> (Token) - F\u00fcr Filterung nach Library - <code>user</code> (Token) - F\u00fcr Filterung nach Benutzer - <code>fileId</code> (Token) - F\u00fcr Filterung nach Datei-ID (wird mit <code>$in</code> verwendet)</p> <p>Array-Facetten-Felder (dynamisch aus Facetten-Config): - <code>authors</code> (Token) - Wenn als Array-Facette (<code>type: 'string[]'</code>) definiert - <code>speakers</code> (Token) - Wenn als Array-Facette definiert - <code>tags</code> (Token) - Wenn als Array-Facette definiert - <code>topics</code> (Token) - Wenn als Array-Facette definiert - <code>speakers_image_url</code> (Token) - Wenn als Array-Facette definiert - Weitere Array-Facetten aus der Library-Config werden automatisch hinzugef\u00fcgt</p>"},{"location":"mongodb-vector-search-index.html#fur-bestehende-indexe","title":"F\u00fcr bestehende Indexe","text":"<p>Wenn Sie einen bestehenden Vector Search Index haben, m\u00fcssen Sie ihn manuell aktualisieren:</p>"},{"location":"mongodb-vector-search-index.html#option-1-index-neu-erstellen-empfohlen","title":"Option 1: Index neu erstellen (empfohlen)","text":"<ol> <li> <p>Index l\u00f6schen (\u00fcber MongoDB Atlas UI oder Shell):    <pre><code>db.collection.dropSearchIndex(\"vector_search_idx\")\n</code></pre></p> </li> <li> <p>Index wird automatisch neu erstellt beim n\u00e4chsten Aufruf von <code>getVectorCollection()</code> mit allen ben\u00f6tigten Token-Indexen.</p> </li> </ol>"},{"location":"mongodb-vector-search-index.html#option-2-index-definition-manuell-aktualisieren","title":"Option 2: Index-Definition manuell aktualisieren","text":"<ol> <li>Gehen Sie zu MongoDB Atlas \u2192 Search \u2192 Indexes</li> <li>\u00d6ffnen Sie den <code>vector_search_idx</code> Index</li> <li>F\u00fcgen Sie die folgenden Felder als Token-Indexe hinzu:</li> </ol> <pre><code>{\n  \"mappings\": {\n    \"dynamic\": true,\n    \"fields\": {\n      \"embedding\": {\n        \"type\": \"knnVector\",\n        \"dimensions\": 1024,\n        \"similarity\": \"cosine\"\n      },\n      \"kind\": {\n        \"type\": \"token\"\n      },\n      \"libraryId\": {\n        \"type\": \"token\"\n      },\n      \"user\": {\n        \"type\": \"token\"\n      },\n      \"authors\": {\n        \"type\": \"token\"\n      },\n      \"speakers\": {\n        \"type\": \"token\"\n      },\n      \"tags\": {\n        \"type\": \"token\"\n      },\n      \"topics\": {\n        \"type\": \"token\"\n      },\n      \"speakers_image_url\": {\n        \"type\": \"token\"\n      },\n      \"track\": {\n        \"type\": \"string\"\n      },\n      \"year\": {\n        \"type\": \"number\"\n      },\n      \"region\": {\n        \"type\": \"string\"\n      },\n      \"docType\": {\n        \"type\": \"string\"\n      },\n      \"source\": {\n        \"type\": \"string\"\n      },\n      \"date\": {\n        \"type\": \"string\"\n      }\n    }\n  }\n}\n</code></pre> <p>WICHTIG:  - <code>libraryId</code> und <code>user</code> m\u00fcssen als Token-Indexe definiert sein (nicht <code>string</code>), da sie in Filtern mit <code>$eq</code>-Operatoren verwendet werden - Alle Felder, die in Vector Search Filtern verwendet werden, ben\u00f6tigen Token-Indexe</p>"},{"location":"mongodb-vector-search-index.html#welche-felder-benotigen-token-indexe","title":"Welche Felder ben\u00f6tigen Token-Indexe?","text":"<p>Alle Filter-Felder, die in Vector Search Filtern mit Operatoren (<code>$eq</code>, <code>$in</code>, etc.) verwendet werden:</p> <p>Basis-Filter-Felder (immer erforderlich): - <code>kind</code> - Dokument-Typ (chunk, meta, etc.) - <code>libraryId</code> - Library-ID - <code>user</code> - Benutzer-E-Mail</p> <p>Array-Facetten-Felder (dynamisch aus Facetten-Config): - <code>authors</code> - Array von Autoren - <code>speakers</code> - Array von Sprechern - <code>tags</code> - Array von Tags - <code>topics</code> - Array von Topics - <code>speakers_image_url</code> - Array von Bild-URLs - Weitere Array-Facetten aus der Library-Config</p> <p>Hinweis: MongoDB Atlas Vector Search ben\u00f6tigt Token-Indexe f\u00fcr alle Felder, die in Filtern verwendet werden, nicht nur f\u00fcr Array-Felder. String-Felder wie <code>libraryId</code> und <code>user</code> m\u00fcssen ebenfalls als Token-Indexe definiert sein, wenn sie mit <code>$eq</code>-Operatoren verwendet werden.</p>"},{"location":"mongodb-vector-search-index.html#weitere-facetten-felder","title":"Weitere Facetten-Felder","text":"<p>Wenn Sie zus\u00e4tzliche Facetten-Felder in Ihrer Library-Konfiguration haben, die Array-Typen sind (<code>type: 'string[]'</code>), m\u00fcssen diese ebenfalls als Token-Indexe hinzugef\u00fcgt werden.</p>"},{"location":"mongodb-vector-search-index.html#prufung","title":"Pr\u00fcfung","text":"<p>Nach der Index-Aktualisierung k\u00f6nnen Sie testen, ob der Index korrekt funktioniert:</p> <pre><code>// Test-Query mit authors-Filter\ndb.collection.aggregate([\n  {\n    $vectorSearch: {\n      index: \"vector_search_idx\",\n      path: \"embedding\",\n      queryVector: [/* test vector */],\n      numCandidates: 10,\n      limit: 5,\n      filter: {\n        authors: { $in: [\"Test Author\"] }\n      }\n    }\n  }\n])\n</code></pre> <p>Wenn diese Query ohne Fehler funktioniert, ist der Index korrekt konfiguriert.</p>"},{"location":"_analysis/chat-orchestration-flow.html","title":"Chat-Orchestrierungs-Flow: Vereinfachte Dokumentation","text":""},{"location":"_analysis/chat-orchestration-flow.html#ubersicht","title":"\u00dcbersicht","text":"<p>Dieses Dokument beschreibt den vereinfachten Flow der Chat-Orchestrierung von der Frage bis zur Antwort. Die Logik wurde stark vereinfacht: TOC-Queries verwenden Summary oder ChunkSummary basierend auf Token-Budget, normale Fragen verwenden immer RAG (chunk) mit Warnung bei zu wenig relevanten Dokumenten.</p>"},{"location":"_analysis/chat-orchestration-flow.html#flow-diagramm","title":"Flow-Diagramm","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   1. Request empfangen                          \u2502\n\u2502              (POST /api/chat/[libraryId]/stream)                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                            \u2502\n                            \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   2. Authentifizierung &amp;                         \u2502\n\u2502                      Library-Context laden                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                            \u2502\n                            \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   3. Query-Typ bestimmen                        \u2502\n\u2502              \u2022 isTOCQuery? (TOC_QUESTION)                        \u2502\n\u2502              \u2022 Normale Frage                                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                            \u2502\n                \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                \u2502                       \u2502\n                \u25bc                                                   \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502   TOC-Query       \u2502   \u2502   Normale Frage      \u2502\n    \u2502   (Story Mode)    \u2502   \u2502   (immer RAG)        \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n              \u2502                        \u2502\n              \u2502                        \u2502\n              \u2502                        \u2502\n              \u2502                        \u2502\n              \u2502                        \u2502\n              \u2502                        \u2502\n              \u2502                        \u2502\n              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502\n                           \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502  4. Retriever-Entscheidung           \u2502\n        \u2502  TOC: summary oder chunkSummary      \u2502\n        \u2502  (basierend auf Token-Budget)        \u2502\n        \u2502  Normale Frage: chunk (RAG)          \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502           \u2502           \u2502\n        \u25bc           \u25bc           \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502Summary \u2502 \u2502ChunkSumm \u2502 \u2502 Chunk  \u2502\n    \u2502(TOC)   \u2502 \u2502(TOC)     \u2502 \u2502(RAG)   \u2502\n    \u2514\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n        \u2502           \u2502           \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n                    \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502  5. Retrieval          \u2502\n        \u2502  (Quellen abrufen)    \u2502\n        \u2502  \u2022 RAG: Score-Pr\u00fcfung \u2502\n        \u2502  \u2022 Warnung bei &lt; 0.7  \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n                    \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502  6. Prompt-Building   \u2502\n        \u2502  \u2022 TOC-Prompt         \u2502\n        \u2502  \u2022 Normal-Prompt      \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n                    \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502  7. LLM-Aufruf        \u2502\n        \u2502  (OpenAI API)         \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n                    \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502  8. Response-Parsing  \u2502\n        \u2502  \u2022 StoryTopicsData    \u2502\n        \u2502  \u2022 Normal-Answer      \u2502\n        \u2502  \u2022 Warnung hinzuf\u00fcgen \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n                    \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502  9. Complete          \u2502\n        \u2502  (Stream beenden)     \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_analysis/chat-orchestration-flow.html#detaillierte-fallbeschreibungen","title":"Detaillierte Fallbeschreibungen","text":""},{"location":"_analysis/chat-orchestration-flow.html#fall-1-toc-query-story-mode","title":"Fall 1: TOC-Query (Story Mode)","text":"<p>Trigger: <code>isTOCQuery === true</code> (Frage entspricht <code>TOC_QUESTION</code> ODER <code>asTOC === true</code>)</p> <p>Flow: 1. \u2705 Retriever-Entscheidung: Basierend auf Token-Budget    - Berechnet: <code>estimatedTokens = totalChunks \u00d7 CHAT_AVG_TOKENS_PER_CHUNK</code>    - Wenn <code>estimatedTokens &gt;= CHAT_MAX_INPUT_TOKENS</code>: <code>summary</code> (MongoDB Summaries)    - Wenn <code>estimatedTokens &lt; CHAT_MAX_INPUT_TOKENS</code>: <code>chunkSummary</code> (alle Chunks) 2. \u2705 Retrieval:     - <code>summary</code>: <code>summariesMongoRetriever</code> - L\u00e4dt alle MongoDB-Dokument-Summaries    - <code>chunkSummary</code>: <code>chunkSummaryRetriever</code> - L\u00e4dt alle Chunks der gefilterten Dokumente 3. \u2705 Prompt: <code>buildTOCPrompt()</code> - Spezieller Prompt f\u00fcr Themen\u00fcbersicht 4. \u2705 LLM: Generiert strukturierte Themen\u00fcbersicht 5. \u2705 Parsing: <code>parseStoryTopicsData()</code> - Extrahiert strukturierte Daten 6. \u2705 Output: <code>StoryTopicsData</code> + Markdown-Answer (f\u00fcr R\u00fcckw\u00e4rtskompatibilit\u00e4t)</p> <p>Vorteile: - Automatische Entscheidung basierend auf Token-Budget - Bei wenigen Dokumenten: Pr\u00e4ziser (chunkSummary) - Bei vielen Dokumenten: \u00dcbersichtlich (summary)</p> <p>Nachteile: - Abh\u00e4ngig von Qualit\u00e4t der Summaries (bei summary)</p>"},{"location":"_analysis/chat-orchestration-flow.html#fall-2-normale-frage-summary-modus-nur-explizit","title":"Fall 2: Normale Frage - Summary-Modus (nur explizit)","text":"<p>Trigger:  - Explizit: <code>retriever=summary</code> oder <code>retriever=doc</code></p> <p>Flow: 1. \u2705 Retriever-Entscheidung: <code>summary</code> (nur wenn explizit gesetzt) 2. \u2705 Retrieval: <code>summariesMongoRetriever</code>    - L\u00e4dt alle MongoDB-Dokument-Summaries (gefiltert)    - Keine Embedding-Suche 3. \u2705 Prompt: <code>buildPrompt()</code> - Normaler Prompt mit Summaries 4. \u2705 LLM: Generiert Antwort basierend auf Summaries 5. \u2705 Parsing: <code>parseStructuredLLMResponse()</code> - Standard-Parsing</p> <p>Hinweis: Dieser Modus wird nur noch verwendet, wenn explizit gew\u00e4hlt. Automatisch wird immer RAG verwendet.</p>"},{"location":"_analysis/chat-orchestration-flow.html#fall-3-toc-query-chunksummary-modus","title":"Fall 3: TOC-Query - ChunkSummary-Modus","text":"<p>Trigger:  - TOC-Query UND <code>estimatedTokens &lt; CHAT_MAX_INPUT_TOKENS</code></p> <p>Entscheidungskriterien: <pre><code>estimatedTokens = totalChunks \u00d7 CHAT_AVG_TOKENS_PER_CHUNK\nif (estimatedTokens &lt; CHAT_MAX_INPUT_TOKENS) {\n  mode = 'chunkSummary' // F\u00fcr TOC\n}\n</code></pre></p> <p>Flow: 1. \u2705 Retriever-Entscheidung: <code>chunkSummary</code> (nur f\u00fcr TOC)    - Automatisch basierend auf Token-Budget    - Berechnet: <code>sumChunkCounts()</code> aus MongoDB 2. \u2705 Retrieval: <code>chunkSummaryRetriever</code>    - Schritt 1: L\u00e4dt gefilterte Dokumente aus MongoDB (nur <code>fileIds</code>)    - Schritt 2: L\u00e4dt alle Chunks dieser Dokumente aus MongoDB    - OHNE Embedding-Suche (direkter Filter: <code>fileId: { $in: [...] }</code>)    - Filter-Struktur: <code>{ kind: 'chunk', libraryId, user, fileId: { $in: [...] } }</code> 3. \u2705 Prompt: <code>buildTOCPrompt()</code> - TOC-Prompt mit allen Chunks 4. \u2705 LLM: Generiert strukturierte Themen\u00fcbersicht 5. \u2705 Parsing: <code>parseStoryTopicsData()</code> - Extrahiert strukturierte Daten</p> <p>Vorteile: - Vollst\u00e4ndiger Kontext (alle Chunks) - Pr\u00e4zisere Themen\u00fcbersicht als Summary-Modus - Keine Embedding-Suche n\u00f6tig</p> <p>Hinweis: Dieser Modus wird nur f\u00fcr TOC-Queries verwendet, nicht f\u00fcr normale Fragen.</p>"},{"location":"_analysis/chat-orchestration-flow.html#fall-4-normale-frage-chunk-modus-rag","title":"Fall 4: Normale Frage - Chunk-Modus (RAG)","text":"<p>Trigger:  - Immer f\u00fcr normale Fragen (automatisch) - Explizit: <code>retriever=chunk</code></p> <p>Flow: 1. \u2705 Retriever-Entscheidung: <code>chunk</code> (RAG) - Immer f\u00fcr normale Fragen 2. \u2705 Retrieval: <code>chunksRetriever</code>    - Schritt 1: Embedding der Frage generieren    - Schritt 2: Semantische Suche in MongoDB Vector Search (Vector-Similarity)    - Schritt 3: Top-K relevante Chunks zur\u00fcckgeben    - Optional: Chapter-Summaries zus\u00e4tzlich abrufen    - Warnung: Wenn alle Scores &lt; 0.7 \u2192 Warnung generieren 3. \u2705 Prompt: <code>buildPrompt()</code> - Normaler Prompt mit relevanten Chunks 4. \u2705 LLM: Generiert Antwort basierend auf relevanten Chunks 5. \u2705 Parsing: <code>parseStructuredLLMResponse()</code> - Standard-Parsing 6. \u2705 Warnung: Falls vorhanden, wird zur Antwort hinzugef\u00fcgt</p> <p>Vorteile: - Semantisch relevante Chunks (beste Qualit\u00e4t) - Funktioniert auch bei vielen Dokumenten - Flexibel (Top-K kann angepasst werden) - Warnung bei zu wenig relevanten Dokumenten</p> <p>Nachteile: - Langsamer (Embedding-Generierung + Vektor-Suche) - Teurer (mehr API-Calls)</p>"},{"location":"_analysis/chat-orchestration-flow.html#entscheidungslogik-decideretrievermode","title":"Entscheidungslogik: <code>decideRetrieverMode()</code>","text":""},{"location":"_analysis/chat-orchestration-flow.html#prioritaten-in-reihenfolge","title":"Priorit\u00e4ten (in Reihenfolge):","text":"<ol> <li> <p>TOC-Query: Entscheidung basierend auf Token-Budget    <pre><code>if (isTOCQuery) {\n  totalChunks = sumChunkCounts(filter)\n  estimatedTokens = totalChunks \u00d7 CHAT_AVG_TOKENS_PER_CHUNK\n\n  if (estimatedTokens &lt; CHAT_MAX_INPUT_TOKENS) {\n    return { mode: 'chunkSummary' } // Pr\u00e4ziser bei wenigen Dokumenten\n  } else {\n    return { mode: 'summary' } // \u00dcbersichtlich bei vielen Dokumenten\n  }\n}\n</code></pre></p> </li> <li> <p>Explizite Auswahl: Respektiere User-Input    <pre><code>if (explicitRetriever &amp;&amp; explicitRetriever !== 'auto') {\n  // chunkSummary nur f\u00fcr TOC verf\u00fcgbar\n  return { mode: explicitRetriever === 'doc' ? 'summary' : explicitRetriever }\n}\n</code></pre></p> </li> <li> <p>Normale Fragen: Immer RAG    <pre><code>return { mode: 'chunk' } // Immer RAG f\u00fcr normale Fragen\n</code></pre></p> </li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#konfiguration","title":"Konfiguration:","text":"<ul> <li><code>CHAT_MAX_INPUT_TOKENS</code>: Token-Budget (Standard: aus <code>budget.ts</code>)</li> <li><code>CHAT_AVG_TOKENS_PER_CHUNK</code>: Durchschnittliche Token pro Chunk (Standard: 300)</li> <li><code>RAG_MIN_SCORE_THRESHOLD</code>: Mindest-Score f\u00fcr relevante Dokumente (Standard: 0.7)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#warnungs-logik","title":"Warnungs-Logik","text":""},{"location":"_analysis/chat-orchestration-flow.html#warnung-bei-zu-wenig-relevanten-dokumenten","title":"Warnung bei zu wenig relevanten Dokumenten","text":"<p>Trigger:  - RAG-Modus (chunk) - Alle gefundenen Dokumente haben Score &lt; 0.7</p> <p>Warnung: <pre><code>\"Die zugrundeliegenden Dokumente enthalten zu wenig passenden Inhalt. \nBitte formulieren Sie die Frage um oder erweitern Sie die Anzahl der \nzugrundeliegenden Dokumente (Facettenfilter anpassen).\"\n</code></pre></p> <p>Implementierung: - Pr\u00fcfung nach <code>queryVectors()</code> in <code>chunksRetriever</code> - Warnung wird in <code>RetrieverOutput.warning</code> zur\u00fcckgegeben - Im Orchestrator wird Warnung zur Antwort hinzugef\u00fcgt</p>"},{"location":"_analysis/chat-orchestration-flow.html#checkbox-fur-themenubersicht","title":"Checkbox f\u00fcr Themen\u00fcbersicht","text":""},{"location":"_analysis/chat-orchestration-flow.html#feature-als-themenubersicht-anzeigen","title":"Feature: \"Als Themen\u00fcbersicht anzeigen\"","text":"<p>Beschreibung:  - Checkbox im Chat-Input f\u00fcr normale Fragen - Wenn aktiviert: Antwort wird als Themen\u00fcbersicht (StoryTopicsData) formatiert - Erm\u00f6glicht es Benutzern, normale Fragen als strukturierte Themen\u00fcbersicht zu erhalten</p> <p>Implementierung: - Parameter <code>asTOC</code> im Request-Body - Wenn <code>asTOC === true</code>: <code>isTOCQuery</code> wird auf <code>true</code> gesetzt - Verwendet TOC-Prompt und StoryTopicsData-Parsing</p>"},{"location":"_analysis/chat-orchestration-flow.html#implementierte-anderungen","title":"Implementierte \u00c4nderungen","text":""},{"location":"_analysis/chat-orchestration-flow.html#1-vereinfachte-toc-logik","title":"1. Vereinfachte TOC-Logik","text":"<ul> <li>TOC verwendet <code>summary</code> oder <code>chunkSummary</code> basierend auf Token-Budget</li> <li><code>chunkSummary</code> nur f\u00fcr TOC verf\u00fcgbar (nicht f\u00fcr normale Fragen)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#2-normale-fragen-immer-rag","title":"2. Normale Fragen: Immer RAG","text":"<ul> <li>Automatisch immer <code>chunk</code> (RAG) f\u00fcr normale Fragen</li> <li>Keine Token-Budget-Pr\u00fcfung mehr f\u00fcr normale Fragen</li> <li>Warnung bei zu wenig relevanten Dokumenten (Score &lt; 0.7)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#3-frage-analyse-entfernt","title":"3. Frage-Analyse entfernt","text":"<ul> <li>Keine LLM-basierte Frage-Analyse mehr</li> <li>Chat-Title wird direkt aus Frage generiert (erste 60 Zeichen)</li> <li>Vereinfachter Flow ohne zus\u00e4tzliche LLM-Calls</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#4-checkbox-fur-themenubersicht","title":"4. Checkbox f\u00fcr Themen\u00fcbersicht","text":"<ul> <li>Checkbox \"Als Themen\u00fcbersicht anzeigen\" im Chat-Input</li> <li>Erm\u00f6glicht normale Fragen als Themen\u00fcbersicht zu formatieren</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#zusammenfassung-vereinfachte-logik","title":"Zusammenfassung: Vereinfachte Logik","text":""},{"location":"_analysis/chat-orchestration-flow.html#implementiert","title":"Implementiert:","text":"<pre><code>TOC-Query:\n  Wenn estimatedTokens &lt; CHAT_MAX_INPUT_TOKENS \u2192 chunkSummary (pr\u00e4ziser)\n  Wenn estimatedTokens &gt;= CHAT_MAX_INPUT_TOKENS \u2192 summary (\u00fcbersichtlich)\n\nNormale Frage:\n  Immer \u2192 chunk (RAG)\n  Warnung wenn alle Scores &lt; 0.7\n\nCheckbox \"Als Themen\u00fcbersicht\":\n  Setzt isTOCQuery = true \u2192 verwendet TOC-Logik\n</code></pre>"},{"location":"_analysis/chat-orchestration-flow.html#implementierungsstatus","title":"Implementierungsstatus","text":"<ol> <li>\u2705 TOC-Logik vereinfacht (Token-Budget basiert)</li> <li>\u2705 Normale Fragen: Immer RAG</li> <li>\u2705 Warnung bei zu wenig relevanten Dokumenten</li> <li>\u2705 Frage-Analyse entfernt</li> <li>\u2705 Checkbox f\u00fcr Themen\u00fcbersicht hinzugef\u00fcgt</li> <li>\u2705 Dokumentation aktualisiert</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#nachste-schritte-optional","title":"N\u00e4chste Schritte (optional)","text":"<ol> <li>\u26a0\ufe0f Tests f\u00fcr Edge-Cases (wenige Dokumente, viele Dokumente)</li> <li>\u26a0\ufe0f Monitoring: Welcher Modus wird wann gew\u00e4hlt?</li> <li>\u26a0\ufe0f Top-K Erweiterung evaluieren (bei zu wenig relevanten Dokumenten)</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#performance-analyse-timing-daten","title":"Performance-Analyse: Timing-Daten","text":""},{"location":"_analysis/chat-orchestration-flow.html#gemessene-timings-beispiel-aus-produktion","title":"Gemessene Timings (Beispiel aus Produktion)","text":"<p>RAG-Flow (chunk-Modus) - Normale Frage:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Schritt                    \u2502 Timing    \u2502 Anteil \u2502 Status   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 1. Embedding-Generierung   \u2502 ~514ms    \u2502 11%    \u2502 \u2705 OK    \u2502\n\u2502 2. Vector-Suche (Query)    \u2502 ~1187ms   \u2502 26%    \u2502 \u26a0\ufe0f Langsam\u2502\n\u2502 3. Fetch Neighbors          \u2502 ~2902ms   \u2502 64%    \u2502 \u274c Sehr  \u2502\n\u2502                            \u2502           \u2502        \u2502   langsam \u2502\n\u2502 4. Prompt-Building         \u2502 ~50-100ms \u2502 1-2%   \u2502 \u2705 OK    \u2502\n\u2502 5. LLM-Aufruf             \u2502 ~2000-5000ms\u2502 44-55%\u2502 \u26a0\ufe0f Variabel\u2502\n\u2502                            \u2502           \u2502        \u2502           \u2502\n\u2502 TOTAL                      \u2502 ~4600-8700ms\u2502 100% \u2502 \u26a0\ufe0f        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_analysis/chat-orchestration-flow.html#detaillierte-schritt-analyse","title":"Detaillierte Schritt-Analyse","text":""},{"location":"_analysis/chat-orchestration-flow.html#1-embedding-generierung-embed","title":"1. Embedding-Generierung (<code>embed</code>)","text":"<ul> <li>Timing: ~514ms</li> <li>Was passiert: Frage wird in Embedding-Vektor umgewandelt</li> <li>API-Call: OpenAI Embeddings API</li> <li>Bewertung: \u2705 Akzeptabel (~500ms ist normal f\u00fcr Embeddings)</li> <li>Optimierungspotenzial: Gering (abh\u00e4ngig von OpenAI)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#2-vector-suche-query","title":"2. Vector-Suche (<code>query</code>)","text":"<ul> <li>Timing: ~1187ms</li> <li>Was passiert: </li> <li>Semantische Suche in MongoDB Vector Search</li> <li>Top-K relevante Chunks finden (Standard: 20)</li> <li>Parallel: Chapter-Summaries suchen (Top-10)</li> <li>API-Call: MongoDB <code>$vectorSearch</code> Aggregation (2 parallel)</li> <li>Bewertung: \u26a0\ufe0f Langsam (k\u00f6nnte optimiert werden)</li> <li>Optimierungspotenzial: </li> <li>Parallelisierung bereits implementiert \u2705</li> <li>Top-K k\u00f6nnte reduziert werden (wenn nicht alle ben\u00f6tigt)</li> <li>MongoDB Vector Search Index-Performance pr\u00fcfen</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#3-fetch-neighbors-fetchneighbors","title":"3. Fetch Neighbors (<code>fetchNeighbors</code>)","text":"<ul> <li>Timing: Variabel (abh\u00e4ngig von Anzahl der Nachbarn)</li> <li>Was passiert:</li> <li>Window-basierte Nachbar-Chunks abrufen</li> <li>Beispiel: Top-20 Chunks \u2192 Window \u00b11-3 \u2192 ~60-74 IDs</li> <li>Direkte MongoDB-Abfrage mit <code>_id: { $in: [...] }</code></li> <li>API-Call: MongoDB <code>find()</code> Query (1 Request mit vielen IDs)</li> <li>Bewertung: \u2705 Schneller als Pinecone Fetch API</li> <li>Vorteile: </li> <li>Direkte MongoDB-Abfrage ist effizienter</li> <li>Alle Metadaten bereits verf\u00fcgbar (keine separate Fetch n\u00f6tig)</li> <li>Window-Gr\u00f6\u00dfe (<code>windowByLength</code>) bestimmt Anzahl der IDs</li> <li>Optimierungspotenzial: </li> <li>Mittel: Window-Gr\u00f6\u00dfe dynamisch anpassen</li> <li>Niedrig: Optional machen (nur wenn wirklich n\u00f6tig)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#4-prompt-building","title":"4. Prompt-Building","text":"<ul> <li>Timing: ~50-100ms (gesch\u00e4tzt)</li> <li>Was passiert: Prompt aus Quellen zusammenbauen</li> <li>Bewertung: \u2705 OK (lokale Operation)</li> <li>Optimierungspotenzial: Gering</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#5-llm-aufruf","title":"5. LLM-Aufruf","text":"<ul> <li>Timing: ~2000-5000ms (variabel)</li> <li>Was passiert: OpenAI API-Call f\u00fcr Antwort-Generierung</li> <li>Bewertung: \u26a0\ufe0f Variabel (abh\u00e4ngig von Antwortl\u00e4nge, Modell, Last)</li> <li>Optimierungspotenzial: </li> <li>Modell-Auswahl (gpt-4.1-mini ist schneller als gpt-4o)</li> <li>Streaming bereits implementiert \u2705</li> <li>Token-Budget-Management bereits implementiert \u2705</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#identifizierte-performance-probleme","title":"Identifizierte Performance-Probleme","text":""},{"location":"_analysis/chat-orchestration-flow.html#problem-1-fetch-neighbors-ist-zu-langsam","title":"\ud83d\udd34 Problem 1: Fetch Neighbors ist zu langsam","text":"<ul> <li>Impact: Hoch (64% der Retrieval-Zeit)</li> <li>Ursache: Ein Request mit vielen IDs (74+)</li> <li>L\u00f6sung: </li> <li>Batch-Gr\u00f6\u00dfe reduzieren (z.B. max 20 IDs pro Request)</li> <li>Parallelisierung (mehrere Requests parallel)</li> <li>Window-Gr\u00f6\u00dfe dynamisch anpassen (kleineres Window bei vielen Chunks)</li> <li>Optional machen (nur wenn wirklich n\u00f6tig)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#problem-2-vector-suche-konnte-schneller-sein","title":"\ud83d\udfe1 Problem 2: Vector-Suche k\u00f6nnte schneller sein","text":"<ul> <li>Impact: Mittel (26% der Retrieval-Zeit)</li> <li>Ursache: MongoDB Vector Search Query-Performance</li> <li>L\u00f6sung: </li> <li>Top-K reduzieren (wenn nicht alle ben\u00f6tigt)</li> <li>Vector Search Index-Performance pr\u00fcfen</li> <li>Caching f\u00fcr \u00e4hnliche Queries</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#problem-3-embedding-generierung-ist-akzeptabel","title":"\ud83d\udfe2 Problem 3: Embedding-Generierung ist akzeptabel","text":"<ul> <li>Impact: Niedrig (11% der Retrieval-Zeit)</li> <li>Status: \u2705 OK</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#optimierungsvorschlage","title":"Optimierungsvorschl\u00e4ge","text":""},{"location":"_analysis/chat-orchestration-flow.html#prioritat-1-fetch-neighbors-optimieren-hoch","title":"Priorit\u00e4t 1: Fetch Neighbors optimieren (Hoch)","text":"<p>Option A: Batch-Gr\u00f6\u00dfe reduzieren <pre><code>// Aktuell: Ein Request mit allen IDs\nconst fetched = await fetchVectors(idx.host, apiKey, ids) // 74 IDs\n\n// Optimiert: Mehrere Requests mit kleineren Batches\nconst BATCH_SIZE = 20\nconst batches = []\nfor (let i = 0; i &lt; ids.length; i += BATCH_SIZE) {\n  batches.push(ids.slice(i, i + BATCH_SIZE))\n}\nconst fetched = await Promise.all(\n  batches.map(batch =&gt; fetchVectors(idx.host, apiKey, batch))\n)\n</code></pre></p> <p>Option B: Window-Gr\u00f6\u00dfe dynamisch anpassen <pre><code>// Aktuell: Feste Window-Gr\u00f6\u00dfe basierend auf answerLength\nconst windowByLength = input.answerLength === 'ausf\u00fchrlich' ? 3 : ...\n\n// Optimiert: Dynamisch basierend auf Anzahl der Matches\nconst windowSize = matches.length &gt; 30 ? 1 : matches.length &gt; 15 ? 2 : 3\n</code></pre></p> <p>Option C: Optional machen <pre><code>// Nur wenn wirklich n\u00f6tig (z.B. wenn Chunks sequenziell sind)\nconst needsNeighbors = matches.some(m =&gt; {\n  const { base, chunk } = parseId(m.id)\n  return Number.isFinite(chunk)\n})\nif (needsNeighbors) {\n  // Fetch neighbors\n} else {\n  // Verwende Original-Matches direkt\n}\n</code></pre></p>"},{"location":"_analysis/chat-orchestration-flow.html#prioritat-2-vector-suche-optimieren-mittel","title":"Priorit\u00e4t 2: Vector-Suche optimieren (Mittel)","text":"<p>Option A: Top-K reduzieren <pre><code>// Aktuell: baseTopK = 20\n// Optimiert: Dynamisch basierend auf Budget\nconst baseTopK = budget &gt; 50000 ? 30 : budget &gt; 30000 ? 20 : 15\n</code></pre></p> <p>Option B: Caching f\u00fcr \u00e4hnliche Queries <pre><code>// Cache f\u00fcr Embeddings \u00e4hnlicher Fragen (z.B. innerhalb von 5 Minuten)\nconst cacheKey = hashQuestion(input.question)\nconst cached = await getCachedEmbedding(cacheKey)\nif (cached) {\n  // Verwende cached embedding\n}\n</code></pre></p>"},{"location":"_analysis/chat-orchestration-flow.html#prioritat-3-monitoring-verbessern-niedrig","title":"Priorit\u00e4t 3: Monitoring verbessern (Niedrig)","text":"<ul> <li>Detaillierte Timing-Logs f\u00fcr jeden Schritt</li> <li>Alerts bei langsamen Queries (&gt;5s)</li> <li>Dashboard f\u00fcr Performance-Metriken</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#flow-validierung-aktueller-stand","title":"Flow-Validierung: Aktueller Stand","text":""},{"location":"_analysis/chat-orchestration-flow.html#validierung-flow-stimmt-noch","title":"\u2705 Validierung: Flow stimmt noch","text":"<p>Der dokumentierte Flow entspricht der aktuellen Implementierung:</p> <ol> <li>\u2705 TOC-Query-Logik: </li> <li>Token-Budget-basierte Entscheidung zwischen <code>summary</code> und <code>chunkSummary</code></li> <li> <p>Implementiert in <code>decideRetrieverMode()</code></p> </li> <li> <p>\u2705 Normale Fragen: </p> </li> <li>Immer RAG (<code>chunk</code>-Modus)</li> <li>Warnung bei Score &lt; 0.7</li> <li> <p>Implementiert in <code>chunksRetriever</code></p> </li> <li> <p>\u2705 Retrieval-Schritte:</p> </li> <li>Embedding-Generierung \u2705</li> <li>Vector-Suche (parallel f\u00fcr Chunks und Chapter-Summaries) \u2705</li> <li>Fetch Neighbors (Window-basiert) \u2705</li> <li> <p>Score-Boosting (Chapter-Boost, Lexical-Boost) \u2705</p> </li> <li> <p>\u2705 Prompt-Building:</p> </li> <li>TOC-Prompt f\u00fcr TOC-Queries \u2705</li> <li> <p>Normal-Prompt f\u00fcr normale Fragen \u2705</p> </li> <li> <p>\u2705 LLM-Aufruf:</p> </li> <li>Streaming implementiert \u2705</li> <li>Token-Budget-Management \u2705</li> <li> <p>Retry-Logik bei zu langen Prompts \u2705</p> </li> <li> <p>\u2705 Response-Parsing:</p> </li> <li>StoryTopicsData f\u00fcr TOC-Queries \u2705</li> <li>Normal-Parsing f\u00fcr normale Fragen \u2705</li> <li>Warnung wird hinzugef\u00fcgt \u2705</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#verbesserungen-identifiziert","title":"\u26a0\ufe0f Verbesserungen identifiziert","text":"<ol> <li>Performance: Fetch Neighbors ist zu langsam (siehe oben)</li> <li>Monitoring: Timing-Daten werden gesammelt, aber nicht ausgewertet</li> <li>Optimierung: Window-Gr\u00f6\u00dfe k\u00f6nnte dynamischer sein</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#empfohlene-optimierungen-priorisiert","title":"Empfohlene Optimierungen (Priorisiert)","text":""},{"location":"_analysis/chat-orchestration-flow.html#sofort-umsetzbar-quick-wins","title":"Sofort umsetzbar (Quick Wins)","text":"<ol> <li>Fetch Neighbors batching (Priorit\u00e4t: Hoch)</li> <li>Batch-Gr\u00f6\u00dfe auf 20 IDs reduzieren</li> <li>Parallelisierung implementieren</li> <li> <p>Gesch\u00e4tzte Verbesserung: ~50% schneller (2902ms \u2192 ~1450ms)</p> </li> <li> <p>Window-Gr\u00f6\u00dfe dynamisch anpassen (Priorit\u00e4t: Mittel)</p> </li> <li>Kleinere Window-Gr\u00f6\u00dfe bei vielen Matches</li> <li>Gesch\u00e4tzte Verbesserung: ~30% weniger IDs \u2192 ~20% schneller</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#mittelfristig-wochen","title":"Mittelfristig (Wochen)","text":"<ol> <li>Top-K dynamisch anpassen (Priorit\u00e4t: Mittel)</li> <li>Basierend auf Budget und Anzahl der Matches</li> <li> <p>Gesch\u00e4tzte Verbesserung: ~10-15% schneller</p> </li> <li> <p>Caching f\u00fcr Embeddings (Priorit\u00e4t: Niedrig)</p> </li> <li>Cache f\u00fcr \u00e4hnliche Fragen</li> <li>Gesch\u00e4tzte Verbesserung: ~500ms bei Cache-Hit</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#langfristig-monate","title":"Langfristig (Monate)","text":"<ol> <li>Monitoring-Dashboard (Priorit\u00e4t: Niedrig)</li> <li>Performance-Metriken visualisieren</li> <li>Alerts bei langsamen Queries</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#zusammenfassung-performance-optimierung","title":"Zusammenfassung: Performance-Optimierung","text":""},{"location":"_analysis/chat-orchestration-flow.html#aktuelle-performance-rag-flow","title":"Aktuelle Performance (RAG-Flow)","text":"<ul> <li>Total Retrieval: ~4600ms</li> <li>Langsamster Schritt: Fetch Neighbors (~2902ms, 64%)</li> <li>Zweiter Schritt: Vector-Suche (~1187ms, 26%)</li> <li>Schnellster Schritt: Embedding (~514ms, 11%)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#optimierungspotenzial","title":"Optimierungspotenzial","text":"<ul> <li>Fetch Neighbors: ~50% schneller m\u00f6glich (Batching)</li> <li>Vector-Suche: ~10-15% schneller m\u00f6glich (dynamisches Top-K)</li> <li>Gesamt: ~30-40% schneller m\u00f6glich (~4600ms \u2192 ~2800-3200ms)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#nachste-schritte","title":"N\u00e4chste Schritte","text":"<ol> <li>\u2705 Flow validiert - stimmt noch</li> <li>\u2705 Performance-Probleme identifiziert</li> <li>\u2705 Optimierungsvorschl\u00e4ge dokumentiert</li> <li>\u2705 Implementierung der Quick Wins abgeschlossen</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#implementierte-optimierungen","title":"Implementierte Optimierungen","text":""},{"location":"_analysis/chat-orchestration-flow.html#fetch-neighbors-batching-implementiert","title":"\u2705 Fetch Neighbors Batching (Implementiert)","text":"<p>Problem: Ein einzelner Request mit vielen IDs (74+) war sehr langsam (~2902ms).</p> <p>L\u00f6sung:  - IDs werden in Batches aufgeteilt (Standard: 20 IDs pro Batch) - Batches werden parallel mit <code>Promise.all()</code> abgerufen - Ergebnisse werden zusammengef\u00fchrt</p> <p>Code-\u00c4nderungen (<code>src/lib/chat/retrievers/chunks.ts</code>): <pre><code>// Batching: IDs in kleinere Batches aufteilen und parallel abrufen\nconst BATCH_SIZE = Number(process.env.CHAT_FETCH_BATCH_SIZE) || 20\nconst batches: string[][] = []\nfor (let i = 0; i &lt; ids.length; i += BATCH_SIZE) {\n  batches.push(ids.slice(i, i + BATCH_SIZE))\n}\n\n// Parallel abrufen: Mehrere kleinere Requests sind schneller als ein gro\u00dfer Request\nconst fetchedBatches = await Promise.all(\n  batches.map(batch =&gt; fetchVectors(idx.host, apiKey, batch))\n)\n\n// Ergebnisse zusammenf\u00fchren\nconst fetched: Record&lt;string, { id: string; metadata?: Record&lt;string, unknown&gt; }&gt; = {}\nfor (const batch of fetchedBatches) {\n  Object.assign(fetched, batch)\n}\n</code></pre></p> <p>Konfiguration: - Umgebungsvariable: <code>CHAT_FETCH_BATCH_SIZE</code> (Standard: 20) - Kann \u00fcber <code>.env</code> angepasst werden</p> <p>Erwartete Verbesserung: ~50% schneller (2902ms \u2192 ~1450ms)</p>"},{"location":"_analysis/chat-orchestration-flow.html#dynamische-window-groe-implementiert","title":"\u2705 Dynamische Window-Gr\u00f6\u00dfe (Implementiert)","text":"<p>Problem: Feste Window-Gr\u00f6\u00dfe f\u00fchrte bei vielen Matches zu sehr vielen IDs.</p> <p>L\u00f6sung: - Window-Gr\u00f6\u00dfe wird dynamisch basierend auf Anzahl der Matches angepasst - Bei vielen Matches (&gt;30): Window-Gr\u00f6\u00dfe 1 - Bei mittleren Matches (&gt;15): Window-Gr\u00f6\u00dfe 2 - Sonst: Urspr\u00fcngliche Window-Gr\u00f6\u00dfe basierend auf <code>answerLength</code></p> <p>Code-\u00c4nderungen (<code>src/lib/chat/retrievers/chunks.ts</code>): <pre><code>// Dynamische Window-Gr\u00f6\u00dfe: Kleinere Window-Gr\u00f6\u00dfe bei vielen Matches\nconst baseWindow = input.answerLength === 'ausf\u00fchrlich' ? 3 : input.answerLength === 'mittel' ? 2 : 1\nconst dynamicWindow = matches.length &gt; 30 ? 1 : matches.length &gt; 15 ? 2 : baseWindow\nconst windowByLength = Math.min(dynamicWindow, baseWindow) // Nicht gr\u00f6\u00dfer als urspr\u00fcnglich\n</code></pre></p> <p>Erwartete Verbesserung: ~30% weniger IDs \u2192 ~20% schneller</p>"},{"location":"_analysis/chat-orchestration-flow.html#dynamisches-top-k-implementiert","title":"\u2705 Dynamisches Top-K (Implementiert)","text":"<p>Problem: Festes <code>baseTopK = 20</code> war nicht optimal f\u00fcr verschiedene Budgets.</p> <p>L\u00f6sung: - Top-K wird dynamisch basierend auf verf\u00fcgbarem Budget berechnet - Gr\u00f6\u00dferes Budget erm\u00f6glicht mehr Chunks</p> <p>Code-\u00c4nderungen (<code>src/lib/chat/retrievers/chunks.ts</code>): <pre><code>// Dynamisches Top-K basierend auf Budget: Gr\u00f6\u00dferes Budget erm\u00f6glicht mehr Chunks\nconst baseTopK = budget &gt; 50000 ? 30 : budget &gt; 30000 ? 20 : 15\n</code></pre></p> <p>Logik: - Budget &gt; 50000: Top-K = 30 - Budget &gt; 30000: Top-K = 20 - Sonst: Top-K = 15</p> <p>Erwartete Verbesserung: ~10-15% schneller</p>"},{"location":"_analysis/chat-orchestration-flow.html#performance-verbesserungen-zusammenfassung","title":"Performance-Verbesserungen: Zusammenfassung","text":""},{"location":"_analysis/chat-orchestration-flow.html#vorher-gemessen","title":"Vorher (gemessen)","text":"<ul> <li>Total Retrieval: ~4600ms</li> <li>Fetch Neighbors: ~2902ms (64%)</li> <li>Vector-Suche: ~1187ms (26%)</li> <li>Embedding: ~514ms (11%)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#nachher-geschatzt","title":"Nachher (gesch\u00e4tzt)","text":"<ul> <li>Total Retrieval: ~2800-3200ms (~30-40% schneller)</li> <li>Fetch Neighbors: ~1450ms (~50% schneller durch Batching)</li> <li>Vector-Suche: ~1000-1070ms (~10-15% schneller durch dynamisches Top-K)</li> <li>Embedding: ~514ms (unver\u00e4ndert)</li> </ul>"},{"location":"_analysis/chat-orchestration-flow.html#implementierte-features","title":"Implementierte Features","text":"<ol> <li>\u2705 Fetch Neighbors Batching mit Parallelisierung</li> <li>\u2705 Dynamische Window-Gr\u00f6\u00dfe basierend auf Anzahl der Matches</li> <li>\u2705 Dynamisches Top-K basierend auf Budget</li> <li>\u2705 Konfigurierbare Batch-Gr\u00f6\u00dfe \u00fcber Umgebungsvariable</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#konfiguration_1","title":"Konfiguration","text":"<p>Neue Umgebungsvariable: - <code>CHAT_FETCH_BATCH_SIZE</code>: Batch-Gr\u00f6\u00dfe f\u00fcr Fetch Neighbors (Standard: 20)   - Kann in <code>.env</code> gesetzt werden   - Empfohlener Wert: 20-30 (abh\u00e4ngig von MongoDB-Performance)</p>"},{"location":"_analysis/chat-orchestration-flow.html#monitoring-testing","title":"Monitoring &amp; Testing","text":""},{"location":"_analysis/chat-orchestration-flow.html#empfohlene-tests","title":"Empfohlene Tests","text":"<ol> <li>Unit-Tests: Batching-Logik mit verschiedenen ID-Anzahlen</li> <li>Integration-Tests: Gesamter Retrieval-Flow mit Timing-Messungen</li> <li>Edge-Cases: </li> <li>Leere IDs-Liste</li> <li>Sehr viele IDs (&gt;100)</li> <li>Einzelne ID</li> <li>Batch-Gr\u00f6\u00dfe gr\u00f6\u00dfer als Anzahl der IDs</li> </ol>"},{"location":"_analysis/chat-orchestration-flow.html#performance-monitoring","title":"Performance-Monitoring","text":"<ul> <li>Timing-Daten werden bereits in <code>QueryRetrievalStep</code> gespeichert</li> <li>Empfehlung: Dashboard f\u00fcr Performance-Metriken erstellen</li> <li>Alerts bei langsamen Queries (&gt;5s) einrichten</li> </ul>"},{"location":"_analysis/cleanup-summary.html","title":"Code Cleanup Summary","text":"<p>Date: 2025-01-XX Status: Phase 1, 2 &amp; 3 Completed \u2705</p>"},{"location":"_analysis/cleanup-summary.html#files-removed","title":"Files Removed","text":""},{"location":"_analysis/cleanup-summary.html#testdevelopment-files-5-files","title":"Test/Development Files (5 files)","text":"<ul> <li>\u2705 <code>src/app/api/auth-test/route.ts</code> - Test API endpoint</li> <li>\u2705 <code>src/app/api/teststorage/route.ts</code> - Test API endpoint</li> <li>\u2705 <code>src/app/api/env-test/route.ts</code> - Test API endpoint</li> <li>\u2705 <code>src/lib/test-env.ts</code> - Test utility</li> </ul>"},{"location":"_analysis/cleanup-summary.html#redundant-files-2-files","title":"Redundant Files (2 files)","text":"<ul> <li>\u2705 <code>src/components/debug/debug-footer-client.tsx</code> - Duplicate wrapper (kept <code>debug-footer-wrapper.tsx</code>)</li> <li>\u2705 <code>src/lib/atoms/library.ts</code> - Unused atoms file (functionality moved to <code>src/atoms/library-atom.ts</code>)</li> </ul>"},{"location":"_analysis/cleanup-summary.html#consolidated-files-1-file","title":"Consolidated Files (1 file)","text":"<ul> <li>\u2705 <code>src/hooks/use-toast.ts</code> - Redundant toast hook (consolidated into <code>src/components/ui/use-toast.ts</code>)</li> <li>Updated <code>src/components/templates/template-management.tsx</code> to use the standard ShadCN version</li> </ul> <p>Total Files Removed: 13 files (7 aus Phase 1 &amp; 2 + 6 Dateien aus Phase 3)</p>"},{"location":"_analysis/cleanup-summary.html#files-kept-not-redundant","title":"Files Kept (Not Redundant)","text":""},{"location":"_analysis/cleanup-summary.html#pdf-defaults","title":"PDF Defaults","text":"<ul> <li>\u2705 <code>src/lib/pdf-defaults.ts</code> - Persistent defaults in localStorage (different purpose)</li> <li>\u2705 <code>src/atoms/pdf-defaults.ts</code> - Runtime overrides in Jotai atoms (different purpose)</li> </ul> <p>Conclusion: These files serve different purposes and are both needed.</p>"},{"location":"_analysis/cleanup-summary.html#files-requiring-evaluation","title":"Files Requiring Evaluation","text":""},{"location":"_analysis/cleanup-summary.html#azure-storage-legacydeprecated","title":"Azure Storage (Legacy/Deprecated)","text":"<ul> <li>\u26a0\ufe0f <code>src/lib/services/azure-storage-service.ts</code> - Still used in <code>ingestion-service.ts</code> (optional)</li> <li>\u26a0\ufe0f <code>src/lib/config/azure-storage.ts</code> - Configuration for Azure Storage</li> </ul> <p>Status: Azure Storage is optional - if not configured, ingestion-service skips image uploads. According to README, Azure Storage was replaced by Nextcloud (in development). These files may still be needed for existing deployments.</p> <p>Recommendation:  - If no existing deployments use Azure Storage, these files can be archived - If Azure Storage is still in use, keep until migration to Nextcloud is complete</p>"},{"location":"_analysis/cleanup-summary.html#phase-3-explore-kontext-analyse","title":"Phase 3: Explore-Kontext Analyse \u2705","text":""},{"location":"_analysis/cleanup-summary.html#analyse-durchgefuhrt","title":"Analyse durchgef\u00fchrt","text":"<ul> <li>Date: 2025-01-XX</li> <li>Report: <code>docs/_analysis/unused-components-explore.md</code></li> <li>Umfang: Vollst\u00e4ndige Analyse von Komponenten, Seiten und Dependencies</li> </ul>"},{"location":"_analysis/cleanup-summary.html#ergebnisse","title":"Ergebnisse","text":""},{"location":"_analysis/cleanup-summary.html#dateien-entfernt","title":"Dateien entfernt \u2705","text":"<ul> <li>\u2705 <code>src/components/library/chat/chat-panel.tsx.backup</code> - Backup-Datei gel\u00f6scht</li> <li>\u2705 <code>src/app/add-test-library/page.tsx</code> - Schatten-Seite gel\u00f6scht</li> <li>\u2705 <code>src/app/api/add-library/route.ts</code> - Ungenutzte API-Route gel\u00f6scht</li> <li>\u2705 <code>src/components/shared/job-trace.tsx</code> - Ungenutzte Komponente gel\u00f6scht</li> <li>\u2705 <code>src/components/shared/key-value-table.tsx</code> - Ungenutzte Komponente gel\u00f6scht</li> <li>\u2705 <code>src/components/shared/storage-auth-button.tsx</code> - Ungenutzte Komponente gel\u00f6scht</li> </ul>"},{"location":"_analysis/cleanup-summary.html#chat-komponenten-analyse","title":"Chat-Komponenten Analyse","text":"<ul> <li>Status: Alle Chat-Komponenten sind aktiv verwendet</li> <li>Total: 29 Komponenten (24 Komponenten + 5 Hooks + 2 Utils)</li> <li>Ungenutzt: 0 Komponenten (alle werden verwendet)</li> <li>Debug-Komponenten: 4 Debug-Komponenten vorhanden (k\u00f6nnen f\u00fcr Production entfernt werden)</li> </ul>"},{"location":"_analysis/cleanup-summary.html#shared-komponenten-analyse","title":"Shared-Komponenten Analyse","text":"<ul> <li>Total: 9 Komponenten</li> <li>Aktiv: 6 Komponenten</li> <li>Potentiell ungenutzt: 3 Komponenten</li> <li><code>job-trace.tsx</code> - Keine Verwendung gefunden</li> <li><code>key-value-table.tsx</code> - Keine Verwendung gefunden</li> <li><code>storage-auth-button.tsx</code> - Keine Verwendung gefunden</li> </ul>"},{"location":"_analysis/cleanup-summary.html#seiten-analyse","title":"Seiten-Analyse","text":"<ul> <li>Total: 27 Seiten</li> <li>Erreichbar: 26 Seiten (\u00fcber Navigation oder Links)</li> <li>Schatten-Seiten: 1 Seite identifiziert</li> <li><code>/add-test-library</code> - Admin/Test-Seite, nicht im Men\u00fc, keine Links</li> </ul>"},{"location":"_analysis/cleanup-summary.html#empfehlungen","title":"Empfehlungen","text":""},{"location":"_analysis/cleanup-summary.html#geloscht","title":"Gel\u00f6scht \u2705","text":"<ul> <li>\u2705 <code>chat-panel.tsx.backup</code> - Backup-Datei</li> <li>\u2705 <code>/add-test-library</code> Seite - Schatten-Seite</li> <li>\u2705 <code>/api/add-library</code> API-Route - Ungenutzte Route</li> <li>\u2705 <code>job-trace.tsx</code> - Ungenutzte Shared-Komponente</li> <li>\u2705 <code>key-value-table.tsx</code> - Ungenutzte Shared-Komponente</li> <li> <p>\u2705 <code>storage-auth-button.tsx</code> - Ungenutzte Shared-Komponente</p> </li> <li> <p>Debug-Komponenten:</p> </li> <li><code>debug-panel.tsx</code></li> <li><code>debug-timeline.tsx</code></li> <li><code>debug-trace.tsx</code></li> <li><code>debug-step-table.tsx</code></li> <li>Empfehlung: F\u00fcr Production entfernen, f\u00fcr Development behalten</li> </ul>"},{"location":"_analysis/cleanup-summary.html#next-steps","title":"Next Steps","text":"<ol> <li>Phase 4: Review Debug-Komponenten f\u00fcr Production</li> <li><code>debug-panel.tsx</code></li> <li><code>debug-timeline.tsx</code></li> <li><code>debug-trace.tsx</code></li> <li><code>debug-step-table.tsx</code></li> <li>Check for commented-out code that can be removed</li> <li>Review deprecated API routes</li> <li>Verify build after cleanup (run <code>pnpm build</code>)</li> </ol>"},{"location":"_analysis/cleanup-summary.html#impact","title":"Impact","text":"<ul> <li>No Breaking Changes: All removed files were either unused or redundant</li> <li>Code Quality: Reduced codebase complexity by removing duplicate implementations</li> <li>Maintainability: Consolidated toast hook usage to single standard implementation</li> </ul>"},{"location":"_analysis/dependencies.html","title":"Dependency Analysis","text":"<p>This document analyzes import patterns and dependencies across the codebase.</p>"},{"location":"_analysis/dependencies.html#most-imported-modules","title":"Most Imported Modules","text":"<p>Based on import analysis (1079 imports from <code>@/</code> across 328 files), the most frequently imported modules are:</p>"},{"location":"_analysis/dependencies.html#core-infrastructure-most-imported","title":"Core Infrastructure (Most Imported)","text":"<ol> <li><code>@/lib/storage/storage-factory.ts</code> - Storage provider factory</li> <li><code>@/lib/storage/types.ts</code> - Storage type definitions</li> <li><code>@/lib/services/library-service.ts</code> - Library service</li> <li><code>@/types/library.ts</code> - Library type definitions</li> <li><code>@/lib/env.ts</code> - Environment variables</li> <li><code>@/lib/auth.ts</code> - Authentication utilities</li> <li><code>@/lib/mongodb-service.ts</code> - Database service</li> </ol>"},{"location":"_analysis/dependencies.html#storage-layer","title":"Storage Layer","text":"<ul> <li><code>@/lib/storage/filesystem-provider.ts</code></li> <li><code>@/lib/storage/onedrive-provider.ts</code></li> <li><code>@/lib/storage/server-provider.ts</code></li> <li><code>@/contexts/storage-context.tsx</code></li> <li><code>@/hooks/use-storage-provider.tsx</code></li> </ul>"},{"location":"_analysis/dependencies.html#chat-system","title":"Chat System","text":"<ul> <li><code>@/lib/chat/orchestrator.ts</code></li> <li><code>@/lib/chat/loader.ts</code></li> <li><code>@/lib/chat/config.ts</code></li> <li><code>@/lib/chat/constants.ts</code></li> <li><code>@/lib/chat/retrievers/chunks.ts</code></li> <li><code>@/lib/chat/retrievers/summaries-mongo.ts</code></li> <li><code>@/lib/chat/common/prompt.ts</code></li> <li><code>@/lib/chat/common/filters.ts</code></li> <li><code>@/lib/chat/common/llm.ts</code></li> </ul>"},{"location":"_analysis/dependencies.html#components","title":"Components","text":"<ul> <li><code>@/components/library/library.tsx</code></li> <li><code>@/components/ui/*</code> (UI components)</li> <li><code>@/components/shared/*</code> (Shared components)</li> </ul>"},{"location":"_analysis/dependencies.html#types","title":"Types","text":"<ul> <li><code>@/types/chat.ts</code></li> <li><code>@/types/chat-response.ts</code></li> <li><code>@/types/query-log.ts</code></li> <li><code>@/types/session.ts</code></li> <li><code>@/types/external-job.ts</code></li> </ul>"},{"location":"_analysis/dependencies.html#dependency-graph-structure","title":"Dependency Graph Structure","text":""},{"location":"_analysis/dependencies.html#layer-1-core-infrastructure-no-internal-dependencies","title":"Layer 1: Core Infrastructure (No internal dependencies)","text":"<ul> <li><code>src/middleware.ts</code></li> <li><code>src/app/layout.tsx</code></li> <li><code>src/instrumentation.ts</code></li> <li><code>src/lib/env.ts</code></li> <li><code>src/lib/auth.ts</code></li> <li><code>src/lib/mongodb-service.ts</code></li> </ul>"},{"location":"_analysis/dependencies.html#layer-2-storage-layer-depends-on-layer-1","title":"Layer 2: Storage Layer (Depends on Layer 1)","text":"<ul> <li><code>src/lib/storage/types.ts</code> \u2192 <code>src/types/library.ts</code></li> <li><code>src/lib/storage/storage-factory.ts</code> \u2192 <code>src/lib/storage/types.ts</code>, <code>src/lib/storage/filesystem-provider.ts</code>, <code>src/lib/storage/onedrive-provider.ts</code></li> <li><code>src/lib/storage/filesystem-provider.ts</code> \u2192 <code>src/lib/storage/types.ts</code>, <code>src/types/library.ts</code></li> <li><code>src/lib/storage/onedrive-provider.ts</code> \u2192 <code>src/lib/storage/types.ts</code>, <code>src/types/library.ts</code></li> <li><code>src/contexts/storage-context.tsx</code> \u2192 <code>src/lib/storage/storage-factory.ts</code></li> <li><code>src/hooks/use-storage-provider.tsx</code> \u2192 <code>src/contexts/storage-context.tsx</code></li> </ul>"},{"location":"_analysis/dependencies.html#layer-3-library-system-depends-on-layer-2","title":"Layer 3: Library System (Depends on Layer 2)","text":"<ul> <li><code>src/types/library.ts</code> \u2192 (no internal deps)</li> <li><code>src/atoms/library-atom.ts</code> \u2192 <code>src/types/library.ts</code></li> <li><code>src/lib/services/library-service.ts</code> \u2192 <code>src/lib/mongodb-service.ts</code>, <code>src/types/library.ts</code></li> <li><code>src/components/library/library.tsx</code> \u2192 <code>src/lib/storage/storage-factory.ts</code>, <code>src/atoms/library-atom.ts</code>, <code>src/lib/services/library-service.ts</code></li> </ul>"},{"location":"_analysis/dependencies.html#layer-4-chat-system-depends-on-layer-3","title":"Layer 4: Chat System (Depends on Layer 3)","text":"<ul> <li><code>src/types/chat.ts</code> \u2192 <code>src/types/library.ts</code></li> <li><code>src/lib/chat/constants.ts</code> \u2192 (no internal deps)</li> <li><code>src/lib/chat/orchestrator.ts</code> \u2192 <code>src/lib/chat/loader.ts</code>, <code>src/lib/chat/common/prompt.ts</code>, <code>src/lib/chat/common/llm.ts</code></li> <li><code>src/lib/chat/loader.ts</code> \u2192 <code>src/lib/services/library-service.ts</code>, <code>src/lib/mongodb-service.ts</code></li> <li><code>src/app/api/chat/[libraryId]/stream/route.ts</code> \u2192 <code>src/lib/chat/orchestrator.ts</code>, <code>src/lib/services/library-service.ts</code></li> </ul>"},{"location":"_analysis/dependencies.html#layer-5-api-routes-components-depends-on-layers-1-4","title":"Layer 5: API Routes &amp; Components (Depends on Layers 1-4)","text":"<ul> <li>All API routes depend on services and libraries</li> <li>Components depend on hooks, contexts, and library code</li> </ul>"},{"location":"_analysis/dependencies.html#circular-dependencies","title":"Circular Dependencies","text":""},{"location":"_analysis/dependencies.html#potential-circular-dependencies-to-check","title":"Potential Circular Dependencies to Check:","text":"<ol> <li>Storage Factory \u2194 Storage Providers</li> <li><code>storage-factory.ts</code> imports providers</li> <li> <p>Providers may import factory (needs verification)</p> </li> <li> <p>Library Service \u2194 Storage Factory</p> </li> <li><code>library-service.ts</code> may use storage</li> <li> <p>Storage may reference library types</p> </li> <li> <p>Chat Orchestrator \u2194 Chat Loader</p> </li> <li><code>orchestrator.ts</code> imports <code>loader.ts</code></li> <li><code>loader.ts</code> may import orchestrator utilities</li> </ol>"},{"location":"_analysis/dependencies.html#unused-imports-to-verify","title":"Unused Imports (To Verify)","text":"<p>Based on commented-out imports found: - <code>src/app/api/external/jobs/[jobId]/route.ts</code> has commented imports:   - <code>FileSystemProvider</code> (commented)   - <code>ImageExtractionService</code> (commented)   - <code>TransformService</code> (commented)   - <code>parseSecretaryMarkdownStrict</code> (marked as unused)</p>"},{"location":"_analysis/dependencies.html#import-patterns","title":"Import Patterns","text":""},{"location":"_analysis/dependencies.html#most-common-import-patterns","title":"Most Common Import Patterns:","text":"<ol> <li>Type Imports: <code>import type { ... } from '@/types/...'</code></li> <li>Component Imports: <code>import { Component } from '@/components/...'</code></li> <li>Service Imports: <code>import { Service } from '@/lib/services/...'</code></li> <li>Utility Imports: <code>import { util } from '@/lib/utils'</code></li> </ol>"},{"location":"_analysis/dependencies.html#import-categories","title":"Import Categories:","text":"<ul> <li>Types: ~15% of imports</li> <li>Components: ~35% of imports</li> <li>Library/Utils: ~30% of imports</li> <li>Hooks/Contexts: ~10% of imports</li> <li>Atoms: ~5% of imports</li> <li>Other: ~5% of imports</li> </ul>"},{"location":"_analysis/dependencies.html#recommendations","title":"Recommendations","text":"<ol> <li>Document Core Modules First: Start with Layer 1 (Core Infrastructure)</li> <li>Follow Dependency Order: Document layers in order (1 \u2192 2 \u2192 3 \u2192 4 \u2192 5)</li> <li>Check Circular Dependencies: Verify and document any circular dependencies found</li> <li>Clean Up Unused Imports: Remove commented imports and verify unused code</li> <li>Standardize Import Patterns: Ensure consistent import style across codebase</li> </ol>"},{"location":"_analysis/dependencies.html#next-steps","title":"Next Steps","text":"<ol> <li>Complete dependency analysis for specific modules</li> <li>Create visual dependency graph</li> <li>Identify and document circular dependencies</li> <li>Create import/export audit report</li> <li>Document module boundaries and interfaces</li> </ol>"},{"location":"_analysis/documentation-progress.html","title":"Documentation Progress","text":"<p>This document tracks the progress of the systematic code documentation effort.</p>"},{"location":"_analysis/documentation-progress.html#phase-1-analysis-structure-mapping","title":"Phase 1: Analysis &amp; Structure Mapping \u2705","text":""},{"location":"_analysis/documentation-progress.html#11-file-inventory","title":"1.1 File Inventory \u2705","text":"<ul> <li>Status: Complete</li> <li>File: <code>docs/_analysis/file-inventory.md</code></li> <li>Content: Complete inventory of all 424 source files categorized by type</li> </ul>"},{"location":"_analysis/documentation-progress.html#12-dependency-analysis","title":"1.2 Dependency Analysis \u2705","text":"<ul> <li>Status: Complete</li> <li>File: <code>docs/_analysis/dependencies.md</code></li> <li>Content: Import pattern analysis, dependency layers, circular dependency checks</li> </ul>"},{"location":"_analysis/documentation-progress.html#13-priority-list","title":"1.3 Priority List \u2705","text":"<ul> <li>Status: Complete</li> <li>Content: Prioritized list of modules for documentation (in plan)</li> </ul>"},{"location":"_analysis/documentation-progress.html#phase-2-jsdoc-headers","title":"Phase 2: JSDoc Headers \u2705","text":""},{"location":"_analysis/documentation-progress.html#core-infrastructure","title":"Core Infrastructure \u2705","text":"<ul> <li>\u2705 <code>src/middleware.ts</code> - Authentication and routing middleware</li> <li>\u2705 <code>src/app/layout.tsx</code> - Root layout component</li> <li>\u2705 <code>src/instrumentation.ts</code> - Next.js instrumentation</li> <li>\u2705 <code>src/lib/env.ts</code> - Environment variable handling</li> <li>\u2705 <code>src/lib/auth.ts</code> - Authentication utilities</li> <li>\u2705 <code>src/lib/mongodb-service.ts</code> - Database service</li> </ul>"},{"location":"_analysis/documentation-progress.html#storage-layer","title":"Storage Layer \u2705","text":"<ul> <li>\u2705 <code>src/lib/storage/types.ts</code> - Storage type definitions</li> <li>\u2705 <code>src/lib/storage/storage-factory.ts</code> - Storage factory</li> <li>\u2705 <code>src/lib/storage/filesystem-provider.ts</code> - Local filesystem provider</li> <li>\u2705 <code>src/lib/storage/onedrive-provider.ts</code> - OneDrive provider</li> <li>\u2705 <code>src/lib/storage/storage-factory-mongodb.ts</code> - MongoDB storage factory</li> <li>\u2705 <code>src/lib/storage/filesystem-client.ts</code> - Filesystem client</li> <li>\u2705 <code>src/lib/storage/server-provider.ts</code> - Server provider helper</li> <li>\u2705 <code>src/lib/storage/supported-types.ts</code> - Supported library types</li> <li>\u2705 <code>src/contexts/storage-context.tsx</code> - Storage React context</li> <li>\u2705 <code>src/hooks/use-storage-provider.tsx</code> - Storage hook</li> </ul>"},{"location":"_analysis/documentation-progress.html#library-system","title":"Library System \u2705","text":"<ul> <li>\u2705 <code>src/types/library.ts</code> - Library type definitions</li> <li>\u2705 <code>src/atoms/library-atom.ts</code> - Library state atoms</li> <li>\u2705 <code>src/lib/services/library-service.ts</code> - Library service</li> <li>\u2705 <code>src/components/library/library.tsx</code> - Main library component</li> </ul>"},{"location":"_analysis/documentation-progress.html#chat-system","title":"Chat System \u2705","text":"<ul> <li>\u2705 <code>src/types/chat.ts</code> - Chat type definitions</li> <li>\u2705 <code>src/lib/chat/constants.ts</code> - Chat constants</li> <li>\u2705 <code>src/lib/chat/orchestrator.ts</code> - Chat orchestration</li> <li>\u2705 <code>src/lib/chat/loader.ts</code> - Chat loader</li> <li>\u2705 <code>src/lib/chat/config.ts</code> - Chat configuration</li> <li>\u2705 <code>src/lib/chat/retrievers/chunks.ts</code> - Chunk retriever</li> <li>\u2705 <code>src/lib/chat/retrievers/summaries-mongo.ts</code> - Summary retriever</li> <li>\u2705 <code>src/lib/chat/common/prompt.ts</code> - Prompt building utilities</li> <li>\u2705 <code>src/lib/chat/common/llm.ts</code> - LLM calling utilities</li> <li>\u2705 <code>src/app/api/chat/[libraryId]/stream/route.ts</code> - Chat streaming endpoint</li> </ul>"},{"location":"_analysis/documentation-progress.html#external-jobs-system","title":"External Jobs System \u2705","text":"<ul> <li>\u2705 <code>src/lib/external-jobs-repository.ts</code> - MongoDB repository for external jobs</li> <li>\u2705 <code>src/lib/external-jobs-worker.ts</code> - Background worker for processing jobs</li> <li>\u2705 <code>src/lib/external-jobs-watchdog.ts</code> - Timeout monitoring for jobs</li> <li>\u2705 <code>src/lib/external-jobs/context.ts</code> - Request context parsing</li> <li>\u2705 <code>src/lib/external-jobs/auth.ts</code> - Authorization and bypass checks</li> <li>\u2705 <code>src/lib/external-jobs/policies.ts</code> - Phase policy extraction</li> <li>\u2705 <code>src/lib/external-jobs/template-decision.ts</code> - Template execution decision logic</li> <li>\u2705 <code>src/lib/external-jobs/template-run.ts</code> - Template transformation execution</li> <li>\u2705 <code>src/lib/external-jobs/chapters.ts</code> - Chapter detection and merging</li> <li>\u2705 <code>src/lib/external-jobs/storage.ts</code> - Markdown file storage</li> <li>\u2705 <code>src/lib/external-jobs/images.ts</code> - Image archive extraction</li> <li>\u2705 <code>src/lib/external-jobs/ingest.ts</code> - RAG ingestion pipeline</li> <li>\u2705 <code>src/lib/external-jobs/complete.ts</code> - Job completion handler</li> <li>\u2705 <code>src/lib/external-jobs/preprocess.ts</code> - Job preprocessing and analysis</li> <li>\u2705 <code>src/lib/external-jobs/provider.ts</code> - Storage provider construction</li> <li>\u2705 <code>src/lib/external-jobs/progress.ts</code> - Progress update processing</li> <li>\u2705 <code>src/app/api/external/jobs/[jobId]/route.ts</code> - Main job processing endpoint</li> <li>\u2705 <code>src/app/api/external/jobs/[jobId]/start/route.ts</code> - Job execution trigger</li> <li>\u2705 <code>src/app/api/external/jobs/route.ts</code> - Job query endpoint</li> </ul>"},{"location":"_analysis/documentation-progress.html#secretary-service","title":"Secretary Service \u2705","text":"<ul> <li>\u2705 <code>src/lib/secretary/client.ts</code> - HTTP client for Secretary Service API</li> <li>\u2705 <code>src/lib/secretary/adapter.ts</code> - Low-level API call functions</li> <li>\u2705 <code>src/lib/secretary/response-parser.ts</code> - Markdown response parsing</li> <li>\u2705 <code>src/lib/secretary/types.ts</code> - Type definitions for Secretary Service</li> <li>\u2705 <code>src/app/api/secretary/process-pdf/route.ts</code> - PDF transformation endpoint</li> <li>\u2705 <code>src/app/api/secretary/process-audio/route.ts</code> - Audio transformation endpoint</li> <li>\u2705 <code>src/app/api/secretary/process-video/route.ts</code> - Video transformation endpoint</li> <li>\u2705 <code>src/app/api/secretary/process-image/route.ts</code> - Image OCR endpoint</li> <li>\u2705 <code>src/app/api/secretary/session/process/route.ts</code> - Session import endpoint</li> </ul>"},{"location":"_analysis/documentation-progress.html#event-job-system","title":"Event Job System \u2705","text":"<ul> <li>\u2705 <code>src/lib/event-job-repository.ts</code> - MongoDB repository for event jobs</li> <li>\u2705 <code>src/lib/session/session-processor.ts</code> - Session data processing utilities</li> <li>\u2705 <code>src/lib/session-repository.ts</code> - MongoDB repository for sessions</li> <li>\u2705 <code>src/app/api/event-job/jobs/[jobId]/route.ts</code> - Individual job operations</li> <li>\u2705 <code>src/app/api/event-job/batches/[batchId]/route.ts</code> - Individual batch operations</li> <li>\u2705 <code>src/app/api/event-job/events/route.ts</code> - Event list and migration</li> </ul>"},{"location":"_analysis/documentation-progress.html#transform-processing","title":"Transform &amp; Processing \u2705","text":"<ul> <li>\u2705 <code>src/lib/transform/transform-service.ts</code> - Central transformation service</li> <li>\u2705 <code>src/lib/transform/image-extraction-service.ts</code> - PDF image extraction and storage</li> <li>\u2705 <code>src/lib/processing/gates.ts</code> - Phase gate checking utilities</li> <li>\u2705 <code>src/lib/processing/phase-policy.ts</code> - Processing phase control policies</li> </ul>"},{"location":"_analysis/documentation-progress.html#database-repositories","title":"Database Repositories \u2705","text":"<ul> <li>\u2705 <code>src/lib/db/chats-repo.ts</code> - MongoDB repository for chat management</li> <li>\u2705 <code>src/lib/db/queries-repo.ts</code> - MongoDB repository for query logging</li> <li>\u2705 <code>src/lib/repositories/doc-meta-repo.ts</code> - MongoDB repository for document metadata</li> </ul>"},{"location":"_analysis/documentation-progress.html#api-routes","title":"API Routes \u2705","text":"<ul> <li>\u2705 <code>src/app/api/storage/filesystem/route.ts</code> - Filesystem storage API</li> <li>\u2705 <code>src/app/api/libraries/route.ts</code> - Library management API</li> </ul>"},{"location":"_analysis/documentation-progress.html#phase-3-index-overview","title":"Phase 3: Index &amp; Overview \u2705","text":""},{"location":"_analysis/documentation-progress.html#31-file-index-table","title":"3.1 File Index Table \u2705","text":"<ul> <li>Status: Complete</li> <li>File: <code>docs/reference/file-index.md</code></li> <li>Content: Table of documented files with descriptions, exports, and usage</li> </ul>"},{"location":"_analysis/documentation-progress.html#32-module-hierarchy-tree","title":"3.2 Module Hierarchy Tree \u2705","text":"<ul> <li>Status: Complete</li> <li>File: <code>docs/architecture/module-hierarchy.md</code></li> <li>Content: Visual tree structure of module organization</li> </ul>"},{"location":"_analysis/documentation-progress.html#33-dependency-graph","title":"3.3 Dependency Graph \u2705","text":"<ul> <li>Status: Complete</li> <li>File: <code>docs/architecture/dependency-graph.md</code></li> <li>Content: Mermaid diagram showing dependencies</li> </ul>"},{"location":"_analysis/documentation-progress.html#phase-4-module-documentation","title":"Phase 4: Module Documentation \u2705","text":""},{"location":"_analysis/documentation-progress.html#41-module-documentation-files","title":"4.1 Module Documentation Files \u2705","text":"<ul> <li>Status: Complete (initial version)</li> <li>Files: </li> <li><code>docs/reference/modules/storage.md</code></li> <li><code>docs/reference/modules/library.md</code></li> <li><code>docs/reference/modules/chat.md</code></li> <li>Content: Detailed documentation for each major module</li> </ul>"},{"location":"_analysis/documentation-progress.html#42-link-code-to-documentation","title":"4.2 Link Code to Documentation \u23f3","text":"<ul> <li>Status: Pending</li> <li>Content: Add links in JSDoc comments to documentation files</li> </ul>"},{"location":"_analysis/documentation-progress.html#phase-5-cleanup-validation","title":"Phase 5: Cleanup &amp; Validation \u23f3","text":""},{"location":"_analysis/documentation-progress.html#51-unused-code-detection","title":"5.1 Unused Code Detection \u23f3","text":"<ul> <li>Status: Pending</li> <li>Content: Scan for unused exports and dead code</li> </ul>"},{"location":"_analysis/documentation-progress.html#52-redundancy-detection","title":"5.2 Redundancy Detection \u23f3","text":"<ul> <li>Status: Pending</li> <li>Content: Find duplicate functionality</li> </ul>"},{"location":"_analysis/documentation-progress.html#statistics","title":"Statistics","text":"<ul> <li>Total Files: ~424 files</li> <li>Documented Files: 71 files</li> <li>Documentation Progress: ~16.7%</li> <li>Analysis Complete: \u2705</li> <li>Index Created: \u2705</li> <li>Module Documentation: \u2705</li> </ul>"},{"location":"_analysis/documentation-progress.html#completed-modules","title":"Completed Modules","text":""},{"location":"_analysis/documentation-progress.html#core-infrastructure-6-files","title":"Core Infrastructure (6 files) \u2705","text":"<ul> <li>Middleware, Layout, Instrumentation</li> <li>Environment, Auth, Database</li> </ul>"},{"location":"_analysis/documentation-progress.html#storage-layer-10-files","title":"Storage Layer (10 files) \u2705","text":"<ul> <li>Types, Factory, Providers</li> <li>Client, Server, Context, Hooks</li> </ul>"},{"location":"_analysis/documentation-progress.html#library-system-4-files","title":"Library System (4 files) \u2705","text":"<ul> <li>Types, Atoms, Service, Main Component</li> </ul>"},{"location":"_analysis/documentation-progress.html#chat-system-9-files","title":"Chat System (9 files) \u2705","text":"<ul> <li>Types, Constants, Orchestrator</li> <li>Loader, Config, Retrievers</li> <li>Common utilities, API Route</li> </ul>"},{"location":"_analysis/documentation-progress.html#external-jobs-system-18-files","title":"External Jobs System (18 files) \u2705","text":"<ul> <li>Repository, Worker, Watchdog</li> <li>Orchestration modules (context, auth, policies, template, chapters, storage, images, ingest, complete)</li> <li>Preprocessing, Provider, Progress</li> <li>API Routes (job callback, start, list)</li> </ul>"},{"location":"_analysis/documentation-progress.html#secretary-service-9-files","title":"Secretary Service (9 files) \u2705","text":"<ul> <li>Client, Adapter, Response Parser, Types</li> <li>API Routes (PDF, audio, video, image, session)</li> </ul>"},{"location":"_analysis/documentation-progress.html#event-job-system-6-files","title":"Event Job System (6 files) \u2705","text":"<ul> <li>Repository, Session Processor, Session Repository</li> <li>API Routes (jobs, batches, events)</li> </ul>"},{"location":"_analysis/documentation-progress.html#transform-processing-4-files","title":"Transform &amp; Processing (4 files) \u2705","text":"<ul> <li>Transform Service, Image Extraction Service</li> <li>Processing Gates, Phase Policy</li> </ul>"},{"location":"_analysis/documentation-progress.html#database-repositories-3-files","title":"Database Repositories (3 files) \u2705","text":"<ul> <li>Chats Repository, Queries Repository, Document Metadata Repository</li> </ul>"},{"location":"_analysis/documentation-progress.html#api-routes-2-files","title":"API Routes (2 files) \u2705","text":"<ul> <li>Storage API, Libraries API</li> </ul>"},{"location":"_analysis/documentation-progress.html#next-steps","title":"Next Steps","text":"<ol> <li>Continue documenting remaining API routes</li> <li>Document remaining components</li> <li>Document remaining hooks and utilities</li> <li>Add links from code to documentation files</li> <li>Perform cleanup and validation</li> <li>Create additional module documentation as needed</li> </ol>"},{"location":"_analysis/documentation-progress.html#notes","title":"Notes","text":"<ul> <li>JSDoc headers follow the template from the plan</li> <li>Files are documented in dependency order (top to bottom)</li> <li>Index and hierarchy are created and updated</li> <li>Module documentation provides comprehensive overviews</li> <li>All documented files include: @fileoverview, @description, @module, @exports, @usedIn, @dependencies</li> </ul>"},{"location":"_analysis/documentation-updates-linter-fixes.html","title":"Dokumentationsaktualisierungen - Linter-Fehler Behebung","text":"<p>Datum: 2025-01-XX Kontext: Systematische Behebung aller Linter-Fehler im Build-Prozess</p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#zusammenfassung","title":"Zusammenfassung","text":"<p>Im Rahmen der Linter-Fehler-Behebung wurden mehrere API-Signaturen ge\u00e4ndert, Import-Pfade korrigiert und unbenutzte Exporte entfernt. Diese \u00c4nderungen m\u00fcssen in der Dokumentation reflektiert werden.</p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#kritische-api-anderungen","title":"Kritische API-\u00c4nderungen","text":""},{"location":"_analysis/documentation-updates-linter-fixes.html#1-userootitems-hook-signatur-geandert","title":"1. <code>useRootItems</code> Hook - Signatur ge\u00e4ndert","text":"<p>Datei: <code>src/hooks/use-root-items.ts</code></p> <p>\u00c4nderung: - Vorher: <code>useRootItems(provider?: StorageProvider | null)</code> - Nachher: <code>useRootItems()</code></p> <p>Grund: Provider wird jetzt intern aus <code>useStorage()</code> Context geladen, kein Parameter mehr n\u00f6tig.</p> <p>Betroffene Dokumentation: - <code>docs/reference/modules/library.md</code> - Falls <code>useRootItems</code> dort dokumentiert ist - <code>docs/reference/file-index.md</code> - Falls dort erw\u00e4hnt - Alle Use-Cases die <code>useRootItems</code> verwenden</p> <p>Aktualisierung erforderlich: <pre><code>// \u274c ALT (falsch)\nconst getRootItems = useRootItems(provider);\n\n// \u2705 NEU (korrekt)\nconst getRootItems = useRootItems();\n</code></pre></p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#2-getvectorindexforlibrary-parameter-entfernt","title":"2. <code>getVectorIndexForLibrary</code> - Parameter entfernt","text":"<p>Datei: <code>src/lib/chat/config.ts</code></p> <p>\u00c4nderung: - Vorher: <code>getVectorIndexForLibrary(library, chatConfig?, userEmail?)</code> - Nachher: <code>getVectorIndexForLibrary(library, chatConfig?)</code></p> <p>Grund: <code>userEmail</code> Parameter wurde nicht verwendet und entfernt.</p> <p>Betroffene Dokumentation: - <code>docs/reference/modules/chat.md</code> - Falls dort dokumentiert - <code>docs/reference/file-index.md</code> - Zeile 50 erw\u00e4hnt die Funktion</p> <p>Aktualisierung erforderlich: <pre><code>// \u274c ALT (falsch)\nconst index = getVectorIndexForLibrary(library, config, userEmail);\n\n// \u2705 NEU (korrekt)\nconst index = getVectorIndexForLibrary(library, config);\n</code></pre></p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#3-getfiltereddocumentcount-signatur-erweitert","title":"3. <code>getFilteredDocumentCount</code> - Signatur erweitert","text":"<p>Datei: <code>src/lib/db/queries-repo.ts</code></p> <p>\u00c4nderung: - Vorher: <code>getFilteredDocumentCount(library: Library, filter: Record&lt;string, unknown&gt;)</code> - Nachher: <code>getFilteredDocumentCount(libraryOrId: Library | string, filter: Record&lt;string, unknown&gt;)</code></p> <p>Grund: Funktion akzeptiert jetzt auch <code>libraryId</code> (string) direkt, um flexibler zu sein.</p> <p>Betroffene Dokumentation: - <code>docs/reference/file-index.md</code> - Falls dort dokumentiert - <code>docs/reference/modules/chat.md</code> - Falls dort erw\u00e4hnt</p> <p>Aktualisierung erforderlich: <pre><code>// \u2705 Beide Varianten sind jetzt m\u00f6glich:\nconst count1 = await getFilteredDocumentCount(library, filter);\nconst count2 = await getFilteredDocumentCount(libraryId, filter);\n</code></pre></p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#4-findorcreateshadowtwinfolder-ruckgabetyp-geandert","title":"4. <code>findOrCreateShadowTwinFolder</code> - R\u00fcckgabetyp ge\u00e4ndert","text":"<p>Datei: <code>src/lib/external-jobs/shadow-twin-helpers.ts</code></p> <p>\u00c4nderung: - Vorher: R\u00fcckgabetyp war <code>Promise&lt;StorageItem | undefined&gt;</code> (implizit) - Nachher: R\u00fcckgabetyp ist explizit <code>Promise&lt;string | undefined&gt;</code> (nur ID)</p> <p>Grund: Funktion gibt jetzt nur die Folder-ID zur\u00fcck, nicht das komplette StorageItem-Objekt.</p> <p>Betroffene Dokumentation: - <code>docs/architecture/shadow-twin.md</code> - Falls dort Usage-Beispiele vorhanden - <code>docs/reference/file-index.md</code> - Falls dort erw\u00e4hnt</p> <p>Aktualisierung erforderlich: <pre><code>// \u274c ALT (falsch)\nconst folder = await findOrCreateShadowTwinFolder(...);\nif (folder) {\n  const folderId = folder.id;\n  const folderName = folder.metadata.name;\n}\n\n// \u2705 NEU (korrekt)\nconst folderId = await findOrCreateShadowTwinFolder(...);\nif (folderId) {\n  // Verwende folderId direkt\n}\n</code></pre></p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#import-pfad-korrekturen","title":"Import-Pfad-Korrekturen","text":""},{"location":"_analysis/documentation-updates-linter-fixes.html#5-shadowtwinstate-import-pfad","title":"5. <code>ShadowTwinState</code> Import-Pfad","text":"<p>\u00c4nderung: - Vorher: <code>import { ShadowTwinState } from '@/atoms/shadow-twin-atom'</code> - Nachher: <code>import { ShadowTwinState } from '@/lib/shadow-twin/shared'</code></p> <p>Betroffene Dateien: - <code>src/hooks/use-shadow-twin-analysis.ts</code></p> <p>Dokumentation: Keine direkte Aktualisierung n\u00f6tig, da dies interne Implementierungsdetails sind.</p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#6-externaljob-import-pfad","title":"6. <code>ExternalJob</code> Import-Pfad","text":"<p>\u00c4nderung: - Vorher: <code>import type { ExternalJob } from '@/types/external-jobs'</code> - Nachher: <code>import type { ExternalJob } from '@/types/external-job'</code></p> <p>Betroffene Dateien: - <code>src/lib/external-jobs/shadow-twin-helpers.ts</code></p> <p>Dokumentation: Keine direkte Aktualisierung n\u00f6tig, da dies interne Implementierungsdetails sind.</p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#7-tomongoshadowtwinstate-import-pfad","title":"7. <code>toMongoShadowTwinState</code> Import-Pfad","text":"<p>\u00c4nderung: - Vorher: <code>import { toMongoShadowTwinState } from '@/lib/shadow-twin/analyze-shadow-twin'</code> - Nachher: <code>import { toMongoShadowTwinState } from '@/lib/shadow-twin/shared'</code></p> <p>Betroffene Dateien: - <code>src/lib/external-jobs/extract-only.ts</code></p> <p>Dokumentation: Falls in <code>docs/architecture/shadow-twin.md</code> Code-Referenzen vorhanden sind, sollten diese aktualisiert werden.</p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#entfernte-exporte","title":"Entfernte Exporte","text":""},{"location":"_analysis/documentation-updates-linter-fixes.html#8-maybeprocessimages-entfernt","title":"8. <code>maybeProcessImages</code> entfernt","text":"<p>Datei: <code>src/lib/external-jobs/images.ts</code></p> <p>\u00c4nderung: Export <code>maybeProcessImages</code> wurde entfernt, da unbenutzt.</p> <p>Betroffene Dokumentation: - <code>docs/reference/file-index.md</code> - Zeile 71 erw\u00e4hnt <code>maybeProcessImages</code> als Export</p> <p>Aktualisierung erforderlich: <pre><code>| `src/lib/external-jobs/images.ts` | external-jobs | Image archive extraction | `processAllImageSources` | Job callback |\n</code></pre></p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#9-unbenutzte-parameter-entfernt","title":"9. Unbenutzte Parameter entfernt","text":"<p>Betroffene Funktionen: - <code>TransformSaveOptions</code> - <code>defaultIncludeOcrImages</code> und <code>defaultIncludePageImages</code> Parameter hinzugef\u00fcgt (waren in Interface definiert, aber nicht in Funktionssignatur)</p> <p>Dokumentation: Keine direkte Aktualisierung n\u00f6tig, da dies interne Implementierungsdetails sind.</p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#type-assertions-hinzugefugt","title":"Type-Assertions hinzugef\u00fcgt","text":""},{"location":"_analysis/documentation-updates-linter-fixes.html#10-indexoverride-type-assertions","title":"10. <code>indexOverride</code> Type-Assertions","text":"<p>Datei: <code>src/lib/chat/loader.ts</code></p> <p>\u00c4nderung: <code>indexOverride</code> existiert nicht mehr im Typ <code>LibraryChatConfig.vectorStore</code>, wird aber f\u00fcr Migration noch verwendet. Type-Assertions hinzugef\u00fcgt.</p> <p>Dokumentation: Keine direkte Aktualisierung n\u00f6tig, da dies interne Migrations-Logik ist.</p>"},{"location":"_analysis/documentation-updates-linter-fixes.html#empfohlene-dokumentationsaktualisierungen","title":"Empfohlene Dokumentationsaktualisierungen","text":""},{"location":"_analysis/documentation-updates-linter-fixes.html#prioritat-hoch","title":"Priorit\u00e4t: HOCH","text":"<ol> <li><code>docs/reference/file-index.md</code></li> <li>Zeile 50: <code>getVectorIndexForLibrary</code> - Parameter-Liste aktualisieren</li> <li> <p>Zeile 71: <code>maybeProcessImages</code> entfernen, durch <code>processAllImageSources</code> ersetzen</p> </li> <li> <p><code>docs/reference/modules/library.md</code></p> </li> <li> <p>Falls <code>useRootItems</code> dort dokumentiert ist: Signatur aktualisieren</p> </li> <li> <p><code>docs/reference/modules/chat.md</code></p> </li> <li>Falls <code>getVectorIndexForLibrary</code> dort dokumentiert ist: Signatur aktualisieren</li> </ol>"},{"location":"_analysis/documentation-updates-linter-fixes.html#prioritat-mittel","title":"Priorit\u00e4t: MITTEL","text":"<ol> <li><code>docs/architecture/shadow-twin.md</code></li> <li>Usage-Beispiele f\u00fcr <code>findOrCreateShadowTwinFolder</code> aktualisieren (falls vorhanden)</li> <li> <p>Code-Referenzen f\u00fcr <code>toMongoShadowTwinState</code> Import-Pfad pr\u00fcfen</p> </li> <li> <p><code>docs/reference/modules/storage.md</code></p> </li> <li>Falls <code>getFilteredDocumentCount</code> dort dokumentiert ist: Signatur aktualisieren</li> </ol>"},{"location":"_analysis/documentation-updates-linter-fixes.html#prioritat-niedrig","title":"Priorit\u00e4t: NIEDRIG","text":"<ol> <li>Use-Case Dokumentation</li> <li>Alle Use-Cases pr\u00fcfen, die <code>useRootItems</code> verwenden</li> <li>Code-Beispiele aktualisieren</li> </ol>"},{"location":"_analysis/documentation-updates-linter-fixes.html#nicht-dokumentationsrelevant","title":"Nicht dokumentationsrelevant","text":"<p>Folgende \u00c4nderungen sind rein intern und ben\u00f6tigen keine Dokumentationsaktualisierung:</p> <ul> <li>Entfernung unbenutzter Variablen (<code>UILogger</code>, <code>startupT0Ref</code>, <code>NavigationLogger</code>, etc.)</li> <li><code>prefer-const</code> Korrekturen</li> <li>Unescaped Entities in JSX</li> <li>React Hook Dependencies Warnungen (sind Warnungen, keine Fehler)</li> </ul>"},{"location":"_analysis/documentation-updates-linter-fixes.html#nachste-schritte","title":"N\u00e4chste Schritte","text":"<ol> <li>\u2705 Build erfolgreich - alle kritischen Fehler behoben</li> <li>\u2705 Dokumentationsdateien aktualisieren (siehe oben)</li> <li>\u2705 Code-Beispiele in Dokumentation aktualisiert</li> <li>\u23f3 Changelog aktualisieren (falls vorhanden)</li> </ol>"},{"location":"_analysis/documentation-updates-linter-fixes.html#durchgefuhrte-aktualisierungen","title":"Durchgef\u00fchrte Aktualisierungen","text":""},{"location":"_analysis/documentation-updates-linter-fixes.html#aktualisiert-2025-01-xx","title":"\u2705 Aktualisiert (2025-01-XX)","text":"<ol> <li><code>docs/reference/file-index.md</code></li> <li>\u2705 <code>getVectorIndexForLibrary</code> - Signatur mit Parameter-Liste aktualisiert</li> <li>\u2705 <code>maybeProcessImages</code> \u2192 <code>processAllImageSources</code> korrigiert</li> <li>\u2705 <code>getFilteredDocumentCount</code> - Signatur mit <code>libraryOrId</code> dokumentiert</li> <li> <p>\u2705 <code>findOrCreateShadowTwinFolder</code> - Hinzugef\u00fcgt mit korrektem R\u00fcckgabetyp</p> </li> <li> <p><code>docs/reference/modules/chat.md</code></p> </li> <li>\u2705 <code>getVectorIndexForLibrary</code> zu Exports hinzugef\u00fcgt</li> <li> <p>\u2705 Usage-Beispiel f\u00fcr <code>getVectorIndexForLibrary</code> hinzugef\u00fcgt</p> </li> <li> <p><code>docs/reference/modules/library.md</code></p> </li> <li> <p>\u2705 Usage-Beispiel f\u00fcr <code>useRootItems</code> und <code>useRootItemsSync</code> hinzugef\u00fcgt</p> </li> <li> <p><code>docs/architecture/shadow-twin.md</code></p> </li> <li>\u2705 Usage-Beispiel f\u00fcr <code>findOrCreateShadowTwinFolder</code> hinzugef\u00fcgt</li> <li>\u2705 R\u00fcckgabetyp (<code>string | undefined</code>) dokumentiert</li> </ol>"},{"location":"_analysis/documentation-updates-linter-fixes.html#nicht-erforderlich","title":"\u23f3 Nicht erforderlich","text":"<ul> <li>Use-Cases enthalten keine Code-Beispiele mit den ge\u00e4nderten Funktionen</li> <li><code>docs/reference/modules/storage.md</code> - enth\u00e4lt keine Referenz zu <code>getFilteredDocumentCount</code></li> </ul>"},{"location":"_analysis/email-service-provider-examples.html","title":"Mailjet E-Mail-Service Implementierung","text":"<p>Diese Dokumentation beschreibt die Implementierung des E-Mail-Services mit Mailjet f\u00fcr das Einladungssystem.</p>"},{"location":"_analysis/email-service-provider-examples.html#interface-definition","title":"Interface-Definition","text":"<p>Der E-Mail-Service muss folgendes Interface erf\u00fcllen:</p> <pre><code>interface InvitationEmailData {\n  to: string;\n  name: string;\n  subject: string;\n  inviterName: string;\n  organizationName?: string;\n  loginUrl: string;\n  personalMessage?: string;\n}\n\ninterface EmailService {\n  sendInvitationEmail(data: InvitationEmailData): Promise&lt;boolean&gt;;\n}\n</code></pre>"},{"location":"_analysis/email-service-provider-examples.html#mailjet-implementierung","title":"Mailjet Implementierung","text":"<p>Package: <code>node-mailjet</code></p> <p>Installation: <pre><code>npm install node-mailjet\n</code></pre></p> <p>Implementierung:</p> <pre><code>import Mailjet from 'node-mailjet'\n\nconst mailjet = new Mailjet({\n  apiKey: process.env.MAILJET_API_KEY,\n  apiSecret: process.env.MAILJET_API_SECRET,\n})\n\nexport class EmailService {\n  static async sendInvitationEmail(data: InvitationEmailData): Promise&lt;boolean&gt; {\n    try {\n      await mailjet.post('send', { version: 'v3.1' }).request({\n        Messages: [{\n          From: {\n            Email: process.env.MAILJET_FROM_EMAIL,\n            Name: process.env.MAILJET_FROM_NAME\n          },\n          To: [{\n            Email: data.to,\n            Name: data.name\n          }],\n          Subject: data.subject,\n          HTMLPart: this.generateHTML(data),\n          TextPart: this.generateText(data)\n        }]\n      })\n      return true\n    } catch (error) {\n      console.error('E-Mail-Versand Fehler:', error)\n      return false\n    }\n  }\n\n  private static generateHTML(data: InvitationEmailData): string {\n    return `\n      &lt;div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\"&gt;\n        &lt;h2 style=\"color: #2d5016;\"&gt;Sie wurden eingeladen!&lt;/h2&gt;\n\n        &lt;p&gt;Hallo ${data.name},&lt;/p&gt;\n\n        &lt;p&gt;${data.inviterName} hat Sie eingeladen${data.organizationName ? ` (${data.organizationName})` : ''}.&lt;/p&gt;\n\n        ${data.personalMessage ? `\n        &lt;div style=\"background-color: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #2d5016; margin: 20px 0;\"&gt;\n          &lt;p style=\"margin: 0; font-style: italic; color: #2d5016;\"&gt;\n            &lt;strong&gt;Pers\u00f6nliche Nachricht von ${data.inviterName}:&lt;/strong&gt;&lt;br&gt;\n            \"${data.personalMessage}\"\n          &lt;/p&gt;\n        &lt;/div&gt;\n        ` : ''}\n\n        &lt;div style=\"background-color: #e8f5e8; padding: 20px; border-radius: 8px; margin: 20px 0;\"&gt;\n          &lt;h3 style=\"color: #2d5016; margin-top: 0;\"&gt;Ihre Registrierung:&lt;/h3&gt;\n          &lt;p style=\"margin: 10px 0;\"&gt;&lt;strong&gt;E-Mail:&lt;/strong&gt; ${data.to}&lt;/p&gt;\n          &lt;p style=\"margin: 10px 0;\"&gt;&lt;strong&gt;Name:&lt;/strong&gt; ${data.name}&lt;/p&gt;\n        &lt;/div&gt;\n\n        &lt;div style=\"text-align: center; margin: 30px 0;\"&gt;\n          &lt;a href=\"${data.loginUrl}\" \n             style=\"background-color: #2d5016; color: white; padding: 12px 30px; \n                    text-decoration: none; border-radius: 5px; display: inline-block;\"&gt;\n            Einladung annehmen &amp; direkt starten\n          &lt;/a&gt;\n        &lt;/div&gt;\n\n        &lt;p style=\"color: #666; font-size: 14px;\"&gt;\n          Bei Fragen antworten Sie einfach auf diese E-Mail oder wenden Sie sich an ${data.inviterName}.\n        &lt;/p&gt;\n      &lt;/div&gt;\n    `\n  }\n\n  private static generateText(data: InvitationEmailData): string {\n    return `\n      Sie wurden eingeladen!\n\n      Hallo ${data.name},\n\n      ${data.inviterName} hat Sie eingeladen${data.organizationName ? ` (${data.organizationName})` : ''}.\n\n      ${data.personalMessage ? `Pers\u00f6nliche Nachricht von ${data.inviterName}: \"${data.personalMessage}\"` : ''}\n\n      Ihre Registrierung:\n      E-Mail: ${data.to}\n      Name: ${data.name}\n\n      Einladung annehmen: ${data.loginUrl}\n\n      Wichtig: Klicken Sie auf den Link, um Ihre Einladung anzunehmen.\n    `\n  }\n}\n</code></pre> <p>Umgebungsvariablen: <pre><code>MAILJET_API_KEY=your-api-key\nMAILJET_API_SECRET=your-api-secret\nMAILJET_FROM_EMAIL=noreply@example.com\nMAILJET_FROM_NAME=Meine App\n</code></pre></p> <p>Hinweis: In der aktuellen Implementierung werden <code>MAILJET_FROM_EMAIL</code> und <code>MAILJET_FROM_NAME</code> verwendet. Alternativ k\u00f6nnen auch <code>EMAIL_FROM_EMAIL</code> und <code>EMAIL_FROM_NAME</code> verwendet werden, wenn eine allgemeinere Namensgebung bevorzugt wird.</p>"},{"location":"_analysis/email-service-provider-examples.html#e-mail-templates","title":"E-Mail-Templates","text":""},{"location":"_analysis/email-service-provider-examples.html#html-template","title":"HTML-Template","text":"<p>Das HTML-Template enth\u00e4lt: - Responsive Design mit inline Styles - Pers\u00f6nliche Begr\u00fc\u00dfung - Organisations-Informationen (falls vorhanden) - Pers\u00f6nliche Nachricht (falls vorhanden) - Registrierungsinformationen - Call-to-Action Button mit Einladungslink - Kontaktinformationen</p>"},{"location":"_analysis/email-service-provider-examples.html#text-template","title":"Text-Template","text":"<p>Das Text-Template ist eine Fallback-Version f\u00fcr E-Mail-Clients ohne HTML-Unterst\u00fctzung und enth\u00e4lt alle wichtigen Informationen als reiner Text.</p>"},{"location":"_analysis/email-service-provider-examples.html#testing","title":"Testing","text":""},{"location":"_analysis/email-service-provider-examples.html#mock-implementierung-fur-tests","title":"Mock-Implementierung f\u00fcr Tests","text":"<p>F\u00fcr Tests kann ein Mock-Service verwendet werden:</p> <pre><code>export class MockEmailService {\n  private static sentEmails: InvitationEmailData[] = []\n\n  static async sendInvitationEmail(data: InvitationEmailData): Promise&lt;boolean&gt; {\n    this.sentEmails.push(data)\n    return true\n  }\n\n  static getSentEmails(): InvitationEmailData[] {\n    return this.sentEmails\n  }\n\n  static clearSentEmails(): void {\n    this.sentEmails = []\n  }\n}\n</code></pre> <p>Verwendung in Tests: <pre><code>// In Tests\nimport { MockEmailService } from './mock-email-service'\n\nbeforeEach(() =&gt; {\n  MockEmailService.clearSentEmails()\n})\n\ntest('sends invitation email', async () =&gt; {\n  await sendInvitation({ email: 'test@example.com' })\n\n  const sentEmails = MockEmailService.getSentEmails()\n  expect(sentEmails).toHaveLength(1)\n  expect(sentEmails[0].to).toBe('test@example.com')\n})\n</code></pre></p>"},{"location":"_analysis/email-service-provider-examples.html#mailjet-konfiguration","title":"Mailjet-Konfiguration","text":""},{"location":"_analysis/email-service-provider-examples.html#api-schlussel-erhalten","title":"API-Schl\u00fcssel erhalten","text":"<ol> <li>Registrieren Sie sich bei Mailjet</li> <li>Gehen Sie zu Account Settings \u2192 API Keys</li> <li>Kopieren Sie den API Key und API Secret</li> <li>F\u00fcgen Sie diese in Ihre <code>.env</code>-Datei ein</li> </ol>"},{"location":"_analysis/email-service-provider-examples.html#absender-e-mail-verifizieren","title":"Absender-E-Mail verifizieren","text":"<ol> <li>Gehen Sie zu Senders &amp; Domains</li> <li>F\u00fcgen Sie Ihre E-Mail-Adresse oder Domain hinzu</li> <li>Verifizieren Sie die E-Mail-Adresse/Domain</li> <li>Verwenden Sie die verifizierte E-Mail als <code>MAILJET_FROM_EMAIL</code></li> </ol>"},{"location":"_analysis/email-service-provider-examples.html#limits","title":"Limits","text":"<ul> <li>Kostenloser Plan: Bis zu 6.000 E-Mails pro Monat</li> <li>API-Limits: 200 Requests pro Sekunde</li> <li>T\u00e4gliches Limit: Abh\u00e4ngig vom gew\u00e4hlten Plan</li> </ul>"},{"location":"_analysis/email-service-provider-examples.html#fehlerbehandlung","title":"Fehlerbehandlung","text":""},{"location":"_analysis/email-service-provider-examples.html#haufige-fehler","title":"H\u00e4ufige Fehler","text":"<p>Ung\u00fcltige API-Schl\u00fcssel: <pre><code>Error: Unauthorized\n</code></pre> - Pr\u00fcfen Sie <code>MAILJET_API_KEY</code> und <code>MAILJET_API_SECRET</code></p> <p>Nicht verifizierte Absender-E-Mail: <pre><code>Error: Sender address not verified\n</code></pre> - Verifizieren Sie die Absender-E-Mail in Mailjet</p> <p>Rate Limit \u00fcberschritten: <pre><code>Error: Too many requests\n</code></pre> - Implementieren Sie Rate Limiting oder warten Sie</p>"},{"location":"_analysis/email-service-provider-examples.html#fehlerbehandlung-im-code","title":"Fehlerbehandlung im Code","text":"<pre><code>static async sendInvitationEmail(data: InvitationEmailData): Promise&lt;boolean&gt; {\n  try {\n    await mailjet.post('send', { version: 'v3.1' }).request({\n      // ... E-Mail-Daten\n    })\n    return true\n  } catch (error: any) {\n    console.error('E-Mail-Versand Fehler:', error)\n\n    // Spezifische Fehlerbehandlung\n    if (error.statusCode === 401) {\n      console.error('Ung\u00fcltige API-Schl\u00fcssel')\n    } else if (error.statusCode === 400) {\n      console.error('Ung\u00fcltige E-Mail-Daten:', error.response?.body)\n    } else if (error.statusCode === 429) {\n      console.error('Rate Limit \u00fcberschritten')\n    }\n\n    return false\n  }\n}\n</code></pre>"},{"location":"_analysis/email-service-provider-examples.html#integration-in-das-einladungssystem","title":"Integration in das Einladungssystem","text":"<p>Der Mailjet E-Mail-Service wird in folgenden Dateien verwendet:</p> <ul> <li><code>src/lib/services/mailjet-service.ts</code> - E-Mail-Service-Implementierung</li> <li><code>src/app/api/auth/invite/route.ts</code> - Einladung erstellen und E-Mail senden</li> <li><code>src/app/api/auth/register/route.ts</code> - Willkommens-E-Mail nach Registrierung</li> <li><code>src/app/api/auth/forgot-password/route.ts</code> - Passwort-Reset-E-Mail</li> </ul> <p>Verwendung: <pre><code>import { MailjetService } from '@/lib/services/mailjet-service'\n\nawait MailjetService.sendInvitationEmail({\n  to: 'user@example.com',\n  name: 'Max Mustermann',\n  subject: 'Einladung zu NatureScout',\n  inviterName: 'Anna Schmidt',\n  organizationName: 'Meine Organisation',\n  loginUrl: 'https://example.com/invite/token123',\n  personalMessage: 'Willkommen im Team!'\n})\n</code></pre></p>"},{"location":"_analysis/email-service-provider-examples.html#zusammenfassung","title":"Zusammenfassung","text":"<p>Die Mailjet-Implementierung bietet:</p> <ul> <li>\u2705 Einfaches Setup mit API-Schl\u00fcsseln</li> <li>\u2705 HTML- und Text-Versionen der E-Mails</li> <li>\u2705 Kostenloser Plan f\u00fcr kleine Projekte (6k E-Mails/Monat)</li> <li>\u2705 Gute Delivery Rate</li> <li>\u2705 Analytics und Tracking \u00fcber Mailjet-Dashboard</li> <li>\u2705 Einfache Integration in bestehende Systeme</li> </ul> <p>Die Einladungslogik ist vollst\u00e4ndig vom E-Mail-Provider getrennt, sodass bei Bedarf ein Wechsel zu einem anderen Provider m\u00f6glich ist, ohne die restliche Logik zu \u00e4ndern.</p>"},{"location":"_analysis/file-inventory.html","title":"File Inventory","text":"<p>This document provides a complete inventory of all source files in the <code>src/</code> directory, categorized by type and purpose.</p> <p>Total Files: ~424 files (233 .ts files + 191 .tsx files)</p>"},{"location":"_analysis/file-inventory.html#entry-points","title":"Entry Points","text":"File Path Type Description <code>src/middleware.ts</code> Middleware Authentication and routing middleware <code>src/app/layout.tsx</code> Layout Root layout component <code>src/instrumentation.ts</code> Instrumentation Next.js instrumentation"},{"location":"_analysis/file-inventory.html#api-routes","title":"API Routes","text":""},{"location":"_analysis/file-inventory.html#authentication","title":"Authentication","text":"<ul> <li><code>src/app/api/auth/onedrive/callback/route.ts</code></li> <li><code>src/app/api/auth/onedrive/refresh/route.ts</code></li> <li><code>src/app/api/auth-test/route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#chat-api-srcappapichatlibraryid","title":"Chat API (<code>src/app/api/chat/[libraryId]/</code>)","text":"<ul> <li><code>adhoc/route.ts</code> - Ad-hoc chat operations</li> <li><code>analyze-chapters/route.ts</code> - Chapter analysis</li> <li><code>chats/[chatId]/route.ts</code> - Individual chat operations</li> <li><code>chats/route.ts</code> - Chat list operations</li> <li><code>config/route.ts</code> - Chat configuration</li> <li><code>doc-meta/route.ts</code> - Document metadata</li> <li><code>docs/route.ts</code> - Document operations</li> <li><code>document-status/route.ts</code> - Document status check</li> <li><code>facets/route.ts</code> - Facet operations</li> <li><code>file-status/route.ts</code> - File status check</li> <li><code>index/route.ts</code> - Index operations</li> <li><code>index-status/route.ts</code> - Index status check</li> <li><code>ingest/route.ts</code> - Ingestion operations</li> <li><code>ingestion-status/route.ts</code> - Ingestion status</li> <li><code>ingest-markdown/route.ts</code> - Markdown ingestion</li> <li><code>queries/[queryId]/explain/route.ts</code> - Query explanation</li> <li><code>queries/[queryId]/route.ts</code> - Individual query operations</li> <li><code>queries/route.ts</code> - Query list operations</li> <li><code>route.ts</code> - Main chat route</li> <li><code>stats/route.ts</code> - Chat statistics</li> <li><code>stream/route.ts</code> - Chat streaming endpoint</li> <li><code>toc-cache/route.ts</code> - Table of contents cache</li> <li><code>upsert-doc-meta/route.ts</code> - Upsert document metadata</li> <li><code>upsert-file/route.ts</code> - Upsert file</li> </ul>"},{"location":"_analysis/file-inventory.html#event-jobs-srcappapievent-job","title":"Event Jobs (<code>src/app/api/event-job/</code>)","text":"<ul> <li><code>batches/[batchId]/archive/route.ts</code></li> <li><code>batches/[batchId]/archive-status/route.ts</code></li> <li><code>batches/[batchId]/change-language/route.ts</code></li> <li><code>batches/[batchId]/jobs/route.ts</code></li> <li><code>batches/[batchId]/restart/route.ts</code></li> <li><code>batches/[batchId]/route.ts</code></li> <li><code>batches/[batchId]/toggle-active/route.ts</code></li> <li><code>batches/change-language-all/route.ts</code></li> <li><code>batches/fail-all/route.ts</code></li> <li><code>batches/pending-all/route.ts</code></li> <li><code>batches/reset-all/route.ts</code></li> <li><code>batches/route.ts</code></li> <li><code>events/[eventName]/restart-all-batches/route.ts</code></li> <li><code>events/route.ts</code></li> <li><code>jobs/[jobId]/download-archive/route.ts</code></li> <li><code>jobs/[jobId]/process-direct/route.ts</code></li> <li><code>jobs/[jobId]/restart/route.ts</code></li> <li><code>jobs/[jobId]/route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#external-jobs-srcappapiexternaljobs","title":"External Jobs (<code>src/app/api/external/jobs/</code>)","text":"<ul> <li><code>[jobId]/download-archive/route.ts</code></li> <li><code>[jobId]/markdown/route.ts</code></li> <li><code>[jobId]/route.ts</code></li> <li><code>[jobId]/start/route.ts</code></li> <li><code>[jobId]/trace/route.ts</code></li> <li><code>batches/route.ts</code></li> <li><code>counters/route.ts</code></li> <li><code>internal/create/route.ts</code></li> <li><code>retry-batch/route.ts</code></li> <li><code>route.ts</code></li> <li><code>start-batch/route.ts</code></li> <li><code>stream/route.ts</code></li> <li><code>worker/route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#libraries-srcappapilibraries","title":"Libraries (<code>src/app/api/libraries/</code>)","text":"<ul> <li><code>[id]/public/check-slug/route.ts</code></li> <li><code>[id]/public/route.ts</code></li> <li><code>[id]/route.ts</code></li> <li><code>[id]/tokens/route.ts</code></li> <li><code>route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#public-api-srcappapipublic","title":"Public API (<code>src/app/api/public/</code>)","text":"<ul> <li><code>libraries/[slug]/route.ts</code></li> <li><code>libraries/route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#secretary-srcappapisecretary","title":"Secretary (<code>src/app/api/secretary/</code>)","text":"<ul> <li><code>import-from-url/route.ts</code></li> <li><code>process-audio/route.ts</code></li> <li><code>process-image/route.ts</code></li> <li><code>process-pdf/batch/route.ts</code></li> <li><code>process-pdf/route.ts</code></li> <li><code>process-text/route.ts</code></li> <li><code>process-video/route.ts</code></li> <li><code>session/process/route.ts</code></li> <li><code>tracks/[...track]/route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#sessions-srcappapisessions","title":"Sessions (<code>src/app/api/sessions/</code>)","text":"<ul> <li><code>[id]/route.ts</code></li> <li><code>events/route.ts</code></li> <li><code>generate-jobs/route.ts</code></li> <li><code>route.ts</code></li> <li><code>transcript/route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#storage-srcappapistorage","title":"Storage (<code>src/app/api/storage/</code>)","text":"<ul> <li><code>filesystem/route.ts</code></li> <li><code>filesystem/upload-archive/route.ts</code></li> <li><code>route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#other-api-routes","title":"Other API Routes","text":"<ul> <li><code>src/app/api/add-library/route.ts</code></li> <li><code>src/app/api/db-test/route.ts</code></li> <li><code>src/app/api/debug-libraries/route.ts</code></li> <li><code>src/app/api/env-test/route.ts</code></li> <li><code>src/app/api/health/pinecone/route.ts</code> \u26a0\ufe0f VERALTET - Pinecone Health-Check nicht mehr ben\u00f6tigt</li> <li><code>src/app/api/metadata/template/run/route.ts</code></li> <li><code>src/app/api/settings/oauth-defaults/route.ts</code></li> <li><code>src/app/api/settings/storage-test/route.ts</code></li> <li><code>src/app/api/test-route/route.ts</code></li> <li><code>src/app/api/teststorage/route.ts</code></li> <li><code>src/app/api/user/route.ts</code></li> <li><code>src/app/api/user-info/route.ts</code></li> <li><code>src/app/api/video/resolve/route.ts</code></li> <li><code>src/app/api/video/transcript/route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#pages-srcapp","title":"Pages (<code>src/app/</code>)","text":""},{"location":"_analysis/file-inventory.html#main-pages","title":"Main Pages","text":"<ul> <li><code>src/app/page.tsx</code> - Home page</li> <li><code>src/app/library/page.tsx</code> - Library main page</li> <li><code>src/app/library/chat/page.tsx</code> - Chat page</li> <li><code>src/app/library/chat/client.tsx</code> - Chat client component</li> <li><code>src/app/library/gallery/page.tsx</code> - Gallery page</li> <li><code>src/app/library/gallery/client.tsx</code> - Gallery client component</li> <li><code>src/app/library/gallery/ensure-library.tsx</code> - Library ensure component</li> </ul>"},{"location":"_analysis/file-inventory.html#settings-pages-srcappsettings","title":"Settings Pages (<code>src/app/settings/</code>)","text":"<ul> <li><code>appearance/page.tsx</code></li> <li><code>chat/page.tsx</code></li> <li><code>display/page.tsx</code></li> <li><code>layout.tsx</code></li> <li><code>library/page.tsx</code></li> <li><code>notifications/page.tsx</code></li> <li><code>owner/page.tsx</code></li> <li><code>page.tsx</code></li> <li><code>public/page.tsx</code></li> <li><code>secretary-service/page.tsx</code></li> <li><code>settings-client.tsx</code></li> <li><code>storage/page.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#other-pages","title":"Other Pages","text":"<ul> <li><code>src/app/add-test-library/page.tsx</code></li> <li><code>src/app/datenschutz/page.tsx</code></li> <li><code>src/app/event-monitor/page.tsx</code></li> <li><code>src/app/event-monitor/batches/[batchId]/page.tsx</code></li> <li><code>src/app/event-monitor/jobs/[jobId]/page.tsx</code></li> <li><code>src/app/explore/[slug]/page.tsx</code></li> <li><code>src/app/impressum/page.tsx</code></li> <li><code>src/app/rechtliche-hinweise/page.tsx</code></li> <li><code>src/app/session-manager/page.tsx</code></li> <li><code>src/app/templates/page.tsx</code></li> <li><code>src/app/ueber/page.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#error-pages","title":"Error Pages","text":"<ul> <li><code>src/app/global-error.tsx</code></li> <li><code>src/app/not-found.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#other-app-files","title":"Other App Files","text":"<ul> <li><code>src/app/auth/microsoft/callback/route.ts</code></li> <li><code>src/app/pdf.worker.mjs/route.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#components-srccomponents","title":"Components (<code>src/components/</code>)","text":""},{"location":"_analysis/file-inventory.html#library-components-srccomponentslibrary","title":"Library Components (<code>src/components/library/</code>)","text":"<ul> <li><code>audio-player.tsx</code></li> <li><code>audio-recorder-client.tsx</code></li> <li><code>audio-transform.tsx</code></li> <li><code>book-detail.tsx</code></li> <li><code>breadcrumb.tsx</code></li> <li><code>chapter-accordion.tsx</code></li> <li><code>combined-chat-dialog.tsx</code></li> <li><code>document-preview.tsx</code></li> <li><code>event-details-accordion.tsx</code></li> <li><code>file-category-filter.tsx</code></li> <li><code>file-list.tsx</code></li> <li><code>file-preview.tsx</code></li> <li><code>file-tree.tsx</code></li> <li><code>filter-context-bar.tsx</code></li> <li><code>image-preview.tsx</code></li> <li><code>image-transform.tsx</code></li> <li><code>ingestion-book-detail.tsx</code></li> <li><code>ingestion-dialog.tsx</code></li> <li><code>ingestion-session-detail.tsx</code></li> <li><code>ingestion-status.tsx</code></li> <li><code>job-report-tab.tsx</code></li> <li><code>library.tsx</code> - Main library component</li> <li><code>library-header.tsx</code></li> <li><code>library-switcher.tsx</code></li> <li><code>markdown-audio.tsx</code></li> <li><code>markdown-metadata.tsx</code></li> <li><code>markdown-preview.tsx</code></li> <li><code>pdf-bulk-import-dialog.tsx</code></li> <li><code>pdf-canvas-viewer.tsx</code></li> <li><code>pdf-phase-settings.tsx</code></li> <li><code>pdf-phases-view.tsx</code></li> <li><code>pdf-transform.tsx</code></li> <li><code>phase-stepper.tsx</code></li> <li><code>session-detail.tsx</code></li> <li><code>slide-accordion.tsx</code></li> <li><code>template-management.tsx</code></li> <li><code>text-editor.tsx</code></li> <li><code>transcription-dialog.tsx</code></li> <li><code>transformation-dialog.tsx</code></li> <li><code>transform-result-handler.tsx</code></li> <li><code>transform-save-options.tsx</code></li> <li><code>types.tsx</code></li> <li><code>upload-area.tsx</code></li> <li><code>upload-dialog.tsx</code></li> <li><code>video-player.tsx</code></li> <li><code>video-transform.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#library-chat-components-srccomponentslibrarychat","title":"Library Chat Components (<code>src/components/library/chat/</code>)","text":"<ul> <li><code>chat-config-bar.tsx</code></li> <li><code>chat-config-display.tsx</code></li> <li><code>chat-config-popover.tsx</code></li> <li><code>chat-conversation-item.tsx</code></li> <li><code>chat-document-sources.tsx</code></li> <li><code>chat-input.tsx</code></li> <li><code>chat-message.tsx</code></li> <li><code>chat-messages-list.tsx</code></li> <li><code>chat-panel.tsx</code></li> <li><code>chat-reference-list.tsx</code></li> <li><code>chat-selector.tsx</code></li> <li><code>chat-suggested-questions.tsx</code></li> <li><code>chat-welcome-assistant.tsx</code></li> <li><code>debug-panel.tsx</code></li> <li><code>debug-step-table.tsx</code></li> <li><code>debug-timeline.tsx</code></li> <li><code>debug-trace.tsx</code></li> <li><code>processing-logs-dialog.tsx</code></li> <li><code>processing-status.tsx</code></li> <li><code>query-details-dialog.tsx</code></li> <li><code>hooks/use-chat-scroll.ts</code></li> <li><code>utils/chat-storage.ts</code></li> <li><code>utils/chat-utils.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#library-story-components-srccomponentslibrarystory","title":"Library Story Components (<code>src/components/library/story/</code>)","text":"<ul> <li><code>story-header.tsx</code></li> <li><code>story-mode-header.tsx</code></li> <li><code>story-topics.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#settings-components-srccomponentssettings","title":"Settings Components (<code>src/components/settings/</code>)","text":"<ul> <li><code>appearance-form.tsx</code></li> <li><code>chat-form.tsx</code></li> <li><code>display-form.tsx</code></li> <li><code>FacetDefsEditor.tsx</code></li> <li><code>library-form.tsx</code></li> <li><code>notifications-form.tsx</code></li> <li><code>owner-form.tsx</code></li> <li><code>public-form.tsx</code></li> <li><code>secretary-service-form.tsx</code></li> <li><code>sidebar-nav.tsx</code></li> <li><code>storage-form.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#event-monitor-components-srccomponentsevent-monitor","title":"Event Monitor Components (<code>src/components/event-monitor/</code>)","text":"<ul> <li><code>batch-archive-dialog.tsx</code></li> <li><code>batch-list.tsx</code></li> <li><code>batch-process-dialog.tsx</code></li> <li><code>event-filter-dropdown.tsx</code></li> <li><code>job-archive-test.tsx</code></li> <li><code>job-details-panel.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#home-components-srccomponentshome","title":"Home Components (<code>src/components/home/</code>)","text":"<ul> <li><code>conditional-footer.tsx</code></li> <li><code>cta-section.tsx</code></li> <li><code>footer.tsx</code></li> <li><code>hero-section.tsx</code></li> <li><code>how-it-works.tsx</code></li> <li><code>library-grid.tsx</code></li> <li><code>philosophy-section.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#shared-components-srccomponentsshared","title":"Shared Components (<code>src/components/shared/</code>)","text":"<ul> <li><code>ai-generated-notice.tsx</code></li> <li><code>chat-panel.tsx</code></li> <li><code>job-monitor-panel.tsx</code></li> <li><code>job-trace.tsx</code></li> <li><code>key-value-table.tsx</code></li> <li><code>language-switcher.tsx</code></li> <li><code>storage-auth-button.tsx</code></li> <li><code>trace-viewer.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#ui-components-srccomponentsui","title":"UI Components (<code>src/components/ui/</code>)","text":"<ul> <li><code>accordion.tsx</code></li> <li><code>alert.tsx</code></li> <li><code>alert-dialog.tsx</code></li> <li><code>avatar.tsx</code></li> <li><code>badge.tsx</code></li> <li><code>button.tsx</code></li> <li><code>calendar.tsx</code></li> <li><code>card.tsx</code></li> <li><code>chart.tsx</code></li> <li><code>checkbox.tsx</code></li> <li><code>collapsible.tsx</code></li> <li><code>command.tsx</code></li> <li><code>context-menu.tsx</code></li> <li><code>dialog.tsx</code></li> <li><code>dropdown-menu.tsx</code></li> <li><code>form.tsx</code></li> <li><code>hover-card.tsx</code></li> <li><code>input.tsx</code></li> <li><code>label.tsx</code></li> <li><code>menubar.tsx</code></li> <li><code>popover.tsx</code></li> <li><code>progress.tsx</code></li> <li><code>radio-group.tsx</code></li> <li><code>resizable.tsx</code></li> <li><code>scroll-area.tsx</code></li> <li><code>select.tsx</code></li> <li><code>separator.tsx</code></li> <li><code>sheet.tsx</code></li> <li><code>skeleton.tsx</code></li> <li><code>slider.tsx</code></li> <li><code>switch.tsx</code></li> <li><code>table.tsx</code></li> <li><code>tabs.tsx</code></li> <li><code>textarea.tsx</code></li> <li><code>toast.tsx</code></li> <li><code>toaster.tsx</code></li> <li><code>tooltip.tsx</code></li> <li><code>tree.tsx</code></li> <li><code>use-toast.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#other-components","title":"Other Components","text":"<ul> <li><code>src/components/debug/debug-footer.tsx</code></li> <li><code>src/components/debug/debug-footer-client.tsx</code></li> <li><code>src/components/debug/debug-footer-wrapper.tsx</code></li> <li><code>src/components/event-slides.tsx</code></li> <li><code>src/components/event-summary.tsx</code></li> <li><code>src/components/icons.tsx</code></li> <li><code>src/components/layouts/app-layout.tsx</code></li> <li><code>src/components/layouts/home-layout.tsx</code></li> <li><code>src/components/login-button.tsx</code></li> <li><code>src/components/session/session-event-filter.tsx</code></li> <li><code>src/components/session/session-import-modal.tsx</code></li> <li><code>src/components/templates/structured-template-editor.tsx</code></li> <li><code>src/components/templates/template-management.tsx</code></li> <li><code>src/components/theme-provider.tsx</code></li> <li><code>src/components/top-nav.tsx</code></li> <li><code>src/components/top-nav-wrapper.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#library-code-srclib","title":"Library Code (<code>src/lib/</code>)","text":""},{"location":"_analysis/file-inventory.html#storage-srclibstorage","title":"Storage (<code>src/lib/storage/</code>)","text":"<ul> <li><code>filesystem-client.ts</code></li> <li><code>filesystem-provider.ts</code></li> <li><code>onedrive-provider.ts</code></li> <li><code>onedrive-provider-server.ts</code></li> <li><code>server-provider.ts</code></li> <li><code>shadow-twin.ts</code></li> <li><code>storage-factory.ts</code></li> <li><code>storage-factory-mongodb.ts</code></li> <li><code>storage-service.ts</code></li> <li><code>supported-types.ts</code></li> <li><code>types.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#chat-srclibchat","title":"Chat (<code>src/lib/chat/</code>)","text":"<ul> <li><code>config.ts</code></li> <li><code>constants.ts</code></li> <li><code>debug-stats.ts</code></li> <li><code>dynamic-facets.ts</code></li> <li><code>embeddings.ts</code></li> <li><code>facets.ts</code></li> <li><code>ingestion-service.ts</code></li> <li><code>loader.ts</code></li> <li><code>orchestrator.ts</code></li> <li><code>pinecone.ts</code> \u26a0\ufe0f VERALTET - Wird nicht mehr verwendet (Migration zu MongoDB Vector Search abgeschlossen)</li> <li><code>vector-stats.ts</code></li> <li><code>common/budget.ts</code></li> <li><code>common/filters.ts</code></li> <li><code>common/llm.ts</code></li> <li><code>common/prompt.ts</code></li> <li><code>common/question-analyzer.ts</code></li> <li><code>common/toc-parser.ts</code></li> <li><code>retrievers/chunks.ts</code></li> <li><code>retrievers/metadata-extractor.ts</code></li> <li><code>retrievers/summaries-mongo.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#external-jobs-srclibexternal-jobs","title":"External Jobs (<code>src/lib/external-jobs/</code>)","text":"<ul> <li><code>auth.ts</code></li> <li><code>chapters.ts</code></li> <li><code>complete.ts</code></li> <li><code>context.ts</code></li> <li><code>images.ts</code></li> <li><code>ingest.ts</code></li> <li><code>policies.ts</code></li> <li><code>preprocess.ts</code></li> <li><code>progress.ts</code></li> <li><code>provider.ts</code></li> <li><code>storage.ts</code></li> <li><code>template-decision.ts</code></li> <li><code>template-files.ts</code></li> <li><code>template-run.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#secretary-srclibsecretary","title":"Secretary (<code>src/lib/secretary/</code>)","text":"<ul> <li><code>adapter.ts</code></li> <li><code>client.ts</code></li> <li><code>constants.ts</code></li> <li><code>response-parser.ts</code></li> <li><code>types.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#database-srclibdb","title":"Database (<code>src/lib/db/</code>)","text":"<ul> <li><code>chats-repo.ts</code></li> <li><code>queries-repo.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#services-srclibservices","title":"Services (<code>src/lib/services/</code>)","text":"<ul> <li><code>azure-storage-service.ts</code></li> <li><code>library-service.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#session-srclibsession","title":"Session (<code>src/lib/session/</code>)","text":"<ul> <li><code>session-processor.ts</code></li> <li><code>session-utils.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#transform-srclibtransform","title":"Transform (<code>src/lib/transform/</code>)","text":"<ul> <li><code>batch-transform-service.ts</code></li> <li><code>image-extraction-service.ts</code></li> <li><code>transform-service.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#other-library-files","title":"Other Library Files","text":"<ul> <li><code>src/lib/atoms/library.ts</code></li> <li><code>src/lib/auth.ts</code></li> <li><code>src/lib/config/azure-storage.ts</code></li> <li><code>src/lib/debug/logger.ts</code></li> <li><code>src/lib/debug/wdyr.ts</code></li> <li><code>src/lib/env.ts</code></li> <li><code>src/lib/event-job-repository.ts</code></li> <li><code>src/lib/events/job-event-bus.ts</code></li> <li><code>src/lib/external-jobs-log-buffer.ts</code></li> <li><code>src/lib/external-jobs-repository.ts</code></li> <li><code>src/lib/external-jobs-watchdog.ts</code></li> <li><code>src/lib/external-jobs-worker.ts</code></li> <li><code>src/lib/i18n/hooks.ts</code></li> <li><code>src/lib/i18n/index.ts</code></li> <li><code>src/lib/i18n/server.ts</code></li> <li><code>src/lib/i18n/types.ts</code></li> <li><code>src/lib/ingestion/page-split.ts</code></li> <li><code>src/lib/library/favorites.ts</code></li> <li><code>src/lib/logging/query-logger.ts</code></li> <li><code>src/lib/markdown/compose.ts</code></li> <li><code>src/lib/markdown/frontmatter.ts</code></li> <li><code>src/lib/mongodb-service.ts</code></li> <li><code>src/lib/pdf-defaults.ts</code></li> <li><code>src/lib/pdfjs-worker-setup.ts</code></li> <li><code>src/lib/processing/gates.ts</code></li> <li><code>src/lib/processing/phase-policy.ts</code></li> <li><code>src/lib/repositories/doc-meta-repo.ts</code></li> <li><code>src/lib/session-repository.ts</code></li> <li><code>src/lib/templates/placeholders.ts</code></li> <li><code>src/lib/test-env.ts</code></li> <li><code>src/lib/text/chunk.ts</code></li> <li><code>src/lib/utils.ts</code></li> <li><code>src/lib/utils/fetch-with-timeout.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#types-srctypes","title":"Types (<code>src/types/</code>)","text":"<ul> <li><code>chat.ts</code></li> <li><code>chat-processing.ts</code></li> <li><code>chat-response.ts</code></li> <li><code>doc-meta.ts</code></li> <li><code>event-job.ts</code></li> <li><code>external-job.ts</code></li> <li><code>external-jobs.ts</code></li> <li><code>library.ts</code></li> <li><code>query-log.ts</code></li> <li><code>retriever.ts</code></li> <li><code>session.ts</code></li> <li><code>story-topics.ts</code></li> <li>Type definitions: <code>@welldone-software__why-did-you-render.d.ts</code>, <code>better-sqlite3.d.ts</code>, <code>pdfjs-dist.d.ts</code>, <code>react-volume-meter.d.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#hooks-srchooks","title":"Hooks (<code>src/hooks/</code>)","text":"<ul> <li><code>use-folder-navigation.ts</code></li> <li><code>use-selected-file.ts</code></li> <li><code>use-storage-provider.tsx</code></li> <li><code>use-story-context.ts</code></li> <li><code>use-toast.ts</code></li> <li><code>use-transcription-twins.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#atoms-srcatoms","title":"Atoms (<code>src/atoms/</code>)","text":"<ul> <li><code>chat-references-atom.ts</code></li> <li><code>combined-chat-atom.ts</code></li> <li><code>create-library-atom.ts</code></li> <li><code>debug-atom.ts</code></li> <li><code>event-filter-atom.ts</code></li> <li><code>gallery-filters.ts</code></li> <li><code>job-status.ts</code></li> <li><code>library-atom.ts</code></li> <li><code>pdf-defaults.ts</code></li> <li><code>pdf-phases.ts</code></li> <li><code>pdf-viewer.ts</code></li> <li><code>story-context-atom.ts</code></li> <li><code>template-atom.ts</code></li> <li><code>template-context-atom.ts</code></li> <li><code>transcription-options.ts</code></li> <li><code>ui-prefs-atom.ts</code></li> </ul>"},{"location":"_analysis/file-inventory.html#contexts-srccontexts","title":"Contexts (<code>src/contexts/</code>)","text":"<ul> <li><code>storage-context.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#providers-srcproviders","title":"Providers (<code>src/providers/</code>)","text":"<ul> <li><code>debug-provider.tsx</code></li> </ul>"},{"location":"_analysis/file-inventory.html#notes","title":"Notes","text":"<ul> <li>Files are organized by functional area</li> <li>API routes follow Next.js App Router conventions</li> <li>Components are organized by feature area</li> <li>Library code is organized by domain (storage, chat, etc.)</li> <li>Type definitions are centralized in <code>src/types/</code></li> </ul>"},{"location":"_analysis/ingestion-service-refactoring.html","title":"Ingestion Service Refactoring Analyse","text":""},{"location":"_analysis/ingestion-service-refactoring.html#ubersicht","title":"\u00dcbersicht","text":"<p>Die Datei <code>src/lib/chat/ingestion-service.ts</code> ist mit 1375 Zeilen sehr lang und enth\u00e4lt mehrere redundante Code-Bl\u00f6cke sowie Funktionen, die in separate Libraries ausgelagert werden sollten.</p>"},{"location":"_analysis/ingestion-service-refactoring.html#identifizierte-redundanzen-und-auslagerungsmoglichkeiten","title":"Identifizierte Redundanzen und Auslagerungsm\u00f6glichkeiten","text":""},{"location":"_analysis/ingestion-service-refactoring.html#1-bild-verarbeitung-3-funktionen-mit-viel-redundanz","title":"1. Bild-Verarbeitung (3 Funktionen mit viel Redundanz)","text":"<p>Betroffene Funktionen: - <code>processMarkdownImagesToAzure()</code> (Zeilen 200-450, ~250 Zeilen) - <code>processCoverImageToAzure()</code> (Zeilen 462-585, ~123 Zeilen) - <code>processSlideImagesToAzure()</code> (Zeilen 592-755, ~163 Zeilen)</p> <p>Redundanzen: - Azure Config Check (Zeilen 209-213, 470-474, 599-603) - Azure Storage Service Initialisierung (Zeilen 215-219, 476-480, 605-609) - Container-Existenz-Pr\u00fcfung (Zeilen 221-237, 612-627) - Hash-Berechnung mit <code>calculateImageHash</code> (Zeilen 345, 513, 662) - Extension-Extraktion (Zeilen 348, 516, 665) - Scope-Bestimmung (<code>books</code> vs <code>sessions</code>) (Zeilen 352, 519, 671) - <code>getImageUrlByHashWithScope</code> + <code>uploadImageToScope</code> Pattern (Zeilen 355-403, 522-571, 668-715) - Fehlerbehandlung mit <code>userFriendlyError</code> (Zeilen 416-425, 730-740)</p> <p>Vorschlag: Auslagern in <code>src/lib/ingestion/image-processor.ts</code></p> <pre><code>// Neue Datei: src/lib/ingestion/image-processor.ts\nexport class ImageProcessor {\n  static async processMarkdownImages(...)\n  static async processCoverImage(...)\n  static async processSlideImages(...)\n\n  // Private Hilfsfunktionen:\n  private static async ensureAzureStorage()\n  private static async uploadImageWithDeduplication(...)\n  private static normalizeImagePath(...)\n  private static extractImageReferences(...)\n}\n</code></pre> <p>Einsparung: ~200 Zeilen Redundanz eliminieren</p>"},{"location":"_analysis/ingestion-service-refactoring.html#2-frontmatter-parsing-und-facetten-validierung","title":"2. Frontmatter-Parsing und Facetten-Validierung","text":"<p>Betroffener Code-Block: Zeilen 775-871 (~96 Zeilen)</p> <p>Funktionen: - <code>stripWrappingQuotes()</code> (Zeilen 790-794) - <code>toStringArray()</code> (Zeilen 795-809) - HINWEIS: Es gibt bereits eine \u00e4hnliche Funktion in <code>src/lib/chat/facets.ts</code> (Zeile 7), aber mit anderer Signatur - <code>deepClean()</code> (Zeilen 810-838) - Facetten-Validierung Loop (Zeilen 839-862) - <code>__sanitized</code> und <code>__jsonClean</code> Setup (Zeilen 863-870)</p> <p>Bestehende Libraries: - \u2705 <code>src/lib/markdown/frontmatter.ts</code> - Basis-Parsing (<code>parseFrontmatter</code>) - \u2705 <code>src/lib/external-jobs/preprocess-core.ts</code> - Einfache Validierung (<code>validateFrontmatter</code>) - \u2705 <code>src/lib/chat/dynamic-facets.ts</code> - Facetten-Definitionen und <code>getTopLevelValue</code> - \u2705 <code>src/lib/chat/facets.ts</code> - <code>toStringArray</code> (aber einfachere Signatur)</p> <p>Problem: Die komplexe Sanitization-Logik (stripWrappingQuotes, deepClean, Facetten-Sanitization) existiert noch nicht in den bestehenden Libraries.</p> <p>Vorschlag: Erweitere <code>src/lib/chat/dynamic-facets.ts</code> um Sanitization-Funktionen</p> <pre><code>// Erweitere: src/lib/chat/dynamic-facets.ts\nexport interface SanitizedMeta {\n  sanitized: Record&lt;string, unknown&gt;\n  jsonClean: Record&lt;string, unknown&gt;\n  metaEffective: Record&lt;string, unknown&gt;\n}\n\nexport function stripWrappingQuotes(s: string): string\nexport function toStringArrayFromUnknown(val: unknown): string[] | undefined\nexport function deepCleanMeta(val: unknown): unknown\nexport function validateAndSanitizeFrontmatter(\n  metaEffective: Record&lt;string, unknown&gt;,\n  facetDefs: FacetDef[],\n  jobId?: string\n): SanitizedMeta\n</code></pre> <p>Vorteil: Nutzt bestehende Library statt neue zu erstellen, konsolidiert Facetten-Logik an einem Ort.</p> <p>Einsparung: ~96 Zeilen auslagern</p>"},{"location":"_analysis/ingestion-service-refactoring.html#3-metadata-prafix-building","title":"3. Metadata-Pr\u00e4fix-Building","text":"<p>Betroffene Funktion: <code>buildMetadataPrefix()</code> (Zeilen 23-135, ~112 Zeilen)</p> <p>Status: Wird nur in <code>ingestion-service.ts</code> verwendet, aber ist eine reine Utility-Funktion</p> <p>Vorschlag: Auslagern in <code>src/lib/ingestion/metadata-formatter.ts</code></p> <pre><code>// Neue Datei: src/lib/ingestion/metadata-formatter.ts\nexport function buildMetadataPrefix(docMetaJsonObj: Record&lt;string, unknown&gt;): string\n</code></pre> <p>Einsparung: ~112 Zeilen auslagern</p>"},{"location":"_analysis/ingestion-service-refactoring.html#4-chunk-vektor-erstellung","title":"4. Chunk-Vektor-Erstellung","text":"<p>Betroffener Code-Block: Zeilen 1212-1295 (~83 Zeilen)</p> <p>Funktionen: - Facetten-Werte extrahieren (Zeilen 1243-1256) - Vektor-Dokumente aus RAG-Chunks erstellen (Zeilen 1258-1295)</p> <p>Vorschlag: Auslagern in <code>src/lib/ingestion/vector-builder.ts</code></p> <pre><code>// Neue Datei: src/lib/ingestion/vector-builder.ts\nexport interface VectorDocument {\n  _id: string\n  kind: 'chunk'\n  libraryId: string\n  user: string\n  fileId: string\n  fileName: string\n  chunkIndex: number\n  text: string\n  embedding: number[]\n  // ... weitere Felder\n}\n\nexport function buildVectorDocuments(\n  ragResult: RAGResult,\n  fileId: string,\n  fileName: string,\n  libraryId: string,\n  userEmail: string,\n  facetValues: Record&lt;string, unknown&gt;\n): VectorDocument[]\n</code></pre> <p>Einsparung: ~83 Zeilen auslagern</p>"},{"location":"_analysis/ingestion-service-refactoring.html#5-meta-dokument-erstellung","title":"5. Meta-Dokument-Erstellung","text":"<p>Betroffener Code-Block: Zeilen 1316-1345 (~29 Zeilen)</p> <p>Vorschlag: Auslagern in <code>src/lib/ingestion/meta-document-builder.ts</code></p> <pre><code>// Neue Datei: src/lib/ingestion/meta-document-builder.ts\nexport function buildMetaDocument(\n  mongoDoc: DocMeta,\n  docMetaJsonObj: Record&lt;string, unknown&gt;,\n  chaptersForMongo: ChapterMetaEntry[],\n  chaptersCount: number,\n  chunksUpserted: number,\n  facetValues: Record&lt;string, unknown&gt;,\n  userEmail: string\n): MetaDocument\n</code></pre> <p>Einsparung: ~29 Zeilen auslagern</p>"},{"location":"_analysis/ingestion-service-refactoring.html#6-hilfsfunktionen","title":"6. Hilfsfunktionen","text":"<p>Betroffene Funktionen: Zeilen 897-910 (~13 Zeilen) - <code>safeText()</code> - Text k\u00fcrzen - <code>toStrArr()</code> - Array zu String-Array konvertieren (wird nicht verwendet!) - <code>hashId()</code> - String zu Hash-ID</p> <p>Redundanz:  - <code>toStrArr()</code> wird definiert, aber nirgendwo verwendet (Dead Code!)</p> <p>Vorschlag:  - <code>safeText</code> und <code>hashId</code> in <code>src/lib/utils/string-utils.ts</code> auslagern - <code>toStrArr</code> l\u00f6schen (Dead Code)</p> <p>Einsparung: ~13 Zeilen (davon 1 Dead Code)</p>"},{"location":"_analysis/ingestion-service-refactoring.html#zusammenfassung-der-refaktorierung","title":"Zusammenfassung der Refaktorierung","text":""},{"location":"_analysis/ingestion-service-refactoring.html#neue-dateien","title":"Neue Dateien","text":"<ol> <li><code>src/lib/ingestion/image-processor.ts</code> (~400 Zeilen)</li> <li>Konsolidiert alle 3 Bild-Verarbeitungs-Funktionen</li> <li> <p>Eliminiert ~200 Zeilen Redundanz</p> </li> <li> <p><code>src/lib/ingestion/frontmatter-validator.ts</code> (~150 Zeilen)</p> </li> <li>Frontmatter-Parsing und Facetten-Validierung</li> <li> <p>Wiederverwendbar f\u00fcr andere Services</p> </li> <li> <p><code>src/lib/ingestion/metadata-formatter.ts</code> (~120 Zeilen)</p> </li> <li>Metadata-Pr\u00e4fix-Building</li> <li> <p>Reine Utility-Funktion</p> </li> <li> <p><code>src/lib/ingestion/vector-builder.ts</code> (~100 Zeilen)</p> </li> <li>Chunk-Vektor-Erstellung</li> <li> <p>Klare Trennung von Logik</p> </li> <li> <p><code>src/lib/ingestion/meta-document-builder.ts</code> (~50 Zeilen)</p> </li> <li>Meta-Dokument-Erstellung</li> <li> <p>Einfache Builder-Funktion</p> </li> <li> <p><code>src/lib/utils/string-utils.ts</code> (~30 Zeilen)</p> </li> <li><code>safeText()</code>, <code>hashId()</code> und andere String-Utilities</li> </ol>"},{"location":"_analysis/ingestion-service-refactoring.html#reduzierung-der-ingestion-servicets","title":"Reduzierung der <code>ingestion-service.ts</code>","text":"<p>Aktuell: 1375 Zeilen Nach Refaktorierung: ~600-700 Zeilen (ca. 50% Reduzierung)</p> <p>Eliminierte Redundanz: ~200 Zeilen Ausgelagerte Code-Bl\u00f6cke: ~575 Zeilen</p>"},{"location":"_analysis/ingestion-service-refactoring.html#priorisierung","title":"Priorisierung","text":""},{"location":"_analysis/ingestion-service-refactoring.html#phase-1-hohe-prioritat-redundanz-eliminieren","title":"Phase 1: Hohe Priorit\u00e4t (Redundanz eliminieren)","text":"<ol> <li>\u2705 Bild-Verarbeitung - Gr\u00f6\u00dfte Redundanz (~200 Zeilen)</li> <li>\u2705 Frontmatter-Validator - Wiederverwendbar f\u00fcr andere Services</li> </ol>"},{"location":"_analysis/ingestion-service-refactoring.html#phase-2-mittlere-prioritat-code-organisation","title":"Phase 2: Mittlere Priorit\u00e4t (Code-Organisation)","text":"<ol> <li>\u2705 Metadata-Formatter - Reine Utility-Funktion</li> <li>\u2705 Vector-Builder - Klare Trennung von Logik</li> <li>\u2705 Meta-Document-Builder - Einfache Builder-Funktion</li> </ol>"},{"location":"_analysis/ingestion-service-refactoring.html#phase-3-niedrige-prioritat-cleanup","title":"Phase 3: Niedrige Priorit\u00e4t (Cleanup)","text":"<ol> <li>\u2705 String-Utils - Kleine Hilfsfunktionen</li> <li>\u2705 Dead Code entfernen - <code>toStrArr()</code> l\u00f6schen</li> </ol>"},{"location":"_analysis/ingestion-service-refactoring.html#weitere-verbesserungen","title":"Weitere Verbesserungen","text":""},{"location":"_analysis/ingestion-service-refactoring.html#code-duplikationen-identifiziert","title":"Code-Duplikationen identifiziert","text":"<ol> <li> <p>Fehlerbehandlung-Pattern (3x identisch):    <pre><code>let userFriendlyError = errorMessage\nif (errorMessage.includes('not found') || errorMessage.includes('nicht gefunden')) {\n  userFriendlyError = `[Schritt: Bild-Upload] Bild nicht gefunden: ${imagePath}`\n} else if (errorMessage.includes('does not exist')) {\n  userFriendlyError = `[Schritt: Bild-Upload] Bild-Datei existiert nicht: ${imagePath}`\n} else if (errorMessage.includes('Upload fehlgeschlagen')) {\n  userFriendlyError = `[Schritt: Bild-Upload] Upload fehlgeschlagen f\u00fcr ${imagePath}: ${errorMessage.replace('Upload fehlgeschlagen: ', '')}`\n} else {\n  userFriendlyError = `[Schritt: Bild-Upload] ${errorMessage}`\n}\n</code></pre> Vorschlag: In <code>ImageProcessor</code> als private Methode <code>formatImageError()</code></p> </li> <li> <p>Azure Storage Check Pattern (3x identisch):    <pre><code>const azureConfig = getAzureStorageConfig()\nif (!azureConfig) {\n  FileLogger.info('ingestion', 'Azure Storage nicht konfiguriert, ...')\n  return ...\n}\nconst azureStorage = new AzureStorageService()\nif (!azureStorage.isConfigured()) {\n  FileLogger.warn('ingestion', 'Azure Storage Service nicht konfiguriert')\n  return ...\n}\n</code></pre> Vorschlag: In <code>ImageProcessor.ensureAzureStorage()</code> konsolidieren</p> </li> <li> <p>Container-Check Pattern (2x identisch):    <pre><code>const containerExists = await azureStorage.containerExists(azureConfig.containerName)\nif (!containerExists) {\n  const errorMessage = `[Schritt: Azure Container Pr\u00fcfung] ...`\n  FileLogger.error('ingestion', 'Azure Container existiert nicht', {...})\n  if (jobId) bufferLog(jobId, {...})\n  return/throw ...\n}\n</code></pre> Vorschlag: In <code>ImageProcessor.ensureContainer()</code> konsolidieren</p> </li> </ol>"},{"location":"_analysis/ingestion-service-refactoring.html#nachste-schritte","title":"N\u00e4chste Schritte","text":"<ol> <li>\u2705 Analyse dokumentieren (dieses Dokument)</li> <li>\u23f3 Phase 1 Refaktorierung durchf\u00fchren (Bild-Verarbeitung + Frontmatter-Validator)</li> <li>\u23f3 Phase 2 Refaktorierung durchf\u00fchren (Metadata-Formatter, Vector-Builder, Meta-Document-Builder)</li> <li>\u23f3 Phase 3 Cleanup (String-Utils, Dead Code entfernen)</li> <li>\u23f3 Tests anpassen/erweitern</li> <li>\u23f3 Dokumentation aktualisieren</li> </ol>"},{"location":"_analysis/integration-tests-phase3-analysis.html","title":"Integrationstests Phase 3 \u2013 Analyse nach MongoDB-Migration","text":""},{"location":"_analysis/integration-tests-phase3-analysis.html#aktuelle-situation","title":"Aktuelle Situation","text":""},{"location":"_analysis/integration-tests-phase3-analysis.html#vorhandene-test-cases-phase-3","title":"Vorhandene Test-Cases (Phase 3)","text":"<ol> <li>TC-3.1: Vollst\u00e4ndige Ingestion (Extract + Template + Ingest)</li> <li>TC-3.2: Ingest mit force-Policy</li> <li>TC-3.3: Ingest mit skip-Policy (Gate-basiert)</li> <li>TC-3.4: MongoDB-only Ingestion mit force-Policy \u26a0\ufe0f</li> <li>TC-3.5: MongoDB-only Ingestion mit auto-Policy \u26a0\ufe0f</li> <li>TC-3.6: Pinecone-only Ingestion mit force-Policy \u274c VERALTET</li> <li>TC-3.7: Pinecone-only Ingestion mit auto-Policy \u274c VERALTET</li> </ol>"},{"location":"_analysis/integration-tests-phase3-analysis.html#aktuelle-validatoren","title":"Aktuelle Validatoren","text":"<ul> <li><code>validateMongoUpsert()</code>: Pr\u00fcft <code>doc_meta</code> Collection (verwendet noch <code>doc-meta-repo</code>)</li> <li><code>validatePineconeUpsert()</code>: Pr\u00fcft Pinecone-Vektoren \u274c VERALTET</li> <li><code>validateIngestion()</code>: Pr\u00fcft nur <code>job.ingestion.vectorsUpserted</code></li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#probleme-nach-mongodb-migration","title":"Probleme nach MongoDB-Migration","text":""},{"location":"_analysis/integration-tests-phase3-analysis.html#1-trennung-mongodbpinecone-macht-keinen-sinn-mehr","title":"1. Trennung MongoDB/Pinecone macht keinen Sinn mehr","text":"<p>Vorher: - MongoDB: <code>doc_meta</code> Collection f\u00fcr Metadaten - Pinecone: Vektoren f\u00fcr RAG-Suche</p> <p>Jetzt: - MongoDB: Alles in einer Collection (<code>vectors__${libraryId}</code>)   - <code>kind: 'meta'</code> \u2192 Meta-Dokument (ersetzt <code>doc_meta</code>)   - <code>kind: 'chunk'</code> \u2192 Chunk-Vektoren (ersetzt Pinecone Chunks)   - <code>kind: 'chapterSummary'</code> \u2192 Chapter-Summaries</p>"},{"location":"_analysis/integration-tests-phase3-analysis.html#2-validatoren-verwenden-noch-alte-repositories","title":"2. Validatoren verwenden noch alte Repositories","text":"<ul> <li><code>validateMongoUpsert()</code> verwendet <code>doc-meta-repo</code> \u2192 sollte <code>vector-repo</code> verwenden</li> <li><code>validatePineconeUpsert()</code> ist komplett obsolet</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#3-test-cases-tc-36tc-37-sind-obsolet","title":"3. Test-Cases TC-3.6/TC-3.7 sind obsolet","text":"<p>Diese Tests pr\u00fcfen explizit Pinecone und machen nach der Migration keinen Sinn mehr.</p>"},{"location":"_analysis/integration-tests-phase3-analysis.html#vorschlag-neue-test-strategie-fur-phase-3","title":"Vorschlag: Neue Test-Strategie f\u00fcr Phase 3","text":""},{"location":"_analysis/integration-tests-phase3-analysis.html#use-cases-die-wir-testen-sollten","title":"Use Cases, die wir testen sollten","text":""},{"location":"_analysis/integration-tests-phase3-analysis.html#1-vollstandige-ingestion-tc-31-tc-32","title":"1. Vollst\u00e4ndige Ingestion (TC-3.1, TC-3.2)","text":"<ul> <li>\u2705 Meta-Dokument existiert (<code>kind: 'meta'</code>)</li> <li>\u2705 Chunk-Vektoren existieren (<code>kind: 'chunk'</code>)</li> <li>\u2705 Chapter-Summaries existieren (<code>kind: 'chapterSummary'</code>, falls vorhanden)</li> <li>\u2705 Vector Search Index existiert</li> <li>\u2705 Vektoren k\u00f6nnen abgefragt werden (Vector Search funktioniert)</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#2-gate-basierte-policies-tc-33","title":"2. Gate-basierte Policies (TC-3.3)","text":"<ul> <li>\u2705 Wenn bereits Vektoren existieren \u2192 Skip</li> <li>\u2705 Wenn keine Vektoren existieren \u2192 Run</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#3-force-policy-tc-32","title":"3. Force-Policy (TC-3.2)","text":"<ul> <li>\u2705 \u00dcberschreibt bestehende Vektoren</li> <li>\u2705 Alte Vektoren werden gel\u00f6scht (<code>deleteVectorsByFileId</code>)</li> <li>\u2705 Neue Vektoren werden erstellt</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#4-vector-search-funktionalitat-neu","title":"4. Vector Search Funktionalit\u00e4t (NEU)","text":"<ul> <li>\u2705 Vector Search Query funktioniert</li> <li>\u2705 Filter funktionieren (libraryId, user, fileId, kind)</li> <li>\u2705 Facetten-Filter funktionieren (year, authors, etc.)</li> <li>\u2705 Top-K Ergebnisse sind korrekt</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#5-meta-dokument-validierung-neu","title":"5. Meta-Dokument Validierung (NEU)","text":"<ul> <li>\u2705 Meta-Dokument enth\u00e4lt alle erwarteten Felder</li> <li>\u2705 Facetten-Metadaten sind korrekt gespeichert</li> <li>\u2705 Chapters-Array ist korrekt</li> <li>\u2705 Chunk-Count stimmt mit tats\u00e4chlichen Chunks \u00fcberein</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#6-chunk-vektoren-validierung-neu","title":"6. Chunk-Vektoren Validierung (NEU)","text":"<ul> <li>\u2705 Chunk-Vektoren enthalten Facetten-Metadaten (f\u00fcr Filterung)</li> <li>\u2705 Embeddings haben korrekte Dimension</li> <li>\u2705 Text-Inhalte sind korrekt</li> <li>\u2705 Heading-Context ist vorhanden (falls vorhanden)</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#vorschlag-neue-validatoren","title":"Vorschlag: Neue Validatoren","text":""},{"location":"_analysis/integration-tests-phase3-analysis.html#validatemongovectorupsert","title":"<code>validateMongoVectorUpsert()</code>","text":"<p>Ersetzt sowohl <code>validateMongoUpsert()</code> als auch <code>validatePineconeUpsert()</code>.</p> <p>Pr\u00fcfungen: 1. Meta-Dokument existiert (<code>kind: 'meta'</code>) 2. Chunk-Vektoren existieren (<code>kind: 'chunk'</code>) 3. Chapter-Summaries existieren (<code>kind: 'chapterSummary'</code>, falls vorhanden) 4. Vector Search Index existiert 5. Vektoren k\u00f6nnen abgefragt werden</p> <p>Implementierung: <pre><code>async function validateMongoVectorUpsert(\n  job: ExternalJob,\n  expected: ExpectedOutcome,\n  messages: ValidationMessage[]\n): Promise&lt;void&gt; {\n  if (!expected.expectMongoUpsert &amp;&amp; !expected.expectVectorUpsert) return\n\n  const fileId = job.correlation?.source?.itemId\n  if (!fileId) {\n    pushMessage(messages, 'warn', 'Keine fileId im Job gefunden')\n    return\n  }\n\n  try {\n    const { loadLibraryChatContext } = await import('@/lib/chat/loader')\n    const { getVectorCollection, getMetaByFileId, queryVectors } = await import('@/lib/repositories/vector-repo')\n\n    const ctx = await loadLibraryChatContext(job.userEmail, job.libraryId)\n    if (!ctx) {\n      pushMessage(messages, 'error', 'Bibliothek nicht gefunden')\n      return\n    }\n\n    const libraryKey = getCollectionNameForLibrary(ctx.library)\n    const dimension = getEmbeddingDimensionForModel(ctx.library.config?.chat)\n\n    // 1. Pr\u00fcfe Meta-Dokument\n    const metaDoc = await getMetaByFileId(libraryKey, fileId)\n    if (!metaDoc) {\n      pushMessage(messages, 'error', `Meta-Dokument nicht gefunden f\u00fcr fileId \"${fileId}\"`)\n    } else {\n      const chunkCount = typeof metaDoc.chunkCount === 'number' ? metaDoc.chunkCount : 0\n      const chaptersCount = typeof metaDoc.chaptersCount === 'number' ? metaDoc.chaptersCount : 0\n      pushMessage(messages, 'info', `Meta-Dokument gefunden: chunkCount=${chunkCount}, chaptersCount=${chaptersCount}`)\n    }\n\n    // 2. Pr\u00fcfe Chunk-Vektoren\n    const zeroVector = new Array&lt;number&gt;(dimension).fill(0)\n    const chunkVectors = await queryVectors(\n      libraryKey,\n      zeroVector,\n      10,\n      {\n        libraryId: job.libraryId,\n        user: job.userEmail,\n        fileId,\n        kind: 'chunk',\n      },\n      dimension\n    )\n\n    if (chunkVectors.length === 0) {\n      pushMessage(messages, 'error', `Keine Chunk-Vektoren gefunden f\u00fcr fileId \"${fileId}\"`)\n    } else {\n      pushMessage(messages, 'info', `${chunkVectors.length} Chunk-Vektoren gefunden`)\n\n      // Pr\u00fcfe Facetten-Metadaten in Chunks\n      const firstChunk = chunkVectors[0]\n      const hasFacets = firstChunk.year !== undefined || \n                        firstChunk.authors !== undefined || \n                        firstChunk.region !== undefined\n      if (hasFacets) {\n        pushMessage(messages, 'info', 'Chunk-Vektoren enthalten Facetten-Metadaten (f\u00fcr Filterung)')\n      } else {\n        pushMessage(messages, 'warn', 'Chunk-Vektoren enthalten keine Facetten-Metadaten')\n      }\n    }\n\n    // 3. Pr\u00fcfe Chapter-Summaries (falls vorhanden)\n    if (metaDoc &amp;&amp; metaDoc.chaptersCount &gt; 0) {\n      const chapterSummaries = await queryVectors(\n        libraryKey,\n        zeroVector,\n        10,\n        {\n          libraryId: job.libraryId,\n          user: job.userEmail,\n          fileId,\n          kind: 'chapterSummary',\n        },\n        dimension\n      )\n\n      if (chapterSummaries.length &gt; 0) {\n        pushMessage(messages, 'info', `${chapterSummaries.length} Chapter-Summaries gefunden`)\n      } else {\n        pushMessage(messages, 'warn', 'Chapter-Summaries erwartet, aber keine gefunden')\n      }\n    }\n\n    // 4. Pr\u00fcfe Vector Search Index\n    const collection = getVectorCollection(libraryKey)\n    const indexes = await collection.listSearchIndexes().toArray()\n    const vectorIndex = indexes.find(idx =&gt; idx.name === 'vector_search_idx')\n\n    if (!vectorIndex) {\n      pushMessage(messages, 'error', 'Vector Search Index nicht gefunden')\n    } else {\n      pushMessage(messages, 'info', 'Vector Search Index existiert')\n    }\n\n    // 5. Teste Vector Search Query\n    if (chunkVectors.length &gt; 0 &amp;&amp; chunkVectors[0].embedding) {\n      const testQuery = await queryVectors(\n        libraryKey,\n        chunkVectors[0].embedding,\n        5,\n        {\n          libraryId: job.libraryId,\n          user: job.userEmail,\n          fileId,\n          kind: 'chunk',\n        },\n        dimension\n      )\n\n      if (testQuery.length &gt; 0) {\n        pushMessage(messages, 'info', `Vector Search Query erfolgreich: ${testQuery.length} Ergebnisse`)\n      } else {\n        pushMessage(messages, 'warn', 'Vector Search Query lieferte keine Ergebnisse')\n      }\n    }\n  } catch (error) {\n    pushMessage(\n      messages,\n      'error',\n      `Fehler beim Pr\u00fcfen von MongoDB Vector Search: ${error instanceof Error ? error.message : String(error)}`\n    )\n  }\n}\n</code></pre></p>"},{"location":"_analysis/integration-tests-phase3-analysis.html#vorschlag-neue-test-cases","title":"Vorschlag: Neue Test-Cases","text":""},{"location":"_analysis/integration-tests-phase3-analysis.html#tc-34-mongodb-vector-search-ingestion-mit-force-policy","title":"TC-3.4: MongoDB Vector Search Ingestion mit force-Policy","text":"<ul> <li>Beschreibung: Pr\u00fcft, ob Meta-Dokument und Chunk-Vektoren in MongoDB Vector Search Collection existieren</li> <li>Erwartungen:</li> <li><code>expectMongoUpsert: true</code> \u2192 Meta-Dokument existiert</li> <li><code>expectVectorUpsert: true</code> \u2192 Chunk-Vektoren existieren</li> <li><code>expectVectorSearchIndex: true</code> \u2192 Vector Search Index existiert</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#tc-35-mongodb-vector-search-ingestion-mit-auto-policy","title":"TC-3.5: MongoDB Vector Search Ingestion mit auto-Policy","text":"<ul> <li>Beschreibung: Gate-basierte Ingestion, pr\u00fcft ob Skip-Logik funktioniert</li> <li>Erwartungen:</li> <li>Wenn Vektoren existieren \u2192 Skip</li> <li>Wenn keine Vektoren existieren \u2192 Run</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#tc-36-vector-search-funktionalitat-neu","title":"TC-3.6: Vector Search Funktionalit\u00e4t (NEU)","text":"<ul> <li>Beschreibung: Pr\u00fcft, ob Vector Search Queries funktionieren</li> <li>Erwartungen:</li> <li>Vector Search Query liefert Ergebnisse</li> <li>Filter funktionieren (libraryId, user, fileId, kind)</li> <li>Facetten-Filter funktionieren</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#tc-37-facetten-metadaten-in-vektoren-neu","title":"TC-3.7: Facetten-Metadaten in Vektoren (NEU)","text":"<ul> <li>Beschreibung: Pr\u00fcft, ob Facetten-Metadaten korrekt in Chunk-Vektoren kopiert wurden</li> <li>Erwartungen:</li> <li>Chunk-Vektoren enthalten Facetten-Metadaten</li> <li>Filterung nach Facetten funktioniert</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#vorschlag-anpassungen-an-expectedoutcome","title":"Vorschlag: Anpassungen an ExpectedOutcome","text":"<pre><code>export interface ExpectedOutcome {\n  // ... bestehende Felder ...\n\n  /** MongoDB Vector Search: Meta-Dokument soll existieren */\n  expectMetaDocument?: boolean;\n\n  /** MongoDB Vector Search: Chunk-Vektoren sollen existieren */\n  expectChunkVectors?: boolean;\n\n  /** MongoDB Vector Search: Chapter-Summaries sollen existieren */\n  expectChapterSummaries?: boolean;\n\n  /** MongoDB Vector Search: Vector Search Index soll existieren */\n  expectVectorSearchIndex?: boolean;\n\n  /** MongoDB Vector Search: Vector Search Query soll funktionieren */\n  expectVectorSearchQuery?: boolean;\n\n  /** MongoDB Vector Search: Facetten-Metadaten sollen in Chunks vorhanden sein */\n  expectFacetMetadataInChunks?: boolean;\n\n  // Veraltete Felder (f\u00fcr R\u00fcckw\u00e4rtskompatibilit\u00e4t behalten, aber als deprecated markieren)\n  /** @deprecated Verwende expectMetaDocument statt expectMongoUpsert */\n  expectMongoUpsert?: boolean;\n\n  /** @deprecated Nicht mehr relevant nach MongoDB-Migration */\n  expectPineconeUpsert?: boolean;\n}\n</code></pre>"},{"location":"_analysis/integration-tests-phase3-analysis.html#zusammenfassung-was-muss-geandert-werden","title":"Zusammenfassung: Was muss ge\u00e4ndert werden?","text":""},{"location":"_analysis/integration-tests-phase3-analysis.html#1-validatoren-aktualisieren","title":"1. Validatoren aktualisieren","text":"<ul> <li>\u2705 <code>validateMongoUpsert()</code> \u2192 <code>validateMongoVectorUpsert()</code> umbenennen und anpassen</li> <li>\u274c <code>validatePineconeUpsert()</code> entfernen oder als deprecated markieren</li> <li>\u2705 Neue Validierungen f\u00fcr Vector Search Index und Queries hinzuf\u00fcgen</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#2-test-cases-aktualisieren","title":"2. Test-Cases aktualisieren","text":"<ul> <li>\u2705 TC-3.4, TC-3.5: Beschreibungen und Erwartungen anpassen</li> <li>\u274c TC-3.6, TC-3.7: Entfernen oder durch neue Vector Search Tests ersetzen</li> <li>\u2705 Neue Test-Cases f\u00fcr Vector Search Funktionalit\u00e4t hinzuf\u00fcgen</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#3-expectedoutcome-interface-erweitern","title":"3. ExpectedOutcome Interface erweitern","text":"<ul> <li>\u2705 Neue Felder f\u00fcr MongoDB Vector Search hinzuf\u00fcgen</li> <li>\u2705 Alte Felder als deprecated markieren</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#4-repository-imports-aktualisieren","title":"4. Repository-Imports aktualisieren","text":"<ul> <li>\u2705 <code>doc-meta-repo</code> \u2192 <code>vector-repo</code> in Validatoren</li> <li>\u2705 <code>getByFileIds</code> \u2192 <code>getMetaByFileId</code></li> <li>\u2705 <code>getCollectionNameForLibrary</code> aus <code>vector-repo</code> verwenden</li> </ul>"},{"location":"_analysis/integration-tests-phase3-analysis.html#ergebnis-prufung-wie-konnen-wir-ergebnisse-prufen","title":"Ergebnis-Pr\u00fcfung: Wie k\u00f6nnen wir Ergebnisse pr\u00fcfen?","text":""},{"location":"_analysis/integration-tests-phase3-analysis.html#1-meta-dokument-prufung","title":"1. Meta-Dokument Pr\u00fcfung","text":"<pre><code>const metaDoc = await getMetaByFileId(libraryKey, fileId)\n// Pr\u00fcfe: chunkCount, chaptersCount, docMetaJson, Facetten-Felder\n</code></pre>"},{"location":"_analysis/integration-tests-phase3-analysis.html#2-chunk-vektoren-prufung","title":"2. Chunk-Vektoren Pr\u00fcfung","text":"<pre><code>const chunks = await queryVectors(libraryKey, zeroVector, 10, {\n  libraryId, user, fileId, kind: 'chunk'\n}, dimension)\n// Pr\u00fcfe: Anzahl, Facetten-Metadaten, Embeddings-Dimension\n</code></pre>"},{"location":"_analysis/integration-tests-phase3-analysis.html#3-vector-search-index-prufung","title":"3. Vector Search Index Pr\u00fcfung","text":"<pre><code>const indexes = await collection.listSearchIndexes().toArray()\nconst vectorIndex = indexes.find(idx =&gt; idx.name === 'vector_search_idx')\n// Pr\u00fcfe: Index existiert, korrekte Konfiguration\n</code></pre>"},{"location":"_analysis/integration-tests-phase3-analysis.html#4-vector-search-query-prufung","title":"4. Vector Search Query Pr\u00fcfung","text":"<pre><code>const results = await queryVectors(libraryKey, queryVector, topK, filter, dimension)\n// Pr\u00fcfe: Ergebnisse vorhanden, Filter funktionieren, Scores sind sinnvoll\n</code></pre>"},{"location":"_analysis/integration-tests-phase3-analysis.html#5-facetten-filter-prufung","title":"5. Facetten-Filter Pr\u00fcfung","text":"<pre><code>const filteredResults = await queryVectors(libraryKey, queryVector, topK, {\n  libraryId, user, fileId, kind: 'chunk',\n  year: 2024, // Facetten-Filter\n}, dimension)\n// Pr\u00fcfe: Nur Dokumente mit year=2024 werden zur\u00fcckgegeben\n</code></pre>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html","title":"MongoDB Vector Search Ingestion - Technische Analyse","text":""},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#ubersicht","title":"\u00dcbersicht","text":"<p>Diese Analyse beschreibt den vollst\u00e4ndigen Ablauf der Vektor-Berechnung und Ingestion in MongoDB Atlas Vector Search f\u00fcr die RAG-Pipeline. Alle Embeddings laufen \u00fcber den Secretary Service RAG API (<code>/api/rag/embed-text</code>). Chunking erfolgt im Secretary Service, nicht mehr lokal.</p>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#verwendete-libraries-und-technologien","title":"Verwendete Libraries und Technologien","text":""},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#1-secretary-service-rag-api","title":"1. Secretary Service RAG API","text":"<ul> <li>Service: Secretary Service (<code>/api/rag/embed-text</code>)</li> <li>Model: Standard <code>voyage-3-large</code> (konfigurierbar pro Library via <code>config.chat.embeddings.embeddingModel</code>)</li> <li>Dimension: Standard 1024 f\u00fcr <code>voyage-3-large</code> (konfigurierbar via <code>config.chat.embeddings.dimensions</code>)</li> <li>Chunking: Erfolgt im Secretary Service (Markdown-aware, respektiert \u00dcberschriften und Abs\u00e4tze)</li> <li>Datei: <code>src/lib/secretary/client.ts</code> (<code>embedTextRag()</code>)</li> <li>Abstraktion: <code>src/lib/chat/rag-embeddings.ts</code></li> </ul> <p>Unterst\u00fctzte Modelle: - <code>voyage-3-large</code> (Standard, 1024 Dimensionen, beste Qualit\u00e4t laut Voyage Blog) - <code>voyage-3.5</code>, <code>voyage-3.5-lite</code> (1024 Dimensionen) - <code>voyage-code-3</code> (1024 Dimensionen) - <code>text-embedding-3-large</code> (3072 Dimensionen, OpenAI \u00fcber Secretary Service) - Weitere Voyage-Modelle</p>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#2-mongodb-atlas-vector-search","title":"2. MongoDB Atlas Vector Search","text":"<ul> <li>Database: MongoDB Atlas (oder MongoDB Server \u22657.0)</li> <li>Vector Search: Native <code>$vectorSearch</code> Aggregation Pipeline</li> <li>Index: Vector Search Index mit <code>knnVector</code> Feld-Typ</li> <li>Datei: <code>src/lib/repositories/vector-repo.ts</code></li> </ul> <p>Collection-Struktur: - Pro Library eine Collection: <code>vectors__${libraryId}</code> - Dokument-Typen (unterschieden durch <code>kind</code>-Feld):   - <code>kind: 'meta'</code> - Meta-Dokumente (ohne Embedding, enthalten vollst\u00e4ndige Metadaten)   - <code>kind: 'chunk'</code> - Text-Chunks (mit Embedding und Facetten-Metadaten)   - <code>kind: 'chapterSummary'</code> - Kapitel-Summaries (mit Embedding)</p> <p>WICHTIG:  - Alle Dokument-Typen werden in derselben Collection gespeichert - Facetten-Metadaten werden in Chunk- und ChapterSummary-Dokumente kopiert f\u00fcr direkte Filterung - Meta-Dokumente enthalten keine Embeddings (nur Metadaten f\u00fcr Gallery-Anzeige)</p>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#3-text-chunking-nicht-mehr-lokal-verwendet","title":"3. Text-Chunking (nicht mehr lokal verwendet)","text":"<ul> <li>Hinweis: Chunking erfolgt jetzt im Secretary Service</li> <li>Die lokale <code>chunkText()</code> Funktion (<code>src/lib/text/chunk.ts</code>) wird f\u00fcr Chat/RAG nicht mehr verwendet</li> <li>Secretary Service verwendet Markdown-aware Chunking (respektiert \u00dcberschriften, Abs\u00e4tze)</li> </ul>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#detaillierter-ablauf","title":"Detaillierter Ablauf","text":""},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#phase-1-markdown-vorbereitung","title":"Phase 1: Markdown-Vorbereitung","text":"<p>Datei: <code>src/lib/chat/ingestion-service.ts</code></p> <p>Prozess: 1. Frontmatter-Parsing: Extraktion von Meta und Body 2. Bild-Verarbeitung: Slides, Cover-Bilder und Markdown-Bilder werden auf Azure Storage hochgeladen 3. Finales Markdown: Das Markdown aus <code>docMetaJson.markdown</code> wird verwendet (identisch mit MongoDB-Inhalt)</p> <p>WICHTIG: Das finale Markdown enth\u00e4lt bereits alle Azure-Bild-URLs, die auch in MongoDB gespeichert sind. Damit ist Konsistenz zwischen Vector-Chunks und MongoDB-Dokument gew\u00e4hrleistet.</p>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#phase-2-secretary-service-rag-embedding","title":"Phase 2: Secretary Service RAG Embedding","text":"<p>Datei: <code>src/lib/chat/rag-embeddings.ts</code></p> <p>Funktion: <code>embedDocumentWithSecretary(markdown: string, ctx: LibraryChatContext, options?: {...}): Promise&lt;{chunks, dimensions, model}&gt;</code></p> <p>Prozess:</p> <ol> <li> <p>Config-Lesen:    <pre><code>const config = getEmbeddingConfig(ctx)\n// Defaults: model='voyage-3-large', chunkSize=1000, chunkOverlap=200, dimensions=1024\n</code></pre></p> </li> <li> <p>Secretary Service API-Aufruf:    <pre><code>POST ${SECRETARY_SERVICE_URL}/api/rag/embed-text\nHeaders:\n  Authorization: Bearer ${SECRETARY_SERVICE_API_KEY}\n  X-Secretary-Api-Key: ${SECRETARY_SERVICE_API_KEY}\n  Content-Type: application/json\nBody:\n  {\n    \"markdown\": \"...\", // Komplettes Dokument\n    \"document_id\": fileId,\n    \"chunk_size\": 1000,\n    \"chunk_overlap\": 200,\n    \"embedding_model\": \"voyage-3-large\",\n    \"metadata\": { ... }\n  }\n</code></pre></p> </li> <li> <p>Response-Struktur:    <pre><code>{\n  status: 'success',\n  data: {\n    chunks: [\n      {\n        text: \"...\",\n        chunk_index: 0,\n        document_id: \"...\",\n        embedding: [0.123, -0.456, ...], // 1024 Dimensionen\n        heading_context: \"Introduction\" | null,\n        start_char: 0 | null,\n        end_char: 100 | null,\n        metadata: { ... } // Zus\u00e4tzliche Metadaten vom Secretary Service\n      }\n    ],\n    dimensions: 1024,\n    model: \"voyage-3-large\"\n  }\n}\n</code></pre></p> </li> </ol>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#phase-3-mongodb-vector-search-upsert","title":"Phase 3: MongoDB Vector Search Upsert","text":"<p>Datei: <code>src/lib/repositories/vector-repo.ts</code></p> <p>Funktion: <code>upsertVectors(libraryKey: string, vectors: VectorDocument[]): Promise&lt;void&gt;</code></p> <p>Prozess:</p> <ol> <li> <p>Collection-Zugriff:    <pre><code>const col = await getVectorCollection(libraryKey)\n// Collection-Name: vectors__${libraryId}\n</code></pre></p> </li> <li> <p>Vector Search Index Setup (automatisch):</p> </li> <li>Index wird automatisch erstellt beim ersten Zugriff</li> <li>Index-Name: <code>vector_search_idx</code></li> <li> <p>Index-Definition:      <pre><code>{\n  \"mappings\": {\n    \"dynamic\": true,\n    \"fields\": {\n      \"embedding\": {\n        \"type\": \"knnVector\",\n        \"dimensions\": 1024, // Aus Config\n        \"similarity\": \"cosine\"\n      }\n    }\n  }\n}\n</code></pre></p> </li> <li> <p>Chunk-Vektoren erstellen:    <pre><code>const vectors = ragResult.chunks.map(chunk =&gt; ({\n  _id: `${fileId}-${chunk.index}`,\n  kind: 'chunk',\n  libraryId,\n  user: userEmail,\n  fileId,\n  fileName,\n  chunkIndex: chunk.index,\n  text: chunk.text,\n  embedding: chunk.embedding,\n  headingContext: chunk.headingContext,\n  startChar: chunk.startChar,\n  endChar: chunk.endChar,\n  upsertedAt: new Date().toISOString(),\n  // Facetten-Metadaten f\u00fcr direkte Filterung\n  year: mongoDoc.year,\n  authors: mongoDoc.authors,\n  region: mongoDoc.region,\n  docType: mongoDoc.docType,\n  source: mongoDoc.source,\n  tags: mongoDoc.tags,\n  // ... weitere Facetten-Felder\n}))\n</code></pre></p> </li> <li> <p>Batch-Upsert:    <pre><code>await upsertVectors(libraryKey, vectors)\n// Verwendet MongoDB bulkWrite mit Batches von 1000\n</code></pre></p> </li> <li> <p>Meta-Dokument erstellen:    <pre><code>const metaDoc = {\n  libraryId,\n  user: userEmail,\n  fileId,\n  fileName,\n  chunkCount: vectors.length,\n  chaptersCount,\n  docMetaJson: docMetaJsonObj,\n  chapters: chaptersForMongo,\n  upsertedAt: new Date().toISOString(),\n  // Alle Facetten-Metadaten\n  year, authors, region, docType, source, tags, ...\n}\nawait upsertVectorMeta(libraryKey, metaDoc)\n// Speichert als kind: 'meta' ohne Embedding\n</code></pre></p> </li> </ol> <p>WICHTIG:  - Facetten-Metadaten werden in jeden Chunk kopiert f\u00fcr direkte Filterung w\u00e4hrend Vector Search - Meta-Dokumente enthalten keine Embeddings (nur Metadaten) - Alle Dokument-Typen werden in derselben Collection gespeichert</p>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#phase-4-vector-search-query","title":"Phase 4: Vector Search Query","text":"<p>Datei: <code>src/lib/repositories/vector-repo.ts</code></p> <p>Funktion: <code>queryVectors(libraryKey: string, queryVector: number[], topK: number, filter: Record&lt;string, unknown&gt;, dimension?: number): Promise&lt;QueryMatch[]&gt;</code></p> <p>Prozess:</p> <ol> <li> <p>Vector Search Aggregation Pipeline:    <pre><code>const pipeline = [\n  {\n    $vectorSearch: {\n      index: 'vector_search_idx',\n      path: 'embedding',\n      queryVector: queryVector,\n      numCandidates: Math.max(topK * 10, 100),\n      limit: topK,\n      filter: {\n        kind: { $in: ['chunk', 'chapterSummary'] },\n        libraryId: { $eq: libraryId },\n        user: { $eq: userEmail },\n        // Direkte Facetten-Filterung\n        year: { $in: [2023, 2024] },\n        authors: { $in: ['Author1', 'Author2'] },\n        // ... weitere Filter\n      }\n    }\n  },\n  {\n    $project: {\n      _id: 1,\n      score: { $meta: 'vectorSearchScore' },\n      // ... Metadaten\n    }\n  }\n]\n</code></pre></p> </li> <li> <p>Ergebnisse:    <pre><code>const results = await col.aggregate(pipeline).toArray()\nreturn results.map(doc =&gt; ({\n  id: doc._id,\n  score: doc.score,\n  metadata: { ...doc }\n}))\n</code></pre></p> </li> </ol> <p>Vorteile: - Direkte Filterung in Vector Search (keine separate MongoDB-Query n\u00f6tig) - Alle Facetten-Metadaten sind in den Vektoren verf\u00fcgbar - Einzelne Query statt zwei separate Queries</p>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#code-referenzen","title":"Code-Referenzen","text":""},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#ingestion-service","title":"Ingestion Service","text":"<ul> <li><code>src/lib/chat/ingestion-service.ts</code>: Haupt-Ingestion-Logik</li> <li><code>upsertMarkdown()</code>: Kompletter Upsert-Prozess</li> <li>Erstellt Chunk-Vektoren mit Facetten-Metadaten</li> <li>Erstellt Meta-Dokument ohne Embedding</li> </ul>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#vector-repository","title":"Vector Repository","text":"<ul> <li><code>src/lib/repositories/vector-repo.ts</code>: MongoDB Vector Search Repository</li> <li><code>getVectorCollection()</code>: Collection-Zugriff mit automatischem Index-Setup</li> <li><code>upsertVectors()</code>: Batch-Upsert von Vektoren</li> <li><code>upsertVectorMeta()</code>: Upsert von Meta-Dokumenten</li> <li><code>queryVectors()</code>: Vector Search Query mit Filterung</li> <li><code>findDocs()</code>: Findet Meta-Dokumente f\u00fcr Gallery</li> <li><code>aggregateFacets()</code>: Aggregiert Facetten aus Meta-Dokumenten</li> </ul>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#retriever","title":"Retriever","text":"<ul> <li><code>src/lib/chat/retrievers/chunks.ts</code>: Chunk-Retriever</li> <li>Verwendet <code>queryVectors()</code> f\u00fcr semantische Suche</li> <li>Filter werden direkt in Vector Search angewendet</li> <li> <p>L\u00e4dt Nachbar-Chunks aus MongoDB f\u00fcr Kontext</p> </li> <li> <p><code>src/lib/chat/retrievers/chunk-summary.ts</code>: ChunkSummary-Retriever</p> </li> <li>L\u00e4dt alle Chunks direkt aus MongoDB ohne Vector Search</li> <li>Verwendet direkte MongoDB-Abfrage mit Filterung</li> </ul>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#umgebungsvariablen","title":"Umgebungsvariablen","text":"Variable Default Beschreibung <code>MONGODB_URI</code> - MongoDB Connection String (erforderlich) <code>SECRETARY_SERVICE_URL</code> - Secretary Service URL (erforderlich) <code>SECRETARY_SERVICE_API_KEY</code> - Secretary Service API-Key (erforderlich) <p>Hinweis: <code>PINECONE_API_KEY</code> wird nicht mehr ben\u00f6tigt.</p>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#collection-struktur","title":"Collection-Struktur","text":""},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#collection-name","title":"Collection-Name","text":"<ul> <li>Format: <code>vectors__${libraryId}</code></li> <li>Beispiel: <code>vectors__lib-abc123</code></li> </ul>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#dokument-struktur","title":"Dokument-Struktur","text":""},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#meta-dokument-kind-meta","title":"Meta-Dokument (kind: 'meta')","text":"<pre><code>{\n  _id: `${fileId}-meta`,\n  kind: 'meta',\n  libraryId: string,\n  user: string,\n  fileId: string,\n  fileName: string,\n  chunkCount: number,\n  chaptersCount: number,\n  docMetaJson: Record&lt;string, unknown&gt;,\n  chapters: Array&lt;ChapterMetaEntry&gt;,\n  // Facetten-Metadaten\n  year?: number,\n  authors?: string[],\n  region?: string,\n  docType?: string,\n  source?: string,\n  tags?: string[],\n  upsertedAt: string,\n  // KEIN embedding-Feld\n}\n</code></pre>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#chunk-dokument-kind-chunk","title":"Chunk-Dokument (kind: 'chunk')","text":"<pre><code>{\n  _id: `${fileId}-${chunkIndex}`,\n  kind: 'chunk',\n  libraryId: string,\n  user: string,\n  fileId: string,\n  fileName: string,\n  chunkIndex: number,\n  text: string,\n  embedding: number[], // Vector Embedding\n  headingContext?: string,\n  startChar?: number,\n  endChar?: number,\n  upsertedAt: string,\n  // Facetten-Metadaten (f\u00fcr Filterung kopiert)\n  year?: number,\n  authors?: string[],\n  region?: string,\n  docType?: string,\n  source?: string,\n  tags?: string[],\n}\n</code></pre>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#chaptersummary-dokument-kind-chaptersummary","title":"ChapterSummary-Dokument (kind: 'chapterSummary')","text":"<pre><code>{\n  _id: `${fileId}-chap-${chapterId}`,\n  kind: 'chapterSummary',\n  libraryId: string,\n  user: string,\n  fileId: string,\n  fileName: string,\n  chapterId: string,\n  chapterTitle?: string,\n  chapterOrder?: number,\n  text: string,\n  embedding: number[], // Vector Embedding\n  keywords?: string[],\n  upsertedAt: string,\n  // Facetten-Metadaten (f\u00fcr Filterung kopiert)\n  year?: number,\n  authors?: string[],\n  // ...\n}\n</code></pre>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#vector-search-index","title":"Vector Search Index","text":""},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#automatisches-setup","title":"Automatisches Setup","text":"<ul> <li>Index wird automatisch beim ersten Zugriff erstellt</li> <li>Verwendet <code>db.admin().command({ createSearchIndexes: ... })</code></li> <li>Dimension wird aus Library-Config gelesen</li> </ul>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#index-definition","title":"Index-Definition","text":"<pre><code>{\n  \"name\": \"vector_search_idx\",\n  \"definition\": {\n    \"mappings\": {\n      \"dynamic\": true,\n      \"fields\": {\n        \"embedding\": {\n          \"type\": \"knnVector\",\n          \"dimensions\": 1024,\n          \"similarity\": \"cosine\"\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#indizes-fur-filterung","title":"Indizes f\u00fcr Filterung","text":"<ul> <li><code>libraryId</code>: Index f\u00fcr Library-Filterung</li> <li><code>fileId</code>: Index f\u00fcr File-Filterung</li> <li><code>kind</code>: Index f\u00fcr Dokument-Typ-Filterung</li> <li><code>user</code>: Index f\u00fcr User-Filterung</li> <li>Facetten-Indizes: Automatisch erstellt via <code>ensureFacetIndexes()</code></li> </ul>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#performance-optimierungen","title":"Performance-Optimierungen","text":"<ol> <li>Batch-Upsert: Vektoren werden in Batches von 1000 upsertet</li> <li>Direkte Filterung: Facetten-Filter werden direkt in Vector Search angewendet</li> <li>Meta-Dokumente: Keine Embeddings in Meta-Dokumenten (spart Speicher)</li> <li>Facetten-Duplikation: Metadaten werden in Chunks kopiert f\u00fcr direkte Filterung</li> <li>Index-Caching: Collection- und Index-Cache f\u00fcr bessere Performance</li> </ol>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#fehlerbehandlung","title":"Fehlerbehandlung","text":""},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#vector-search-index_1","title":"Vector Search Index","text":"<ul> <li>Fehler beim Index-Setup werden geloggt, aber nicht geworfen</li> <li>Index kann manuell erstellt werden falls automatisches Setup fehlschl\u00e4gt</li> </ul>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#upsert-fehler","title":"Upsert-Fehler","text":"<ul> <li>Fehler werden geloggt und weitergeworfen</li> <li>Job wird als failed markiert bei kritischen Fehlern</li> </ul>"},{"location":"_analysis/mongodb-vector-search-ingestion-analysis.html#zusammenfassung","title":"Zusammenfassung","text":"<p>Die MongoDB Vector Search Ingestion erfolgt in mehreren Phasen:</p> <ol> <li>Markdown-Vorbereitung: Frontmatter-Parsing, Bild-Upload</li> <li>Secretary Service RAG Embedding: Chunking und Embedding-Generierung</li> <li>MongoDB Vector Search Upsert: Batch-Upsert mit automatischem Index-Setup</li> <li>Meta-Dokument: Speicherung ohne Embedding f\u00fcr Gallery-Anzeige</li> </ol> <p>Die verwendeten Libraries sind minimal: Native MongoDB Driver f\u00fcr Vector Search, keine externen Dependencies f\u00fcr Embeddings oder Vector-Datenbank-Integration.</p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html","title":"MongoDB Vector Search Migration - Dokumentations-Update","text":""},{"location":"_analysis/mongodb-vector-search-migration-docs.html#ubersicht","title":"\u00dcbersicht","text":"<p>Nach der Migration von Pinecone zu MongoDB Vector Search m\u00fcssen mehrere Dokumentationsdateien aktualisiert werden. Diese Datei listet alle betroffenen Dokumente und die notwendigen \u00c4nderungen auf.</p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#kritische-updates-muss-aktualisiert-werden","title":"Kritische Updates (Muss aktualisiert werden)","text":""},{"location":"_analysis/mongodb-vector-search-migration-docs.html#1-docs_analysispinecone-ingestion-analysismd-komplett-uberarbeiten","title":"1. <code>docs/_analysis/pinecone-ingestion-analysis.md</code> \u26a0\ufe0f KOMPLETT \u00dcBERARBEITEN","text":"<p>Status: Komplett veraltet - beschreibt Pinecone-Architektur</p> <p>\u00c4nderungen: - Titel \u00e4ndern zu: \"MongoDB Vector Search Ingestion - Technische Analyse\" - Alle Pinecone-Referenzen durch MongoDB Vector Search ersetzen - Neue Architektur beschreiben:   - MongoDB Atlas Vector Search statt Pinecone   - Collection-Struktur pro Library (<code>vectors__${libraryId}</code>)   - Meta-Dokumente (kind: 'meta') ohne Embeddings   - Chunk-Dokumente (kind: 'chunk') mit Embeddings   - Chapter-Summary-Dokumente (kind: 'chapterSummary') mit Embeddings - Vector Search Index Setup beschreiben - <code>$vectorSearch</code> Aggregation Pipeline erkl\u00e4ren - Repository-Pattern (<code>vector-repo.ts</code>) dokumentieren</p> <p>Neue Struktur: <pre><code># MongoDB Vector Search Ingestion - Technische Analyse\n\n## \u00dcbersicht\nDiese Analyse beschreibt den vollst\u00e4ndigen Ablauf der Vektor-Berechnung und Ingestion in MongoDB Atlas Vector Search f\u00fcr die RAG-Pipeline.\n\n## Verwendete Libraries und Technologien\n\n### 1. Secretary Service RAG API\n[... bleibt gleich ...]\n\n### 2. MongoDB Atlas Vector Search\n- **Database**: MongoDB Atlas (oder MongoDB Server \u22657.0)\n- **Vector Search**: Native `$vectorSearch` Aggregation Pipeline\n- **Index**: Vector Search Index mit `knnVector` Feld-Typ\n- **Datei**: `src/lib/repositories/vector-repo.ts`\n\n**Collection-Struktur**:\n- Pro Library eine Collection: `vectors__${libraryId}`\n- Dokument-Typen:\n  - `kind: 'meta'` - Meta-Dokumente (ohne Embedding)\n  - `kind: 'chunk'` - Text-Chunks (mit Embedding)\n  - `kind: 'chapterSummary'` - Kapitel-Summaries (mit Embedding)\n\n### 3. Text-Chunking\n[... bleibt gleich ...]\n</code></pre></p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#2-docs_analysischat-orchestration-flowmd-mehrere-stellen","title":"2. <code>docs/_analysis/chat-orchestration-flow.md</code> \u26a0\ufe0f MEHRERE STELLEN","text":"<p>Betroffene Abschnitte: - Zeile 164: \"L\u00e4dt alle Chunks dieser Dokumente aus Pinecone\" \u2192 MongoDB - Zeile 190: \"Semantische Suche in Pinecone\" \u2192 MongoDB Vector Search - Zeile 383: \"Semantische Suche in Pinecone\" \u2192 MongoDB Vector Search - Zeile 386: \"Pinecone Query API\" \u2192 MongoDB Vector Search Aggregation - Zeile 391: \"Pinecone-Index-Performance\" \u2192 MongoDB Vector Search Index - Zeile 399: \"Pinecone Fetch API\" \u2192 MongoDB direkte Abfrage - Zeile 403: \"Pinecone Fetch API kann bei vielen IDs langsam sein\" \u2192 MongoDB Query-Optimierung - Zeile 439: \"Pinecone Query-Performance\" \u2192 MongoDB Vector Search Performance - Zeile 724: \"Pinecone-Performance\" \u2192 MongoDB Performance</p> <p>\u00c4nderungen: - Alle Pinecone-Referenzen durch MongoDB Vector Search ersetzen - Neue Query-Struktur beschreiben (<code>$vectorSearch</code> Aggregation) - Filter-Logik aktualisieren (direkte Filterung in Vector Search) - Performance-Hinweise anpassen</p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#3-docsarchitecturepdf-transformation-phasesmd-phase-3","title":"3. <code>docs/architecture/pdf-transformation-phases.md</code> \u26a0\ufe0f PHASE 3","text":"<p>Betroffene Abschnitte: - Zeile 198: \"Ingest transformed Markdown into vector database (Pinecone)\" \u2192 MongoDB Vector Search - Zeile 210: \"Chunks with embeddings are received and stored in Pinecone\" \u2192 MongoDB - Zeile 237: \"Vector embeddings: Stored in Pinecone\" \u2192 MongoDB Vector Search - Zeile 248: \"Pinecone/MongoDB upsert\" \u2192 MongoDB Vector Search upsert - Zeile 251: \"uses Pinecone <code>listVectors</code>\" \u2192 MongoDB Query - Zeile 267: \"vectors for this document already exist in the Pinecone index\" \u2192 MongoDB Collection</p> <p>\u00c4nderungen: - Phase 3 komplett \u00fcberarbeiten - MongoDB Vector Search Collection-Struktur beschreiben - Neue Upsert-Logik dokumentieren - Gate-Checking auf MongoDB umstellen</p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#4-docsreferencemoduleschatmd-dependencies-retriever","title":"4. <code>docs/reference/modules/chat.md</code> \u26a0\ufe0f DEPENDENCIES &amp; RETRIEVER","text":"<p>Betroffene Abschnitte: - Zeile 109: \"Uses OpenAI API for LLM calls, Pinecone for vector search\" \u2192 MongoDB Vector Search - Zeile 122: \"Semantic search in Pinecone for specific chunks\" \u2192 MongoDB Vector Search</p> <p>\u00c4nderungen: <pre><code>## Dependencies\n- **Library System**: Uses `@/lib/services/library-service` for library access\n- **Database**: Uses `@/lib/mongodb-service` for chat and query persistence\n- **Storage**: Uses storage providers for file access\n- **External**: Uses OpenAI API for LLM calls, MongoDB Atlas Vector Search for vector search\n\n## Retriever Types\n- **`chunk`**: Semantic search in MongoDB Vector Search for specific chunks\n- **`summary`**: MongoDB search for document summaries\n- **`chunkSummary`**: Loads all chunks from MongoDB without vector search\n- **`auto`**: Automatic retriever selection based on question analysis\n</code></pre></p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#optionale-updates-kann-aktualisiert-werden","title":"Optionale Updates (Kann aktualisiert werden)","text":""},{"location":"_analysis/mongodb-vector-search-migration-docs.html#5-docs_analysisfile-inventorymd","title":"5. <code>docs/_analysis/file-inventory.md</code>","text":"<p>Betroffene Abschnitte: - Zeile 122: <code>src/app/api/health/pinecone/route.ts</code> - Diese Route existiert m\u00f6glicherweise noch, sollte aber als veraltet markiert werden</p> <p>\u00c4nderungen: - Health-Check-Route als veraltet markieren oder entfernen - Neue MongoDB Health-Check-Route dokumentieren (falls vorhanden)</p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#6-docs_analysispdf-transformation-phases-istmd","title":"6. <code>docs/_analysis/pdf-transformation-phases-ist.md</code>","text":"<p>Betroffene Abschnitte: - Zeile 192: Pinecone-Referenzen in Gate-Checking - Zeile 229: Pinecone-Upsert-Logik</p> <p>\u00c4nderungen: - Gate-Checking auf MongoDB umstellen - Upsert-Logik aktualisieren</p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#neue-dokumentation-erstellen","title":"Neue Dokumentation erstellen","text":""},{"location":"_analysis/mongodb-vector-search-migration-docs.html#7-docsarchitecturemongodb-vector-searchmd-neu","title":"7. <code>docs/architecture/mongodb-vector-search.md</code> \u2b50 NEU","text":"<p>Inhalt: - MongoDB Vector Search Architektur-\u00dcbersicht - Collection-Struktur und Dokument-Typen - Vector Search Index Setup - Query-Patterns (<code>$vectorSearch</code> Aggregation) - Filter-Strategien - Performance-Optimierung - Migration von Pinecone (historischer Kontext)</p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#8-docsreferencemongodb-vector-search-indexmd-neu","title":"8. <code>docs/reference/mongodb-vector-search-index.md</code> \u2b50 NEU","text":"<p>Inhalt: - Index-Definition - Automatisches Index-Setup - Index-Management - Troubleshooting</p>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#dokumentation-die-aktuell-bleibt","title":"Dokumentation die aktuell bleibt","text":""},{"location":"_analysis/mongodb-vector-search-migration-docs.html#docsmongodb-indexesmd","title":"\u2705 <code>docs/mongodb-indexes.md</code>","text":"<ul> <li>Beschreibt QueryLog-Collection-Indexe</li> <li>Keine Pinecone-Referenzen</li> <li>Keine \u00c4nderungen n\u00f6tig</li> </ul>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#prioritaten","title":"Priorit\u00e4ten","text":"<ol> <li>Hoch: <code>pinecone-ingestion-analysis.md</code> komplett neu schreiben</li> <li>Hoch: <code>chat-orchestration-flow.md</code> aktualisieren</li> <li>Mittel: <code>pdf-transformation-phases.md</code> Phase 3 aktualisieren</li> <li>Mittel: <code>reference/modules/chat.md</code> Dependencies aktualisieren</li> <li>Niedrig: Neue Architektur-Dokumentation erstellen</li> <li>Niedrig: Optionale Dateien aktualisieren</li> </ol>"},{"location":"_analysis/mongodb-vector-search-migration-docs.html#checkliste-fur-updates","title":"Checkliste f\u00fcr Updates","text":"<ul> <li>[x] <code>pinecone-ingestion-analysis.md</code> \u2192 <code>mongodb-vector-search-ingestion-analysis.md</code> umbenennen und komplett neu schreiben \u2705</li> <li>[x] <code>chat-orchestration-flow.md</code> alle Pinecone-Referenzen durch MongoDB Vector Search ersetzen \u2705</li> <li>[x] <code>pdf-transformation-phases.md</code> Phase 3 aktualisieren \u2705</li> <li>[x] <code>reference/modules/chat.md</code> Dependencies und Retriever-Typen aktualisieren \u2705</li> <li>[x] <code>pdf-transformation-phases-ist.md</code> Gate-Checking aktualisieren \u2705</li> <li>[x] <code>file-inventory.md</code> veraltete Referenzen markieren \u2705</li> <li>[ ] Neue Architektur-Dokumentation erstellen (optional)</li> <li>[ ] Optionale Dateien durchgehen und aktualisieren (optional)</li> </ul>"},{"location":"_analysis/pdf-transformation-phases-ist.html","title":"Analyse: PDF-Transformation \u2013 IST-Zustand der 3 Phasen","text":""},{"location":"_analysis/pdf-transformation-phases-ist.html#ziel-dieser-analyse","title":"Ziel dieser Analyse","text":"<p>Dieses Dokument beschreibt den IST-Zustand der PDF-Transformation in drei Phasen (Extract, Template, Ingestion) inklusive der realen Ausf\u00fchrungspfade im Code (Worker, Start-Route, Callback-Route, Library-Module). Es dient ausschlie\u00dflich der Dokumentation und Entscheidungsgrundlage f\u00fcr die Aktualisierung von <code>docs/architecture/pdf-transformation-phases.md</code> \u2013 der Code selbst wird hier nicht ver\u00e4ndert.</p> <p>Die Kernfragen:</p> <ul> <li>Wie werden die drei Phasen im aktuellen System tats\u00e4chlich abgearbeitet?</li> <li>Welche Dateien / Module sind jeweils beteiligt?</li> <li>Wo entstehen Kopplungen zwischen Phasen (Start-Route vs. Callback-Route)?</li> </ul>"},{"location":"_analysis/pdf-transformation-phases-ist.html#1-orchestrierung-auf-hoher-ebene-ist","title":"1. Orchestrierung auf hoher Ebene (IST)","text":""},{"location":"_analysis/pdf-transformation-phases-ist.html#11-beteilige-parteien","title":"1.1 Beteilige Parteien","text":"<ul> <li>ExternalJobsWorker </li> <li>Datei: <code>src/lib/external-jobs-worker.ts</code> </li> <li> <p>Rolle: Pollt Jobs aus der Queue, ruft f\u00fcr jeden gefundenen Job die Start-Route auf:</p> <ul> <li><code>POST /api/external/jobs/[jobId]/start</code></li> </ul> </li> <li> <p>Start-Route </p> </li> <li>Datei: <code>src/app/api/external/jobs/[jobId]/start/route.ts</code> </li> <li>Rolle:<ul> <li>L\u00e4dt die PDF aus dem Storage (\u00fcber <code>getServerProvider</code>)</li> <li>Startet Watchdog und initialisiert Trace/Steps (<code>extract_pdf</code>, <code>transform_template</code>, <code>ingest_rag</code>)</li> <li>F\u00fchrt ein Preprocessing aus (<code>preprocess</code>) und entscheidet \u00fcber Extract/Template/Ingest-only anhand:</li> <li>Shadow-Twin-Gate (<code>gateExtractPdf</code>)</li> <li>Phase-Policies (<code>getPolicies</code> / <code>shouldRunExtract</code>)</li> <li>Job-Parameter <code>phases</code> (extract/template/ingest)</li> <li>Ruft den Secretary Service (<code>/api/pdf/process</code> oder <code>/api/pdf/process-mistral-ocr</code>) mit:</li> <li>PDF-File</li> <li>Callback-URL: <code>/api/external/jobs/[jobId]</code></li> <li>Callback-Token (secret)  </li> </ul> </li> <li> <p>WICHTIG: Die Start-Route kann selbst (ohne weiteren Secretary-Request) eine Ingest-only-Variante fahren, wenn bereits ein Shadow-Twin mit transformiertem Markdown existiert (siehe Block <code>runIngestOnly</code> in der Start-Route).</p> </li> <li> <p>Secretary Service (extern) </p> </li> <li>Nicht im Repo, aber zentral im Flow:</li> <li>Endpoints:<ul> <li><code>/api/pdf/process</code> (Standard-Extraktion)</li> <li><code>/api/pdf/process-mistral-ocr</code> (Mistral OCR)</li> <li><code>/api/pdf/jobs/{job_id}/mistral-ocr-raw</code> (Download kompletter OCR-Daten)</li> </ul> </li> <li> <p>Sendet Callbacks an:</p> <ul> <li><code>POST /api/external/jobs/[jobId]</code> mit Payload-Feldern wie <code>extracted_text</code>, <code>pages_archive_url</code>, <code>mistral_ocr_raw_url</code>, <code>mistral_ocr_raw_metadata</code>, <code>mistral_ocr_images_url</code>.</li> </ul> </li> <li> <p>Callback-Route </p> </li> <li>Datei: <code>src/app/api/external/jobs/[jobId]/route.ts</code> </li> <li>Rolle: Zentrale Orchestrierung des laufenden Jobs beim Eintreffen eines Callbacks:<ul> <li>Liest und validiert Kontext (<code>readContext</code>)</li> <li>Autorisiert den Callback (<code>authorizeCallback</code>)</li> <li>Handhabt Progress-Events (<code>handleProgressIfAny</code>)</li> <li>Entscheidet basierend auf Payload und Policies, welche Phasen tats\u00e4chlich ausgef\u00fchrt werden:</li> <li>Extract-Only (wenn Template &amp; Ingest deaktiviert)</li> <li>Voller Flow: Extract \u2192 Template \u2192 Ingest</li> <li>Skip-Varianten (z.B. Template-Skip wegen vorhandenem Frontmatter, Ingest-Skip wegen vorhandener Vektoren)</li> </ul> </li> </ul>"},{"location":"_analysis/pdf-transformation-phases-ist.html#2-phase-1-extract-ist","title":"2. Phase 1 \u2013 Extract (IST)","text":""},{"location":"_analysis/pdf-transformation-phases-ist.html#21-ablauf","title":"2.1 Ablauf","text":"<ol> <li>Worker \u2192 Start-Route </li> <li> <p>Worker (<code>ExternalJobsWorker</code>) ruft <code>POST /api/external/jobs/{jobId}/start</code> auf.</p> </li> <li> <p>Start-Route \u2013 Vorbereitung </p> </li> <li>L\u00e4dt Job-Dokument (<code>ExternalJobsRepository.get</code>).</li> <li>Startet Watchdog.</li> <li>L\u00e4dt PDF aus Storage (<code>getServerProvider(...).getBinary(src.itemId)</code>).</li> <li>F\u00fchrt <code>preprocess</code> aus (Span <code>preprocess</code> im Trace), um vorhandenes Markdown/Frontmatter zu erkennen.</li> <li> <p>Initialisiert Steps (<code>extract_pdf</code>, <code>transform_template</code>, <code>ingest_rag</code>) via <code>initializeSteps</code>.</p> </li> <li> <p>Extract-Entscheidung in der Start-Route </p> </li> <li>Liest Phase-Policies (<code>getPolicies</code>) und <code>job.parameters.phases</code>.</li> <li>Ruft <code>gateExtractPdf</code> auf (<code>src/lib/processing/gates.ts</code>), um vorhandene Shadow-Twins (Transcript/Transformed) zu erkennen.</li> <li>Kombiniert Gate + Policy mit <code>shouldRunExtract</code> zu <code>runExtract</code> / <code>runTemplate</code> / <code>runIngestOnly</code>.</li> <li> <p>Spezialf\u00e4lle:</p> <ul> <li>Ingest-only: Wenn <code>ingestEnabled</code> aber weder Extract noch Template laufen m\u00fcssen, l\u00e4dt die Start-Route direkt das bereits vorhandene transformierte Markdown aus dem Shadow-Twin und ruft <code>runIngestion</code> selbst auf (ohne Secretary-Request).</li> <li>Extract-skip: Wenn Gate+Policies sagen, dass Extraktion nicht n\u00f6tig ist, wird kein Request an den Secretary Service gesendet.</li> </ul> </li> <li> <p>Secretary-Request (nur wenn <code>runExtract</code> true) </p> </li> <li>Baut <code>FormData</code> mit PDF und Parametern, setzt <code>callback_url</code> und <code>callback_token</code>.</li> <li> <p>W\u00e4hlt Endpoint:</p> <ul> <li>Standard: <code>/api/pdf/process</code></li> <li>Mistral OCR: <code>/api/pdf/process-mistral-ocr</code> (mit <code>includeImages</code> / <code>includePageImages</code>).</li> </ul> </li> <li> <p>Secretary \u2192 Callback-Route </p> </li> <li> <p>Secretary sendet einen oder mehrere Callbacks an <code>/api/external/jobs/{jobId}</code> mit:</p> <ul> <li><code>data.extracted_text</code></li> <li>optional <code>pages_archive_url</code>, <code>pages_archive_data</code>, <code>images_archive_url</code>, <code>images_archive_data</code>, <code>mistral_ocr_raw_url</code>, <code>mistral_ocr_raw_metadata</code>, <code>mistral_ocr_raw</code>, <code>mistral_ocr_images_url</code>.</li> </ul> </li> <li> <p>Callback-Route \u2013 Extract-Verarbeitung </p> </li> <li>Extrahiert <code>extracted_text</code> und Bild-Archiv-Informationen.</li> <li>Markiert den Step <code>extract_pdf</code> als <code>completed</code>, sobald ein stabiles OCR-Ergebnis vorhanden ist.</li> <li>F\u00fchrt je nach Phasen-Flags drei Wege:<ul> <li>Extract-Only: <code>templatePhaseEnabled === false</code> und <code>ingestPhaseEnabled === false</code> \u2192 ruft <code>runExtractOnly</code> mit allen Bildquellen auf, speichert Transcript-Markdown OHNE Frontmatter und Bilder im Shadow-Twin, setzt Jobstatus auf <code>completed</code>.</li> <li>Normaler Flow: Setzt nur Extract-Step auf <code>completed</code> und \u00fcbergibt Ergebnisse an die weiteren Phasen.</li> <li>Noop: Wenn kein finales Payload (nur Heartbeats/Progress), macht nichts au\u00dfer Watchdog-Bump.</li> </ul> </li> </ol>"},{"location":"_analysis/pdf-transformation-phases-ist.html#22-relevante-dateien","title":"2.2 Relevante Dateien","text":"<ul> <li>Worker:</li> <li><code>src/lib/external-jobs-worker.ts</code> \u2013 findet Jobs und ruft Start-Route auf.</li> <li>Start-Route:</li> <li><code>src/app/api/external/jobs/[jobId]/start/route.ts</code> \u2013 initialisiert Job, f\u00fchrt Preprocess und Gate-Logik aus, ruft Secretary-Endpoints auf, enth\u00e4lt Ingest-only-Sonderpfad.</li> <li>Callback-Route:</li> <li><code>src/app/api/external/jobs/[jobId]/route.ts</code> \u2013 verarbeitet <code>extracted_text</code>, Markierung des Extract-Steps, Extract-Only Modus.</li> <li>Library-Module:</li> <li><code>src/lib/external-jobs/extract-only.ts</code> \u2013 Implementierung des Extract-Only Flows (Transcript speichern, Bilder verarbeiten, Job abschlie\u00dfen).</li> <li><code>src/lib/external-jobs/images.ts</code> \u2013 Bildverarbeitung aus allen Quellen (pages-Archive, images-Archive, Mistral OCR).</li> <li><code>src/lib/external-jobs/storage.ts</code> \u2013 Speichern von Markdown im Shadow-Twin/Parent.</li> <li><code>src/lib/processing/gates.ts</code> \u2013 <code>gateExtractPdf</code> zur Pr\u00fcfung vorhandener Shadow-Twins.</li> <li><code>src/lib/external-jobs/preprocess.ts</code> \u2013 Voranalyse vorhandener Artefakte (Markdown/Frontmatter).</li> </ul>"},{"location":"_analysis/pdf-transformation-phases-ist.html#3-phase-2-template-ist","title":"3. Phase 2 \u2013 Template (IST)","text":""},{"location":"_analysis/pdf-transformation-phases-ist.html#31-ablauf","title":"3.1 Ablauf","text":"<ol> <li>Trigger </li> <li> <p>Phase 2 wird nicht durch einen separaten HTTP-Endpoint gestartet, sondern immer innerhalb der Callback-Route (<code>POST /api/external/jobs/[jobId]</code>), nachdem Extract-Daten vorliegen (direkt oder \u00fcber Shadow-Twin).</p> </li> <li> <p>Preprocess &amp; Policies </p> </li> <li>In der Callback-Route wird (falls noch nicht geschehen) <code>preprocess</code> erneut ausgef\u00fchrt, um vorhandene Frontmatter-Qualit\u00e4t zu bewerten.</li> <li> <p>Policies f\u00fcr die Template-Phase werden \u00fcber <code>readPhasesAndPolicies</code> gelesen (Modul <code>src/lib/external-jobs/policies.ts</code>).</p> </li> <li> <p>Gate- und Entscheidungslogik </p> </li> <li>Frontmatter-Vollst\u00e4ndigkeit aus dem Callback-Body wird gepr\u00fcft (<code>body.data.metadata</code> mit <code>chapters</code> und <code>pages</code>).</li> <li><code>decideTemplateRun</code> (in <code>src/lib/external-jobs/template-decision.ts</code>) kombiniert:<ul> <li>Policies (<code>metadata: force/skip/auto/ignore</code>)</li> <li>Gate-Status (<code>gateTransformTemplate</code>)</li> <li>Preprocess-Ergebnis (Frontmatter g\u00fcltig/ung\u00fcltig)</li> <li>Callback-Phase (<code>phase === 'template_completed'</code>)</li> <li>Reparatur-Bedarf eines vorhandenen Shadow-Twins (unvollst\u00e4ndiges Frontmatter).</li> </ul> </li> <li> <p>Ergebnis: <code>shouldRunTemplate</code> + Begr\u00fcndung.</p> </li> <li> <p>Template-Transformation (falls <code>shouldRunTemplate</code> true) </p> </li> <li>Callback-Route:<ul> <li>W\u00e4hlt Template-Datei \u00fcber <code>pickTemplate</code> (<code>src/lib/external-jobs/template-files.ts</code>).</li> <li>Ruft <code>runTemplateTransform</code> auf (<code>src/lib/external-jobs/template-run.ts</code>).</li> </ul> </li> <li> <p><code>runTemplateTransform</code>:</p> <ul> <li>Baut Request an Secretary Template-Transformer (<code>/transformer/template</code>).</li> <li>Parst Response und normalisiert <code>structured_data</code> zu <code>Frontmatter</code>.</li> </ul> </li> <li> <p>Kapitel-Analyse &amp; Merge </p> </li> <li> <p>Callback-Route ruft <code>analyzeAndMergeChapters</code> (<code>src/lib/external-jobs/chapters.ts</code>) auf, um:</p> <ul> <li>Kapitel im Text zu analysieren.</li> <li>Bestehende Kapitel aus altem Frontmatter mit neuen zu mergen.</li> <li>Konsistente Kapitelbereiche (startPage/endPage/pageCount) herzustellen.</li> </ul> </li> <li> <p>Markdown mit Frontmatter speichern </p> </li> <li>Frontmatter wird mit SSOT-Feldern angereichert (job_id, source_file, template_status etc.).</li> <li><code>stripAllFrontmatter</code> entfernt alte Frontmatter-Bl\u00f6cke aus dem Text.</li> <li><code>createMarkdownWithFrontmatter</code> (aus <code>@/lib/markdown/compose</code>) erzeugt Markdown mit neuem Frontmatter.</li> <li><code>saveMarkdown</code> speichert <code>{baseName}.{lang}.md</code> im Shadow-Twin- oder Parent-Verzeichnis.</li> <li> <p>Step <code>transform_template</code> wird am Ende zuverl\u00e4ssig auf <code>completed</code>/<code>failed</code> gesetzt.</p> </li> <li> <p>Skip-F\u00e4lle </p> </li> <li>Wenn Template-Phase geskippt wird (z.B. vollst\u00e4ndiges Frontmatter im Body, oder Gate sagt \u201efrontmatter_complete\u201c):<ul> <li>Die Callback-Route \u00fcbernimmt direkt das bereits vorhandene Frontmatter (z.B. aus <code>body.data.metadata</code>) als Basis f\u00fcr Ingestion.</li> </ul> </li> </ol>"},{"location":"_analysis/pdf-transformation-phases-ist.html#32-relevante-dateien","title":"3.2 Relevante Dateien","text":"<ul> <li>Callback-Route:</li> <li><code>src/app/api/external/jobs/[jobId]/route.ts</code> \u2013 enth\u00e4lt gesamte Template-Orchestrierung.</li> <li>Library-Module:</li> <li><code>src/lib/external-jobs/template-run.ts</code> \u2013 HTTP-Aufruf des Template-Transformers, Parsing/Normalisierung der Antwort.</li> <li><code>src/lib/external-jobs/template-decision.ts</code> \u2013 Entscheidung, ob Template \u00fcberhaupt laufen soll (inkl. Reparaturf\u00e4lle).</li> <li><code>src/lib/external-jobs/chapters.ts</code> \u2013 Analyse/Merge von Kapiteln.</li> <li><code>src/lib/external-jobs/template-files.ts</code> \u2013 Auswahl des Template-Files.</li> <li><code>src/lib/processing/gates.ts</code> \u2013 <code>gateTransformTemplate</code> (Frontmatter bereits vollst\u00e4ndig?).</li> <li><code>src/lib/external-jobs/preprocess.ts</code> \u2013 Frontmatter-Qualit\u00e4t vor der Template-Phase.</li> <li><code>src/lib/external-jobs/storage.ts</code> \u2013 Speichern des transformierten Markdown.</li> </ul>"},{"location":"_analysis/pdf-transformation-phases-ist.html#4-phase-3-ingestion-ist","title":"4. Phase 3 \u2013 Ingestion (IST)","text":""},{"location":"_analysis/pdf-transformation-phases-ist.html#41-ablauf","title":"4.1 Ablauf","text":"<ol> <li>Trigger </li> <li>Phase 3 wird ebenfalls innerhalb der Callback-Route gestartet, nachdem:<ul> <li>Ein Shadow-Twin mit transformiertem Markdown existiert (entweder neu geschrieben oder wiederverwendet), und</li> <li>Die Template-Phase entweder erfolgreich war oder explizit \u00fcbersprungen wurde, aber ausreichende Metadaten vorliegen.</li> </ul> </li> <li> <p>Zus\u00e4tzlich existiert ein Ingest-only Pfad:</p> <ul> <li>In der Start-Route (<code>runIngestOnly</code>) ohne neuen Secretary-Request, wenn bereits ein transformiertes Shadow-Twin-Markdown existiert.</li> </ul> </li> <li> <p>Gate-Logik </p> </li> <li><code>gateIngestRag</code> (<code>src/lib/processing/gates.ts</code>) pr\u00fcft \u00fcber einen <code>ingestionCheck</code>-Callback, ob bereits Vektoren f\u00fcr diese Datei in der MongoDB Vector Search Collection existieren:<ul> <li>Verwendung von <code>loadLibraryChatContext</code> und MongoDB Query (Filter nach <code>kind: 'meta'</code>, <code>userEmail</code>, <code>libraryId</code>, <code>fileId</code>).</li> </ul> </li> <li> <p>Ergebnis:</p> <ul> <li>Wenn Vektoren schon existieren \u2192 Ingestion-Step als <code>completed</code> mit Details <code>{ skipped: true, reason: 'ingest_exists' }</code>.</li> </ul> </li> <li> <p>Policy-Entscheidung </p> </li> <li>In der Callback-Route werden zus\u00e4tzlich \u201eleichte\u201c Ingestion-Policies evaluiert:<ul> <li><code>ingestPolicy: 'do' | 'force' | 'skip'</code> plus Legacy-Flags (<code>doIngestRAG</code>, <code>phases.ingest</code>, <code>policies.ingest</code>).</li> </ul> </li> <li> <p>Daraus wird <code>useIngestion</code> abgeleitet.</p> </li> <li> <p>Markdown f\u00fcr Ingestion laden </p> </li> <li>Prim\u00e4rquelle: frisch erzeugtes transformiertes Markdown (Text im Callback oder soeben gespeicherte Datei).</li> <li> <p>Fallback: Laden der transformierten Datei <code>{baseName}.{lang}.md</code> aus Storage, falls <code>extractedText</code> nicht mehr vorliegt.</p> </li> <li> <p>Ingestion ausf\u00fchren </p> </li> <li><code>runIngestion</code> (<code>src/lib/external-jobs/ingest.ts</code>) ruft:<ul> <li><code>IngestionService.upsertMarkdown(userEmail, libraryId, fileId, fileName, markdown, meta, jobId)</code>    (in <code>src/lib/chat/ingestion-service.ts</code>)</li> </ul> </li> <li>Ergebnis:<ul> <li><code>chunksUpserted</code>, <code>docUpserted</code>, <code>index</code>.</li> </ul> </li> <li> <p>Die Callback-Route:</p> <ul> <li>Speichert Ingestion-Metadaten im Job (<code>setIngestion</code>).</li> <li>Aktualisiert Step <code>ingest_rag</code> auf <code>completed</code>.</li> </ul> </li> <li> <p>Job-Abschluss </p> </li> <li><code>setJobCompleted</code> (<code>src/lib/external-jobs/complete.ts</code>) setzt Jobstatus und Ergebnis.</li> <li>Shadow-Twin-State wird auf <code>processingStatus: 'ready'</code> gesetzt.</li> <li><code>JobEventBus</code> schickt ein final <code>job_update</code> Event inkl. <code>refreshFolderIds</code>.</li> </ol>"},{"location":"_analysis/pdf-transformation-phases-ist.html#42-relevante-dateien","title":"4.2 Relevante Dateien","text":"<ul> <li>Start-Route:</li> <li><code>src/app/api/external/jobs/[jobId]/start/route.ts</code> \u2013 Ingest-only Pfad (<code>runIngestOnly</code>) ohne Secretary-Request.</li> <li>Callback-Route:</li> <li><code>src/app/api/external/jobs/[jobId]/route.ts</code> \u2013 regul\u00e4re Ingestion nach Template-Phase.</li> <li>Library-Module:</li> <li><code>src/lib/external-jobs/ingest.ts</code> \u2013 Wrapper f\u00fcr RAG-Ingestion.</li> <li><code>src/lib/chat/ingestion-service.ts</code> \u2013 konkrete Upsert-Logik in MongoDB Vector Search.</li> <li><code>src/lib/repositories/vector-repo.ts</code> \u2013 MongoDB Vector Search Repository.</li> <li><code>src/lib/processing/gates.ts</code> \u2013 <code>gateIngestRag</code>.</li> <li><code>src/lib/external-jobs/complete.ts</code> \u2013 finaler Jobabschluss inkl. Events.</li> </ul>"},{"location":"_analysis/pdf-transformation-phases-ist.html#5-dokumentations-varianten-fur-pdf-transformation-phasesmd","title":"5. Dokumentations-Varianten f\u00fcr <code>pdf-transformation-phases.md</code>","text":""},{"location":"_analysis/pdf-transformation-phases-ist.html#variante-a-minimal-invasiv-empfohlen","title":"Variante A \u2013 Minimal-invasiv (empfohlen)","text":"<ul> <li>Behalte die bestehende Struktur (Phase 1/2/3) bei.</li> <li>Erg\u00e4nze pro Phase:</li> <li>Einen kurzen Unterpunkt \u201eExecution in Code (IST)\u201c mit:<ul> <li>Nennung der beteiligten Routen (Start/Callback).</li> <li>Hinweis auf Worker/Secretary.</li> <li>Liste der wichtigsten Module.</li> </ul> </li> <li>Erg\u00e4nze unter \u201eOverview\u201c eine kleine Tabelle \u201eWho does what?\u201c (Worker, Start-Route, Callback-Route, Secretary).</li> <li>Vorteil: Wenig \u00c4nderungen, Doku bleibt kompakt, aber realit\u00e4tsn\u00e4her.</li> </ul>"},{"location":"_analysis/pdf-transformation-phases-ist.html#variante-b-starkere-orchestrierungs-sektion","title":"Variante B \u2013 St\u00e4rkere Orchestrierungs-Sektion","text":"<ul> <li>Erg\u00e4nze oberhalb der Phasen eine neue Sektion \u201eRuntime Orchestration\u201c:</li> <li>Sequenzielle Beschreibung: Worker \u2192 Start-Route \u2192 Secretary \u2192 Callback-Route.</li> <li>Danach pro Phase nur noch die fachliche Sicht, aber mit Verweis auf diese neue Sektion.</li> <li>Vorteil: Klarer Unterschied zwischen fachlicher Phase (Konzept) und technischer Ausf\u00fchrung (Routen/Module).</li> <li>Nachteil: Etwas mehr Text, zwei Stellen zu pflegen (Orchestrierung + Phasen).</li> </ul>"},{"location":"_analysis/pdf-transformation-phases-ist.html#variante-c-aufsplitten-in-mehrere-dokumente","title":"Variante C \u2013 Aufsplitten in mehrere Dokumente","text":"<ul> <li>Lasse <code>pdf-transformation-phases.md</code> bewusst fachlich.</li> <li>Erstelle separate Datei(en) unter <code>docs/architecture/phases/*</code> mit rein technischer Sicht:</li> <li><code>phase-1-extract.md</code>, <code>phase-2-template.md</code>, <code>phase-3-ingest.md</code>, <code>overview.md</code>.</li> <li>Vorteil: Sehr klare Trennung von Dom\u00e4nen- vs. Implementierungswissen.</li> <li>Nachteil: Mehr Streuung, h\u00f6herer Pflegeaufwand, aktuell overkill.</li> </ul>"},{"location":"_analysis/pdf-transformation-phases-ist.html#6-gewahlte-variante-fur-das-nachste-update","title":"6. Gew\u00e4hlte Variante f\u00fcr das n\u00e4chste Update","text":"<p>F\u00fcr das unmittelbare Update von <code>docs/architecture/pdf-transformation-phases.md</code> w\u00e4hle ich Variante A (minimal-invasiv):</p> <ul> <li>Erg\u00e4nzung einer kompakten Orchestrierungs-\u00dcbersicht in der Overview.</li> <li>Pro Phase:</li> <li>Erweiterung der bestehenden \u201eCode References\u201c um:<ul> <li>Start-Route / Callback-Route.</li> <li>Worker (f\u00fcr Phase 1) und Secretary Service als externe Partei.</li> </ul> </li> <li>Ein kurzer Absatz \u201eExecution in Code (IST)\u201c, der die reale Abarbeitung beschreibt, ohne in Implementierungsdetails abzudriften.</li> </ul> <p>Die folgenden \u00c4nderungen an <code>pdf-transformation-phases.md</code> orientieren sich genau an diesem Plan.</p>"},{"location":"_analysis/story-mode-initial-load-analysis.html","title":"Analyse: Story-Mode Erstladung","text":""},{"location":"_analysis/story-mode-initial-load-analysis.html#ubersicht","title":"\u00dcbersicht","text":"<p>Analyse der Erstladung im Story-Mode (<code>/explore/[slug]?mode=story&amp;lang=it</code>) mit Fokus auf Console-Logs und m\u00f6gliche fehlerhafte Logik.</p>"},{"location":"_analysis/story-mode-initial-load-analysis.html#identifizierte-probleme","title":"Identifizierte Probleme","text":""},{"location":"_analysis/story-mode-initial-load-analysis.html#1-mehrfache-cache-checks-durch-konkurrierende-useeffects","title":"1. Mehrfache Cache-Checks durch konkurrierende useEffects","text":"<p>Problem: Es gibt 3 verschiedene <code>useEffect</code>-Hooks, die alle Cache-Checks ausl\u00f6sen k\u00f6nnen:</p>"},{"location":"_analysis/story-mode-initial-load-analysis.html#useeffect-1-parameter-anderungen-zeile-358-404","title":"useEffect #1: Parameter-\u00c4nderungen (Zeile 358-404)","text":"<pre><code>useEffect(() =&gt; {\n  if (!cfg) return\n  if (!isEmbedded) return\n  if (perspectiveOpen) return\n  if (isSending) return\n  // ... weitere Bedingungen ...\n  checkTOCCache()\n}, [cfg, isEmbedded, perspectiveOpen, isSending, galleryFilters, targetLanguage, character, socialContext, genderInclusive, messages])\n</code></pre>"},{"location":"_analysis/story-mode-initial-load-analysis.html#useeffect-2-automatische-generierung-zeile-408-440","title":"useEffect #2: Automatische Generierung (Zeile 408-440)","text":"<pre><code>useEffect(() =&gt; {\n  if (!isEmbedded) return\n  if (isSending || isCheckingTOC || isGeneratingTOC) return\n  // ... pr\u00fcft ob Cache vorhanden ...\n  generateTOC()\n}, [cachedStoryTopicsData, cachedTOC, isCheckingTOC, isEmbedded, sendQuestion, isSending, isGeneratingTOC, processingSteps])\n</code></pre>"},{"location":"_analysis/story-mode-initial-load-analysis.html#useeffect-3-sendquestion-verfugbar-zeile-445-471","title":"useEffect #3: sendQuestion verf\u00fcgbar (Zeile 445-471)","text":"<pre><code>useEffect(() =&gt; {\n  if (!cfg || !isEmbedded) return\n  if (perspectiveOpen) return\n  if (cachedStoryTopicsData || cachedTOC) return\n  if (hasCheckedCacheRef.current) return\n  // ... pr\u00fcft ob sendQuestion von undefined zu definiert gewechselt ist ...\n  checkTOCCache()\n}, [sendQuestion, cfg, isEmbedded, perspectiveOpen, cachedStoryTopicsData, cachedTOC, checkTOCCache])\n</code></pre> <p>Risiko: Race Conditions, mehrfache Cache-Checks, inkonsistente States</p>"},{"location":"_analysis/story-mode-initial-load-analysis.html#2-fehlende-synchronisation-zwischen-refs","title":"2. Fehlende Synchronisation zwischen Refs","text":"<p>Problem: Mehrere Refs werden in verschiedenen useEffects verwendet, ohne klare Synchronisation:</p> <ul> <li><code>hasCheckedCacheRef</code> - wird in useEffect #1 und #3 verwendet</li> <li><code>shouldAutoGenerateRef</code> - wird in useEffect #1 und #2 verwendet</li> <li><code>lastFiltersRef</code> / <code>lastParamsRef</code> - nur in useEffect #1 verwendet</li> </ul> <p>Risiko: Inkonsistente States, wenn mehrere useEffects gleichzeitig laufen</p>"},{"location":"_analysis/story-mode-initial-load-analysis.html#3-fehlende-debug-logs-fur-kritische-entscheidungen","title":"3. Fehlende Debug-Logs f\u00fcr kritische Entscheidungen","text":"<p>Problem: Keine Logs f\u00fcr: - Welcher useEffect wird ausgel\u00f6st und warum? - Warum wird ein Cache-Check \u00fcbersprungen? - Warum wird eine Generierung gestartet/\u00fcbersprungen? - Race Condition Detection</p> <p>Empfehlung: Strategische Logs hinzuf\u00fcgen f\u00fcr: <pre><code>console.log('[ChatPanel] useEffect #1 triggered', { cfg, isEmbedded, perspectiveOpen, isSending, hasNormalQuestions })\nconsole.log('[ChatPanel] useEffect #2 triggered', { cachedStoryTopicsData, cachedTOC, isCheckingTOC, shouldAutoGenerateRef.current })\nconsole.log('[ChatPanel] useEffect #3 triggered', { sendQuestion, hasCheckedCacheRef.current })\n</code></pre></p>"},{"location":"_analysis/story-mode-initial-load-analysis.html#4-komplexe-bedingungslogik-schwer-nachvollziehbar","title":"4. Komplexe Bedingungslogik schwer nachvollziehbar","text":"<p>Problem: Die Bedingungen f\u00fcr Cache-Checks sind sehr komplex:</p> <pre><code>// Beispiel aus useEffect #1:\nconst hasNormalQuestions = messages.some(\n  (msg) =&gt; msg.type === 'question' &amp;&amp; msg.content.trim() !== TOC_QUESTION.trim()\n)\nif (hasNormalQuestions) {\n  return // Benutzer hat bereits normale Fragen gestellt, kein Cache-Check f\u00fcr TOC n\u00f6tig\n}\n\n// Pr\u00fcfe, ob sich Filter oder Parameter ge\u00e4ndert haben\nconst filtersChanged = lastFiltersRef.current !== currentFiltersKey\nconst paramsChanged = lastParamsRef.current !== currentParamsKey\n\n// Wenn sich Filter oder Parameter ge\u00e4ndert haben, setze hasCheckedCacheRef zur\u00fcck\nif (filtersChanged || paramsChanged) {\n  hasCheckedCacheRef.current = false\n  // ...\n}\n\n// Wenn bereits gepr\u00fcft wurde und sich nichts ge\u00e4ndert hat, \u00fcberspringe\nif (hasCheckedCacheRef.current &amp;&amp; !filtersChanged &amp;&amp; !paramsChanged) {\n  return\n}\n</code></pre> <p>Risiko: Schwer zu debuggen, wenn etwas nicht funktioniert</p>"},{"location":"_analysis/story-mode-initial-load-analysis.html#5-timeout-basierte-state-updates-konnen-race-conditions-verursachen","title":"5. Timeout-basierte State-Updates k\u00f6nnen Race Conditions verursachen","text":"<p>Problem: In <code>use-chat-toc.ts</code> wird <code>isCheckingTOC</code> mit einem Timeout zur\u00fcckgesetzt:</p> <pre><code>finally {\n  setTimeout(() =&gt; {\n    isCheckingTOCRef.current = false\n    setIsCheckingTOC(false)\n  }, 100)\n}\n</code></pre> <p>Risiko: Wenn w\u00e4hrend des Timeouts ein neuer Cache-Check startet, kann der State inkonsistent werden</p>"},{"location":"_analysis/story-mode-initial-load-analysis.html#6-fehlende-validierung-cache-check-vs-generierung","title":"6. Fehlende Validierung: Cache-Check vs. Generierung","text":"<p>Problem: Es gibt keine explizite Validierung, ob ein Cache-Check abgeschlossen ist, bevor eine Generierung startet. Die Pr\u00fcfung basiert nur auf <code>isCheckingTOC</code> und <code>processingSteps</code>.</p> <p>Risiko: Generierung k\u00f6nnte starten, w\u00e4hrend Cache-Check noch l\u00e4uft</p>"},{"location":"_analysis/story-mode-initial-load-analysis.html#empfohlene-verbesserungen","title":"Empfohlene Verbesserungen","text":""},{"location":"_analysis/story-mode-initial-load-analysis.html#1-konsolidierung-der-cache-check-logik","title":"1. Konsolidierung der Cache-Check-Logik","text":"<p>Vorschlag: Ein zentraler <code>useEffect</code> f\u00fcr Cache-Checks, der alle Bedingungen pr\u00fcft:</p> <pre><code>useEffect(() =&gt; {\n  // Zentrale Logik f\u00fcr Cache-Check\n  // Alle Bedingungen an einem Ort\n  // Klare Priorisierung\n}, [/* alle relevanten Dependencies */])\n</code></pre>"},{"location":"_analysis/story-mode-initial-load-analysis.html#2-state-machine-fur-toc-loading","title":"2. State Machine f\u00fcr TOC-Loading","text":"<p>Vorschlag: Klarer State-Machine f\u00fcr TOC-Loading:</p> <pre><code>type TOCState = \n  | 'idle'\n  | 'checking_cache'\n  | 'cache_found'\n  | 'generating'\n  | 'generated'\n  | 'error'\n</code></pre>"},{"location":"_analysis/story-mode-initial-load-analysis.html#3-strategische-debug-logs-hinzufugen","title":"3. Strategische Debug-Logs hinzuf\u00fcgen","text":"<p>Vorschlag: Logs f\u00fcr kritische Entscheidungspunkte:</p> <pre><code>console.log('[ChatPanel] Cache-Check Entscheidung:', {\n  shouldCheck: /* Bedingung */,\n  reason: /* Warum wird gepr\u00fcft/\u00fcbersprungen */,\n  currentState: { hasCheckedCacheRef, shouldAutoGenerateRef, isCheckingTOC }\n})\n</code></pre>"},{"location":"_analysis/story-mode-initial-load-analysis.html#4-race-condition-prevention","title":"4. Race Condition Prevention","text":"<p>Vorschlag: Explizite Guards gegen Race Conditions:</p> <pre><code>const checkInProgressRef = useRef(false)\n\nif (checkInProgressRef.current) {\n  console.warn('[ChatPanel] Cache-Check bereits in Progress, \u00fcberspringe')\n  return\n}\ncheckInProgressRef.current = true\n// ... Cache-Check ...\ncheckInProgressRef.current = false\n</code></pre>"},{"location":"_analysis/story-mode-initial-load-analysis.html#bestehende-console-logs-analyse","title":"Bestehende Console-Logs Analyse","text":""},{"location":"_analysis/story-mode-initial-load-analysis.html#sinnvolle-logs-behalten","title":"Sinnvolle Logs (behalten):","text":"<ol> <li><code>[GalleryRoot] initialDetailViewType</code> (Zeile 70)</li> <li>\u2705 Zeigt Library-Config und resultierenden viewType</li> <li> <p>\u2705 Hilfreich f\u00fcr Debugging von viewType-Problemen</p> </li> <li> <p><code>[StoryContext] Lade ... aus localStorage</code> (Zeile 84)</p> </li> <li>\u2705 Zeigt, welche Werte aus localStorage geladen werden</li> <li> <p>\u2705 Hilfreich f\u00fcr Debugging von Persistenz-Problemen</p> </li> <li> <p><code>[useChatTOC] Generierung abgebrochen oder fehlgeschlagen</code> (Zeile 127)</p> </li> <li>\u2705 Zeigt, wenn Generierung fehlschl\u00e4gt</li> <li>\u2705 Wichtig f\u00fcr Fehlerdiagnose</li> </ol>"},{"location":"_analysis/story-mode-initial-load-analysis.html#fehlende-logs-hinzufugen","title":"Fehlende Logs (hinzuf\u00fcgen):","text":"<ol> <li> <p>Cache-Check Start/Ende <pre><code>console.log('[ChatPanel] Cache-Check gestartet', { libraryId, targetLanguage, character, socialContext })\nconsole.log('[ChatPanel] Cache-Check abgeschlossen', { found: result?.found, queryId: result?.queryId })\n</code></pre></p> </li> <li> <p>useEffect Trigger <pre><code>console.log('[ChatPanel] useEffect #1 triggered', { reason: 'parameter-change', ... })\nconsole.log('[ChatPanel] useEffect #2 triggered', { reason: 'auto-generate', ... })\nconsole.log('[ChatPanel] useEffect #3 triggered', { reason: 'sendQuestion-available', ... })\n</code></pre></p> </li> <li> <p>Race Condition Detection <pre><code>if (isCheckingTOCRef.current &amp;&amp; /* neuer Check startet */) {\n  console.warn('[ChatPanel] \u26a0\ufe0f Race Condition: Cache-Check bereits in Progress')\n}\n</code></pre></p> </li> </ol>"},{"location":"_analysis/story-mode-initial-load-analysis.html#fazit","title":"Fazit","text":"<p>Die aktuelle Implementierung funktioniert, ist aber schwer zu debuggen aufgrund: - Mehrfacher useEffects mit \u00e4hnlicher Logik - Fehlender Debug-Logs f\u00fcr kritische Entscheidungen - Komplexer Bedingungslogik - Potenzielle Race Conditions</p> <p>Empfehlung: Strategische Logs hinzuf\u00fcgen, um die Logik nachvollziehbar zu machen, ohne die bestehende Funktionalit\u00e4t zu \u00e4ndern.</p>"},{"location":"_analysis/terminal-logs-analysis.html","title":"Analyse: Terminal-Logs Sinnhaftigkeit","text":""},{"location":"_analysis/terminal-logs-analysis.html#ubersicht","title":"\u00dcbersicht","text":"<p>Analyse der Server-seitigen Terminal-Logs auf Sinnhaftigkeit und Verbesserungspotenzial.</p>"},{"location":"_analysis/terminal-logs-analysis.html#aktuelle-logs-im-terminal","title":"Aktuelle Logs im Terminal","text":""},{"location":"_analysis/terminal-logs-analysis.html#1-middleware-logs","title":"1. Middleware-Logs","text":"<p>Zeile 3-4: <pre><code>[MIDDLEWARE] \ud83d\ude80 Middleware wird geladen - 2025-11-14T16:32:04.473Z\n[MIDDLEWARE] \ud83d\udd27 Public routes configured: [ '/', '/docs(.*)', '/explore(.*)', '/api/public(.*)' ]\n</code></pre></p> <p>Bewertung: - \u274c Zu verbose - Wird bei jedem Server-Start geloggt - \u274c Nicht operationell wichtig - Nur f\u00fcr Initial-Debugging n\u00fctzlich - \u2705 Empfehlung: Entfernen oder nur in Development-Modus loggen</p> <p>Code-Stelle: <code>src/middleware.ts</code> Zeile 30, 41</p>"},{"location":"_analysis/terminal-logs-analysis.html#2-toc-cache-logs","title":"2. TOC-Cache Logs","text":"<p>Zeile 23-30 (Erfolgreicher Cache-Fund): <pre><code>[toc-cache] \u2705 Query gefunden: {\n  queryId: 'aea7b1a9-a75d-473e-a557-c2d38a5df39d',\n  retriever: 'summary',\n  status: 'ok',\n  hasAnswer: true,\n  hasStoryTopicsData: true,\n  answerLength: 2798\n}\n</code></pre></p> <p>Bewertung: - \u26a0\ufe0f Teilweise sinnvoll - Erfolgreiche Cache-Funde sind operationell wichtig - \u274c Zu verbose - Wird bei jedem Cache-Hit geloggt - \u2705 Empfehlung: Reduzieren auf wichtige Informationen oder nur bei Fehlern loggen</p> <p>Code-Stelle: <code>src/app/api/chat/[libraryId]/toc-cache/route.ts</code> Zeile 106-113</p> <p>Zeile 89-100 (Keine Query gefunden): <pre><code>[toc-cache] Keine Query gefunden f\u00fcr: { ... }\n</code></pre></p> <p>Bewertung: - \u274c Zu verbose - Wird bei jedem Cache-Miss geloggt (normaler Fall) - \u274c Nicht operationell wichtig - Cache-Misses sind erwartetes Verhalten - \u2705 Empfehlung: Entfernen oder nur bei unerwarteten Situationen loggen</p> <p>Code-Stelle: <code>src/app/api/chat/[libraryId]/toc-cache/route.ts</code> Zeile 89-100</p> <p>Zeile 134-140 (Query gefunden, aber keine Daten): <pre><code>[toc-cache] \u26a0\ufe0f Query gefunden, aber keine Daten: { ... }\n</code></pre></p> <p>Bewertung: - \u2705 Sinnvoll - Zeigt potenzielle Dateninkonsistenzen - \u2705 Behalten - Wichtig f\u00fcr Debugging von Datenproblemen</p>"},{"location":"_analysis/terminal-logs-analysis.html#3-auth-failed-logs","title":"3. Auth Failed Logs","text":"<p>Zeile 32: <pre><code>[MIDDLEWARE] Auth failed for /api/chat/97eee164-e3d0-4986-9024-01ea03a74b12/queries/aea7b1a9-a75d-473e-a557-c2d38a5df39d { name: 'Error', message: 'NEXT_HTTP_ERROR_FALLBACK;404' }\n</code></pre></p> <p>Bewertung: - \u26a0\ufe0f Teilweise sinnvoll - 404-Fehler bei anonymen Nutzern sind normal - \u274c Zu verbose - Wird bei jedem 404 geloggt (normales Verhalten) - \u2705 Empfehlung: Nur bei unerwarteten Auth-Fehlern loggen (nicht bei 404)</p> <p>Code-Stelle: <code>src/middleware.ts</code> Zeile 164</p>"},{"location":"_analysis/terminal-logs-analysis.html#4-mongodb-verbindungen","title":"4. MongoDB-Verbindungen","text":"<p>Zeile 11, 15, 21, 22, 35: <pre><code>Verbindung zu MongoDB wird hergestellt... (Datenbank: common-knowledge-scout)\n</code></pre></p> <p>Bewertung: - \u2705 Standard Next.js/MongoDB Logs - Nicht von uns kontrolliert - \u2705 Sinnvoll - Zeigt Datenbankverbindungen - \u2705 Keine \u00c4nderung n\u00f6tig</p>"},{"location":"_analysis/terminal-logs-analysis.html#5-compilation-logs","title":"5. Compilation-Logs","text":"<p>Zeile 1-2, 5-7, 9-10, 13-14, 20, 33-34: <pre><code>\u25cb Compiling /middleware ...\n\u2713 Compiled /middleware in 514ms (231 modules)\n</code></pre></p> <p>Bewertung: - \u2705 Standard Next.js Logs - Nicht von uns kontrolliert - \u2705 Sinnvoll - Zeigt Build-Prozess - \u2705 Keine \u00c4nderung n\u00f6tig</p>"},{"location":"_analysis/terminal-logs-analysis.html#6-http-request-logs","title":"6. HTTP-Request-Logs","text":"<p>Zeile 8, 12, 16-18, 22, 31, 36-37: <pre><code>GET /explore/sfscon?mode=story&amp;lang=it 200 in 7156ms\nGET /api/public/libraries/sfscon 200 in 3383ms\n</code></pre></p> <p>Bewertung: - \u2705 Standard Next.js Logs - Nicht von uns kontrolliert - \u2705 Sinnvoll - Zeigt Request-Performance - \u2705 Keine \u00c4nderung n\u00f6tig</p>"},{"location":"_analysis/terminal-logs-analysis.html#empfohlene-anderungen","title":"Empfohlene \u00c4nderungen","text":""},{"location":"_analysis/terminal-logs-analysis.html#1-middleware-logs-reduzieren","title":"1. Middleware-Logs reduzieren","text":"<p>Aktuell: <pre><code>console.log(`[MIDDLEWARE] \ud83d\ude80 Middleware wird geladen - ${new Date().toISOString()}`);\nconsole.log(`[MIDDLEWARE] \ud83d\udd27 Public routes configured:`, [...]);\n</code></pre></p> <p>Empfehlung: <pre><code>// Nur in Development-Modus loggen\nif (process.env.NODE_ENV === 'development') {\n  console.log(`[MIDDLEWARE] \ud83d\ude80 Middleware wird geladen - ${new Date().toISOString()}`);\n  console.log(`[MIDDLEWARE] \ud83d\udd27 Public routes configured:`, [...]);\n}\n</code></pre></p>"},{"location":"_analysis/terminal-logs-analysis.html#2-toc-cache-logs-optimieren","title":"2. TOC-Cache Logs optimieren","text":"<p>Aktuell: - Loggt bei jedem Cache-Hit (zu verbose) - Loggt bei jedem Cache-Miss (zu verbose)</p> <p>Empfehlung: - Erfolgreiche Cache-Funde: Reduzieren auf wichtige Infos oder nur in Development - Cache-Misses: Entfernen (normales Verhalten) - Query ohne Daten: Behalten (zeigt Probleme)</p>"},{"location":"_analysis/terminal-logs-analysis.html#3-auth-failed-logs-optimieren","title":"3. Auth Failed Logs optimieren","text":"<p>Aktuell: <pre><code>console.error(`[MIDDLEWARE] Auth failed for ${req.nextUrl.pathname}`, {...});\n</code></pre></p> <p>Empfehlung: <pre><code>// Nur bei echten Auth-Fehlern loggen, nicht bei 404\nif (error.message !== 'NEXT_HTTP_ERROR_FALLBACK;404') {\n  console.error(`[MIDDLEWARE] Auth failed for ${req.nextUrl.pathname}`, {...});\n}\n</code></pre></p>"},{"location":"_analysis/terminal-logs-analysis.html#zusammenfassung","title":"Zusammenfassung","text":""},{"location":"_analysis/terminal-logs-analysis.html#zu-verbose-reduzierenentfernen","title":"Zu verbose (reduzieren/entfernen):","text":"<ol> <li>\u2705 Middleware Startup-Logs (nur Development)</li> <li>\u2705 TOC-Cache \"Keine Query gefunden\" (entfernen)</li> <li>\u2705 TOC-Cache erfolgreiche Funde (reduzieren)</li> <li>\u2705 Auth failed bei 404 (filtern)</li> </ol>"},{"location":"_analysis/terminal-logs-analysis.html#sinnvoll-behalten","title":"Sinnvoll (behalten):","text":"<ol> <li>\u2705 TOC-Cache \"Query ohne Daten\" (zeigt Probleme)</li> <li>\u2705 MongoDB-Verbindungen (Standard-Logs)</li> <li>\u2705 Compilation-Logs (Standard-Logs)</li> <li>\u2705 HTTP-Request-Logs (Standard-Logs)</li> </ol>"},{"location":"_analysis/terminal-logs-analysis.html#prioritat","title":"Priorit\u00e4t:","text":"<ul> <li>Hoch: Middleware-Logs reduzieren (bei jedem Start)</li> <li>Mittel: TOC-Cache \"Keine Query gefunden\" entfernen (bei jedem Cache-Miss)</li> <li>Niedrig: TOC-Cache erfolgreiche Funde reduzieren (nur bei Cache-Hits)</li> </ul>"},{"location":"_analysis/unused-code-analysis.html","title":"Unused and Redundant Code Analysis","text":"<p>Analysis of potentially unused or redundant files in the codebase, based on import analysis and codebase search.</p> <p>Analysis Date: 2025-01-XX Total Files Analyzed: ~424 files</p>"},{"location":"_analysis/unused-code-analysis.html#summary","title":"Summary","text":"<ul> <li>\u2705 Removed: 7 files (Test/Development files, redundant wrappers, unused atoms, redundant toast hook)</li> <li>\u26a0\ufe0f Legacy/Deprecated: 2 files (Azure Storage - optional, still used in ingestion-service.ts)</li> <li>\u2705 Resolved: PDF defaults are NOT redundant (different purposes)</li> <li>\ud83d\udd0d Needs Review: 10+ files (Low import count, potential consolidation)</li> </ul>"},{"location":"_analysis/unused-code-analysis.html#confirmed-unused-files-safe-to-remove","title":"\ud83d\udd34 Confirmed Unused Files (Safe to Remove)","text":""},{"location":"_analysis/unused-code-analysis.html#testdevelopment-files","title":"Test/Development Files","text":"File Path Type Reason Import Count <code>src/app/api/auth-test/route.ts</code> Test API Test endpoint, not used in production 0 <code>src/app/api/teststorage/route.ts</code> Test API Test endpoint, not used in production 0 <code>src/app/api/env-test/route.ts</code> Test API Test endpoint, only imports test-env 1 <code>src/lib/test-env.ts</code> Test Utility Only used by env-test route 1 <code>src/lib/debug/wdyr.ts</code> Dev Tool Why Did You Render - development only 1 <p>Action: Remove all test/development files listed above.</p>"},{"location":"_analysis/unused-code-analysis.html#redundant-files-duplicate-functionality","title":"\ud83d\udfe1 Redundant Files (Duplicate Functionality)","text":""},{"location":"_analysis/unused-code-analysis.html#debug-footer-wrappers","title":"Debug Footer Wrappers","text":"File Path Problem Solution <code>src/components/debug/debug-footer-client.tsx</code> Both files wrap <code>debug-footer.tsx</code> identically with SSR disabled Remove one (keep <code>debug-footer-wrapper.tsx</code>) <code>src/components/debug/debug-footer-wrapper.tsx</code> Both files wrap <code>debug-footer.tsx</code> identically with SSR disabled Keep this one <p>Action: Remove <code>debug-footer-client.tsx</code>, keep <code>debug-footer-wrapper.tsx</code>.</p>"},{"location":"_analysis/unused-code-analysis.html#legacy-atoms-file","title":"Legacy Atoms File","text":"File Path Problem Solution <code>src/lib/atoms/library.ts</code> Never imported (0 imports found) Remove - functionality moved to <code>src/atoms/library-atom.ts</code> <code>src/atoms/library-atom.ts</code> Active file for library state Keep <p>Action: Remove <code>src/lib/atoms/library.ts</code>.</p>"},{"location":"_analysis/unused-code-analysis.html#legacydeprecated-files-needs-evaluation","title":"\ud83d\udfe1 Legacy/Deprecated Files (Needs Evaluation)","text":""},{"location":"_analysis/unused-code-analysis.html#azure-storage-service","title":"Azure Storage Service","text":"File Path Status Usage Recommendation <code>src/lib/services/azure-storage-service.ts</code> Legacy 1 import (ingestion-service.ts) Evaluate: If Azure Storage is deprecated in favor of Nextcloud, archive these files <code>src/lib/config/azure-storage.ts</code> Legacy 2 imports (azure-storage-service, ingestion-service) Evaluate: Check if still needed for existing deployments <p>Note: According to README.md, Azure Storage was replaced by Nextcloud (in development). However, these files may still be needed for existing deployments.</p> <p>Action:  1. Check if Azure Storage is still configured in any libraries 2. If not, archive these files 3. If yes, keep until migration is complete</p>"},{"location":"_analysis/unused-code-analysis.html#potential-redundancy-needs-review","title":"\ud83d\udfe1 Potential Redundancy (Needs Review)","text":""},{"location":"_analysis/unused-code-analysis.html#pdf-defaults","title":"PDF Defaults","text":"File Path Location Usage <code>src/lib/pdf-defaults.ts</code> Library code To be verified <code>src/atoms/pdf-defaults.ts</code> Atoms To be verified <p>Action: Review if both files serve different purposes or can be consolidated.</p>"},{"location":"_analysis/unused-code-analysis.html#resolved-not-redundant","title":"\u2705 Resolved: Not Redundant","text":""},{"location":"_analysis/unused-code-analysis.html#pdf-defaults_1","title":"PDF Defaults","text":"File Path Purpose Status <code>src/lib/pdf-defaults.ts</code> Persistent defaults in localStorage Keep - Different purpose <code>src/atoms/pdf-defaults.ts</code> Runtime overrides in Jotai atoms Keep - Different purpose <p>Conclusion: These files serve different purposes and are both needed.</p>"},{"location":"_analysis/unused-code-analysis.html#toast-hooks-redundancy","title":"\ud83d\udfe1 Toast Hooks Redundancy","text":"File Path Usage Difference Recommendation <code>src/components/ui/use-toast.ts</code> 11 imports Uses <code>Number.MAX_VALUE</code> Keep - Standard ShadCN version <code>src/hooks/use-toast.ts</code> 1 import Uses <code>Number.MAX_SAFE_INTEGER</code> Replace - Update import in <code>template-management.tsx</code> <p>Action:  1. Update <code>src/components/templates/template-management.tsx</code> to use <code>@/components/ui/use-toast</code> instead of <code>@/hooks/use-toast</code> 2. Remove <code>src/hooks/use-toast.ts</code> after verification</p>"},{"location":"_analysis/unused-code-analysis.html#low-usage-files-needs-verification","title":"\ud83d\udfe2 Low Usage Files (Needs Verification)","text":"<p>These files have low import counts and should be verified:</p> File Path Import Count Notes <code>src/lib/external-jobs/template-files.ts</code> 4 Used in template management <code>src/lib/library/favorites.ts</code> 2 Used in breadcrumb and library components <code>src/lib/templates/placeholders.ts</code> 1 Used in template-files <code>src/lib/ingestion/page-split.ts</code> 1 Used in ingestion service <code>src/lib/session/session-utils.ts</code> 3 Used in chat components <code>src/lib/markdown/compose.ts</code> Unknown Needs verification <code>src/lib/pdfjs-worker-setup.ts</code> Unknown Needs verification <code>src/lib/chat/debug-stats.ts</code> Unknown Needs verification <code>src/lib/chat/metadata-extractor.ts</code> Unknown Needs verification <code>src/lib/chat/embeddings.ts</code> Unknown Needs verification <code>src/lib/chat/common/budget.ts</code> Unknown Needs verification <code>src/lib/chat/common/toc-parser.ts</code> Unknown Needs verification <code>src/lib/secretary/constants.ts</code> Unknown Needs verification <code>src/atoms/create-library-atom.ts</code> Unknown Needs verification <code>src/atoms/template-atom.ts</code> Unknown Needs verification <code>src/atoms/combined-chat-atom.ts</code> Unknown Needs verification <code>src/hooks/use-selected-file.ts</code> Unknown Needs verification <code>src/hooks/use-transcription-twins.ts</code> Unknown Needs verification <p>Action: Verify each file's usage before removal.</p>"},{"location":"_analysis/unused-code-analysis.html#recommended-cleanup-order","title":"Recommended Cleanup Order","text":""},{"location":"_analysis/unused-code-analysis.html#phase-1-safe-removals-completed","title":"Phase 1: Safe Removals \u2705 COMPLETED","text":"<ol> <li>\u2705 Removed test API routes (<code>auth-test</code>, <code>teststorage</code>, <code>env-test</code>)</li> <li>\u2705 Removed test utility (<code>test-env.ts</code>)</li> <li>\u2705 Removed redundant debug wrapper (<code>debug-footer-client.tsx</code>)</li> <li>\u2705 Removed unused atoms file (<code>src/lib/atoms/library.ts</code>)</li> </ol>"},{"location":"_analysis/unused-code-analysis.html#phase-2-toast-hook-consolidation-completed","title":"Phase 2: Toast Hook Consolidation \u2705 COMPLETED","text":"<ol> <li>\u2705 Updated <code>template-management.tsx</code> to use <code>@/components/ui/use-toast</code></li> <li>\u2705 Removed <code>src/hooks/use-toast.ts</code></li> </ol>"},{"location":"_analysis/unused-code-analysis.html#phase-3-evaluation-required","title":"Phase 3: Evaluation Required","text":"<ol> <li>\u26a0\ufe0f Evaluate Azure Storage files (check if still needed)</li> </ol>"},{"location":"_analysis/unused-code-analysis.html#phase-4-verification-required","title":"Phase 4: Verification Required","text":"<ol> <li>\ud83d\udd0d Verify low-usage files before removal</li> <li>\ud83d\udd0d Check for commented-out code that can be removed</li> <li>\ud83d\udd0d Review deprecated API routes</li> </ol>"},{"location":"_analysis/unused-code-analysis.html#notes","title":"Notes","text":"<ul> <li>All removals should be tested to ensure no runtime errors</li> <li>Files marked as \"Legacy\" should be archived rather than deleted if they might be needed for existing deployments</li> <li>Low-usage files may still be critical for specific features - verify before removal</li> </ul>"},{"location":"_analysis/unused-components-explore.html","title":"Unused Components &amp; Shadow Pages Analysis","text":"<p>Date: 2025-01-XX Status: Complete Analysis</p>"},{"location":"_analysis/unused-components-explore.html#summary","title":"Summary","text":"<ul> <li>Total Components Analyzed: ~431 files with imports</li> <li>Chat Components: 24 components + 5 hooks + 2 utils</li> <li>Shared Components: 9 components</li> <li>Pages: 27 page.tsx files</li> <li>Backup Files: 1 file identified</li> <li>Shadow Pages: 1 potential shadow page identified</li> </ul>"},{"location":"_analysis/unused-components-explore.html#components-analysis","title":"Components Analysis","text":""},{"location":"_analysis/unused-components-explore.html#chat-components-srccomponentslibrarychat","title":"Chat Components (<code>src/components/library/chat/</code>)","text":""},{"location":"_analysis/unused-components-explore.html#in-use-used-in-explore-or-app-layout","title":"\u2705 In Use (Used in Explore or App-Layout)","text":"<ol> <li>ChatPanel (<code>chat-panel.tsx</code>)</li> <li>Used in: <code>gallery-root.tsx</code>, <code>library/chat/client.tsx</code>, <code>shared/chat-panel.tsx</code></li> <li> <p>Status: ACTIVE - Core component used in Gallery and Library Chat</p> </li> <li> <p>ChatConfigDisplay (<code>chat-config-display.tsx</code>)</p> </li> <li>Used in: <code>story-topics.tsx</code></li> <li> <p>Status: ACTIVE - Used in Story Mode</p> </li> <li> <p>ChatReferenceList (<code>chat-reference-list.tsx</code>)</p> </li> <li>Used in: <code>references-legend.tsx</code></li> <li> <p>Status: ACTIVE - Used in Gallery References Legend</p> </li> <li> <p>ChatInput (<code>chat-input.tsx</code>)</p> </li> <li>Used in: <code>chat-panel.tsx</code></li> <li> <p>Status: ACTIVE - Used by ChatPanel</p> </li> <li> <p>ChatMessage (<code>chat-message.tsx</code>)</p> </li> <li>Used in: <code>chat-messages-list.tsx</code></li> <li> <p>Status: ACTIVE - Used by ChatMessagesList</p> </li> <li> <p>ChatMessagesList (<code>chat-messages-list.tsx</code>)</p> </li> <li>Used in: <code>chat-panel.tsx</code></li> <li> <p>Status: ACTIVE - Used by ChatPanel</p> </li> <li> <p>ChatConfigBar (<code>chat-config-bar.tsx</code>)</p> </li> <li>Used in: <code>chat-panel.tsx</code></li> <li> <p>Status: ACTIVE - Used by ChatPanel</p> </li> <li> <p>ChatConfigPopover (<code>chat-config-popover.tsx</code>)</p> </li> <li>Used in: <code>chat-panel.tsx</code></li> <li> <p>Status: ACTIVE - Used by ChatPanel</p> </li> <li> <p>ChatConversationItem (<code>chat-conversation-item.tsx</code>)</p> </li> <li>Used in: <code>chat-messages-list.tsx</code></li> <li> <p>Status: ACTIVE - Used by ChatMessagesList</p> </li> <li> <p>ChatSuggestedQuestions (<code>chat-suggested-questions.tsx</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE - Used by ChatPanel</li> </ul> </li> <li> <p>ChatWelcomeAssistant (<code>chat-welcome-assistant.tsx</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE - Used by ChatPanel</li> </ul> </li> <li> <p>ChatSelector (<code>chat-selector.tsx</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE - Used by ChatPanel</li> </ul> </li> <li> <p>ChatDocumentSources (<code>chat-document-sources.tsx</code>)</p> <ul> <li>Used in: <code>chat-message.tsx</code></li> <li>Status: ACTIVE - Used by ChatMessage</li> </ul> </li> <li> <p>ChatFiltersDisplay (<code>chat-filters-display.tsx</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE - Used by ChatPanel</li> </ul> </li> <li> <p>ProcessingStatus (<code>processing-status.tsx</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE - Used by ChatPanel</li> </ul> </li> <li> <p>QueryDetailsDialog (<code>query-details-dialog.tsx</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE - Used by ChatPanel</li> </ul> </li> <li> <p>ProcessingLogsDialog (<code>processing-logs-dialog.tsx</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE - Used by ChatPanel</li> </ul> </li> </ol>"},{"location":"_analysis/unused-components-explore.html#hooks-all-active","title":"Hooks (All Active)","text":"<ol> <li> <p>useChatHistory (<code>hooks/use-chat-history.ts</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE</li> </ul> </li> <li> <p>useChatStream (<code>hooks/use-chat-stream.ts</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE</li> </ul> </li> <li> <p>useChatTOC (<code>hooks/use-chat-toc.ts</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE</li> </ul> </li> <li> <p>useChatConfig (<code>hooks/use-chat-config.ts</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE</li> </ul> </li> <li> <p>useChatScroll (<code>hooks/use-chat-scroll.ts</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE</li> </ul> </li> </ol>"},{"location":"_analysis/unused-components-explore.html#utils-all-active","title":"Utils (All Active)","text":"<ol> <li> <p>chat-storage.ts (<code>utils/chat-storage.ts</code>)</p> <ul> <li>Used in: <code>chat-panel.tsx</code></li> <li>Status: ACTIVE</li> </ul> </li> <li> <p>chat-utils.ts (<code>utils/chat-utils.ts</code>)</p> <ul> <li>Used in: <code>chat-messages-list.tsx</code></li> <li>Status: ACTIVE</li> </ul> </li> </ol>"},{"location":"_analysis/unused-components-explore.html#debug-components-potentially-unused-in-production","title":"\u26a0\ufe0f Debug Components (Potentially Unused in Production)","text":"<ol> <li> <p>DebugPanel (<code>debug-panel.tsx</code>)</p> <ul> <li>Used in: <code>debug-footer.tsx</code></li> <li>Status: DEBUG ONLY - May be removable if debug features are disabled</li> </ul> </li> <li> <p>DebugTimeline (<code>debug-timeline.tsx</code>)</p> <ul> <li>Used in: <code>debug-panel.tsx</code></li> <li>Status: DEBUG ONLY - May be removable if debug features are disabled</li> </ul> </li> <li> <p>DebugTrace (<code>debug-trace.tsx</code>)</p> <ul> <li>Used in: <code>debug-panel.tsx</code></li> <li>Status: DEBUG ONLY - May be removable if debug features are disabled</li> </ul> </li> <li> <p>DebugStepTable (<code>debug-step-table.tsx</code>)</p> <ul> <li>Used in: <code>debug-panel.tsx</code></li> <li>Status: DEBUG ONLY - May be removable if debug features are disabled</li> </ul> </li> </ol>"},{"location":"_analysis/unused-components-explore.html#backup-file-deleted","title":"\u274c Backup File (Deleted)","text":"<ol> <li>chat-panel.tsx.backup<ul> <li>Status: DELETED \u2705</li> </ul> </li> </ol>"},{"location":"_analysis/unused-components-explore.html#shared-components-srccomponentsshared","title":"Shared Components (<code>src/components/shared/</code>)","text":""},{"location":"_analysis/unused-components-explore.html#all-active","title":"\u2705 All Active","text":"<ol> <li>AppLogo (<code>app-logo.tsx</code>)</li> <li>Used in: <code>chat-messages-list.tsx</code>, <code>hero-section.tsx</code>, <code>story-topics.tsx</code>, <code>chat-message.tsx</code></li> <li> <p>Status: ACTIVE</p> </li> <li> <p>AIGeneratedNotice (<code>ai-generated-notice.tsx</code>)</p> </li> <li>Used in: <code>story-topics.tsx</code>, <code>chat-message.tsx</code>, <code>book-detail.tsx</code>, <code>session-detail.tsx</code></li> <li> <p>Status: ACTIVE</p> </li> <li> <p>ChatSidePanel (<code>chat-panel.tsx</code>)</p> </li> <li>Used in: <code>app-layout.tsx</code></li> <li> <p>Status: ACTIVE - Used in App Layout</p> </li> <li> <p>JobMonitorPanel (<code>job-monitor-panel.tsx</code>)</p> </li> <li>Used in: <code>app-layout.tsx</code></li> <li> <p>Status: ACTIVE - Used in App Layout</p> </li> <li> <p>LanguageSwitcher (<code>language-switcher.tsx</code>)</p> </li> <li>Used in: <code>top-nav.tsx</code></li> <li> <p>Status: ACTIVE</p> </li> <li> <p>TraceViewer (<code>trace-viewer.tsx</code>)</p> </li> <li>Used in: <code>job-monitor-panel.tsx</code></li> <li> <p>Status: ACTIVE</p> </li> <li> <p>JobTrace (<code>job-trace.tsx</code>)</p> </li> <li> <p>Status: DELETED \u2705 - No imports found, removed</p> </li> <li> <p>KeyValueTable (<code>key-value-table.tsx</code>)</p> </li> <li> <p>Status: DELETED \u2705 - No imports found, removed</p> </li> <li> <p>StorageAuthButton (<code>storage-auth-button.tsx</code>)</p> </li> <li>Status: DELETED \u2705 - No imports found, removed</li> </ol>"},{"location":"_analysis/unused-components-explore.html#pages-analysis","title":"Pages Analysis","text":""},{"location":"_analysis/unused-components-explore.html#in-use-pages-reachable-via-navigation","title":"\u2705 In Use Pages (Reachable via Navigation)","text":""},{"location":"_analysis/unused-components-explore.html#public-navigation-top-navtsx","title":"Public Navigation (<code>top-nav.tsx</code>)","text":"<ul> <li><code>/</code> - Home page</li> <li><code>/docs/</code> - Documentation page</li> </ul>"},{"location":"_analysis/unused-components-explore.html#protected-navigation-top-navtsx","title":"Protected Navigation (<code>top-nav.tsx</code>)","text":"<ul> <li><code>/library</code> - Library main page</li> <li><code>/library/gallery</code> - Gallery page</li> <li><code>/templates</code> - Templates page</li> <li><code>/event-monitor</code> - Event Monitor page</li> <li><code>/session-manager</code> - Session Manager page</li> <li><code>/library/[id]/chat</code> - Chat page (dynamically generated)</li> </ul>"},{"location":"_analysis/unused-components-explore.html#settings-navigation-settingslayouttsx","title":"Settings Navigation (<code>settings/layout.tsx</code>)","text":"<ul> <li><code>/settings</code> - General settings</li> <li><code>/settings/storage</code> - Storage settings</li> <li><code>/settings/secretary-service</code> - Secretary Service settings</li> <li><code>/settings/chat</code> - Chat settings</li> <li><code>/settings/public</code> - Publishing settings</li> </ul>"},{"location":"_analysis/unused-components-explore.html#footer-links-footertsx","title":"Footer Links (<code>footer.tsx</code>)","text":"<ul> <li><code>/datenschutz</code> - Privacy policy</li> <li><code>/impressum</code> - Imprint</li> <li><code>/rechtliche-hinweise</code> - Legal notices</li> <li><code>/ueber</code> - About page</li> </ul>"},{"location":"_analysis/unused-components-explore.html#dynamically-generated-routes","title":"Dynamically Generated Routes","text":"<ul> <li><code>/explore/[slug]</code> - Generated by <code>library-grid.tsx</code> (line 229)</li> <li><code>/explore/[slug]/perspective</code> - Generated by <code>gallery-root.tsx</code> (line 105) and <code>story-header.tsx</code> (line 51)</li> <li><code>/library/[id]/chat</code> - Generated dynamically in <code>top-nav.tsx</code> (line 226)</li> <li><code>/event-monitor/jobs/[jobId]</code> - Generated by <code>batch-list.tsx</code> (line 441)</li> <li><code>/event-monitor/batches/[batchId]</code> - Generated by <code>batch-list.tsx</code> (lines 874, 898)</li> </ul>"},{"location":"_analysis/unused-components-explore.html#programmatically-navigated-routes","title":"Programmatically Navigated Routes","text":"<ul> <li><code>/settings</code> - Navigated from <code>top-nav.tsx</code> (multiple places)</li> <li><code>/library/gallery?mode=story</code> - Navigated from <code>top-nav.tsx</code> (lines 150, 239)</li> <li><code>/templates</code> - Navigated from <code>transformation-dialog.tsx</code> (line 551)</li> <li><code>/event-monitor</code> - Navigated from <code>session-manager/page.tsx</code> (line 283)</li> <li><code>/settings/storage</code> - Navigated from <code>library-form.tsx</code> (line 278)</li> </ul>"},{"location":"_analysis/unused-components-explore.html#potential-shadow-pages","title":"\u26a0\ufe0f Potential Shadow Pages","text":""},{"location":"_analysis/unused-components-explore.html#1-add-test-library-srcappadd-test-librarypagetsx","title":"1. <code>/add-test-library</code> (<code>src/app/add-test-library/page.tsx</code>)","text":"<ul> <li>Status: DELETED \u2705</li> <li>Analysis:<ul> <li>\u274c Not in navigation menu</li> <li>\u274c No <code>router.push()</code> references found</li> <li>\u274c No <code>Link</code> components pointing to it</li> <li>\u2705 Had API endpoint <code>/api/add-library</code> (also deleted)</li> </ul> </li> <li>Action: DELETED - Shadow page removed along with API route</li> </ul>"},{"location":"_analysis/unused-components-explore.html#2-settings-pages-not-in-sidebar","title":"2. Settings Pages Not in Sidebar","text":"<ul> <li><code>/settings/appearance</code> - Not in sidebar navigation</li> <li><code>/settings/display</code> - Not in sidebar navigation</li> <li><code>/settings/notifications</code> - Not in sidebar navigation</li> <li><code>/settings/owner</code> - Not in sidebar navigation</li> <li><code>/settings/library</code> - Not in sidebar navigation</li> <li>Status: NEEDS VERIFICATION</li> <li>These may be accessible via direct URL or other navigation methods</li> </ul>"},{"location":"_analysis/unused-components-explore.html#error-pages-keep-required-by-nextjs","title":"\u2705 Error Pages (Keep - Required by Next.js)","text":"<ul> <li><code>/not-found.tsx</code> - 404 page</li> <li><code>/global-error.tsx</code> - Global error handler</li> </ul>"},{"location":"_analysis/unused-components-explore.html#layouts-keep-required-by-nextjs","title":"\u2705 Layouts (Keep - Required by Next.js)","text":"<ul> <li><code>/layout.tsx</code> - Root layout</li> <li><code>/settings/layout.tsx</code> - Settings layout</li> <li><code>/docs/[[...path]]/page.tsx</code> - Docs dynamic route</li> </ul>"},{"location":"_analysis/unused-components-explore.html#explore-dependency-tree","title":"Explore Dependency Tree","text":"<pre><code>explore/[slug]/page.tsx\n  \u2192 GalleryClient (dynamisch importiert)\n    \u2192 GalleryRoot (gallery-root.tsx)\n      \u2192 ChatPanel (chat-panel.tsx)\n        \u2192 ChatInput\n        \u2192 ChatMessagesList\n          \u2192 ChatMessage\n            \u2192 ChatDocumentSources\n          \u2192 ChatConversationItem\n        \u2192 ChatConfigBar\n        \u2192 ChatConfigPopover\n        \u2192 ChatSelector\n        \u2192 ChatWelcomeAssistant\n        \u2192 ChatSuggestedQuestions\n        \u2192 ChatFiltersDisplay\n        \u2192 ProcessingStatus\n        \u2192 QueryDetailsDialog\n        \u2192 ProcessingLogsDialog\n        \u2192 useChatHistory\n        \u2192 useChatStream\n        \u2192 useChatTOC\n        \u2192 useChatConfig\n        \u2192 useChatScroll\n        \u2192 chat-storage.ts\n      \u2192 StoryTopics (story-topics.tsx)\n        \u2192 ChatConfigDisplay\n        \u2192 AIGeneratedNotice\n        \u2192 AppLogo\n      \u2192 ReferencesLegend (references-legend.tsx)\n        \u2192 ChatReferenceList\n</code></pre>"},{"location":"_analysis/unused-components-explore.html#recommendations","title":"Recommendations","text":""},{"location":"_analysis/unused-components-explore.html#deleted-completed","title":"\ud83d\uddd1\ufe0f Deleted (Completed)","text":"<ol> <li>Backup Files</li> <li> <p>\u2705 <code>src/components/library/chat/chat-panel.tsx.backup</code> - DELETED</p> </li> <li> <p>Shadow Page</p> </li> <li>\u2705 <code>/add-test-library</code> page - DELETED</li> <li> <p>\u2705 <code>/api/add-library</code> API route - DELETED</p> </li> <li> <p>Unused Shared Components</p> </li> <li>\u2705 <code>job-trace.tsx</code> - DELETED</li> <li>\u2705 <code>key-value-table.tsx</code> - DELETED</li> <li>\u2705 <code>storage-auth-button.tsx</code> - DELETED</li> </ol>"},{"location":"_analysis/unused-components-explore.html#review-required-medium-priority","title":"\u26a0\ufe0f Review Required (Medium Priority)","text":"<ol> <li>Debug Components</li> <li><code>debug-panel.tsx</code></li> <li><code>debug-timeline.tsx</code></li> <li><code>debug-trace.tsx</code></li> <li><code>debug-step-table.tsx</code></li> <li>Action: Review if debug features are needed in production</li> <li> <p>Risk: Low (only used in debug context)</p> </li> <li> <p>Settings Pages Not in Sidebar</p> </li> <li><code>/settings/appearance</code></li> <li><code>/settings/display</code></li> <li><code>/settings/notifications</code></li> <li><code>/settings/owner</code></li> <li><code>/settings/library</code></li> <li>Action: Verify if accessible via other means or should be added to sidebar</li> <li>Risk: Low (settings pages, may be intentionally hidden)</li> </ol>"},{"location":"_analysis/unused-components-explore.html#keep-all-active","title":"\u2705 Keep (All Active)","text":"<ul> <li>All Chat Components (except backup and debug)</li> <li>All Shared Components (except unverified ones)</li> <li>All Pages (except potential shadow page)</li> <li>All Hooks and Utils</li> </ul>"},{"location":"_analysis/unused-components-explore.html#next-steps","title":"Next Steps","text":"<ol> <li>Immediate Actions:</li> <li>[ ] Delete <code>chat-panel.tsx.backup</code></li> <li>[ ] Verify usage of unverified shared components</li> <li> <p>[ ] Review <code>/add-test-library</code> page purpose</p> </li> <li> <p>Follow-up Actions:</p> </li> <li>[ ] Review debug components for production readiness</li> <li>[ ] Verify settings pages accessibility</li> <li> <p>[ ] Update documentation after cleanup</p> </li> <li> <p>Verification:</p> </li> <li>[ ] Run build after deletions</li> <li>[ ] Run linter after cleanup</li> <li>[ ] Test affected pages manually</li> </ol>"},{"location":"_analysis/unused-components-explore.html#notes","title":"Notes","text":"<ul> <li>All Chat Components are actively used in the Explore context or App Layout</li> <li>No unused Chat Components found (except debug components)</li> <li>Shared Components are mostly active, but some need verification</li> <li>Only one potential shadow page identified (<code>/add-test-library</code>)</li> <li>The Explore context uses Chat Components extensively through GalleryRoot</li> <li>Dynamic imports are properly handled (GalleryClient uses dynamic import)</li> </ul>"},{"location":"analysis/browser-test-analysis-latest.html","title":"Browser-Test Analyse: Optimierungen validiert","text":""},{"location":"analysis/browser-test-analysis-latest.html#test-szenario","title":"Test-Szenario","text":"<ol> <li>Root-Verzeichnis laden (<code>http://localhost:3000/library</code>)</li> <li>In Unterverzeichnis navigieren (\"2. Wertephase\")</li> </ol>"},{"location":"analysis/browser-test-analysis-latest.html#test-datum","title":"Test-Datum","text":"<p>2025-11-23 00:19:18</p>"},{"location":"analysis/browser-test-analysis-latest.html#analyse-ergebnisse","title":"Analyse-Ergebnisse","text":""},{"location":"analysis/browser-test-analysis-latest.html#root-laden-initial","title":"\u2705 Root-Laden (Initial)","text":"<p>API-Calls: - \u2705 <code>action=list&amp;fileId=root</code> (1x) - Root-Items laden - \u2705 <code>action=list&amp;fileId=LmNrLW1ldGE=</code> (1x) - Favoriten laden - \u2705 <code>action=get</code> (27x) - Metadaten f\u00fcr Dateien (f\u00fcr Shadow-Twin-Analyse) - \u2705 <code>file-status</code> (9x) - Doc-Status f\u00fcr Markdown-Dateien (debounced)</p> <p>Ergebnis: - \u2705 Nur 1x Root-Request (vorher: 3x) - \u2705 Keine doppelten Root-Requests mehr!</p>"},{"location":"analysis/browser-test-analysis-latest.html#navigation-zu-unterverzeichnis-2-wertephase","title":"\u2705 Navigation zu Unterverzeichnis (\"2. Wertephase\")","text":"<p>Console-Logs: <pre><code>[INFO] [00:19:18.676Z][NAV:9][debug@nav][info] \u2139\ufe0f navigateToFolder called {folderId: Mi4gV2VydGVwaGFzZQ==}\n[INFO] [00:19:18.681Z][STATE:20][FolderNavigation][info] \u2139\ufe0f Cache miss, loading path from provider {folderId: Mi4gV2VydGVwaGFzZQ==, missingIds: Array(1)}\n[DEBUG] [00:19:18.802Z][NAV:10][debug@nav][debug] \ud83d\udd0d Using cached root items for path building {itemCount: 51}\n[DEBUG] [00:19:18.803Z][NAV:11][debug@nav][debug] \ud83d\udd0d Using cached children for path building {parentId: root, itemCount: 51}\n[INFO] [00:19:18.804Z][NAV:12][debug@nav][info] \u2139\ufe0f Loaded path items for folder {folderId: Mi4gV2VydGVwaGFzZQ==, pathLength: 2}\n[INFO] [00:19:19.244Z][UI:8][Library][info] \u2139\ufe0f Initial load triggered {currentFolderId: Mi4gV2VydGVwaGFzZQ==, lastLoadedFolder: root, tSinceMountMs: 188969.2}\n[INFO] [00:19:19.247Z][NAV:15][Library][info] \u2139\ufe0f Loading initial items {folderId: Mi4gV2VydGVwaGFzZQ==}\n[INFO] [00:19:19.250Z][NAV:16][Library][info] \u2139\ufe0f Fetching items from provider {folderId: Mi4gV2VydGVwaHFzZQ==, cacheHit: false}\n</code></pre></p> <p>API-Calls: - \u2705 <code>action=path&amp;fileId=Mi4gV2VydGVwaHFzZQ==</code> (1x) - Pfad aufbauen - \u2705 <code>action=list&amp;fileId=Mi4gV2VydGVwaHFzZQ==</code> (1x) - Zielordner-Inhalt laden - \u2705 KEIN <code>action=list&amp;fileId=root</code> - Root-Items werden aus Cache verwendet!</p> <p>Ergebnis: - \u2705 Nur 1x Zielordner-Request (vorher: 2x) - \u2705 Kein Root-Request - Root-Items werden aus Cache verwendet! - \u2705 Keine doppelten Calls mehr!</p>"},{"location":"analysis/browser-test-analysis-latest.html#validierung-der-optimierungen","title":"Validierung der Optimierungen","text":""},{"location":"analysis/browser-test-analysis-latest.html#1-race-condition-bei-loaditems-behoben","title":"\u2705 1. Race-Condition bei loadItems behoben","text":"<p>Vorher: - <code>loadItems</code> wurde zweimal aufgerufen - 2x Zielordner-Requests</p> <p>Nachher: - <code>loadItems</code> wird nur 1x aufgerufen - 1x Zielordner-Request - <code>lastLoadedFolder</code> wird optimistisch gesetzt</p> <p>Status: \u2705 FUNKTIONIERT</p>"},{"location":"analysis/browser-test-analysis-latest.html#2-root-items-fur-pfadaufbau-optimiert","title":"\u2705 2. Root-Items f\u00fcr Pfadaufbau optimiert","text":"<p>Vorher: - <code>getPathItemsById</code> l\u00e4dt Root-Items mit API-Call - 3x Root-Requests insgesamt</p> <p>Nachher: - Root-Items werden aus Cache verwendet (<code>Using cached root items for path building</code>) - Root-Children werden aus Cache verwendet (<code>Using cached children for path building</code>) - 0x Root-Requests bei Navigation</p> <p>Status: \u2705 FUNKTIONIERT</p>"},{"location":"analysis/browser-test-analysis-latest.html#performance-verbesserungen","title":"Performance-Verbesserungen","text":""},{"location":"analysis/browser-test-analysis-latest.html#root-laden","title":"Root-Laden","text":"<ul> <li>Vorher: 3x Root-Requests</li> <li>Nachher: 1x Root-Request</li> <li>Verbesserung: 66% Reduzierung</li> </ul>"},{"location":"analysis/browser-test-analysis-latest.html#navigation-zu-unterverzeichnis","title":"Navigation zu Unterverzeichnis","text":"<ul> <li>Vorher: 1x path, 1x root, 2x Zielordner = 4 API-Calls</li> <li>Nachher: 1x path, 0x root (Cache), 1x Zielordner = 2 API-Calls</li> <li>Verbesserung: 50% Reduzierung</li> </ul>"},{"location":"analysis/browser-test-analysis-latest.html#zusammenfassung","title":"Zusammenfassung","text":"<p>\u2705 Alle Optimierungen funktionieren wie erwartet!</p> <ol> <li>\u2705 Race-Condition bei <code>loadItems</code> behoben - keine doppelten Zielordner-Requests mehr</li> <li>\u2705 Root-Items werden aus Cache verwendet - keine doppelten Root-Requests mehr</li> <li>\u2705 Cache wird effizient genutzt - Root-Items werden nicht neu geladen</li> </ol> <p>Die Optimierungen haben die erwartete Wirkung und reduzieren die API-Calls deutlich.</p>"},{"location":"analysis/browser-test-analysis.html","title":"Browser-Test Analyse: Root-Laden und Navigation","text":""},{"location":"analysis/browser-test-analysis.html#test-szenario","title":"Test-Szenario","text":"<ol> <li>Root-Verzeichnis laden (<code>http://localhost:3000/library</code>)</li> <li>In Unterverzeichnis navigieren (\"2. Wertephase\")</li> </ol>"},{"location":"analysis/browser-test-analysis.html#identifizierte-api-calls","title":"Identifizierte API-Calls","text":""},{"location":"analysis/browser-test-analysis.html#root-laden-initial","title":"Root-Laden (Initial)","text":"<p>Notwendige Calls: - \u2705 <code>action=list&amp;fileId=root</code> (1x) - Root-Items laden - \u2705 <code>action=list&amp;fileId=LmNrLW1ldGE=</code> (1x) - Favoriten laden - \u2705 <code>action=binary&amp;fileId=LmNrLW1ldGEvZmF2b3JpdGVzLmpzb24=</code> (1x) - Favoriten-Datei laden - \u2705 <code>action=get</code> (27x) - Metadaten f\u00fcr Dateien (f\u00fcr Shadow-Twin-Analyse) - \u2705 <code>file-status</code> (9x) - Doc-Status f\u00fcr Markdown-Dateien (debounced)</p> <p>Problematische Calls: - \u274c <code>action=list&amp;fileId=root</code> (2x zus\u00e4tzlich) - DOUBLETTE   - Zeile 194: Zweiter Root-Call w\u00e4hrend Shadow-Twin-Analyse   - Ursache: <code>getPathItemsById</code> l\u00e4dt Root-Items f\u00fcr Pfadaufbau</p>"},{"location":"analysis/browser-test-analysis.html#navigation-zu-unterverzeichnis","title":"Navigation zu Unterverzeichnis","text":"<p>Notwendige Calls: - \u2705 <code>action=path&amp;fileId=Mi4gV2VydGVwaGFzZQ==</code> (1x) - Pfad aufbauen - \u2705 <code>action=list&amp;fileId=root</code> (1x) - Root-Items f\u00fcr Pfadaufbau (notwendig, aber k\u00f6nnte gecacht werden) - \u2705 <code>action=list&amp;fileId=Mi4gV2VydGVwaGFzZQ==</code> (1x) - Zielordner-Inhalt laden</p> <p>Problematische Calls: - \u274c <code>action=list&amp;fileId=Mi4gV2VydGVwaGFzZQ==</code> (2x) - DOUBLETTE   - Zeile 391-392: Erster Call durch <code>loadItems</code>   - Zeile 400-401: Zweiter Call durch <code>loadItems</code> (warum?)   - Ursache: <code>loadItems</code> wird zweimal aufgerufen (Race-Condition?)</p>"},{"location":"analysis/browser-test-analysis.html#identifizierte-probleme","title":"Identifizierte Probleme","text":""},{"location":"analysis/browser-test-analysis.html#1-doppelte-root-requests","title":"1. Doppelte Root-Requests","text":"<p>Problem: - Root wird 3x geladen statt 1x - Zweiter Call durch <code>getPathItemsById</code> w\u00e4hrend Shadow-Twin-Analyse - Dritter Call durch <code>getPathItemsById</code> beim Navigieren</p> <p>Ursache: - <code>getPathItemsById</code> l\u00e4dt Root-Items f\u00fcr Pfadaufbau - Root-Items sind bereits im Cache, aber <code>getPathItemsById</code> macht trotzdem API-Call</p> <p>L\u00f6sung: - <code>getPathItemsById</code> sollte Root-Items aus Cache verwenden, wenn verf\u00fcgbar - Oder: Root-Items werden bereits beim Initial-Load geladen und sind im Cache</p>"},{"location":"analysis/browser-test-analysis.html#2-doppelte-zielordner-requests","title":"2. Doppelte Zielordner-Requests","text":"<p>Problem: - Zielordner wird 2x geladen statt 1x - Beide Calls durch <code>loadItems</code> mit <code>cacheHit: false</code></p> <p>Ursache: - <code>loadItems</code> wird zweimal aufgerufen (Race-Condition?) - Cache-Check schl\u00e4gt fehl oder Cache ist noch nicht aktualisiert</p> <p>L\u00f6sung: - Cache-Check vor API-Call verbessern - <code>loadInFlightRef</code> sollte Race-Conditions verhindern, aber scheint nicht zu greifen</p>"},{"location":"analysis/browser-test-analysis.html#3-viele-metadaten-requests","title":"3. Viele Metadaten-Requests","text":"<p>Problem: - 27+ <code>action=get</code> Requests f\u00fcr Metadaten - Jeder Request l\u00e4dt nur Metadaten f\u00fcr eine Datei</p> <p>Ursache: - Shadow-Twin-Analyse l\u00e4dt Metadaten f\u00fcr jede Datei einzeln - Kein Batching vorhanden</p> <p>L\u00f6sung: - Metadaten-Batching implementieren - Oder: Metadaten bereits in <code>listItems</code> Response enthalten</p>"},{"location":"analysis/browser-test-analysis.html#4-root-items-fur-pfadaufbau","title":"4. Root-Items f\u00fcr Pfadaufbau","text":"<p>Problem: - <code>getPathItemsById</code> l\u00e4dt Root-Items, obwohl sie bereits im Cache sind - Root-Items werden f\u00fcr jeden Pfadaufbau neu geladen</p> <p>Ursache: - <code>getPathItemsById</code> macht immer API-Call f\u00fcr Root-Items - Cache wird nicht verwendet</p> <p>L\u00f6sung: - <code>getPathItemsById</code> sollte Root-Items aus Cache verwenden - Oder: Root-Items werden bereits beim Initial-Load geladen und sind im Cache</p>"},{"location":"analysis/browser-test-analysis.html#empfohlene-optimierungen","title":"Empfohlene Optimierungen","text":""},{"location":"analysis/browser-test-analysis.html#prioritat-1-hochste-impact","title":"Priorit\u00e4t 1 (H\u00f6chste Impact)","text":"<ol> <li>Doppelte Zielordner-Requests eliminieren:</li> <li>Cache-Check vor API-Call verbessern</li> <li><code>loadInFlightRef</code> sollte Race-Conditions verhindern</li> <li> <p>Pr\u00fcfen, warum <code>loadItems</code> zweimal aufgerufen wird</p> </li> <li> <p>Root-Items f\u00fcr Pfadaufbau cachen:</p> </li> <li><code>getPathItemsById</code> sollte Root-Items aus Cache verwenden</li> <li>Oder: Root-Items werden bereits beim Initial-Load geladen und sind im Cache</li> </ol>"},{"location":"analysis/browser-test-analysis.html#prioritat-2-mittlere-impact","title":"Priorit\u00e4t 2 (Mittlere Impact)","text":"<ol> <li>Metadaten-Batching:</li> <li>Metadaten bereits in <code>listItems</code> Response enthalten</li> <li> <p>Oder: Batch-API f\u00fcr Metadaten implementieren</p> </li> <li> <p>Doppelte Root-Requests eliminieren:</p> </li> <li><code>getPathItemsById</code> sollte Root-Items aus Cache verwenden</li> <li>Oder: Root-Items werden bereits beim Initial-Load geladen und sind im Cache</li> </ol>"},{"location":"analysis/browser-test-analysis.html#prioritat-3-niedrige-impact","title":"Priorit\u00e4t 3 (Niedrige Impact)","text":"<ol> <li>Cache-Invalidierung optimieren:</li> <li>Cache wird nur bei Bedarf invalidiert</li> <li>Cache-TTL implementieren</li> </ol>"},{"location":"analysis/browser-test-analysis.html#messungen","title":"Messungen","text":""},{"location":"analysis/browser-test-analysis.html#aktuelle-performance","title":"Aktuelle Performance","text":"<p>Root-Laden: - API-Calls: 3x Root, 1x Favoriten, 27x Metadaten, 9x file-status - Gesamt: ~40 API-Calls - Ladezeit: ~877ms (laut Logs)</p> <p>Navigation zu Unterverzeichnis: - API-Calls: 1x path, 1x root (f\u00fcr Pfad), 2x Zielordner (doppelt!) - Gesamt: ~4 API-Calls (sollte 2 sein) - Ladezeit: ~500ms (gesch\u00e4tzt)</p>"},{"location":"analysis/browser-test-analysis.html#ziel-performance","title":"Ziel-Performance","text":"<p>Root-Laden: - API-Calls: 1x Root, 1x Favoriten, 1x Batch-Metadaten, 1x Batch-file-status - Gesamt: ~4 API-Calls - Ladezeit: ~200-300ms</p> <p>Navigation zu Unterverzeichnis: - API-Calls: 1x Zielordner (aus Cache wenn m\u00f6glich) - Gesamt: ~1 API-Call - Ladezeit: ~50-100ms</p>"},{"location":"analysis/browser-test-analysis.html#implementierte-optimierungen","title":"Implementierte Optimierungen","text":""},{"location":"analysis/browser-test-analysis.html#1-race-condition-bei-loaditems-behoben-prioritat-1","title":"\u2705 1. Race-Condition bei loadItems behoben (Priorit\u00e4t 1)","text":"<p>Problem: - <code>loadItems</code> wurde zweimal aufgerufen (Zeile 390-392 und 399-401) - Ursache: <code>lastLoadedFolder</code> wurde erst nach dem API-Call gesetzt, aber <code>useEffect</code> lief erneut, bevor <code>lastLoadedFolder</code> aktualisiert wurde</p> <p>L\u00f6sung: - <code>setLastLoadedFolder</code> wird jetzt optimistisch gesetzt, bevor der API-Call gemacht wird - Verhindert, dass <code>loadItems</code> zweimal aufgerufen wird - Bei Context-Change wird <code>lastLoadedFolder</code> zur\u00fcckgesetzt</p> <p>Datei: <code>src/components/library/library.tsx</code></p> <p>Impact: - Eliminiert doppelte Zielordner-Requests - Reduziert API-Calls um ~50% bei Navigation</p>"},{"location":"analysis/browser-test-analysis.html#2-root-items-fur-pfadaufbau-optimiert-prioritat-1","title":"\u2705 2. Root-Items f\u00fcr Pfadaufbau optimiert (Priorit\u00e4t 1)","text":"<p>Problem: - <code>getPathItemsById</code> l\u00e4dt Root-Items mit <code>listItemsById('root')</code>, das nicht dedupliziert ist - Root-Items wurden doppelt geladen, obwohl sie bereits im Cache waren</p> <p>L\u00f6sung: - <code>useFolderNavigation</code> baut den Pfad jetzt manuell auf - Verwendet <code>listItems</code> (dedupliziert) statt <code>getPathItemsById</code> - Pr\u00fcft Cache f\u00fcr Root-Items und Ordner im Pfad vor API-Calls</p> <p>Datei: <code>src/hooks/use-folder-navigation.ts</code></p> <p>Impact: - Eliminiert doppelte Root-Requests - Reduziert API-Calls um ~33% bei Navigation - Nutzt Cache effizienter</p>"},{"location":"analysis/browser-test-analysis.html#nachste-schritte","title":"N\u00e4chste Schritte","text":"<ol> <li>\u2705 Doppelte Zielordner-Requests analysieren und beheben - FERTIG</li> <li>\u2705 Root-Items f\u00fcr Pfadaufbau cachen - FERTIG</li> <li>\u23f3 Performance messen und validieren</li> <li>\u23f3 Metadaten-Batching implementieren (optional, niedrige Priorit\u00e4t)</li> </ol>"},{"location":"analysis/library-root-loading-analysis.html","title":"Library Root Loading - Performance Analyse","text":""},{"location":"analysis/library-root-loading-analysis.html#use-case-laden-der-library-root-beim-ersten-mal","title":"Use Case: Laden der Library-Root beim ersten Mal","text":""},{"location":"analysis/library-root-loading-analysis.html#potenzielle-probleme-identifiziert","title":"Potenzielle Probleme identifiziert","text":""},{"location":"analysis/library-root-loading-analysis.html#1-doppelte-root-item-ladung","title":"1. Doppelte Root-Item-Ladung","text":"<p>Problem: Zwei Komponenten laden m\u00f6glicherweise gleichzeitig Root-Items:</p> <ul> <li>FileTree (<code>src/components/library/file-tree.tsx:156</code>):</li> <li><code>loadRootItems()</code> ruft <code>provider.listItemsById('root')</code> auf</li> <li> <p>Wird beim Mount der FileTree-Komponente ausgef\u00fchrt</p> </li> <li> <p>Library (<code>src/components/library/library.tsx:163</code>):</p> </li> <li><code>loadItems()</code> ruft <code>listItems('root')</code> auf (wenn <code>currentFolderId === 'root'</code>)</li> <li>Wird im <code>useEffect</code> f\u00fcr Initial-Load ausgef\u00fchrt</li> </ul> <p>M\u00f6gliche L\u00f6sung: - Cache-Sharing zwischen FileTree und Library - Oder: FileTree verwendet Library-State statt eigenen API-Call</p>"},{"location":"analysis/library-root-loading-analysis.html#2-mehrfache-useeffect-ausfuhrungen","title":"2. Mehrfache useEffect-Ausf\u00fchrungen","text":"<p>Library-Komponente (<code>library.tsx:320</code>): - <code>useEffect</code> hat viele Dependencies: <code>[providerInstance, libraryStatus, currentFolderId, lastLoadedFolder, activeLibraryId, loadItems, searchParams]</code> - <code>loadItems</code> ist ein <code>useCallback</code> mit vielen Dependencies - Bei jeder \u00c4nderung einer Dependency k\u00f6nnte der Effect erneut ausgef\u00fchrt werden</p> <p>M\u00f6gliche L\u00f6sung: - Dependencies reduzieren - <code>loadInFlightRef</code> pr\u00fcfen, aber Timing k\u00f6nnte problematisch sein</p>"},{"location":"analysis/library-root-loading-analysis.html#3-storagecontext-listitems","title":"3. StorageContext listItems","text":"<p>StorageContext (<code>storage-context.tsx:520</code>): - <code>listItems</code> wird von mehreren Stellen aufgerufen - Keine zentrale Cache-Verwaltung sichtbar - Jeder Aufruf k\u00f6nnte einen API-Request ausl\u00f6sen</p>"},{"location":"analysis/library-root-loading-analysis.html#zu-analysierende-logs","title":"Zu analysierende Logs","text":"<p>Nach der Anmeldung sollten folgende Logs erscheinen:</p> <ol> <li>Client-seitig:</li> <li><code>[StorageContext]</code> - Library Loading</li> <li><code>[Library]</code> - Initial load triggered</li> <li><code>[FileTree]</code> - Root-Items laden</li> <li> <p><code>[NAV]</code> - Navigation Events</p> </li> <li> <p>Server-seitig:</p> </li> <li><code>[API][filesystem][list]</code> - API-Calls f\u00fcr Root-Items</li> <li><code>[API][filesystem]</code> - Allgemeine Filesystem-Requests</li> </ol>"},{"location":"analysis/library-root-loading-analysis.html#metriken-zu-messen","title":"Metriken zu messen","text":"<ul> <li>Anzahl der API-Calls f\u00fcr Root-Items</li> <li>Zeit zwischen erstem und letztem Root-Item-Call</li> <li>Anzahl der Re-Renders</li> <li>Cache-Hit-Rate</li> </ul>"},{"location":"analysis/library-root-loading-analysis.html#analyse-ergebnisse-22112025","title":"Analyse-Ergebnisse (22.11.2025)","text":""},{"location":"analysis/library-root-loading-analysis.html#1-doppelte-root-item-ladung-bestatigt","title":"1. Doppelte Root-Item-Ladung \u2705 BEST\u00c4TIGT","text":"<p>Zeitstempel: - <code>22:07:41.616Z</code> - FileTree startet Root-Load - <code>22:07:41.619Z</code> - Library startet Root-Load (nur 3ms sp\u00e4ter!)</p> <p>Network-Requests: - Mindestens 4 separate <code>GET /api/storage/filesystem?action=list&amp;fileId=root</code> Calls - Alle innerhalb weniger Millisekunden</p> <p>Problem: - FileTree und Library laden beide Root-Items unabh\u00e4ngig voneinander - Keine Koordination zwischen den Komponenten - Jede Komponente macht eigenen API-Call</p>"},{"location":"analysis/library-root-loading-analysis.html#2-unnotige-get-requests","title":"2. Unn\u00f6tige get-Requests","text":"<p>Problem: - Nach dem Laden der Root-Liste werden f\u00fcr jede Datei separate <code>action=get</code> Requests gemacht - Diese Requests holen Metadaten, die bereits in der Root-Liste enthalten sein k\u00f6nnten - Beispiel: 27 Dateien = 27 zus\u00e4tzliche API-Calls</p> <p>Network-Requests: <pre><code>[GET] .../action=get&amp;fileId=MDEgLSBVbmJla2FubnRlIEludGVycGV0IC0gVW5iZWthbm50ZSBUaXRlbC5kZS5tZA==\n[GET] .../action=get&amp;fileId=MDEgLSBVbmJla2FubnRlIEludGVycGV0IC0gVW5iZWthbm50ZSBUaXRlbC5tcDM=\n[GET] .../action=get&amp;fileId=MjAyNTA0MjFfMTI1MTAzLmpwZw==\n... (24 weitere)\n</code></pre></p>"},{"location":"analysis/library-root-loading-analysis.html#3-mehrfache-useeffect-ausfuhrungen","title":"3. Mehrfache useEffect-Ausf\u00fchrungen","text":"<p>Beobachtung: - Library-Komponente hat <code>useEffect</code> mit vielen Dependencies - <code>loadItems</code> wird mehrfach aufgerufen - Cache-Check (<code>lastLoadedFolder !== currentFolderId</code>) funktioniert, aber Timing ist problematisch</p>"},{"location":"analysis/library-root-loading-analysis.html#4-doppelte-binary-requests","title":"4. Doppelte Binary-Requests","text":"<p>Problem: - Einige Dateien werden mehrfach geladen (z.B. <code>Diva Shopl\u00f6sungen.de.md</code> 3x) - Vermutlich durch verschiedene Komponenten (Preview, FileRow, etc.)</p>"},{"location":"analysis/library-root-loading-analysis.html#gefundene-root-item-ladungen","title":"Gefundene Root-Item-Ladungen","text":"<p>Mindestens 8 verschiedene Stellen laden Root-Items:</p> <ol> <li>FileTree (<code>file-tree.tsx:160</code>) - <code>loadRootItems()</code></li> <li>Library (<code>library.tsx:163</code>) - <code>loadItems('root')</code></li> <li>MarkdownPreview (<code>markdown-preview.tsx:215, 345</code>) - <code>listItems('root')</code> (2x!)</li> <li>JobReportTab (<code>job-report-tab.tsx:163</code>) - <code>provider.listItemsById('root')</code></li> <li>PdfPhaseSettings (<code>pdf-phase-settings.tsx:47</code>) - <code>listItems('root')</code></li> <li>PdfTransform (<code>pdf-transform.tsx:67</code>) - <code>provider.listItemsById('root')</code></li> <li>TransformationDialog (<code>transformation-dialog.tsx:87</code>) - <code>listItems('root')</code></li> <li>CombinedChatDialog (<code>combined-chat-dialog.tsx:48</code>) - <code>provider.listItemsById('root')</code></li> </ol> <p>Problem: Jede Komponente macht eigenen API-Call, keine Koordination!</p>"},{"location":"analysis/library-root-loading-analysis.html#empfohlene-optimierungen","title":"Empfohlene Optimierungen","text":""},{"location":"analysis/library-root-loading-analysis.html#1-zentrale-root-item-verwaltung-prioritat-hoch","title":"1. Zentrale Root-Item-Verwaltung (PRIORIT\u00c4T: HOCH)","text":"<p>L\u00f6sung: Gemeinsames Atom f\u00fcr Root-Items</p> <pre><code>// src/atoms/library-atom.ts\nexport const rootItemsAtom = atom&lt;StorageItem[] | null&gt;(null);\n\n// StorageContext oder Library-Komponente l\u00e4dt einmal\n// Alle anderen Komponenten verwenden das Atom\n</code></pre> <p>Vorteile: - Nur 1 API-Call statt 8+ - Sofortige Verf\u00fcgbarkeit f\u00fcr alle Komponenten - Konsistente Daten</p> <p>Implementierung: - Root-Items in <code>folderItemsAtom</code> speichern wenn <code>currentFolderId === 'root'</code> - FileTree verwendet <code>folderItemsAtom</code> statt eigenen Call - Andere Komponenten verwenden <code>folderItemsAtom</code> oder dediziertes <code>rootItemsAtom</code></p>"},{"location":"analysis/library-root-loading-analysis.html#2-request-deduplizierung-prioritat-mittel","title":"2. Request-Deduplizierung (PRIORIT\u00c4T: MITTEL)","text":"<p>L\u00f6sung: Promise-Sharing f\u00fcr identische Requests</p> <pre><code>// src/lib/storage/request-deduplicator.ts\nconst pendingRequests = new Map&lt;string, Promise&lt;StorageItem[]&gt;&gt;();\n\nexport function deduplicateRequest(key: string, request: () =&gt; Promise&lt;StorageItem[]&gt;) {\n  if (pendingRequests.has(key)) {\n    return pendingRequests.get(key)!;\n  }\n  const promise = request().finally(() =&gt; pendingRequests.delete(key));\n  pendingRequests.set(key, promise);\n  return promise;\n}\n</code></pre> <p>Vorteile: - Mehrfache gleichzeitige Requests werden zusammengef\u00fchrt - Reduziert Server-Last</p>"},{"location":"analysis/library-root-loading-analysis.html#3-batch-requests-fur-metadaten-prioritat-niedrig","title":"3. Batch-Requests f\u00fcr Metadaten (PRIORIT\u00c4T: NIEDRIG)","text":"<p>Problem: 27 separate <code>get</code>-Requests f\u00fcr Metadaten</p> <p>L\u00f6sung: Batch-API oder Metadaten in <code>list</code>-Response</p> <p>Vorteile: - Reduziert 27 Requests auf 1-2 Requests - Schnelleres Laden</p>"},{"location":"analysis/library-root-loading-analysis.html#4-useeffect-dependencies-optimieren-prioritat-mittel","title":"4. useEffect-Dependencies optimieren (PRIORIT\u00c4T: MITTEL)","text":"<p>Problem: Library <code>useEffect</code> hat viele Dependencies</p> <p>L\u00f6sung: - Dependencies reduzieren - Stabile Referenzen verwenden (<code>useRef</code> f\u00fcr Callbacks) - <code>loadInFlightRef</code> verbessern</p>"},{"location":"analysis/library-root-loading-analysis.html#nachste-schritte","title":"N\u00e4chste Schritte","text":"<ol> <li>\u2705 Analyse abgeschlossen</li> <li>\u23f3 Implementierung: Zentrale Root-Item-Verwaltung</li> <li>\u23f3 Implementierung: Request-Deduplizierung</li> <li>\u23f3 Testing: Performance-Messung vor/nach Optimierung</li> </ol>"},{"location":"analysis/performance-analysis-loading.html","title":"Performance-Analyse: Ladeverhalten und Verzeichniswechsel","text":""},{"location":"analysis/performance-analysis-loading.html#problemstellung","title":"Problemstellung","text":"<p>Die Anwendung ist sehr tr\u00e4ge, besonders bei Verzeichniswechseln. Ziel: Unn\u00f6tige Operationen identifizieren und eliminieren.</p>"},{"location":"analysis/performance-analysis-loading.html#identifizierte-performance-probleme","title":"Identifizierte Performance-Probleme","text":""},{"location":"analysis/performance-analysis-loading.html#1-mehrfache-api-calls-beim-verzeichniswechsel","title":"1. Mehrfache API-Calls beim Verzeichniswechsel","text":"<p>Problem: Beim Navigieren zu einem Ordner werden mehrere API-Calls ausgef\u00fchrt:</p> <ol> <li><code>navigateToFolder</code> \u2192 <code>getPathItemsById(folderId)</code> - L\u00e4dt den gesamten Pfad</li> <li><code>navigateToFolder</code> \u2192 <code>getItemById(folderId)</code> - L\u00e4dt den Zielordner selbst</li> <li><code>loadItems</code> \u2192 <code>listItems(currentFolderId)</code> - L\u00e4dt den Ordnerinhalt</li> <li>FileTree \u2192 <code>listItemsById(folderId)</code> - Kann zus\u00e4tzlich Ordnerinhalt laden (bei Auto-Expand)</li> </ol> <p>L\u00f6sung: - <code>getPathItemsById</code> sollte bereits den Zielordner enthalten (oder wir kombinieren die Calls) - Cache-Check in <code>loadItems</code> sollte vor dem API-Call erfolgen - FileTree sollte nicht nochmal laden, wenn <code>loadItems</code> bereits l\u00e4dt</p>"},{"location":"analysis/performance-analysis-loading.html#2-shadow-twin-analyse-bei-jedem-ordnerwechsel","title":"2. Shadow-Twin-Analyse bei jedem Ordnerwechsel","text":"<p>Problem: <code>useShadowTwinAnalysis</code> analysiert ALLE Dateien im Ordner bei jedem Wechsel: - Bei 100 Dateien = 100 API-Calls - L\u00e4uft synchron, blockiert UI - Wird auch ausgef\u00fchrt, wenn sich nichts ge\u00e4ndert hat</p> <p>L\u00f6sung: - Analyse nur f\u00fcr neue/ge\u00e4nderte Dateien (bereits implementiert, aber pr\u00fcfen) - Debouncing bei schnellen Ordnerwechseln - Lazy Loading: Analyse erst nach kurzer Verz\u00f6gerung - Parallelisierung optimieren</p>"},{"location":"analysis/performance-analysis-loading.html#3-redundante-useeffect-ausfuhrungen","title":"3. Redundante useEffect-Ausf\u00fchrungen","text":"<p>Problem: Mehrere useEffects reagieren auf <code>currentFolderId</code>:</p> <ol> <li><code>library.tsx</code> - Initial Load Effect (Zeile 320-371)</li> <li><code>library.tsx</code> - Library Change Effect (Zeile 378-400)</li> <li><code>file-tree.tsx</code> - Auto-Expand Effect (Zeile 439-534)</li> <li><code>file-list.tsx</code> - Shadow-Twin Analysis (Zeile 767)</li> </ol> <p>L\u00f6sung: - Konsolidiere Logik in weniger useEffects - Verwende Refs f\u00fcr Werte, die nicht zu Re-Renders f\u00fchren sollen - Vermeide unn\u00f6tige Dependencies</p>"},{"location":"analysis/performance-analysis-loading.html#4-cache-updates-nicht-optimal","title":"4. Cache-Updates nicht optimal","text":"<p>Problem: - <code>loadItems</code> aktualisiert Cache nur wenn <code>currentFolderId !== 'root'</code> - <code>navigateToFolder</code> aktualisiert Cache separat - Cache wird nicht f\u00fcr Root-Items verwendet</p> <p>L\u00f6sung: - Einheitliche Cache-Strategie f\u00fcr alle Ordner (inkl. Root) - Cache-Update atomar mit State-Update kombinieren - Cache-Invalidierung nur bei Bedarf</p>"},{"location":"analysis/performance-analysis-loading.html#5-url-updates-fuhren-zu-re-renders","title":"5. URL-Updates f\u00fchren zu Re-Renders","text":"<p>Problem: - <code>navigateToFolder</code> ruft <code>router.replace</code> auf - <code>useSearchParams</code> wird neu evaluiert - Kann zu mehrfachen Re-Renders f\u00fchren</p> <p>L\u00f6sung: - URL-Update debouncen - <code>useSearchParams</code> nur dort verwenden, wo n\u00f6tig - Memoization f\u00fcr abgeleitete Werte</p>"},{"location":"analysis/performance-analysis-loading.html#6-filetree-auto-expand-ladt-unnotig","title":"6. FileTree Auto-Expand l\u00e4dt unn\u00f6tig","text":"<p>Problem: - FileTree l\u00e4dt Ordner-Inhalte beim Auto-Expand (Zeile 439-534) - L\u00e4dt auch Ordner, die bereits im Cache sind - Kann zu zus\u00e4tzlichen API-Calls f\u00fchren</p> <p>L\u00f6sung: - Cache-Check vor dem Laden - Verwende <code>folderCache</code> statt <code>listItemsById</code> - Lazy Loading: Nur sichtbare Ordner laden</p>"},{"location":"analysis/performance-analysis-loading.html#7-breadcrumb-pfad-berechnung","title":"7. Breadcrumb-Pfad-Berechnung","text":"<p>Problem: - <code>currentPathAtom</code> wird bei jedem <code>folderCache</code>-Update neu berechnet - Kann bei vielen Cache-Updates zu Performance-Problemen f\u00fchren</p> <p>L\u00f6sung: - Memoization f\u00fcr Pfad-Berechnung - Nur bei relevanten Cache-Updates neu berechnen</p>"},{"location":"analysis/performance-analysis-loading.html#empfohlene-optimierungen","title":"Empfohlene Optimierungen","text":""},{"location":"analysis/performance-analysis-loading.html#prioritat-1-hochste-impact","title":"Priorit\u00e4t 1 (H\u00f6chste Impact)","text":"<ol> <li>Shadow-Twin-Analyse optimieren:</li> <li>Debouncing (300ms)</li> <li>Lazy Loading (erst nach 500ms)</li> <li> <p>Nur neue/ge\u00e4nderte Dateien analysieren</p> </li> <li> <p>Cache-Strategie vereinheitlichen:</p> </li> <li>Root-Items auch cachen</li> <li>Cache-Check vor jedem API-Call</li> <li> <p>Atomare Cache-Updates</p> </li> <li> <p>Redundante API-Calls eliminieren:</p> </li> <li><code>getPathItemsById</code> sollte Zielordner enthalten</li> <li>FileTree sollte Cache verwenden statt API-Calls</li> </ol>"},{"location":"analysis/performance-analysis-loading.html#prioritat-2-mittlere-impact","title":"Priorit\u00e4t 2 (Mittlere Impact)","text":"<ol> <li>useEffect-Konsolidierung:</li> <li>Weniger useEffects mit mehr Logik</li> <li> <p>Refs f\u00fcr nicht-reaktive Werte</p> </li> <li> <p>URL-Update optimieren:</p> </li> <li>Debouncing f\u00fcr URL-Updates</li> <li>Memoization f\u00fcr <code>useSearchParams</code></li> </ol>"},{"location":"analysis/performance-analysis-loading.html#prioritat-3-niedrige-impact","title":"Priorit\u00e4t 3 (Niedrige Impact)","text":"<ol> <li>Breadcrumb-Optimierung:</li> <li> <p>Memoization f\u00fcr Pfad-Berechnung</p> </li> <li> <p>FileTree Lazy Loading:</p> </li> <li>Nur sichtbare Ordner laden</li> </ol>"},{"location":"analysis/performance-analysis-loading.html#messungen","title":"Messungen","text":""},{"location":"analysis/performance-analysis-loading.html#aktuelle-performance-geschatzt","title":"Aktuelle Performance (gesch\u00e4tzt)","text":"<ul> <li>Verzeichniswechsel: ~500-1000ms</li> <li>Navigation: ~100ms</li> <li>API-Calls: ~200-400ms</li> <li>Shadow-Twin-Analyse: ~200-500ms</li> <li>Re-Renders: ~100-200ms</li> </ul>"},{"location":"analysis/performance-analysis-loading.html#ziel-performance","title":"Ziel-Performance","text":"<ul> <li>Verzeichniswechsel: ~100-200ms</li> <li>Navigation: ~50ms</li> <li>API-Calls: ~50-100ms (mit Cache)</li> <li>Shadow-Twin-Analyse: ~50-100ms (lazy, debounced)</li> <li>Re-Renders: ~50ms</li> </ul>"},{"location":"analysis/performance-analysis-loading.html#implementierte-optimierungen","title":"Implementierte Optimierungen","text":""},{"location":"analysis/performance-analysis-loading.html#1-shadow-twin-analyse-optimiert-prioritat-1","title":"\u2705 1. Shadow-Twin-Analyse optimiert (Priorit\u00e4t 1)","text":"<p>\u00c4nderungen: - Lazy Loading: 500ms Delay bevor die Analyse startet - Debouncing: Verhindert unn\u00f6tige Analysen bei schnellen Ordnerwechseln - Cleanup: Timeout wird bei Unmount gecancelt</p> <p>Datei: <code>src/hooks/use-shadow-twin-analysis.ts</code></p> <p>Impact:  - Verhindert sofortige Analysen bei schnellen Ordnerwechseln - Reduziert API-Calls um ~50-80% bei schneller Navigation - Verbessert wahrgenommene Performance deutlich</p>"},{"location":"analysis/performance-analysis-loading.html#2-cache-strategie-vereinheitlicht-prioritat-1","title":"\u2705 2. Cache-Strategie vereinheitlicht (Priorit\u00e4t 1)","text":"<p>\u00c4nderungen: - Root-Items werden jetzt auch gecacht - Cache-Update f\u00fcr alle Ordner (inkl. Root) - Einheitliche Cache-Strategie</p> <p>Datei: <code>src/components/library/library.tsx</code></p> <p>Impact: - FileTree kann Root-Items aus Cache laden - Reduziert redundante API-Calls f\u00fcr Root-Items - Konsistente Cache-Verwendung</p>"},{"location":"analysis/performance-analysis-loading.html#3-filetree-auto-expand-optimiert-prioritat-2","title":"\u2705 3. FileTree Auto-Expand optimiert (Priorit\u00e4t 2)","text":"<p>\u00c4nderungen: - Cache-Check vor API-Call - Verwendet <code>folderCache</code> statt <code>listItemsById</code> wenn m\u00f6glich - Reduziert API-Calls beim Auto-Expand</p> <p>Datei: <code>src/components/library/file-tree.tsx</code></p> <p>Impact: - Eliminiert redundante API-Calls beim Auto-Expand - Schnellere Pfad-Erweiterung</p>"},{"location":"analysis/performance-analysis-loading.html#4-file-status-debouncing-implementiert-prioritat-2","title":"\u2705 4. File-Status Debouncing implementiert (Priorit\u00e4t 2)","text":"<p>\u00c4nderungen: - 200ms Debounce f\u00fcr file-status Requests in FileRow - Verhindert viele Requests beim schnellen Scrollen oder Rendern - Cleanup bei Unmount</p> <p>Datei: <code>src/components/library/file-list.tsx</code></p> <p>Impact: - Reduziert file-status Requests um ~70-90% bei schnellem Scrollen - Verbessert Netzwerk-Performance - Reduziert Server-Last</p>"},{"location":"analysis/performance-analysis-loading.html#5-request-deduplizierung-verbessert-prioritat-1","title":"\u2705 5. Request-Deduplizierung verbessert (Priorit\u00e4t 1)","text":"<p>\u00c4nderungen: - FileTree verwendet jetzt <code>listItems</code> statt <code>provider.listItemsById</code> - Alle FileTree-Calls gehen durch Deduplizierung - Cache-Check vor API-Calls in FileTree</p> <p>Dateien:  - <code>src/components/library/file-tree.tsx</code> - <code>src/lib/storage/request-deduplicator.ts</code></p> <p>Impact: - Eliminiert doppelte API-Calls f\u00fcr denselben Ordner - Konsistente Request-Deduplizierung \u00fcber alle Komponenten</p>"},{"location":"analysis/performance-analysis-loading.html#6-getpathitemsbyid-optimiert-prioritat-1","title":"\u2705 6. getPathItemsById optimiert (Priorit\u00e4t 1)","text":"<p>\u00c4nderungen: - Zielordner wird jetzt direkt in <code>getPathItemsById</code> zur\u00fcckgegeben - Eliminiert zus\u00e4tzlichen <code>getItemById</code>-Call in <code>useFolderNavigation</code> - Implementiert f\u00fcr alle Provider (filesystem-provider, storage-factory, storage-factory-mongodb, filesystem-client)</p> <p>Dateien: - <code>src/lib/storage/filesystem-provider.ts</code> - <code>src/lib/storage/storage-factory.ts</code> - <code>src/lib/storage/storage-factory-mongodb.ts</code> - <code>src/lib/storage/filesystem-client.ts</code> - <code>src/hooks/use-folder-navigation.ts</code></p> <p>Impact: - Reduziert API-Calls beim Verzeichniswechsel von 3 auf 2 - Schnellere Navigation - Konsistentes Verhalten \u00fcber alle Provider</p>"},{"location":"analysis/performance-analysis-loading.html#7-shadow-twin-analyse-timeout-korrigiert-prioritat-1","title":"\u2705 7. Shadow-Twin-Analyse Timeout korrigiert (Priorit\u00e4t 1)","text":"<p>\u00c4nderungen: - <code>itemsToAnalyze</code> wird jetzt innerhalb des Timeouts berechnet - Verwendet aktuelle Items statt stale Closure-Werte - Verhindert Analysen mit veralteten Item-Listen</p> <p>Datei: <code>src/hooks/use-shadow-twin-analysis.ts</code></p> <p>Impact: - Korrekte Analyse auch bei schnellen Ordnerwechseln - Verhindert Analysen mit falschen Items - Verbessert Datenqualit\u00e4t</p>"},{"location":"analysis/performance-analysis-loading.html#8-race-condition-bei-loaditems-behoben-prioritat-1","title":"\u2705 8. Race-Condition bei loadItems behoben (Priorit\u00e4t 1)","text":"<p>\u00c4nderungen: - <code>setLastLoadedFolder</code> wird jetzt optimistisch gesetzt, bevor der API-Call gemacht wird - Verhindert, dass <code>loadItems</code> zweimal aufgerufen wird - Bei Context-Change wird <code>lastLoadedFolder</code> zur\u00fcckgesetzt</p> <p>Datei: <code>src/components/library/library.tsx</code></p> <p>Impact: - Eliminiert doppelte Zielordner-Requests - Reduziert API-Calls um ~50% bei Navigation</p>"},{"location":"analysis/performance-analysis-loading.html#9-root-items-fur-pfadaufbau-optimiert-prioritat-1","title":"\u2705 9. Root-Items f\u00fcr Pfadaufbau optimiert (Priorit\u00e4t 1)","text":"<p>\u00c4nderungen: - <code>useFolderNavigation</code> baut den Pfad jetzt manuell auf - Verwendet <code>listItems</code> (dedupliziert) statt <code>getPathItemsById</code> - Pr\u00fcft Cache f\u00fcr Root-Items und Ordner im Pfad vor API-Calls</p> <p>Datei: <code>src/hooks/use-folder-navigation.ts</code></p> <p>Impact: - Eliminiert doppelte Root-Requests - Reduziert API-Calls um ~33% bei Navigation - Nutzt Cache effizienter</p>"},{"location":"analysis/performance-analysis-loading.html#nachste-schritte","title":"N\u00e4chste Schritte","text":"<ol> <li>\u2705 Shadow-Twin-Analyse optimieren (Debouncing + Lazy Loading) - FERTIG</li> <li>\u2705 Cache-Strategie vereinheitlichen - FERTIG</li> <li>\u2705 Redundante API-Calls eliminieren: <code>getPathItemsById</code> gibt jetzt Zielordner zur\u00fcck - FERTIG</li> <li>\u2705 File-Status Debouncing implementiert - FERTIG</li> <li>\u2705 Request-Deduplizierung verbessert - FERTIG</li> <li>\u2705 Race-Condition bei loadItems behoben - FERTIG</li> <li>\u2705 Root-Items f\u00fcr Pfadaufbau optimiert - FERTIG</li> <li>\u23f3 Performance messen und validieren</li> <li>\u23f3 Metadaten-Cache implementieren (optional, niedrige Priorit\u00e4t)</li> </ol>"},{"location":"analysis/shadow-twin-processing-status.html","title":"Shadow twin processing status","text":""},{"location":"analysis/shadow-twin-processing-status.html#shadowtwin-processingstatus-analyse-und-fixvarianten","title":"Shadow\u2011Twin <code>processingStatus</code> \u2013 Analyse und Fix\u2011Varianten","text":""},{"location":"analysis/shadow-twin-processing-status.html#istzustand","title":"Ist\u2011Zustand","text":"<ul> <li>Beobachtung TC\u20111.2: <code>shadowTwinState.processingStatus</code> ist <code>null</code>, obwohl der Jobstatus <code>completed</code> ist und ein g\u00fcltiges Transcript (<code>Livique_S\u00f8rensen.md</code>) sowie Bilder im Shadow\u2011Twin\u2011Verzeichnis existieren.  </li> <li>Datenfluss:</li> <li>Beim Job\u2011Start analysiert <code>analyzeShadowTwin</code> die Datei und <code>start/route.ts</code> setzt <code>processingStatus: 'processing'</code> \u00fcber <code>toMongoShadowTwinState({ ...shadowTwinState, processingStatus: 'processing' })</code>.</li> <li>Im Extract\u2011Only\u2011Pfad speichert <code>runExtractOnly</code> zuerst das Transcript\u2011Markdown und ruft danach erneut <code>analyzeShadowTwin</code> auf; das Ergebnis wird aktuell mit <code>toMongoShadowTwinState(updatedShadowTwinState)</code> gespeichert \u2013 ohne <code>processingStatus</code>. Dadurch kann ein zuvor gesetzter Status \u00fcberschrieben werden.</li> <li>Am Ende von <code>runExtractOnly</code> wird versucht, den Status mit einem separaten <code>repo.get(jobId)</code> nochmals auf <code>'ready'</code> zu setzen; Fehler in diesem Block werden jedoch stumm geschluckt.</li> <li>Problem: Der Status wird de facto in zwei Schritten verwaltet (Start\u2011Route und Extract\u2011Only\u2011Finalisierung). Ein sp\u00e4teres \u00dcberschreiben ohne <code>processingStatus</code> plus ein potentiell fehlschlagender, stumm gefangener Update\u2011Versuch erkl\u00e4ren, warum in einzelnen Jobs <code>processingStatus</code> auf <code>null</code> bzw. <code>undefined</code> landet.</li> </ul>"},{"location":"analysis/shadow-twin-processing-status.html#varianten-fur-einen-fix","title":"Varianten f\u00fcr einen Fix","text":"<ul> <li>Variante A \u2013 Minimaler, lokaler Fix in <code>runExtractOnly</code> (empfohlen) </li> <li>Beim Neuberechnen des Shadow\u2011Twin\u2011States nach dem Speichern des Transcripts (<code>analyzeShadowTwin</code> in <code>runExtractOnly</code>) wird der Status direkt auf <code>'ready'</code> gesetzt:  <ul> <li><code>const mongoState = toMongoShadowTwinState({ ...updatedShadowTwinState, processingStatus: 'ready' })</code>.  </li> </ul> </li> <li>Der abschlie\u00dfende Block, der nochmals <code>processingStatus: 'ready'</code> setzt, bleibt als idempotente Absicherung erhalten.  </li> <li>Vorteile: Sehr kleiner Eingriff, keine \u00c4nderungen an Start\u2011Route oder Callback\u2011Route, garantiert f\u00fcr alle k\u00fcnftigen Extract\u2011Only\u2011Jobs einen konsistenten <code>processingStatus: 'ready'</code>.  </li> <li> <p>Nachteile: Semantisch wird der Status bereits vor Abschluss der Bilder\u2011Verarbeitung auf <code>'ready'</code> gesetzt \u2013 in der Praxis tolerierbar, da Bild\u2011Fehler ohnehin nicht fatal sind und der Jobstatus selbst auf <code>completed</code> gesetzt wird.</p> </li> <li> <p>Variante B \u2013 Zentrale Helper\u2011Funktion f\u00fcr Shadow\u2011Twin\u2011Status </p> </li> <li>Einf\u00fchrung eines Helpers <code>updateShadowTwinProcessingStatus(jobId, status)</code>, der:<ul> <li>den aktuellen Job l\u00e4dt (<code>repo.get</code>),</li> <li>vorhandenen <code>shadowTwinState</code> mit <code>processingStatus: status</code> merged und</li> <li>\u00fcber <code>setShadowTwinState</code> speichert.  </li> </ul> </li> <li>Verwendung dieses Helpers an allen Stellen, an denen heute der Status direkt gesetzt wird (<code>start/route.ts</code>, <code>extract-only.ts</code>, <code>route.ts</code>).  </li> <li>Vorteile: Einheitliche Statuslogik, klarere Verantwortlichkeit, weniger Risiko f\u00fcr inkonsistente Updates.  </li> <li> <p>Nachteile: Gr\u00f6\u00dferer Refactor, mehr ber\u00fchrte Dateien, h\u00f6heres Risiko f\u00fcr Regressionen \u2013 nicht ideal f\u00fcr einen ersten gezielten Bugfix.</p> </li> <li> <p>Variante C \u2013 UI\u2011seitige Toleranz + Logging </p> </li> <li>Im Frontend (<code>job-report-tab.tsx</code>) w\u00fcrde <code>processingStatus === null</code> wie <code>undefined</code> behandelt werden (<code>isReady</code> auch bei <code>null</code> true).  </li> <li>Serverseitig w\u00fcrde zus\u00e4tzlich Logging erg\u00e4nzt, falls das finale Setzen von <code>'ready'</code> in <code>runExtractOnly</code> fehlschl\u00e4gt.  </li> <li>Vorteile: Behebt kurzfristig Anzeige\u2011Probleme f\u00fcr historische Jobs.  </li> <li>Nachteile: L\u00e4sst die inkonsistente Datenlage in MongoDB unangetastet und verbessert die Traceability nicht \u2013 entspricht nicht dem Ziel \u201ekorrekte und saubere Statuskommunikation\u201c.</li> </ul>"},{"location":"analysis/shadow-twin-processing-status.html#entscheidung","title":"Entscheidung","text":"<ul> <li>F\u00fcr den aktuellen Durchgang wird Variante A umgesetzt:  </li> <li>Sie ist lokal (nur <code>runExtractOnly</code>), \u00e4ndert keine externen APIs und keine anderen Phasen.  </li> <li>Sie sorgt daf\u00fcr, dass Shadow\u2011Twin\u2011States f\u00fcr reine Extract\u2011Jobs deterministisch mit <code>processingStatus: 'ready'</code> geschrieben werden, sobald das Transcript erfolgreich im Shadow\u2011Twin\u2011Verzeichnis gespeichert wurde.  </li> <li>Der bestehende Abschluss\u2011Block bleibt als zus\u00e4tzliche, idempotente Absicherung bestehen.</li> </ul>"},{"location":"architecture/dependency-graph.html","title":"Dependency Graph","text":"<p>Visual representation of module dependencies in the Common Knowledge Scout application.</p>"},{"location":"architecture/dependency-graph.html#mermaid-dependency-graph","title":"Mermaid Dependency Graph","text":"<pre><code>graph TB\n    subgraph \"Layer 1: Core Infrastructure\"\n        MW[middleware.ts]\n        LAYOUT[app/layout.tsx]\n        INST[instrumentation.ts]\n        ENV[lib/env.ts]\n        AUTH[lib/auth.ts]\n        DB[lib/mongodb-service.ts]\n    end\n\n    subgraph \"Layer 2: Storage Layer\"\n        STYPES[lib/storage/types.ts]\n        SFACTORY[lib/storage/storage-factory.ts]\n        FSPROVIDER[lib/storage/filesystem-provider.ts]\n        ODPROVIDER[lib/storage/onedrive-provider.ts]\n        SERVERPROV[lib/storage/server-provider.ts]\n        SCONTEXT[contexts/storage-context.tsx]\n        USEPROV[hooks/use-storage-provider.tsx]\n    end\n\n    subgraph \"Layer 3: Library System\"\n        LTYPES[types/library.ts]\n        LATOMS[atoms/library-atom.ts]\n        LSERVICE[lib/services/library-service.ts]\n        LIBCOMP[components/library/library.tsx]\n    end\n\n    subgraph \"Layer 4: Chat System\"\n        CTYPES[types/chat.ts]\n        CCONST[lib/chat/constants.ts]\n        CORCH[lib/chat/orchestrator.ts]\n        CLOADER[lib/chat/loader.ts]\n        CSTREAM[app/api/chat/.../stream/route.ts]\n    end\n\n    subgraph \"Layer 5: API Routes &amp; Components\"\n        APIROUTES[app/api/**/*.ts]\n        COMPONENTS[components/**/*.tsx]\n    end\n\n    %% Core Infrastructure (no dependencies)\n\n    %% Storage Layer dependencies\n    SFACTORY --&gt; STYPES\n    SFACTORY --&gt; FSPROVIDER\n    SFACTORY --&gt; ODPROVIDER\n    FSPROVIDER --&gt; STYPES\n    ODPROVIDER --&gt; STYPES\n    ODPROVIDER --&gt; LTYPES\n    SERVERPROV --&gt; SFACTORY\n    SERVERPROV --&gt; LSERVICE\n    SERVERPROV --&gt; ENV\n    SCONTEXT --&gt; SFACTORY\n    SCONTEXT --&gt; LATOMS\n    USEPROV --&gt; LATOMS\n    USEPROV --&gt; SFACTORY\n\n    %% Library System dependencies\n    LATOMS --&gt; LTYPES\n    LATOMS --&gt; STYPES\n    LSERVICE --&gt; DB\n    LSERVICE --&gt; LTYPES\n    LIBCOMP --&gt; SCONTEXT\n    LIBCOMP --&gt; LATOMS\n\n    %% Chat System dependencies\n    CORCH --&gt; CLOADER\n    CORCH --&gt; CCONST\n    CORCH --&gt; CTYPES\n    CLOADER --&gt; LSERVICE\n    CLOADER --&gt; DB\n    CSTREAM --&gt; CORCH\n    CSTREAM --&gt; CLOADER\n    CSTREAM --&gt; CCONST\n\n    %% API Routes dependencies\n    APIROUTES --&gt; LSERVICE\n    APIROUTES --&gt; SFACTORY\n    APIROUTES --&gt; DB\n    APIROUTES --&gt; CORCH\n\n    %% Components dependencies\n    COMPONENTS --&gt; SCONTEXT\n    COMPONENTS --&gt; LATOMS\n    COMPONENTS --&gt; LIBCOMP</code></pre>"},{"location":"architecture/dependency-graph.html#dependency-layers","title":"Dependency Layers","text":""},{"location":"architecture/dependency-graph.html#layer-1-core-infrastructure","title":"Layer 1: Core Infrastructure","text":"<ul> <li>No internal dependencies</li> <li>Provides foundational services (auth, database, env)</li> <li>Used by all other layers</li> </ul>"},{"location":"architecture/dependency-graph.html#layer-2-storage-layer","title":"Layer 2: Storage Layer","text":"<ul> <li>Depends on: Layer 1 (env, auth, db)</li> <li>Provides: Storage abstraction</li> <li>Used by: Layer 3 (Library System), Layer 5 (API Routes)</li> </ul>"},{"location":"architecture/dependency-graph.html#layer-3-library-system","title":"Layer 3: Library System","text":"<ul> <li>Depends on: Layer 2 (Storage Layer)</li> <li>Provides: Library management and UI</li> <li>Used by: Layer 4 (Chat System), Layer 5 (Components)</li> </ul>"},{"location":"architecture/dependency-graph.html#layer-4-chat-system","title":"Layer 4: Chat System","text":"<ul> <li>Depends on: Layer 3 (Library System), Layer 2 (Storage)</li> <li>Provides: RAG-based chat functionality</li> <li>Used by: Layer 5 (API Routes, Components)</li> </ul>"},{"location":"architecture/dependency-graph.html#layer-5-api-routes-components","title":"Layer 5: API Routes &amp; Components","text":"<ul> <li>Depends on: All previous layers</li> <li>Provides: User-facing interfaces</li> <li>No dependencies from other modules</li> </ul>"},{"location":"architecture/dependency-graph.html#key-dependencies","title":"Key Dependencies","text":""},{"location":"architecture/dependency-graph.html#most-imported-modules","title":"Most Imported Modules","text":"<ol> <li><code>@/lib/storage/storage-factory.ts</code> - Used by contexts, API routes, components</li> <li><code>@/lib/storage/types.ts</code> - Used by all storage-related files</li> <li><code>@/lib/services/library-service.ts</code> - Used by API routes, storage, chat</li> <li><code>@/types/library.ts</code> - Used throughout the application</li> <li><code>@/lib/mongodb-service.ts</code> - Used by services and repositories</li> </ol>"},{"location":"architecture/dependency-graph.html#critical-paths","title":"Critical Paths","text":"<ul> <li>Storage Access: <code>components</code> \u2192 <code>contexts/storage-context</code> \u2192 <code>storage-factory</code> \u2192 <code>providers</code></li> <li>Chat Flow: <code>api/chat/stream</code> \u2192 <code>chat/orchestrator</code> \u2192 <code>chat/loader</code> \u2192 <code>library-service</code> \u2192 <code>mongodb-service</code></li> <li>Library Management: <code>components/library</code> \u2192 <code>atoms/library-atom</code> \u2192 <code>services/library-service</code> \u2192 <code>mongodb-service</code></li> </ul>"},{"location":"architecture/dependency-graph.html#circular-dependencies","title":"Circular Dependencies","text":""},{"location":"architecture/dependency-graph.html#potential-issues-to-verify","title":"Potential Issues (To Verify)","text":"<ol> <li>Storage Factory \u2194 Providers: Factory creates providers, providers may reference factory</li> <li>Library Service \u2194 Storage Factory: Service uses storage, storage may reference library types</li> <li>Chat Orchestrator \u2194 Chat Loader: Orchestrator uses loader, loader may use orchestrator utilities</li> </ol>"},{"location":"architecture/dependency-graph.html#notes","title":"Notes","text":"<ul> <li>Dependencies flow downward (Layer 1 \u2192 Layer 5)</li> <li>Each layer can only depend on layers below it</li> <li>Type definitions (types/) have no runtime dependencies</li> <li>Components depend on hooks, contexts, and library code</li> <li>API routes depend on services, storage, and chat systems</li> </ul>"},{"location":"architecture/module-hierarchy.html","title":"Module Hierarchy","text":"<p>Visual representation of the Common Knowledge Scout module organization and dependencies.</p>"},{"location":"architecture/module-hierarchy.html#module-tree","title":"Module Tree","text":"<pre><code>Common Knowledge Scout\n\u2502\n\u251c\u2500\u2500 Core Infrastructure (Layer 1)\n\u2502   \u251c\u2500\u2500 middleware.ts\n\u2502   \u2502   \u2514\u2500\u2500 Authentication &amp; Routing\n\u2502   \u251c\u2500\u2500 app/layout.tsx\n\u2502   \u2502   \u2514\u2500\u2500 Root Layout &amp; Providers\n\u2502   \u251c\u2500\u2500 instrumentation.ts\n\u2502   \u2502   \u2514\u2500\u2500 External Jobs Worker Startup\n\u2502   \u2514\u2500\u2500 lib/\n\u2502       \u251c\u2500\u2500 env.ts\n\u2502       \u2502   \u2514\u2500\u2500 Environment Variables\n\u2502       \u251c\u2500\u2500 auth.ts\n\u2502       \u2502   \u2514\u2500\u2500 Authentication Helpers\n\u2502       \u2514\u2500\u2500 mongodb-service.ts\n\u2502           \u2514\u2500\u2500 Database Connection\n\u2502\n\u251c\u2500\u2500 Storage Layer (Layer 2)\n\u2502   \u251c\u2500\u2500 lib/storage/\n\u2502   \u2502   \u251c\u2500\u2500 types.ts\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 Type Definitions\n\u2502   \u2502   \u251c\u2500\u2500 storage-factory.ts\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 LocalStorageProvider\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 StorageFactory\n\u2502   \u2502   \u251c\u2500\u2500 filesystem-provider.ts\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 FileSystemProvider\n\u2502   \u2502   \u251c\u2500\u2500 onedrive-provider.ts\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 OneDriveProvider\n\u2502   \u2502   \u251c\u2500\u2500 onedrive-provider-server.ts\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 OneDriveServerProvider\n\u2502   \u2502   \u251c\u2500\u2500 filesystem-client.ts\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 FilesystemClient\n\u2502   \u2502   \u251c\u2500\u2500 server-provider.ts\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 Server Provider Helper\n\u2502   \u2502   \u251c\u2500\u2500 storage-factory-mongodb.ts\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 MongoDBStorageFactory\n\u2502   \u2502   \u251c\u2500\u2500 storage-service.ts\n\u2502   \u2502   \u251c\u2500\u2500 shadow-twin.ts\n\u2502   \u2502   \u2514\u2500\u2500 supported-types.ts\n\u2502   \u251c\u2500\u2500 contexts/storage-context.tsx\n\u2502   \u2502   \u2514\u2500\u2500 StorageContextProvider\n\u2502   \u2514\u2500\u2500 hooks/use-storage-provider.tsx\n\u2502       \u2514\u2500\u2500 useStorageProvider Hook\n\u2502\n\u251c\u2500\u2500 Library System (Layer 3)\n\u2502   \u251c\u2500\u2500 types/library.ts\n\u2502   \u2502   \u2514\u2500\u2500 Library Type Definitions\n\u2502   \u251c\u2500\u2500 atoms/library-atom.ts\n\u2502   \u2502   \u2514\u2500\u2500 Library State Atoms\n\u2502   \u251c\u2500\u2500 lib/services/library-service.ts\n\u2502   \u2502   \u2514\u2500\u2500 LibraryService\n\u2502   \u2514\u2500\u2500 components/library/\n\u2502       \u251c\u2500\u2500 library.tsx\n\u2502       \u2502   \u2514\u2500\u2500 Main Library Component\n\u2502       \u251c\u2500\u2500 library-header.tsx\n\u2502       \u251c\u2500\u2500 library-switcher.tsx\n\u2502       \u251c\u2500\u2500 file-tree.tsx\n\u2502       \u251c\u2500\u2500 file-list.tsx\n\u2502       \u251c\u2500\u2500 file-preview.tsx\n\u2502       \u2514\u2500\u2500 ... (other library components)\n\u2502\n\u251c\u2500\u2500 Chat System (Layer 4)\n\u2502   \u251c\u2500\u2500 types/chat.ts\n\u2502   \u2502   \u2514\u2500\u2500 Chat Type Definitions\n\u2502   \u251c\u2500\u2500 lib/chat/\n\u2502   \u2502   \u251c\u2500\u2500 constants.ts\n\u2502   \u2502   \u251c\u2500\u2500 orchestrator.ts\n\u2502   \u2502   \u251c\u2500\u2500 loader.ts\n\u2502   \u2502   \u251c\u2500\u2500 config.ts\n\u2502   \u2502   \u251c\u2500\u2500 common/\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 prompt.ts\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 filters.ts\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 llm.ts\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 question-analyzer.ts\n\u2502   \u2502   \u2514\u2500\u2500 retrievers/\n\u2502   \u2502       \u251c\u2500\u2500 chunks.ts\n\u2502   \u2502       \u2514\u2500\u2500 summaries-mongo.ts\n\u2502   \u251c\u2500\u2500 app/api/chat/[libraryId]/\n\u2502   \u2502   \u2514\u2500\u2500 stream/route.ts\n\u2502   \u2514\u2500\u2500 components/library/chat/\n\u2502       \u2514\u2500\u2500 ... (chat components)\n\u2502\n\u2514\u2500\u2500 API Routes &amp; Components (Layer 5)\n    \u251c\u2500\u2500 app/api/\n    \u2502   \u251c\u2500\u2500 storage/\n    \u2502   \u251c\u2500\u2500 chat/\n    \u2502   \u251c\u2500\u2500 libraries/\n    \u2502   \u251c\u2500\u2500 external/jobs/\n    \u2502   \u2514\u2500\u2500 ... (other API routes)\n    \u2514\u2500\u2500 components/\n        \u251c\u2500\u2500 ui/ (Shadcn UI components)\n        \u251c\u2500\u2500 shared/\n        \u2514\u2500\u2500 ... (other components)\n</code></pre>"},{"location":"architecture/module-hierarchy.html#dependency-flow","title":"Dependency Flow","text":"<pre><code>Layer 1 (Core Infrastructure)\n    \u2193\nLayer 2 (Storage Layer)\n    \u2193\nLayer 3 (Library System)\n    \u2193\nLayer 4 (Chat System)\n    \u2193\nLayer 5 (API Routes &amp; Components)\n</code></pre>"},{"location":"architecture/module-hierarchy.html#module-descriptions","title":"Module Descriptions","text":""},{"location":"architecture/module-hierarchy.html#core-infrastructure","title":"Core Infrastructure","text":"<p>Foundation layer providing authentication, database, and environment configuration. No internal dependencies.</p>"},{"location":"architecture/module-hierarchy.html#storage-layer","title":"Storage Layer","text":"<p>Abstracts file storage operations across multiple backends (local filesystem, OneDrive). Depends on Core Infrastructure.</p>"},{"location":"architecture/module-hierarchy.html#library-system","title":"Library System","text":"<p>Manages library data and provides UI components for file browsing and management. Depends on Storage Layer.</p>"},{"location":"architecture/module-hierarchy.html#chat-system","title":"Chat System","text":"<p>Provides RAG-based chat functionality for knowledge exploration. Depends on Library System and Storage Layer.</p>"},{"location":"architecture/module-hierarchy.html#api-routes-components","title":"API Routes &amp; Components","text":"<p>User-facing API endpoints and React components. Depends on all previous layers.</p>"},{"location":"architecture/module-hierarchy.html#key-principles","title":"Key Principles","text":"<ol> <li>Layered Architecture: Each layer depends only on layers below it</li> <li>Dependency Injection: Higher layers receive dependencies from lower layers</li> <li>Type Safety: TypeScript interfaces ensure contract compliance</li> <li>Separation of Concerns: Each module has a single, well-defined responsibility</li> </ol>"},{"location":"architecture/mongodb-vector-search.html","title":"MongoDB Vector Search Architektur","text":""},{"location":"architecture/mongodb-vector-search.html#ubersicht","title":"\u00dcbersicht","text":"<p>Die Anwendung verwendet MongoDB Atlas Vector Search f\u00fcr semantische Suche und RAG (Retrieval-Augmented Generation). Alle Vektoren werden in MongoDB gespeichert, keine externe Vector-Datenbank ist mehr erforderlich.</p>"},{"location":"architecture/mongodb-vector-search.html#architektur-prinzipien","title":"Architektur-Prinzipien","text":""},{"location":"architecture/mongodb-vector-search.html#collection-struktur","title":"Collection-Struktur","text":"<ul> <li>Pro Library eine Collection: <code>vectors__${libraryId}</code></li> <li>Alle Dokument-Typen in derselben Collection: Meta-Dokumente, Chunks und Chapter-Summaries</li> <li>Unterscheidung durch <code>kind</code>-Feld: <code>'meta'</code>, <code>'chunk'</code>, <code>'chapterSummary'</code></li> </ul>"},{"location":"architecture/mongodb-vector-search.html#hybrid-ansatz","title":"Hybrid-Ansatz","text":"<ul> <li>Meta-Dokumente (<code>kind: 'meta'</code>): Enthalten vollst\u00e4ndige Metadaten, keine Embeddings</li> <li>Verwendet f\u00fcr Gallery-Anzeige, Facetten-Aggregation</li> <li>Enth\u00e4lt <code>docMetaJson</code>, <code>chapters</code>, Facetten-Metadaten</li> <li>Chunk-Dokumente (<code>kind: 'chunk'</code>): Enthalten Text-Chunks mit Embeddings</li> <li>Verwendet f\u00fcr semantische Suche</li> <li>Facetten-Metadaten werden kopiert f\u00fcr direkte Filterung</li> <li>ChapterSummary-Dokumente (<code>kind: 'chapterSummary'</code>): Enthalten Kapitel-Summaries mit Embeddings</li> <li>Verwendet f\u00fcr Kapitel-basierte Suche</li> </ul>"},{"location":"architecture/mongodb-vector-search.html#vector-search-index","title":"Vector Search Index","text":""},{"location":"architecture/mongodb-vector-search.html#automatisches-setup","title":"Automatisches Setup","text":"<ul> <li>Index wird automatisch beim ersten Zugriff erstellt</li> <li>Verwendet MongoDB Admin API: <code>db.admin().command({ createSearchIndexes: ... })</code></li> <li>Index-Name: <code>vector_search_idx</code> (pro Collection)</li> </ul>"},{"location":"architecture/mongodb-vector-search.html#index-definition","title":"Index-Definition","text":"<pre><code>{\n  \"name\": \"vector_search_idx\",\n  \"definition\": {\n    \"mappings\": {\n      \"dynamic\": true,\n      \"fields\": {\n        \"embedding\": {\n          \"type\": \"knnVector\",\n          \"dimensions\": 1024,  // Aus Library-Config\n          \"similarity\": \"cosine\"\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"architecture/mongodb-vector-search.html#zusatzliche-indizes","title":"Zus\u00e4tzliche Indizes","text":"<ul> <li><code>libraryId</code>: Index f\u00fcr Library-Filterung</li> <li><code>fileId</code>: Index f\u00fcr File-Filterung</li> <li><code>kind</code>: Index f\u00fcr Dokument-Typ-Filterung</li> <li><code>user</code>: Index f\u00fcr User-Filterung</li> <li>Facetten-Indizes: Automatisch erstellt via <code>ensureFacetIndexes()</code></li> </ul>"},{"location":"architecture/mongodb-vector-search.html#query-patterns","title":"Query-Patterns","text":""},{"location":"architecture/mongodb-vector-search.html#vector-search-query","title":"Vector Search Query","text":"<pre><code>const pipeline = [\n  {\n    $vectorSearch: {\n      index: 'vector_search_idx',\n      path: 'embedding',\n      queryVector: queryVector,\n      numCandidates: Math.max(topK * 10, 100),\n      limit: topK,\n      filter: {\n        kind: { $in: ['chunk', 'chapterSummary'] },\n        libraryId: { $eq: libraryId },\n        user: { $eq: userEmail },\n        // Direkte Facetten-Filterung\n        year: { $in: [2023, 2024] },\n        authors: { $in: ['Author1'] },\n      }\n    }\n  },\n  {\n    $project: {\n      _id: 1,\n      score: { $meta: 'vectorSearchScore' },\n      // ... Metadaten\n    }\n  }\n]\n</code></pre>"},{"location":"architecture/mongodb-vector-search.html#direkte-mongodb-abfrage-ohne-vector-search","title":"Direkte MongoDB-Abfrage (ohne Vector Search)","text":"<pre><code>// F\u00fcr chunkSummary-Retriever oder Nachbar-Chunks\nconst chunks = await collection.find({\n  kind: 'chunk',\n  libraryId,\n  user,\n  fileId: { $in: fileIds },\n}).sort({ fileId: 1, chunkIndex: 1 }).toArray()\n</code></pre>"},{"location":"architecture/mongodb-vector-search.html#facetten-metadaten-duplikation","title":"Facetten-Metadaten-Duplikation","text":""},{"location":"architecture/mongodb-vector-search.html#strategie","title":"Strategie","text":"<ul> <li>Facetten-Metadaten werden in jeden Chunk und ChapterSummary kopiert</li> <li>Erm\u00f6glicht direkte Filterung w\u00e4hrend Vector Search</li> <li>Keine separate MongoDB-Query f\u00fcr FileIDs n\u00f6tig</li> </ul>"},{"location":"architecture/mongodb-vector-search.html#beispiel","title":"Beispiel","text":"<pre><code>// Meta-Dokument\n{\n  _id: 'file123-meta',\n  kind: 'meta',\n  year: 2024,\n  authors: ['Author1', 'Author2'],\n  // ... keine embedding\n}\n\n// Chunk-Dokument (mit kopierten Facetten)\n{\n  _id: 'file123-0',\n  kind: 'chunk',\n  embedding: [0.123, ...],\n  year: 2024,  // Kopiert aus Meta\n  authors: ['Author1', 'Author2'],  // Kopiert aus Meta\n  // ...\n}\n</code></pre>"},{"location":"architecture/mongodb-vector-search.html#performance-optimierungen","title":"Performance-Optimierungen","text":"<ol> <li>Direkte Filterung: Facetten-Filter werden direkt in <code>$vectorSearch</code> angewendet</li> <li>Batch-Upsert: Vektoren werden in Batches von 1000 upsertet</li> <li>Meta-Dokumente: Keine Embeddings sparen Speicher</li> <li>Index-Caching: Collection- und Index-Cache f\u00fcr bessere Performance</li> <li>Nachbar-Chunks: Direkte MongoDB-Abfrage statt separater Fetch-API</li> </ol>"},{"location":"architecture/mongodb-vector-search.html#migration-von-pinecone","title":"Migration von Pinecone","text":""},{"location":"architecture/mongodb-vector-search.html#vorteile","title":"Vorteile","text":"<ul> <li>\u2705 Keine externe Vector-Datenbank erforderlich</li> <li>\u2705 Alle Daten in einer Datenbank (MongoDB)</li> <li>\u2705 Direkte Filterung in Vector Search</li> <li>\u2705 Konsistente Datenstruktur</li> <li>\u2705 Einfacheres Deployment (eine Datenbank)</li> </ul>"},{"location":"architecture/mongodb-vector-search.html#unterschiede","title":"Unterschiede","text":"<ul> <li>Collection statt Index: Pro Library eine Collection statt Index</li> <li>Meta-Dokumente: Separate Dokumente ohne Embeddings</li> <li>Facetten-Duplikation: Metadaten werden in Chunks kopiert</li> <li>Query-Pattern: <code>$vectorSearch</code> Aggregation statt REST API</li> </ul>"},{"location":"architecture/mongodb-vector-search.html#repository-pattern","title":"Repository-Pattern","text":""},{"location":"architecture/mongodb-vector-search.html#srclibrepositoriesvector-repots","title":"<code>src/lib/repositories/vector-repo.ts</code>","text":"<ul> <li>Zentrale Abstraktion f\u00fcr alle Vector Search Operationen</li> <li>Funktionen:</li> <li><code>getVectorCollection()</code>: Collection-Zugriff mit automatischem Index-Setup</li> <li><code>upsertVectors()</code>: Batch-Upsert von Vektoren</li> <li><code>upsertVectorMeta()</code>: Upsert von Meta-Dokumenten</li> <li><code>queryVectors()</code>: Vector Search Query mit Filterung</li> <li><code>findDocs()</code>: Findet Meta-Dokumente f\u00fcr Gallery</li> <li><code>aggregateFacets()</code>: Aggregiert Facetten aus Meta-Dokumenten</li> </ul>"},{"location":"architecture/mongodb-vector-search.html#code-referenzen","title":"Code-Referenzen","text":"<ul> <li>Repository: <code>src/lib/repositories/vector-repo.ts</code></li> <li>Ingestion: <code>src/lib/chat/ingestion-service.ts</code></li> <li>Retriever: <code>src/lib/chat/retrievers/chunks.ts</code></li> <li>ChunkSummary-Retriever: <code>src/lib/chat/retrievers/chunk-summary.ts</code></li> </ul>"},{"location":"architecture/mongodb-vector-search.html#weitere-informationen","title":"Weitere Informationen","text":"<ul> <li>Siehe <code>docs/_analysis/mongodb-vector-search-ingestion-analysis.md</code> f\u00fcr detaillierte Ingestion-Analyse</li> <li>Siehe <code>docs/_analysis/chat-orchestration-flow.md</code> f\u00fcr Retrieval-Flow</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html","title":"PDF Transformation Phases","text":""},{"location":"architecture/pdf-transformation-phases.html#overview","title":"Overview","text":"<p>PDF transformation consists of three sequential phases that convert a PDF file into a searchable, structured document ready for RAG (Retrieval Augmented Generation). Each phase builds upon the previous one, creating intermediate artifacts that can be reused or skipped based on policies.</p> <p>In the current implementation (IST), these three phases are not executed via three separate HTTP endpoints, but through a combination of:</p> <ul> <li>Worker: <code>src/lib/external-jobs-worker.ts</code> \u2013 polls jobs and calls the start route</li> <li>Start route: <code>src/app/api/external/jobs/[jobId]/start/route.ts</code> \u2013 initializes the job and starts Phase 1 (Extract) or an ingest-only path</li> <li>Secretary Service (external) \u2013 performs PDF/OCR/template transformation and sends webhooks back</li> <li>Callback route: <code>src/app/api/external/jobs/[jobId]/route.ts</code> \u2013 processes webhooks and orchestrates Phase 1\u20133 (Extract, Template, Ingestion)</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#runtime-orchestration-high-level","title":"Runtime Orchestration (high level)","text":"<pre><code>Worker (jobs queue)\n  \u2193 POST /api/external/jobs/{jobId}/start\nStart route\n  - loads PDF from storage\n  - decides Extract/Template/Ingest-only via gates + policies\n  - calls Secretary Service (PDF/OCR)\n  \u2193 Webhook: POST /api/external/jobs/{jobId}\nSecretary Service (external)\n  - extracts text/images\n  - sends extracted_text, pages_archive_url, mistral_ocr_raw_url, ...\n  \u2193\nCallback route\n  - processes extract result (Phase 1)\n  - runs or skips template phase (Phase 2)\n  - runs or skips ingestion (Phase 3)\n</code></pre>"},{"location":"architecture/pdf-transformation-phases.html#phase-1-extract-extraction","title":"Phase 1: Extract (Extraction)","text":""},{"location":"architecture/pdf-transformation-phases.html#purpose","title":"Purpose","text":"<p>Extract text and images from PDF files using OCR or native text extraction.</p>"},{"location":"architecture/pdf-transformation-phases.html#what-happens","title":"What Happens","text":"<ol> <li>PDF Processing:</li> <li>PDF file is sent to Secretary Service</li> <li>Text extraction via native PDF parsing or OCR (Mistral OCR)</li> <li> <p>Image extraction (if enabled)</p> </li> <li> <p>Image Processing:</p> </li> <li>Mistral OCR images: Extracted via <code>mistral_ocr_images_url</code> (ZIP archive) - separate from <code>mistral_ocr_raw</code></li> <li>PDF page images: Extracted as ZIP archive (<code>pages_archive_url</code> or <code>pages_archive_data</code>)</li> <li>Images saved to Shadow-Twin directory (if present)</li> <li> <p>Note: Asynchronous webhook sends <code>mistral_ocr_raw_url</code> and <code>mistral_ocr_raw_metadata</code> only. Full <code>mistral_ocr_raw</code> data must be downloaded via <code>GET /api/pdf/jobs/{job_id}/mistral-ocr-raw</code></p> </li> <li> <p>Markdown Creation:</p> </li> <li>Extracted text saved as Markdown without frontmatter</li> <li>File name: <code>{originalName}.md</code> (no language suffix - transcript)</li> </ol>"},{"location":"architecture/pdf-transformation-phases.html#input","title":"Input","text":"<ul> <li>PDF file (<code>document.pdf</code>)</li> <li>Extraction method (<code>native</code> or <code>mistral_ocr</code>)</li> <li>Target language (for OCR)</li> <li>Image extraction flags (<code>includeOcrImages</code>, <code>includePageImages</code>)</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#output","title":"Output","text":"<ul> <li>Transcript File: <code>document.md</code> (Markdown without frontmatter)</li> <li>Images: Saved to <code>.document.pdf/</code> directory (if images extracted)</li> <li>Shadow-Twin Directory: Created automatically if images are present</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#code-references-ist","title":"Code References (IST)","text":"<ul> <li>Worker &amp; routes</li> <li><code>src/lib/external-jobs-worker.ts</code>: Background worker that polls jobs from the queue and triggers the start route (<code>POST /api/external/jobs/[jobId]/start</code>)</li> <li><code>src/app/api/external/jobs/[jobId]/start/route.ts</code>: Start route; loads the PDF from storage, sets watchdog/steps, calls Secretary Service (standard or Mistral OCR endpoint) and can run an ingest-only flow</li> <li><code>src/app/api/external/jobs/[jobId]/route.ts</code>: Callback route; processes webhooks from Secretary Service (including <code>extracted_text</code>, <code>pages_archive_url</code>, <code>mistral_ocr_raw_url</code>) and decides whether to run Extract-only, Extract+Template+Ingest or a skip path</li> <li>Extract-Phase (Core-Module)</li> <li><code>src/lib/external-jobs/extract-only.ts</code>: Extract-only processing logic (Transcript speichern, Bilder verarbeiten, Job abschlie\u00dfen)</li> <li><code>src/lib/external-jobs/images.ts</code>: Image extraction and processing (pages-Archive, images-Archive, Mistral OCR)</li> <li><code>src/lib/external-jobs/storage.ts</code>: Markdown storage in the shadow twin or parent folder</li> <li><code>src/lib/processing/gates.ts</code> (<code>gateExtractPdf</code>): Gate that checks whether a shadow twin (transcript or transformed) already exists and allows Extract to be skipped</li> <li><code>src/lib/transform/image-extraction-service.ts</code>: Image extraction service (deeper image-processing pipeline)</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#execution-in-code-ist","title":"Execution in Code (IST)","text":"<ul> <li>Start route</li> <li>Loads the PDF from storage via <code>getServerProvider</code>.</li> <li>Runs preprocessing and initializes steps (<code>extract_pdf</code>, <code>transform_template</code>, <code>ingest_rag</code>).</li> <li>Calls <code>gateExtractPdf</code> and phase policies to decide:<ul> <li>whether Extract should actually be sent to Secretary Service (<code>runExtract</code>),</li> <li>whether only Template/Ingestion should run,</li> <li>whether an ingest-only path without a new Secretary call is possible.</li> </ul> </li> <li> <p>When <code>runExtract</code> is true, sends an HTTP request to Secretary Service (<code>/api/pdf/process</code> or <code>/api/pdf/process-mistral-ocr</code>) with <code>callback_url</code> = <code>/api/external/jobs/{jobId}</code>.</p> </li> <li> <p>Callback route</p> </li> <li>Receives webhooks with <code>extracted_text</code> and image archives.</li> <li>Marks <code>extract_pdf</code> as completed as soon as a stable OCR result is available.</li> <li>If template and ingest phases are explicitly disabled, calls <code>runExtractOnly</code>, stores the transcript without frontmatter and optionally processes images.</li> <li>In all other cases it only ensures that Phase 1 is completed and passes the results to the template/ingestion logic.</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#example-output","title":"Example Output","text":"<pre><code>.document.pdf/\n\u251c\u2500\u2500 document.md          (Transcript - extracted text, no frontmatter)\n\u251c\u2500\u2500 page-001.png        (Extracted images)\n\u2514\u2500\u2500 page-002.png\n</code></pre>"},{"location":"architecture/pdf-transformation-phases.html#phase-2-template-metadata","title":"Phase 2: Template (Metadata)","text":""},{"location":"architecture/pdf-transformation-phases.html#purpose_1","title":"Purpose","text":"<p>Add structured metadata (frontmatter) to the extracted text, enabling structured queries and RAG integration.</p>"},{"location":"architecture/pdf-transformation-phases.html#what-happens_1","title":"What Happens","text":"<ol> <li>Template Processing:</li> <li>Transcript Markdown (<code>document.md</code>) is sent to Secretary Service template transformer</li> <li>LLM analyzes content and extracts structured metadata</li> <li>Frontmatter is generated with chapters, topics etc.</li> <li> <p>The total page count (<code>pages</code>) is not computed by the template but always reconstructed from the <code>--- Seite N ---</code> markers in the Markdown body.</p> </li> <li> <p>Markdown Creation:</p> </li> <li>Transcript content + frontmatter = transformed Markdown</li> <li>File name: <code>{originalName}.{language}.md</code> (with language suffix - transformed)</li> </ol>"},{"location":"architecture/pdf-transformation-phases.html#input_1","title":"Input","text":"<ul> <li>Transcript Markdown (<code>document.md</code>)</li> <li>Template content (structured schema)</li> <li>Target language</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#output_1","title":"Output","text":"<ul> <li>Transformed File: <code>document.de.md</code> (Markdown with frontmatter)</li> <li>Metadata: Structured data in YAML frontmatter</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#code-references-ist_1","title":"Code References (IST)","text":"<ul> <li>Routes &amp; orchestration</li> <li><code>src/app/api/external/jobs/[jobId]/route.ts</code>: Central callback route that, after receiving extract results, decides whether the template phase runs or is skipped and then saves the transformed Markdown.</li> <li>Template phase (core modules)</li> <li><code>src/lib/external-jobs/phase-template.ts</code>: Consolidated template phase (decision logic, repair cases, saving transformed Markdown)</li> <li><code>src/lib/external-jobs/template-run.ts</code>: Template transformation execution (calls the Secretary template transformer and parses the response)</li> <li><code>src/lib/external-jobs/chapters.ts</code>: Chapter detection and merge based on text</li> <li><code>src/lib/templates/template-service.ts</code>: Central management and loading of template files from the library <code>/templates</code> folder</li> <li><code>src/lib/external-jobs/template-files.ts</code>: Wrapper around <code>template-service.ts</code> for the external jobs phase</li> <li><code>src/lib/processing/gates.ts</code> (<code>gateTransformTemplate</code>): Gate checking (e.g. skip if chapter metadata already exists)</li> <li><code>src/lib/external-jobs/storage.ts</code>: Saves transformed Markdown (<code>{originalName}.{language}.md</code>)</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#execution-in-code-ist_1","title":"Execution in Code (IST)","text":"<ul> <li>Callback route</li> <li>Runs a preprocess span (if not already present) to detect existing frontmatter and its quality.</li> <li>Reads policies and phase flags via <code>readPhasesAndPolicies</code> and <code>job.parameters.phases</code>.</li> <li>Determines from the callback body whether chapter metadata (<code>chapters</code>) is already present.</li> <li>Calls the consolidated template phase (<code>runTemplatePhase</code> in <code>phase-template.ts</code>), which:<ul> <li>combines policies (<code>metadata: force/skip/auto/ignore</code>),</li> <li>gates (<code>gateTransformTemplate</code>), and</li> <li>the repair needs of an existing shadow twin.</li> </ul> </li> <li>Template transformation is only executed if no chapter metadata (<code>chapters</code>) exists yet. If only <code>pages</code> are missing, they are reconstructed from the <code>--- Seite N ---</code> markers in the body.</li> <li>When template processing is executed:<ul> <li>it selects a template via the central template service from the library <code>/templates</code> folder,</li> <li>calls the Secretary template endpoint and adds chapter information,</li> <li>strips old frontmatter and stores the new Markdown with frontmatter via <code>saveMarkdown</code> as <code>{originalName}.{language}.md</code>,</li> <li>and reliably marks the <code>transform_template</code> step as <code>completed</code> or <code>failed</code>.</li> </ul> </li> <li>When the template phase is skipped (chapters already exist), only missing <code>pages</code> are reconstructed and the existing frontmatter is used directly as the basis for ingestion.</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#example-output_1","title":"Example Output","text":"<pre><code>---\ntitle: \"Document Title\"\npages: 42\nchapters:\n  - title: \"Chapter 1\"\n    page: 1\n  - title: \"Chapter 2\"\n    page: 15\n---\n# Document Title\n\n[Extracted content...]\n</code></pre>"},{"location":"architecture/pdf-transformation-phases.html#skip-conditions","title":"Skip Conditions","text":"<ul> <li>Chapter metadata (<code>chapters</code>) already exists (frontmatter is complete with respect to chapters).</li> <li>Template phase disabled via policy.</li> <li>Previous job already completed the template phase.</li> </ul> <p>If only the page count (<code>pages</code>) is missing, the template phase is skipped and <code>pages</code> is silently reconstructed from the <code>--- Seite N ---</code> markers in the body.</p>"},{"location":"architecture/pdf-transformation-phases.html#phase-3-ingestion-rag","title":"Phase 3: Ingestion (RAG)","text":""},{"location":"architecture/pdf-transformation-phases.html#purpose_2","title":"Purpose","text":"<p>Ingest transformed Markdown into MongoDB Atlas Vector Search for RAG queries.</p>"},{"location":"architecture/pdf-transformation-phases.html#what-happens_2","title":"What Happens","text":"<ol> <li>Markdown Processing:</li> <li>Transformed Markdown (<code>document.de.md</code>) is parsed</li> <li>Images are processed and uploaded to Azure Storage (Slides, Cover, Markdown images)</li> <li> <p>Final Markdown (with Azure image URLs) is stored in MongoDB</p> </li> <li> <p>Vector Storage:</p> </li> <li>Complete document is sent to Secretary Service RAG API (<code>/api/rag/embed-text</code>)</li> <li>Secretary Service performs Markdown-aware chunking and embedding generation</li> <li>Chunks with embeddings are received and stored in MongoDB Vector Search Collection</li> <li>Meta-documents (without embeddings) are stored alongside chunks for gallery display</li> <li> <p>Facet metadata is duplicated into chunks for direct filtering during vector search</p> </li> <li> <p>MongoDB Storage:</p> </li> <li>All data stored in MongoDB: Meta-documents, chunks, and chapter summaries in same collection</li> <li>Collection structure: <code>vectors__${libraryId}</code> per library</li> <li>Document metadata stored as <code>kind: 'meta'</code> documents (no embeddings)</li> <li> <p>Chapter summaries stored as <code>kind: 'chapterSummary'</code> documents (with embeddings)</p> </li> <li> <p>Image Upload (Shadow-Twin \u2192 Azure Storage):</p> </li> <li>All image handling in Phase 3 is based on the Shadow-Twin directory and is centralized in the ingestion service.</li> <li>Session-mode documents (events with slides):<ul> <li><code>docMetaJson.slides[].image_url</code> is interpreted as a reference into the Shadow-Twin.</li> <li>Each slide image is resolved via <code>findShadowTwinImage</code>, uploaded to Azure Storage under the scoped path <code>\u2026/{libraryId}/sessions/{fileId}/{hash}.{ext}</code> and de-duplicated by hash.</li> <li>The resulting Azure URLs replace the original <code>slides[].image_url</code> values and are used directly by the frontend (<code>EventSlides</code>).</li> </ul> </li> <li>Book-mode documents (no slides):<ul> <li>A cover image is detected in the Shadow-Twin directory (<code>preview_001.jpg</code>), uploaded to Azure under <code>\u2026/{libraryId}/books/{fileId}/{hash}.{ext}</code> and stored as <code>docMetaJson.coverImageUrl</code>; this field is also available as a facet and is used by the gallery and book-detail views.</li> <li>Inline images in the Markdown body (Markdown <code>![]()</code>, HTML <code>&lt;img&gt;</code> and Obsidian <code>&lt;img-x.ext&gt;</code> syntax) are resolved against the Shadow-Twin, uploaded to Azure under the <code>books</code> scope and all references in the Markdown are rewritten to use the Azure URLs.</li> </ul> </li> <li>Frontend components (gallery cards, document detail, markdown viewer) use only these Azure URLs; direct access to Shadow-Twin image files from the browser is no longer required.</li> </ol>"},{"location":"architecture/pdf-transformation-phases.html#input_2","title":"Input","text":"<ul> <li>Transformed Markdown (<code>document.de.md</code>)</li> <li>Shadow-Twin directory (transcript, transformed Markdown, extracted images)</li> <li>Library configuration (including ingestion policies and facets)</li> <li>Storage provider + <code>shadowTwinFolderId</code> from the job\u2019s <code>shadowTwinState</code></li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#output_2","title":"Output","text":"<ul> <li>Vector embeddings: Stored in MongoDB Vector Search Collection (<code>vectors__${libraryId}</code>)</li> <li>Document metadata: Stored as meta-documents (<code>kind: 'meta'</code>) in same collection</li> <li>Image URLs: Azure Storage URLs in metadata</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#code-references-ist_2","title":"Code References (IST)","text":"<ul> <li>Routes &amp; orchestration</li> <li><code>src/app/api/external/jobs/[jobId]/start/route.ts</code>: Can execute an ingest-only path if a transformed shadow-twin Markdown already exists (without another Secretary request).</li> <li><code>src/app/api/external/jobs/[jobId]/route.ts</code>: Runs the regular ingestion after the template phase (including gates, policies, and error handling).</li> <li>Ingestion phase (core modules)</li> <li><code>src/lib/external-jobs/ingest.ts</code>: RAG ingestion pipeline (wrapper around the ingestion service)</li> <li><code>src/lib/chat/ingestion-service.ts</code>: Ingestion service (Secretary Service RAG API integration, MongoDB Vector Search upsert, image processing and Azure upload via <code>processSlideImagesToAzure</code>, <code>processMarkdownImagesToAzure</code>, <code>processCoverImageToAzure</code>)</li> <li><code>src/lib/chat/rag-embeddings.ts</code>: RAG embedding abstraction (Secretary Service client wrapper)</li> <li><code>src/lib/secretary/client.ts</code>: Secretary Service client (<code>embedTextRag()</code> for RAG API)</li> <li><code>src/lib/repositories/vector-repo.ts</code>: MongoDB Vector Search repository (upsert, query, meta-documents)</li> <li><code>src/lib/processing/gates.ts</code> (<code>gateIngestRag</code>): Gate checking (skip if already ingested; uses MongoDB query)</li> <li><code>src/lib/external-jobs/complete.ts</code>: Job completion handler (status, result, events)</li> <li>Storage &amp; metadata</li> <li><code>src/lib/repositories/doc-meta-repo.ts</code>: MongoDB document metadata repository (incl. <code>coverImageUrl</code>)</li> <li><code>src/lib/storage/shadow-twin.ts</code>: Shadow-Twin utilities (<code>findShadowTwinImage</code>, <code>resolveShadowTwinImageUrl</code>) for resolving images by relative path</li> <li><code>src/lib/services/azure-storage-service.ts</code>: Azure Storage client (scoped blob paths <code>books</code> / <code>sessions</code>, hash-based de-duplication)</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#execution-in-code-ist_2","title":"Execution in Code (IST)","text":"<ul> <li>Start route (ingest-only path)</li> <li> <p>If policies/gates decide that Extract/Template are not needed but ingestion should run:</p> <ul> <li>it searches for the already transformed Markdown in the shadow twin (directory first, then file),</li> <li>loads the Markdown text and parses frontmatter via <code>parseSecretaryMarkdownStrict</code>,</li> <li>calls <code>runIngestion</code> directly and completes the job after successful ingestion.</li> </ul> </li> <li> <p>Callback route (regular path)</p> </li> <li>Uses <code>gateIngestRag</code> and optionally <code>ingestionCheck</code> to determine whether vectors for this document already exist in the MongoDB Vector Search collection.</li> <li>Reads ingestion policies (<code>ingestPolicy: 'do' | 'force' | 'skip'</code> plus legacy flags from <code>job.parameters</code>).</li> <li>Determines <code>useIngestion</code> and marks <code>ingest_rag</code> as <code>skipped</code> if appropriate (including reason).</li> <li>When ingestion runs:<ul> <li>determines <code>fileId</code> and <code>fileName</code> of the document to ingest,</li> <li>loads Markdown for ingestion (directly from the current callback context or via storage fallback),</li> <li>calls <code>runIngestion</code>, which:</li> <li>calls <code>IngestionService.upsertMarkdown(...)</code>,</li> <li>stores chunks in Pinecone, and</li> <li>writes metadata (including chapter summaries) to MongoDB,</li> <li>updates the ingestion status in the job (<code>setIngestion</code>) and sets the <code>ingest_rag</code> step to <code>completed</code>.</li> </ul> </li> <li>Finally calls <code>setJobCompleted</code>, updates the shadow-twin state to <code>processingStatus: 'ready'</code> and sends a final <code>job_update</code> event with <code>refreshFolderIds</code>.</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#skip-conditions_1","title":"Skip Conditions","text":"<ul> <li>Document already ingested (check via <code>ingestionCheck</code>)</li> <li>Ingestion phase disabled via policy</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#phase-control","title":"Phase Control","text":""},{"location":"architecture/pdf-transformation-phases.html#policies","title":"Policies","text":"<p>Phases can be controlled via policies:</p> <pre><code>interface PhasePolicies {\n  extract: 'force' | 'skip' | 'auto' | 'ignore';\n  metadata: 'force' | 'skip' | 'auto' | 'ignore';\n  ingest: 'force' | 'skip' | 'auto' | 'ignore';\n}\n</code></pre> <ul> <li><code>force</code>: Always execute phase (even if artifacts exist)</li> <li><code>skip</code>: Skip phase (even if artifacts don't exist)</li> <li><code>auto</code>: Execute if needed (check gates)</li> <li><code>ignore</code>: Phase disabled</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#gates","title":"Gates","text":"<p>Gates check if phases should be skipped:</p> <ul> <li><code>gateExtractPdf()</code>: Checks for existing Shadow-Twin files</li> <li><code>gateTransformTemplate()</code>: Checks for existing frontmatter</li> <li><code>gateIngestRag()</code>: Checks for existing ingestion</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#execution-flow","title":"Execution Flow","text":"<pre><code>PDF File\n  \u2193\n[Gate: Extract] \u2192 Skip if Shadow-Twin exists\n  \u2193\nPhase 1: Extract \u2192 document.md + images\n  \u2193\n[Gate: Template] \u2192 Skip if frontmatter exists\n  \u2193\nPhase 2: Template \u2192 document.de.md\n  \u2193\n[Gate: Ingestion] \u2192 Skip if already ingested\n  \u2193\nPhase 3: Ingestion \u2192 Vector storage + MongoDB\n  \u2193\nComplete\n</code></pre>"},{"location":"architecture/pdf-transformation-phases.html#file-naming-convention","title":"File Naming Convention","text":""},{"location":"architecture/pdf-transformation-phases.html#transcript-file-phase-1","title":"Transcript File (Phase 1)","text":"<ul> <li>Format: <code>{originalName}.md</code></li> <li>Example: <code>document.md</code></li> <li>Language: No suffix (original language)</li> <li>Content: Extracted text without frontmatter</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#transformed-file-phase-2","title":"Transformed File (Phase 2)","text":"<ul> <li>Format: <code>{originalName}.{language}.md</code></li> <li>Example: <code>document.de.md</code></li> <li>Language: With suffix (target language)</li> <li>Content: Text with frontmatter and metadata</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#why-different-names","title":"Why Different Names?","text":"<ul> <li>Transcript: Original language, no transformation \u2192 no language suffix</li> <li>Transformed: Translated/structured, target language \u2192 language suffix</li> <li>Coexistence: Both files can exist simultaneously (no overwrite)</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#error-handling","title":"Error Handling","text":"<ul> <li>Phase failures: Logged in job document, job status set to <code>failed</code></li> <li>Partial completion: Intermediate artifacts preserved</li> <li>Retry: Failed phases can be retried independently</li> <li>Skip on error: Subsequent phases can still execute if previous phase failed (depending on policy)</li> </ul>"},{"location":"architecture/pdf-transformation-phases.html#performance-considerations","title":"Performance Considerations","text":"<ul> <li>Parallel processing: Images processed in parallel with text extraction</li> <li>Caching: Secretary Service caches OCR results</li> <li>Batch processing: Multiple PDFs processed in parallel</li> <li>Incremental updates: Only changed phases re-executed</li> </ul>"},{"location":"architecture/shadow-twin.html","title":"Shadow-Twin Architecture","text":""},{"location":"architecture/shadow-twin.html#concept","title":"Concept","text":"<p>A Shadow-Twin is a transformed representation of an original document (PDF, audio, video, image, text) stored alongside the original. It contains:</p> <ul> <li>Markdown files: Extracted text, structured content, and metadata</li> <li>Images: Extracted images from PDFs or OCR results</li> <li>Media files: Audio/video transcripts</li> </ul> <p>Shadow-Twins enable: - Searchable text content - Structured metadata - RAG (Retrieval Augmented Generation) integration - Media-independent processing pipeline</p>"},{"location":"architecture/shadow-twin.html#structure","title":"Structure","text":"<p>Shadow-Twins can exist in two forms:</p>"},{"location":"architecture/shadow-twin.html#1-shadow-twin-directory-when-imagesmedia-are-present","title":"1. Shadow-Twin Directory (when images/media are present)","text":"<p>A hidden directory (starts with <code>.</code>) containing all related files:</p> <pre><code>.document.pdf/\n\u251c\u2500\u2500 document.md          (Transcript - Phase 1 output)\n\u251c\u2500\u2500 document.de.md       (Transformed - Phase 2 output)\n\u251c\u2500\u2500 page-001.png        (Extracted images)\n\u251c\u2500\u2500 page-002.png\n\u2514\u2500\u2500 ...\n</code></pre> <p>When created: Automatically when images are extracted (<code>includeOcrImages</code> or <code>includePageImages</code> enabled)</p> <p>Directory naming: <code>.{originalName}</code> (e.g., <code>.document.pdf/</code>) - Maximum length: 255 characters (truncated if necessary) - Hidden from normal directory listings (starts with <code>.</code>)</p>"},{"location":"architecture/shadow-twin.html#2-shadow-twin-files-when-no-imagesmedia","title":"2. Shadow-Twin Files (when no images/media)","text":"<p>Files stored directly next to the original:</p> <pre><code>document.pdf\ndocument.md          (Transcript - Phase 1 output)\ndocument.de.md       (Transformed - Phase 2 output)\n</code></pre>"},{"location":"architecture/shadow-twin.html#naming-conventions","title":"Naming Conventions","text":""},{"location":"architecture/shadow-twin.html#transcript-file","title":"Transcript File","text":"<ul> <li>Format: <code>{originalName}.md</code></li> <li>Example: <code>document.md</code></li> <li>Created: After Phase 1 (Extract)</li> <li>Content: Extracted text without frontmatter</li> <li>Language: No language suffix (original language of source)</li> </ul>"},{"location":"architecture/shadow-twin.html#transformed-file","title":"Transformed File","text":"<ul> <li>Format: <code>{originalName}.{language}.md</code></li> <li>Example: <code>document.de.md</code></li> <li>Created: After Phase 2 (Template)</li> <li>Content: Text with frontmatter and metadata</li> <li>Language: With language suffix (target language for transformation)</li> </ul>"},{"location":"architecture/shadow-twin.html#shadow-twin-directory","title":"Shadow-Twin Directory","text":"<ul> <li>Format: <code>.{originalName}</code></li> <li>Example: <code>.document.pdf/</code></li> <li>Created: When images are extracted</li> <li>Length limit: 255 characters (truncated if necessary)</li> </ul>"},{"location":"architecture/shadow-twin.html#state-management","title":"State Management","text":""},{"location":"architecture/shadow-twin.html#job-document-primary-source","title":"Job Document (Primary Source)","text":"<p>Shadow-Twin state is calculated at job start, updated by the processing phases, and stored in MongoDB:</p> <pre><code>interface ExternalJob {\n  shadowTwinState?: {\n    baseItem: { id: string; metadata: { name: string } };\n    transformed?: { id: string; metadata: { name: string } };\n    transcriptFiles?: Array&lt;{ id: string; metadata: { name: string } }&gt;;\n    shadowTwinFolderId?: string;\n    mediaFiles?: Array&lt;{ id: string; metadata: { name: string } }&gt;;\n    analysisTimestamp: number;\n    analysisError?: string;\n    processingStatus?: 'processing' | 'ready' | 'error' | null;\n  };\n}\n</code></pre> <p>Benefits: - Single source of truth - Available to all workers (parallel processing) - Persistent across sessions</p>"},{"location":"architecture/shadow-twin.html#frontend-atom-ui-display","title":"Frontend Atom (UI Display)","text":"<p>Frontend uses Jotai atom for UI state:</p> <pre><code>const shadowTwinStateAtom = atom&lt;Map&lt;string, FrontendShadowTwinState&gt;&gt;(new Map());\n</code></pre> <p>Purpose: UI display only (not primary source) Updates: From job documents or local analysis</p>"},{"location":"architecture/shadow-twin.html#analysis-logic","title":"Analysis Logic","text":"<p>Shadow-Twin analysis is performed by <code>analyzeShadowTwin()</code>:</p> <ol> <li>Load base item (original file)</li> <li>Check for Shadow-Twin directory:</li> <li>Search for <code>.document.pdf/</code> directory</li> <li>If found: Load contents</li> <li>Check for Shadow-Twin files:</li> <li>Search for <code>document.md</code> (transcript)</li> <li>Search for <code>document.de.md</code> (transformed)</li> <li>Classify files:</li> <li>Files without language suffix \u2192 <code>transcriptFiles</code></li> <li>Files with language suffix \u2192 <code>transformed</code> (after frontmatter check)</li> <li>Return ShadowTwinState</li> </ol>"},{"location":"architecture/shadow-twin.html#file-types-in-shadow-twin","title":"File Types in Shadow-Twin","text":""},{"location":"architecture/shadow-twin.html#transcriptfiles","title":"<code>transcriptFiles</code>","text":"<ul> <li>Type: <code>StorageItem[]</code></li> <li>Content: Markdown without frontmatter</li> <li>Naming: <code>{originalName}.md</code> (no language suffix)</li> <li>Created: Phase 1 (Extract)</li> <li>Purpose: Raw extracted text (original language)</li> </ul>"},{"location":"architecture/shadow-twin.html#transformed","title":"<code>transformed</code>","text":"<ul> <li>Type: <code>StorageItem</code></li> <li>Content: Markdown with frontmatter</li> <li>Naming: <code>{originalName}.{language}.md</code> (with language suffix)</li> <li>Created: Phase 2 (Template)</li> <li>Purpose: Structured document with metadata</li> </ul>"},{"location":"architecture/shadow-twin.html#shadowtwinfolderid","title":"<code>shadowTwinFolderId</code>","text":"<ul> <li>Type: <code>string | undefined</code></li> <li>Content: ID of Shadow-Twin directory</li> <li>Created: When images are extracted</li> <li>Purpose: Container for all Shadow-Twin files</li> </ul>"},{"location":"architecture/shadow-twin.html#mediafiles","title":"<code>mediaFiles</code>","text":"<ul> <li>Type: <code>StorageItem[]</code></li> <li>Content: Audio/video files</li> <li>Purpose: Original media files (for audio/video transformations)</li> </ul>"},{"location":"architecture/shadow-twin.html#code-references","title":"Code References","text":""},{"location":"architecture/shadow-twin.html#core-functions","title":"Core Functions","text":"<ul> <li><code>src/lib/storage/shadow-twin.ts</code>:</li> <li><code>generateShadowTwinName()</code>: Generate file names (with/without language suffix)</li> <li><code>generateShadowTwinFolderName()</code>: Generate directory names</li> <li><code>findShadowTwinFolder()</code>: Find Shadow-Twin directory</li> <li> <p><code>findShadowTwinMarkdown()</code>: Find Markdown files (both variants)</p> </li> <li> <p><code>src/lib/shadow-twin/analyze-shadow-twin.ts</code>:</p> </li> <li> <p><code>analyzeShadowTwin()</code>: Analyze file and find all Shadow-Twin components</p> </li> <li> <p><code>src/lib/shadow-twin/shared.ts</code>:</p> </li> <li><code>ShadowTwinState</code>: Shared type definition</li> <li><code>toMongoShadowTwinState()</code>: Convert to MongoDB-compatible format</li> </ul>"},{"location":"architecture/shadow-twin.html#state-management_1","title":"State Management","text":"<ul> <li><code>src/atoms/shadow-twin-atom.ts</code>:</li> <li><code>shadowTwinStateAtom</code>: Frontend state atom</li> <li> <p><code>FrontendShadowTwinState</code>: Frontend type (with full StorageItem objects)</p> </li> <li> <p><code>src/hooks/use-shadow-twin-analysis.ts</code>:</p> </li> <li><code>useShadowTwinAnalysis()</code>: React hook for automatic analysis</li> </ul>"},{"location":"architecture/shadow-twin.html#processing","title":"Processing","text":"<ul> <li><code>src/lib/external-jobs/extract-only.ts</code>:</li> <li> <p>Extract phase: Creates transcript file (<code>document.md</code>)</p> </li> <li> <p><code>src/lib/external-jobs/storage.ts</code>:</p> </li> <li> <p><code>saveMarkdown()</code>: Saves Markdown files (transcript or transformed)</p> </li> <li> <p><code>src/lib/processing/gates.ts</code>:</p> </li> <li><code>gateExtractPdf()</code>: Checks if extraction should be skipped</li> <li><code>gateTransformTemplate()</code>: Checks if template phase should be skipped</li> </ul>"},{"location":"architecture/shadow-twin.html#usage-examples","title":"Usage Examples","text":""},{"location":"architecture/shadow-twin.html#finding-a-shadow-twin","title":"Finding a Shadow-Twin","text":"<pre><code>import { findShadowTwinFolder, findShadowTwinMarkdown } from '@/lib/storage/shadow-twin';\n\n// Find directory\nconst folder = await findShadowTwinFolder(parentId, 'document.pdf', provider);\n\n// Find Markdown (prefers transformed, falls back to transcript)\nconst markdown = await findShadowTwinMarkdown(folder.id, 'document', 'de', provider);\n</code></pre>"},{"location":"architecture/shadow-twin.html#creating-or-finding-shadow-twin-folder","title":"Creating or Finding Shadow-Twin Folder","text":"<pre><code>import { findOrCreateShadowTwinFolder } from '@/lib/external-jobs/shadow-twin-helpers';\n\n// Find existing folder or create new one\n// Returns folder ID (string) or undefined if failed\nconst folderId = await findOrCreateShadowTwinFolder(\n  provider,\n  parentId,\n  'document', // original name without extension\n  jobId\n);\n\nif (folderId) {\n  // Use folderId to save files in Shadow-Twin directory\n  await provider.saveFile(folderId, 'document.md', content);\n}\n</code></pre>"},{"location":"architecture/shadow-twin.html#analyzing-shadow-twin-state","title":"Analyzing Shadow-Twin State","text":"<pre><code>import { analyzeShadowTwin } from '@/lib/shadow-twin/analyze-shadow-twin';\n\nconst state = await analyzeShadowTwin(fileId, provider);\nif (state) {\n  console.log('Transcript:', state.transcriptFiles);\n  console.log('Transformed:', state.transformed);\n  console.log('Folder:', state.shadowTwinFolderId);\n}\n</code></pre>"},{"location":"architecture/shadow-twin.html#best-practices","title":"Best Practices","text":"<ol> <li>Always use job document state as primary source (not frontend atom)</li> <li>Check both file variants when searching (transcript and transformed)</li> <li>Respect naming conventions (transcript without language, transformed with language)</li> <li>Handle directory length limits (255 characters)</li> <li>Use analysis function instead of manual file searching</li> </ol>"},{"location":"reference/file-index.html","title":"File Index","text":"<p>Complete index of all documented source files with descriptions, exports, and usage information.</p>"},{"location":"reference/file-index.html#core-infrastructure","title":"Core Infrastructure \u2705","text":"File Path Module Description Exports Used In <code>src/middleware.ts</code> core Authentication and routing middleware <code>default</code>, <code>config</code> Next.js framework, all routes <code>src/app/layout.tsx</code> core Root layout component <code>default</code>, <code>metadata</code> Next.js framework, all pages <code>src/instrumentation.ts</code> core Next.js instrumentation hook <code>register</code> Next.js framework <code>src/lib/env.ts</code> core Environment variable helpers <code>getPublicAppUrl</code>, <code>getSelfBaseUrl</code>, <code>getSecretaryConfig</code>, <code>getVimeoConfig</code> API routes, services <code>src/lib/auth.ts</code> core Authentication helpers <code>getLibraryId</code>, <code>isAuthenticated</code>, <code>getUserInfo</code> API routes, components <code>src/lib/mongodb-service.ts</code> core MongoDB database service <code>connectToDatabase</code>, <code>getCollection</code> Services, repositories, API routes"},{"location":"reference/file-index.html#storage-layer","title":"Storage Layer \u2705","text":"File Path Module Description Exports Used In <code>src/lib/storage/types.ts</code> storage Storage type definitions <code>StorageItemMetadata</code>, <code>StorageItem</code>, <code>StorageValidationResult</code>, <code>StorageProvider</code> All storage files <code>src/lib/storage/storage-factory.ts</code> storage Storage provider factory <code>StorageFactory</code>, <code>LocalStorageProvider</code> Contexts, API routes, components <code>src/lib/storage/filesystem-provider.ts</code> storage Local filesystem provider <code>FileSystemProvider</code> Storage factory <code>src/lib/storage/onedrive-provider.ts</code> storage OneDrive provider <code>OneDriveProvider</code> Storage factory <code>src/lib/storage/storage-factory-mongodb.ts</code> storage MongoDB storage factory <code>MongoDBStorageFactory</code> MongoDB operations <code>src/lib/storage/filesystem-client.ts</code> storage Filesystem client <code>FileSystemClient</code> Client-side operations <code>src/lib/storage/server-provider.ts</code> storage Server-side provider helper <code>getServerProvider</code> API routes <code>src/lib/storage/supported-types.ts</code> storage Supported library types <code>SUPPORTED_LIBRARY_TYPES</code>, <code>isSupportedLibraryType</code>, <code>getSupportedLibraryTypesString</code> Storage factory <code>src/contexts/storage-context.tsx</code> storage Storage React context <code>StorageContextProvider</code>, <code>useStorage</code> Components <code>src/hooks/use-storage-provider.tsx</code> storage Storage provider hook <code>useStorageProvider</code> Components"},{"location":"reference/file-index.html#library-system","title":"Library System \u2705","text":"File Path Module Description Exports Used In <code>src/types/library.ts</code> library Library type definitions <code>ClientLibrary</code>, <code>Library</code>, <code>LibraryChatConfig</code>, <code>StorageConfig</code>, <code>PublicLibraryConfig</code> All library files <code>src/atoms/library-atom.ts</code> library Library state atoms <code>libraryAtom</code>, <code>activeLibraryIdAtom</code>, <code>librariesAtom</code>, <code>activeLibraryAtom</code>, <code>currentFolderIdAtom</code> Components <code>src/lib/services/library-service.ts</code> library Library service <code>LibraryService</code>, <code>UserLibraries</code> API routes, components <code>src/components/library/library.tsx</code> library Main library component <code>Library</code> Library page <code>src/components/library/library-header.tsx</code> library Library header component TBD Library component <code>src/components/library/library-switcher.tsx</code> library Library switcher component TBD Library header <code>src/components/library/file-list.tsx</code> library File list with header actions and record operations <code>FileList</code> Library component"},{"location":"reference/file-index.html#chat-system","title":"Chat System \u2705","text":"File Path Module Description Exports Used In <code>src/types/chat.ts</code> chat Chat type definitions <code>Chat</code> Chat system <code>src/lib/chat/constants.ts</code> chat Chat constants <code>AnswerLength</code>, <code>Retriever</code>, <code>TargetLanguage</code>, <code>Character</code>, <code>SocialContext</code> Chat system <code>src/lib/chat/orchestrator.ts</code> chat Chat orchestration <code>runChatOrchestrated</code>, <code>OrchestratorInput</code>, <code>OrchestratorOutput</code> Chat API routes <code>src/lib/chat/loader.ts</code> chat Chat loader <code>loadLibraryChatContext</code>, <code>LibraryChatContext</code> Chat orchestrator <code>src/lib/chat/config.ts</code> chat Chat configuration <code>chatConfigSchema</code>, <code>normalizeChatConfig</code>, <code>getVectorIndexForLibrary(library, chatConfig?)</code> Chat system <code>src/lib/chat/retrievers/chunks.ts</code> chat Chunk retriever <code>chunksRetriever</code> Chat orchestrator <code>src/lib/chat/retrievers/summaries-mongo.ts</code> chat Summary retriever <code>summariesMongoRetriever</code> Chat orchestrator <code>src/lib/chat/common/prompt.ts</code> chat Prompt building <code>buildPrompt</code>, <code>buildTOCPrompt</code>, <code>getSourceDescription</code> Chat orchestrator <code>src/lib/chat/common/llm.ts</code> chat LLM calling <code>callOpenAI</code>, <code>parseOpenAIResponseWithUsage</code>, <code>parseStructuredLLMResponse</code> Chat orchestrator <code>src/app/api/chat/[libraryId]/stream/route.ts</code> chat Chat streaming endpoint <code>POST</code> Chat components"},{"location":"reference/file-index.html#external-jobs-system","title":"External Jobs System \u2705","text":"File Path Module Description Exports Used In <code>src/lib/external-jobs-repository.ts</code> external-jobs MongoDB repository for external jobs <code>ExternalJobsRepository</code> Worker, watchdog, API routes, orchestration <code>src/lib/external-jobs-worker.ts</code> external-jobs Background worker for processing jobs <code>ExternalJobsWorker</code> Instrumentation, worker status endpoint <code>src/lib/external-jobs-watchdog.ts</code> external-jobs Timeout monitoring for jobs <code>startWatchdog</code>, <code>bumpWatchdog</code>, <code>clearWatchdog</code> Job callbacks, job start <code>src/lib/external-jobs/context.ts</code> external-jobs Request context parsing <code>readContext</code> Job callback <code>src/lib/external-jobs/auth.ts</code> external-jobs Authorization and bypass checks <code>isInternalAuthorized</code>, <code>authorizeCallback</code>, <code>guardProcessId</code> Job callbacks, job start <code>src/lib/external-jobs/policies.ts</code> external-jobs Phase policy extraction <code>readPhasesAndPolicies</code> Job callback <code>src/lib/external-jobs/template-decision.ts</code> external-jobs Template execution decision logic <code>decideTemplateRun</code> Job callback <code>src/lib/external-jobs/template-run.ts</code> external-jobs Template transformation execution <code>runTemplateTransform</code> Job callback <code>src/lib/external-jobs/chapters.ts</code> external-jobs Chapter detection and merging <code>analyzeAndMergeChapters</code> Job callback <code>src/lib/external-jobs/storage.ts</code> external-jobs Markdown file storage <code>saveMarkdown</code> Job callback <code>src/lib/external-jobs/images.ts</code> external-jobs Image archive extraction <code>processAllImageSources</code> Job callback <code>src/lib/external-jobs/ingest.ts</code> external-jobs RAG ingestion pipeline <code>runIngestion</code> Job callback, job start <code>src/lib/external-jobs/complete.ts</code> external-jobs Job completion handler <code>setJobCompleted</code> Job callback, job start <code>src/lib/external-jobs/preprocess.ts</code> external-jobs Job preprocessing and analysis <code>preprocess</code>, <code>PreprocessResult</code> Job start, job callback <code>src/lib/external-jobs/provider.ts</code> external-jobs Storage provider construction <code>buildProvider</code> Preprocessing, job callback <code>src/lib/external-jobs/progress.ts</code> external-jobs Progress update processing <code>handleProgressIfAny</code> Job callback <code>src/app/api/external/jobs/[jobId]/route.ts</code> external-jobs Main job processing endpoint <code>GET</code>, <code>POST</code> Secretary Service, worker <code>src/app/api/external/jobs/[jobId]/start/route.ts</code> external-jobs Job execution trigger <code>POST</code> Worker <code>src/app/api/external/jobs/route.ts</code> external-jobs Job query endpoint <code>GET</code> Event monitor components"},{"location":"reference/file-index.html#secretary-service","title":"Secretary Service \u2705","text":"File Path Module Description Exports Used In <code>src/lib/secretary/client.ts</code> secretary HTTP client for Secretary Service API <code>SecretaryServiceClient</code>, <code>SecretaryServiceError</code>, response interfaces Secretary API routes, external jobs <code>src/lib/secretary/adapter.ts</code> secretary Low-level API call functions <code>callPdfProcess</code>, <code>callTemplateTransform</code> Secretary client, template runner <code>src/lib/secretary/response-parser.ts</code> secretary Markdown response parsing <code>parseSecretaryMarkdownStrict</code>, <code>FrontmatterParseResult</code> External jobs, Secretary API routes <code>src/lib/secretary/types.ts</code> secretary Type definitions for Secretary Service Request/response interfaces Secretary client, API routes, external jobs <code>src/app/api/secretary/process-pdf/route.ts</code> secretary PDF transformation endpoint <code>POST</code> Library components <code>src/app/api/secretary/process-audio/route.ts</code> secretary Audio transformation endpoint <code>POST</code> Library components <code>src/app/api/secretary/process-video/route.ts</code> secretary Video transformation endpoint <code>POST</code> Library components <code>src/app/api/secretary/process-image/route.ts</code> secretary Image OCR endpoint <code>POST</code> Library components <code>src/app/api/secretary/session/process/route.ts</code> secretary Session import endpoint <code>POST</code> Event monitor components, session processing"},{"location":"reference/file-index.html#event-job-system","title":"Event Job System \u2705","text":"File Path Module Description Exports Used In <code>src/lib/event-job-repository.ts</code> event-job MongoDB repository for event jobs <code>EventJobRepository</code> API routes, session processor, event monitor <code>src/lib/session/session-processor.ts</code> event-job Session data processing utilities <code>vttToPlainText</code>, <code>extractVideoTranscript</code>, <code>buildSessionPayload</code> API routes, event monitor components <code>src/lib/session-repository.ts</code> event-job MongoDB repository for sessions <code>SessionRepository</code> API routes, event monitor components <code>src/app/api/event-job/jobs/[jobId]/route.ts</code> event-job Individual job operations <code>GET</code>, <code>DELETE</code>, <code>PATCH</code> Event monitor components <code>src/app/api/event-job/batches/[batchId]/route.ts</code> event-job Individual batch operations <code>GET</code>, <code>DELETE</code> Event monitor components <code>src/app/api/event-job/events/route.ts</code> event-job Event list and migration <code>GET</code>, <code>POST</code> Event monitor components"},{"location":"reference/file-index.html#transform-processing","title":"Transform &amp; Processing \u2705","text":"File Path Module Description Exports Used In <code>src/lib/transform/transform-service.ts</code> transform Central transformation service <code>TransformService</code>, transform option interfaces, <code>TransformResult</code> Library components, transform API routes <code>src/lib/transform/image-extraction-service.ts</code> transform PDF image extraction and storage <code>ImageExtractionService</code>, <code>ExtractedPageImage</code>, <code>ImageExtractionResult</code> Transform service, external jobs <code>src/lib/processing/gates.ts</code> processing Phase gate checking utilities <code>gateExtractPdf</code>, <code>gateTransformTemplate</code>, <code>gateIngestRag</code>, <code>GateContext</code>, <code>GateResult</code> Template decision, external jobs <code>src/lib/processing/phase-policy.ts</code> processing Processing phase control policies <code>PhaseDirective</code>, <code>PhasePolicies</code>, policy utilities External jobs, gates, Secretary API routes"},{"location":"reference/file-index.html#shadow-twin-system","title":"Shadow-Twin System \u2705","text":"File Path Module Description Exports Used In <code>src/lib/shadow-twin/shared.ts</code> shadow-twin Shared Shadow-Twin types and utilities <code>ShadowTwinState</code>, <code>toMongoShadowTwinState</code> Backend (Job documents), Frontend (Atoms) <code>src/lib/shadow-twin/analyze-shadow-twin.ts</code> shadow-twin Shadow-Twin analysis logic <code>analyzeShadowTwin</code> Frontend hooks, job start <code>src/lib/storage/shadow-twin.ts</code> shadow-twin Shadow-Twin file and directory utilities <code>generateShadowTwinName</code>, <code>generateShadowTwinFolderName</code>, <code>findShadowTwinFolder</code>, <code>findShadowTwinMarkdown</code> External jobs, gates, analysis <code>src/lib/external-jobs/shadow-twin-helpers.ts</code> shadow-twin Shadow-Twin folder creation utilities <code>findOrCreateShadowTwinFolder(provider, parentId, originalName, jobId)</code> \u2192 <code>string | undefined</code> External jobs <code>src/atoms/shadow-twin-atom.ts</code> shadow-twin Frontend Shadow-Twin state atom <code>shadowTwinStateAtom</code>, <code>FrontendShadowTwinState</code> Library components, file list, file preview <code>src/hooks/use-shadow-twin-analysis.ts</code> shadow-twin React hook for Shadow-Twin analysis <code>useShadowTwinAnalysis</code> File list component <p>Documentation: See Shadow-Twin Architecture and PDF Transformation Phases</p>"},{"location":"reference/file-index.html#database-repositories","title":"Database Repositories \u2705","text":"File Path Module Description Exports Used In <code>src/lib/db/chats-repo.ts</code> chat MongoDB repository for chat management <code>createChat</code>, <code>listChats</code>, <code>getChatById</code>, <code>touchChat</code>, <code>deleteChat</code> Chat API routes, chat components <code>src/lib/db/queries-repo.ts</code> chat MongoDB repository for query logging <code>insertQueryLog</code>, <code>appendRetrievalStep</code>, <code>updateQueryLogPartial</code>, <code>getQueryLogById</code>, <code>listRecentQueries</code>, <code>getFilteredDocumentCount(libraryOrId, filter)</code> Chat API routes, chat modules, query logger <code>src/lib/repositories/doc-meta-repo.ts</code> chat MongoDB repository for document metadata <code>computeDocMetaCollectionName</code>, <code>ensureFacetIndexes</code>, <code>upsertDocMeta</code>, <code>findDocs</code>, <code>deleteDocMeta</code> Summary retriever, ingestion service"},{"location":"reference/file-index.html#api-routes","title":"API Routes \u2705","text":"File Path Module Description Exports Used In <code>src/app/api/storage/filesystem/route.ts</code> storage Filesystem storage API <code>GET</code>, <code>POST</code>, <code>DELETE</code>, <code>PATCH</code> Storage providers <code>src/app/api/libraries/route.ts</code> library Library management API <code>GET</code>, <code>POST</code> Settings, storage context"},{"location":"reference/file-index.html#notes","title":"Notes","text":"<ul> <li>Files are organized by functional module</li> <li>\u2705 = Fully documented with JSDoc headers</li> <li>Export information completed for documented files</li> <li>Usage information updated based on dependency analysis</li> </ul>"},{"location":"reference/file-index.html#status","title":"Status","text":"<ul> <li>\u2705 Core Infrastructure: Documented (6 files)</li> <li>\u2705 Storage Layer: Documented (10 files)</li> <li>\u2705 Library System: Documented (4 files)</li> <li>\u2705 Chat System: Documented (9 files)</li> <li>\u2705 External Jobs System: Documented (18 files)</li> <li>\u2705 Secretary Service: Documented (9 files)</li> <li>\u2705 Event Job System: Documented (6 files)</li> <li>\u2705 Transform &amp; Processing: Documented (4 files)</li> <li>\u2705 Database Repositories: Documented (3 files)</li> <li>\u2705 API Routes: Documented (2 files)</li> <li>Total Documented: 71 files (~16.7% of ~424 files)</li> <li>\u23f3 Remaining Components: Pending</li> <li>\u23f3 Remaining API Routes: Pending</li> </ul>"},{"location":"reference/modules/chat.html","title":"Chat Module","text":"<p>Complete documentation for the Chat module.</p>"},{"location":"reference/modules/chat.html#overview","title":"Overview","text":"<p>The Chat module provides RAG-based chat functionality for knowledge exploration. Supports both regular chat mode and story mode with structured topic exploration.</p>"},{"location":"reference/modules/chat.html#key-files","title":"Key Files","text":""},{"location":"reference/modules/chat.html#types","title":"Types","text":"<ul> <li><code>src/types/chat.ts</code>: Chat interface for conversation management</li> <li><code>src/types/chat-response.ts</code>: Chat response types</li> <li><code>src/types/chat-processing.ts</code>: Chat processing step types</li> <li><code>src/types/retriever.ts</code>: Retriever input/output types</li> </ul>"},{"location":"reference/modules/chat.html#constants-configuration","title":"Constants &amp; Configuration","text":"<ul> <li><code>src/lib/chat/constants.ts</code>: Central chat configuration definitions</li> <li><code>src/lib/chat/config.ts</code>: Chat configuration normalization</li> </ul>"},{"location":"reference/modules/chat.html#orchestration","title":"Orchestration","text":"<ul> <li><code>src/lib/chat/orchestrator.ts</code>: Main orchestration for chat response generation</li> <li><code>src/lib/chat/loader.ts</code>: Library chat context loading</li> </ul>"},{"location":"reference/modules/chat.html#retrievers","title":"Retrievers","text":"<ul> <li><code>src/lib/chat/retrievers/chunks.ts</code>: Chunk-based retriever</li> <li><code>src/lib/chat/retrievers/summaries-mongo.ts</code>: Summary-based retriever</li> <li><code>src/lib/chat/retrievers/metadata-extractor.ts</code>: Metadata extraction</li> </ul>"},{"location":"reference/modules/chat.html#common-utilities","title":"Common Utilities","text":"<ul> <li><code>src/lib/chat/common/prompt.ts</code>: Prompt building utilities</li> <li><code>src/lib/chat/common/llm.ts</code>: LLM calling utilities</li> <li><code>src/lib/chat/common/filters.ts</code>: Filter building utilities</li> <li><code>src/lib/chat/common/question-analyzer.ts</code>: Question analysis for retriever selection</li> <li><code>src/lib/chat/common/budget.ts</code>: Budget management for source reduction</li> </ul>"},{"location":"reference/modules/chat.html#api-routes","title":"API Routes","text":"<ul> <li><code>src/app/api/chat/[libraryId]/stream/route.ts</code>: Chat streaming endpoint</li> </ul>"},{"location":"reference/modules/chat.html#exports","title":"Exports","text":""},{"location":"reference/modules/chat.html#types_1","title":"Types","text":"<ul> <li><code>Chat</code>: Chat conversation interface</li> <li><code>ChatResponse</code>: Chat response structure</li> <li><code>ChatProcessingStep</code>: Processing step types</li> <li><code>RetrieverInput</code>: Retriever input interface</li> <li><code>RetrieverOutput</code>: Retriever output interface</li> <li><code>OrchestratorInput</code>: Orchestration input</li> <li><code>OrchestratorOutput</code>: Orchestration output</li> </ul>"},{"location":"reference/modules/chat.html#constants","title":"Constants","text":"<ul> <li><code>AnswerLength</code>: Answer length type and values</li> <li><code>Retriever</code>: Retriever method type and values</li> <li><code>TargetLanguage</code>: Target language type and values</li> <li><code>Character</code>: Character type and values</li> <li><code>SocialContext</code>: Social context type and values</li> </ul>"},{"location":"reference/modules/chat.html#functions","title":"Functions","text":"<ul> <li><code>runChatOrchestrated()</code>: Main orchestration function</li> <li><code>analyzeQuestionForRetriever()</code>: Question analysis function</li> <li><code>buildPrompt()</code>: Prompt building function</li> <li><code>callOpenAI()</code>: LLM calling function</li> <li><code>getVectorIndexForLibrary(library, chatConfig?)</code>: Get vector index name for library</li> </ul>"},{"location":"reference/modules/chat.html#usage-examples","title":"Usage Examples","text":""},{"location":"reference/modules/chat.html#chat-streaming-api-route","title":"Chat Streaming (API Route)","text":"<pre><code>// POST /api/chat/[libraryId]/stream\nconst response = await fetch('/api/chat/library-id/stream', {\n  method: 'POST',\n  body: JSON.stringify({\n    message: 'What is this library about?',\n    answerLength: 'ausf\u00fchrlich',\n    chatId: 'optional-chat-id'\n  })\n});\n</code></pre>"},{"location":"reference/modules/chat.html#using-chat-orchestrator","title":"Using Chat Orchestrator","text":"<pre><code>import { runChatOrchestrated } from '@/lib/chat/orchestrator';\n\nconst result = await runChatOrchestrated({\n  libraryId: 'lib-id',\n  question: 'What is this about?',\n  retriever: 'chunk',\n  chatConfig: { targetLanguage: 'de' }\n});\n</code></pre>"},{"location":"reference/modules/chat.html#getting-vector-index-name","title":"Getting Vector Index Name","text":"<pre><code>import { getVectorIndexForLibrary } from '@/lib/chat/config';\n\n// Get vector index name for a library\n// Uses config.vectorStore.indexName if set, otherwise derives from library label\nconst indexName = getVectorIndexForLibrary(\n  { id: 'lib-id', label: 'My Library' },\n  { vectorStore: { indexName: 'custom-index' } } // optional chat config\n);\n</code></pre>"},{"location":"reference/modules/chat.html#dependencies","title":"Dependencies","text":"<ul> <li>Library System: Uses <code>@/lib/services/library-service</code> for library access</li> <li>Database: Uses <code>@/lib/mongodb-service</code> for chat and query persistence</li> <li>Storage: Uses storage providers for file access</li> <li>External: Uses OpenAI API for LLM calls, MongoDB Atlas Vector Search for vector search</li> </ul>"},{"location":"reference/modules/chat.html#chat-flow","title":"Chat Flow","text":"<ol> <li>Question Analysis: Analyze question to recommend retriever</li> <li>Retrieval: Retrieve relevant sources using selected retriever</li> <li>Prompt Building: Build prompt with sources and configuration</li> <li>LLM Call: Call OpenAI API with prompt</li> <li>Response Parsing: Parse structured response</li> <li>Logging: Log query and response for analytics</li> </ol>"},{"location":"reference/modules/chat.html#retriever-types","title":"Retriever Types","text":"<ul> <li><code>chunk</code>: Semantic search in MongoDB Vector Search for specific chunks</li> <li><code>summary</code>: MongoDB search for document summaries</li> <li><code>chunkSummary</code>: Loads all chunks from MongoDB without vector search</li> <li><code>auto</code>: Automatic retriever selection based on question analysis</li> </ul>"},{"location":"reference/modules/chat.html#story-mode","title":"Story Mode","text":"<p>Story mode provides structured topic exploration: - TOC (Table of Contents) queries - Structured topic hierarchy - Narrative exploration of knowledge</p>"},{"location":"reference/modules/chat.html#configuration-options","title":"Configuration Options","text":"<ul> <li>Answer Length: kurz, mittel, ausf\u00fchrlich, unbegrenzt</li> <li>Target Language: de, en, it, fr, es, ar</li> <li>Character: Various character perspectives</li> <li>Social Context: Formal, informal, technical</li> <li>Gender Inclusive: Gender-neutral formulations</li> </ul>"},{"location":"reference/modules/library.html","title":"Library Module","text":"<p>Complete documentation for the Library module.</p>"},{"location":"reference/modules/library.html#overview","title":"Overview","text":"<p>The Library module manages library configuration, state, and UI components. Libraries represent collections of files organized by storage backend and user ownership.</p>"},{"location":"reference/modules/library.html#key-files","title":"Key Files","text":""},{"location":"reference/modules/library.html#types","title":"Types","text":"<ul> <li><code>src/types/library.ts</code>: Complete library type definitions including <code>Library</code>, <code>ClientLibrary</code>, <code>LibraryChatConfig</code>, <code>StorageConfig</code>, and <code>PublicLibraryConfig</code></li> </ul>"},{"location":"reference/modules/library.html#state-management","title":"State Management","text":"<ul> <li><code>src/atoms/library-atom.ts</code>: Jotai atoms for library state management including active library, folder navigation, and file caching</li> </ul>"},{"location":"reference/modules/library.html#service","title":"Service","text":"<ul> <li><code>src/lib/services/library-service.ts</code>: MongoDB-based library service for CRUD operations</li> </ul>"},{"location":"reference/modules/library.html#components","title":"Components","text":"<ul> <li><code>src/components/library/library.tsx</code>: Main library component combining file tree, list, and preview</li> <li><code>src/components/library/library-header.tsx</code>: Library header with switcher and actions</li> <li><code>src/components/library/library-switcher.tsx</code>: Library selection component</li> <li><code>src/components/library/file-list.tsx</code>: File list component with header actions and record-level operations</li> </ul>"},{"location":"reference/modules/library.html#exports","title":"Exports","text":""},{"location":"reference/modules/library.html#types_1","title":"Types","text":"<ul> <li><code>Library</code>: Complete library configuration type</li> <li><code>ClientLibrary</code>: Client-side library type</li> <li><code>LibraryChatConfig</code>: Chat/RAG configuration</li> <li><code>StorageConfig</code>: Storage provider configuration</li> <li><code>PublicLibraryConfig</code>: Public publishing configuration</li> <li><code>StorageProviderType</code>: Supported storage provider types</li> </ul>"},{"location":"reference/modules/library.html#atoms","title":"Atoms","text":"<ul> <li><code>libraryAtom</code>: Main library state atom</li> <li><code>activeLibraryIdAtom</code>: Active library ID atom</li> <li><code>librariesAtom</code>: Libraries list atom</li> <li><code>activeLibraryAtom</code>: Active library object atom</li> <li><code>currentFolderIdAtom</code>: Current folder ID atom</li> <li><code>folderItemsAtom</code>: Folder items atom family</li> </ul>"},{"location":"reference/modules/library.html#service_1","title":"Service","text":"<ul> <li><code>LibraryService</code>: Singleton service class for library operations</li> </ul>"},{"location":"reference/modules/library.html#components_1","title":"Components","text":"<ul> <li><code>Library</code>: Main library component</li> <li><code>LibraryHeader</code>: Library header component</li> <li><code>LibrarySwitcher</code>: Library switcher component</li> <li><code>FileList</code>: File list component with actions and batch operations</li> </ul>"},{"location":"reference/modules/library.html#usage-examples","title":"Usage Examples","text":""},{"location":"reference/modules/library.html#accessing-library-state","title":"Accessing Library State","text":"<pre><code>import { useAtomValue } from 'jotai';\nimport { activeLibraryAtom, librariesAtom } from '@/atoms/library-atom';\n\nfunction MyComponent() {\n  const activeLibrary = useAtomValue(activeLibraryAtom);\n  const libraries = useAtomValue(librariesAtom);\n  // Use library data\n}\n</code></pre>"},{"location":"reference/modules/library.html#using-library-service","title":"Using Library Service","text":"<pre><code>import { LibraryService } from '@/lib/services/library-service';\n\nconst service = LibraryService.getInstance();\nconst libraries = await service.getUserLibraries(userEmail);\nconst library = await service.getLibrary(userEmail, libraryId);\n</code></pre>"},{"location":"reference/modules/library.html#library-component","title":"Library Component","text":"<pre><code>import { Library } from '@/components/library/library';\n\nexport default function LibraryPage() {\n  return &lt;Library /&gt;;\n}\n</code></pre>"},{"location":"reference/modules/library.html#using-root-items-hook","title":"Using Root Items Hook","text":"<pre><code>import { useRootItems, useRootItemsSync } from '@/hooks/use-root-items';\n\nfunction MyComponent() {\n  // Get function to load root items (async)\n  const getRootItems = useRootItems();\n\n  // Get root items synchronously if already loaded\n  const rootItems = useRootItemsSync();\n\n  useEffect(() =&gt; {\n    if (!rootItems) {\n      // Load root items if not available\n      getRootItems().then(items =&gt; {\n        console.log('Root items loaded:', items);\n      });\n    }\n  }, [getRootItems, rootItems]);\n}\n</code></pre>"},{"location":"reference/modules/library.html#dependencies","title":"Dependencies","text":"<ul> <li>Storage Layer: Uses <code>@/lib/storage/storage-factory</code> for provider access</li> <li>Database: Uses <code>@/lib/mongodb-service</code> for persistence</li> <li>State Management: Uses Jotai for state management</li> <li>Chat System: Uses <code>@/lib/chat/constants</code> for chat configuration types</li> </ul>"},{"location":"reference/modules/library.html#library-configuration","title":"Library Configuration","text":"<p>Libraries support: - Storage Configuration: Provider type and authentication - Chat Configuration: RAG settings, target language, character - Public Publishing: Gallery and story mode configuration - Gallery Configuration: Facets, detail view types</p>"},{"location":"reference/modules/library.html#state-management_1","title":"State Management","text":"<p>Library state is managed through Jotai atoms with a centralized caching strategy:</p>"},{"location":"reference/modules/library.html#state-architecture","title":"State Architecture","text":"<p>The Library module uses a centralized state management approach with Jotai atoms:</p> <ul> <li>Global State: Libraries list, active library</li> <li>Navigation State: Current folder, path</li> <li>UI State: Loading states, selected files</li> <li>Cache: Folder items cache for performance</li> </ul>"},{"location":"reference/modules/library.html#central-state-logic","title":"Central State Logic","text":""},{"location":"reference/modules/library.html#1-folder-items-cache-folderitemsatom","title":"1. Folder Items Cache (<code>folderItemsAtom</code>)","text":"<p>The <code>folderItemsAtom</code> is an atom family that caches folder contents by folder ID:</p> <pre><code>// Atom family for folder-specific caching\nexport const folderItemsAtom = atomFamily((folderId: string) =&gt; \n  atom&lt;StorageItem[] | null&gt;(null)\n);\n</code></pre> <p>How it works: - Each folder has its own cached state - When <code>currentFolderId === 'root'</code>, root items are cached - Components can access cached items synchronously without API calls - Cache is updated when folders are loaded via <code>StorageContext</code></p> <p>Benefits: - Eliminates duplicate API calls for the same folder - Provides instant access to already-loaded data - Reduces server load and improves performance</p>"},{"location":"reference/modules/library.html#2-root-items-central-management-userootitems","title":"2. Root Items Central Management (<code>useRootItems</code>)","text":"<p>The <code>useRootItems</code> hook provides centralized access to root items:</p> <pre><code>// Hook automatically uses cache if available\nconst getRootItems = useRootItems();\n\n// Synchronous access if root items are already cached\nconst rootItems = useRootItemsSync();\n</code></pre> <p>How it works: - Checks <code>folderItemsAtom</code> if <code>currentFolderId === 'root'</code> - Falls back to API call via <code>StorageContext.listItems('root')</code> - Uses request deduplication from <code>StorageContext</code> - All components share the same cached root items</p> <p>Integration with StorageContext: - <code>StorageContext</code> loads root items once when library is initialized - Updates <code>folderItemsAtom</code> when root items are loaded - <code>useRootItems</code> reads from cache, avoiding duplicate requests</p>"},{"location":"reference/modules/library.html#3-request-deduplication","title":"3. Request Deduplication","text":"<p>The <code>StorageContext</code> implements request deduplication:</p> <ul> <li>Multiple simultaneous requests for the same folder are merged</li> <li>Only one API call is made, all callers receive the same promise</li> <li>Prevents duplicate network requests during rapid navigation</li> </ul>"},{"location":"reference/modules/library.html#4-state-flow","title":"4. State Flow","text":"<pre><code>1. User navigates to folder\n   \u2193\n2. StorageContext.listItems(folderId)\n   \u2193\n3. Request deduplication checks for pending requests\n   \u2193\n4. API call (if not cached/deduplicated)\n   \u2193\n5. folderItemsAtom updated with results\n   \u2193\n6. All components using folderItemsAtom receive updates\n</code></pre>"},{"location":"reference/modules/library.html#state-atoms-reference","title":"State Atoms Reference","text":"Atom Type Purpose <code>libraryAtom</code> <code>LibraryState</code> Main library state container <code>activeLibraryIdAtom</code> <code>string</code> Currently active library ID <code>librariesAtom</code> <code>ClientLibrary[]</code> List of all user libraries <code>activeLibraryAtom</code> <code>ClientLibrary \\| undefined</code> Active library object (derived) <code>currentFolderIdAtom</code> <code>string</code> Current folder ID (default: 'root') <code>folderItemsAtom</code> <code>atomFamily</code> Folder items cache by folder ID <code>libraryStatusAtom</code> <code>LibraryStatus</code> Library loading status"},{"location":"reference/modules/library.html#best-practices","title":"Best Practices","text":"<ol> <li>Always use <code>folderItemsAtom</code> for folder contents - Don't make direct API calls</li> <li>Use <code>useRootItems</code> for root items - Provides cache-aware access</li> <li>Let StorageContext manage loading - Components should read from atoms, not trigger loads</li> <li>Cache is automatically updated - No manual cache invalidation needed</li> </ol>"},{"location":"reference/modules/library.html#file-list-component","title":"File List Component","text":"<p>The <code>FileList</code> component displays files and folders in a table format with header actions and record-level operations.</p>"},{"location":"reference/modules/library.html#header-actions","title":"Header Actions","text":"<p>The header bar (visible when not in compact mode) provides batch operations:</p> Button Icon Function When Visible Refresh <code>RefreshCw</code> Reloads current folder contents Always File Category Filter Filter icon Filters files by category (PDF, Audio, Video, etc.) Always Batch Transcription <code>ScrollText</code> Opens transcription dialog for selected audio/video files When audio/video files are selected Batch Transformation <code>Plus</code> Opens transformation dialog for selected PDF files When PDF files are selected Batch Ingest Text button Ingests selected documents into RAG system When PDF/Markdown files are selected Bulk Delete <code>Trash2</code> Deletes all selected files When any files are selected <p>Usage: 1. Select files using checkboxes 2. Header buttons appear automatically based on file types selected 3. Click button to perform batch operation 4. Operation runs in background, progress shown per file</p>"},{"location":"reference/modules/library.html#record-level-actions","title":"Record-Level Actions","text":"<p>Each file row provides the following actions:</p> Element Function Details Checkbox Select file for batch operations Leftmost column, enables batch actions File Icon Visual file type indicator Shows icon based on MIME type (PDF, Audio, Video, Text) File Name Select/Edit file Click to select, double-click to rename Shadow-Twin Icon View Shadow-Twin files Blue <code>FileText</code> icon, shows if Shadow-Twin exists (transcript or transformed file or directory) Create Transcript Create new transcript Plus icon, only shown for transcribable files without Shadow-Twin Delete Button Delete file Red <code>Trash2</code> icon, deletes file after confirmation <p>File Interactions: - Single Click: Selects file (opens in preview) - Double Click: Enters rename mode - Long Press (touch): Opens context menu - Drag &amp; Drop: Reorder files (if supported)</p> <p>Shadow-Twin Integration: - Shadow-Twin files (transcripts and transformed files) are grouped with their base files - Single Shadow-Twin icon indicates if Shadow-Twin exists (file or directory) - Clicking Shadow-Twin icon opens the transformed file (if available) or first transcript file - Shadow-Twin state is automatically analyzed and displayed</p>"},{"location":"reference/modules/library.html#file-categories","title":"File Categories","text":"<p>Files are automatically categorized: - PDF Files: Can be transformed, transcribed (OCR), and ingested - Audio Files: Can be transcribed and ingested - Video Files: Can be transcribed and ingested - Markdown Files: Can be ingested, may be transcripts or transformed files - Other Files: Display only, limited operations</p>"},{"location":"reference/modules/library.html#batch-operations","title":"Batch Operations","text":"<p>Batch operations support multiple files simultaneously:</p> <ol> <li>Batch Transcription: Transcribes multiple audio/video files in parallel</li> <li>Batch Transformation: Transforms multiple PDFs to Markdown</li> <li>Batch Ingestion: Ingests multiple documents into RAG system</li> <li>Bulk Delete: Deletes multiple files at once</li> </ol> <p>Selection: - Use checkboxes to select individual files - Selection persists across folder navigation - Header shows count of selected files</p>"},{"location":"reference/modules/library.html#api-integration","title":"API Integration","text":"<p>Libraries are managed through: - <code>GET /api/libraries</code>: Get user libraries - <code>POST /api/libraries</code>: Create/update library - <code>GET /api/libraries/[id]</code>: Get specific library - <code>PUT /api/libraries/[id]</code>: Update library - <code>DELETE /api/libraries/[id]</code>: Delete library</p>"},{"location":"reference/modules/storage.html","title":"Storage Module","text":"<p>Complete documentation for the Storage module.</p>"},{"location":"reference/modules/storage.html#overview","title":"Overview","text":"<p>The Storage module provides an abstraction layer for file storage operations across multiple backends. It supports local filesystem and OneDrive storage, with Nextcloud support in development.</p>"},{"location":"reference/modules/storage.html#key-files","title":"Key Files","text":""},{"location":"reference/modules/storage.html#core-types","title":"Core Types","text":"<ul> <li><code>src/lib/storage/types.ts</code>: Core type definitions including <code>StorageProvider</code> interface, <code>StorageItem</code>, and <code>StorageValidationResult</code></li> </ul>"},{"location":"reference/modules/storage.html#factory-providers","title":"Factory &amp; Providers","text":"<ul> <li><code>src/lib/storage/storage-factory.ts</code>: Main factory for creating storage providers</li> <li><code>src/lib/storage/filesystem-provider.ts</code>: Local filesystem provider implementation</li> <li><code>src/lib/storage/onedrive-provider.ts</code>: OneDrive provider implementation</li> <li><code>src/lib/storage/storage-factory-mongodb.ts</code>: MongoDB-based storage factory</li> </ul>"},{"location":"reference/modules/storage.html#client-server","title":"Client &amp; Server","text":"<ul> <li><code>src/lib/storage/filesystem-client.ts</code>: Client-side filesystem provider</li> <li><code>src/lib/storage/server-provider.ts</code>: Server-side provider helper</li> </ul>"},{"location":"reference/modules/storage.html#context-hooks","title":"Context &amp; Hooks","text":"<ul> <li><code>src/contexts/storage-context.tsx</code>: React context for storage provider management</li> <li><code>src/hooks/use-storage-provider.tsx</code>: React hook for storage provider access</li> </ul>"},{"location":"reference/modules/storage.html#utilities","title":"Utilities","text":"<ul> <li><code>src/lib/storage/supported-types.ts</code>: Supported library type definitions</li> </ul>"},{"location":"reference/modules/storage.html#exports","title":"Exports","text":""},{"location":"reference/modules/storage.html#types","title":"Types","text":"<ul> <li><code>StorageProvider</code>: Core interface for storage providers</li> <li><code>StorageItem</code>: Unified type for files and folders</li> <li><code>StorageItemMetadata</code>: Metadata for storage items</li> <li><code>StorageValidationResult</code>: Result of validation operations</li> <li><code>StorageError</code>: Error type for storage operations</li> </ul>"},{"location":"reference/modules/storage.html#classes","title":"Classes","text":"<ul> <li><code>StorageFactory</code>: Singleton factory for creating providers</li> <li><code>FileSystemProvider</code>: Local filesystem provider</li> <li><code>OneDriveProvider</code>: OneDrive provider</li> <li><code>FileSystemClient</code>: Client-side filesystem provider</li> <li><code>MongoDBStorageFactory</code>: MongoDB-based factory</li> </ul>"},{"location":"reference/modules/storage.html#functions","title":"Functions","text":"<ul> <li><code>getServerProvider()</code>: Creates server-side storage provider</li> <li><code>isSupportedLibraryType()</code>: Type guard for library types</li> <li><code>getSupportedLibraryTypesString()</code>: UI helper for supported types</li> </ul>"},{"location":"reference/modules/storage.html#usage-examples","title":"Usage Examples","text":""},{"location":"reference/modules/storage.html#creating-a-provider-client-side","title":"Creating a Provider (Client-side)","text":"<pre><code>import { StorageFactory } from '@/lib/storage/storage-factory';\n\nconst factory = StorageFactory.getInstance();\nconst provider = await factory.getProvider(libraryId);\nconst items = await provider.listItemsById('root');\n</code></pre>"},{"location":"reference/modules/storage.html#using-storage-context-react","title":"Using Storage Context (React)","text":"<pre><code>import { useStorage } from '@/contexts/storage-context';\n\nfunction MyComponent() {\n  const { provider, listItems, currentLibrary } = useStorage();\n  // Use provider for storage operations\n}\n</code></pre>"},{"location":"reference/modules/storage.html#server-side-provider","title":"Server-side Provider","text":"<pre><code>import { getServerProvider } from '@/lib/storage/server-provider';\n\nconst provider = await getServerProvider(userEmail, libraryId);\nconst items = await provider.listItemsById('root');\n</code></pre>"},{"location":"reference/modules/storage.html#dependencies","title":"Dependencies","text":"<ul> <li>Core Infrastructure: Uses <code>@/lib/env</code>, <code>@/lib/auth</code>, <code>@/lib/mongodb-service</code></li> <li>Library System: Uses <code>@/types/library</code>, <code>@/lib/services/library-service</code></li> <li>External: Uses Clerk for authentication, MongoDB for data storage</li> </ul>"},{"location":"reference/modules/storage.html#architecture","title":"Architecture","text":"<p>The storage module follows a layered architecture:</p> <ol> <li>Types Layer: Pure type definitions</li> <li>Provider Layer: Concrete provider implementations</li> <li>Factory Layer: Provider creation and management</li> <li>Context Layer: React integration</li> <li>API Layer: Server-side route handlers</li> </ol>"},{"location":"reference/modules/storage.html#supported-storage-backends","title":"Supported Storage Backends","text":"<ul> <li>\u2705 Local File System: Direct filesystem access</li> <li>\u2705 OneDrive: Microsoft OneDrive integration</li> <li>\ud83d\udea7 Nextcloud: In development</li> </ul>"},{"location":"reference/modules/storage.html#error-handling","title":"Error Handling","text":"<p>Storage operations use typed errors (<code>StorageError</code>) with error codes: - <code>HTTP_ERROR</code>: Network/HTTP errors - <code>AUTH_ERROR</code>: Authentication failures - <code>NOT_FOUND</code>: Item not found - <code>VALIDATION_ERROR</code>: Configuration validation failures</p>"},{"location":"reference/modules/storage.html#performance-optimizations","title":"Performance Optimizations","text":"<ul> <li>Caching: Client-side caching for file listings</li> <li>Request Deduplication: Prevents duplicate concurrent requests</li> <li>Lazy Loading: Providers created on-demand</li> <li>Connection Pooling: MongoDB connection reuse</li> </ul>"},{"location":"use-cases/index.html","title":"Use Cases","text":"<p>Short guides for common tasks in Common Knowledge Scout.</p>"},{"location":"use-cases/index.html#basic-use-cases","title":"Basic Use Cases","text":"<ul> <li>Library Setup \u2013 Create and configure a library</li> <li>PDF Transformation \u2013 Transform PDF files to Markdown</li> <li>Media Transformation \u2013 Transcribe audio and video files</li> </ul>"},{"location":"use-cases/index.html#advanced-use-cases","title":"Advanced Use Cases","text":"<ul> <li>Web Scraping \u2013 Scrape web content and import events</li> <li>Publishing \u2013 Publish library publicly</li> <li>Chat &amp; Story Mode \u2013 Explore knowledge with chat</li> </ul>"},{"location":"use-cases/index.html#advanced-features","title":"Advanced Features","text":"<ul> <li>Batch Operations \u2013 Process multiple files simultaneously</li> </ul>"},{"location":"use-cases/index.html#further-information","title":"Further Information","text":"<p>For detailed technical information see: - Architecture Documentation - Reference Documentation - Concepts Documentation</p>"},{"location":"use-cases/batch-operations.html","title":"Batch Operations","text":""},{"location":"use-cases/batch-operations.html#what-is-achieved","title":"What is achieved?","text":"<p>Process multiple files simultaneously for transformation, transcription, or ingestion. Save time by handling multiple operations in parallel.</p>"},{"location":"use-cases/batch-operations.html#prerequisites","title":"Prerequisites","text":"<ul> <li>Active library selected</li> <li>Multiple files available in Library Browser</li> </ul>"},{"location":"use-cases/batch-operations.html#steps","title":"Steps","text":"<ol> <li>Open the Library view</li> <li>Navigate to the folder containing files</li> <li>Select multiple files:</li> <li>Use checkboxes to select individual files</li> <li>Or select all files in a folder</li> <li>Choose the operation:</li> <li>Transformation: Transform PDFs to Markdown</li> <li>Transcription: Transcribe audio/video files</li> <li>Ingestion: Ingest documents into RAG system</li> <li>Configure options:</li> <li>Select target language</li> <li>Choose template (if applicable)</li> <li>Set processing options</li> <li>Click \"Start Batch Processing\"</li> <li>Monitor progress:</li> <li>View overall progress bar</li> <li>See individual file status</li> <li>Check success/failure counts</li> <li>Review results:</li> <li>Successful transformations appear as Shadow Twins</li> <li>Failed files show error messages</li> <li>Retry failed operations if needed</li> </ol>"},{"location":"use-cases/batch-operations.html#result","title":"Result","text":"<p>Multiple files are processed in parallel. Results appear as they complete, with success/failure status for each file. Internally the same three phases are used as for single-file PDF transformation (Extract \u2192 Template \u2192 Ingestion); depending on existing artifacts, individual phases may be skipped automatically.</p>"},{"location":"use-cases/batch-operations.html#tips","title":"Tips","text":"<ul> <li>Batch operations run in the background</li> <li>You can continue working while processing</li> <li>Failed files can be retried individually</li> <li>Progress is saved - you can refresh without losing state</li> <li>Large batches may take time - be patient</li> </ul>"},{"location":"use-cases/batch-operations.html#further-information","title":"Further Information","text":"<ul> <li>Transform Service Documentation</li> <li>PDF Transformation for single files</li> <li>Media Transformation for single files</li> </ul>"},{"location":"use-cases/chat-exploration.html","title":"Chat &amp; Story Mode","text":""},{"location":"use-cases/chat-exploration.html#what-is-achieved","title":"What is achieved?","text":"<p>Explore your knowledge base using natural language queries. The Chat interface uses RAG (Retrieval-Augmented Generation) to find relevant content and generate answers based on your library's documents.</p>"},{"location":"use-cases/chat-exploration.html#prerequisites","title":"Prerequisites","text":"<ul> <li>Active library selected</li> <li>Documents transformed and ingested into the library</li> </ul>"},{"location":"use-cases/chat-exploration.html#steps","title":"Steps","text":"<ol> <li>Open the Library view</li> <li>Click the Chat icon or open the chat panel</li> <li>Configure chat settings (optional):</li> <li>Answer Length: Short, medium, or long answers</li> <li>Retriever: Chunk-based or summary-based retrieval</li> <li>Target Language: Language for responses</li> <li>Character: Perspective for answers (e.g., expert, beginner)</li> <li>Social Context: Context for answer generation</li> <li>Type your question in the chat input</li> <li>The system will:</li> <li>Analyze your question</li> <li>Retrieve relevant documents</li> <li>Generate an answer based on your library content</li> <li>Display sources used for the answer</li> <li>Continue the conversation with follow-up questions</li> <li>Use Story Mode for narrative-style exploration</li> </ol>"},{"location":"use-cases/chat-exploration.html#result","title":"Result","text":"<p>You receive answers based on your library's content with source citations. The chat history is saved for future reference.</p>"},{"location":"use-cases/chat-exploration.html#tips","title":"Tips","text":"<ul> <li>Use specific questions for better results</li> <li>Check source citations to verify information</li> <li>Story Mode provides narrative-style exploration</li> <li>Chat history is saved automatically</li> <li>Filter by facets/metadata for focused queries</li> </ul>"},{"location":"use-cases/chat-exploration.html#further-information","title":"Further Information","text":"<ul> <li>Chat System Documentation</li> <li>Chat Orchestration</li> </ul>"},{"location":"use-cases/file-transformation-media.html","title":"Media Transformation (Audio/Video)","text":""},{"location":"use-cases/file-transformation-media.html#what-is-achieved","title":"What is achieved?","text":"<p>Transcribe audio and video files to text. Extract transcripts with speaker identification and save them as searchable Markdown files.</p>"},{"location":"use-cases/file-transformation-media.html#prerequisites","title":"Prerequisites","text":"<ul> <li>Active library selected</li> <li>Audio or video file available in Library Browser</li> </ul>"},{"location":"use-cases/file-transformation-media.html#steps","title":"Steps","text":"<ol> <li>Open the Library view</li> <li>Navigate to the folder containing the audio/video file</li> <li>Select the media file (single file or multiple for batch processing)</li> <li>Click the Transcription icon or use the context menu</li> <li>In the transcription dialog:</li> <li>Select the target language for transcription</li> <li>Optional: Choose a template for structured output</li> <li>Click \"Start Transcription\"</li> <li>Monitor progress in the dialog</li> <li>After completion: The transcript Markdown file appears next to the original</li> </ol>"},{"location":"use-cases/file-transformation-media.html#result","title":"Result","text":"<p>A new Markdown file named <code>[OriginalName].md</code> is created. It contains the transcribed text, speaker identification (if available), and metadata in frontmatter.</p>"},{"location":"use-cases/file-transformation-media.html#tips","title":"Tips","text":"<ul> <li>Transcription runs in the background - you can continue working</li> <li>For video files, transcripts can be extracted from VTT files if available</li> <li>Errors are displayed in an error message</li> <li>Batch processing is supported for multiple files</li> </ul>"},{"location":"use-cases/file-transformation-media.html#further-information","title":"Further Information","text":"<ul> <li>Transform Service Documentation</li> <li>Batch Operations for multiple files</li> </ul>"},{"location":"use-cases/file-transformation-pdf.html","title":"PDF Transformation","text":""},{"location":"use-cases/file-transformation-pdf.html#what-is-achieved","title":"What is achieved?","text":"<p>Transform PDF files into structured Markdown documents. Text, images, and structure are extracted and saved as searchable Markdown files. The transformation process consists of three phases: Extract, Template/Metadata, and Ingestion.</p>"},{"location":"use-cases/file-transformation-pdf.html#prerequisites","title":"Prerequisites","text":"<ul> <li>Active library selected</li> <li>PDF file available in Library Browser</li> </ul>"},{"location":"use-cases/file-transformation-pdf.html#steps","title":"Steps","text":"<ol> <li>Open the Library view</li> <li>Navigate to the folder containing the PDF file</li> <li>Select the PDF file (single file or multiple for batch processing)</li> <li>Click the Transformation icon or use the context menu</li> <li>In the transformation dialog:</li> <li>Select the target language for transformation</li> <li>Optional: Choose a template for structured output</li> <li>Optional: Enable \"Extract OCR images\" for Mistral OCR extracted images</li> <li>Optional: Enable \"Extract page images\" for PDF pages as images</li> <li>Click \"Start Transformation\"</li> <li>Monitor progress in the dialog (three phases: Extract \u2192 Template \u2192 Ingestion)</li> <li>After completion: The transformed Markdown files (Shadow Twins) appear next to the original</li> </ol>"},{"location":"use-cases/file-transformation-pdf.html#transformation-phases","title":"Transformation Phases","text":""},{"location":"use-cases/file-transformation-pdf.html#phase-1-extract-extraction","title":"Phase 1: Extract (Extraction)","text":"<ul> <li>What happens: PDF \u2192 Text + Images extraction</li> <li>Output: Markdown file without frontmatter (<code>document.md</code> - Transcript)</li> <li>Images: Extracted as ZIP archives or Base64 (Mistral OCR)</li> <li>Shadow-Twin Directory: Created automatically if images are present (<code>.document.pdf/</code>)</li> </ul>"},{"location":"use-cases/file-transformation-pdf.html#phase-2-templatemetadata","title":"Phase 2: Template/Metadata","text":"<ul> <li>What happens: Frontmatter is added and the document is structured (chapters, topics, etc.).</li> <li>Input: Markdown without frontmatter (<code>document.md</code>)</li> <li>Output: Markdown with frontmatter (<code>document.de.md</code> - Transformed)</li> <li>Automatic skipping:</li> <li>If the document already has chapter metadata (<code>chapters</code> in frontmatter), the template phase is skipped.</li> <li>If only <code>pages</code> are missing, they are automatically reconstructed from the <code>--- Seite N ---</code> markers in the body (no extra analysis needed).</li> </ul>"},{"location":"use-cases/file-transformation-pdf.html#phase-3-ingestion-rag","title":"Phase 3: Ingestion (RAG)","text":"<ul> <li>What happens: Markdown \u2192 Vector storage, MongoDB</li> <li>Images: Uploaded to Azure Storage for frontend access</li> <li>Result: Document is searchable via RAG (Retrieval Augmented Generation)</li> </ul>"},{"location":"use-cases/file-transformation-pdf.html#result-structure","title":"Result Structure","text":""},{"location":"use-cases/file-transformation-pdf.html#shadow-twin-directory-when-images-are-present","title":"Shadow-Twin Directory (when images are present)","text":"<p>If images are extracted, a Shadow-Twin directory is created: <pre><code>.document.pdf/\n\u251c\u2500\u2500 document.md          (Transcript - Phase 1 output, no frontmatter)\n\u251c\u2500\u2500 document.de.md       (Transformed - Phase 2 output, with frontmatter)\n\u251c\u2500\u2500 page-001.png        (Extracted images)\n\u251c\u2500\u2500 page-002.png\n\u2514\u2500\u2500 ...\n</code></pre></p>"},{"location":"use-cases/file-transformation-pdf.html#shadow-twin-files-when-no-images","title":"Shadow-Twin Files (when no images)","text":""},{"location":"use-cases/file-transformation-pdf.html#shadow-twin-files-when-no-images_1","title":"Shadow-Twin Files (when no images)","text":"<p>If no images are extracted, files are saved directly next to the PDF: <pre><code>document.pdf\ndocument.md          (Transcript - Phase 1 output, no frontmatter)\ndocument.de.md       (Transformed - Phase 2 output, with frontmatter)\n</code></pre> For more detailed information about the Shadow-Twin structure, see the Shadow-Twin Architecture Documentation.</p>"},{"location":"use-cases/file-transformation-pdf.html#file-naming-convention","title":"File Naming Convention","text":"<ul> <li>Transcript File (<code>document.md</code>): </li> <li>Created after Phase 1 (Extract)</li> <li>Contains extracted text without frontmatter</li> <li> <p>No language suffix (original language of source)</p> </li> <li> <p>Transformed File (<code>document.de.md</code>):</p> </li> <li>Created after Phase 2 (Template)</li> <li>Contains text with frontmatter and metadata</li> <li>With language suffix (target language for transformation)</li> </ul>"},{"location":"use-cases/file-transformation-pdf.html#parameters","title":"Parameters","text":"<ul> <li><code>includeOcrImages</code>: Request Mistral OCR images as Base64 (default: <code>true</code> for Mistral OCR)</li> <li><code>includePageImages</code>: Extract PDF pages as images and return as ZIP archive (default: <code>true</code> for Mistral OCR)</li> </ul>"},{"location":"use-cases/file-transformation-pdf.html#tips","title":"Tips","text":"<ul> <li>Shadow Twins are automatically linked with the original</li> <li>Transformation runs in the background - you can continue working</li> <li>Errors are displayed in an error message</li> <li>Both transcript and transformed files can coexist (different names)</li> <li>Shadow-Twin directory is hidden (starts with <code>.</code>)</li> </ul>"},{"location":"use-cases/file-transformation-pdf.html#further-information","title":"Further Information","text":"<ul> <li>Shadow-Twin Architecture Documentation</li> <li>PDF Transformation Phases</li> <li>Transform Service Documentation</li> <li>Batch Operations for multiple files</li> </ul>"},{"location":"use-cases/library-setup.html","title":"Library Setup","text":""},{"location":"use-cases/library-setup.html#what-is-achieved","title":"What is achieved?","text":"<p>Create a new library to organize your knowledge. Libraries serve as containers for documents, media files, and transformed content.</p>"},{"location":"use-cases/library-setup.html#prerequisites","title":"Prerequisites","text":"<ul> <li>Authenticated user</li> <li>Access to storage provider (Local Filesystem or OneDrive)</li> </ul>"},{"location":"use-cases/library-setup.html#steps","title":"Steps","text":"<ol> <li>Go to Settings \u2192 Library</li> <li>Click \"Create New Library\" (if no library exists yet)</li> <li>Fill out the form:</li> <li>Name: Enter a meaningful name (at least 3 characters)</li> <li>Storage Type: Choose between \"Local\" (local filesystem) or \"OneDrive\"</li> <li>Storage Path: Enter the path where files should be stored</li> <li>Description (optional): Short description of the library</li> <li>Configure the transcription strategy:</li> <li>Shadow Twin: Transformed files are saved as separate Markdown files</li> <li>Database: Transcripts are stored in the database</li> <li>Click \"Save\"</li> </ol>"},{"location":"use-cases/library-setup.html#result","title":"Result","text":"<p>A new library is created and can be used for files. The library appears in the Library Switcher and can be selected as the active library.</p>"},{"location":"use-cases/library-setup.html#further-information","title":"Further Information","text":"<ul> <li>Library Module Documentation</li> <li>Storage Provider Concepts</li> </ul>"},{"location":"use-cases/publishing.html","title":"Publishing &amp; Gallery","text":""},{"location":"use-cases/publishing.html#what-is-achieved","title":"What is achieved?","text":"<p>Publish your library publicly so others can access and explore your knowledge base. Create a public gallery with a custom URL, API access, and configurable display settings.</p>"},{"location":"use-cases/publishing.html#prerequisites","title":"Prerequisites","text":"<ul> <li>Active library configured</li> <li>Library owner permissions</li> </ul>"},{"location":"use-cases/publishing.html#steps","title":"Steps","text":"<ol> <li>Go to Settings \u2192 Public</li> <li>Enable \"Public Library\" toggle</li> <li>Configure public settings:</li> <li>Slug Name: URL-friendly identifier (lowercase, numbers, hyphens only)</li> <li>Public Name: Display name for your library</li> <li>Description: Public description of your library</li> <li>Icon: Choose an icon from common options (optional)</li> <li>Configure gallery display:</li> <li>Headline: Main headline for the gallery page</li> <li>Subtitle: Subtitle text</li> <li>Description: Gallery description</li> <li>Filter Description: Help text for filters</li> <li>Generate API Key (if needed for programmatic access)</li> <li>Click \"Save\"</li> <li>Your library is now accessible at: <code>/public/[slug-name]</code></li> </ol>"},{"location":"use-cases/publishing.html#result","title":"Result","text":"<p>Your library is publicly accessible. Visitors can browse documents, use the chat interface, and explore your knowledge base without authentication.</p>"},{"location":"use-cases/publishing.html#tips","title":"Tips","text":"<ul> <li>The slug name must be unique across all public libraries</li> <li>API keys provide programmatic access to your library</li> <li>Gallery settings customize the public-facing interface</li> <li>You can disable public access at any time</li> </ul>"},{"location":"use-cases/publishing.html#further-information","title":"Further Information","text":"<ul> <li>Library Module Documentation</li> <li>Public Publishing Settings</li> </ul>"},{"location":"use-cases/web-scraping.html","title":"Web Scraping &amp; Event Import","text":""},{"location":"use-cases/web-scraping.html#what-is-achieved","title":"What is achieved?","text":"<p>Scrape web content and import event data (conferences, workshops, talks) into your library. Extract structured data from web pages, convert them to Markdown format, and organize them by events and tracks.</p>"},{"location":"use-cases/web-scraping.html#prerequisites","title":"Prerequisites","text":"<ul> <li>Active library selected</li> <li>Event Monitor access</li> <li>Event URL or web page with structured content</li> </ul>"},{"location":"use-cases/web-scraping.html#steps","title":"Steps","text":"<ol> <li>Navigate to Event Monitor page</li> <li>Click \"Create Track\" to start a new batch</li> <li>Enter event information:</li> <li>Event Name: Name of the event/conference</li> <li>Track Name: Track or session category</li> <li>Source URL: URL of the web page to scrape</li> <li>Configure scraping options:</li> <li>Select target language for transformation</li> <li>Choose template for structured output (optional)</li> <li>Start the scraping process</li> <li>Monitor progress in the Event Monitor:</li> <li>View job status (pending, running, completed, failed)</li> <li>Filter by event name</li> <li>Check individual job details</li> <li>After completion: Sessions are transformed to Markdown files in your library</li> </ol>"},{"location":"use-cases/web-scraping.html#result","title":"Result","text":"<p>Event sessions are imported as structured Markdown files organized by event and track. Each session contains metadata, transcripts (if available), and associated media files.</p>"},{"location":"use-cases/web-scraping.html#tips","title":"Tips","text":"<ul> <li>Use the Event Filter to focus on specific events</li> <li>Batch operations allow processing multiple tracks simultaneously</li> <li>Failed jobs can be retried individually</li> <li>Archive completed batches for organization</li> </ul>"},{"location":"use-cases/web-scraping.html#further-information","title":"Further Information","text":"<ul> <li>Event Job System Documentation</li> <li>Batch Operations for multiple files</li> </ul>"}]}