
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://localhost:3000/docs/_history/09_september/cursor_2025.09.15_1_fehlerbehebung_und_bnpm_build_st.html">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Fehlerbehebung und BNPM Build starten - Common Knowledge Scout</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/print.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fehlerbehebung-und-bnpm-build-starten" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Common Knowledge Scout" class="md-header__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Common Knowledge Scout
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Fehlerbehebung und BNPM Build starten
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Common Knowledge Scout" class="md-nav__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Common Knowledge Scout
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/intro.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/features.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/architecture.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/core-components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core Components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/getting-started.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/settings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Settings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/library.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using the Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/event-monitor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event Monitor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/batch-session-import.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Session Import
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/troubleshooting.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/faq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/storage-provider.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage Provider
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/localstorage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileSystem (Local)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/image-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/pdf/extraction-methods.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/metadata.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metadata
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/global-state.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Global State
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/header.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Header
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/breadcrumb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Breadcrumb
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-tree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileTree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-list.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileList
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/upload.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Upload
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-preview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FilePreview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/batch-transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/error-handling-logging-testing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Error Handling & Tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/initialization-sequence.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Initialization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Library Components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/shadowtwins.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/extended-shadowtwin.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extended Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/transformation-service.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformation Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/video-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Video Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/glossary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/secretary-services.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Secretary Services
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/track-processor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Track Processor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chat-response-generation-process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat & Story Mode
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/deployment/docker.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker Deployment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/quick-setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Quick Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/package-strategy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Package Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="fehlerbehebung-und-bnpm-build-starten">Fehlerbehebung und BNPM Build starten<a class="headerlink" href="#fehlerbehebung-und-bnpm-build-starten" title="Permanent link">&para;</a></h1>
<p><em>Exported on 10/9/2025 at 14:59:19 GMT+2 from Cursor (1.7.38)</em></p>
<hr />
<p><strong>User</strong></p>
<p>Linterfehler beheben und diesen BNPM Build selbstständig starten und auf neue Fehler prüfen, solange bis der Build durchläuft.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich starte mit einer kurzen Bestandsaufnahme und suche die fehlerhafte Stelle im Code, um den Typfehler sauber zu beheben. Danach führe ich den Build aus und iteriere, bis er durchläuft.</p>
<p>Ich suche die fehlerhafte Stelle im Retry-Route-Handler und die zugehörigen Typen, um den Zugriff auf <code>bin.name</code> korrekt zu ersetzen. Anschließend passe ich den Code minimal an.</p>
<p>Ich suche die Typdefinition von <code>getServerProvider</code> und der Rückgabe von <code>getBinary</code>, um den korrekten Feldnamen zu verwenden und den minimalen Fix vorzunehmen. Danach passe ich die fehlerhafte Zeile an.</p>
<p>Ich passe die fehlerhafte Zeile in der Retry-Route an (entferne den Zugriff auf <code>bin.name</code> und setze einen sicheren Fallback-Dateinamen). Danach starte ich den Build und prüfe auf weitere Fehler.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">startWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nur failed oder queued Jobs können neu gestartet werden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// In-Place Requeue: Bestehenden Job zurücksetzen und mit gleicher jobId erneut an Secretary senden</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quelle für Retry unvollständig&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Secretary-FormData aufbauen (wie in process-pdf für den Worker-Call)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">serviceFormData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extraction_method&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;native&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Callback-URL und -Token (neues Secret generieren)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">appUrl</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;NEXT_PUBLIC_APP_URL fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mf">24</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64url&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">newSecret</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Job zurücksetzen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">initializeSteps</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">parameters</span><span class="p">);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobSecretHash</span><span class="o">:</span><span class="w"> </span><span class="kt">newHash</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_sent_requeue&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// Live-Event + Watchdog</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;requeued&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.itemId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">startWatchdog</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mf">600</span><span class="nx">_000</span><span class="p">);</span>

<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_url&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">newSecret</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Secretary aufrufen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseUrl</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">pdf/process`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/pdf/process`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">normalizedUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">serviceFormData</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">message</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">503</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_ack&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">data?.error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Secretary Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Ich entferne die ungenutzten Importe, die den Build stoppen, und starte anschließend erneut den Build.</p>
<p>Ich entferne ungenutzte Importe in drei Dateien, um die ESLint-Fehler zu beheben, und starte anschließend den Build erneut.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">startWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nur failed oder queued Jobs können neu gestartet werden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// In-Place Requeue: Bestehenden Job zurücksetzen und mit gleicher jobId erneut an Secretary senden</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quelle für Retry unvollständig&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Secretary-FormData aufbauen (wie in process-pdf für den Worker-Call)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">serviceFormData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extraction_method&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;native&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Callback-URL und -Token (neues Secret generieren)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">appUrl</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;NEXT_PUBLIC_APP_URL fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mf">24</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64url&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">newSecret</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Job zurücksetzen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">initializeSteps</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">parameters</span><span class="p">);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobSecretHash</span><span class="o">:</span><span class="w"> </span><span class="kt">newHash</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_sent_requeue&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// Live-Event + Watchdog</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;requeued&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.itemId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">startWatchdog</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mf">600</span><span class="nx">_000</span><span class="p">);</span>

<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_url&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">newSecret</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Secretary aufrufen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseUrl</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">pdf/process`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/pdf/process`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">normalizedUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">serviceFormData</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">message</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">503</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_ack&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">data?.error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Secretary Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useAtom } from &#39;jotai&#39;
import { useCallback, useEffect, useMemo, useState } from &#39;react&#39;
import { combinedChatDialogOpenAtom } from &#39;@/atoms/combined-chat-atom&#39;
import { Dialog, DialogContent, DialogHeader, DialogTitle } from &#39;@/components/ui/dialog&#39;
import { Button } from &#39;@/components/ui/button&#39;
import { Label } from &#39;@/components/ui/label&#39;
import { Input } from &#39;@/components/ui/input&#39;
import { useAtomValue } from &#39;jotai&#39;
import { activeLibraryIdAtom } from &#39;@/atoms/library-atom&#39;
import { StorageItem, StorageProvider } from &#39;@/lib/storage/types&#39;
import { toast } from &#39;sonner&#39;

interface CombinedChatDialogProps {
  provider: StorageProvider | null
  items: Array&lt;StorageItem&gt;
  selectedTemplate: string
  selectedLanguage: string
  defaultFileName: string
  systemPrompt?: string
  templateBody?: string
}

export function CombinedChatDialog({ provider, items, selectedTemplate, selectedLanguage, defaultFileName, systemPrompt = &#39;Du bist ein hilfreicher, faktenbasierter Assistent. Nutze ausschließlich den bereitgestellten Kontext.&#39;, templateBody = &#39;&#39; }: CombinedChatDialogProps) {
  const [open, setOpen] = useAtom(combinedChatDialogOpenAtom)
  const libraryId = useAtomValue(activeLibraryIdAtom)
  const [instructions, setInstructions] = useState&lt;string&gt;(templateBody)
  const [answer, setAnswer] = useState&lt;string&gt;(&#39;&#39;)
  const [loading, setLoading] = useState&lt;boolean&gt;(false)
  const [fileName, setFileName] = useState&lt;string&gt;(defaultFileName)
  const [templateContent, setTemplateContent] = useState&lt;string&gt;(templateBody)
  const [templateVars, setTemplateVars] = useState&lt;Array&lt;{ key: string; question: string }&gt;&gt;([])
  const [chatInput, setChatInput] = useState&lt;string&gt;(&#39;&#39;)
  const [chatHistory, setChatHistory] = useState&lt;Array&lt;{ role: &#39;user&#39;|&#39;assistant&#39;; content: string }&gt;&gt;([])

  const disabled = useMemo(() =&gt; loading || !provider || items.length === 0 || !libraryId, [loading, provider, items.length, libraryId])

  // Template laden (aus /templates/&lt;selectedTemplate&gt;.md), wenn kein templateBody gesetzt ist
  useEffect(() =&gt; {
    let cancelled = false
    async function loadTemplate() {
      if (!provider || !open) return
      try {
        if (templateBody) {
          if (!cancelled) setTemplateContent(templateBody)
        } else {
          const roots = await provider.listItemsById(&#39;root&#39;)
          const templatesFolder = roots.find(it =&gt; it.type === &#39;folder&#39; &amp;&amp; it.metadata?.name === &#39;templates&#39;)
          if (!templatesFolder) return
          const items = await provider.listItemsById(templatesFolder.id)
          const tpl = items.find(it =&gt; it.type === &#39;file&#39; &amp;&amp; it.metadata?.name?.toLowerCase() === `${selectedTemplate.toLowerCase()}.md`)
          if (!tpl) return
          const { blob } = await provider.getBinary(tpl.id)
          const text = await blob.text()
          if (!cancelled) { setTemplateContent(text); setInstructions(text) }
        }
      } catch { /* ignore */ }
    }
    loadTemplate()
    return () =&gt; { cancelled = true }
  }, [provider, open, selectedTemplate, templateBody])

  // Variablen aus Template extrahieren
  useEffect(() =&gt; {
    const vars: Array&lt;{ key: string; question: string }&gt; = []
    const re = /\{\{([^}|]+)\|([^}]+)\}\}/g
    let m: RegExpExecArray | null
    while ((m = re.exec(templateContent)) !== null) {
      const key = m[1].trim()
      const question = m[2].trim()
      if (key) vars.push({ key, question })
    }
    setTemplateVars(vars)
  }, [templateContent])

  const loadContextText = useCallback(async (): Promise&lt;string&gt; =&gt; {
    if (!provider) return &#39;&#39;
    const parts: string[] = []
    for (const it of items) {
      try {
        const { blob } = await provider.getBinary(it.id)
        const text = await blob.text()
        parts.push(`# ${it.metadata.name}\n\n${text}\n\n---\n`)
      } catch {
        // ignore single file errors
      }
    }
    return parts.join(&#39;\n&#39;)
  }, [provider, items])

  const handleTemplateChatSend = useCallback(async () =&gt; {
    const msg = chatInput.trim()
    if (!msg) return
    try {
      setLoading(true)
      setChatHistory(prev =&gt; [...prev, { role: &#39;user&#39;, content: msg }])
      setChatInput(&#39;&#39;)
      const res = await fetch(`/api/chat/${encodeURIComponent(libraryId)}/adhoc`, {
        method: &#39;POST&#39;, headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
        body: JSON.stringify({ systemPrompt, instructions: msg, contextText: templateContent, answerLength: &#39;mittel&#39; })
      })
      const data = await res.json().catch(() =&gt; ({})) as { status?: string; answer?: string; error?: string }
      if (!res.ok) throw new Error(data?.error || &#39;Chat fehlgeschlagen&#39;)
      const ai = (data?.answer || &#39;&#39;).trim()
      setChatHistory(prev =&gt; [...prev, { role: &#39;assistant&#39;, content: ai }])
    } catch (e) {
      toast.error(&#39;Fehler&#39;, { description: e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39; })
    } finally {
      setLoading(false)
    }
  }, [libraryId, systemPrompt, templateContent, chatInput])

  const handlePreview = useCallback(async () =&gt; {
    try {
      setLoading(true)
      setAnswer(&#39;&#39;)
      const contextText = await loadContextText()
      const res = await fetch(`/api/chat/${encodeURIComponent(libraryId)}/adhoc`, {
        method: &#39;POST&#39;,
        headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
        body: JSON.stringify({ systemPrompt, instructions, contextText, answerLength: &#39;mittel&#39; })
      })
      const data = await res.json().catch(() =&gt; ({})) as { status?: string; answer?: string; error?: string }
      if (!res.ok) throw new Error(data?.error || &#39;Vorschau fehlgeschlagen&#39;)
      setAnswer(data?.answer || &#39;&#39;)
    } catch (e) {
      toast.error(&#39;Fehler&#39;, { description: e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39; })
    } finally {
      setLoading(false)
    }
  }, [libraryId, systemPrompt, instructions, loadContextText])

  return (
    &lt;Dialog open={open} onOpenChange={setOpen}&gt;
      &lt;DialogContent className=&quot;max-w-4xl&quot;&gt;
        &lt;DialogHeader&gt;
          &lt;DialogTitle&gt;Prompt‑Design (kombinierter Dialog)&lt;/DialogTitle&gt;
        &lt;/DialogHeader&gt;

        &lt;div className=&quot;grid grid-cols-1 md:grid-cols-2 gap-4 py-4&quot;&gt;
          {/* Linke Spalte: Template‑Struktur + Chat mit Template */}
          &lt;div className=&quot;space-y-3&quot;&gt;
            &lt;div&gt;
              &lt;Label&gt;Template&lt;/Label&gt;
              &lt;div className=&quot;text-sm text-muted-foreground mb-2&quot;&gt;{selectedTemplate} · {selectedLanguage}&lt;/div&gt;
              &lt;div className=&quot;border rounded p-2 max-h-[180px] overflow-auto text-sm&quot;&gt;
                {templateVars.length === 0 ? (
                  &lt;div className=&quot;text-muted-foreground text-xs&quot;&gt;Keine Variablen gefunden.&lt;/div&gt;
                ) : (
                  &lt;ul className=&quot;list-disc pl-5 space-y-1&quot;&gt;
                    {templateVars.map(v =&gt; (
                      &lt;li key={v.key}&gt;&lt;span className=&quot;font-mono&quot;&gt;{v.key}&lt;/span&gt;: {v.question}&lt;/li&gt;
                    ))}
                  &lt;/ul&gt;
                )}
              &lt;/div&gt;
            &lt;/div&gt;

            &lt;div&gt;
              &lt;Label&gt;Template‑Chat&lt;/Label&gt;
              &lt;div className=&quot;border rounded p-2 h-[180px] overflow-auto text-sm mb-2&quot;&gt;
                {chatHistory.length === 0 ? (
                  &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;Stelle eine Frage zum Template, z. B. „Wie präzisiere ich die Zusammenfassung?“. Antwort erscheint hier.&lt;/div&gt;
                ) : (
                  &lt;div className=&quot;space-y-2&quot;&gt;
                    {chatHistory.map((m, i) =&gt; (
                      &lt;div key={i} className={m.role === &#39;user&#39; ? &#39;text-right&#39; : &#39;&#39;}&gt;
                        &lt;span className={&quot;inline-block rounded px-2 py-1 &quot; + (m.role === &#39;user&#39; ? &#39;bg-primary text-primary-foreground&#39; : &#39;bg-muted&#39;)}&gt;{m.content}&lt;/span&gt;
                      &lt;/div&gt;
                    ))}
                  &lt;/div&gt;
                )}
              &lt;/div&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;Input value={chatInput} onChange={(e) =&gt; setChatInput(e.target.value)} placeholder=&quot;Frage an das Template…&quot; onKeyDown={(e) =&gt; { if (e.key === &#39;Enter&#39;) handleTemplateChatSend() }} /&gt;
                &lt;Button onClick={handleTemplateChatSend} disabled={disabled || !chatInput.trim()}&gt;{loading ? &#39;…&#39; : &#39;Senden&#39;}&lt;/Button&gt;
              &lt;/div&gt;
            &lt;/div&gt;

            &lt;div className=&quot;flex items-center gap-2&quot;&gt;
              &lt;Button onClick={handlePreview} disabled={disabled}&gt;{loading ? &#39;Lade…&#39; : &#39;Template anwenden (Vorschau)&#39;}&lt;/Button&gt;
            &lt;/div&gt;
          &lt;/div&gt;

          {/* Rechte Spalte: Vorschau + Dateiname + Aktionen */}
          &lt;div className=&quot;space-y-3&quot;&gt;
            &lt;div&gt;
              &lt;Label&gt;Vorschau&lt;/Label&gt;
              &lt;div className=&quot;border rounded p-3 h-[300px] overflow-auto text-sm whitespace-pre-wrap&quot;&gt;{answer}&lt;/div&gt;
            &lt;/div&gt;
            &lt;div&gt;
              &lt;Label htmlFor=&quot;fn&quot;&gt;Dateiname&lt;/Label&gt;
              &lt;Input id=&quot;fn&quot; value={fileName} onChange={(e) =&gt; setFileName(e.target.value)} /&gt;
            &lt;/div&gt;
            &lt;div className=&quot;flex items-center gap-2&quot;&gt;
              &lt;Button variant=&quot;outline&quot; onClick={() =&gt; setOpen(false)}&gt;Schließen&lt;/Button&gt;
              &lt;Button disabled&gt;Dokument generieren (später)&lt;/Button&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/DialogContent&gt;
    &lt;/Dialog&gt;
  )
}
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;

import { useState, useEffect, useCallback } from &quot;react&quot;
import { useForm } from &quot;react-hook-form&quot;
import { zodResolver } from &quot;@hookform/resolvers/zod&quot;
import * as z from &quot;zod&quot;
import { Button } from &quot;@/components/ui/button&quot;
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from &quot;@/components/ui/card&quot;
import { Label } from &quot;@/components/ui/label&quot;
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from &quot;@/components/ui/select&quot;
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from &quot;@/components/ui/tooltip&quot;
import { StructuredTemplateEditor } from &quot;@/components/templates/structured-template-editor&quot;
import { useToast } from &quot;@/hooks/use-toast&quot;
import { Loader2, Save, Plus, Trash2, Eye, Play, FolderOpen, Info } from &quot;lucide-react&quot;
import { useAtom, useAtomValue } from &quot;jotai&quot;
import { activeLibraryAtom, libraryStatusAtom } from &quot;@/atoms/library-atom&quot;
import { 
  templatesAtom, 
  selectedTemplateNameAtom, 
  selectedTemplateAtom,
  templatesFolderIdAtom,
  templateLoadingAtom,
  templateErrorAtom,
  type Template
} from &quot;@/atoms/template-atom&quot;
import { useStorage } from &quot;@/contexts/storage-context&quot;
import { templateContextDocsAtom } from &#39;@/atoms/template-context-atom&#39;
import { Checkbox } from &quot;@/components/ui/checkbox&quot;
import { MarkdownPreview } from &quot;@/components/library/markdown-preview&quot;

// Schema für Template-Daten
const templateSchema = z.object({
  name: z.string().min(1, &quot;Prompt-Name ist erforderlich&quot;),
  yamlFrontmatter: z.string(),
  markdownBody: z.string(),
  systemPrompt: z.string(),
})

type TemplateFormValues = z.infer&lt;typeof templateSchema&gt;

export function TemplateManagement() {
  const [previewMode, setPreviewMode] = useState(false)
  const [isSaving, setIsSaving] = useState(false)
  const [isTesting, setIsTesting] = useState(false)
  const [testResult, setTestResult] = useState&lt;string | null&gt;(null)
  const [selectedContextIds, setSelectedContextIds] = useState&lt;string[]&gt;([])
  const [selectedContextMarkdown, setSelectedContextMarkdown] = useState&lt;string&gt;(&quot;&quot;)
  const { toast } = useToast()

  // Atoms
  const [templates, setTemplates] = useAtom(templatesAtom)
  const [selectedTemplateName, setSelectedTemplateName] = useAtom(selectedTemplateNameAtom)
  const [selectedTemplate] = useAtom(selectedTemplateAtom)
  const [templatesFolderId, setTemplatesFolderId] = useAtom(templatesFolderIdAtom)
  const [isLoading, setIsLoading] = useAtom(templateLoadingAtom)
  const [error, setError] = useAtom(templateErrorAtom)

  // Library und Storage
  const activeLibrary = useAtomValue(activeLibraryAtom)
  const libraryStatus = useAtomValue(libraryStatusAtom)
  const { 
    provider: providerInstance, 
    listItems
  } = useStorage()
  const contextDocs = useAtomValue(templateContextDocsAtom)

  const form = useForm&lt;TemplateFormValues&gt;({
    resolver: zodResolver(templateSchema),
    defaultValues: {
      name: &quot;&quot;,
      yamlFrontmatter: `---
title: {{title|Titel des Dokuments}}
tags: {{tags|Relevante Tags}}
date: {{date|Datum im Format yyyy-mm-dd}}
---`,
      markdownBody: `# {{title}}

## Zusammenfassung
{{summary|Kurze Zusammenfassung des Inhalts}}

## Details
{{details|Detaillierte Beschreibung}}`,
      systemPrompt: `You are a specialized assistant that processes and structures information clearly and concisely.

IMPORTANT: Your response must be a valid JSON object where each key corresponds to a template variable.`,
    },
  })

  // Helper zum Erzeugen von Default-Werten
  function getDefaultTemplateValues(name: string): TemplateFormValues {
    return {
      name,
      yamlFrontmatter: `---\n` +
        `title: {{title|Titel des Dokuments}}\n` +
        `tags: {{tags|Relevante Tags}}\n` +
        `date: {{date|Datum im Format yyyy-mm-dd}}\n` +
        `---`,
      markdownBody: `# {{title}}\n\n## Zusammenfassung\n{{summary|Kurze Zusammenfassung des Inhalts}}\n\n## Details\n{{details|Detaillierte Beschreibung}}`,
      systemPrompt: `You are a specialized assistant that processes and structures information clearly and concisely.\n\nIMPORTANT: Your response must be a valid JSON object where each key corresponds to a template variable.`,
    }
  }

  // Template-Daten laden wenn sich die Auswahl ändert
  useEffect(() =&gt; {
    if (selectedTemplate) {
      form.reset({
        name: selectedTemplate.name,
        yamlFrontmatter: selectedTemplate.yamlFrontmatter,
        markdownBody: selectedTemplate.markdownBody,
        systemPrompt: selectedTemplate.systemPrompt,
      })
    }
  }, [selectedTemplate, form])

  // Ordner-Erstellung/Suche memoisiert, damit als Dep verwendbar
  const ensureTemplatesFolder = useCallback(async (): Promise&lt;string&gt; =&gt; {
    if (!providerInstance || !activeLibrary) {
      throw new Error(&quot;Keine aktive Bibliothek oder Provider verfügbar&quot;);
    }

    try {
      console.log(&#39;[TemplateManagement] Suche nach Templates-Ordner...&#39;);
      const rootItems = await listItems(&#39;root&#39;);
      const templatesFolder = rootItems.find(item =&gt; 
        item.type === &#39;folder&#39; &amp;&amp; item.metadata.name === &#39;templates&#39;
      );
      if (templatesFolder) {
        console.log(&#39;[TemplateManagement] Templates-Ordner gefunden:&#39;, templatesFolder.id);
        return templatesFolder.id;
      }
      console.log(&#39;[TemplateManagement] Templates-Ordner nicht gefunden, erstelle neuen...&#39;);
      const newFolder = await providerInstance.createFolder(&#39;root&#39;, &#39;templates&#39;);
      console.log(&#39;[TemplateManagement] Neuer Templates-Ordner erstellt:&#39;, newFolder.id);
      return newFolder.id;
    } catch (error) {
      console.error(&#39;Fehler beim Erstellen des Templates-Ordners:&#39;, {
        error: error instanceof Error ? {
          message: error.message,
          name: error.name,
          stack: error.stack?.split(&#39;\n&#39;).slice(0, 3)
        } : error,
        libraryId: activeLibrary?.id,
        libraryPath: activeLibrary?.path,
        providerName: providerInstance?.name
      });
      let errorMessage = &#39;Fehler beim Erstellen des Templates-Ordners&#39;;
      if (error instanceof Error) {
        if (error.message.includes(&#39;Nicht authentifiziert&#39;)) {
          errorMessage = &#39;Bitte authentifizieren Sie sich bei Ihrem Cloud-Speicher, um den Templates-Ordner zu erstellen.&#39;;
        } else if (error.message.includes(&#39;Keine Berechtigung&#39;)) {
          errorMessage = &#39;Keine Berechtigung zum Erstellen von Ordnern in der Bibliothek.&#39;;
        } else if (error.message.includes(&#39;Bibliothek nicht gefunden&#39;)) {
          errorMessage = &#39;Die ausgewählte Bibliothek wurde nicht gefunden.&#39;;
        } else {
          errorMessage = `Fehler beim Erstellen des Templates-Ordners: ${error.message}`;
        }
      }
      throw new Error(errorMessage);
    }
  }, [providerInstance, activeLibrary, listItems]);

  // Templates laden mit der gleichen Logik wie Library-Komponente
  const loadTemplates = useCallback(async () =&gt; {
    if (!providerInstance || libraryStatus !== &#39;ready&#39; || !activeLibrary) {
      console.log(&#39;[TemplateManagement] loadTemplates übersprungen:&#39;, {
        hasProvider: !!providerInstance,
        libraryStatus,
        hasActiveLibrary: !!activeLibrary
      });
      return;
    }

    try {
      setIsLoading(true);
      setError(null);

      console.log(&#39;[TemplateManagement] Starte Prompt-Loading:&#39;, {
        libraryId: activeLibrary.id,
        libraryPath: activeLibrary.path,
        providerName: providerInstance.name
      });

      // 1. Templates-Ordner finden oder erstellen
      const folderId = await ensureTemplatesFolder();
      setTemplatesFolderId(folderId);

      console.log(&#39;[TemplateManagement] Templates-Ordner gefunden/erstellt:&#39;, folderId);

      // 2. Alle Template-Dateien im Ordner auflisten
      const items = await listItems(folderId);
      const templateFiles = items.filter(item =&gt; 
        item.type === &#39;file&#39; &amp;&amp; 
        item.metadata.name.endsWith(&#39;.md&#39;)
      );

      console.log(&#39;[TemplateManagement] Prompt-Dateien gefunden:&#39;, templateFiles.length);

      // 3. Template-Inhalte laden
      const templatePromises = templateFiles.map(async (file) =&gt; {
        try {
          const { blob } = await providerInstance.getBinary(file.id);
          const content = await blob.text();
          const template = parseTemplateContent(content, file.metadata.name.replace(&#39;.md&#39;, &#39;&#39;));

          return {
            ...template,
            fileId: file.id,
            lastModified: typeof file.metadata.modifiedAt === &#39;string&#39; 
              ? file.metadata.modifiedAt 
              : file.metadata.modifiedAt instanceof Date 
                ? file.metadata.modifiedAt.toISOString()
                : new Date().toISOString()
          } as Template;
        } catch (error) {
          console.error(`Fehler beim Parsen von ${file.metadata.name}:`, error);
          return null;
        }
      });

      const loadedTemplates = await Promise.all(templatePromises);
      const validTemplates = loadedTemplates.filter((t): t is Template =&gt; t !== null);

      setTemplates(validTemplates);

      console.log(&#39;[TemplateManagement] Prompts erfolgreich geladen:&#39;, validTemplates.length);

      if (validTemplates.length === 0) {
        toast({
          title: &quot;Keine Prompts gefunden&quot;,
          description: &quot;Erstellen Sie Ihren ersten Prompt im Verzeichnis &#39;/templates&#39;.&quot;,
        });
      }
    } catch (error) {
      console.error(&#39;Fehler beim Laden der Prompts:&#39;, {
        error: error instanceof Error ? {
          message: error.message,
          name: error.name,
          stack: error.stack?.split(&#39;\n&#39;).slice(0, 3)
        } : error,
        libraryId: activeLibrary?.id,
        libraryPath: activeLibrary?.path,
        providerName: providerInstance?.name
      });

      let errorMessage = &#39;Unbekannter Fehler beim Laden der Prompts&#39;;

      if (error instanceof Error) {
        errorMessage = error.message;

        // Spezifische Fehlermeldungen für häufige Probleme
        if (error.message.includes(&#39;Nicht authentifiziert&#39;)) {
          errorMessage = &#39;Bitte authentifizieren Sie sich bei Ihrem Cloud-Speicher, um Prompts zu laden.&#39;;
        } else if (error.message.includes(&#39;Bibliothek nicht gefunden&#39;)) {
          errorMessage = &#39;Die ausgewählte Bibliothek wurde nicht gefunden. Bitte überprüfen Sie die Bibliothekskonfiguration.&#39;;
        } else if (error.message.includes(&#39;Server-Fehler&#39;)) {
          errorMessage = &#39;Server-Fehler beim Laden der Prompts. Bitte überprüfen Sie, ob der Bibliothekspfad existiert und zugänglich ist.&#39;;
        } else if (error.message.includes(&#39;Keine aktive Bibliothek&#39;)) {
          errorMessage = &#39;Keine aktive Bibliothek verfügbar. Bitte wählen Sie eine Bibliothek aus.&#39;;
        }
      }

      setError(errorMessage);
      toast({
        title: &quot;Fehler beim Laden der Prompts&quot;,
        description: errorMessage,
        variant: &quot;destructive&quot;,
      });
    } finally {
      setIsLoading(false);
    }
  }, [providerInstance, libraryStatus, activeLibrary, listItems, setTemplates, setTemplatesFolderId, setIsLoading, setError, toast, ensureTemplatesFolder]);

  // Effect für Template Loading (wie Library-Komponente)
  useEffect(() =&gt; {
    const isReady = providerInstance &amp;&amp; libraryStatus === &#39;ready&#39; &amp;&amp; activeLibrary

    if (!isReady) {
      return
    }

    // Templates laden wenn noch nicht geladen
    if (!templatesFolderId) {
      loadTemplates()
    }
  }, [providerInstance, libraryStatus, activeLibrary, templatesFolderId, loadTemplates])

  // Reset wenn sich die Library ändert
  useEffect(() =&gt; {
    setSelectedTemplateName(null)
    setTemplatesFolderId(null)
    setTemplates([])
    setError(null)
  }, [libraryStatus, setSelectedTemplateName, setTemplatesFolderId, setTemplates, setError])

  useEffect(() =&gt; {
    async function loadSelectedContext() {
      if (!providerInstance || !Array.isArray(selectedContextIds) || selectedContextIds.length === 0) {
        setSelectedContextMarkdown(&quot;&quot;)
        return
      }
      try {
        const parts: string[] = []
        for (const id of selectedContextIds) {
          const { blob } = await providerInstance.getBinary(id)
          const text = await blob.text()
          parts.push(text)
        }
        setSelectedContextMarkdown(parts.join(&quot;\n\n---\n\n&quot;))
      } catch (e) {
        console.error(&#39;Fehler beim Laden des Kontextes&#39;, e)
        setSelectedContextMarkdown(&quot;&quot;)
      }
    }
    void loadSelectedContext()
  }, [providerInstance, selectedContextIds])

  function parseTemplateContent(content: string, fileName: string): Template {
    // Template in drei Bereiche aufteilen
    const parts = content.split(&#39;--- systemprompt&#39;)

    let yamlFrontmatter = &quot;&quot;
    let markdownBody = &quot;&quot;
    let systemPrompt = &quot;&quot;

    if (parts.length &gt;= 2) {
      const mainContent = parts[0].trim()
      systemPrompt = parts[1].trim()

      // YAML Frontmatter extrahieren
      const yamlMatch = mainContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/)
      if (yamlMatch) {
        yamlFrontmatter = `---\n${yamlMatch[1]}\n---`
        markdownBody = yamlMatch[2].trim()
      } else {
        // Kein YAML Frontmatter gefunden
        markdownBody = mainContent
      }
    } else {
      // Kein Systemprompt gefunden
      const yamlMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/)
      if (yamlMatch) {
        yamlFrontmatter = `---\n${yamlMatch[1]}\n---`
        markdownBody = yamlMatch[2].trim()
      } else {
        markdownBody = content
      }
    }

    return {
      name: fileName,
      yamlFrontmatter,
      markdownBody,
      systemPrompt,
    }
  }

  function generateTemplateContent(values: TemplateFormValues): string {
    let content = &quot;&quot;

    // YAML Frontmatter hinzufügen
    if (values.yamlFrontmatter.trim()) {
      content += values.yamlFrontmatter + &quot;\n\n&quot;
    }

    // Markdown Body hinzufügen
    content += values.markdownBody

    // System Prompt hinzufügen
    if (values.systemPrompt.trim()) {
      content += &quot;\n\n--- systemprompt\n&quot; + values.systemPrompt
    }

    return content
  }

  async function onSubmit(data: TemplateFormValues) {
    if (!activeLibrary || !templatesFolderId || !providerInstance) {
      toast({
        title: &quot;Fehler&quot;,
        description: &quot;Keine aktive Bibliothek oder Templates-Ordner nicht gefunden.&quot;,
        variant: &quot;destructive&quot;,
      })
      return
    }

    setIsSaving(true)
    try {
      const templateContent = generateTemplateContent(data)
      const fileName = `${data.name}.md`

      // Datei als Blob erstellen
      const blob = new Blob([templateContent], { type: &#39;text/markdown&#39; })
      const file = new File([blob], fileName, { type: &#39;text/markdown&#39; })

      // Datei hochladen
      await providerInstance.uploadFile(templatesFolderId, file)

      // Templates neu laden
      await loadTemplates()

      // Auswahl auf das neue Template setzen
      setSelectedTemplateName(data.name)

      toast({
        title: &quot;Template gespeichert&quot;,
        description: `Template &quot;${data.name}&quot; wurde erfolgreich im Verzeichnis &quot;/templates&quot; gespeichert.`,
      })
    } catch (error) {
      console.error(&#39;Fehler beim Speichern des Templates:&#39;, error)
      toast({
        title: &quot;Fehler beim Speichern&quot;,
        description: error instanceof Error ? error.message : &quot;Unbekannter Fehler&quot;,
        variant: &quot;destructive&quot;,
      })
    } finally {
      setIsSaving(false)
    }
  }

  async function renameCurrentTemplate() {
    const current = selectedTemplateName ? templates.find(t =&gt; t.name === selectedTemplateName) : null
    if (!current || !current.fileId || !providerInstance) return
    const newName = (window.prompt(&#39;Neuen Namen eingeben:&#39;, current.name) || &#39;&#39;).trim()
    if (!newName || newName === current.name) return
    if (/[^a-zA-Z0-9._\- ]/.test(newName)) { toast({ title: &#39;Ungültiger Name&#39;, description: &#39;Nur Buchstaben, Zahlen, Leerzeichen, . _ - sind erlaubt.&#39;, variant: &#39;destructive&#39; }); return }
    if (templates.some(t =&gt; t.name.toLowerCase() === newName.toLowerCase())) { toast({ title: &#39;Bereits vorhanden&#39;, description: &#39;Bitte anderen Namen wählen.&#39;, variant: &#39;destructive&#39; }); return }
    try {
      await providerInstance.renameItem(current.fileId, `${newName}.md`)
      await loadTemplates()
      setSelectedTemplateName(newName)
      form.setValue(&#39;name&#39;, newName, { shouldDirty: false })
      toast({ title: &#39;Umbenannt&#39;, description: `${current.name} → ${newName}` })
    } catch (e) {
      toast({ title: &#39;Fehler beim Umbenennen&#39;, description: e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;, variant: &#39;destructive&#39; })
    }
  }

  async function deleteTemplate(templateName: string) {
    if (!activeLibrary || !providerInstance) return

    try {
      const template = templates.find(t =&gt; t.name === templateName)
      if (!template?.fileId) {
        throw new Error(&quot;Template-Datei nicht gefunden&quot;)
      }

      // Datei löschen
      await providerInstance.deleteItem(template.fileId)

      // Templates neu laden
      await loadTemplates()

      if (selectedTemplateName === templateName) {
        setSelectedTemplateName(null)
        form.reset()
      }

      toast({
        title: &quot;Template gelöscht&quot;,
        description: `Template &quot;${templateName}&quot; wurde erfolgreich gelöscht.`,
      })
    } catch (error) {
      console.error(&#39;Fehler beim Löschen des Templates:&#39;, error)
      toast({
        title: &quot;Fehler beim Löschen&quot;,
        description: error instanceof Error ? error.message : &quot;Unbekannter Fehler&quot;,
        variant: &quot;destructive&quot;,
      })
    }
  }

  async function createNewTemplate() {
    const name = (window.prompt(&#39;Neuen Template‑Namen eingeben:&#39;) || &#39;&#39;).trim()
    if (!name) return
    if (/[^a-zA-Z0-9._\- ]/.test(name)) { toast({ title: &#39;Ungültiger Name&#39;, description: &#39;Nur Buchstaben, Zahlen, Leerzeichen, . _ - sind erlaubt.&#39;, variant: &#39;destructive&#39; }); return }
    if (templates.some(t =&gt; t.name.toLowerCase() === name.toLowerCase())) { toast({ title: &#39;Bereits vorhanden&#39;, description: &#39;Bitte anderen Namen wählen.&#39;, variant: &#39;destructive&#39; }); return }
    if (!providerInstance) { toast({ title: &#39;Kein Provider&#39; , variant: &#39;destructive&#39; }); return }
    try {
      const folderId = await ensureTemplatesFolder()
      const values = getDefaultTemplateValues(name)
      const content = (values.yamlFrontmatter ? values.yamlFrontmatter + &#39;\n\n&#39; : &#39;&#39;) + values.markdownBody + &#39;\n\n--- systemprompt\n&#39; + values.systemPrompt
      const file = new File([new Blob([content], { type: &#39;text/markdown&#39; })], `${name}.md`, { type: &#39;text/markdown&#39; })
      await providerInstance.uploadFile(folderId, file)
      await loadTemplates()
      setSelectedTemplateName(name)
      form.reset(values)
      toast({ title: &#39;Template angelegt&#39;, description: `&quot;${name}&quot; wurde erstellt.` })
    } catch (e) {
      toast({ title: &#39;Fehler beim Anlegen&#39;, description: e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;, variant: &#39;destructive&#39; })
    }
  }

  function generatePreview(): string {
    const values = form.getValues()
    return generateTemplateContent(values)
  }

  async function testTemplate() {
    if (!activeLibrary) return

    setIsTesting(true)
    setTestResult(null)

    const values = form.getValues()
    const templateContent = generateTemplateContent(values)
    const testText = selectedContextMarkdown || &quot;&quot;

    try {
      const response = await fetch(&#39;/api/secretary/process-text&#39;, {
        method: &#39;POST&#39;,
        headers: {
          &#39;Content-Type&#39;: &#39;application/x-www-form-urlencoded&#39;,
          &#39;X-Library-Id&#39;: activeLibrary.id,
        },
        body: new URLSearchParams({
          text: testText,
          template_content: templateContent,
          source_language: &#39;de&#39;,
          target_language: &#39;de&#39;,
        }),
      })

      if (!response.ok) {
        const errorData = await response.json()
        throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`)
      }

      const result = await response.json()
      const formattedResult = typeof result === &#39;string&#39; ? result : JSON.stringify(result, null, 2)
      setTestResult(formattedResult)

      toast({
        title: &quot;Prompt-Test erfolgreich&quot;,
        description: &quot;Der Prompt wurde erfolgreich mit dem gewählten Kontext verarbeitet.&quot;,
      })

      console.log(&#39;Prompt-Test Ergebnis:&#39;, result)
    } catch (error) {
      console.error(&#39;Fehler beim Prompt-Test:&#39;, error)
      const errorMessage = error instanceof Error ? error.message : &quot;Unbekannter Fehler&quot;
      setTestResult(`Fehler: ${errorMessage}`)
      toast({
        title: &quot;Prompt-Test fehlgeschlagen&quot;,
        description: errorMessage,
        variant: &quot;destructive&quot;,
      })
    } finally {
      setIsTesting(false)
    }
  }

  // Render-Logik für verschiedene Status
  if (libraryStatus === &quot;waitingForAuth&quot;) {
    return (
      &lt;div className=&quot;flex flex-col items-center justify-center h-full text-muted-foreground&quot;&gt;
        &lt;span&gt;Diese Bibliothek benötigt eine Authentifizierung.&lt;/span&gt;
        &lt;span className=&quot;text-sm mt-2&quot;&gt;Bitte konfigurieren Sie die Bibliothek in den Einstellungen.&lt;/span&gt;
      &lt;/div&gt;
    )
  }

  if (libraryStatus !== &quot;ready&quot;) {
    return (
      &lt;div className=&quot;flex flex-col items-center justify-center h-full text-muted-foreground&quot;&gt;
        &lt;span&gt;Lade Storage...&lt;/span&gt;
      &lt;/div&gt;
    )
  }

  if (!activeLibrary) {
    return (
      &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
        Bitte wählen Sie eine Bibliothek aus.
      &lt;/div&gt;
    )
  }

  if (error) {
    return (
      &lt;div className=&quot;text-center text-destructive&quot;&gt;
        &lt;p&gt;Fehler beim Laden der Prompts:&lt;/p&gt;
        &lt;p className=&quot;text-sm&quot;&gt;{error}&lt;/p&gt;
        &lt;Button 
          variant=&quot;outline&quot; 
          className=&quot;mt-4&quot;
          onClick={loadTemplates}
        &gt;
          Erneut versuchen
        &lt;/Button&gt;
      &lt;/div&gt;
    )
  }

  return (
    &lt;div className=&quot;space-y-6&quot;&gt;

      {/* Kompakte Toolbar oben */}
      &lt;div className=&quot;flex items-center gap-2&quot;&gt;
        &lt;Select value={selectedTemplateName || &#39;&#39;} onValueChange={(v) =&gt; { setSelectedTemplateName(v); form.setValue(&#39;name&#39;, v, { shouldDirty: false }) }} disabled={isLoading}&gt;
          &lt;SelectTrigger className=&quot;w-64&quot;&gt;
            &lt;SelectValue placeholder=&quot;Prompt auswählen...&quot; /&gt;
          &lt;/SelectTrigger&gt;
          &lt;SelectContent&gt;
            {templates.map((t) =&gt; (
              &lt;SelectItem key={t.name} value={t.name}&gt;{t.name}&lt;/SelectItem&gt;
            ))}
          &lt;/SelectContent&gt;
        &lt;/Select&gt;
        &lt;TooltipProvider&gt;
          &lt;Tooltip&gt;
            &lt;TooltipTrigger asChild&gt;
              &lt;Button variant=&quot;ghost&quot; size=&quot;sm&quot; className=&quot;h-8 w-8 p-0&quot;&gt;&lt;Info className=&quot;h-4 w-4&quot; /&gt;&lt;/Button&gt;
            &lt;/TooltipTrigger&gt;
            &lt;TooltipContent&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;&lt;FolderOpen className=&quot;h-4 w-4&quot; /&gt;&lt;span&gt;Ort: /templates in „{activeLibrary.label}“&lt;/span&gt;&lt;/div&gt;
            &lt;/TooltipContent&gt;
          &lt;/Tooltip&gt;
        &lt;/TooltipProvider&gt;
        &lt;Button type=&quot;button&quot; variant=&quot;outline&quot; size=&quot;sm&quot; onClick={createNewTemplate} disabled={isLoading}&gt;Neu&lt;/Button&gt;
        &lt;Button type=&quot;button&quot; variant=&quot;outline&quot; size=&quot;sm&quot; onClick={renameCurrentTemplate} disabled={!selectedTemplateName}&gt;Umbenennen&lt;/Button&gt;
        {selectedTemplateName &amp;&amp; (
          &lt;Button type=&quot;button&quot; variant=&quot;destructive&quot; size=&quot;sm&quot; onClick={() =&gt; deleteTemplate(selectedTemplateName!)}&gt;Löschen&lt;/Button&gt;
        )}
      &lt;/div&gt;

      &lt;div className=&quot;grid grid-cols-1 lg:grid-cols-2 gap-6&quot;&gt;
        &lt;Card&gt;
          &lt;CardHeader&gt;
            &lt;CardTitle&gt;Prompt Design&lt;/CardTitle&gt;
            &lt;CardDescription&gt;
              Drei Bereiche: Aufgabe (was), Rollenanweisung (wie), Metadaten (Begleitinfos).
            &lt;/CardDescription&gt;
          &lt;/CardHeader&gt;
          &lt;CardContent&gt;
            &lt;form onSubmit={form.handleSubmit(onSubmit)} className=&quot;space-y-6&quot;&gt;
              {/* Template-Name Feld entfernt (oben verwaltet) */}

              {previewMode ? (
                &lt;div className=&quot;space-y-4&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between&quot;&gt;
                    &lt;h4 className=&quot;text-sm font-medium&quot;&gt;Prompt-Vorschau&lt;/h4&gt;
                    &lt;Button
                      type=&quot;button&quot;
                      variant=&quot;outline&quot;
                      size=&quot;sm&quot;
                      onClick={() =&gt; setPreviewMode(false)}
                    &gt;
                      Bearbeiten
                    &lt;/Button&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;border rounded-md p-4 bg-muted/50&quot;&gt;
                    &lt;pre className=&quot;text-sm whitespace-pre-wrap font-mono&quot;&gt;
                      {generatePreview()}
                    &lt;/pre&gt;
                  &lt;/div&gt;
                &lt;/div&gt;
              ) : (
                &lt;StructuredTemplateEditor
                  markdownBody={form.watch(&#39;markdownBody&#39;)}
                  yamlFrontmatter={form.watch(&#39;yamlFrontmatter&#39;)}
                  systemPrompt={form.watch(&#39;systemPrompt&#39;)}
                  onChange={({ markdownBody, yamlFrontmatter, systemPrompt }) =&gt; {
                    form.setValue(&#39;markdownBody&#39;, markdownBody, { shouldDirty: true })
                    form.setValue(&#39;yamlFrontmatter&#39;, yamlFrontmatter, { shouldDirty: true })
                    form.setValue(&#39;systemPrompt&#39;, systemPrompt, { shouldDirty: true })
                  }}
                /&gt;
              )}

              &lt;div className=&quot;flex justify-end gap-2&quot;&gt;
                &lt;Button
                  type=&quot;button&quot;
                  variant=&quot;outline&quot;
                  onClick={() =&gt; setPreviewMode(!previewMode)}
                &gt;
                  &lt;Eye className=&quot;h-4 w-4 mr-2&quot; /&gt;
                  {previewMode ? &quot;Bearbeiten&quot; : &quot;Vorschau&quot;}
                &lt;/Button&gt;
                &lt;Button
                  type=&quot;submit&quot;
                  disabled={isSaving || !form.formState.isDirty}
                &gt;
                  {isSaving ? (
                    &lt;&gt;
                      &lt;Loader2 className=&quot;h-4 w-4 mr-2 animate-spin&quot; /&gt;
                      Wird gespeichert...
                    &lt;/&gt;
                  ) : (
                    &lt;&gt;
                      &lt;Save className=&quot;h-4 w-4 mr-2&quot; /&gt;
                      Speichern
                    &lt;/&gt;
                  )}
                &lt;/Button&gt;
              &lt;/div&gt;
            &lt;/form&gt;
          &lt;/CardContent&gt;
        &lt;/Card&gt;

        &lt;Card&gt;
          &lt;CardHeader&gt;
            &lt;CardTitle&gt;Prompt testen&lt;/CardTitle&gt;
            &lt;CardDescription&gt;
              Test mit Beispieltext. Nutzt Rollenanweisung, Aufgabe und Metadaten des Prompts.
            &lt;/CardDescription&gt;
          &lt;/CardHeader&gt;
          &lt;CardContent&gt;
            &lt;div className=&quot;space-y-4&quot;&gt;
              &lt;div className=&quot;space-y-2&quot;&gt;
                &lt;Label&gt;Kontext-Texte&lt;/Label&gt;
                &lt;div className=&quot;border rounded p-2 max-h-40 overflow-auto text-sm&quot;&gt;
                  {Array.isArray(contextDocs) &amp;&amp; contextDocs.length &gt; 0 ? (
                    contextDocs.map(d =&gt; {
                      const checked = selectedContextIds.includes(d.id)
                      return (
                        &lt;label key={d.id} className=&quot;flex items-center gap-2 py-1&quot;&gt;
                          &lt;Checkbox
                            checked={checked}
                            onCheckedChange={(v) =&gt; {
                              const isOn = v === true
                              setSelectedContextIds(prev =&gt; isOn ? [...prev, d.id] : prev.filter(x =&gt; x !== d.id))
                            }}
                          /&gt;
                          &lt;span className=&quot;truncate&quot;&gt;{d.name}&lt;/span&gt;
                        &lt;/label&gt;
                      )
                    })
                  ) : (
                    &lt;div className=&quot;text-muted-foreground text-sm&quot;&gt;Keine Kontext-Texte verfügbar&lt;/div&gt;
                  )}
                &lt;/div&gt;
              &lt;/div&gt;

              &lt;div className=&quot;space-y-2&quot;&gt;
                &lt;Label&gt;Gewählter Kontext (Lesemodus)&lt;/Label&gt;
                &lt;div className=&quot;border rounded-md&quot;&gt;
                  &lt;MarkdownPreview content={selectedContextMarkdown} className=&quot;max-h-64 overflow-auto&quot; /&gt;
                &lt;/div&gt;
              &lt;/div&gt;

              &lt;div className=&quot;space-y-2&quot;&gt;
                &lt;Label&gt;Prompt‑Vorschau (Aufgabe als Markdown)&lt;/Label&gt;
                &lt;div className=&quot;border rounded-md&quot;&gt;
                  &lt;MarkdownPreview content={form.watch(&#39;markdownBody&#39;) || &#39;&#39;} className=&quot;max-h-64 overflow-auto&quot; /&gt;
                &lt;/div&gt;
              &lt;/div&gt;

              &lt;div className=&quot;flex gap-2&quot;&gt;
                &lt;Button 
                  variant=&quot;outline&quot; 
                  size=&quot;sm&quot;
                  onClick={testTemplate}
                  disabled={!selectedTemplateName || isTesting}
                &gt;
                  {isTesting ? (
                    &lt;&gt;
                      &lt;Loader2 className=&quot;h-4 w-4 mr-2 animate-spin&quot; /&gt;
                      Teste...
                    &lt;/&gt;
                  ) : (
                    &lt;&gt;
                      &lt;Play className=&quot;h-4 w-4 mr-2&quot; /&gt;
                      Prompt testen
                    &lt;/&gt;
                  )}
                &lt;/Button&gt;
              &lt;/div&gt;

              {testResult &amp;&amp; (
                &lt;div className=&quot;space-y-2&quot;&gt;
                  &lt;Label&gt;Ergebnis (Markdown)&lt;/Label&gt;
                  &lt;div className=&quot;border rounded-md&quot;&gt;
                    &lt;MarkdownPreview content={testResult} className=&quot;max-h-80 overflow-auto&quot; /&gt;
                  &lt;/div&gt;
                &lt;/div&gt;
              )}
            &lt;/div&gt;
          &lt;/CardContent&gt;
        &lt;/Card&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
} 
</code></pre></div>
<p>Ich entferne die ungenutzten <code>Plus</code> und <code>Trash2</code> Importe in <code>src/components/templates/template-management.tsx</code> und starte danach erneut den Build.</p>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;

import { useState, useEffect, useCallback } from &quot;react&quot;
import { useForm } from &quot;react-hook-form&quot;
import { zodResolver } from &quot;@hookform/resolvers/zod&quot;
import * as z from &quot;zod&quot;
import { Button } from &quot;@/components/ui/button&quot;
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from &quot;@/components/ui/card&quot;
import { Label } from &quot;@/components/ui/label&quot;
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from &quot;@/components/ui/select&quot;
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from &quot;@/components/ui/tooltip&quot;
import { StructuredTemplateEditor } from &quot;@/components/templates/structured-template-editor&quot;
import { useToast } from &quot;@/hooks/use-toast&quot;
import { Loader2, Save, Eye, Play, FolderOpen, Info } from &quot;lucide-react&quot;
import { useAtom, useAtomValue } from &quot;jotai&quot;
import { activeLibraryAtom, libraryStatusAtom } from &quot;@/atoms/library-atom&quot;
import { 
  templatesAtom, 
  selectedTemplateNameAtom, 
  selectedTemplateAtom,
  templatesFolderIdAtom,
  templateLoadingAtom,
  templateErrorAtom,
  type Template
} from &quot;@/atoms/template-atom&quot;
import { useStorage } from &quot;@/contexts/storage-context&quot;
import { templateContextDocsAtom } from &#39;@/atoms/template-context-atom&#39;
import { Checkbox } from &quot;@/components/ui/checkbox&quot;
import { MarkdownPreview } from &quot;@/components/library/markdown-preview&quot;

// Schema für Template-Daten
const templateSchema = z.object({
  name: z.string().min(1, &quot;Prompt-Name ist erforderlich&quot;),
  yamlFrontmatter: z.string(),
  markdownBody: z.string(),
  systemPrompt: z.string(),
})

type TemplateFormValues = z.infer&lt;typeof templateSchema&gt;

export function TemplateManagement() {
  const [previewMode, setPreviewMode] = useState(false)
  const [isSaving, setIsSaving] = useState(false)
  const [isTesting, setIsTesting] = useState(false)
  const [testResult, setTestResult] = useState&lt;string | null&gt;(null)
  const [selectedContextIds, setSelectedContextIds] = useState&lt;string[]&gt;([])
  const [selectedContextMarkdown, setSelectedContextMarkdown] = useState&lt;string&gt;(&quot;&quot;)
  const { toast } = useToast()

  // Atoms
  const [templates, setTemplates] = useAtom(templatesAtom)
  const [selectedTemplateName, setSelectedTemplateName] = useAtom(selectedTemplateNameAtom)
  const [selectedTemplate] = useAtom(selectedTemplateAtom)
  const [templatesFolderId, setTemplatesFolderId] = useAtom(templatesFolderIdAtom)
  const [isLoading, setIsLoading] = useAtom(templateLoadingAtom)
  const [error, setError] = useAtom(templateErrorAtom)

  // Library und Storage
  const activeLibrary = useAtomValue(activeLibraryAtom)
  const libraryStatus = useAtomValue(libraryStatusAtom)
  const { 
    provider: providerInstance, 
    listItems
  } = useStorage()
  const contextDocs = useAtomValue(templateContextDocsAtom)

  const form = useForm&lt;TemplateFormValues&gt;({
    resolver: zodResolver(templateSchema),
    defaultValues: {
      name: &quot;&quot;,
      yamlFrontmatter: `---
title: {{title|Titel des Dokuments}}
tags: {{tags|Relevante Tags}}
date: {{date|Datum im Format yyyy-mm-dd}}
---`,
      markdownBody: `# {{title}}

## Zusammenfassung
{{summary|Kurze Zusammenfassung des Inhalts}}

## Details
{{details|Detaillierte Beschreibung}}`,
      systemPrompt: `You are a specialized assistant that processes and structures information clearly and concisely.

IMPORTANT: Your response must be a valid JSON object where each key corresponds to a template variable.`,
    },
  })

  // Helper zum Erzeugen von Default-Werten
  function getDefaultTemplateValues(name: string): TemplateFormValues {
    return {
      name,
      yamlFrontmatter: `---\n` +
        `title: {{title|Titel des Dokuments}}\n` +
        `tags: {{tags|Relevante Tags}}\n` +
        `date: {{date|Datum im Format yyyy-mm-dd}}\n` +
        `---`,
      markdownBody: `# {{title}}\n\n## Zusammenfassung\n{{summary|Kurze Zusammenfassung des Inhalts}}\n\n## Details\n{{details|Detaillierte Beschreibung}}`,
      systemPrompt: `You are a specialized assistant that processes and structures information clearly and concisely.\n\nIMPORTANT: Your response must be a valid JSON object where each key corresponds to a template variable.`,
    }
  }

  // Template-Daten laden wenn sich die Auswahl ändert
  useEffect(() =&gt; {
    if (selectedTemplate) {
      form.reset({
        name: selectedTemplate.name,
        yamlFrontmatter: selectedTemplate.yamlFrontmatter,
        markdownBody: selectedTemplate.markdownBody,
        systemPrompt: selectedTemplate.systemPrompt,
      })
    }
  }, [selectedTemplate, form])

  // Ordner-Erstellung/Suche memoisiert, damit als Dep verwendbar
  const ensureTemplatesFolder = useCallback(async (): Promise&lt;string&gt; =&gt; {
    if (!providerInstance || !activeLibrary) {
      throw new Error(&quot;Keine aktive Bibliothek oder Provider verfügbar&quot;);
    }

    try {
      console.log(&#39;[TemplateManagement] Suche nach Templates-Ordner...&#39;);
      const rootItems = await listItems(&#39;root&#39;);
      const templatesFolder = rootItems.find(item =&gt; 
        item.type === &#39;folder&#39; &amp;&amp; item.metadata.name === &#39;templates&#39;
      );
      if (templatesFolder) {
        console.log(&#39;[TemplateManagement] Templates-Ordner gefunden:&#39;, templatesFolder.id);
        return templatesFolder.id;
      }
      console.log(&#39;[TemplateManagement] Templates-Ordner nicht gefunden, erstelle neuen...&#39;);
      const newFolder = await providerInstance.createFolder(&#39;root&#39;, &#39;templates&#39;);
      console.log(&#39;[TemplateManagement] Neuer Templates-Ordner erstellt:&#39;, newFolder.id);
      return newFolder.id;
    } catch (error) {
      console.error(&#39;Fehler beim Erstellen des Templates-Ordners:&#39;, {
        error: error instanceof Error ? {
          message: error.message,
          name: error.name,
          stack: error.stack?.split(&#39;\n&#39;).slice(0, 3)
        } : error,
        libraryId: activeLibrary?.id,
        libraryPath: activeLibrary?.path,
        providerName: providerInstance?.name
      });
      let errorMessage = &#39;Fehler beim Erstellen des Templates-Ordners&#39;;
      if (error instanceof Error) {
        if (error.message.includes(&#39;Nicht authentifiziert&#39;)) {
          errorMessage = &#39;Bitte authentifizieren Sie sich bei Ihrem Cloud-Speicher, um den Templates-Ordner zu erstellen.&#39;;
        } else if (error.message.includes(&#39;Keine Berechtigung&#39;)) {
          errorMessage = &#39;Keine Berechtigung zum Erstellen von Ordnern in der Bibliothek.&#39;;
        } else if (error.message.includes(&#39;Bibliothek nicht gefunden&#39;)) {
          errorMessage = &#39;Die ausgewählte Bibliothek wurde nicht gefunden.&#39;;
        } else {
          errorMessage = `Fehler beim Erstellen des Templates-Ordners: ${error.message}`;
        }
      }
      throw new Error(errorMessage);
    }
  }, [providerInstance, activeLibrary, listItems]);

  // Templates laden mit der gleichen Logik wie Library-Komponente
  const loadTemplates = useCallback(async () =&gt; {
    if (!providerInstance || libraryStatus !== &#39;ready&#39; || !activeLibrary) {
      console.log(&#39;[TemplateManagement] loadTemplates übersprungen:&#39;, {
        hasProvider: !!providerInstance,
        libraryStatus,
        hasActiveLibrary: !!activeLibrary
      });
      return;
    }

    try {
      setIsLoading(true);
      setError(null);

      console.log(&#39;[TemplateManagement] Starte Prompt-Loading:&#39;, {
        libraryId: activeLibrary.id,
        libraryPath: activeLibrary.path,
        providerName: providerInstance.name
      });

      // 1. Templates-Ordner finden oder erstellen
      const folderId = await ensureTemplatesFolder();
      setTemplatesFolderId(folderId);

      console.log(&#39;[TemplateManagement] Templates-Ordner gefunden/erstellt:&#39;, folderId);

      // 2. Alle Template-Dateien im Ordner auflisten
      const items = await listItems(folderId);
      const templateFiles = items.filter(item =&gt; 
        item.type === &#39;file&#39; &amp;&amp; 
        item.metadata.name.endsWith(&#39;.md&#39;)
      );

      console.log(&#39;[TemplateManagement] Prompt-Dateien gefunden:&#39;, templateFiles.length);

      // 3. Template-Inhalte laden
      const templatePromises = templateFiles.map(async (file) =&gt; {
        try {
          const { blob } = await providerInstance.getBinary(file.id);
          const content = await blob.text();
          const template = parseTemplateContent(content, file.metadata.name.replace(&#39;.md&#39;, &#39;&#39;));

          return {
            ...template,
            fileId: file.id,
            lastModified: typeof file.metadata.modifiedAt === &#39;string&#39; 
              ? file.metadata.modifiedAt 
              : file.metadata.modifiedAt instanceof Date 
                ? file.metadata.modifiedAt.toISOString()
                : new Date().toISOString()
          } as Template;
        } catch (error) {
          console.error(`Fehler beim Parsen von ${file.metadata.name}:`, error);
          return null;
        }
      });

      const loadedTemplates = await Promise.all(templatePromises);
      const validTemplates = loadedTemplates.filter((t): t is Template =&gt; t !== null);

      setTemplates(validTemplates);

      console.log(&#39;[TemplateManagement] Prompts erfolgreich geladen:&#39;, validTemplates.length);

      if (validTemplates.length === 0) {
        toast({
          title: &quot;Keine Prompts gefunden&quot;,
          description: &quot;Erstellen Sie Ihren ersten Prompt im Verzeichnis &#39;/templates&#39;.&quot;,
        });
      }
    } catch (error) {
      console.error(&#39;Fehler beim Laden der Prompts:&#39;, {
        error: error instanceof Error ? {
          message: error.message,
          name: error.name,
          stack: error.stack?.split(&#39;\n&#39;).slice(0, 3)
        } : error,
        libraryId: activeLibrary?.id,
        libraryPath: activeLibrary?.path,
        providerName: providerInstance?.name
      });

      let errorMessage = &#39;Unbekannter Fehler beim Laden der Prompts&#39;;

      if (error instanceof Error) {
        errorMessage = error.message;

        // Spezifische Fehlermeldungen für häufige Probleme
        if (error.message.includes(&#39;Nicht authentifiziert&#39;)) {
          errorMessage = &#39;Bitte authentifizieren Sie sich bei Ihrem Cloud-Speicher, um Prompts zu laden.&#39;;
        } else if (error.message.includes(&#39;Bibliothek nicht gefunden&#39;)) {
          errorMessage = &#39;Die ausgewählte Bibliothek wurde nicht gefunden. Bitte überprüfen Sie die Bibliothekskonfiguration.&#39;;
        } else if (error.message.includes(&#39;Server-Fehler&#39;)) {
          errorMessage = &#39;Server-Fehler beim Laden der Prompts. Bitte überprüfen Sie, ob der Bibliothekspfad existiert und zugänglich ist.&#39;;
        } else if (error.message.includes(&#39;Keine aktive Bibliothek&#39;)) {
          errorMessage = &#39;Keine aktive Bibliothek verfügbar. Bitte wählen Sie eine Bibliothek aus.&#39;;
        }
      }

      setError(errorMessage);
      toast({
        title: &quot;Fehler beim Laden der Prompts&quot;,
        description: errorMessage,
        variant: &quot;destructive&quot;,
      });
    } finally {
      setIsLoading(false);
    }
  }, [providerInstance, libraryStatus, activeLibrary, listItems, setTemplates, setTemplatesFolderId, setIsLoading, setError, toast, ensureTemplatesFolder]);

  // Effect für Template Loading (wie Library-Komponente)
  useEffect(() =&gt; {
    const isReady = providerInstance &amp;&amp; libraryStatus === &#39;ready&#39; &amp;&amp; activeLibrary

    if (!isReady) {
      return
    }

    // Templates laden wenn noch nicht geladen
    if (!templatesFolderId) {
      loadTemplates()
    }
  }, [providerInstance, libraryStatus, activeLibrary, templatesFolderId, loadTemplates])

  // Reset wenn sich die Library ändert
  useEffect(() =&gt; {
    setSelectedTemplateName(null)
    setTemplatesFolderId(null)
    setTemplates([])
    setError(null)
  }, [libraryStatus, setSelectedTemplateName, setTemplatesFolderId, setTemplates, setError])

  useEffect(() =&gt; {
    async function loadSelectedContext() {
      if (!providerInstance || !Array.isArray(selectedContextIds) || selectedContextIds.length === 0) {
        setSelectedContextMarkdown(&quot;&quot;)
        return
      }
      try {
        const parts: string[] = []
        for (const id of selectedContextIds) {
          const { blob } = await providerInstance.getBinary(id)
          const text = await blob.text()
          parts.push(text)
        }
        setSelectedContextMarkdown(parts.join(&quot;\n\n---\n\n&quot;))
      } catch (e) {
        console.error(&#39;Fehler beim Laden des Kontextes&#39;, e)
        setSelectedContextMarkdown(&quot;&quot;)
      }
    }
    void loadSelectedContext()
  }, [providerInstance, selectedContextIds])

  function parseTemplateContent(content: string, fileName: string): Template {
    // Template in drei Bereiche aufteilen
    const parts = content.split(&#39;--- systemprompt&#39;)

    let yamlFrontmatter = &quot;&quot;
    let markdownBody = &quot;&quot;
    let systemPrompt = &quot;&quot;

    if (parts.length &gt;= 2) {
      const mainContent = parts[0].trim()
      systemPrompt = parts[1].trim()

      // YAML Frontmatter extrahieren
      const yamlMatch = mainContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/)
      if (yamlMatch) {
        yamlFrontmatter = `---\n${yamlMatch[1]}\n---`
        markdownBody = yamlMatch[2].trim()
      } else {
        // Kein YAML Frontmatter gefunden
        markdownBody = mainContent
      }
    } else {
      // Kein Systemprompt gefunden
      const yamlMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/)
      if (yamlMatch) {
        yamlFrontmatter = `---\n${yamlMatch[1]}\n---`
        markdownBody = yamlMatch[2].trim()
      } else {
        markdownBody = content
      }
    }

    return {
      name: fileName,
      yamlFrontmatter,
      markdownBody,
      systemPrompt,
    }
  }

  function generateTemplateContent(values: TemplateFormValues): string {
    let content = &quot;&quot;

    // YAML Frontmatter hinzufügen
    if (values.yamlFrontmatter.trim()) {
      content += values.yamlFrontmatter + &quot;\n\n&quot;
    }

    // Markdown Body hinzufügen
    content += values.markdownBody

    // System Prompt hinzufügen
    if (values.systemPrompt.trim()) {
      content += &quot;\n\n--- systemprompt\n&quot; + values.systemPrompt
    }

    return content
  }

  async function onSubmit(data: TemplateFormValues) {
    if (!activeLibrary || !templatesFolderId || !providerInstance) {
      toast({
        title: &quot;Fehler&quot;,
        description: &quot;Keine aktive Bibliothek oder Templates-Ordner nicht gefunden.&quot;,
        variant: &quot;destructive&quot;,
      })
      return
    }

    setIsSaving(true)
    try {
      const templateContent = generateTemplateContent(data)
      const fileName = `${data.name}.md`

      // Datei als Blob erstellen
      const blob = new Blob([templateContent], { type: &#39;text/markdown&#39; })
      const file = new File([blob], fileName, { type: &#39;text/markdown&#39; })

      // Datei hochladen
      await providerInstance.uploadFile(templatesFolderId, file)

      // Templates neu laden
      await loadTemplates()

      // Auswahl auf das neue Template setzen
      setSelectedTemplateName(data.name)

      toast({
        title: &quot;Template gespeichert&quot;,
        description: `Template &quot;${data.name}&quot; wurde erfolgreich im Verzeichnis &quot;/templates&quot; gespeichert.`,
      })
    } catch (error) {
      console.error(&#39;Fehler beim Speichern des Templates:&#39;, error)
      toast({
        title: &quot;Fehler beim Speichern&quot;,
        description: error instanceof Error ? error.message : &quot;Unbekannter Fehler&quot;,
        variant: &quot;destructive&quot;,
      })
    } finally {
      setIsSaving(false)
    }
  }

  async function renameCurrentTemplate() {
    const current = selectedTemplateName ? templates.find(t =&gt; t.name === selectedTemplateName) : null
    if (!current || !current.fileId || !providerInstance) return
    const newName = (window.prompt(&#39;Neuen Namen eingeben:&#39;, current.name) || &#39;&#39;).trim()
    if (!newName || newName === current.name) return
    if (/[^a-zA-Z0-9._\- ]/.test(newName)) { toast({ title: &#39;Ungültiger Name&#39;, description: &#39;Nur Buchstaben, Zahlen, Leerzeichen, . _ - sind erlaubt.&#39;, variant: &#39;destructive&#39; }); return }
    if (templates.some(t =&gt; t.name.toLowerCase() === newName.toLowerCase())) { toast({ title: &#39;Bereits vorhanden&#39;, description: &#39;Bitte anderen Namen wählen.&#39;, variant: &#39;destructive&#39; }); return }
    try {
      await providerInstance.renameItem(current.fileId, `${newName}.md`)
      await loadTemplates()
      setSelectedTemplateName(newName)
      form.setValue(&#39;name&#39;, newName, { shouldDirty: false })
      toast({ title: &#39;Umbenannt&#39;, description: `${current.name} → ${newName}` })
    } catch (e) {
      toast({ title: &#39;Fehler beim Umbenennen&#39;, description: e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;, variant: &#39;destructive&#39; })
    }
  }

  async function deleteTemplate(templateName: string) {
    if (!activeLibrary || !providerInstance) return

    try {
      const template = templates.find(t =&gt; t.name === templateName)
      if (!template?.fileId) {
        throw new Error(&quot;Template-Datei nicht gefunden&quot;)
      }

      // Datei löschen
      await providerInstance.deleteItem(template.fileId)

      // Templates neu laden
      await loadTemplates()

      if (selectedTemplateName === templateName) {
        setSelectedTemplateName(null)
        form.reset()
      }

      toast({
        title: &quot;Template gelöscht&quot;,
        description: `Template &quot;${templateName}&quot; wurde erfolgreich gelöscht.`,
      })
    } catch (error) {
      console.error(&#39;Fehler beim Löschen des Templates:&#39;, error)
      toast({
        title: &quot;Fehler beim Löschen&quot;,
        description: error instanceof Error ? error.message : &quot;Unbekannter Fehler&quot;,
        variant: &quot;destructive&quot;,
      })
    }
  }

  async function createNewTemplate() {
    const name = (window.prompt(&#39;Neuen Template‑Namen eingeben:&#39;) || &#39;&#39;).trim()
    if (!name) return
    if (/[^a-zA-Z0-9._\- ]/.test(name)) { toast({ title: &#39;Ungültiger Name&#39;, description: &#39;Nur Buchstaben, Zahlen, Leerzeichen, . _ - sind erlaubt.&#39;, variant: &#39;destructive&#39; }); return }
    if (templates.some(t =&gt; t.name.toLowerCase() === name.toLowerCase())) { toast({ title: &#39;Bereits vorhanden&#39;, description: &#39;Bitte anderen Namen wählen.&#39;, variant: &#39;destructive&#39; }); return }
    if (!providerInstance) { toast({ title: &#39;Kein Provider&#39; , variant: &#39;destructive&#39; }); return }
    try {
      const folderId = await ensureTemplatesFolder()
      const values = getDefaultTemplateValues(name)
      const content = (values.yamlFrontmatter ? values.yamlFrontmatter + &#39;\n\n&#39; : &#39;&#39;) + values.markdownBody + &#39;\n\n--- systemprompt\n&#39; + values.systemPrompt
      const file = new File([new Blob([content], { type: &#39;text/markdown&#39; })], `${name}.md`, { type: &#39;text/markdown&#39; })
      await providerInstance.uploadFile(folderId, file)
      await loadTemplates()
      setSelectedTemplateName(name)
      form.reset(values)
      toast({ title: &#39;Template angelegt&#39;, description: `&quot;${name}&quot; wurde erstellt.` })
    } catch (e) {
      toast({ title: &#39;Fehler beim Anlegen&#39;, description: e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;, variant: &#39;destructive&#39; })
    }
  }

  function generatePreview(): string {
    const values = form.getValues()
    return generateTemplateContent(values)
  }

  async function testTemplate() {
    if (!activeLibrary) return

    setIsTesting(true)
    setTestResult(null)

    const values = form.getValues()
    const templateContent = generateTemplateContent(values)
    const testText = selectedContextMarkdown || &quot;&quot;

    try {
      const response = await fetch(&#39;/api/secretary/process-text&#39;, {
        method: &#39;POST&#39;,
        headers: {
          &#39;Content-Type&#39;: &#39;application/x-www-form-urlencoded&#39;,
          &#39;X-Library-Id&#39;: activeLibrary.id,
        },
        body: new URLSearchParams({
          text: testText,
          template_content: templateContent,
          source_language: &#39;de&#39;,
          target_language: &#39;de&#39;,
        }),
      })

      if (!response.ok) {
        const errorData = await response.json()
        throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`)
      }

      const result = await response.json()
      const formattedResult = typeof result === &#39;string&#39; ? result : JSON.stringify(result, null, 2)
      setTestResult(formattedResult)

      toast({
        title: &quot;Prompt-Test erfolgreich&quot;,
        description: &quot;Der Prompt wurde erfolgreich mit dem gewählten Kontext verarbeitet.&quot;,
      })

      console.log(&#39;Prompt-Test Ergebnis:&#39;, result)
    } catch (error) {
      console.error(&#39;Fehler beim Prompt-Test:&#39;, error)
      const errorMessage = error instanceof Error ? error.message : &quot;Unbekannter Fehler&quot;
      setTestResult(`Fehler: ${errorMessage}`)
      toast({
        title: &quot;Prompt-Test fehlgeschlagen&quot;,
        description: errorMessage,
        variant: &quot;destructive&quot;,
      })
    } finally {
      setIsTesting(false)
    }
  }

  // Render-Logik für verschiedene Status
  if (libraryStatus === &quot;waitingForAuth&quot;) {
    return (
      &lt;div className=&quot;flex flex-col items-center justify-center h-full text-muted-foreground&quot;&gt;
        &lt;span&gt;Diese Bibliothek benötigt eine Authentifizierung.&lt;/span&gt;
        &lt;span className=&quot;text-sm mt-2&quot;&gt;Bitte konfigurieren Sie die Bibliothek in den Einstellungen.&lt;/span&gt;
      &lt;/div&gt;
    )
  }

  if (libraryStatus !== &quot;ready&quot;) {
    return (
      &lt;div className=&quot;flex flex-col items-center justify-center h-full text-muted-foreground&quot;&gt;
        &lt;span&gt;Lade Storage...&lt;/span&gt;
      &lt;/div&gt;
    )
  }

  if (!activeLibrary) {
    return (
      &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
        Bitte wählen Sie eine Bibliothek aus.
      &lt;/div&gt;
    )
  }

  if (error) {
    return (
      &lt;div className=&quot;text-center text-destructive&quot;&gt;
        &lt;p&gt;Fehler beim Laden der Prompts:&lt;/p&gt;
        &lt;p className=&quot;text-sm&quot;&gt;{error}&lt;/p&gt;
        &lt;Button 
          variant=&quot;outline&quot; 
          className=&quot;mt-4&quot;
          onClick={loadTemplates}
        &gt;
          Erneut versuchen
        &lt;/Button&gt;
      &lt;/div&gt;
    )
  }

  return (
    &lt;div className=&quot;space-y-6&quot;&gt;

      {/* Kompakte Toolbar oben */}
      &lt;div className=&quot;flex items-center gap-2&quot;&gt;
        &lt;Select value={selectedTemplateName || &#39;&#39;} onValueChange={(v) =&gt; { setSelectedTemplateName(v); form.setValue(&#39;name&#39;, v, { shouldDirty: false }) }} disabled={isLoading}&gt;
          &lt;SelectTrigger className=&quot;w-64&quot;&gt;
            &lt;SelectValue placeholder=&quot;Prompt auswählen...&quot; /&gt;
          &lt;/SelectTrigger&gt;
          &lt;SelectContent&gt;
            {templates.map((t) =&gt; (
              &lt;SelectItem key={t.name} value={t.name}&gt;{t.name}&lt;/SelectItem&gt;
            ))}
          &lt;/SelectContent&gt;
        &lt;/Select&gt;
        &lt;TooltipProvider&gt;
          &lt;Tooltip&gt;
            &lt;TooltipTrigger asChild&gt;
              &lt;Button variant=&quot;ghost&quot; size=&quot;sm&quot; className=&quot;h-8 w-8 p-0&quot;&gt;&lt;Info className=&quot;h-4 w-4&quot; /&gt;&lt;/Button&gt;
            &lt;/TooltipTrigger&gt;
            &lt;TooltipContent&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;&lt;FolderOpen className=&quot;h-4 w-4&quot; /&gt;&lt;span&gt;Ort: /templates in „{activeLibrary.label}“&lt;/span&gt;&lt;/div&gt;
            &lt;/TooltipContent&gt;
          &lt;/Tooltip&gt;
        &lt;/TooltipProvider&gt;
        &lt;Button type=&quot;button&quot; variant=&quot;outline&quot; size=&quot;sm&quot; onClick={createNewTemplate} disabled={isLoading}&gt;Neu&lt;/Button&gt;
        &lt;Button type=&quot;button&quot; variant=&quot;outline&quot; size=&quot;sm&quot; onClick={renameCurrentTemplate} disabled={!selectedTemplateName}&gt;Umbenennen&lt;/Button&gt;
        {selectedTemplateName &amp;&amp; (
          &lt;Button type=&quot;button&quot; variant=&quot;destructive&quot; size=&quot;sm&quot; onClick={() =&gt; deleteTemplate(selectedTemplateName!)}&gt;Löschen&lt;/Button&gt;
        )}
      &lt;/div&gt;

      &lt;div className=&quot;grid grid-cols-1 lg:grid-cols-2 gap-6&quot;&gt;
        &lt;Card&gt;
          &lt;CardHeader&gt;
            &lt;CardTitle&gt;Prompt Design&lt;/CardTitle&gt;
            &lt;CardDescription&gt;
              Drei Bereiche: Aufgabe (was), Rollenanweisung (wie), Metadaten (Begleitinfos).
            &lt;/CardDescription&gt;
          &lt;/CardHeader&gt;
          &lt;CardContent&gt;
            &lt;form onSubmit={form.handleSubmit(onSubmit)} className=&quot;space-y-6&quot;&gt;
              {/* Template-Name Feld entfernt (oben verwaltet) */}

              {previewMode ? (
                &lt;div className=&quot;space-y-4&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between&quot;&gt;
                    &lt;h4 className=&quot;text-sm font-medium&quot;&gt;Prompt-Vorschau&lt;/h4&gt;
                    &lt;Button
                      type=&quot;button&quot;
                      variant=&quot;outline&quot;
                      size=&quot;sm&quot;
                      onClick={() =&gt; setPreviewMode(false)}
                    &gt;
                      Bearbeiten
                    &lt;/Button&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;border rounded-md p-4 bg-muted/50&quot;&gt;
                    &lt;pre className=&quot;text-sm whitespace-pre-wrap font-mono&quot;&gt;
                      {generatePreview()}
                    &lt;/pre&gt;
                  &lt;/div&gt;
                &lt;/div&gt;
              ) : (
                &lt;StructuredTemplateEditor
                  markdownBody={form.watch(&#39;markdownBody&#39;)}
                  yamlFrontmatter={form.watch(&#39;yamlFrontmatter&#39;)}
                  systemPrompt={form.watch(&#39;systemPrompt&#39;)}
                  onChange={({ markdownBody, yamlFrontmatter, systemPrompt }) =&gt; {
                    form.setValue(&#39;markdownBody&#39;, markdownBody, { shouldDirty: true })
                    form.setValue(&#39;yamlFrontmatter&#39;, yamlFrontmatter, { shouldDirty: true })
                    form.setValue(&#39;systemPrompt&#39;, systemPrompt, { shouldDirty: true })
                  }}
                /&gt;
              )}

              &lt;div className=&quot;flex justify-end gap-2&quot;&gt;
                &lt;Button
                  type=&quot;button&quot;
                  variant=&quot;outline&quot;
                  onClick={() =&gt; setPreviewMode(!previewMode)}
                &gt;
                  &lt;Eye className=&quot;h-4 w-4 mr-2&quot; /&gt;
                  {previewMode ? &quot;Bearbeiten&quot; : &quot;Vorschau&quot;}
                &lt;/Button&gt;
                &lt;Button
                  type=&quot;submit&quot;
                  disabled={isSaving || !form.formState.isDirty}
                &gt;
                  {isSaving ? (
                    &lt;&gt;
                      &lt;Loader2 className=&quot;h-4 w-4 mr-2 animate-spin&quot; /&gt;
                      Wird gespeichert...
                    &lt;/&gt;
                  ) : (
                    &lt;&gt;
                      &lt;Save className=&quot;h-4 w-4 mr-2&quot; /&gt;
                      Speichern
                    &lt;/&gt;
                  )}
                &lt;/Button&gt;
              &lt;/div&gt;
            &lt;/form&gt;
          &lt;/CardContent&gt;
        &lt;/Card&gt;

        &lt;Card&gt;
          &lt;CardHeader&gt;
            &lt;CardTitle&gt;Prompt testen&lt;/CardTitle&gt;
            &lt;CardDescription&gt;
              Test mit Beispieltext. Nutzt Rollenanweisung, Aufgabe und Metadaten des Prompts.
            &lt;/CardDescription&gt;
          &lt;/CardHeader&gt;
          &lt;CardContent&gt;
            &lt;div className=&quot;space-y-4&quot;&gt;
              &lt;div className=&quot;space-y-2&quot;&gt;
                &lt;Label&gt;Kontext-Texte&lt;/Label&gt;
                &lt;div className=&quot;border rounded p-2 max-h-40 overflow-auto text-sm&quot;&gt;
                  {Array.isArray(contextDocs) &amp;&amp; contextDocs.length &gt; 0 ? (
                    contextDocs.map(d =&gt; {
                      const checked = selectedContextIds.includes(d.id)
                      return (
                        &lt;label key={d.id} className=&quot;flex items-center gap-2 py-1&quot;&gt;
                          &lt;Checkbox
                            checked={checked}
                            onCheckedChange={(v) =&gt; {
                              const isOn = v === true
                              setSelectedContextIds(prev =&gt; isOn ? [...prev, d.id] : prev.filter(x =&gt; x !== d.id))
                            }}
                          /&gt;
                          &lt;span className=&quot;truncate&quot;&gt;{d.name}&lt;/span&gt;
                        &lt;/label&gt;
                      )
                    })
                  ) : (
                    &lt;div className=&quot;text-muted-foreground text-sm&quot;&gt;Keine Kontext-Texte verfügbar&lt;/div&gt;
                  )}
                &lt;/div&gt;
              &lt;/div&gt;

              &lt;div className=&quot;space-y-2&quot;&gt;
                &lt;Label&gt;Gewählter Kontext (Lesemodus)&lt;/Label&gt;
                &lt;div className=&quot;border rounded-md&quot;&gt;
                  &lt;MarkdownPreview content={selectedContextMarkdown} className=&quot;max-h-64 overflow-auto&quot; /&gt;
                &lt;/div&gt;
              &lt;/div&gt;

              &lt;div className=&quot;space-y-2&quot;&gt;
                &lt;Label&gt;Prompt‑Vorschau (Aufgabe als Markdown)&lt;/Label&gt;
                &lt;div className=&quot;border rounded-md&quot;&gt;
                  &lt;MarkdownPreview content={form.watch(&#39;markdownBody&#39;) || &#39;&#39;} className=&quot;max-h-64 overflow-auto&quot; /&gt;
                &lt;/div&gt;
              &lt;/div&gt;

              &lt;div className=&quot;flex gap-2&quot;&gt;
                &lt;Button 
                  variant=&quot;outline&quot; 
                  size=&quot;sm&quot;
                  onClick={testTemplate}
                  disabled={!selectedTemplateName || isTesting}
                &gt;
                  {isTesting ? (
                    &lt;&gt;
                      &lt;Loader2 className=&quot;h-4 w-4 mr-2 animate-spin&quot; /&gt;
                      Teste...
                    &lt;/&gt;
                  ) : (
                    &lt;&gt;
                      &lt;Play className=&quot;h-4 w-4 mr-2&quot; /&gt;
                      Prompt testen
                    &lt;/&gt;
                  )}
                &lt;/Button&gt;
              &lt;/div&gt;

              {testResult &amp;&amp; (
                &lt;div className=&quot;space-y-2&quot;&gt;
                  &lt;Label&gt;Ergebnis (Markdown)&lt;/Label&gt;
                  &lt;div className=&quot;border rounded-md&quot;&gt;
                    &lt;MarkdownPreview content={testResult} className=&quot;max-h-80 overflow-auto&quot; /&gt;
                  &lt;/div&gt;
                &lt;/div&gt;
              )}
            &lt;/div&gt;
          &lt;/CardContent&gt;
        &lt;/Card&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
} 
</code></pre></div>
<p>Ich öffne die betroffene Datei, um die Funktionsdeklaration innerhalb eines Blocks in eine <code>const</code>-Funktionszuweisung umzuschreiben. Danach starte ich erneut den Build.</p>
<p>Ich konvertiere die Funktionsdeklarationen <code>submitOne</code> und <code>worker</code> in <code>const</code>-Funktionsausdrücke, um den ES5-Strict-Mode-Fehler zu beheben, und starte danach den Build.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>

<span class="c1">// Batch-Submit: Erwartet JSON mit items[] (each: { fileId, parentId, name, mimeType }) und optionalen Optionen/Batch-Metadaten</span>
<span class="c1">// Server lädt Binärdaten per Server-Storage, reicht an die bestehende process-pdf Route weiter.</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchItemInput</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mimeType?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">options</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">targetLanguage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">extractionMethod?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">includeImages?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">useCache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">template?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doExtractMetadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doIngestRAG?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">forceRecreate?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">[];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Content-Type application/json erwartet&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">415</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">items</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">batchName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body.batchName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;libraryId und items erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Serverseitige Parallelität begrenzen (z. B. 5)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Eindeutige Batch-ID generieren, für zuverlässiges Grouping unabhängig vom Namen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomUUID</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Worker-Funktion: reiche einzelne Datei weiter an process-pdf</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">submitOne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Hole Datei-Binärdaten via interner API, um Code-Duplizierung zu vermeiden</span>
<span class="w">        </span><span class="c1">// Wir nutzen die bestehende Client-Route, indem wir eine FormData bauen und lokal requesten</span>
<span class="w">        </span><span class="c1">// Vorteil: die gesamte Job-Anlage/Idempotenz bleibt an einem Ort</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Holen der Datei aus dem Storage muss in der Zielroute passieren; hier nur Metadaten weitergeben</span>
<span class="w">        </span><span class="c1">// Aber unsere bestehende process-pdf Route erwartet die Datei bereits. Daher rufen wir sie nicht direkt hier,</span>
<span class="w">        </span><span class="c1">// sondern nutzen einen vereinfachten Pfad: Der Client übergibt im Normalfall Binärdaten.</span>
<span class="w">        </span><span class="c1">// Für serverseitige Batch-Einreichung wählen wir den robusteren Weg: lade die Datei serverseitig und reiche mit.</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">template</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractMetadata&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doIngestRAG&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;forceRecreate&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Wichtig: Phase 1 standardmäßig aktivieren, damit Secretary aufgerufen wird</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractPDF&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/api/secretary/process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;X-Library-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// Clerk-Session weiterreichen, damit die Zielroute authentifiziert ist</span>
<span class="w">            </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">));</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">job</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="nx">.job.id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Einfache Concurrency-Queue</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.min</span><span class="p">(</span><span class="nx">concurrency</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">worker</span><span class="p">());</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">workers</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">okCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="o">?</span><span class="p">.</span><span class="nx">ok</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">failCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">okCount</span><span class="p">;</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf-batch&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Batch abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">items.length</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Ich passe die benannte Datei an, um den Zugriff auf ein nicht existentes Feld zu entfernen, und starte danach erneut den Build.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>

<span class="c1">// Batch-Submit: Erwartet JSON mit items[] (each: { fileId, parentId, name, mimeType }) und optionalen Optionen/Batch-Metadaten</span>
<span class="c1">// Server lädt Binärdaten per Server-Storage, reicht an die bestehende process-pdf Route weiter.</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchItemInput</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mimeType?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">options</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">targetLanguage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">extractionMethod?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">includeImages?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">useCache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">template?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doExtractMetadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doIngestRAG?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">forceRecreate?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">[];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Content-Type application/json erwartet&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">415</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">items</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">batchName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body.batchName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;libraryId und items erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Serverseitige Parallelität begrenzen (z. B. 5)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Eindeutige Batch-ID generieren, für zuverlässiges Grouping unabhängig vom Namen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomUUID</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Worker-Funktion: reiche einzelne Datei weiter an process-pdf</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">submitOne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Hole Datei-Binärdaten via interner API, um Code-Duplizierung zu vermeiden</span>
<span class="w">        </span><span class="c1">// Wir nutzen die bestehende Client-Route, indem wir eine FormData bauen und lokal requesten</span>
<span class="w">        </span><span class="c1">// Vorteil: die gesamte Job-Anlage/Idempotenz bleibt an einem Ort</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Holen der Datei aus dem Storage muss in der Zielroute passieren; hier nur Metadaten weitergeben</span>
<span class="w">        </span><span class="c1">// Aber unsere bestehende process-pdf Route erwartet die Datei bereits. Daher rufen wir sie nicht direkt hier,</span>
<span class="w">        </span><span class="c1">// sondern nutzen einen vereinfachten Pfad: Der Client übergibt im Normalfall Binärdaten.</span>
<span class="w">        </span><span class="c1">// Für serverseitige Batch-Einreichung wählen wir den robusteren Weg: lade die Datei serverseitig und reiche mit.</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">template</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractMetadata&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doIngestRAG&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;forceRecreate&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Wichtig: Phase 1 standardmäßig aktivieren, damit Secretary aufgerufen wird</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractPDF&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/api/secretary/process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;X-Library-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// Clerk-Session weiterreichen, damit die Zielroute authentifiziert ist</span>
<span class="w">            </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">));</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">job</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="nx">.job.id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Einfache Concurrency-Queue</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.min</span><span class="p">(</span><span class="nx">concurrency</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">worker</span><span class="p">());</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">workers</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">okCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="o">?</span><span class="p">.</span><span class="nx">ok</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">failCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">okCount</span><span class="p">;</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf-batch&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Batch abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">items.length</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Build läuft jetzt erfolgreich durch. Es bleiben nur React-Hook-Warnungen, die den Build nicht blockieren.</li>
</ul>
<p>Kurzupdate:
- Ich habe die Typfehler in <code>retry/route.ts</code> und <code>process-pdf/batch/route.ts</code> behoben (kein Zugriff mehr auf <code>bin.name</code>).
- Ungenutzte Importe in <code>combined-chat-dialog.tsx</code> und <code>template-management.tsx</code> entfernt.
- Strict-Mode-Fehler behoben, indem Funktionsdeklarationen in <code>const</code>-Zuweisungen geändert wurden.
- Build mehrfach gestartet; der letzte Durchlauf war erfolgreich.</p>
<p>Tests/Verifikation:
- <code>pnpm build</code> lief fehlerfrei durch. Die aufgelisteten ESLint-Warnungen betreffen Hook-Dependencies und blockieren nicht.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js"></script>
      
        <script src="../../assets/javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>