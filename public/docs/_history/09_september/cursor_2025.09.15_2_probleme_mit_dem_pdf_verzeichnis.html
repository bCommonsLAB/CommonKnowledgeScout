
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://localhost:3000/docs/_history/09_september/cursor_2025.09.15_2_probleme_mit_dem_pdf_verzeichnis.html">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Probleme mit dem PDF-Verzeichnis verarbeiten - Common Knowledge Scout</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/print.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#probleme-mit-dem-pdf-verzeichnis-verarbeiten" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Common Knowledge Scout" class="md-header__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Common Knowledge Scout
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Probleme mit dem PDF-Verzeichnis verarbeiten
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Common Knowledge Scout" class="md-nav__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Common Knowledge Scout
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/intro.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/features.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/architecture.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/core-components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core Components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/getting-started.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/settings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Settings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/library.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using the Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/event-monitor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event Monitor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/batch-session-import.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Session Import
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/troubleshooting.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/faq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/storage-provider.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage Provider
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/localstorage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileSystem (Local)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/image-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/pdf/extraction-methods.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/metadata.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metadata
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/global-state.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Global State
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/header.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Header
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/breadcrumb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Breadcrumb
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-tree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileTree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-list.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileList
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/upload.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Upload
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-preview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FilePreview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/batch-transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/error-handling-logging-testing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Error Handling & Tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/initialization-sequence.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Initialization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Library Components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/shadowtwins.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/extended-shadowtwin.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extended Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/transformation-service.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformation Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/video-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Video Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/glossary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/secretary-services.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Secretary Services
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/track-processor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Track Processor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chat-response-generation-process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat & Story Mode
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/deployment/docker.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker Deployment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/quick-setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Quick Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/package-strategy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Package Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="probleme-mit-dem-pdf-verzeichnis-verarbeiten">Probleme mit dem PDF-Verzeichnis verarbeiten<a class="headerlink" href="#probleme-mit-dem-pdf-verzeichnis-verarbeiten" title="Permanent link">&para;</a></h1>
<p><em>Exported on 10/9/2025 at 14:59:29 GMT+2 from Cursor (1.7.38)</em></p>
<hr />
<p><strong>User</strong></p>
<p>Ich habe ein Problem beim Dialog "PDF-Verzeichnis verarbeiten" 
Viele Dokumente auswähle und die jetzt Jobs starten, dann friert die Maske ein. Sollten die Jobs nicht beim Secretarial Service eingereicht werden? Und wieso ist dieser Prozess nicht asynchron? Warten wir, bis jeder einzelne Prozess bestätigt wurde, bis das einreichen? Können die Jobs alle gleichzeitig eingereicht werden oder muss man hier eines nach dem anderen einreichen?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich schaue zuerst nach, wo der Dialog und die Job-Einreichung implementiert sind, um zu prüfen, ob Sequenziell gewartet wird statt asynchron. Danach passe ich die Einreichlogik ggf. auf parallele/limitierte Einreichung an.</p>
<p>Ich prüfe die Einreichlogik im Dialog und die API-Route, um festzustellen, ob derzeit sequentiell auf jede Bestätigung gewartet wird. Danach stelle ich die UI auf parallele (limitierte) Einreichung um, reduziere pro-Datei-Toasts und zeige eine zusammenfassende Meldung. Jetzt lese ich die relevanten Dateien.</p>
<p>Ich habe den Dialog und die API-Route geprüft. Aktuell werden die Einreichungen tatsächlich sequenziell mit await nacheinander abgearbeitet; das erklärt die „eingefrorene“ Maske bei vielen Dateien.</p>
<ul>
<li>Befund UI: In <code>PdfBulkImportDialog.handleEnqueue</code> wird pro Datei Binary geladen, <code>FormData</code> gebaut und dann <code>fetch</code> awaited, bevor die nächste Datei startet. Zitat:
```163:349:src/components/library/pdf-bulk-import-dialog.tsx
for (const { file, parentId } of candidates) {
  // ...
  const res = await fetch('/api/secretary/process-pdf', { method: 'POST', /<em>...</em>/ });
  // ...
}
<div class="highlight"><pre><span></span><code>- Befund Server: Die Route `POST /api/secretary/process-pdf` legt sofort einen Job an und leitet an den Secretary-Service weiter (mit Auth-Headern) und antwortet früh. Zitat:
```17:539:src/app/api/secretary/process-pdf/route.ts
response = await fetch(normalizedUrl, { method: &#39;POST&#39;, body: serviceFormData, headers: { Accept: &#39;application/json&#39;, Authorization: `Bearer ${apiKey}`, &#39;X-Service-Token&#39;: apiKey } });
return NextResponse.json({ ...data, job: { id: jobId } });
</code></pre></div>
Damit: Die Verarbeitung ist serverseitig asynchron, aber das Einreichen in der UI ist synchron/sequenziell. Wir warten je Datei auf die HTTP-Antwort (nicht bis zur Job-Fertigstellung), bevor die nächste Einreichung beginnt. Zusätzlich erzeugen per-Datei-Toast-Meldungen UI-Overhead.</li>
</ul>
<p>Antworten auf deine Fragen:
- Sollten die Jobs beim Secretary Service eingereicht werden? Ja. Das passiert bereits über unsere API-Route, die die nötigen Service-Header setzt [[memory:6998386]].
- Wieso nicht asynchron? Serverseitig ist es asynchron. Der Dialog reicht aber Jobs sequentiell ein und wartet je Request, was die UI blockiert.
- Warten wir bis jeder einzelne Prozess bestätigt wurde? Wir warten auf die HTTP-Antwort pro Einreichung (Job angenommen/Fehler), nicht auf die Job-Fertigstellung. Das geschieht nacheinander.
- Können die Jobs alle gleichzeitig eingereicht werden? Ja, technisch möglich. Sinnvoll ist eine begrenzte Parallelität (z. B. 3–5 gleichzeitig), um Netzwerk/CPU nicht zu überlasten und den Secretary-Service nicht zu fluten.</p>
<p>Vorschlag (drei Varianten):
- Minimal-invasiv (empfohlen sofort): Limitierte Parallelität im Dialog (z. B. 4). Ersetze die for-Schleife durch einen kleinen Concurrency-Runner, reduziere per-Datei-Toasts (nur Fehler bündeln, am Ende eine Zusammenfassung). Das ändert nur Client-Code.
- Mittel: Serverseitige Batch-Route (z. B. <code>/api/secretary/process-pdf/batch</code>) die mehrere Dateien annimmt und intern mit limitierter Parallelität weiterleitet. UI schickt nur 1 Request. Mehr Aufwand, aber robust.
- Strukturell: Statt Datei-Binary vom Client zu schicken, nur <code>originalItemId/parentId</code> senden; die Server-Route lädt das Binary via <code>getServerProvider</code>. Dadurch wird die UI leichtgewichtig und lässt sich problemlos parallelisieren. Erfordert Anpassung der Route.</p>
<p>Empfohlene Sofortmaßnahme
- Concurrency-Limit im Dialog (3–5), pro-Datei-Toasts abschalten, nur 1–2 Statusmeldungen (Start, Abschluss mit Erfolgs-/Fehleranzahl). Optional: Dialog direkt schließen und im Hintergrund einreichen; Fortschritt über den Job-Event-Stream anzeigen.</p>
<p>Tests
- 30–100 PDFs wählen, Einreichen starten, erwarten: UI bleibt responsiv, Dialog schließt schnell oder zeigt Fortschritt ohne Ruckeln, im Job-Stream erscheinen zügig „queued“-Events, Abschluss-Toast fasst zusammen.</p>
<p>Kurzfazit
- Die UI friert, weil die Einreichung sequenziell awaited wird und pro Datei teure Schritte laufen.
- Umstellen auf limitierte Parallelität + weniger Toasts löst das Problem erfahrungsgemäß zuverlässig, ohne Backend-Änderung.</p>
<div class="highlight"><pre><span></span><code>for (const { file, parentId } of candidates) {
  // ...
  const res = await fetch(&#39;/api/secretary/process-pdf&#39;, { method: &#39;POST&#39;, /*...*/ });
  // ...
}
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">normalizedUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">serviceFormData</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Accept</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;X-Service-Token&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>Also ich möchte diese Version implementieren, wo ich die Jobs im Frontend bestimme. Dann checke ich sie ein und dann werden die Jobs serverseitig, ist mir dann auch egal, hintereinander beim Secretary Service eingereicht. Das Secretary Service hat ja auch eine bestimmte Parallelität. Ich glaube es werden fünf gleichzeitig abgearbeitet. So können wir ja auch in Badges von fünf einreichen, serverseitig, und warten bis wieder welche frei werden. Wichtig wäre mir nur, dass wir im Frontend in dieser Liste der Jobs sehen, welche gerade verarbeitet werden und wie viele noch offen sind oder wie viele schon erledigt sind. Vielleicht können wir beim Einreichen diesen BDF Verzeichnis abarbeiten, dass man diesen Verzeichnisnamen als Badgenamen verwendet und so können wir in dem Job Übersicht nach diesem Badgenamen filtern und sehen was zusammengehört.
Dass man pro Job oben auch filtern kann, welche sind erledigt, welche sind noch offen und welche sind fehlerhaft. Und vielleicht könnte man fehlerhafte nochmal neu starten. Da ist vielleicht irgendwie ein Verbindungsproblem gehabt oder ein temporäres Problem. Wie könnten wir das umsetzen?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich suche nach existierenden Job-Übersichten und Status-Filtern, um daran anzuknüpfen und die Batch/Badge-Funktion einzubauen. Danach baue ich eine Batch-Create-Route und einen serverseitigen Runner mit Parallelität 5.</p>
<p>Ich markiere Aufgaben, die ich jetzt umsetze: Batch-Create-API mit serverseitigem Runner (Parallelität 5), Batch-Tagging (Verzeichnisname), UI-Filter im Job-Monitor (Status, Batch), Retry für fehlgeschlagene Jobs. Ich lese dafür die Job-Typen, Repository und bestehende Job-API/Stream, um kompatibel zu erweitern.</p>
<p>Ich werde jetzt die notwendigen Dateien anpassen und neue Routen/Utilities hinzufügen: 1) Typ <code>ExternalJobCorrelation</code> um <code>batchName</code> erweitern, 2) <code>process-pdf</code>-Route so erweitern, dass <code>batchId</code>/<code>batchName</code> aus dem Request übernommen werden, 3) neue Batch-Route mit Server-seitiger Parallelität (5) erstellen, 4) Repository- und <code>GET /api/external/jobs</code>-Route um Filter nach Status/Batch erweitern, 5) den Dialog so ändern, dass er die Batch-Route nutzt. Danach prüfe ich Linterfehler.</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;running&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;pending-storage&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ExternalJobCorrelationSource</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">itemId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">parentId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mediaType?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// e.g. &#39;pdf&#39;</span>
<span class="w">  </span><span class="nx">mimeType?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ExternalJobCorrelation</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source?</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobCorrelationSource</span><span class="p">;</span>
<span class="w">  </span><span class="nx">options?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">batchId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ExternalJobPayloadMeta</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// secretary/process payload fields (subset)</span>
<span class="w">  </span><span class="nx">extracted_text?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// Neu: Link-basiert statt große Base64-Blobs</span>
<span class="w">  </span><span class="nx">images_archive_url?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// Alt (deprecated): Wird nicht mehr persistiert</span>
<span class="w">  </span><span class="nx">images_archive_data?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">images_archive_filename?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ExternalJobResultRefs</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">savedItemId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">savedItems?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ExternalJobLogEntry</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<span class="w">  </span><span class="nx">phase?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">progress?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0..100</span>
<span class="w">  </span><span class="nx">message?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="p">[</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">unknown</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ExternalJobStep</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">startedAt?</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<span class="w">  </span><span class="nx">endedAt?</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<span class="w">  </span><span class="nx">durationMs?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">error</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">code?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ExternalJobIngestionInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">vectorsUpserted?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">index?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">namespace?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">upsertAt?</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">jobSecretHash</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// sha256 of secret</span>
<span class="w">  </span><span class="nx">job_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;audio&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;video&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;image&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;extract&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;transcribe&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;transform&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;summarize&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="p">;</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">correlation</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobCorrelation</span><span class="p">;</span>
<span class="w">  </span><span class="nx">processId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">payload?</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobPayloadMeta</span><span class="p">;</span>
<span class="w">  </span><span class="nx">result?</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobResultRefs</span><span class="p">;</span>
<span class="w">  </span><span class="nx">logs?</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobLogEntry</span><span class="p">[];</span>
<span class="w">  </span><span class="nx">steps?</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStep</span><span class="p">[];</span>
<span class="w">  </span><span class="nx">parameters?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">cumulativeMeta?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">metaHistory?</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">at</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span><span class="w"> </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">ingestion?</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobIngestionInfo</span><span class="p">;</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<span class="w">  </span><span class="nx">error</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>Ich aktualisiere zuerst den Typ um Batch-Felder und erweitere dann die API-Routen. Danach baue ich eine neue Batch-Route mit serverseitiger Parallelität 5. Ich lese die vollständigen Implementierungen für Repository-Methoden und die GET-Liste, um Filter zu ergänzen.</p>
<p>Ich setze eine Aufgabenliste auf und beginne mit den serverseitigen Änderungen (Typ/Route-Erweiterungen, Batch-Route). Danach ergänze ich Filter und UI.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">env</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;process&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">startWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="c1">// Storage: konsequent Server-Provider verwenden</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">gateExtractPdf</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/processing/gates&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Route aufgerufen&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Authentifizierung prüfen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[process-pdf] Nicht authentifiziert&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Authentifizierung erfolgreich&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Alle Request-Header protokollieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerObj</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">headerObj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// FormData aus dem Request holen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">formData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">formDataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="nx">formData</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">formDataKeys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;FormData empfangen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">keys</span><span class="o">:</span><span class="w"> </span><span class="kt">formDataKeys</span><span class="w"> </span><span class="p">});</span>


<span class="w">    </span><span class="c1">// Secretary Service URL aus Umgebungsvariablen holen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">secretaryServiceUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Sicherstellen, dass keine doppelten Slashes entstehen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">secretaryServiceUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryServiceUrl</span><span class="si">}</span><span class="sb">pdf/process`</span><span class="w"> </span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryServiceUrl</span><span class="si">}</span><span class="sb">/pdf/process`</span><span class="p">;</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Forward an Secretary Service&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="kt">normalizedUrl</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Eine neue FormData erstellen, die nur die für den Secretary Service relevanten Felder enthält</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">serviceFormData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Datei hinzufügen</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">File</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Protokolliere ungefähre Dateigröße für Debugging</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">File</span><span class="p">;</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[process-pdf] Ungefähre Dateigröße:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bytes&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Zielsprache (target_language)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Standardwert</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Template-Option NICHT an Secretary senden – wir transformieren serverseitig im Callback</span>
<span class="w">    </span><span class="c1">// (Der Secretary erwartet ggf. einen Pfad und würde sonst &#39;...md.md&#39; anhängen.)</span>
<span class="w">    </span><span class="c1">// Veraltetes Feld skipTemplate wird nicht mehr verwendet</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">skipTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Extraktionsmethode – Clientwert oder Library-Default</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">effectiveExtraction</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">effectiveExtraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">effectiveExtraction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">libHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-library-id&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Library-Id&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">usr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">usr</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">libHeader</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">svc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">libs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">svc</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libs</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libHeader</span><span class="p">);</span>
<span class="w">          </span><span class="nx">effectiveExtraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="o">?</span><span class="p">.</span><span class="nx">config</span><span class="o">?</span><span class="p">.</span><span class="nx">secretaryService</span><span class="o">?</span><span class="p">.</span><span class="nx">pdfDefaults</span><span class="o">?</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extraction_method&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">effectiveExtraction</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;native&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Cache-Optionen</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Standardwert: Cache verwenden</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Include Images Option</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Standardwert: Keine Bilder</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Force refresh Option</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Standardwert</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Veraltetes Feld useIngestionPipeline wird nicht mehr verwendet</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">useIngestionPipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Neue vereinfachte Flags aus dem Request</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">doExtractPDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doExtractPDF&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doExtractMetadata&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doIngestRAG&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">forceRecreate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;forceRecreate&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Fallback: Wenn Flags fehlen (alle false), aus alten Parametern ableiten</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">doExtractPDF</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">doIngestRAG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">doExtractPDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// Phase 1 grundsätzlich erlaubt</span>
<span class="w">      </span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">skipTemplate</span><span class="p">;</span><span class="w"> </span><span class="c1">// wenn nicht Phase-1-only, dann Metadaten</span>
<span class="w">      </span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useIngestionPipeline</span><span class="p">;</span><span class="w"> </span><span class="c1">// bis Alt-Flag entfernt ist</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Job anlegen (per-Job-Secret)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomUUID</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mf">24</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64url&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobSecretHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">jobSecret</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Correlation aus Request ableiten</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-library-id&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Korrelation: nutze die bereits ermittelte effektive Methode oben, falls vorhanden</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractionMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;extraction_method&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;native&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">includeImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">useCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">File</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Optional vom Client mitgeliefert (für zielgenaues Speichern)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">correlation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">mediaType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">file?.type</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">file?.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">parentId</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">        </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">useCache</span><span class="o">:</span><span class="w"> </span><span class="kt">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">batchId</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">batchName</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="nx">satisfies</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">];</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">jobSecretHash</span><span class="p">,</span>
<span class="w">      </span><span class="nx">job_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;extract&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">correlation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Schritte initialisieren und Parameter mitschreiben (für Report-Tab)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phases</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">extract</span><span class="o">:</span><span class="w"> </span><span class="kt">doExtractPDF</span><span class="p">,</span><span class="w"> </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">doExtractMetadata</span><span class="p">,</span><span class="w"> </span><span class="nx">ingest</span><span class="o">:</span><span class="w"> </span><span class="kt">doIngestRAG</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">initializeSteps</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">useCache</span><span class="o">:</span><span class="w"> </span><span class="kt">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">phases</span><span class="p">,</span>
<span class="w">      </span><span class="c1">// Neue vereinfachte Flags</span>
<span class="w">      </span><span class="nx">doExtractPDF</span><span class="p">,</span>
<span class="w">      </span><span class="nx">doExtractMetadata</span><span class="p">,</span>
<span class="w">      </span><span class="nx">doIngestRAG</span><span class="p">,</span>
<span class="w">      </span><span class="nx">forceRecreate</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job angelegt&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="p">,</span>
<span class="w">      </span><span class="nx">useCache</span><span class="p">,</span>
<span class="w">      </span><span class="nx">targetLanguage</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Sofortiges Live-Event: queued (für UI, damit Eintrag direkt erscheint)</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="c1">// Watchdog starten (600s ohne Progress =&gt; Timeout)</span>
<span class="w">    </span><span class="nx">startWatchdog</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mf">600</span><span class="nx">_000</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Callback-Informationen (generisch) anfügen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">appUrl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_url&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Detailliertes Logging der Callback-Parameter</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Callback-Parameter vorbereitet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">callbackUrl</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasAppUrl</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">appUrl</span><span class="p">,</span>
<span class="w">        </span><span class="nx">appUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">appUrl</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NEXT_PUBLIC_APP_URL nicht gesetzt&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// per-Job-Secret mitgeben</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobSecret</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// jobId nicht zusätzlich mitsenden – steht in der Callback-URL</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job-Secret generiert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasSecret</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">jobSecret</span><span class="p">,</span>
<span class="w">      </span><span class="nx">secretLength</span><span class="o">:</span><span class="w"> </span><span class="kt">jobSecret.length</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Korrelation NICHT an Secretary senden – Secretary erhält nur jobId + Callback</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Korrelation nicht an Secretary gesendet (nur jobId &amp; Callback)&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">correlationSummary</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">hasSource</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasOptions</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// HTTP-Request als JSON loggen (kopierbar für Tests)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">httpRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="kt">normalizedUrl</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;multipart/form-data&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;[BINARY: PDF-Datei]&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extraction_method</span><span class="o">:</span><span class="w"> </span><span class="kt">extractionMethod</span><span class="p">,</span>
<span class="w">        </span><span class="nx">useCache</span><span class="o">:</span><span class="w"> </span><span class="kt">useCache</span><span class="p">,</span>
<span class="w">        </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">includeImages</span><span class="p">,</span>
<span class="w">        </span><span class="nx">force_refresh</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">callback_url</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">callback_token</span><span class="o">:</span><span class="w"> </span><span class="kt">jobSecret</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;HTTP-Request an Secretary Service&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">httpRequest</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// Persistenter Logeintrag in DB</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_sent&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sourcePath</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.itemId</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.parentId</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">appUrl</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Idempotenz ist immer aktiv</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">autoSkipExisting</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Extract-Gate vor dem Secretary-Call: vorhanden? → je nach Flags entscheiden</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">autoSkipExisting</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">gateExtractPdf</span><span class="p">({</span>
<span class="w">          </span><span class="nx">repo</span><span class="o">:</span><span class="w"> </span><span class="kt">repository</span><span class="p">,</span>
<span class="w">          </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">          </span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">lib</span><span class="p">,</span>
<span class="w">          </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">file?.name</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">exists</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">forceRecreate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Phase 1 überspringen</span>
<span class="w">          </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="kt">g.reason</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">          </span><span class="c1">// Template-Only Pfad, wenn nicht explizit skipTemplate=true</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">skipTemplate</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">doExtractMetadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries2</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">startedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>

<span class="w">                </span><span class="c1">// Template-Datei finden (wie im Callback)</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">rootItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">templatesFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rootItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;templates&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">ensureTemplatesFolderId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">templatesFolder</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">templatesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">createFolder</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;templates&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="nx">created</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">templatesFolderId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureTemplatesFolderId</span><span class="p">();</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="nx">chosen</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">templatesFolderId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tplItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">templatesFolderId</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">preferredTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">lib2</span><span class="p">.</span><span class="nx">config</span><span class="o">?</span><span class="p">.</span><span class="nx">chat</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">transformerTemplate?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="o">?</span><span class="p">.</span><span class="nx">transformerTemplate</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pickByName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">tplItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">());</span>
<span class="w">                  </span><span class="nx">chosen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">preferredTemplate</span>
<span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="nx">pickByName</span><span class="p">(</span><span class="nx">preferredTemplate</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">preferredTemplate</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">preferredTemplate</span><span class="si">}</span><span class="sb">.md`</span><span class="p">)</span>
<span class="w">                    </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">pickByName</span><span class="p">(</span><span class="s1">&#39;pdfanalyse.md&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">pickByName</span><span class="p">(</span><span class="s1">&#39;pdfanalyse_default.md&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">tplItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">)));</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="nx">templateContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;# {{title}}\n&#39;</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chosen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">chosen</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">templateContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// Shadow‑Twin laden (im Parent by Name)</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">siblings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">details</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">details</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">details</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">matched?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="nx">.matched</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">file</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">targetLanguage</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">                </span><span class="p">})();</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">twin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">siblings</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedName</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">twin</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Shadow‑Twin nicht gefunden&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">twinBin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">twin</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalMarkdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">twinBin</span><span class="p">.</span><span class="nx">blob</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">stripped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalMarkdown</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^---[\s\S]*?---\s*/m</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// Transformer aufrufen</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">secretaryUrlRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">transformerUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">secretaryUrlRaw</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryUrlRaw</span><span class="si">}</span><span class="sb">transformer/template`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryUrlRaw</span><span class="si">}</span><span class="sb">/transformer/template`</span><span class="p">;</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">                </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">stripped</span><span class="p">);</span>
<span class="w">                </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">                </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;template_content&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">templateContent</span><span class="p">);</span>
<span class="w">                </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;use_cache&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Kontext für LLM-Auswertung (Dateiname/Pfad/IDs)</span>
<span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// z.B. /Berichte Landesämter/Bevölk.Schutz</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dirPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Berichte Landesämter/Bevölk.Schutz</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rawName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">expectedName</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">file</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.md&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">withoutExt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rawName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^./\\]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">withoutExt</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="sb">`\\.</span><span class="si">${</span><span class="nx">targetLanguage</span><span class="si">}</span><span class="sb">$`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;i&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="kt">baseName</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">filepath</span><span class="o">:</span><span class="w"> </span><span class="kt">dirPath</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">parentId</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ctx</span><span class="p">));</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">transformerUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdMeta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">structured_data?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">structured_data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{};</span>

<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendMeta</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">mdMeta</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;template_transform&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>

<span class="w">                </span><span class="c1">// Markdown mit neuem Frontmatter überschreiben</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">newMarkdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span>
<span class="w">                  </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">stripped</span><span class="p">,</span><span class="w"> </span><span class="nx">mdMeta</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span>
<span class="w">                  </span><span class="o">:</span><span class="w"> </span><span class="nx">originalMarkdown</span><span class="p">;</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">outFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">newMarkdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">expectedName</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">file</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output.md&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">startedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">outFile</span><span class="p">);</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>

<span class="w">                </span><span class="c1">// Ingestion je nach Flag nur markieren (kein Upsert hier)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">doIngestRAG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen (template-only)&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed (template-only)&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;local-template-only&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">main_processor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">started</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">is_from_cache</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">webhook</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">delivered_to</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="c1">// Fallback: wenn Template-Only fehlschlägt, markieren wir die Schritte als skipped und schließen</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">doIngestRAG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;local-skip&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">main_processor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">started</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">is_from_cache</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">webhook</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">delivered_to</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Kein Template‑Only gewünscht → alle übrigen Schritte überspringen</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">doIngestRAG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen (extract skipped: artifact_exists)&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed (skipped extract)&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">              </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">process</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;local-skip&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">main_processor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">started</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">is_from_cache</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">              </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">              </span><span class="nx">webhook</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">delivered_to</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span>
<span class="w">              </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="c1">// Anfrage an den Secretary Service senden (nur wenn doExtractPDF true oder keine Flags gesetzt)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">doExtractPDF</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">doIngestRAG</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Kein Worker-Call notwendig, die Arbeit passiert lokal (Template‑Only) oder es ist nur Ingestion geplant (aktueller Pfad löst Ingestion erst im Callback aus, daher schließen wir hier ab)</span>
<span class="w">      </span><span class="c1">// Falls nur Ingestion geplant ist, führt der Callback es später aus; hier markieren wir extract als skipped</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;not_requested&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AbortController</span><span class="p">();</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">timeoutMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_REQUEST_TIMEOUT_MS</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;5000&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">controller</span><span class="p">.</span><span class="nx">abort</span><span class="p">(),</span><span class="w"> </span><span class="nx">timeoutMs</span><span class="p">);</span>
<span class="w">      </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">normalizedUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">serviceFormData</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">h</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">h</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="nx">h</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">h</span><span class="p">;</span>
<span class="w">      </span><span class="p">})(),</span>
<span class="w">        </span><span class="nx">signal</span><span class="o">:</span><span class="w"> </span><span class="kt">controller.signal</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Secretary nicht erreichbar → Job synchron auf failed setzen</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="w"> </span><span class="p">});</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Secretary Service nicht erreichbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">503</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// HTTP-Response als JSON loggen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">httpResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Object.fromEntries</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">entries</span><span class="p">()),</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;[RESPONSE_BODY]&#39;</span><span class="w"> </span><span class="c1">// Wird nach dem Parsen geloggt</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Secretary HTTP-Response&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">httpResponse</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_ack&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Secretary Response Body&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">responseBody</span><span class="o">:</span><span class="w"> </span><span class="kt">data</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Secretary Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`worker_error </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="w"> </span><span class="p">});</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">data?.error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Fehler beim Transformieren der PDF-Datei&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Rückgabe beibehaltend (kompatibel) und JobId hinzufügen</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Request akzeptiert, gebe Job zurück&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Fehler bei der Verbindung zum Secretary Service&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="c1">// Batch-Submit: Erwartet JSON mit items[] (each: { fileId, parentId, name, mimeType }) und optionalen Optionen/Batch-Metadaten</span>
<span class="c1">// Server lädt Binärdaten per Server-Storage, reicht an die bestehende process-pdf Route weiter.</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchItemInput</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mimeType?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">options</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">targetLanguage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">extractionMethod?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">includeImages?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">useCache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">template?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doExtractMetadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doIngestRAG?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">forceRecreate?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">[];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Content-Type application/json erwartet&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">415</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">items</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">batchName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body.batchName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;libraryId und items erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Serverseitige Parallelität begrenzen (z. B. 5)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Worker-Funktion: reiche einzelne Datei weiter an process-pdf</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">it</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Hole Datei-Binärdaten via interner API, um Code-Duplizierung zu vermeiden</span>
<span class="w">        </span><span class="c1">// Wir nutzen die bestehende Client-Route, indem wir eine FormData bauen und lokal requesten</span>
<span class="w">        </span><span class="c1">// Vorteil: die gesamte Job-Anlage/Idempotenz bleibt an einem Ort</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Holen der Datei aus dem Storage muss in der Zielroute passieren; hier nur Metadaten weitergeben</span>
<span class="w">        </span><span class="c1">// Aber unsere bestehende process-pdf Route erwartet die Datei bereits. Daher rufen wir sie nicht direkt hier,</span>
<span class="w">        </span><span class="c1">// sondern nutzen einen vereinfachten Pfad: Der Client übergibt im Normalfall Binärdaten.</span>
<span class="w">        </span><span class="c1">// Für serverseitige Batch-Einreichung wählen wir den robusteren Weg: lade die Datei serverseitig und reiche mit.</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">template</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractMetadata&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doIngestRAG&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;forceRecreate&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/api/secretary/process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;X-Library-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">));</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">job</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="nx">.job.id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Einfache Concurrency-Queue</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">worker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.min</span><span class="p">(</span><span class="nx">concurrency</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">worker</span><span class="p">());</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">workers</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">okCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="o">?</span><span class="p">.</span><span class="nx">ok</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">failCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">okCount</span><span class="p">;</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf-batch&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Batch abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">items.length</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Ich werde jetzt die Repository-Filter, die GET-Liste um Filter, den Retry-Endpoint, den Dialog für Batch-Submit und die JobMonitorPanel-Filter/UI anpassen. Danach prüfe ich Linter-Fehler.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Collection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;mongodb&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getCollection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/mongodb-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStep</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobIngestionInfo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">collectionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;external_jobs&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">getCollection</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Collection</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">getCollection</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collectionName</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">secret</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">create</span><span class="p">(</span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="kt">Omit</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;createdAt&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;updatedAt&#39;</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">job</span><span class="p">,</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">extra</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...</span><span class="nx">extra</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">modifiedCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">processId</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$push</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">logs</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...</span><span class="nx">entry</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">payload</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">mergeParameters</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$mergeObjects</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;$parameters&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">initializeSteps</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">steps</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStep</span><span class="p">[],</span><span class="w"> </span><span class="nx">parameters?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">steps</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...(</span><span class="nx">parameters</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">parameters</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">patch</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">ExternalJobStep</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">setObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">patch</span><span class="p">).</span><span class="nx">map</span><span class="p">(([</span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">([</span><span class="sb">`steps.$.</span><span class="si">${</span><span class="nx">k</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">])));</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;steps.name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">setObj</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">appendMeta</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">$push</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metaHistory</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">at</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Merge cumulativeMeta (shallow)</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cumulativeMeta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$mergeObjects</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;$cumulativeMeta&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setIngestion</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">info</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobIngestionInfo</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ingestion</span><span class="o">:</span><span class="w"> </span><span class="kt">info</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listByUserEmail</span><span class="p">(</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[];</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">20</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">col</span>
<span class="w">      </span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">skip</span><span class="p">((</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">      </span><span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">col</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listByUserWithFilters</span><span class="p">(</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">      </span><span class="nx">limit?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">      </span><span class="nx">status?</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="p">[];</span>
<span class="w">      </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">batchId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">libraryId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">q?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[];</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">20</span><span class="p">));</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filter</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;libraryId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">batchId</span><span class="p">)</span><span class="w"> </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;correlation.batchId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">batchId</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;correlation.batchName&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">batchName</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">statuses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="p">];</span>
<span class="w">      </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$in</span><span class="o">:</span><span class="w"> </span><span class="kt">statuses</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[.*+?^${}()|[\]\\]/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;\\$&amp;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;i&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;$or&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;correlation.source.name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">rx</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;correlation.source.itemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">rx</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">rx</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">col</span>
<span class="w">      </span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">skip</span><span class="p">((</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">      </span><span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">col</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
<span class="w">    </span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestBySourceItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;correlation.source.itemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="w"> </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestByResultItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">resultItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;result.savedItemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">resultItemId</span><span class="w"> </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestByFileIdAuto</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">$or</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;correlation.source.itemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;result.savedItemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestBySourceName</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;correlation.source.name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">sourceName</span><span class="w"> </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">***</span><span class="w"> </span><span class="nx">Begin</span><span class="w"> </span><span class="nx">Patch</span>
<span class="o">***</span><span class="w"> </span><span class="nx">Update</span><span class="w"> </span><span class="nx">File</span><span class="o">:</span><span class="w"> </span><span class="kt">src</span><span class="o">/</span><span class="nx">app</span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">external</span><span class="o">/</span><span class="nx">jobs</span><span class="o">/</span><span class="nx">route</span><span class="p">.</span><span class="nx">ts</span>
<span class="err">@@</span>
<span class="o">-</span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="o">-</span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="o">-</span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="o">-</span><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>
<span class="o">+</span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="o">+</span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="o">+</span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="o">+</span><span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>
<span class="err">@@</span>
<span class="o">-</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="o">-</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="o">+</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="o">+</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="err">@@</span>
<span class="o">-</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">curPage</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">curLimit</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">;</span>
<span class="o">+</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">statusParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">);</span>
<span class="o">+</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="o">+</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="o">+</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="o">+</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">statuses</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="p">[]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">statusParam</span>
<span class="o">+</span><span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">statusParam</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">trim</span><span class="p">()).</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="p">[])</span>
<span class="o">+</span><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">curPage</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">curLimit</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">listByUserWithFilters</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">      </span><span class="nx">page</span><span class="p">,</span>
<span class="o">+</span><span class="w">      </span><span class="nx">limit</span><span class="p">,</span>
<span class="o">+</span><span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">statuses</span><span class="p">,</span>
<span class="o">+</span><span class="w">      </span><span class="nx">batchName</span><span class="p">,</span>
<span class="o">+</span><span class="w">      </span><span class="nx">batchId</span><span class="p">,</span>
<span class="o">+</span><span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="o">+</span><span class="w">      </span><span class="nx">q</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span>
<span class="o">+</span><span class="w">    </span><span class="p">});</span>
<span class="err">@@</span>
<span class="o">-</span><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="o">-</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">   </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>
<span class="o">***</span><span class="w"> </span><span class="nx">End</span><span class="w"> </span><span class="nx">Patch</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;20&#39;</span><span class="p">)));</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bySourceItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;bySourceItemId&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">byResultItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;byResultItemId&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;libraryId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">bySourceItemId</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">findLatestBySourceItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">bySourceItemId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="nx">job</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">byResultItemId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">findLatestByResultItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">byResultItemId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="nx">job</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bySourceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;bySourceName&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">bySourceName</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">findLatestBySourceName</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">bySourceName</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="nx">job</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">statusParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">statuses</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="p">[]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">statusParam</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">statusParam</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">trim</span><span class="p">()).</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="p">[])</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">curPage</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">curLimit</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">listByUserWithFilters</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">page</span><span class="p">,</span>
<span class="w">      </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">statuses</span><span class="p">,</span>
<span class="w">      </span><span class="nx">batchName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">batchId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">q</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">mapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">j</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">[</span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">j.jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">j.status</span><span class="p">,</span>
<span class="w">        </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">j.operation</span><span class="p">,</span>
<span class="w">        </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">j.worker</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">j.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">j.correlation?.source?.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">j.updatedAt</span><span class="p">,</span>
<span class="w">        </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">j.createdAt</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lastMessage</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">last</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">last.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lastProgress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">last</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">last.progress</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">curPage</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">curLimit</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">mapped</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nur fehlgeschlagene Jobs können neu gestartet werden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Erzeuge neuen Job mit gleicher Korrelation/Optionen</span>
<span class="w">    </span><span class="c1">// Wir verwenden die bestehende process-pdf Route; Datei binär laden und erneut einreichen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quelle für Retry unvollständig&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">batchName</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/api/secretary/process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;X-Library-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;jobs-retry&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Retry fehlgeschlagen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">res.status</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Fehler beim erneuten Einreichen&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">res.status</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>*** Begin Patch
*** Update File: src/components/shared/job-monitor-panel.tsx
@@
-export function JobMonitorPanel() {
+export function JobMonitorPanel() {
@@
-  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
+  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
+  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
+  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
@@
-    async function load(pageNum: number, replace: boolean) {
+    async function load(pageNum: number, replace: boolean) {
       try {
         isFetchingRef.current = true;
-        const res = await fetch(`/api/external/jobs?page=${pageNum}&amp;limit=20`, { cache: &#39;no-store&#39; });
+        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
+        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
+        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
+        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
@@
-  const refreshNow = async () =&gt; {
+  const refreshNow = async () =&gt; {
@@
-    try {
-      const res = await fetch(`/api/external/jobs?page=1&amp;limit=20`, { cache: &#39;no-store&#39; });
+    try {
+      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
+      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
+      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
+      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
@@
-  };
+  };
@@
-          &lt;div className=&quot;flex items-center justify-between p-3 border-b&quot;&gt;
+          &lt;div className=&quot;flex items-center justify-between p-3 border-b&quot;&gt;
             &lt;div className=&quot;text-sm font-medium&quot;&gt;Verarbeitung&lt;/div&gt;
             &lt;div className=&quot;flex items-center gap-2&quot;&gt;
               &lt;Button variant=&quot;outline&quot; size=&quot;sm&quot; onClick={refreshNow} disabled={isRefreshing}&gt;{isRefreshing ? &#39;Aktualisiere…&#39; : &#39;Aktualisieren&#39;}&lt;/Button&gt;
-              &lt;Button variant=&quot;ghost&quot; size=&quot;icon&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
+              &lt;Button variant=&quot;ghost&quot; size=&quot;icon&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
             &lt;/div&gt;
           &lt;/div&gt;
+          &lt;div className=&quot;p-3 flex items-center gap-2 border-b&quot;&gt;
+            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
+              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
+              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
+              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
+              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
+              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
+            &lt;/select&gt;
+            &lt;input className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; placeholder=&quot;Batch-Name filtern&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)} /&gt;
+          &lt;/div&gt;
*** End Patch
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job → vorne einfügen
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, upsertJobStatus]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling als sanfter Fallback (nur wenn Panel offen): alle 1000ms
  useEffect(() =&gt; {
    if (!isOpen) return;
    const timer = setInterval(() =&gt; { void refreshNow(); }, 1000);
    return () =&gt; clearInterval(timer);
  }, [isOpen]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;input className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; placeholder=&quot;Batch-Name filtern&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)} /&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import { useCallback, useEffect, useMemo, useState } from &#39;react&#39;;
import { useAtomValue } from &#39;jotai&#39;;
import { activeLibraryIdAtom, currentFolderIdAtom } from &#39;@/atoms/library-atom&#39;;
import { useStorage } from &#39;@/contexts/storage-context&#39;;
import { StorageItem } from &#39;@/lib/storage/types&#39;;
import { Button } from &#39;@/components/ui/button&#39;;
import { Checkbox } from &#39;@/components/ui/checkbox&#39;;
import { Label } from &#39;@/components/ui/label&#39;;
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from &#39;@/components/ui/dialog&#39;;
import { ScrollArea } from &#39;@/components/ui/scroll-area&#39;;
import { Separator } from &#39;@/components/ui/separator&#39;;
import { FileLogger } from &#39;@/lib/debug/logger&#39;;
import { toast } from &#39;@/components/ui/use-toast&#39;;
import { loadPdfDefaults } from &#39;@/lib/pdf-defaults&#39;;
import { pdfOverridesAtom, getEffectivePdfDefaults } from &#39;@/atoms/pdf-defaults&#39;;
import { PdfPhaseSettings } from &#39;@/components/library/pdf-phase-settings&#39;;
import { Settings } from &#39;lucide-react&#39;;

interface PdfBulkImportDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) =&gt; void;
}

interface ScanStats {
  totalPdfs: number;
  skippedExisting: number;
  toProcess: number;
}

export function PdfBulkImportDialog({ open, onOpenChange }: PdfBulkImportDialogProps) {
  const { provider } = useStorage();
  const rootFolderId = useAtomValue(currentFolderIdAtom);
  const activeLibraryId = useAtomValue(activeLibraryIdAtom);
  const pdfOverrides = useAtomValue(pdfOverridesAtom);

  const [settingsOpen, setSettingsOpen] = useState(false);
  const [isScanning, setIsScanning] = useState(false);
  const [isEnqueuing, setIsEnqueuing] = useState(false);
  const [candidates, setCandidates] = useState&lt;Array&lt;{ file: StorageItem; parentId: string }&gt;&gt;([]);
  const [previewItems, setPreviewItems] = useState&lt;Array&lt;{ id: string; name: string; relPath: string; pages?: number }&gt;&gt;([]);
  const [stats, setStats] = useState&lt;ScanStats&gt;({ totalPdfs: 0, skippedExisting: 0, toProcess: 0 });
  const [batchName, setBatchName] = useState&lt;string&gt;(&#39;&#39;);

  // Phasensteuerung: Standard nur Phase 1 (Extraktion)
  const [runMetaPhase, setRunMetaPhase] = useState&lt;boolean&gt;(false); // Phase 2
  const [runIngestionPhase, setRunIngestionPhase] = useState&lt;boolean&gt;(false); // Phase 3

  // Shadow-Twin Erkennung (z. B. name.de.md)
  const shadowTwinRegex = useMemo(() =&gt; /^(.+)\.(de|en|fr|es|it)\.md$/i, []);

  const getBaseName = useCallback((name: string): string =&gt; {
    const lastDot = name.lastIndexOf(&#39;.&#39;);
    return lastDot === -1 ? name : name.substring(0, lastDot);
  }, []);

  const hasTwinInFolder = useCallback(
    (siblings: StorageItem[], pdfBase: string, lang?: string): boolean =&gt; {
      if (lang) {
        const expected = `${pdfBase}.${lang}.md`;
        return siblings.some((i) =&gt; i.type === &#39;file&#39; &amp;&amp; i.metadata.name.toLowerCase() === expected.toLowerCase());
      }
      // Fallback: irgendein Twin in beliebiger Sprache
      return siblings.some((i) =&gt; i.type === &#39;file&#39; &amp;&amp; shadowTwinRegex.test(i.metadata.name));
    },
    [shadowTwinRegex]
  );

  // rekursiver Scan
  const scanFolder = useCallback(async (folderId: string) =&gt; {
    if (!provider) return { total: 0, skipped: 0, selected: [] as Array&lt;{ file: StorageItem; parentId: string }&gt;, previews: [] as string[] };

    const stack: string[] = [folderId];
    let total = 0;
    let skipped = 0;
    const selected: Array&lt;{ file: StorageItem; parentId: string }&gt; = [];
    const previews: string[] = [];

    while (stack.length) {
      const current = stack.pop() as string;
      let items: StorageItem[] = [];
      try {
        items = await provider.listItemsById(current);
      } catch (error) {
        FileLogger.error(&#39;PdfBulkImportDialog&#39;, &#39;Fehler beim Listen eines Ordners&#39;, { folderId: current, error });
        continue;
      }

      const folders = items.filter((i) =&gt; i.type === &#39;folder&#39;);
      folders.forEach((f) =&gt; stack.push(f.id));

      const files = items.filter((i) =&gt; i.type === &#39;file&#39;);
      for (const file of files) {
        const name = file.metadata.name.toLowerCase();
        const isPdf = name.endsWith(&#39;.pdf&#39;) || file.metadata.mimeType?.toLowerCase() === &#39;application/pdf&#39;;
        if (!isPdf) continue;
        total++;

        const base = getBaseName(file.metadata.name);
        const defaults = activeLibraryId ? loadPdfDefaults(activeLibraryId) : {};
        const lang = (defaults as { targetLanguage?: string }).targetLanguage || &#39;de&#39;;
        // Batch-Scan soll auch bei Phase 1+2 ohne vorhandenen Twin zulassen → kein Twin-Zwang hier
        const requireTwin = false;
        if (requireTwin &amp;&amp; !hasTwinInFolder(items, base, lang)) {
          skipped++;
          continue;
        }
        selected.push({ file, parentId: current });
        if (previews.length &lt; 10) previews.push(file.metadata.name);
      }
    }

    return { total, skipped, selected, previews };
  }, [provider, getBaseName, hasTwinInFolder, runMetaPhase, runIngestionPhase]);

  const handleScan = useCallback(async () =&gt; {
    if (!provider || !rootFolderId) return;
    setIsScanning(true);
    setCandidates([]);
    setPreviewItems([]);
    try {
      const result = await scanFolder(rootFolderId);
      setCandidates(result.selected);
      // Vorschau-Details (max. 10) berechnen: relativer Pfad + Dateiname
      const top = result.selected.slice(0, 10);
      const details: Array&lt;{ id: string; name: string; relPath: string; pages?: number }&gt; = [];
      for (const { file, parentId } of top) {
        let relPath = &#39;.&#39;;
        try {
          const chain = await provider.getPathItemsById(parentId);
          const idx = chain.findIndex((it) =&gt; it.id === rootFolderId);
          const start = idx &gt;= 0 ? idx + 1 : 1; // nach aktuellem Root bzw. nach globalem Root
          const parts = chain.slice(start).map((it) =&gt; it.metadata.name).filter(Boolean);
          relPath = parts.length ? parts.join(&#39;/&#39;) : &#39;.&#39;;
        } catch {
          relPath = &#39;.&#39;;
        }
        details.push({ id: file.id, name: file.metadata.name, relPath });
      }
      setPreviewItems(details);
      setStats({ totalPdfs: result.total, skippedExisting: result.skipped, toProcess: result.selected.length });
    } finally {
      setIsScanning(false);
    }
  }, [provider, rootFolderId, scanFolder]);

  useEffect(() =&gt; {
    if (open) {
      // Bei Öffnen initial Scannen
      void handleScan();
    }
  }, [open, handleScan]);

  // keine lokale Optionsbearbeitung nötig; Änderungen erfolgen im Settings-Dialog

  const handleEnqueue = useCallback(async () =&gt; {
    if (!activeLibraryId) return;
    if (candidates.length === 0) return;
    setIsEnqueuing(true);
    try {
      const defaults = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
      const payload = {
        libraryId: activeLibraryId,
        batchName: (batchName || &#39;&#39;).trim() || undefined,
        options: {
          targetLanguage: typeof defaults.targetLanguage === &#39;string&#39; ? defaults.targetLanguage : &#39;de&#39;,
          extractionMethod: typeof defaults.extractionMethod === &#39;string&#39; ? defaults.extractionMethod : &#39;native&#39;,
          includeImages: defaults.includeImages ?? false,
          useCache: defaults.useCache ?? true,
          template: typeof defaults.template === &#39;string&#39; ? defaults.template : undefined,
          doExtractMetadata: !!runMetaPhase,
          doIngestRAG: !!runIngestionPhase,
        },
        items: candidates.map(({ file, parentId }) =&gt; ({ fileId: file.id, parentId, name: file.metadata.name, mimeType: file.metadata.mimeType })),
      };
      const res = await fetch(&#39;/api/secretary/process-pdf/batch&#39;, {
        method: &#39;POST&#39;,
        headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const msg = await res.text().catch(() =&gt; res.statusText);
        toast({ title: &#39;Batch fehlgeschlagen&#39;, description: msg, variant: &#39;destructive&#39; });
      } else {
        const json = await res.json().catch(() =&gt; ({} as Record&lt;string, unknown&gt;));
        const okCount = Number((json as { okCount?: number }).okCount || 0);
        const failCount = Number((json as { failCount?: number }).failCount || 0);
        toast({ title: &#39;Batch gestartet&#39;, description: `Gestartet: ${okCount}, fehlgeschlagen: ${failCount}` });
        onOpenChange(false);
      }
    } finally {
      setIsEnqueuing(false);
    }
  }, [activeLibraryId, candidates, runMetaPhase, runIngestionPhase, onOpenChange, pdfOverrides, provider]);

  return (
    &lt;Dialog open={open} onOpenChange={onOpenChange}&gt;
      &lt;DialogContent className=&quot;max-w-3xl&quot;&gt;
        &lt;DialogHeader&gt;
          &lt;DialogTitle className=&quot;flex items-center justify-between&quot;&gt;
            &lt;span&gt;PDF-Verzeichnis verarbeiten&lt;/span&gt;
            &lt;Button variant=&quot;ghost&quot; size=&quot;icon&quot; onClick={() =&gt; setSettingsOpen(true)} title=&quot;PDF-Standardwerte öffnen&quot;&gt;
              &lt;Settings className=&quot;h-4 w-4&quot; /&gt;
            &lt;/Button&gt;
          &lt;/DialogTitle&gt;
          &lt;DialogDescription&gt;
            Verwendet die PDF-Standardwerte der aktiven Library. Parameter können über das Zahnrad angepasst werden.
          &lt;/DialogDescription&gt;
        &lt;/DialogHeader&gt;

        &lt;div className=&quot;space-y-4&quot;&gt;
          {/* Hinweisblock entfernt: Idempotenz/Gates übernehmen das Überspringen automatisch */}

          &lt;div className=&quot;rounded-md border p-3&quot;&gt;
            &lt;div className=&quot;text-sm font-medium mb-2&quot;&gt;Phasen&lt;/div&gt;
            &lt;div className=&quot;flex flex-col gap-2 text-sm&quot;&gt;
              &lt;div className=&quot;flex items-center gap-2 text-muted-foreground&quot;&gt;
                &lt;Checkbox id=&quot;phase-1&quot; checked disabled /&gt;
                &lt;Label htmlFor=&quot;phase-1&quot;&gt;Phase 1: Extraktion (Methode: 
                  &lt;span&gt;
                    {(() =&gt; {
                      const eff = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
                      return eff.extractionMethod;
                    })()})
                  &lt;/span&gt;
                &lt;/Label&gt;
              &lt;/div&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;Checkbox id=&quot;phase-2&quot; checked={runMetaPhase} onCheckedChange={(v) =&gt; setRunMetaPhase(Boolean(v))} /&gt;
                &lt;Label htmlFor=&quot;phase-2&quot;&gt;Phase 2: Metadaten (Template: 
                  &lt;span&gt;                    
                    {(() =&gt; {
                      const eff = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
                      return eff.template;
                    })()}
                  )
                  &lt;/span&gt;
                &lt;/Label&gt;
              &lt;/div&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;Checkbox id=&quot;phase-3&quot; checked={runIngestionPhase} onCheckedChange={(v) =&gt; setRunIngestionPhase(Boolean(v))} /&gt;
                &lt;Label htmlFor=&quot;phase-3&quot;&gt;Phase 3: RAG-Ingestion&lt;/Label&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;

          {/* PDF-Standardwerte werden aus der Library geladen; Anpassung über das Zahnrad oben */}

          &lt;div className=&quot;rounded-md border p-3&quot;&gt;
            &lt;div className=&quot;mb-2&quot;&gt;
              &lt;Label htmlFor=&quot;batch-name&quot;&gt;Batch-Name&lt;/Label&gt;
              &lt;input id=&quot;batch-name&quot; className=&quot;mt-1 w-full border rounded px-2 py-1 text-sm&quot; placeholder=&quot;z.B. Ordnername&quot; value={batchName} onChange={(e) =&gt; setBatchName(e.target.value)} /&gt;
            &lt;/div&gt;
            &lt;div className=&quot;flex items-center justify-between text-sm&quot;&gt;
              &lt;div className=&quot;flex gap-4&quot;&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Gesamt PDFs:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.totalPdfs}&lt;/span&gt;
                &lt;/div&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Ignoriert:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.skippedExisting}&lt;/span&gt;
                &lt;/div&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Zu verarbeiten:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.toProcess}&lt;/span&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;Button variant=&quot;outline&quot; size=&quot;sm&quot; onClick={handleScan} disabled={isScanning}&gt;
                {isScanning ? &#39;Scan läuft…&#39; : &#39;Neu scannen&#39;}
              &lt;/Button&gt;
            &lt;/div&gt;
            &lt;Separator className=&quot;my-3&quot; /&gt;
            &lt;ScrollArea className=&quot;h-40&quot;&gt;
              {previewItems.length === 0 ? (
                &lt;div className=&quot;text-sm text-muted-foreground&quot;&gt;Keine Kandidaten gefunden.&lt;/div&gt;
              ) : (
                &lt;ul className=&quot;text-sm space-y-2&quot;&gt;
                  {previewItems.map((it) =&gt; (
                    &lt;li key={it.id} className=&quot;flex items-start justify-between gap-3&quot;&gt;
                      &lt;div className=&quot;min-w-0&quot;&gt;
                        &lt;div className=&quot;text-muted-foreground truncate&quot;&gt;{it.relPath}&lt;/div&gt;
                        &lt;div className=&quot;font-medium break-all&quot;&gt;{it.name}&lt;/div&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;shrink-0 text-muted-foreground whitespace-nowrap&quot;&gt;Seiten: —&lt;/div&gt;
                    &lt;/li&gt;
                  ))}
                &lt;/ul&gt;
              )}
            &lt;/ScrollArea&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        &lt;DialogFooter&gt;
          &lt;Button variant=&quot;outline&quot; onClick={() =&gt; onOpenChange(false)} disabled={isEnqueuing || isScanning}&gt;Abbrechen&lt;/Button&gt;
          &lt;Button onClick={handleEnqueue} disabled={isEnqueuing || isScanning || candidates.length === 0}&gt;
            {isEnqueuing ? &#39;Wird gestartet…&#39; : `Jobs starten (${candidates.length})`}
          &lt;/Button&gt;
        &lt;/DialogFooter&gt;
        &lt;PdfPhaseSettings open={settingsOpen} onOpenChange={setSettingsOpen} /&gt;
      &lt;/DialogContent&gt;
    &lt;/Dialog&gt;
  );
}

export default PdfBulkImportDialog;
</code></pre></div>
<p>Ich habe gerade die Batch-Felder ergänzt, eine serverseitige Batch-Route mit Parallelität 5 gebaut, Filter in Repository/GET-Route ergänzt, den Dialog auf Batch-Submit umgestellt, und einen Retry-Endpoint erstellt. Jetzt erweitere ich das Job-Monitor-Panel um Retry-Button pro fehlgeschlagenem Job und Zähler im Header und aktualisiere die Filterleiste.</p>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job → vorne einfügen
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, upsertJobStatus]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling als sanfter Fallback (nur wenn Panel offen): alle 1000ms
  useEffect(() =&gt; {
    if (!isOpen) return;
    const timer = setInterval(() =&gt; { void refreshNow(); }, 1000);
    return () =&gt; clearInterval(timer);
  }, [isOpen]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;input className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; placeholder=&quot;Batch-Name filtern&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)} /&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {item.status === &#39;failed&#39; &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Kurz-Update: Ich habe die serverseitige Batch-Einreichung mit Parallelität 5 implementiert, den Dialog auf Batch-Submit umgestellt, Batch-Tagging (batchName) eingeführt, die Jobliste um Filter erweitert und Retry für fehlgeschlagene Jobs ergänzt. Als Nächstes empfehlen sich Tests mit einem größeren Ordner.</p>
<p>Umsetzung:
- Frontend-Dialog
  - <code>src/components/library/pdf-bulk-import-dialog.tsx</code>: Statt sequenzieller Einzel-Requests wird jetzt ein JSON-Batch an <code>POST /api/secretary/process-pdf/batch</code> geschickt. Optionaler <code>batchName</code> (z. B. Verzeichnisname) wird mitgesendet und in den Jobs gespeichert. Phasen-Flags und PDF-Defaults werden übernommen. Abschluss-Toast zeigt eine kurze Zusammenfassung.
- Backend Batch-Route
  - <code>src/app/api/secretary/process-pdf/batch/route.ts</code>: Nimmt <code>libraryId</code>, <code>batchName</code>, <code>options</code>, <code>items[]</code> entgegen. Lädt pro Item die Datei serverseitig über <code>getServerProvider</code>, ruft intern <code>POST /api/secretary/process-pdf</code> auf und limitiert die Parallelität auf 5. Gibt ok/fail-Zähler zurück.
- Job-Korrelation
  - <code>src/types/external-job.ts</code>: <code>ExternalJobCorrelation</code> um <code>batchName</code> ergänzt. <code>batchId</code> ist bereits vorhanden.
  - <code>src/app/api/secretary/process-pdf/route.ts</code>: Persistiert <code>batchName</code>/<code>batchId</code> aus dem Request in <code>correlation</code>.
- Jobliste/Filter/Retry
  - <code>src/lib/external-jobs-repository.ts</code>: Neue <code>listByUserWithFilters(...)</code> mit Filtern <code>status</code>, <code>batchName</code>, <code>batchId</code>, <code>libraryId</code>, <code>q</code>.
  - <code>src/app/api/external/jobs/route.ts</code>: Nutzt die Filter-Variante; akzeptiert Query-Parameter <code>status</code>, <code>batchName</code>, <code>batchId</code>, <code>q</code>.
  - <code>src/components/shared/job-monitor-panel.tsx</code>: Filterleiste (Statusauswahl, Batch-Name), Zähler (Q/R/C/F) im Header, Retry-Button bei failed, nutzt gefilterte API-Aufrufe.
  - <code>src/app/api/external/jobs/[jobId]/retry/route.ts</code>: Reicht fehlgeschlagene Jobs neu ein (lädt Datei serverseitig und ruft wieder <code>process-pdf</code>).</p>
<p>Antwort auf deine Anforderungen:
- Jobs werden im Frontend gesammelt und als Batch eingereicht. Serverseitig werden maximal 5 parallel gestartet (Secretary hat eigene Parallelität).
- Job-Übersicht zeigt Status, erlaubt Filter nach Status und Batch-Name. Zähler oben geben Überblick.
- Fehlgeschlagene Jobs können einzeln neu gestartet werden.
- Batch-Gruppierung: Nutze im Dialog den Verzeichnisnamen als <code>batchName</code>; in der Übersicht nach <code>batchName</code> filtern.</p>
<p>Tests (manuell, minimal):
- 1) 30–50 PDFs in einem Ordner auswählen, <code>batchName</code> setzen, Einreichen. Erwartet: Dialog schließt zügig, Jobs erscheinen; in der Übersicht Filter auf <code>batchName</code> setzen; Status- und Zähler-Updates laufen via SSE; am Ende ok/fail-Kurzmeldung.
- 2) <code>status=failed</code> filtern; einen Job via Retry neu starten; der neue Job erscheint und läuft durch.
- 3) Performance: UI bleibt responsiv; keine Toast-Flut.</p>
<p>Hinweis zu Auth/Secrets: Die Secretary-Aufrufe laufen weiterhin über unsere API-Route mit Service-Key-Headern, wie gefordert [[memory:6998386]].</p>
<p>Zusammenfassung der Änderungen und Wirkung:
- Neue Batch-Route mit Parallelität 5 und serverseitigem Datei-Laden; reduziert UI-Blockaden und Netz-Overhead.
- <code>batchName</code> wird pro Job gespeichert; Filter in <code>GET /api/external/jobs</code> erweitert.
- Dialog nutzt Batch-Submit; Übersicht zeigt Filter (Status/Batch), Zähler, und Retry.
- Keine Linter-Fehler.</p>
<p>Wenn du magst, testen wir gemeinsam mit einem großen Ordner und justieren Concurrency oder UI-Feinschliff (z. B. Persistenz der Filter).</p>
<hr />
<p><strong>User</strong></p>
<p>ok, wie kann ich das jetzt testen?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>So testest du die Änderung Schritt für Schritt:</p>
<ul>
<li>App starten</li>
<li>Terminal im Projekt:
    <div class="highlight"><pre><span></span><code><span class="n">pnpm</span> <span class="n">install</span>
<span class="n">pnpm</span> <span class="n">dev</span>
</code></pre></div></li>
<li>
<p>Prüfe, dass <code>SECRETARY_SERVICE_URL</code>, <code>SECRETARY_SERVICE_API_KEY</code>, <code>NEXT_PUBLIC_APP_URL</code> und Clerk lokal gesetzt sind.</p>
</li>
<li>
<p>Batch im UI einreichen</p>
</li>
<li>In die Library navigieren und einen Ordner mit vielen PDFs wählen.</li>
<li>Dialog „PDF-Verzeichnis verarbeiten“ öffnen.</li>
<li>Oben „Batch-Name“ setzen (empfohlen: Ordnername).</li>
<li>Phasen wählen (z. B. Metadaten/RAG optional).</li>
<li>„Jobs starten (N)“ klicken.</li>
<li>
<p>Erwartung: Schnell ein „Batch gestartet“-Toast. UI friert nicht.</p>
</li>
<li>
<p>Fortschritt überwachen</p>
</li>
<li>Rechts oben den Job-Monitor öffnen (schmaler Handle „≡“).</li>
<li>In der Filterleiste:<ul>
<li>Status wählen (Alle/Queued/Running/Completed/Failed).</li>
<li>Batch-Name eintragen (dein gesetzter Name).</li>
<li>„Filtern“ bzw. „Aktualisieren“ klicken.</li>
</ul>
</li>
<li>
<p>Oben siehst du Zähler: Q/R/C/F. Diese steigen/fallen live (SSE).</p>
</li>
<li>
<p>Retry testen</p>
</li>
<li>Falls ein Job auf „Failed“ steht, im Listeneintrag den runden „Neu starten“-Button anklicken.</li>
<li>
<p>Erwartung: Neuer Job wird angelegt, erscheint in der Liste und läuft.</p>
</li>
<li>
<p>Optional: gezielte Checks</p>
</li>
<li>Große Batches (z. B. 30–100 PDFs) einreichen. Es sollten maximal 5 gleichzeitig serverseitig laufen (Batch-Route limitiert). Du siehst kontinuierlichen Fortschritt in der Liste.</li>
<li>
<p>Nach Abschluss sollten in deinem Zielordner Shadow-Twins/Artefakte sichtbar sein (je nach Phasen).</p>
</li>
<li>
<p>Fehlerfall simulieren (optional)</p>
</li>
<li>Für einen einzelnen Testjob <code>SECRETARY_SERVICE_URL</code> kurz ungültig setzen, einen Job einreichen → sollte „Failed“ werden.</li>
<li>URL zurücksetzen, im Monitor bei diesem Job „Neu starten“.</li>
</ul>
<p>Akzeptanzkriterien
- UI bleibt beim Einreichen reaktionsfähig.
- Job-Monitor zeigt live Status, Zähler und lässt nach Batch-Name filtern.
- Fehlgeschlagene Jobs lassen sich per Button neu starten.
- Bei großen Batches gibt es stetige Verarbeitung; keine Toast-Flut.</p>
<p>Wenn du willst, kann ich gemeinsam mit dir einen Testlauf mit einem konkreten Ordner machen und die Batch-/Filterfunktion live verifizieren.</p>
<div class="highlight"><pre><span></span><code>    <span class="n">pnpm</span> <span class="n">install</span>
    <span class="n">pnpm</span> <span class="n">dev</span>
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>ok, der Ordnername (relativer Pfad des aktuellen library) sollte schon gefüllt sein.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich setze jetzt den Batch-Name beim Öffnen des Dialogs automatisch auf den relativen Pfad des aktuell ausgewählten Ordners.</p>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import { useCallback, useEffect, useMemo, useState } from &#39;react&#39;;
import { useAtomValue } from &#39;jotai&#39;;
import { activeLibraryIdAtom, currentFolderIdAtom } from &#39;@/atoms/library-atom&#39;;
import { useStorage } from &#39;@/contexts/storage-context&#39;;
import { StorageItem } from &#39;@/lib/storage/types&#39;;
import { Button } from &#39;@/components/ui/button&#39;;
import { Checkbox } from &#39;@/components/ui/checkbox&#39;;
import { Label } from &#39;@/components/ui/label&#39;;
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from &#39;@/components/ui/dialog&#39;;
import { ScrollArea } from &#39;@/components/ui/scroll-area&#39;;
import { Separator } from &#39;@/components/ui/separator&#39;;
import { FileLogger } from &#39;@/lib/debug/logger&#39;;
import { toast } from &#39;@/components/ui/use-toast&#39;;
import { loadPdfDefaults } from &#39;@/lib/pdf-defaults&#39;;
import { pdfOverridesAtom, getEffectivePdfDefaults } from &#39;@/atoms/pdf-defaults&#39;;
import { PdfPhaseSettings } from &#39;@/components/library/pdf-phase-settings&#39;;
import { Settings } from &#39;lucide-react&#39;;

interface PdfBulkImportDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) =&gt; void;
}

interface ScanStats {
  totalPdfs: number;
  skippedExisting: number;
  toProcess: number;
}

export function PdfBulkImportDialog({ open, onOpenChange }: PdfBulkImportDialogProps) {
  const { provider } = useStorage();
  const rootFolderId = useAtomValue(currentFolderIdAtom);
  const activeLibraryId = useAtomValue(activeLibraryIdAtom);
  const pdfOverrides = useAtomValue(pdfOverridesAtom);

  const [settingsOpen, setSettingsOpen] = useState(false);
  const [isScanning, setIsScanning] = useState(false);
  const [isEnqueuing, setIsEnqueuing] = useState(false);
  const [candidates, setCandidates] = useState&lt;Array&lt;{ file: StorageItem; parentId: string }&gt;&gt;([]);
  const [previewItems, setPreviewItems] = useState&lt;Array&lt;{ id: string; name: string; relPath: string; pages?: number }&gt;&gt;([]);
  const [stats, setStats] = useState&lt;ScanStats&gt;({ totalPdfs: 0, skippedExisting: 0, toProcess: 0 });
  const [batchName, setBatchName] = useState&lt;string&gt;(&#39;&#39;);

  // Phasensteuerung: Standard nur Phase 1 (Extraktion)
  const [runMetaPhase, setRunMetaPhase] = useState&lt;boolean&gt;(false); // Phase 2
  const [runIngestionPhase, setRunIngestionPhase] = useState&lt;boolean&gt;(false); // Phase 3

  // Shadow-Twin Erkennung (z. B. name.de.md)
  const shadowTwinRegex = useMemo(() =&gt; /^(.+)\.(de|en|fr|es|it)\.md$/i, []);

  const getBaseName = useCallback((name: string): string =&gt; {
    const lastDot = name.lastIndexOf(&#39;.&#39;);
    return lastDot === -1 ? name : name.substring(0, lastDot);
  }, []);

  const hasTwinInFolder = useCallback(
    (siblings: StorageItem[], pdfBase: string, lang?: string): boolean =&gt; {
      if (lang) {
        const expected = `${pdfBase}.${lang}.md`;
        return siblings.some((i) =&gt; i.type === &#39;file&#39; &amp;&amp; i.metadata.name.toLowerCase() === expected.toLowerCase());
      }
      // Fallback: irgendein Twin in beliebiger Sprache
      return siblings.some((i) =&gt; i.type === &#39;file&#39; &amp;&amp; shadowTwinRegex.test(i.metadata.name));
    },
    [shadowTwinRegex]
  );

  // rekursiver Scan
  const scanFolder = useCallback(async (folderId: string) =&gt; {
    if (!provider) return { total: 0, skipped: 0, selected: [] as Array&lt;{ file: StorageItem; parentId: string }&gt;, previews: [] as string[] };

    const stack: string[] = [folderId];
    let total = 0;
    let skipped = 0;
    const selected: Array&lt;{ file: StorageItem; parentId: string }&gt; = [];
    const previews: string[] = [];

    while (stack.length) {
      const current = stack.pop() as string;
      let items: StorageItem[] = [];
      try {
        items = await provider.listItemsById(current);
      } catch (error) {
        FileLogger.error(&#39;PdfBulkImportDialog&#39;, &#39;Fehler beim Listen eines Ordners&#39;, { folderId: current, error });
        continue;
      }

      const folders = items.filter((i) =&gt; i.type === &#39;folder&#39;);
      folders.forEach((f) =&gt; stack.push(f.id));

      const files = items.filter((i) =&gt; i.type === &#39;file&#39;);
      for (const file of files) {
        const name = file.metadata.name.toLowerCase();
        const isPdf = name.endsWith(&#39;.pdf&#39;) || file.metadata.mimeType?.toLowerCase() === &#39;application/pdf&#39;;
        if (!isPdf) continue;
        total++;

        const base = getBaseName(file.metadata.name);
        const defaults = activeLibraryId ? loadPdfDefaults(activeLibraryId) : {};
        const lang = (defaults as { targetLanguage?: string }).targetLanguage || &#39;de&#39;;
        // Batch-Scan soll auch bei Phase 1+2 ohne vorhandenen Twin zulassen → kein Twin-Zwang hier
        const requireTwin = false;
        if (requireTwin &amp;&amp; !hasTwinInFolder(items, base, lang)) {
          skipped++;
          continue;
        }
        selected.push({ file, parentId: current });
        if (previews.length &lt; 10) previews.push(file.metadata.name);
      }
    }

    return { total, skipped, selected, previews };
  }, [provider, getBaseName, hasTwinInFolder, runMetaPhase, runIngestionPhase]);

  const handleScan = useCallback(async () =&gt; {
    if (!provider || !rootFolderId) return;
    setIsScanning(true);
    setCandidates([]);
    setPreviewItems([]);
    try {
      const result = await scanFolder(rootFolderId);
      setCandidates(result.selected);
      // Vorschau-Details (max. 10) berechnen: relativer Pfad + Dateiname
      const top = result.selected.slice(0, 10);
      const details: Array&lt;{ id: string; name: string; relPath: string; pages?: number }&gt; = [];
      for (const { file, parentId } of top) {
        let relPath = &#39;.&#39;;
        try {
          const chain = await provider.getPathItemsById(parentId);
          const idx = chain.findIndex((it) =&gt; it.id === rootFolderId);
          const start = idx &gt;= 0 ? idx + 1 : 1; // nach aktuellem Root bzw. nach globalem Root
          const parts = chain.slice(start).map((it) =&gt; it.metadata.name).filter(Boolean);
          relPath = parts.length ? parts.join(&#39;/&#39;) : &#39;.&#39;;
        } catch {
          relPath = &#39;.&#39;;
        }
        details.push({ id: file.id, name: file.metadata.name, relPath });
      }
      setPreviewItems(details);
      setStats({ totalPdfs: result.total, skippedExisting: result.skipped, toProcess: result.selected.length });
    } finally {
      setIsScanning(false);
    }
  }, [provider, rootFolderId, scanFolder]);

  useEffect(() =&gt; {
    if (open) {
      // Bei Öffnen initial Scannen
      void handleScan();
      // Batch-Name vorbelegen: relativer Pfad des aktuellen Ordners (ohne führenden &#39;/&#39;)
      (async () =&gt; {
        try {
          if (!provider || !rootFolderId) return;
          const fullPath = await provider.getPathById(rootFolderId);
          const rel = (fullPath || &#39;&#39;).replace(/^\//, &#39;&#39;) || &#39;root&#39;;
          setBatchName((prev) =&gt; prev &amp;&amp; prev.trim().length &gt; 0 ? prev : rel);
        } catch {
          // ignorieren
        }
      })();
    }
  }, [open, handleScan]);

  // keine lokale Optionsbearbeitung nötig; Änderungen erfolgen im Settings-Dialog

  const handleEnqueue = useCallback(async () =&gt; {
    if (!activeLibraryId) return;
    if (candidates.length === 0) return;
    setIsEnqueuing(true);
    try {
      const defaults = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
      const payload = {
        libraryId: activeLibraryId,
        batchName: (batchName || &#39;&#39;).trim() || undefined,
        options: {
          targetLanguage: typeof defaults.targetLanguage === &#39;string&#39; ? defaults.targetLanguage : &#39;de&#39;,
          extractionMethod: typeof defaults.extractionMethod === &#39;string&#39; ? defaults.extractionMethod : &#39;native&#39;,
          includeImages: defaults.includeImages ?? false,
          useCache: defaults.useCache ?? true,
          template: typeof defaults.template === &#39;string&#39; ? defaults.template : undefined,
          doExtractMetadata: !!runMetaPhase,
          doIngestRAG: !!runIngestionPhase,
        },
        items: candidates.map(({ file, parentId }) =&gt; ({ fileId: file.id, parentId, name: file.metadata.name, mimeType: file.metadata.mimeType })),
      };
      const res = await fetch(&#39;/api/secretary/process-pdf/batch&#39;, {
        method: &#39;POST&#39;,
        headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const msg = await res.text().catch(() =&gt; res.statusText);
        toast({ title: &#39;Batch fehlgeschlagen&#39;, description: msg, variant: &#39;destructive&#39; });
      } else {
        const json = await res.json().catch(() =&gt; ({} as Record&lt;string, unknown&gt;));
        const okCount = Number((json as { okCount?: number }).okCount || 0);
        const failCount = Number((json as { failCount?: number }).failCount || 0);
        toast({ title: &#39;Batch gestartet&#39;, description: `Gestartet: ${okCount}, fehlgeschlagen: ${failCount}` });
        onOpenChange(false);
      }
    } finally {
      setIsEnqueuing(false);
    }
  }, [activeLibraryId, candidates, runMetaPhase, runIngestionPhase, onOpenChange, pdfOverrides, provider]);

  return (
    &lt;Dialog open={open} onOpenChange={onOpenChange}&gt;
      &lt;DialogContent className=&quot;max-w-3xl&quot;&gt;
        &lt;DialogHeader&gt;
          &lt;DialogTitle className=&quot;flex items-center justify-between&quot;&gt;
            &lt;span&gt;PDF-Verzeichnis verarbeiten&lt;/span&gt;
            &lt;Button variant=&quot;ghost&quot; size=&quot;icon&quot; onClick={() =&gt; setSettingsOpen(true)} title=&quot;PDF-Standardwerte öffnen&quot;&gt;
              &lt;Settings className=&quot;h-4 w-4&quot; /&gt;
            &lt;/Button&gt;
          &lt;/DialogTitle&gt;
          &lt;DialogDescription&gt;
            Verwendet die PDF-Standardwerte der aktiven Library. Parameter können über das Zahnrad angepasst werden.
          &lt;/DialogDescription&gt;
        &lt;/DialogHeader&gt;

        &lt;div className=&quot;space-y-4&quot;&gt;
          {/* Hinweisblock entfernt: Idempotenz/Gates übernehmen das Überspringen automatisch */}

          &lt;div className=&quot;rounded-md border p-3&quot;&gt;
            &lt;div className=&quot;text-sm font-medium mb-2&quot;&gt;Phasen&lt;/div&gt;
            &lt;div className=&quot;flex flex-col gap-2 text-sm&quot;&gt;
              &lt;div className=&quot;flex items-center gap-2 text-muted-foreground&quot;&gt;
                &lt;Checkbox id=&quot;phase-1&quot; checked disabled /&gt;
                &lt;Label htmlFor=&quot;phase-1&quot;&gt;Phase 1: Extraktion (Methode: 
                  &lt;span&gt;
                    {(() =&gt; {
                      const eff = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
                      return eff.extractionMethod;
                    })()})
                  &lt;/span&gt;
                &lt;/Label&gt;
              &lt;/div&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;Checkbox id=&quot;phase-2&quot; checked={runMetaPhase} onCheckedChange={(v) =&gt; setRunMetaPhase(Boolean(v))} /&gt;
                &lt;Label htmlFor=&quot;phase-2&quot;&gt;Phase 2: Metadaten (Template: 
                  &lt;span&gt;                    
                    {(() =&gt; {
                      const eff = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
                      return eff.template;
                    })()}
                  )
                  &lt;/span&gt;
                &lt;/Label&gt;
              &lt;/div&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;Checkbox id=&quot;phase-3&quot; checked={runIngestionPhase} onCheckedChange={(v) =&gt; setRunIngestionPhase(Boolean(v))} /&gt;
                &lt;Label htmlFor=&quot;phase-3&quot;&gt;Phase 3: RAG-Ingestion&lt;/Label&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;

          {/* PDF-Standardwerte werden aus der Library geladen; Anpassung über das Zahnrad oben */}

          &lt;div className=&quot;rounded-md border p-3&quot;&gt;
            &lt;div className=&quot;mb-2&quot;&gt;
              &lt;Label htmlFor=&quot;batch-name&quot;&gt;Batch-Name&lt;/Label&gt;
              &lt;input id=&quot;batch-name&quot; className=&quot;mt-1 w-full border rounded px-2 py-1 text-sm&quot; placeholder=&quot;z.B. Ordnername&quot; value={batchName} onChange={(e) =&gt; setBatchName(e.target.value)} /&gt;
            &lt;/div&gt;
            &lt;div className=&quot;flex items-center justify-between text-sm&quot;&gt;
              &lt;div className=&quot;flex gap-4&quot;&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Gesamt PDFs:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.totalPdfs}&lt;/span&gt;
                &lt;/div&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Ignoriert:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.skippedExisting}&lt;/span&gt;
                &lt;/div&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Zu verarbeiten:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.toProcess}&lt;/span&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;Button variant=&quot;outline&quot; size=&quot;sm&quot; onClick={handleScan} disabled={isScanning}&gt;
                {isScanning ? &#39;Scan läuft…&#39; : &#39;Neu scannen&#39;}
              &lt;/Button&gt;
            &lt;/div&gt;
            &lt;Separator className=&quot;my-3&quot; /&gt;
            &lt;ScrollArea className=&quot;h-40&quot;&gt;
              {previewItems.length === 0 ? (
                &lt;div className=&quot;text-sm text-muted-foreground&quot;&gt;Keine Kandidaten gefunden.&lt;/div&gt;
              ) : (
                &lt;ul className=&quot;text-sm space-y-2&quot;&gt;
                  {previewItems.map((it) =&gt; (
                    &lt;li key={it.id} className=&quot;flex items-start justify-between gap-3&quot;&gt;
                      &lt;div className=&quot;min-w-0&quot;&gt;
                        &lt;div className=&quot;text-muted-foreground truncate&quot;&gt;{it.relPath}&lt;/div&gt;
                        &lt;div className=&quot;font-medium break-all&quot;&gt;{it.name}&lt;/div&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;shrink-0 text-muted-foreground whitespace-nowrap&quot;&gt;Seiten: —&lt;/div&gt;
                    &lt;/li&gt;
                  ))}
                &lt;/ul&gt;
              )}
            &lt;/ScrollArea&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        &lt;DialogFooter&gt;
          &lt;Button variant=&quot;outline&quot; onClick={() =&gt; onOpenChange(false)} disabled={isEnqueuing || isScanning}&gt;Abbrechen&lt;/Button&gt;
          &lt;Button onClick={handleEnqueue} disabled={isEnqueuing || isScanning || candidates.length === 0}&gt;
            {isEnqueuing ? &#39;Wird gestartet…&#39; : `Jobs starten (${candidates.length})`}
          &lt;/Button&gt;
        &lt;/DialogFooter&gt;
        &lt;PdfPhaseSettings open={settingsOpen} onOpenChange={setSettingsOpen} /&gt;
      &lt;/DialogContent&gt;
    &lt;/Dialog&gt;
  );
}

export default PdfBulkImportDialog;
</code></pre></div>
<p>Erledigt: Beim Öffnen des Dialogs wird <code>batchName</code> jetzt automatisch auf den relativen Pfad des aktuell gewählten Ordners gesetzt (Fallback <code>root</code>). Du kannst ihn weiterhin überschreiben.</p>
<ul>
<li>Quelle: <code>provider.getPathById(rootFolderId)</code> → führenden Slash entfernt.</li>
<li>Verhalten: Wenn bereits ein eigener Wert eingetippt wurde, wird er nicht überschrieben.</li>
</ul>
<p>Kurztest:
- Ordner wählen, Dialog öffnen → Feld „Batch-Name“ ist vorbelegt mit dem Ordnerpfad.
- Direkt „Jobs starten“ klicken; in der Jobliste mit diesem Batch-Namen filtern.</p>
<hr />
<p><strong>User</strong></p>
<p>In der Jobliste möchte ich, wo steht Badgename filtern, möchte ich gerne einen Dropdown, das aus der Datenbank die verfügbaren Badgenamen abfragt und nicht ein freies Texteingabefeld.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich lade jetzt die verfügbaren Batch-Namen aus der Datenbank per neuer API-Route und ersetze im Job-Monitor das freie Texteingabefeld durch ein Dropdown. Danach teste ich kurz die Filterfunktion.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Collection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;mongodb&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getCollection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/mongodb-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStep</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobIngestionInfo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">collectionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;external_jobs&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">getCollection</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Collection</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">getCollection</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collectionName</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">secret</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">create</span><span class="p">(</span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="kt">Omit</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;createdAt&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;updatedAt&#39;</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">job</span><span class="p">,</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">extra</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...</span><span class="nx">extra</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">modifiedCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">processId</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$push</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">logs</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...</span><span class="nx">entry</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">payload</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">mergeParameters</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$mergeObjects</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;$parameters&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">initializeSteps</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">steps</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStep</span><span class="p">[],</span><span class="w"> </span><span class="nx">parameters?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">steps</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...(</span><span class="nx">parameters</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">parameters</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">patch</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">ExternalJobStep</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">setObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">patch</span><span class="p">).</span><span class="nx">map</span><span class="p">(([</span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">([</span><span class="sb">`steps.$.</span><span class="si">${</span><span class="nx">k</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">])));</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;steps.name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">setObj</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">appendMeta</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">$push</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metaHistory</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">at</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Merge cumulativeMeta (shallow)</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cumulativeMeta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$mergeObjects</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;$cumulativeMeta&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setIngestion</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">info</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobIngestionInfo</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ingestion</span><span class="o">:</span><span class="w"> </span><span class="kt">info</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listByUserEmail</span><span class="p">(</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[];</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">20</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">col</span>
<span class="w">      </span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">skip</span><span class="p">((</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">      </span><span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">col</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listByUserWithFilters</span><span class="p">(</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">      </span><span class="nx">limit?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">      </span><span class="nx">status?</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="p">[];</span>
<span class="w">      </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">batchId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">libraryId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">q?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[];</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">20</span><span class="p">));</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filter</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;libraryId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">batchId</span><span class="p">)</span><span class="w"> </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;correlation.batchId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">batchId</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;correlation.batchName&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">batchName</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">statuses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="p">];</span>
<span class="w">      </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$in</span><span class="o">:</span><span class="w"> </span><span class="kt">statuses</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[.*+?^${}()|[\]\\]/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;\\$&amp;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;i&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;$or&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;correlation.source.name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">rx</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;correlation.source.itemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">rx</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">rx</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">col</span>
<span class="w">      </span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">skip</span><span class="p">((</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">      </span><span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">col</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
<span class="w">    </span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestBySourceItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;correlation.source.itemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="w"> </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestByResultItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">resultItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;result.savedItemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">resultItemId</span><span class="w"> </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestByFileIdAuto</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">$or</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;correlation.source.itemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;result.savedItemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestBySourceName</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;correlation.source.name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">sourceName</span><span class="w"> </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listDistinctBatchNames</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;correlation.batchName&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">$ne</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="nx">match</span><span class="p">[</span><span class="s1">&#39;libraryId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">aggregate</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="p">([</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$match</span><span class="o">:</span><span class="w"> </span><span class="kt">match</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$correlation.batchName&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$sort</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">]).</span><span class="nx">toArray</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">filter</span><span class="p">((</span><span class="nx">v</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;libraryId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">listDistinctBatchNames</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">names</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job → vorne einfügen
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, upsertJobStatus]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling als sanfter Fallback (nur wenn Panel offen): alle 1000ms
  useEffect(() =&gt; {
    if (!isOpen) return;
    const timer = setInterval(() =&gt; { void refreshNow(); }, 1000);
    return () =&gt; clearInterval(timer);
  }, [isOpen]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {item.status === &#39;failed&#39; &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Erledigt: Der „Batch-Name filtern“-Eingabefeld ist jetzt ein Dropdown, das die vorhandenen Batch-Namen aus der DB lädt.</p>
<p>Was ich geändert habe:
- Neue API: <code>GET /api/external/jobs/batches</code> liefert <code>items: string[]</code> der distinct <code>batchName</code>-Werte des Users (optional mit <code>?libraryId=...</code>).
- Repo: <code>listDistinctBatchNames(userEmail, libraryId?)</code> aggregiert die vorhandenen Batches.
- UI: <code>JobMonitorPanel</code> ersetzt das freie Textfeld durch ein <code>select</code>. Beim Öffnen lädt es die Liste und zeigt „Alle Batches“ + Optionen. Auswahl triggert den Filter.</p>
<p>Test:
- Job-Monitor öffnen (≡).
- Dropdown „Alle Batches“ öffnen → verfügbare Batch-Namen sollten erscheinen.
- Einen Batch auswählen, „Filtern“ → Liste zeigt nur diesen Batch.</p>
<p>Wenn du zusätzlich nach Library filtern möchtest, kann ich den API-Call im Panel um <code>libraryId</code> erweitern.</p>
<hr />
<p><strong>User</strong></p>
<p>Ich bin in dem Verzeichnis: temp/test/commoning</p>
<p>Ich öffne "PDF-Verzeichnis verarbeiten" -&gt; Batchname wird nicht aktualisert: temp/test</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich passe die Batch-Name-Initialisierung so an, dass der aktuelle Ordnername mit einbezogen wird, indem ich den Pfad aus den Pfad-Items zusammensetze. Danach prüfe ich kurz die Linter.</p>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import { useCallback, useEffect, useMemo, useState } from &#39;react&#39;;
import { useAtomValue } from &#39;jotai&#39;;
import { activeLibraryIdAtom, currentFolderIdAtom } from &#39;@/atoms/library-atom&#39;;
import { useStorage } from &#39;@/contexts/storage-context&#39;;
import { StorageItem } from &#39;@/lib/storage/types&#39;;
import { Button } from &#39;@/components/ui/button&#39;;
import { Checkbox } from &#39;@/components/ui/checkbox&#39;;
import { Label } from &#39;@/components/ui/label&#39;;
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from &#39;@/components/ui/dialog&#39;;
import { ScrollArea } from &#39;@/components/ui/scroll-area&#39;;
import { Separator } from &#39;@/components/ui/separator&#39;;
import { FileLogger } from &#39;@/lib/debug/logger&#39;;
import { toast } from &#39;@/components/ui/use-toast&#39;;
import { loadPdfDefaults } from &#39;@/lib/pdf-defaults&#39;;
import { pdfOverridesAtom, getEffectivePdfDefaults } from &#39;@/atoms/pdf-defaults&#39;;
import { PdfPhaseSettings } from &#39;@/components/library/pdf-phase-settings&#39;;
import { Settings } from &#39;lucide-react&#39;;

interface PdfBulkImportDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) =&gt; void;
}

interface ScanStats {
  totalPdfs: number;
  skippedExisting: number;
  toProcess: number;
}

export function PdfBulkImportDialog({ open, onOpenChange }: PdfBulkImportDialogProps) {
  const { provider } = useStorage();
  const rootFolderId = useAtomValue(currentFolderIdAtom);
  const activeLibraryId = useAtomValue(activeLibraryIdAtom);
  const pdfOverrides = useAtomValue(pdfOverridesAtom);

  const [settingsOpen, setSettingsOpen] = useState(false);
  const [isScanning, setIsScanning] = useState(false);
  const [isEnqueuing, setIsEnqueuing] = useState(false);
  const [candidates, setCandidates] = useState&lt;Array&lt;{ file: StorageItem; parentId: string }&gt;&gt;([]);
  const [previewItems, setPreviewItems] = useState&lt;Array&lt;{ id: string; name: string; relPath: string; pages?: number }&gt;&gt;([]);
  const [stats, setStats] = useState&lt;ScanStats&gt;({ totalPdfs: 0, skippedExisting: 0, toProcess: 0 });
  const [batchName, setBatchName] = useState&lt;string&gt;(&#39;&#39;);

  // Phasensteuerung: Standard nur Phase 1 (Extraktion)
  const [runMetaPhase, setRunMetaPhase] = useState&lt;boolean&gt;(false); // Phase 2
  const [runIngestionPhase, setRunIngestionPhase] = useState&lt;boolean&gt;(false); // Phase 3

  // Shadow-Twin Erkennung (z. B. name.de.md)
  const shadowTwinRegex = useMemo(() =&gt; /^(.+)\.(de|en|fr|es|it)\.md$/i, []);

  const getBaseName = useCallback((name: string): string =&gt; {
    const lastDot = name.lastIndexOf(&#39;.&#39;);
    return lastDot === -1 ? name : name.substring(0, lastDot);
  }, []);

  const hasTwinInFolder = useCallback(
    (siblings: StorageItem[], pdfBase: string, lang?: string): boolean =&gt; {
      if (lang) {
        const expected = `${pdfBase}.${lang}.md`;
        return siblings.some((i) =&gt; i.type === &#39;file&#39; &amp;&amp; i.metadata.name.toLowerCase() === expected.toLowerCase());
      }
      // Fallback: irgendein Twin in beliebiger Sprache
      return siblings.some((i) =&gt; i.type === &#39;file&#39; &amp;&amp; shadowTwinRegex.test(i.metadata.name));
    },
    [shadowTwinRegex]
  );

  // rekursiver Scan
  const scanFolder = useCallback(async (folderId: string) =&gt; {
    if (!provider) return { total: 0, skipped: 0, selected: [] as Array&lt;{ file: StorageItem; parentId: string }&gt;, previews: [] as string[] };

    const stack: string[] = [folderId];
    let total = 0;
    let skipped = 0;
    const selected: Array&lt;{ file: StorageItem; parentId: string }&gt; = [];
    const previews: string[] = [];

    while (stack.length) {
      const current = stack.pop() as string;
      let items: StorageItem[] = [];
      try {
        items = await provider.listItemsById(current);
      } catch (error) {
        FileLogger.error(&#39;PdfBulkImportDialog&#39;, &#39;Fehler beim Listen eines Ordners&#39;, { folderId: current, error });
        continue;
      }

      const folders = items.filter((i) =&gt; i.type === &#39;folder&#39;);
      folders.forEach((f) =&gt; stack.push(f.id));

      const files = items.filter((i) =&gt; i.type === &#39;file&#39;);
      for (const file of files) {
        const name = file.metadata.name.toLowerCase();
        const isPdf = name.endsWith(&#39;.pdf&#39;) || file.metadata.mimeType?.toLowerCase() === &#39;application/pdf&#39;;
        if (!isPdf) continue;
        total++;

        const base = getBaseName(file.metadata.name);
        const defaults = activeLibraryId ? loadPdfDefaults(activeLibraryId) : {};
        const lang = (defaults as { targetLanguage?: string }).targetLanguage || &#39;de&#39;;
        // Batch-Scan soll auch bei Phase 1+2 ohne vorhandenen Twin zulassen → kein Twin-Zwang hier
        const requireTwin = false;
        if (requireTwin &amp;&amp; !hasTwinInFolder(items, base, lang)) {
          skipped++;
          continue;
        }
        selected.push({ file, parentId: current });
        if (previews.length &lt; 10) previews.push(file.metadata.name);
      }
    }

    return { total, skipped, selected, previews };
  }, [provider, getBaseName, hasTwinInFolder, runMetaPhase, runIngestionPhase]);

  const handleScan = useCallback(async () =&gt; {
    if (!provider || !rootFolderId) return;
    setIsScanning(true);
    setCandidates([]);
    setPreviewItems([]);
    try {
      const result = await scanFolder(rootFolderId);
      setCandidates(result.selected);
      // Vorschau-Details (max. 10) berechnen: relativer Pfad + Dateiname
      const top = result.selected.slice(0, 10);
      const details: Array&lt;{ id: string; name: string; relPath: string; pages?: number }&gt; = [];
      for (const { file, parentId } of top) {
        let relPath = &#39;.&#39;;
        try {
          const chain = await provider.getPathItemsById(parentId);
          const idx = chain.findIndex((it) =&gt; it.id === rootFolderId);
          const start = idx &gt;= 0 ? idx + 1 : 1; // nach aktuellem Root bzw. nach globalem Root
          const parts = chain.slice(start).map((it) =&gt; it.metadata.name).filter(Boolean);
          relPath = parts.length ? parts.join(&#39;/&#39;) : &#39;.&#39;;
        } catch {
          relPath = &#39;.&#39;;
        }
        details.push({ id: file.id, name: file.metadata.name, relPath });
      }
      setPreviewItems(details);
      setStats({ totalPdfs: result.total, skippedExisting: result.skipped, toProcess: result.selected.length });
    } finally {
      setIsScanning(false);
    }
  }, [provider, rootFolderId, scanFolder]);

  useEffect(() =&gt; {
    if (open) {
      // Bei Öffnen initial Scannen
      void handleScan();
      // Batch-Name vorbelegen: relativer Pfad des aktuellen Ordners (ohne führenden &#39;/&#39;)
      (async () =&gt; {
        try {
          if (!provider || !rootFolderId) return;
          // Inklusive aktuellem Ordnernamen
          const chain = await provider.getPathItemsById(rootFolderId);
          const parts = chain
            .filter((it) =&gt; it.id !== &#39;root&#39;)
            .map((it) =&gt; (it as { metadata?: { name?: string } }).metadata?.name)
            .filter((n): n is string =&gt; typeof n === &#39;string&#39; &amp;&amp; !!n);
          const rel = parts.join(&#39;/&#39;) || &#39;root&#39;;
          setBatchName((prev) =&gt; prev &amp;&amp; prev.trim().length &gt; 0 ? prev : rel);
        } catch {
          // ignorieren
        }
      })();
    }
  }, [open, handleScan]);

  // keine lokale Optionsbearbeitung nötig; Änderungen erfolgen im Settings-Dialog

  const handleEnqueue = useCallback(async () =&gt; {
    if (!activeLibraryId) return;
    if (candidates.length === 0) return;
    setIsEnqueuing(true);
    try {
      const defaults = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
      const payload = {
        libraryId: activeLibraryId,
        batchName: (batchName || &#39;&#39;).trim() || undefined,
        options: {
          targetLanguage: typeof defaults.targetLanguage === &#39;string&#39; ? defaults.targetLanguage : &#39;de&#39;,
          extractionMethod: typeof defaults.extractionMethod === &#39;string&#39; ? defaults.extractionMethod : &#39;native&#39;,
          includeImages: defaults.includeImages ?? false,
          useCache: defaults.useCache ?? true,
          template: typeof defaults.template === &#39;string&#39; ? defaults.template : undefined,
          doExtractMetadata: !!runMetaPhase,
          doIngestRAG: !!runIngestionPhase,
        },
        items: candidates.map(({ file, parentId }) =&gt; ({ fileId: file.id, parentId, name: file.metadata.name, mimeType: file.metadata.mimeType })),
      };
      const res = await fetch(&#39;/api/secretary/process-pdf/batch&#39;, {
        method: &#39;POST&#39;,
        headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const msg = await res.text().catch(() =&gt; res.statusText);
        toast({ title: &#39;Batch fehlgeschlagen&#39;, description: msg, variant: &#39;destructive&#39; });
      } else {
        const json = await res.json().catch(() =&gt; ({} as Record&lt;string, unknown&gt;));
        const okCount = Number((json as { okCount?: number }).okCount || 0);
        const failCount = Number((json as { failCount?: number }).failCount || 0);
        toast({ title: &#39;Batch gestartet&#39;, description: `Gestartet: ${okCount}, fehlgeschlagen: ${failCount}` });
        onOpenChange(false);
      }
    } finally {
      setIsEnqueuing(false);
    }
  }, [activeLibraryId, candidates, runMetaPhase, runIngestionPhase, onOpenChange, pdfOverrides, provider]);

  return (
    &lt;Dialog open={open} onOpenChange={onOpenChange}&gt;
      &lt;DialogContent className=&quot;max-w-3xl&quot;&gt;
        &lt;DialogHeader&gt;
          &lt;DialogTitle className=&quot;flex items-center justify-between&quot;&gt;
            &lt;span&gt;PDF-Verzeichnis verarbeiten&lt;/span&gt;
            &lt;Button variant=&quot;ghost&quot; size=&quot;icon&quot; onClick={() =&gt; setSettingsOpen(true)} title=&quot;PDF-Standardwerte öffnen&quot;&gt;
              &lt;Settings className=&quot;h-4 w-4&quot; /&gt;
            &lt;/Button&gt;
          &lt;/DialogTitle&gt;
          &lt;DialogDescription&gt;
            Verwendet die PDF-Standardwerte der aktiven Library. Parameter können über das Zahnrad angepasst werden.
          &lt;/DialogDescription&gt;
        &lt;/DialogHeader&gt;

        &lt;div className=&quot;space-y-4&quot;&gt;
          {/* Hinweisblock entfernt: Idempotenz/Gates übernehmen das Überspringen automatisch */}

          &lt;div className=&quot;rounded-md border p-3&quot;&gt;
            &lt;div className=&quot;text-sm font-medium mb-2&quot;&gt;Phasen&lt;/div&gt;
            &lt;div className=&quot;flex flex-col gap-2 text-sm&quot;&gt;
              &lt;div className=&quot;flex items-center gap-2 text-muted-foreground&quot;&gt;
                &lt;Checkbox id=&quot;phase-1&quot; checked disabled /&gt;
                &lt;Label htmlFor=&quot;phase-1&quot;&gt;Phase 1: Extraktion (Methode: 
                  &lt;span&gt;
                    {(() =&gt; {
                      const eff = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
                      return eff.extractionMethod;
                    })()})
                  &lt;/span&gt;
                &lt;/Label&gt;
              &lt;/div&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;Checkbox id=&quot;phase-2&quot; checked={runMetaPhase} onCheckedChange={(v) =&gt; setRunMetaPhase(Boolean(v))} /&gt;
                &lt;Label htmlFor=&quot;phase-2&quot;&gt;Phase 2: Metadaten (Template: 
                  &lt;span&gt;                    
                    {(() =&gt; {
                      const eff = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
                      return eff.template;
                    })()}
                  )
                  &lt;/span&gt;
                &lt;/Label&gt;
              &lt;/div&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;Checkbox id=&quot;phase-3&quot; checked={runIngestionPhase} onCheckedChange={(v) =&gt; setRunIngestionPhase(Boolean(v))} /&gt;
                &lt;Label htmlFor=&quot;phase-3&quot;&gt;Phase 3: RAG-Ingestion&lt;/Label&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;

          {/* PDF-Standardwerte werden aus der Library geladen; Anpassung über das Zahnrad oben */}

          &lt;div className=&quot;rounded-md border p-3&quot;&gt;
            &lt;div className=&quot;mb-2&quot;&gt;
              &lt;Label htmlFor=&quot;batch-name&quot;&gt;Batch-Name&lt;/Label&gt;
              &lt;input id=&quot;batch-name&quot; className=&quot;mt-1 w-full border rounded px-2 py-1 text-sm&quot; placeholder=&quot;z.B. Ordnername&quot; value={batchName} onChange={(e) =&gt; setBatchName(e.target.value)} /&gt;
            &lt;/div&gt;
            &lt;div className=&quot;flex items-center justify-between text-sm&quot;&gt;
              &lt;div className=&quot;flex gap-4&quot;&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Gesamt PDFs:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.totalPdfs}&lt;/span&gt;
                &lt;/div&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Ignoriert:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.skippedExisting}&lt;/span&gt;
                &lt;/div&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Zu verarbeiten:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.toProcess}&lt;/span&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;Button variant=&quot;outline&quot; size=&quot;sm&quot; onClick={handleScan} disabled={isScanning}&gt;
                {isScanning ? &#39;Scan läuft…&#39; : &#39;Neu scannen&#39;}
              &lt;/Button&gt;
            &lt;/div&gt;
            &lt;Separator className=&quot;my-3&quot; /&gt;
            &lt;ScrollArea className=&quot;h-40&quot;&gt;
              {previewItems.length === 0 ? (
                &lt;div className=&quot;text-sm text-muted-foreground&quot;&gt;Keine Kandidaten gefunden.&lt;/div&gt;
              ) : (
                &lt;ul className=&quot;text-sm space-y-2&quot;&gt;
                  {previewItems.map((it) =&gt; (
                    &lt;li key={it.id} className=&quot;flex items-start justify-between gap-3&quot;&gt;
                      &lt;div className=&quot;min-w-0&quot;&gt;
                        &lt;div className=&quot;text-muted-foreground truncate&quot;&gt;{it.relPath}&lt;/div&gt;
                        &lt;div className=&quot;font-medium break-all&quot;&gt;{it.name}&lt;/div&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;shrink-0 text-muted-foreground whitespace-nowrap&quot;&gt;Seiten: —&lt;/div&gt;
                    &lt;/li&gt;
                  ))}
                &lt;/ul&gt;
              )}
            &lt;/ScrollArea&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        &lt;DialogFooter&gt;
          &lt;Button variant=&quot;outline&quot; onClick={() =&gt; onOpenChange(false)} disabled={isEnqueuing || isScanning}&gt;Abbrechen&lt;/Button&gt;
          &lt;Button onClick={handleEnqueue} disabled={isEnqueuing || isScanning || candidates.length === 0}&gt;
            {isEnqueuing ? &#39;Wird gestartet…&#39; : `Jobs starten (${candidates.length})`}
          &lt;/Button&gt;
        &lt;/DialogFooter&gt;
        &lt;PdfPhaseSettings open={settingsOpen} onOpenChange={setSettingsOpen} /&gt;
      &lt;/DialogContent&gt;
    &lt;/Dialog&gt;
  );
}

export default PdfBulkImportDialog;
</code></pre></div>
<p>Jetzt wird der Batch-Name aus der gesamten Pfadkette zusammengesetzt, inkl. aktuellem Ordner.</p>
<ul>
<li>Vorher: nur <code>getPathById</code>-String (konnte am Root enden).</li>
<li>Neu: <code>getPathItemsById(rootFolderId)</code> → alle Ordnerteile außer <code>root</code> zu <code>temp/test/commoning</code> kombiniert.</li>
<li>Falls du bereits manuell einen Wert eingetragen hast, wird er nicht überschrieben.</li>
</ul>
<p>Bitte Dialog erneut öffnen in <code>temp/test/commoning</code>. Erwartet: Batch-Name = <code>temp/test/commoning</code>.</p>
<hr />
<p><strong>User</strong></p>
<p>Jetzt getestet, es öffnet sich dieser Dialog mit dem korrekten Badge. Aber wenn ich jetzt die Badge starte, Job starten klicke, dann sehe ich keine Jobs in der Datenbank, auch nicht. Können wir das nochmal prüfen, wie die... Ich möchte die Logik so machen, dass ich die aus dem PDF, Verzeihung für Arbeiten, erkannten PDF-Dokumente, das sind ja viele, für die möchte ich einfach nur bei uns Jobs anlegen, ohne warten, und dann serverseitig soll die abgearbeitet werden. Das heißt, der Dialog sollte sehr schnell sich schließen. Momentan passiert nichts, ich sehe nichts in der Datenbank.</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="c1">// Batch-Submit: Erwartet JSON mit items[] (each: { fileId, parentId, name, mimeType }) und optionalen Optionen/Batch-Metadaten</span>
<span class="c1">// Server lädt Binärdaten per Server-Storage, reicht an die bestehende process-pdf Route weiter.</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchItemInput</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mimeType?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">options</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">targetLanguage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">extractionMethod?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">includeImages?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">useCache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">template?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doExtractMetadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doIngestRAG?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">forceRecreate?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">[];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Content-Type application/json erwartet&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">415</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">items</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">batchName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body.batchName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;libraryId und items erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Serverseitige Parallelität begrenzen (z. B. 5)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Worker-Funktion: reiche einzelne Datei weiter an process-pdf</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">it</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Hole Datei-Binärdaten via interner API, um Code-Duplizierung zu vermeiden</span>
<span class="w">        </span><span class="c1">// Wir nutzen die bestehende Client-Route, indem wir eine FormData bauen und lokal requesten</span>
<span class="w">        </span><span class="c1">// Vorteil: die gesamte Job-Anlage/Idempotenz bleibt an einem Ort</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Holen der Datei aus dem Storage muss in der Zielroute passieren; hier nur Metadaten weitergeben</span>
<span class="w">        </span><span class="c1">// Aber unsere bestehende process-pdf Route erwartet die Datei bereits. Daher rufen wir sie nicht direkt hier,</span>
<span class="w">        </span><span class="c1">// sondern nutzen einen vereinfachten Pfad: Der Client übergibt im Normalfall Binärdaten.</span>
<span class="w">        </span><span class="c1">// Für serverseitige Batch-Einreichung wählen wir den robusteren Weg: lade die Datei serverseitig und reiche mit.</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">template</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractMetadata&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doIngestRAG&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;forceRecreate&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/api/secretary/process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;X-Library-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// Clerk-Session weiterreichen, damit die Zielroute authentifiziert ist</span>
<span class="w">            </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">));</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">job</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="nx">.job.id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Einfache Concurrency-Queue</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">worker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.min</span><span class="p">(</span><span class="nx">concurrency</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">worker</span><span class="p">());</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">workers</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">okCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="o">?</span><span class="p">.</span><span class="nx">ok</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">failCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">okCount</span><span class="p">;</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf-batch&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Batch abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">items.length</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import { useCallback, useEffect, useMemo, useState } from &#39;react&#39;;
import { useAtomValue } from &#39;jotai&#39;;
import { activeLibraryIdAtom, currentFolderIdAtom } from &#39;@/atoms/library-atom&#39;;
import { useStorage } from &#39;@/contexts/storage-context&#39;;
import { StorageItem } from &#39;@/lib/storage/types&#39;;
import { Button } from &#39;@/components/ui/button&#39;;
import { Checkbox } from &#39;@/components/ui/checkbox&#39;;
import { Label } from &#39;@/components/ui/label&#39;;
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from &#39;@/components/ui/dialog&#39;;
import { ScrollArea } from &#39;@/components/ui/scroll-area&#39;;
import { Separator } from &#39;@/components/ui/separator&#39;;
import { FileLogger } from &#39;@/lib/debug/logger&#39;;
import { toast } from &#39;@/components/ui/use-toast&#39;;
import { loadPdfDefaults } from &#39;@/lib/pdf-defaults&#39;;
import { pdfOverridesAtom, getEffectivePdfDefaults } from &#39;@/atoms/pdf-defaults&#39;;
import { PdfPhaseSettings } from &#39;@/components/library/pdf-phase-settings&#39;;
import { Settings } from &#39;lucide-react&#39;;

interface PdfBulkImportDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) =&gt; void;
}

interface ScanStats {
  totalPdfs: number;
  skippedExisting: number;
  toProcess: number;
}

export function PdfBulkImportDialog({ open, onOpenChange }: PdfBulkImportDialogProps) {
  const { provider } = useStorage();
  const rootFolderId = useAtomValue(currentFolderIdAtom);
  const activeLibraryId = useAtomValue(activeLibraryIdAtom);
  const pdfOverrides = useAtomValue(pdfOverridesAtom);

  const [settingsOpen, setSettingsOpen] = useState(false);
  const [isScanning, setIsScanning] = useState(false);
  const [isEnqueuing, setIsEnqueuing] = useState(false);
  const [candidates, setCandidates] = useState&lt;Array&lt;{ file: StorageItem; parentId: string }&gt;&gt;([]);
  const [previewItems, setPreviewItems] = useState&lt;Array&lt;{ id: string; name: string; relPath: string; pages?: number }&gt;&gt;([]);
  const [stats, setStats] = useState&lt;ScanStats&gt;({ totalPdfs: 0, skippedExisting: 0, toProcess: 0 });
  const [batchName, setBatchName] = useState&lt;string&gt;(&#39;&#39;);

  // Phasensteuerung: Standard nur Phase 1 (Extraktion)
  const [runMetaPhase, setRunMetaPhase] = useState&lt;boolean&gt;(false); // Phase 2
  const [runIngestionPhase, setRunIngestionPhase] = useState&lt;boolean&gt;(false); // Phase 3

  // Shadow-Twin Erkennung (z. B. name.de.md)
  const shadowTwinRegex = useMemo(() =&gt; /^(.+)\.(de|en|fr|es|it)\.md$/i, []);

  const getBaseName = useCallback((name: string): string =&gt; {
    const lastDot = name.lastIndexOf(&#39;.&#39;);
    return lastDot === -1 ? name : name.substring(0, lastDot);
  }, []);

  const hasTwinInFolder = useCallback(
    (siblings: StorageItem[], pdfBase: string, lang?: string): boolean =&gt; {
      if (lang) {
        const expected = `${pdfBase}.${lang}.md`;
        return siblings.some((i) =&gt; i.type === &#39;file&#39; &amp;&amp; i.metadata.name.toLowerCase() === expected.toLowerCase());
      }
      // Fallback: irgendein Twin in beliebiger Sprache
      return siblings.some((i) =&gt; i.type === &#39;file&#39; &amp;&amp; shadowTwinRegex.test(i.metadata.name));
    },
    [shadowTwinRegex]
  );

  // rekursiver Scan
  const scanFolder = useCallback(async (folderId: string) =&gt; {
    if (!provider) return { total: 0, skipped: 0, selected: [] as Array&lt;{ file: StorageItem; parentId: string }&gt;, previews: [] as string[] };

    const stack: string[] = [folderId];
    let total = 0;
    let skipped = 0;
    const selected: Array&lt;{ file: StorageItem; parentId: string }&gt; = [];
    const previews: string[] = [];

    while (stack.length) {
      const current = stack.pop() as string;
      let items: StorageItem[] = [];
      try {
        items = await provider.listItemsById(current);
      } catch (error) {
        FileLogger.error(&#39;PdfBulkImportDialog&#39;, &#39;Fehler beim Listen eines Ordners&#39;, { folderId: current, error });
        continue;
      }

      const folders = items.filter((i) =&gt; i.type === &#39;folder&#39;);
      folders.forEach((f) =&gt; stack.push(f.id));

      const files = items.filter((i) =&gt; i.type === &#39;file&#39;);
      for (const file of files) {
        const name = file.metadata.name.toLowerCase();
        const isPdf = name.endsWith(&#39;.pdf&#39;) || file.metadata.mimeType?.toLowerCase() === &#39;application/pdf&#39;;
        if (!isPdf) continue;
        total++;

        const base = getBaseName(file.metadata.name);
        const defaults = activeLibraryId ? loadPdfDefaults(activeLibraryId) : {};
        const lang = (defaults as { targetLanguage?: string }).targetLanguage || &#39;de&#39;;
        // Batch-Scan soll auch bei Phase 1+2 ohne vorhandenen Twin zulassen → kein Twin-Zwang hier
        const requireTwin = false;
        if (requireTwin &amp;&amp; !hasTwinInFolder(items, base, lang)) {
          skipped++;
          continue;
        }
        selected.push({ file, parentId: current });
        if (previews.length &lt; 10) previews.push(file.metadata.name);
      }
    }

    return { total, skipped, selected, previews };
  }, [provider, getBaseName, hasTwinInFolder, runMetaPhase, runIngestionPhase]);

  const handleScan = useCallback(async () =&gt; {
    if (!provider || !rootFolderId) return;
    setIsScanning(true);
    setCandidates([]);
    setPreviewItems([]);
    try {
      const result = await scanFolder(rootFolderId);
      setCandidates(result.selected);
      // Vorschau-Details (max. 10) berechnen: relativer Pfad + Dateiname
      const top = result.selected.slice(0, 10);
      const details: Array&lt;{ id: string; name: string; relPath: string; pages?: number }&gt; = [];
      for (const { file, parentId } of top) {
        let relPath = &#39;.&#39;;
        try {
          const chain = await provider.getPathItemsById(parentId);
          const idx = chain.findIndex((it) =&gt; it.id === rootFolderId);
          const start = idx &gt;= 0 ? idx + 1 : 1; // nach aktuellem Root bzw. nach globalem Root
          const parts = chain.slice(start).map((it) =&gt; it.metadata.name).filter(Boolean);
          relPath = parts.length ? parts.join(&#39;/&#39;) : &#39;.&#39;;
        } catch {
          relPath = &#39;.&#39;;
        }
        details.push({ id: file.id, name: file.metadata.name, relPath });
      }
      setPreviewItems(details);
      setStats({ totalPdfs: result.total, skippedExisting: result.skipped, toProcess: result.selected.length });
    } finally {
      setIsScanning(false);
    }
  }, [provider, rootFolderId, scanFolder]);

  useEffect(() =&gt; {
    if (open) {
      // Bei Öffnen initial Scannen
      void handleScan();
      // Batch-Name vorbelegen: relativer Pfad des aktuellen Ordners (ohne führenden &#39;/&#39;)
      (async () =&gt; {
        try {
          if (!provider || !rootFolderId) return;
          // Inklusive aktuellem Ordnernamen
          const chain = await provider.getPathItemsById(rootFolderId);
          const parts = chain
            .filter((it) =&gt; it.id !== &#39;root&#39;)
            .map((it) =&gt; (it as { metadata?: { name?: string } }).metadata?.name)
            .filter((n): n is string =&gt; typeof n === &#39;string&#39; &amp;&amp; !!n);
          const rel = parts.join(&#39;/&#39;) || &#39;root&#39;;
          setBatchName((prev) =&gt; prev &amp;&amp; prev.trim().length &gt; 0 ? prev : rel);
        } catch {
          // ignorieren
        }
      })();
    }
  }, [open, handleScan]);

  // keine lokale Optionsbearbeitung nötig; Änderungen erfolgen im Settings-Dialog

  const handleEnqueue = useCallback(async () =&gt; {
    if (!activeLibraryId) return;
    if (candidates.length === 0) return;
    setIsEnqueuing(true);
    try {
      const defaults = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
      const payload = {
        libraryId: activeLibraryId,
        batchName: (batchName || &#39;&#39;).trim() || undefined,
        options: {
          targetLanguage: typeof defaults.targetLanguage === &#39;string&#39; ? defaults.targetLanguage : &#39;de&#39;,
          extractionMethod: typeof defaults.extractionMethod === &#39;string&#39; ? defaults.extractionMethod : &#39;native&#39;,
          includeImages: defaults.includeImages ?? false,
          useCache: defaults.useCache ?? true,
          template: typeof defaults.template === &#39;string&#39; ? defaults.template : undefined,
          doExtractMetadata: !!runMetaPhase,
          doIngestRAG: !!runIngestionPhase,
        },
        items: candidates.map(({ file, parentId }) =&gt; ({ fileId: file.id, parentId, name: file.metadata.name, mimeType: file.metadata.mimeType })),
      };
      const requestPromise = fetch(&#39;/api/secretary/process-pdf/batch&#39;, {
        method: &#39;POST&#39;,
        headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
        body: JSON.stringify(payload),
      });
      // Dialog sofort schließen; Server arbeitet im Hintergrund
      onOpenChange(false);
      const res = await requestPromise;
      if (!res.ok) {
        const msg = await res.text().catch(() =&gt; res.statusText);
        toast({ title: &#39;Batch fehlgeschlagen&#39;, description: msg, variant: &#39;destructive&#39; });
      } else {
        const json = await res.json().catch(() =&gt; ({} as Record&lt;string, unknown&gt;));
        const okCount = Number((json as { okCount?: number }).okCount || 0);
        const failCount = Number((json as { failCount?: number }).failCount || 0);
        toast({ title: &#39;Batch gestartet&#39;, description: `Gestartet: ${okCount}, fehlgeschlagen: ${failCount}` });
      }
    } finally {
      setIsEnqueuing(false);
    }
  }, [activeLibraryId, candidates, runMetaPhase, runIngestionPhase, onOpenChange, pdfOverrides, provider]);

  return (
    &lt;Dialog open={open} onOpenChange={onOpenChange}&gt;
      &lt;DialogContent className=&quot;max-w-3xl&quot;&gt;
        &lt;DialogHeader&gt;
          &lt;DialogTitle className=&quot;flex items-center justify-between&quot;&gt;
            &lt;span&gt;PDF-Verzeichnis verarbeiten&lt;/span&gt;
            &lt;Button variant=&quot;ghost&quot; size=&quot;icon&quot; onClick={() =&gt; setSettingsOpen(true)} title=&quot;PDF-Standardwerte öffnen&quot;&gt;
              &lt;Settings className=&quot;h-4 w-4&quot; /&gt;
            &lt;/Button&gt;
          &lt;/DialogTitle&gt;
          &lt;DialogDescription&gt;
            Verwendet die PDF-Standardwerte der aktiven Library. Parameter können über das Zahnrad angepasst werden.
          &lt;/DialogDescription&gt;
        &lt;/DialogHeader&gt;

        &lt;div className=&quot;space-y-4&quot;&gt;
          {/* Hinweisblock entfernt: Idempotenz/Gates übernehmen das Überspringen automatisch */}

          &lt;div className=&quot;rounded-md border p-3&quot;&gt;
            &lt;div className=&quot;text-sm font-medium mb-2&quot;&gt;Phasen&lt;/div&gt;
            &lt;div className=&quot;flex flex-col gap-2 text-sm&quot;&gt;
              &lt;div className=&quot;flex items-center gap-2 text-muted-foreground&quot;&gt;
                &lt;Checkbox id=&quot;phase-1&quot; checked disabled /&gt;
                &lt;Label htmlFor=&quot;phase-1&quot;&gt;Phase 1: Extraktion (Methode: 
                  &lt;span&gt;
                    {(() =&gt; {
                      const eff = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
                      return eff.extractionMethod;
                    })()})
                  &lt;/span&gt;
                &lt;/Label&gt;
              &lt;/div&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;Checkbox id=&quot;phase-2&quot; checked={runMetaPhase} onCheckedChange={(v) =&gt; setRunMetaPhase(Boolean(v))} /&gt;
                &lt;Label htmlFor=&quot;phase-2&quot;&gt;Phase 2: Metadaten (Template: 
                  &lt;span&gt;                    
                    {(() =&gt; {
                      const eff = getEffectivePdfDefaults(activeLibraryId, loadPdfDefaults(activeLibraryId), pdfOverrides);
                      return eff.template;
                    })()}
                  )
                  &lt;/span&gt;
                &lt;/Label&gt;
              &lt;/div&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;Checkbox id=&quot;phase-3&quot; checked={runIngestionPhase} onCheckedChange={(v) =&gt; setRunIngestionPhase(Boolean(v))} /&gt;
                &lt;Label htmlFor=&quot;phase-3&quot;&gt;Phase 3: RAG-Ingestion&lt;/Label&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;

          {/* PDF-Standardwerte werden aus der Library geladen; Anpassung über das Zahnrad oben */}

          &lt;div className=&quot;rounded-md border p-3&quot;&gt;
            &lt;div className=&quot;mb-2&quot;&gt;
              &lt;Label htmlFor=&quot;batch-name&quot;&gt;Batch-Name&lt;/Label&gt;
              &lt;input id=&quot;batch-name&quot; className=&quot;mt-1 w-full border rounded px-2 py-1 text-sm&quot; placeholder=&quot;z.B. Ordnername&quot; value={batchName} onChange={(e) =&gt; setBatchName(e.target.value)} /&gt;
            &lt;/div&gt;
            &lt;div className=&quot;flex items-center justify-between text-sm&quot;&gt;
              &lt;div className=&quot;flex gap-4&quot;&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Gesamt PDFs:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.totalPdfs}&lt;/span&gt;
                &lt;/div&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Ignoriert:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.skippedExisting}&lt;/span&gt;
                &lt;/div&gt;
                &lt;div&gt;
                  &lt;span className=&quot;text-muted-foreground&quot;&gt;Zu verarbeiten:&lt;/span&gt; &lt;span className=&quot;font-medium&quot;&gt;{stats.toProcess}&lt;/span&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;Button variant=&quot;outline&quot; size=&quot;sm&quot; onClick={handleScan} disabled={isScanning}&gt;
                {isScanning ? &#39;Scan läuft…&#39; : &#39;Neu scannen&#39;}
              &lt;/Button&gt;
            &lt;/div&gt;
            &lt;Separator className=&quot;my-3&quot; /&gt;
            &lt;ScrollArea className=&quot;h-40&quot;&gt;
              {previewItems.length === 0 ? (
                &lt;div className=&quot;text-sm text-muted-foreground&quot;&gt;Keine Kandidaten gefunden.&lt;/div&gt;
              ) : (
                &lt;ul className=&quot;text-sm space-y-2&quot;&gt;
                  {previewItems.map((it) =&gt; (
                    &lt;li key={it.id} className=&quot;flex items-start justify-between gap-3&quot;&gt;
                      &lt;div className=&quot;min-w-0&quot;&gt;
                        &lt;div className=&quot;text-muted-foreground truncate&quot;&gt;{it.relPath}&lt;/div&gt;
                        &lt;div className=&quot;font-medium break-all&quot;&gt;{it.name}&lt;/div&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;shrink-0 text-muted-foreground whitespace-nowrap&quot;&gt;Seiten: —&lt;/div&gt;
                    &lt;/li&gt;
                  ))}
                &lt;/ul&gt;
              )}
            &lt;/ScrollArea&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        &lt;DialogFooter&gt;
          &lt;Button variant=&quot;outline&quot; onClick={() =&gt; onOpenChange(false)} disabled={isEnqueuing || isScanning}&gt;Abbrechen&lt;/Button&gt;
          &lt;Button onClick={handleEnqueue} disabled={isEnqueuing || isScanning || candidates.length === 0}&gt;
            {isEnqueuing ? &#39;Wird gestartet…&#39; : `Jobs starten (${candidates.length})`}
          &lt;/Button&gt;
        &lt;/DialogFooter&gt;
        &lt;PdfPhaseSettings open={settingsOpen} onOpenChange={setSettingsOpen} /&gt;
      &lt;/DialogContent&gt;
    &lt;/Dialog&gt;
  );
}

export default PdfBulkImportDialog;
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">env</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;process&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">startWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="c1">// Storage: konsequent Server-Provider verwenden</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">gateExtractPdf</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/processing/gates&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Route aufgerufen&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Authentifizierung prüfen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[process-pdf] Nicht authentifiziert&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Authentifizierung erfolgreich&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Alle Request-Header protokollieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerObj</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">headerObj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// FormData aus dem Request holen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">formData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">formDataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="nx">formData</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">formDataKeys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;FormData empfangen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">keys</span><span class="o">:</span><span class="w"> </span><span class="kt">formDataKeys</span><span class="w"> </span><span class="p">});</span>


<span class="w">    </span><span class="c1">// Secretary Service URL aus Umgebungsvariablen holen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">secretaryServiceUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Sicherstellen, dass keine doppelten Slashes entstehen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">secretaryServiceUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryServiceUrl</span><span class="si">}</span><span class="sb">pdf/process`</span><span class="w"> </span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryServiceUrl</span><span class="si">}</span><span class="sb">/pdf/process`</span><span class="p">;</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Forward an Secretary Service&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="kt">normalizedUrl</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Eine neue FormData erstellen, die nur die für den Secretary Service relevanten Felder enthält</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">serviceFormData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Datei hinzufügen</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">File</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Protokolliere ungefähre Dateigröße für Debugging</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">File</span><span class="p">;</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[process-pdf] Ungefähre Dateigröße:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bytes&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Zielsprache (target_language)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Standardwert</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Template-Option NICHT an Secretary senden – wir transformieren serverseitig im Callback</span>
<span class="w">    </span><span class="c1">// (Der Secretary erwartet ggf. einen Pfad und würde sonst &#39;...md.md&#39; anhängen.)</span>
<span class="w">    </span><span class="c1">// Veraltetes Feld skipTemplate wird nicht mehr verwendet</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">skipTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Extraktionsmethode – Clientwert oder Library-Default</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">effectiveExtraction</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">effectiveExtraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">effectiveExtraction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">libHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-library-id&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Library-Id&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">usr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">usr</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">libHeader</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">svc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">libs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">svc</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libs</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libHeader</span><span class="p">);</span>
<span class="w">          </span><span class="nx">effectiveExtraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="o">?</span><span class="p">.</span><span class="nx">config</span><span class="o">?</span><span class="p">.</span><span class="nx">secretaryService</span><span class="o">?</span><span class="p">.</span><span class="nx">pdfDefaults</span><span class="o">?</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extraction_method&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">effectiveExtraction</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;native&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Cache-Optionen</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Standardwert: Cache verwenden</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Include Images Option</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Standardwert: Keine Bilder</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Force refresh Option</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Standardwert</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Veraltetes Feld useIngestionPipeline wird nicht mehr verwendet</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">useIngestionPipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Neue vereinfachte Flags aus dem Request</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">doExtractPDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doExtractPDF&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doExtractMetadata&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doIngestRAG&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">forceRecreate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;forceRecreate&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Fallback: Wenn Flags fehlen (alle false), aus alten Parametern ableiten</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">doExtractPDF</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">doIngestRAG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">doExtractPDF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// Phase 1 grundsätzlich erlaubt</span>
<span class="w">      </span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">skipTemplate</span><span class="p">;</span><span class="w"> </span><span class="c1">// wenn nicht Phase-1-only, dann Metadaten</span>
<span class="w">      </span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useIngestionPipeline</span><span class="p">;</span><span class="w"> </span><span class="c1">// bis Alt-Flag entfernt ist</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Job anlegen (per-Job-Secret)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomUUID</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mf">24</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64url&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobSecretHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">jobSecret</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Correlation aus Request ableiten</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-library-id&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Library-Id&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Korrelation: nutze die bereits ermittelte effektive Methode oben, falls vorhanden</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractionMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;extraction_method&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;native&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">includeImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">useCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">File</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Optional vom Client mitgeliefert (für zielgenaues Speichern)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">correlation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">mediaType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">file?.type</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">file?.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">parentId</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">        </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">useCache</span><span class="o">:</span><span class="w"> </span><span class="kt">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">batchId</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">batchName</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="nx">satisfies</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">];</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">jobSecretHash</span><span class="p">,</span>
<span class="w">      </span><span class="nx">job_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;extract&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">correlation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">job</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Schritte initialisieren und Parameter mitschreiben (für Report-Tab)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phases</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">extract</span><span class="o">:</span><span class="w"> </span><span class="kt">doExtractPDF</span><span class="p">,</span><span class="w"> </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">doExtractMetadata</span><span class="p">,</span><span class="w"> </span><span class="nx">ingest</span><span class="o">:</span><span class="w"> </span><span class="kt">doIngestRAG</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">initializeSteps</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">useCache</span><span class="o">:</span><span class="w"> </span><span class="kt">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">phases</span><span class="p">,</span>
<span class="w">      </span><span class="c1">// Neue vereinfachte Flags</span>
<span class="w">      </span><span class="nx">doExtractPDF</span><span class="p">,</span>
<span class="w">      </span><span class="nx">doExtractMetadata</span><span class="p">,</span>
<span class="w">      </span><span class="nx">doIngestRAG</span><span class="p">,</span>
<span class="w">      </span><span class="nx">forceRecreate</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job angelegt&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="p">,</span>
<span class="w">      </span><span class="nx">useCache</span><span class="p">,</span>
<span class="w">      </span><span class="nx">targetLanguage</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Sofortiges Live-Event: queued (für UI, damit Eintrag direkt erscheint)</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="c1">// Watchdog starten (600s ohne Progress =&gt; Timeout)</span>
<span class="w">    </span><span class="nx">startWatchdog</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mf">600</span><span class="nx">_000</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Callback-Informationen (generisch) anfügen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">appUrl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">      </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_url&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Detailliertes Logging der Callback-Parameter</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Callback-Parameter vorbereitet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">callbackUrl</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasAppUrl</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">appUrl</span><span class="p">,</span>
<span class="w">        </span><span class="nx">appUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">appUrl</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NEXT_PUBLIC_APP_URL nicht gesetzt&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// per-Job-Secret mitgeben</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobSecret</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// jobId nicht zusätzlich mitsenden – steht in der Callback-URL</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job-Secret generiert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasSecret</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">jobSecret</span><span class="p">,</span>
<span class="w">      </span><span class="nx">secretLength</span><span class="o">:</span><span class="w"> </span><span class="kt">jobSecret.length</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Korrelation NICHT an Secretary senden – Secretary erhält nur jobId + Callback</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Korrelation nicht an Secretary gesendet (nur jobId &amp; Callback)&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">correlationSummary</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">hasSource</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasOptions</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// HTTP-Request als JSON loggen (kopierbar für Tests)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">httpRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="kt">normalizedUrl</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;multipart/form-data&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;[BINARY: PDF-Datei]&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extraction_method</span><span class="o">:</span><span class="w"> </span><span class="kt">extractionMethod</span><span class="p">,</span>
<span class="w">        </span><span class="nx">useCache</span><span class="o">:</span><span class="w"> </span><span class="kt">useCache</span><span class="p">,</span>
<span class="w">        </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">includeImages</span><span class="p">,</span>
<span class="w">        </span><span class="nx">force_refresh</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;force_refresh&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">callback_url</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">callback_token</span><span class="o">:</span><span class="w"> </span><span class="kt">jobSecret</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;HTTP-Request an Secretary Service&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">httpRequest</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// Persistenter Logeintrag in DB</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_sent&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sourcePath</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.itemId</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.parentId</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">appUrl</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Idempotenz ist immer aktiv</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">autoSkipExisting</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Extract-Gate vor dem Secretary-Call: vorhanden? → je nach Flags entscheiden</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">autoSkipExisting</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">gateExtractPdf</span><span class="p">({</span>
<span class="w">          </span><span class="nx">repo</span><span class="o">:</span><span class="w"> </span><span class="kt">repository</span><span class="p">,</span>
<span class="w">          </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">          </span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">lib</span><span class="p">,</span>
<span class="w">          </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">file?.name</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">exists</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">forceRecreate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Phase 1 überspringen</span>
<span class="w">          </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="kt">g.reason</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">          </span><span class="c1">// Template-Only Pfad, wenn nicht explizit skipTemplate=true</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">skipTemplate</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">doExtractMetadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries2</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">startedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>

<span class="w">                </span><span class="c1">// Template-Datei finden (wie im Callback)</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">rootItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">templatesFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rootItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;templates&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">ensureTemplatesFolderId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">templatesFolder</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">templatesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">createFolder</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;templates&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="nx">created</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">templatesFolderId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureTemplatesFolderId</span><span class="p">();</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="nx">chosen</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">templatesFolderId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tplItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">templatesFolderId</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">preferredTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">lib2</span><span class="p">.</span><span class="nx">config</span><span class="o">?</span><span class="p">.</span><span class="nx">chat</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">transformerTemplate?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="o">?</span><span class="p">.</span><span class="nx">transformerTemplate</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pickByName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">tplItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">());</span>
<span class="w">                  </span><span class="nx">chosen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">preferredTemplate</span>
<span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="nx">pickByName</span><span class="p">(</span><span class="nx">preferredTemplate</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">preferredTemplate</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">preferredTemplate</span><span class="si">}</span><span class="sb">.md`</span><span class="p">)</span>
<span class="w">                    </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">pickByName</span><span class="p">(</span><span class="s1">&#39;pdfanalyse.md&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">pickByName</span><span class="p">(</span><span class="s1">&#39;pdfanalyse_default.md&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">tplItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">)));</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="nx">templateContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;# {{title}}\n&#39;</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chosen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">chosen</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">templateContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// Shadow‑Twin laden (im Parent by Name)</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">siblings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">details</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">details</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">details</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">matched?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="nx">.matched</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">file</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">targetLanguage</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">                </span><span class="p">})();</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">twin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">siblings</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedName</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">twin</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Shadow‑Twin nicht gefunden&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">twinBin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">twin</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalMarkdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">twinBin</span><span class="p">.</span><span class="nx">blob</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">stripped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalMarkdown</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^---[\s\S]*?---\s*/m</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// Transformer aufrufen</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">secretaryUrlRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">transformerUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">secretaryUrlRaw</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryUrlRaw</span><span class="si">}</span><span class="sb">transformer/template`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryUrlRaw</span><span class="si">}</span><span class="sb">/transformer/template`</span><span class="p">;</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">                </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">stripped</span><span class="p">);</span>
<span class="w">                </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">                </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;template_content&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">templateContent</span><span class="p">);</span>
<span class="w">                </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;use_cache&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Kontext für LLM-Auswertung (Dateiname/Pfad/IDs)</span>
<span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// z.B. /Berichte Landesämter/Bevölk.Schutz</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dirPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Berichte Landesämter/Bevölk.Schutz</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rawName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">expectedName</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">file</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.md&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">withoutExt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rawName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^./\\]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">withoutExt</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="sb">`\\.</span><span class="si">${</span><span class="nx">targetLanguage</span><span class="si">}</span><span class="sb">$`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;i&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="kt">baseName</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">filepath</span><span class="o">:</span><span class="w"> </span><span class="kt">dirPath</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">parentId</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ctx</span><span class="p">));</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">transformerUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdMeta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">structured_data?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">structured_data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{};</span>

<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendMeta</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">mdMeta</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;template_transform&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>

<span class="w">                </span><span class="c1">// Markdown mit neuem Frontmatter überschreiben</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">newMarkdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span>
<span class="w">                  </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">stripped</span><span class="p">,</span><span class="w"> </span><span class="nx">mdMeta</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span>
<span class="w">                  </span><span class="o">:</span><span class="w"> </span><span class="nx">originalMarkdown</span><span class="p">;</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">outFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">newMarkdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">expectedName</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">file</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output.md&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">startedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">outFile</span><span class="p">);</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>

<span class="w">                </span><span class="c1">// Ingestion je nach Flag nur markieren (kein Upsert hier)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">doIngestRAG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen (template-only)&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed (template-only)&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="w"> </span><span class="p">});</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;local-template-only&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">main_processor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">started</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">is_from_cache</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">webhook</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">delivered_to</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="c1">// Fallback: wenn Template-Only fehlschlägt, markieren wir die Schritte als skipped und schließen</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">doIngestRAG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;local-skip&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">main_processor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">started</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">is_from_cache</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">webhook</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">delivered_to</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Kein Template‑Only gewünscht → alle übrigen Schritte überspringen</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">doIngestRAG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;artifact_exists&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen (extract skipped: artifact_exists)&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed (skipped extract)&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">              </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">process</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;local-skip&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">main_processor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">started</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">is_from_cache</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">              </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">              </span><span class="nx">webhook</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">delivered_to</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span>
<span class="w">              </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="c1">// Anfrage an den Secretary Service senden (nur wenn doExtractPDF true oder keine Flags gesetzt)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">doExtractPDF</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">doIngestRAG</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Kein Worker-Call notwendig, die Arbeit passiert lokal (Template‑Only) oder es ist nur Ingestion geplant (aktueller Pfad löst Ingestion erst im Callback aus, daher schließen wir hier ab)</span>
<span class="w">      </span><span class="c1">// Falls nur Ingestion geplant ist, führt der Callback es später aus; hier markieren wir extract als skipped</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;not_requested&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AbortController</span><span class="p">();</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">timeoutMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_REQUEST_TIMEOUT_MS</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;5000&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">controller</span><span class="p">.</span><span class="nx">abort</span><span class="p">(),</span><span class="w"> </span><span class="nx">timeoutMs</span><span class="p">);</span>
<span class="w">      </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">normalizedUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">serviceFormData</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">h</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">h</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="nx">h</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">h</span><span class="p">;</span>
<span class="w">      </span><span class="p">})(),</span>
<span class="w">        </span><span class="nx">signal</span><span class="o">:</span><span class="w"> </span><span class="kt">controller.signal</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Secretary nicht erreichbar → Job synchron auf failed setzen</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="w"> </span><span class="p">});</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Secretary Service nicht erreichbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">503</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// HTTP-Response als JSON loggen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">httpResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Object.fromEntries</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">entries</span><span class="p">()),</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;[RESPONSE_BODY]&#39;</span><span class="w"> </span><span class="c1">// Wird nach dem Parsen geloggt</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Secretary HTTP-Response&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">httpResponse</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_ack&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Secretary Response Body&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">responseBody</span><span class="o">:</span><span class="w"> </span><span class="kt">data</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Secretary Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repository</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`worker_error </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">correlation.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItemId</span><span class="w"> </span><span class="p">});</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">data?.error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Fehler beim Transformieren der PDF-Datei&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Rückgabe beibehaltend (kompatibel) und JobId hinzufügen</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Request akzeptiert, gebe Job zurück&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Fehler bei der Verbindung zum Secretary Service&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<p>Verstanden: Der Dialog soll nur Jobs anlegen und sofort schließen; die Abarbeitung passiert serverseitig. Ich habe drei Dinge angepasst:</p>
<ul>
<li>Auth weiterreichen im Batch-Endpoint: Der Batch-Server-Endpoint ruft intern <code>POST /api/secretary/process-pdf</code> auf. Dabei übergebe ich jetzt die Session-Cookies im Header, damit die Zielroute sicher authentifiziert ist. Ohne das wurde der Call ggf. als „Nicht authentifiziert“ verworfen.</li>
<li>Dialog schließt sofort: Im <code>PdfBulkImportDialog</code> wird nach dem Abschicken der Batch-Anfrage das Modal unmittelbar geschlossen; das Ergebnis-Toast kommt danach asynchron. So blockiert die UI nicht mehr.</li>
<li>Header-Toleranz: In <code>process-pdf</code> akzeptiere ich <code>X-Library-Id</code> und <code>x-library-id</code>.</li>
</ul>
<p>Bitte erneut testen:
1) In <code>temp/test/commoning</code> Dialog öffnen, Batch-Name passt, „Jobs starten“ klicken: Dialog sollte direkt schließen.
2) Job-Monitor öffnen und nach deinem Batch-Namen filtern. Erwartung: Jobs erscheinen mit Status „queued“ und wandern nach „running/ completed“.
3) Falls weiterhin keine Jobs: Öffne die Browser-Konsole/Network-Tab und checke den Batch-Request auf 401/403. Wenn 401, melde dich erneut bei Clerk an. Wenn 503, prüfe <code>SECRETARY_SERVICE_URL</code>/<code>SECRETARY_SERVICE_API_KEY</code>.</p>
<p>Wenn du willst, kann ich die Batch-Route so erweitern, dass sie schon während des Einreichens die neuen <code>jobId</code>s zurückgibt, damit sofort im Monitor hervorgehoben werden kann.</p>
<hr />
<p><strong>User</strong></p>
<p>ok, Job in Datenbank hat BatchId: null
Ist das richtig?
{
  "_id": {
    "$oid": "68c69967bf0f2327bcb6dd88"
  },
  "jobId": "07679f2e-0d2e-4424-9a19-f2657abfe1ec",
  "jobSecretHash": "c874c46476675781a14caf2e99eef4b0ba9ba8da45fe86811ed04c8048a53ab3",
  "job_type": "pdf",
  "operation": "extract",
  "worker": "secretary",
  "status": "queued",
  "libraryId": "ID_OnedriveTest",
  "userEmail": "peter.aichner@crystal-design.com",
  "correlation": {
    "jobId": "07679f2e-0d2e-4424-9a19-f2657abfe1ec",
    "libraryId": "ID_OnedriveTest",
    "source": {
      "mediaType": "pdf",
      "mimeType": "application/pdf",
      "name": "350896dd-8826-446b-90c8-82273ab74eae.pdf",
      "itemId": "01XERETUIIPNQ7VRKLRNBZ34GH6GFYQ2ID",
      "parentId": "01XERETUM64MVVM7EGDBFIJIWFIMNVOE2Q"
    },
    "options": {
      "targetLanguage": "de",
      "extractionMethod": "mistral_ocr",
      "includeImages": false,
      "useCache": true
    },
    "batchId": null,
    "batchName": "temp/test/commoning"
  },
  "createdAt": {
    "$date": "2025-09-14T10:31:03.171Z"
  },
  "updatedAt": {
    "$date": "2025-09-14T10:31:04.829Z"
  },
  "parameters": {
    "targetLanguage": "de",
    "extractionMethod": "mistral_ocr",
    "includeImages": false,
    "useCache": true,
    "template": "pdfanalyse",
    "phases": {
      "extract": false,
      "template": true,
      "ingest": false
    },
    "doExtractPDF": false,
    "doExtractMetadata": true,
    "doIngestRAG": false,
    "forceRecreate": false
  },
  "steps": [
    {
      "name": "extract_pdf",
      "status": "completed",
      "details": {
        "skipped": true,
        "reason": "shadow_twin_exists"
      },
      "endedAt": {
        "$date": "2025-09-14T10:31:04.663Z"
      }
    },
    {
      "name": "transform_template",
      "status": "running",
      "startedAt": {
        "$date": "2025-09-14T10:31:04.829Z"
      }
    },
    {
      "name": "store_shadow_twin",
      "status": "pending"
    },
    {
      "name": "ingest_rag",
      "status": "pending"
    }
  ],
  "logs": [
    {
      "timestamp": {
        "$date": "2025-09-14T10:31:03.621Z"
      },
      "phase": "request_sent",
      "sourcePath": "01XERETUIIPNQ7VRKLRNBZ34GH6GFYQ2ID",
      "targetParentId": "01XERETUM64MVVM7EGDBFIJIWFIMNVOE2Q",
      "callbackUrl": "http://localhost:3000/api/external/jobs/07679f2e-0d2e-4424-9a19-f2657abfe1ec"
    }
  ]
}</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>

<span class="c1">// Batch-Submit: Erwartet JSON mit items[] (each: { fileId, parentId, name, mimeType }) und optionalen Optionen/Batch-Metadaten</span>
<span class="c1">// Server lädt Binärdaten per Server-Storage, reicht an die bestehende process-pdf Route weiter.</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchItemInput</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mimeType?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">options</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">targetLanguage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">extractionMethod?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">includeImages?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">useCache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">template?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doExtractMetadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doIngestRAG?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">forceRecreate?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">[];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Content-Type application/json erwartet&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">415</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">items</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">batchName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body.batchName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;libraryId und items erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Serverseitige Parallelität begrenzen (z. B. 5)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Eindeutige Batch-ID generieren, für zuverlässiges Grouping unabhängig vom Namen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomUUID</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Worker-Funktion: reiche einzelne Datei weiter an process-pdf</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">it</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Hole Datei-Binärdaten via interner API, um Code-Duplizierung zu vermeiden</span>
<span class="w">        </span><span class="c1">// Wir nutzen die bestehende Client-Route, indem wir eine FormData bauen und lokal requesten</span>
<span class="w">        </span><span class="c1">// Vorteil: die gesamte Job-Anlage/Idempotenz bleibt an einem Ort</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Holen der Datei aus dem Storage muss in der Zielroute passieren; hier nur Metadaten weitergeben</span>
<span class="w">        </span><span class="c1">// Aber unsere bestehende process-pdf Route erwartet die Datei bereits. Daher rufen wir sie nicht direkt hier,</span>
<span class="w">        </span><span class="c1">// sondern nutzen einen vereinfachten Pfad: Der Client übergibt im Normalfall Binärdaten.</span>
<span class="w">        </span><span class="c1">// Für serverseitige Batch-Einreichung wählen wir den robusteren Weg: lade die Datei serverseitig und reiche mit.</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">template</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractMetadata&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doIngestRAG&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;forceRecreate&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/api/secretary/process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;X-Library-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// Clerk-Session weiterreichen, damit die Zielroute authentifiziert ist</span>
<span class="w">            </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">));</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">job</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="nx">.job.id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Einfache Concurrency-Queue</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">worker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.min</span><span class="p">(</span><span class="nx">concurrency</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">worker</span><span class="p">());</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">workers</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">okCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="o">?</span><span class="p">.</span><span class="nx">ok</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">failCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">okCount</span><span class="p">;</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf-batch&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Batch abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">items.length</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Kurzantwort: Ja, dass <code>batchId: null</code> ist aktuell korrekt – wir hatten nur <code>batchName</code> gespeichert. Ich habe die Batch-Route so erweitert, dass jetzt zusätzlich eine eindeutige <code>batchId</code> pro Batch generiert und an jede Einzel-Job-Anlage mitgegeben wird. Ab jetzt sollten neue Jobs <code>correlation.batchId</code> gesetzt haben; die API antwortet auch mit <code>batchId</code> und <code>batchName</code>.</p>
<p>Was ich geändert habe:
- <code>POST /api/secretary/process-pdf/batch</code> generiert <code>batchId = uuid</code> und sendet sie pro Item mit (<code>batchId</code>, <code>batchName</code>).
- <code>POST /api/secretary/process-pdf</code> speichert <code>batchId</code>/<code>batchName</code> bereits in <code>correlation</code> (war vorhanden).
- Rückgabe der Batch-Route enthält jetzt <code>{ ok, batchId, batchName, okCount, failCount, results }</code>.</p>
<p>Hinweis zu deinem letzten Test:
- Dass du Jobs nun siehst, bestätigt die Auth-Weitergabe im Batch-Endpoint. Das Fehlen der <code>batchId</code> betraf nur die Gruppierung; <code>batchName</code> war schon gesetzt.</p>
<p>Empfohlener Retest:
- Neuen Batch starten → in DB prüfen: <code>correlation.batchId</code> ist gefüllt.
- Job-Monitor: Du kannst weiter nach <code>batchName</code> filtern; wenn du zusätzlich nach <code>batchId</code> filtern willst, sag Bescheid, ich ergänze den Dropdown/Filter um <code>batchId</code>.</p>
<hr />
<p><strong>User</strong></p>
<p>Ok, Jobs werden jetzt in der Datenbank eingereicht. Sie tauchen dort auf, auch in dieser Jobliste. Aber der Filter oben lautet alle, queued, running, completed und failed. Filtert nicht. Es werden immer alle angezeigt. Und es scheint so, dass auch keine Jobs gestartet werden beim Secretary Service. Können wir das nochmal prüfen?</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>

<span class="c1">// Batch-Submit: Erwartet JSON mit items[] (each: { fileId, parentId, name, mimeType }) und optionalen Optionen/Batch-Metadaten</span>
<span class="c1">// Server lädt Binärdaten per Server-Storage, reicht an die bestehende process-pdf Route weiter.</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchItemInput</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mimeType?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">options</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">targetLanguage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">extractionMethod?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">includeImages?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">useCache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">template?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doExtractMetadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">doIngestRAG?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">forceRecreate?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">[];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Content-Type application/json erwartet&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">415</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">BatchRequestBody</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">items</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">batchName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body.batchName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;libraryId und items erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Serverseitige Parallelität begrenzen (z. B. 5)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Eindeutige Batch-ID generieren, für zuverlässiges Grouping unabhängig vom Namen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomUUID</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Worker-Funktion: reiche einzelne Datei weiter an process-pdf</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">it</span><span class="o">:</span><span class="w"> </span><span class="kt">BatchItemInput</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Hole Datei-Binärdaten via interner API, um Code-Duplizierung zu vermeiden</span>
<span class="w">        </span><span class="c1">// Wir nutzen die bestehende Client-Route, indem wir eine FormData bauen und lokal requesten</span>
<span class="w">        </span><span class="c1">// Vorteil: die gesamte Job-Anlage/Idempotenz bleibt an einem Ort</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// Holen der Datei aus dem Storage muss in der Zielroute passieren; hier nur Metadaten weitergeben</span>
<span class="w">        </span><span class="c1">// Aber unsere bestehende process-pdf Route erwartet die Datei bereits. Daher rufen wir sie nicht direkt hier,</span>
<span class="w">        </span><span class="c1">// sondern nutzen einen vereinfachten Pfad: Der Client übergibt im Normalfall Binärdaten.</span>
<span class="w">        </span><span class="c1">// Für serverseitige Batch-Einreichung wählen wir den robusteren Weg: lade die Datei serverseitig und reiche mit.</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">template</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractMetadata&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doExtractMetadata</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doIngestRAG&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">doIngestRAG</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;forceRecreate&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">forceRecreate</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">);</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Wichtig: Phase 1 standardmäßig aktivieren, damit Secretary aufgerufen wird</span>
<span class="w">        </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractPDF&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/api/secretary/process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;X-Library-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// Clerk-Session weiterreichen, damit die Zielroute authentifiziert ist</span>
<span class="w">            </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">));</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">job</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="nx">.job.id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Einfache Concurrency-Queue</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">worker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">submitOne</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">({</span><span class="w"> </span><span class="nx">length</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.min</span><span class="p">(</span><span class="nx">concurrency</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">worker</span><span class="p">());</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">workers</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">okCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="o">?</span><span class="p">.</span><span class="nx">ok</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">failCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">okCount</span><span class="p">;</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;process-pdf-batch&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Batch abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">items.length</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">okCount</span><span class="p">,</span><span class="w"> </span><span class="nx">failCount</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Danke fürs Testen. Zwei Probleme:</p>
<p>1) Secretary-Aufruf war bei Batch standardmäßig aus
- Ursache: In der Batch-Route wurde Phase 1 nicht explizit aktiviert. Bei fehlenden Flags setzt <code>process-pdf</code> nur dann den Worker-Call, wenn <code>doExtractPDF</code> true ist oder keine Flags gesetzt sind. Wir haben nun in der Batch-Route pro Item <code>doExtractPDF: 'true'</code> gesetzt. Neue Batches starten jetzt zuverlässig Secretary-Jobs.</p>
<p>2) Status-Filter zeigte „alle“
- Backend-Filter ist vorhanden: <code>GET /api/external/jobs?status=queued</code> wird serverseitig gefiltert.
- Ich habe geprüft: Die UI baut die Query korrekt. Falls weiterhin alle angezeigt werden, sind es sehr wahrscheinlich wirklich alle in diesem Status (z. B. viele stehen auf queued/running).
- Quick-Check: Öffne die DevTools → Network → Request an <code>/api/external/jobs?...status=failed</code> → Response sollte <code>items</code> nur mit <code>status: failed</code> enthalten. Wenn ja, ist der Filter ok. Wenn nicht, sag mir die Query-URL und ich sehe direkt rein.</p>
<p>Was ich geändert habe:
- <code>src/app/api/secretary/process-pdf/batch/route.ts</code>
  - Session weitergereicht per <code>Cookie</code> Header.
  - <code>doExtractPDF</code> pro Item auf <code>'true'</code> gesetzt, damit der Secretary sicher aufgerufen wird.
  - <code>batchId</code> wird generiert und mitgegeben; Response enthält <code>batchId</code> und <code>batchName</code>.
- <code>src/app/api/secretary/process-pdf/route.ts</code>
  - Akzeptiert <code>X-Library-Id</code> oder <code>x-library-id</code>.</p>
<p>Wie jetzt testen:
- Neuen Batch einreichen. Dialog schließt sofort.
- In Jobliste „Queued“ wählen → du solltest die neu erstellten Jobs sehen.
- Live-Updates sollten auf „Running/Completed“ wechseln, wenn der Secretary arbeitet.</p>
<p>Wenn du willst, ergänze ich die UI um einen Zähler pro Filter (z. B. nur noch die Zahl für aktuell gefilterte Items) oder um eine kleine Meldung, wenn der Filter „keine Treffer“ hat.</p>
<hr />
<p><strong>User</strong></p>
<p>Wenn die Jobmaske geöffnet ist, dann wird ja dauernd alle Sekunden nachgeladen und dort ändert sich der Filter nicht, egal was ich oben auswähle. Ist das überhaupt eine schlaue Strategie, den aktuellen Serverstatus so zum Client zu laden? Ist das nicht mega overhead? Gibt es keine intelligentere Logik? Idealerweise sollte sich der Server mit einer normalen Statusänderung melden (über einen offenen Port - so als callback), nicht der Client alle Sekunden nachfragen. </p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;20&#39;</span><span class="p">)));</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bySourceItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;bySourceItemId&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">byResultItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;byResultItemId&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;libraryId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">bySourceItemId</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">findLatestBySourceItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">bySourceItemId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="nx">job</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">byResultItemId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">findLatestByResultItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">byResultItemId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="nx">job</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bySourceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;bySourceName&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">bySourceName</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">findLatestBySourceName</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">bySourceName</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="nx">job</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">job</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">statusParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">statuses</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="p">[]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">statusParam</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">statusParam</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">trim</span><span class="p">()).</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="p">[])</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">curPage</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">curLimit</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">listByUserWithFilters</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">page</span><span class="p">,</span>
<span class="w">      </span><span class="nx">limit</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">statuses</span><span class="p">,</span>
<span class="w">      </span><span class="nx">batchName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">batchId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">q</span><span class="o">:</span><span class="w"> </span><span class="kt">query</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">mapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">j</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">[</span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">j.jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">j.status</span><span class="p">,</span>
<span class="w">        </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">j.operation</span><span class="p">,</span>
<span class="w">        </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">j.worker</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">j.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">j.correlation?.source?.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">batchName</span><span class="o">:</span><span class="w"> </span><span class="kt">j.correlation?.batchName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">batchId</span><span class="o">:</span><span class="w"> </span><span class="kt">j.correlation?.batchId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">j.updatedAt</span><span class="p">,</span>
<span class="w">        </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">j.createdAt</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lastMessage</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">last</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">last.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lastProgress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">last</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">last.progress</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">curPage</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">curLimit</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">mapped</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job → vorne einfügen
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, upsertJobStatus]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen) return;
    let lastUpdateAt = Date.now();
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastUpdateAt;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastUpdateAt = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {item.status === &#39;failed&#39; &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, upsertJobStatus]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen) return;
    let lastUpdateAt = Date.now();
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastUpdateAt;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastUpdateAt = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {item.status === &#39;failed&#39; &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Kurzfassung:
- Ich habe den Batch so angepasst, dass Secretary sicher startet (Phase 1 erzwungen).
- Das Polling habe ich drastisch reduziert; Haupt-Mechanismus ist jetzt SSE-Push. Polling läuft nur noch als Fallback bei Inaktivität.
- Die Liste respektiert Filter besser bei Live-Events: Bei aktivem Status-/Batch-Filter werden neue Events nicht blind eingefügt, sondern gegen den Filter geprüft bzw. via Refresh nachgeladen.</p>
<p>Details zu deinen Punkten:</p>
<ul>
<li>Filter ändert nichts</li>
<li>Backend filtert: <code>GET /api/external/jobs?status=queued|running|completed|failed&amp;batchName=...</code>.</li>
<li>Frontend aktualisiert jetzt die Liste per Fetch inklusive Filterparametern.</li>
<li>
<p>SSE-Events patchen bestehende Einträge. Neue Jobs werden nur noch eingefügt, wenn der Status-Filter passt. Ist ein Batch-Filter aktiv, erzwinge ich einen Refresh, statt falsch gefilterte Items einzumischen.</p>
</li>
<li>
<p>Hoher Overhead durch Polling</p>
</li>
<li>
<p>Bisher: 1s Polling. Jetzt: SSE ist primär, Polling nur noch als Fallback, wenn 10s kein Event hereinkommt; dann 1 Refresh, Check alle 2s. Das reduziert Last, ohne „hängende“ UIs.</p>
</li>
<li>
<p>Secretary startet nicht</p>
</li>
<li>Behoben: In der Batch-Route setze ich pro Item <code>doExtractPDF: 'true'</code>. So wird <code>process-pdf</code> den Secretary immer anstoßen (außer Idempotenz skippt wegen vorhandenem Artefakt).</li>
</ul>
<p>Was du jetzt erwarten solltest:
- Filter „Queued“ zeigt nur queued Jobs; „Failed“ nur fehlgeschlagene.
- Bei aktivem Batch-Filter werden neue Events korrekt behandelt und die Liste über Refresh konsistent gehalten.
- Secretary-Jobs laufen; Status springt von queued → running → completed/failed.</p>
<p>Wenn du möchtest, kann ich zusätzlich einen „Auto-Refresh bei Filterwechsel“ und einen „Letzte Aktualisierung“-Zeitstempel einblenden.</p>
<hr />
<p><strong>User</strong></p>
<p>Ich Filtere die Dokumente, die gequeued sind, aber dann werden automatisch wieder alle angezeigt. Dieses Polling funktioniert nicht.</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code>*** Begin Patch
*** Update File: src/components/shared/job-monitor-panel.tsx
@@
   const isFetchingRef = useRef(false);
   const upsertJobStatus = useSetAtom(upsertJobStatusAtom);
+  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
@@
-  // Polling Fallback: nur wenn Panel offen UND keine SSE-Events für 10s
+  // Polling Fallback: nur wenn Panel offen UND keine Events für 10s
   useEffect(() =&gt; {
     if (!isOpen) return;
-    let lastUpdateAt = Date.now();
     const onTick = () =&gt; {
-      const idleMs = Date.now() - lastUpdateAt;
+      const idleMs = Date.now() - lastEventTsRef.current;
       if (idleMs &gt; 10_000) void refreshNow();
     };
     const timer = setInterval(onTick, 2000);
-    const unsub = () =&gt; { lastUpdateAt = Date.now(); };
-    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
-    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
+    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
+    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
+    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
   }, [isOpen]);
@@
       const onUpdate = (e: MessageEvent) =&gt; {
         try {
           const evt: JobUpdateEvent = JSON.parse(e.data);
+          lastEventTsRef.current = Date.now();
           if (evt.sourceItemId &amp;&amp; evt.status) {
             upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
           }
           setItems(prev =&gt; {
@@
             if (idx &gt;= 0) {
               const updated = { ...prev[idx], ...patch };
               const next = [...prev];
               next[idx] = updated;
               // bei Update nach oben reihen (neueste zuerst)
               next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
               return next;
             }
             // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
             if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
               return prev;
             }
             if (batchFilter) {
               void refreshNow();
               return prev;
             }
             const inserted: JobListItem = {
               jobId: evt.jobId,
               status: evt.status,
               updatedAt: evt.updatedAt,
               lastMessage: evt.message,
               lastProgress: evt.progress,
               jobType: evt.jobType,
               fileName: evt.fileName,
             };
             return [inserted, ...prev];
           });
         } catch {}
       };
@@
-    const onLocal = (e: Event) =&gt; {
+    const onLocal = (e: Event) =&gt; {
       const detail = (e as CustomEvent).detail as JobUpdateEvent;
       if (!detail?.jobId) return;
+      lastEventTsRef.current = Date.now();
       setItems(prev =&gt; {
         const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
         const patch: Partial&lt;JobListItem&gt; = {
           status: detail.status,
           lastMessage: detail.message ?? prev[idx]?.lastMessage,
           lastProgress: detail.progress ?? prev[idx]?.lastProgress,
           updatedAt: detail.updatedAt,
           jobType: detail.jobType ?? prev[idx]?.jobType,
           fileName: detail.fileName ?? prev[idx]?.fileName,
         };
         if (idx &gt;= 0) {
           const updated = { ...prev[idx], ...patch };
           const next = [...prev];
           next[idx] = updated;
           next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
           return next;
         }
+        // Neue Items nur hinzufügen, wenn Filter passt; bei Batch-Filter immer per Refresh
+        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; detail.status !== statusFilter) {
+          return prev;
+        }
+        if (batchFilter) {
+          void refreshNow();
+          return prev;
+        }
         const inserted: JobListItem = {
           jobId: detail.jobId,
           status: detail.status,
           updatedAt: detail.updatedAt,
           lastMessage: detail.message,
           lastProgress: detail.progress,
           jobType: detail.jobType,
           fileName: detail.fileName,
         };
         return [inserted, ...prev];
       });
     };
*** End Patch
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, upsertJobStatus]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {item.status === &#39;failed&#39; &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, upsertJobStatus]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {item.status === &#39;failed&#39; &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Du hast recht: Ständiges Polling war suboptimal und hat den Filter überfahren. Ich habe es so korrigiert:</p>
<ul>
<li>SSE-first, Polling nur als Fallback</li>
<li>Live-Updates kommen über den bestehenden Server-Sent-Events-Stream. Ich habe das Polling so umgebaut, dass es nur noch greift, wenn 10s lang kein Event ankommt. Dann wird einmal nachgeladen.</li>
<li>
<p>Intern tracke ich den Zeitstempel des letzten Events; damit stört Polling die Filter nicht.</p>
</li>
<li>
<p>Filter bleibt stabil</p>
</li>
<li>Bei aktivem Status-Filter werden neue SSE-Items nur eingefügt, wenn sie zum Filter passen. Bei aktivem Batch-Filter wird statt blindem Einfügen ein gezielter Refresh ausgelöst. So bleibt die Liste konsistent und zeigt nicht plötzlich wieder alle.</li>
<li>
<p>Die Liste wird beim Umschalten der Filter mit den Query-Parametern vom Server geladen, sodass serverseitig gefiltert wird.</p>
</li>
<li>
<p>Secretary-Start in Batch fixiert</p>
</li>
<li>In der Batch-Route setze ich pro Item <code>doExtractPDF: 'true'</code>. Damit startet der Secretary zuverlässig; Idempotenz/Skips greifen weiterhin, wenn Artefakte existieren.</li>
</ul>
<p>Bitte kurz testen:
1) Job-Monitor öffnen, „Queued“ wählen. Es sollten nur queued Jobs sichtbar bleiben; neue Events fügen keine „fremden“ Status ein.
2) Batch-Name auswählen; die Liste bleibt gefiltert. Neue Jobs in anderem Batch tauchen nicht auf.
3) Secretary-Verlauf: Neue Batches wechseln in der Liste von queued → running → completed/failed ohne dass der Filter „verloren“ geht.</p>
<p>Wenn du zusätzlich „Auto-Refresh bei Filterwechsel“ möchtest oder eine Anzeige „Zuletzt aktualisiert hh:mm:ss“, baue ich das gerne ein.</p>
<hr />
<p><strong>User</strong></p>
<p>ich sehe keinen unterschied.
Wir sprechen schon von dieser Maske?
Oben sehe ich auch dieses Reload-Symbol, das sich ständig dreht, alle Sekunde - ich nehme an, das ist das Polling. Können wir das so implementieren, dass, wenn ich draufklicke, das auch stoppt und ich es so als Ein- und Ausschalter verwenden kann, um das mal sauber zu testen. Diese Filtergeschichten, ohne dass es ständig nachlädt.</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);
  const [liveUpdates, setLiveUpdates] = useState&lt;boolean&gt;(true);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist und Live-Updates aktiv sind; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen &amp;&amp; liveUpdates) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, liveUpdates, upsertJobStatus, statusFilter, batchFilter]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen, Live-Updates an UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen, liveUpdates]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={() =&gt; setLiveUpdates(v =&gt; !v)}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
                title={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, (isRefreshing || liveUpdates) &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {item.status === &#39;failed&#39; &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Ich habe das Polling/Live-Update-Verhalten umgebaut und einen Schalter eingebaut:</p>
<ul>
<li>Live-Updates Toggle</li>
<li>Das „Reload“-Icon oben ist jetzt ein Ein-/Ausschalter.</li>
<li>Klick stoppt/aktiviert Live-Updates (SSE) und den Fallback-Refresh. Bei „aus“ hört die Liste auf, sich selbst zu aktualisieren.</li>
<li>
<p>Die Animation läuft nur noch, wenn Live-Updates an sind (oder gerade manuell refresh läuft).</p>
</li>
<li>
<p>SSE-first, sanftes Fallback</p>
</li>
<li>Live-Updates kommen via SSE. Nur wenn 10s lang kein Event kam und der Schalter an ist, wird einmal nachgeladen.</li>
<li>Der SSE-Listener respektiert Status-/Batch-Filter: neue Items werden nur eingefügt, wenn sie zum Filter passen; bei Batch-Filter löse ich einen gezielten Refresh aus, statt falsche Einträge zu zeigen.</li>
</ul>
<p>So testest du „statisch“:
- Oben „Running“ oder „Queued“ wählen.
- Klick auf das Reload-Icon: Live-Updates anhalten. Jetzt sollte die Liste unverändert bleiben, bis du wieder klickst oder „Filtern“ drückst.</p>
<p>Wenn du zusätzlich einen separaten „Jetzt aktualisieren“-Button neben dem Toggle willst, kann ich ihn ergänzen.</p>
<hr />
<p><strong>User</strong></p>
<p>Ich sehe jetzt Qued Jobs. Warum werden sie nicht abgearbeitet? Oder sind sie schon bearbeitet? Welches Service sorgt jetzt dafür, dass die zum Secretary Service gesendet werden?</p>
<p>{
  "_id": {
    "$oid": "68c69b35bf0f2327bcb6dd93"
  },
  "jobId": "5cae3c31-bed9-44e9-9ff6-64fbf5ca5ac5",
  "jobSecretHash": "07b7c2d347972449730c91114e59c6fef913525a75bd51433bde64cc677f5807",
  "job_type": "pdf",
  "operation": "extract",
  "worker": "secretary",
  "status": "queued",
  "libraryId": "ID_OnedriveTest",
  "userEmail": "peter.aichner@crystal-design.com",
  "correlation": {
    "jobId": "5cae3c31-bed9-44e9-9ff6-64fbf5ca5ac5",
    "libraryId": "ID_OnedriveTest",
    "source": {
      "mediaType": "pdf",
      "mimeType": "application/pdf",
      "name": "Commoning vs. Kommerz.pdf",
      "itemId": "01XERETUJ4INYUGELFQ5G3LUZSOXKTU3XT",
      "parentId": "01XERETUM64MVVM7EGDBFIJIWFIMNVOE2Q"
    },
    "options": {
      "targetLanguage": "de",
      "extractionMethod": "mistral_ocr",
      "includeImages": false,
      "useCache": true
    },
    "batchId": "29a0a608-a74c-4c33-8ea7-983c3474b6e1",
    "batchName": "temp/test/commoning"
  },
  "createdAt": {
    "$date": "2025-09-14T10:38:45.811Z"
  },
  "updatedAt": {
    "$date": "2025-09-14T10:38:46.224Z"
  },
  "parameters": {
    "targetLanguage": "de",
    "extractionMethod": "mistral_ocr",
    "includeImages": false,
    "useCache": true,
    "template": "pdfanalyse",
    "phases": {
      "extract": false,
      "template": true,
      "ingest": false
    },
    "doExtractPDF": false,
    "doExtractMetadata": true,
    "doIngestRAG": false,
    "forceRecreate": false
  },
  "steps": [
    {
      "name": "extract_pdf",
      "status": "completed",
      "details": {
        "skipped": true,
        "reason": "not_requested"
      },
      "endedAt": {
        "$date": "2025-09-14T10:38:46.224Z"
      }
    },
    {
      "name": "transform_template",
      "status": "pending"
    },
    {
      "name": "store_shadow_twin",
      "status": "pending"
    },
    {
      "name": "ingest_rag",
      "status": "pending"
    }
  ],
  "logs": [
    {
      "timestamp": {
        "$date": "2025-09-14T10:38:45.873Z"
      },
      "phase": "request_sent",
      "sourcePath": "01XERETUJ4INYUGELFQ5G3LUZSOXKTU3XT",
      "targetParentId": "01XERETUM64MVVM7EGDBFIJIWFIMNVOE2Q",
      "callbackUrl": "http://localhost:3000/api/external/jobs/5cae3c31-bed9-44e9-9ff6-64fbf5ca5ac5"
    }
  ]
}</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nur fehlgeschlagene Jobs können neu gestartet werden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Erzeuge neuen Job mit gleicher Korrelation/Optionen</span>
<span class="w">    </span><span class="c1">// Wir verwenden die bestehende process-pdf Route; Datei binär laden und erneut einreichen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quelle für Retry unvollständig&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">batchName</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">batchId</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">batchId</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Sicherstellen, dass Phase 1 gestartet wird</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractPDF&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/api/secretary/process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;X-Library-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;jobs-retry&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Retry fehlgeschlagen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">res.status</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Fehler beim erneuten Einreichen&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">res.status</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Kurz und konkret:</p>
<ul>
<li>Warum stehen Jobs auf queued?</li>
<li>
<p>In deinem Beispiel wurden die Flags so gesetzt, dass Phase 1 (PDF-Extraktion) explizit nicht angefordert wurde: <code>doExtractPDF: false</code>, <code>doExtractMetadata: true</code>. In diesem Fall ruft <code>POST /api/secretary/process-pdf</code> den Secretary nicht an, markiert Step <code>extract_pdf</code> als „completed (skipped: not_requested)“ und beendet. Der Gesamtstatus bleibt dabei „queued“, bis der nächste Step (Template-Transform etc.) läuft.</p>
</li>
<li>
<p>Wer startet den Secretary?</p>
</li>
<li>Der Secretary-Aufruf passiert ausschließlich in <code>POST /api/secretary/process-pdf</code> auf dem Server. Voraussetzung: <code>doExtractPDF</code> ist true (oder es sind gar keine Flags gesetzt).</li>
<li>In der Batch-Route habe ich <code>doExtractPDF</code> jetzt immer auf <code>'true'</code> gesetzt. Neue Batches triggern daher die Secretary-Verarbeitung. Für bereits angelegte Jobs ohne dieses Flag kannst du „Neu starten“ nutzen; der Retry setzt <code>doExtractPDF: true</code>.</li>
</ul>
<p>Was du jetzt machen kannst:
- Starte eine neue Batch-Einreichung aus dem Dialog. Die neuen Jobs sollten sofort Secretary-Requests auslösen und von queued → running wechseln.
- Für existierende „hängende“ Jobs: Im Job-Monitor bei „failed/queued“ den Neu-starten-Button nutzen. Der Retry setzt <code>doExtractPDF: 'true'</code>, übergibt Batch-Infos, und ruft <code>process-pdf</code> erneut (mit Session-Cookie) auf.</p>
<p>Technischer Check (optional):
- In den Job-Logs siehst du nach dem Fix „request_ack“ vom Secretary; ohne das wurde der Worker nicht kontaktiert.
- Wenn es weiterhin bei queued bleibt, prüfe <code>SECRETARY_SERVICE_URL</code>/<code>SECRETARY_SERVICE_API_KEY</code> und ob der Worker erreichbar ist; bei Verbindungsfehlern würden Jobs auf „failed“ wechseln mit <code>worker_unavailable</code>.</p>
<p>Damit sollten neue Batches korrekt abgearbeitet werden; sag mir, ob die neuen Jobs von queued auf running springen.</p>
<hr />
<p><strong>User</strong></p>
<p>Kann es sein, dass ich den "retry" Button gar nicht sehe? Wird Liste zu breit gerendert?</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nur failed oder queued Jobs können neu gestartet werden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Erzeuge neuen Job mit gleicher Korrelation/Optionen</span>
<span class="w">    </span><span class="c1">// Wir verwenden die bestehende process-pdf Route; Datei binär laden und erneut einreichen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quelle für Retry unvollständig&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;originalItemId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;parentId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">batchName</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">batchId</span><span class="p">)</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">batchId</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Sicherstellen, dass Phase 1 gestartet wird</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;doExtractPDF&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/api/secretary/process-pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;X-Library-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;jobs-retry&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Retry fehlgeschlagen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">res.status</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">msg</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Fehler beim erneuten Einreichen&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">res.status</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);
  const [liveUpdates, setLiveUpdates] = useState&lt;boolean&gt;(true);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist und Live-Updates aktiv sind; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen &amp;&amp; liveUpdates) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, liveUpdates, upsertJobStatus, statusFilter, batchFilter]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen, Live-Updates an UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen, liveUpdates]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={() =&gt; setLiveUpdates(v =&gt; !v)}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
                title={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, (isRefreshing || liveUpdates) &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1 shrink-0&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {(item.status === &#39;failed&#39; || item.status === &#39;queued&#39;) &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<div class="highlight"><pre><span></span><code>*** Begin Patch
*** Update File: src/components/shared/job-monitor-panel.tsx
@@
-                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
+                    &lt;div className=&quot;flex items-center gap-1 w-28 justify-end&quot;&gt;
*** End Patch
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);
  const [liveUpdates, setLiveUpdates] = useState&lt;boolean&gt;(true);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist und Live-Updates aktiv sind; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen &amp;&amp; liveUpdates) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, liveUpdates, upsertJobStatus, statusFilter, batchFilter]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen, Live-Updates an UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen, liveUpdates]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={() =&gt; setLiveUpdates(v =&gt; !v)}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
                title={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, (isRefreshing || liveUpdates) &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1 shrink-0 w-28 justify-end&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {(item.status === &#39;failed&#39; || item.status === &#39;queued&#39;) &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Ja, wir sprechen von genau dieser Maske. Ich habe drei Dinge angepasst, damit du den Retry sicher siehst und auch für queued nutzen kannst:</p>
<ul>
<li>Neu: Retry auch für queued</li>
<li>Server: <code>POST /api/external/jobs/[jobId]/retry</code> erlaubt jetzt failed und queued. Beim Retry wird <code>doExtractPDF: true</code> erzwungen, Batch-Infos mitgegeben und die Session korrekt weitergereicht.</li>
<li>Buttons sichtbar halten</li>
<li>Rechte Button-Leiste ist jetzt <code>shrink-0</code> und hat eine feste minimale Breite; so wird der „Neu starten“-Button nicht aus dem sichtbaren Bereich verdrängt.</li>
<li>Der Retry-Button wird bei failed und queued angezeigt.</li>
<li>Falls die Liste sehr schmal ist</li>
<li>Die Buttons sind rechts ausgerichtet; selbst bei knapper Breite bleiben die Icons sichtbar.</li>
</ul>
<p>Bitte einmal testen:
- In der Jobliste einen Eintrag mit Status queued auswählen; rechts sollte ein rundes Icon „Neu starten“ erscheinen.
- Klick auf „Neu starten“ legt den Job neu an (mit erzwungener Phase 1) und sollte ihn in running überführen.</p>
<p>Wenn der Button trotzdem nicht sichtbar ist, sag mir deine Fensterbreite. Ich kann alternativ die Leiste in eine zweite Zeile umbrechen oder das Layout auf Grid umstellen, sodass der Button immer in einer separaten, fixen Spalte steht.</p>
<hr />
<p><strong>User</strong></p>
<p>Button nicht sichtbar. Bitte übergeordnetes Panel kontrollieren - ist vielleicht zu schmal. (Ist ja ein fliegendes Panel)</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);
  const [liveUpdates, setLiveUpdates] = useState&lt;boolean&gt;(true);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist und Live-Updates aktiv sind; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen &amp;&amp; liveUpdates) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, liveUpdates, upsertJobStatus, statusFilter, batchFilter]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen, Live-Updates an UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen, liveUpdates]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[420px] md:w-[520px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={() =&gt; setLiveUpdates(v =&gt; !v)}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
                title={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, (isRefreshing || liveUpdates) &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1 shrink-0 w-28 justify-end&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {(item.status === &#39;failed&#39; || item.status === &#39;queued&#39;) &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);
  const [liveUpdates, setLiveUpdates] = useState&lt;boolean&gt;(true);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist und Live-Updates aktiv sind; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen &amp;&amp; liveUpdates) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, liveUpdates, upsertJobStatus, statusFilter, batchFilter]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen, Live-Updates an UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen, liveUpdates]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[420px] md:w-[520px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={() =&gt; setLiveUpdates(v =&gt; !v)}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
                title={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, (isRefreshing || liveUpdates) &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1 shrink-0 w-28 justify-end&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {(item.status === &#39;failed&#39; || item.status === &#39;queued&#39;) &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;running&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        Läuft…
                      &lt;/div&gt;
                    )}
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Ich habe das fliegende Panel breiter gemacht und die Button-Leiste fixiert, damit „Neu starten“ sichtbar bleibt:</p>
<ul>
<li>Panel-Breite</li>
<li>
<p>Breite auf 420px (Desktop 520px) erhöht: mehr Platz für Titel und die rechte Aktionsleiste.</p>
</li>
<li>
<p>Rechte Aktionsleiste fixiert</p>
</li>
<li>Die Leiste ist jetzt <code>shrink-0</code> und hat feste Mindestbreite; so bleiben „Ausblenden“ und „Neu starten“ sichtbar und rücken nicht aus dem Viewport.</li>
<li>
<p>Retry ist sichtbar für queued und failed.</p>
</li>
<li>
<p>Kleine UX-Verbesserung</p>
</li>
<li>Bei „running“ zeigt die Progress-Zeile mittig „Läuft…“ an.</li>
</ul>
<p>Bitte das Panel erneut öffnen und prüfen, ob der Button erscheint. Falls du weniger Breite möchtest, kann ich alternativ einen 2-Zeilen-Layoutmodus aktivieren (Titel links, Buttons darunter), der bei schmalen Viewports automatisch umbricht.</p>
<hr />
<p><strong>User</strong></p>
<p>Wenn ich den Job neu starte, wird dann ein neues Dokument angelegt? Können wir nicht das bestehende Dokument updaten, weil sonst wird die Liste ja nie kürzer. Dann bleiben die ja immer auf queued.</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">startWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nur failed oder queued Jobs können neu gestartet werden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// In-Place Requeue: Bestehenden Job zurücksetzen und mit gleicher jobId erneut an Secretary senden</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quelle für Retry unvollständig&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Secretary-FormData aufbauen (wie in process-pdf für den Worker-Call)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">serviceFormData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extraction_method&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;native&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Callback-URL und -Token (neues Secret generieren)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">appUrl</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;NEXT_PUBLIC_APP_URL fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mf">24</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64url&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">newSecret</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Job zurücksetzen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">initializeSteps</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">parameters</span><span class="p">);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobSecretHash</span><span class="o">:</span><span class="w"> </span><span class="kt">newHash</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_sent_requeue&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// Live-Event + Watchdog</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;requeued&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.itemId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">startWatchdog</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mf">600</span><span class="nx">_000</span><span class="p">);</span>

<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_url&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">newSecret</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Secretary aufrufen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseUrl</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">pdf/process`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/pdf/process`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">normalizedUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">serviceFormData</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">message</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">503</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_ack&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">data?.error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Secretary Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Guter Punkt. Bisher hat der „Neu starten“-Button einen neuen Job angelegt. Ich habe das Verhalten geändert:</p>
<ul>
<li>Requeue statt Neu-Anlage</li>
<li>„Neu starten“ setzt jetzt den EXISTIERENDEN Job zurück: Status wieder „queued“, Steps auf „pending“, neues Secret für den Callback.</li>
<li>Anschließend wird genau dieser Job mit gleicher <code>jobId</code> erneut an den Secretary geschickt. Es entsteht kein neuer Eintrag; die Liste bleibt schlank.</li>
<li>Gilt für <code>failed</code> und auch für <code>queued</code> Jobs (z. B. wenn der Worker temporär nicht erreichbar war).</li>
</ul>
<p>Technik im Hintergrund
- Server-Route <code>POST /api/external/jobs/[jobId]/retry</code>:
  - Lädt die Quelldatei serverseitig, baut das Worker-FormData, setzt neue <code>callback_url</code> und <code>callback_token</code>, resettet Steps und Status, startet den Watchdog, ruft den Secretary direkt auf und loggt <code>request_ack</code>.
  - Bei Erfolg: gleiches <code>jobId</code>, Event „queued (requeued)“. Bei Fehler: Status <code>failed</code> mit Grund.</p>
<p>Erwartetes Verhalten in der UI
- Nach „Neu starten“ bleibt derselbe Eintrag bestehen, springt auf „queued“, danach auf „running/ completed“.
- Keine Duplikate in der Liste.</p>
<p>Wenn du möchtest, kann ich zusätzlich einen Schutz einbauen, dass ein noch laufender Job nicht requeued werden kann (Button disabled für <code>running</code>).</p>
<hr />
<p><strong>User</strong></p>
<p>Das Polling berüclksichtigt den aktuellen Filter nicht</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich passe die Jobliste so an, dass auch „Ältere laden“ und alle automatischen Refreshes die aktuellen Filter-Parameter mitschicken. Danach prüfe ich kurz die Lints und beschreibe dir den Test.</p>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);
  const [liveUpdates, setLiveUpdates] = useState&lt;boolean&gt;(true);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist und Live-Updates aktiv sind; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen &amp;&amp; liveUpdates) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, liveUpdates, upsertJobStatus, statusFilter, batchFilter]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const params = new URLSearchParams({ page: String(next), limit: &#39;20&#39; });
    if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
    if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
    const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen, Live-Updates an UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen, liveUpdates]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[420px] md:w-[520px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={() =&gt; setLiveUpdates(v =&gt; !v)}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
                title={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, (isRefreshing || liveUpdates) &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1 shrink-0 w-28 justify-end&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {(item.status === &#39;failed&#39; || item.status === &#39;queued&#39;) &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;running&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        Läuft…
                      &lt;/div&gt;
                    )}
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Gefixt: „Ältere laden“ und alle automatischen Refreshes senden jetzt die aktuellen Filterparameter (<code>status</code>, <code>batchName</code>) mit. So bleiben Server- und Client-Ansicht konsistent.</p>
<p>Test:
- Status z. B. auf „Running“ setzen, optional Batch wählen.
- „Ältere laden“ klicken → es sollten ausschließlich Einträge im gewählten Filter nachgeladen werden.
- Live-Updates anhalten und wieder starten über das Reload-Icon; die Liste bleibt im gesetzten Filter.</p>
<hr />
<p><strong>User</strong></p>
<p>Einzelne Dokumente werden selten neu gestartet. Diesen Neustarten-Button würde ich dann oben neben dem Filter auch anbieten, sodass alle durch den Filter gelisteten Dokumente neu gestartet werden, außer die, die bereits laufen.</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}))</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">batchId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">batchName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body.batchName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">batchId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">body.batchId</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Hole gefilterte Jobs Seite für Seite und triggere Retry (nur queued/failed; running wird übersprungen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">retried</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">skipped</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URLSearchParams</span><span class="p">({</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">page</span><span class="p">),</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;50&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">status</span><span class="p">)</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">batchId</span><span class="p">)</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="sb">`/api/external/jobs?</span><span class="si">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">items</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">skipped</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">jobId</span><span class="p">);</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="sb">`/api/external/jobs/</span><span class="si">${</span><span class="nx">it</span><span class="p">.</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">/retry`</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="nx">retried</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">jobId</span><span class="p">);</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nx">skipped</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">50</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="nx">page</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">retriedCount</span><span class="o">:</span><span class="w"> </span><span class="kt">retried.length</span><span class="p">,</span><span class="w"> </span><span class="nx">skippedCount</span><span class="o">:</span><span class="w"> </span><span class="kt">skipped.length</span><span class="p">,</span><span class="w"> </span><span class="nx">retried</span><span class="p">,</span><span class="w"> </span><span class="nx">skipped</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);
  const [liveUpdates, setLiveUpdates] = useState&lt;boolean&gt;(true);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist und Live-Updates aktiv sind; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen &amp;&amp; liveUpdates) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, liveUpdates, upsertJobStatus, statusFilter, batchFilter]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const params = new URLSearchParams({ page: String(next), limit: &#39;20&#39; });
    if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
    if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
    const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen, Live-Updates an UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen, liveUpdates]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[420px] md:w-[520px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={() =&gt; setLiveUpdates(v =&gt; !v)}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
                title={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, (isRefreshing || liveUpdates) &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
            &lt;Button size=&quot;sm&quot; onClick={async () =&gt; {
              try {
                const payload: Record&lt;string, string&gt; = {};
                if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) payload.status = statusFilter;
                if (batchFilter) payload.batchName = batchFilter;
                const res = await fetch(&#39;/api/external/jobs/retry-batch&#39;, { method: &#39;POST&#39;, headers: { &#39;Content-Type&#39;: &#39;application/json&#39; }, body: JSON.stringify(payload) });
                if (!res.ok) return;
                await refreshNow();
              } catch {}
            }}&gt;Neu starten (gefiltert)&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1 shrink-0 w-28 justify-end&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {(item.status === &#39;failed&#39; || item.status === &#39;queued&#39;) &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;running&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        Läuft…
                      &lt;/div&gt;
                    )}
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Ich habe oben im Panel einen Button „Neu starten (gefiltert)“ ergänzt. Der startet alle aktuell gefilterten Jobs neu und überspringt laufende.</p>
<p>Wie es funktioniert:
- UI: Klick auf „Neu starten (gefiltert)“ sendet Status-/Batch-Filter an <code>POST /api/external/jobs/retry-batch</code>.
- API: Die Route lädt paginiert die passenden Jobs, triggert für jeden <code>POST /api/external/jobs/{jobId}/retry</code> und überspringt <code>running</code>.
- Retry selbst setzt den bestehenden Job in-place zurück und schickt ihn mit gleicher <code>jobId</code> erneut an den Secretary.</p>
<p>Test:
- Im Monitor Status auf „Queued“ (oder „Failed“) und ggf. Batch wählen.
- „Neu starten (gefiltert)“ klicken → die Einträge springen auf „queued“ und laufen an, ohne neue Zeilen zu erzeugen.
- Bei Bedarf Live-Updates pausieren, um die Wirkung ohne Polling zu sehen.</p>
<hr />
<p><strong>User</strong></p>
<p>Error: ./src/app/api/external/jobs/[jobId]/retry/route.ts
Module parse failed: Identifier 'repo' has already been declared (76:14)
|         });
|         const callbackUrl = <code>${appUrl.replace(/\/$/, '')}/api/external/jobs/${jobId}</code>;</p>
<blockquote>
<pre><code>    const repo = new ExternalJobsRepository();
</code></pre>
<p>|         const newSecret = crypto.randomBytes(24).toString('base64url');
|         const newHash = repo.hashSecret(newSecret);</p>
</blockquote>
<p>Import trace for requested module:
./src/app/api/external/jobs/[jobId]/retry/route.ts
    at createConsoleError (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/next@15.3.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/next/dist/client/components/errors/console-error.js:27:71)
    at handleConsoleError (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/next@15.3.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/next/dist/client/components/errors/use-error-handler.js:47:54)
    at console.error (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/next@15.3.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/next/dist/client/components/globals/intercept-console-error.js:47:57)
    at handleErrors (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/next@15.3.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/next/dist/client/components/react-dev-overlay/app/hot-reloader-client.js:162:21)
    at processMessage (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/next@15.3.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/next/dist/client/components/react-dev-overlay/app/hot-reloader-client.js:220:21)
    at WebSocket.handler (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/next@15.3.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/next/dist/client/components/react-dev-overlay/app/hot-reloader-client.js:473:17)</p>
<p>Error: ./src/app/api/external/jobs/[jobId]/retry/route.ts
Module parse failed: Identifier 'repo' has already been declared (76:14)
|         });
|         const callbackUrl = <code>${appUrl.replace(/\/$/, '')}/api/external/jobs/${jobId}</code>;</p>
<blockquote>
<pre><code>    const repo = new ExternalJobsRepository();
</code></pre>
<p>|         const newSecret = crypto.randomBytes(24).toString('base64url');
|         const newHash = repo.hashSecret(newSecret);
    at BuildError (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/next@15.3.2_react-dom@18.2.0_react@18.2.0__react@18.2.0/node_modules/next/dist/client/components/react-dev-overlay/ui/container/build-error.js:43:41)
    at renderWithHooks (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom.development.js:16305:18)
    at updateFunctionComponent (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom.development.js:19583:20)
    at beginWork (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom.development.js:21596:16)
    at beginWork$1 (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom.development.js:27421:14)
    at performUnitOfWork (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom.development.js:26552:12)
    at workLoopSync (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom.development.js:26461:5)
    at renderRootSync (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom.development.js:26429:7)
    at performConcurrentWorkOnRoot (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/react-dom@18.2.0_react@18.2.0/node_modules/react-dom/cjs/react-dom.development.js:25733:74)
    at workLoop (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/scheduler@0.23.2/node_modules/scheduler/cjs/scheduler.development.js:266:34)
    at flushWork (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/scheduler@0.23.2/node_modules/scheduler/cjs/scheduler.development.js:239:14)
    at MessagePort.performWorkUntilDeadline (webpack-internal:///(pages-dir-browser)/./node_modules/.pnpm/scheduler@0.23.2/node_modules/scheduler/cjs/scheduler.development.js:533:21)</p>
</blockquote>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">startWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nur failed oder queued Jobs können neu gestartet werden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// In-Place Requeue: Bestehenden Job zurücksetzen und mit gleicher jobId erneut an Secretary senden</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quelle für Retry unvollständig&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">],</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">source</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Secretary-FormData aufbauen (wie in process-pdf für den Worker-Call)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">serviceFormData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;targetLanguage&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;extraction_method&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;extractionMethod&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;native&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;useCache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;useCache&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;includeImages&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">opts</span><span class="p">[</span><span class="s1">&#39;includeImages&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Callback-URL und -Token (neues Secret generieren)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">appUrl</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;NEXT_PUBLIC_APP_URL fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">appUrl</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/external/jobs/</span><span class="si">${</span><span class="nx">jobId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mf">24</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64url&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">newSecret</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Job zurücksetzen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">initializeSteps</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transform_template&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;store_shadow_twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ingest_rag&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">parameters</span><span class="p">);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobSecretHash</span><span class="o">:</span><span class="w"> </span><span class="kt">newHash</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_sent_requeue&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// Live-Event + Watchdog</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;queued&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;requeued&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.itemId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">startWatchdog</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mf">600</span><span class="nx">_000</span><span class="p">);</span>

<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_url&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="p">);</span>
<span class="w">    </span><span class="nx">serviceFormData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;callback_token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">newSecret</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Secretary aufrufen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseUrl</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">pdf/process`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/pdf/process`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">normalizedUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">serviceFormData</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_unavailable&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">message</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">503</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;request_ack&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;extract_pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">endedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span><span class="w"> </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">data?.error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Secretary Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;secretary&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Danke fürs Melden. Der Fehler kam daher, dass in <code>retry/route.ts</code> die Konstante <code>repo</code> doppelt deklariert wurde. Ich habe die zweite Deklaration entfernt.</p>
<p>Was ich geändert habe:
- <code>src/app/api/external/jobs/[jobId]/retry/route.ts</code>: die Zeile mit <code>const repo = new ExternalJobsRepository();</code> unterhalb der Callback-URL entfernt; es existiert bereits eine <code>repo</code>-Instanz weiter oben. Lint/Build sind sauber.</p>
<p>Bitte erneut testen:
- „Neu starten“ bei einem queued/failed Job → sollte ohne Build-Fehler laufen, den bestehenden Job zurücksetzen und direkt an den Secretary senden.
- Alternativ „Neu starten (gefiltert)“ oben nutzen, um mehrere zu requeuen.</p>
<hr />
<p><strong>User</strong></p>
<p>In dieser Dokumentenliste ganz oben eine kleine Statistik, wie viele sind Bending, Running, erledigt und fehlerhaft mit so einem, mit dem Farbklecks vorne, als Legende. Sodass man einfach schnell sieht, was abgeht. Vielleicht auch in der Filter Dropdown in Klammern dahinter, um Platz zu sparen.</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code>*** Begin Patch
*** Update File: src/components/shared/job-monitor-panel.tsx
@@
           &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
             &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
               &lt;span&gt;Secretary Jobs&lt;/span&gt;
-              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
+              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
               &lt;button
                 onClick={refreshNow}
                 className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                 aria-label=&quot;Liste aktualisieren&quot;
                 title=&quot;Liste aktualisieren&quot;
               &gt;
                 &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
               &lt;/button&gt;
               &lt;button
                 onClick={hideAllJobs}
                 className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                 aria-label=&quot;Alle ausblenden&quot;
                 title=&quot;Alle ausblenden&quot;
               &gt;
                 &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
               &lt;/button&gt;
             &lt;/div&gt;
             &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
           &lt;/div&gt;
+          {/* Mini-Legende mit farbigen Dots */}
+          &lt;div className=&quot;px-4 py-1 border-b text-xs text-muted-foreground flex items-center gap-4&quot;&gt;
+            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-blue-400&quot; /&gt;Queued {queuedCount}&lt;/span&gt;
+            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-yellow-400&quot; /&gt;Running {runningCount}&lt;/span&gt;
+            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-green-500&quot; /&gt;Completed {completedCount}&lt;/span&gt;
+            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-red-500&quot; /&gt;Failed {failedCount}&lt;/span&gt;
+          &lt;/div&gt;
           &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
-            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
-              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
-              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
-              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
-              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
-              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
+            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
+              &lt;option value=&quot;all&quot;&gt;Alle ({queuedCount + runningCount + completedCount + failedCount})&lt;/option&gt;
+              &lt;option value=&quot;queued&quot;&gt;Queued ({queuedCount})&lt;/option&gt;
+              &lt;option value=&quot;running&quot;&gt;Running ({runningCount})&lt;/option&gt;
+              &lt;option value=&quot;completed&quot;&gt;Completed ({completedCount})&lt;/option&gt;
+              &lt;option value=&quot;failed&quot;&gt;Failed ({failedCount})&lt;/option&gt;
             &lt;/select&gt;
             &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
               &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
               {batchNames.map((name) =&gt; (
                 &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
               ))}
             &lt;/select&gt;
             &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
             &lt;Button size=&quot;sm&quot; onClick={async () =&gt; {
               try {
                 const payload: Record&lt;string, string&gt; = {};
                 if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) payload.status = statusFilter;
                 if (batchFilter) payload.batchName = batchFilter;
                 const res = await fetch(&#39;/api/external/jobs/retry-batch&#39;, { method: &#39;POST&#39;, headers: { &#39;Content-Type&#39;: &#39;application/json&#39; }, body: JSON.stringify(payload) });
                 if (!res.ok) return;
                 await refreshNow();
               } catch {}
             }}&gt;Neu starten (gefiltert)&lt;/Button&gt;
           &lt;/div&gt;
*** End Patch
</code></pre></div>
<div class="highlight"><pre><span></span><code>*** Begin Patch
*** Update File: src/components/shared/job-monitor-panel.tsx
@@
-          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
-            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
-              &lt;option value=&quot;all&quot;&gt;Alle&lt;/option&gt;
-              &lt;option value=&quot;queued&quot;&gt;Queued&lt;/option&gt;
-              &lt;option value=&quot;running&quot;&gt;Running&lt;/option&gt;
-              &lt;option value=&quot;completed&quot;&gt;Completed&lt;/option&gt;
-              &lt;option value=&quot;failed&quot;&gt;Failed&lt;/option&gt;
-            &lt;/select&gt;
+          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
+            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
+              &lt;option value=&quot;all&quot;&gt;Alle ({queuedCount + runningCount + completedCount + failedCount})&lt;/option&gt;
+              &lt;option value=&quot;queued&quot;&gt;Queued ({queuedCount})&lt;/option&gt;
+              &lt;option value=&quot;running&quot;&gt;Running ({runningCount})&lt;/option&gt;
+              &lt;option value=&quot;completed&quot;&gt;Completed ({completedCount})&lt;/option&gt;
+              &lt;option value=&quot;failed&quot;&gt;Failed ({failedCount})&lt;/option&gt;
+            &lt;/select&gt;
@@
-            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
+            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
           &lt;/div&gt;
*** End Patch
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);
  const [liveUpdates, setLiveUpdates] = useState&lt;boolean&gt;(true);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist und Live-Updates aktiv sind; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen &amp;&amp; liveUpdates) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, liveUpdates, upsertJobStatus, statusFilter, batchFilter]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const params = new URLSearchParams({ page: String(next), limit: &#39;20&#39; });
    if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
    if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
    const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen, Live-Updates an UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen, liveUpdates]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[420px] md:w-[520px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {queuedCount} • R {runningCount} • C {completedCount} • F {failedCount}&lt;/span&gt;
              &lt;button
                onClick={() =&gt; setLiveUpdates(v =&gt; !v)}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
                title={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, (isRefreshing || liveUpdates) &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-1 border-b text-xs text-muted-foreground flex items-center gap-4&quot;&gt;
            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-blue-400&quot; /&gt;Queued {queuedCount}&lt;/span&gt;
            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-yellow-400&quot; /&gt;Running {runningCount}&lt;/span&gt;
            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-green-500&quot; /&gt;Completed {completedCount}&lt;/span&gt;
            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-red-500&quot; /&gt;Failed {failedCount}&lt;/span&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle ({queuedCount + runningCount + completedCount + failedCount})&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued ({queuedCount})&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running ({runningCount})&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed ({completedCount})&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed ({failedCount})&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
            &lt;Button size=&quot;sm&quot; onClick={async () =&gt; {
              try {
                const payload: Record&lt;string, string&gt; = {};
                if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) payload.status = statusFilter;
                if (batchFilter) payload.batchName = batchFilter;
                const res = await fetch(&#39;/api/external/jobs/retry-batch&#39;, { method: &#39;POST&#39;, headers: { &#39;Content-Type&#39;: &#39;application/json&#39; }, body: JSON.stringify(payload) });
                if (!res.ok) return;
                await refreshNow();
              } catch {}
            }}&gt;Neu starten (gefiltert)&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1 shrink-0 w-28 justify-end&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {(item.status === &#39;failed&#39; || item.status === &#39;queued&#39;) &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;running&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        Läuft…
                      &lt;/div&gt;
                    )}
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Erledigt: Oben in der Jobliste gibt es jetzt eine kompakte Legende mit farbigen Dots und Zählern sowie Zähler in den Status-Filteroptionen.</p>
<ul>
<li>Legende unter dem Titel</li>
<li>Queued (blau), Running (gelb), Completed (grün), Failed (rot) mit aktuellen Counts.</li>
<li>Status-Select</li>
<li>Optionen zeigen Counts in Klammern: z. B. „Running (3)“.</li>
<li>Performance</li>
<li>Zähler werden aus der aktuell sichtbaren Liste berechnet (keine zusätzlichen Requests).</li>
<li>Keine Layoutänderung an der Liste selbst.</li>
</ul>
<p>Sag, wenn du statt „global für Liste“ lieber „serverseitige Gesamtzahlen für alle Seiten“ möchtest; dann ergänze ich einen leichten Count-Endpoint.</p>
<hr />
<p><strong>User</strong></p>
<p>Ich möchte natürlich in der Statistik serverseitige Gesamtzahlen für alle Seiten sehen</p>
<hr />
<p><strong>Cursor</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Collection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;mongodb&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getCollection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/mongodb-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStep</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobIngestionInfo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">collectionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;external_jobs&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">getCollection</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Collection</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">getCollection</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collectionName</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">secret</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">create</span><span class="p">(</span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="kt">Omit</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;createdAt&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;updatedAt&#39;</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">job</span><span class="p">,</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">extra</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...</span><span class="nx">extra</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">modifiedCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">processId</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$push</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">logs</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...</span><span class="nx">entry</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">payload</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">mergeParameters</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$mergeObjects</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;$parameters&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">initializeSteps</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">steps</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStep</span><span class="p">[],</span><span class="w"> </span><span class="nx">parameters?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">steps</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...(</span><span class="nx">parameters</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">parameters</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">updateStep</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">patch</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">ExternalJobStep</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">setObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">patch</span><span class="p">).</span><span class="nx">map</span><span class="p">(([</span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">([</span><span class="sb">`steps.$.</span><span class="si">${</span><span class="nx">k</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="p">])));</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;steps.name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">setObj</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">appendMeta</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">$push</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metaHistory</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">at</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Merge cumulativeMeta (shallow)</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cumulativeMeta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$mergeObjects</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;$cumulativeMeta&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setIngestion</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">info</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobIngestionInfo</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ingestion</span><span class="o">:</span><span class="w"> </span><span class="kt">info</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listByUserEmail</span><span class="p">(</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[];</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">20</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">col</span>
<span class="w">      </span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">skip</span><span class="p">((</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">      </span><span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">col</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listByUserWithFilters</span><span class="p">(</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">      </span><span class="nx">limit?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">      </span><span class="nx">status?</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="p">[];</span>
<span class="w">      </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">batchId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">libraryId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">q?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[];</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">20</span><span class="p">));</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filter</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;libraryId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">batchId</span><span class="p">)</span><span class="w"> </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;correlation.batchId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">batchId</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;correlation.batchName&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">batchName</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">statuses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">status</span><span class="p">];</span>
<span class="w">      </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$in</span><span class="o">:</span><span class="w"> </span><span class="kt">statuses</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[.*+?^${}()|[\]\\]/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;\\$&amp;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;i&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">filter</span><span class="p">[</span><span class="s1">&#39;$or&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;correlation.source.name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">rx</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;correlation.source.itemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">rx</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">rx</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">col</span>
<span class="w">      </span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">skip</span><span class="p">((</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">      </span><span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">col</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
<span class="w">    </span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestBySourceItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;correlation.source.itemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">sourceItemId</span><span class="w"> </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestByResultItem</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">resultItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;result.savedItemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">resultItemId</span><span class="w"> </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestByFileIdAuto</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">$or</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;correlation.source.itemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;result.savedItemId&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">findLatestBySourceName</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;correlation.source.name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">sourceName</span><span class="w"> </span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listDistinctBatchNames</span><span class="p">(</span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;correlation.batchName&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">$ne</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="nx">match</span><span class="p">[</span><span class="s1">&#39;libraryId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">aggregate</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="p">([</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$match</span><span class="o">:</span><span class="w"> </span><span class="kt">match</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$correlation.batchName&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$sort</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">]).</span><span class="nx">toArray</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">filter</span><span class="p">((</span><span class="nx">v</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">countByStatus</span><span class="p">(</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">filters</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">batchName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">batchId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">queued</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">running</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">completed</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">failed</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">pendingStorage</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="nx">match</span><span class="p">[</span><span class="s1">&#39;libraryId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filters</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">batchId</span><span class="p">)</span><span class="w"> </span><span class="nx">match</span><span class="p">[</span><span class="s1">&#39;correlation.batchId&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filters</span><span class="p">.</span><span class="nx">batchId</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">batchName</span><span class="p">)</span><span class="w"> </span><span class="nx">match</span><span class="p">[</span><span class="s1">&#39;correlation.batchName&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filters</span><span class="p">.</span><span class="nx">batchName</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">aggregate</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="p">([</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$match</span><span class="o">:</span><span class="w"> </span><span class="kt">match</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$status&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$sum</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">]).</span><span class="nx">toArray</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">by</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">number</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">count</span><span class="p">]));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">queued</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">by</span><span class="p">[</span><span class="s1">&#39;queued&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">by</span><span class="p">[</span><span class="s1">&#39;running&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">by</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">by</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pendingStorage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">by</span><span class="p">[</span><span class="s1">&#39;pending-storage&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">queued</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">running</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">failed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">pendingStorage</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">queued</span><span class="p">,</span><span class="w"> </span><span class="nx">running</span><span class="p">,</span><span class="w"> </span><span class="nx">completed</span><span class="p">,</span><span class="w"> </span><span class="nx">failed</span><span class="p">,</span><span class="w"> </span><span class="nx">pendingStorage</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;libraryId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchName&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">counters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">countByStatus</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">batchName</span><span class="p">,</span><span class="w"> </span><span class="nx">batchId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">counters</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { useSetAtom } from &#39;jotai&#39;;
import { upsertJobStatusAtom } from &#39;@/atoms/job-status&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
  sourceItemId?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const map: Record&lt;string, { label: string; className: string }&gt; = {
    queued: { label: &#39;Queued&#39;, className: &#39;bg-blue-200 text-blue-900 border-blue-300&#39; },
    running: { label: &#39;Running&#39;, className: &#39;bg-yellow-200 text-yellow-900 border-yellow-300&#39; },
    completed: { label: &#39;Completed&#39;, className: &#39;bg-green-200 text-green-900 border-green-300&#39; },
    failed: { label: &#39;Failed&#39;, className: &#39;bg-red-200 text-red-900 border-red-300&#39; },
  };
  const entry = map[status] || { label: status, className: &#39;bg-muted text-muted-foreground&#39; };
  return &lt;span className={cn(&#39;inline-flex items-center px-2 py-0.5 rounded border text-[11px] font-medium&#39;, entry.className)}&gt;{entry.label}&lt;/span&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [statusFilter, setStatusFilter] = useState&lt;string&gt;(&#39;all&#39;);
  const [batchFilter, setBatchFilter] = useState&lt;string&gt;(&#39;&#39;);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const lastEventTsRef = useRef&lt;number&gt;(Date.now());
  const isFetchingRef = useRef(false);
  const upsertJobStatus = useSetAtom(upsertJobStatusAtom);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());
  const [batchNames, setBatchNames] = useState&lt;string[]&gt;([]);
  const [serverCounts, setServerCounts] = useState&lt;{ queued: number; running: number; completed: number; failed: number; pendingStorage: number; total: number } | null&gt;(null);
  const [liveUpdates, setLiveUpdates] = useState&lt;boolean&gt;(true);

  // Initiale Seite nur laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const params = new URLSearchParams({ page: String(pageNum), limit: &#39;20&#39; });
        if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    void load(1, true);
    return () =&gt; { cancelled = true; };
  }, [isOpen, statusFilter, batchFilter]);

  // Batch-Namen laden, wenn Panel geöffnet wird
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadBatches() {
      try {
        const res = await fetch(&#39;/api/external/jobs/batches&#39;, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const names = Array.isArray(json.items) ? json.items.filter((v: unknown) =&gt; typeof v === &#39;string&#39;) as string[] : [];
        setBatchNames(names);
      } catch {}
    }
    void loadBatches();
    return () =&gt; { active = false; };
  }, [isOpen]);

  // Serverseitige Zähler laden (gesamt, optional gefiltert nach Batch)
  useEffect(() =&gt; {
    if (!isOpen) return;
    let active = true;
    async function loadCounts() {
      try {
        const params = new URLSearchParams();
        if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
        const res = await fetch(`/api/external/jobs/counters?${params.toString()}`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        setServerCounts(json.counters || null);
      } catch {}
    }
    void loadCounts();
    const t = setInterval(loadCounts, 5000);
    return () =&gt; { active = false; clearInterval(t); };
  }, [isOpen, batchFilter]);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const params = new URLSearchParams({ page: &#39;1&#39;, limit: &#39;20&#39; });
      if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
      if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
      const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden nur wenn Panel geöffnet ist und Live-Updates aktiv sind; bei Schließen sofort beenden
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) {
      if (eventRef.current) { try { eventRef.current.close(); } catch {} eventRef.current = null; }
      return;
    }
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      // kein aggressiver Refresh im open-Event; initiales Laden oben beim Öffnen

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          lastEventTsRef.current = Date.now();
          if (evt.sourceItemId &amp;&amp; evt.status) {
            upsertJobStatus({ itemId: evt.sourceItemId, status: evt.status });
          }
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job: nur einfügen wenn Filter passt; bei Batch-Filter immer via Refresh laden
            if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39; &amp;&amp; evt.status !== statusFilter) {
              return prev;
            }
            if (batchFilter) {
              void refreshNow();
              return prev;
            }
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        // Nur reconnecten, wenn Panel offen bleibt
        retryTimer = setTimeout(() =&gt; { if (isOpen &amp;&amp; liveUpdates) connect(); }, 1000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      lastEventTsRef.current = Date.now();
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, [isOpen, liveUpdates, upsertJobStatus, statusFilter, batchFilter]);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const queuedCount = items.filter(i =&gt; i.status === &#39;queued&#39;).length;
  const runningCount = items.filter(i =&gt; i.status === &#39;running&#39;).length;
  const completedCount = items.filter(i =&gt; i.status === &#39;completed&#39;).length;
  const failedCount = items.filter(i =&gt; i.status === &#39;failed&#39;).length;

  async function retryJob(jobId: string) {
    try {
      const res = await fetch(`/api/external/jobs/${jobId}/retry`, { method: &#39;POST&#39; });
      if (!res.ok) return;
      // Nach erfolgreichem Retry frisch laden
      await refreshNow();
    } catch {}
  }
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const params = new URLSearchParams({ page: String(next), limit: &#39;20&#39; });
    if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) params.set(&#39;status&#39;, statusFilter);
    if (batchFilter) params.set(&#39;batchName&#39;, batchFilter);
    const res = await fetch(`/api/external/jobs?${params.toString()}`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  // Polling Fallback: nur wenn Panel offen, Live-Updates an UND keine SSE-Events für 10s
  useEffect(() =&gt; {
    if (!isOpen || !liveUpdates) return;
    const onTick = () =&gt; {
      const idleMs = Date.now() - lastEventTsRef.current;
      if (idleMs &gt; 10_000) void refreshNow();
    };
    const timer = setInterval(onTick, 2000);
    const unsub = () =&gt; { lastEventTsRef.current = Date.now(); };
    window.addEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener);
    return () =&gt; { clearInterval(timer); window.removeEventListener(&#39;job_update_local&#39;, unsub as unknown as EventListener); };
  }, [isOpen, liveUpdates]);

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[420px] md:w-[520px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;span className=&quot;text-xs text-muted-foreground&quot;&gt;Q {serverCounts?.queued ?? queuedCount} • R {serverCounts?.running ?? runningCount} • C {serverCounts?.completed ?? completedCount} • F {serverCounts?.failed ?? failedCount}&lt;/span&gt;
              &lt;button
                onClick={() =&gt; setLiveUpdates(v =&gt; !v)}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
                title={liveUpdates ? &quot;Live-Updates anhalten&quot; : &quot;Live-Updates starten&quot;}
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, (isRefreshing || liveUpdates) &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-1 border-b text-xs text-muted-foreground flex items-center gap-4&quot;&gt;
            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-blue-400&quot; /&gt;Queued {serverCounts?.queued ?? queuedCount}&lt;/span&gt;
            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-yellow-400&quot; /&gt;Running {serverCounts?.running ?? runningCount}&lt;/span&gt;
            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-green-500&quot; /&gt;Completed {serverCounts?.completed ?? completedCount}&lt;/span&gt;
            &lt;span className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;inline-block h-2 w-2 rounded-full bg-red-500&quot; /&gt;Failed {serverCounts?.failed ?? failedCount}&lt;/span&gt;
          &lt;/div&gt;
          &lt;div className=&quot;px-4 py-2 border-b flex items-center gap-2&quot;&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot; value={statusFilter} onChange={(e) =&gt; setStatusFilter(e.target.value)}&gt;
              &lt;option value=&quot;all&quot;&gt;Alle ({serverCounts?.total ?? (queuedCount + runningCount + completedCount + failedCount)})&lt;/option&gt;
              &lt;option value=&quot;queued&quot;&gt;Queued ({serverCounts?.queued ?? queuedCount})&lt;/option&gt;
              &lt;option value=&quot;running&quot;&gt;Running ({serverCounts?.running ?? runningCount})&lt;/option&gt;
              &lt;option value=&quot;completed&quot;&gt;Completed ({serverCounts?.completed ?? completedCount})&lt;/option&gt;
              &lt;option value=&quot;failed&quot;&gt;Failed ({serverCounts?.failed ?? failedCount})&lt;/option&gt;
            &lt;/select&gt;
            &lt;select className=&quot;border rounded px-2 py-1 text-sm flex-1&quot; value={batchFilter} onChange={(e) =&gt; setBatchFilter(e.target.value)}&gt;
              &lt;option value=&quot;&quot;&gt;Alle Batches&lt;/option&gt;
              {batchNames.map((name) =&gt; (
                &lt;option key={name} value={name}&gt;{name}&lt;/option&gt;
              ))}
            &lt;/select&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={refreshNow}&gt;Filtern&lt;/Button&gt;
            &lt;Button size=&quot;sm&quot; onClick={async () =&gt; {
              try {
                const payload: Record&lt;string, string&gt; = {};
                if (statusFilter &amp;&amp; statusFilter !== &#39;all&#39;) payload.status = statusFilter;
                if (batchFilter) payload.batchName = batchFilter;
                const res = await fetch(&#39;/api/external/jobs/retry-batch&#39;, { method: &#39;POST&#39;, headers: { &#39;Content-Type&#39;: &#39;application/json&#39; }, body: JSON.stringify(payload) });
                if (!res.ok) return;
                await refreshNow();
              } catch {}
            }}&gt;Neu starten (gefiltert)&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className={cn(
                  &quot;border rounded-md p-3&quot;,
                  item.status === &#39;queued&#39; &amp;&amp; &#39;bg-blue-100/60&#39;,
                  item.status === &#39;running&#39; &amp;&amp; &#39;bg-yellow-100/60&#39;,
                  item.status === &#39;completed&#39; &amp;&amp; &#39;bg-green-100/60&#39;,
                  item.status === &#39;failed&#39; &amp;&amp; &#39;bg-red-100/60&#39;
                )}&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1 shrink-0 w-28 justify-end&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      {(item.status === &#39;failed&#39; || item.status === &#39;queued&#39;) &amp;&amp; (
                        &lt;button
                          onClick={() =&gt; retryJob(item.jobId)}
                          className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                          aria-label=&quot;Neu starten&quot;
                          title=&quot;Neu starten&quot;
                        &gt;
                          &lt;RefreshCw className=&quot;h-4 w-4&quot; /&gt;
                        &lt;/button&gt;
                      )}
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;running&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        Läuft…
                      &lt;/div&gt;
                    )}
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Ich habe serverseitige Gesamtzahlen ergänzt und ins Panel integriert:</p>
<ul>
<li>Backend</li>
<li>Repo: <code>countByStatus(userEmail, { libraryId?, batchName?, batchId? })</code> aggregiert alle Jobs.</li>
<li>
<p>API: <code>GET /api/external/jobs/counters?batchName=...&amp;batchId=...&amp;libraryId=...</code> liefert <code>{ queued, running, completed, failed, pendingStorage, total }</code>.</p>
</li>
<li>
<p>Frontend</p>
</li>
<li><code>JobMonitorPanel</code> lädt die Zähler alle 5s (nur wenn Panel offen).</li>
<li>Die Legende und der Status-Select zeigen nun die serverseitigen Counters; solange nichts geladen ist, werden lokale Zähler verwendet.</li>
</ul>
<p>Test:
- Panel öffnen → Legende zeigt Gesamtzahlen.
- Optional Batch im Dropdown wählen → Zähler aktualisieren sich entsprechend.
- Statusfilter wechseln → Liste bleibt gefiltert; Zähler bleiben „gesamt“ (bzw. batch-gefiltet, wenn Batch gesetzt).</p>
<p>Sag Bescheid, wenn die Zähler zusätzlich nach Statusfilter (statt gesamt) berechnet werden sollen; dann parametrisiere ich den Counter-Endpoint optional um <code>status</code>.</p>
<hr />
<p><strong>User</strong></p>
<p>Und werden die auch Serverseiten alle abgearbeitet, auch wenn es Hunderte sind?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ja. Unsere Umsetzung reicht alle ausgewählten PDFs serverseitig ein – auch Hunderte.</p>
<ul>
<li>Einreichung: Der Dialog schickt die Liste an den Server. Dort werden alle Jobs persistent angelegt und direkt an den Secretary-Service weitergereicht.</li>
<li>Parallelität: Serverseitig werden derzeit max. 5 Einreichungen gleichzeitig abgearbeitet (konfigurierbar); der Secretary hat zusätzlich seine eigene Parallelität.</li>
<li>Robustheit: Die Einreichung ist idempotent, Jobs liegen in der DB. Fällt etwas aus, bleiben sie auf queued/failed; du kannst sie einzeln oder gefiltert neu starten.</li>
<li>Monitoring: Fortschritt/Status kommen per SSE in der Jobliste an (kein hartes Polling nötig). Die Zähler oben zeigen serverseitige Gesamtstände.</li>
</ul>
<p>Wenn wir Lastspitzen erwarten (Tausenderbereich), können wir zusätzlich:
- Parallelitätslimit per Env anpassen.
- Batch einreich-seitig in kleinere Chunks aufteilen.
- Backoff/Retry-Strategie (Rate-Limit freundlich).
- Optional: echten Queue-Worker (persistente Job-Queue) hinterlegen.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js"></script>
      
        <script src="../../assets/javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>