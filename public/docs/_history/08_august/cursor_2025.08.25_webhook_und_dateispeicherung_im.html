
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://localhost:3000/docs/_history/08_august/cursor_2025.08.25_webhook_und_dateispeicherung_im.html">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Webhook und Dateispeicherung im Filesystem - Common Knowledge Scout</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/print.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#webhook-und-dateispeicherung-im-filesystem" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Common Knowledge Scout" class="md-header__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Common Knowledge Scout
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Webhook und Dateispeicherung im Filesystem
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Common Knowledge Scout" class="md-nav__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Common Knowledge Scout
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/intro.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/features.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/architecture.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/core-components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core Components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/getting-started.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/settings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Settings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/library.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using the Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/event-monitor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event Monitor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/batch-session-import.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Session Import
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/troubleshooting.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/faq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/storage-provider.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage Provider
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/localstorage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileSystem (Local)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/image-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/pdf/extraction-methods.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/metadata.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metadata
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/global-state.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Global State
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/header.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Header
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/breadcrumb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Breadcrumb
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-tree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileTree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-list.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileList
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/upload.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Upload
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-preview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FilePreview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/batch-transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/error-handling-logging-testing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Error Handling & Tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/initialization-sequence.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Initialization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Library Components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/shadowtwins.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/extended-shadowtwin.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extended Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/transformation-service.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformation Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/video-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Video Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/glossary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/secretary-services.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Secretary Services
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/track-processor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Track Processor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chat-response-generation-process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat & Story Mode
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/deployment/docker.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker Deployment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/quick-setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Quick Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/package-strategy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Package Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#webhook-endpoint-callback-vom-secretary-service" class="md-nav__link">
    <span class="md-ellipsis">
      Webhook-Endpoint (Callback vom Secretary Service)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entpacken-und-speichern-im-filesystem" class="md-nav__link">
    <span class="md-ellipsis">
      Entpacken und Speichern im Filesystem
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kurzantwort" class="md-nav__link">
    <span class="md-ellipsis">
      Kurzantwort
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ist-zustand" class="md-nav__link">
    <span class="md-ellipsis">
      Ist-Zustand
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zielbild-minimal-invasiv" class="md-nav__link">
    <span class="md-ellipsis">
      Zielbild (minimal-invasiv)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#drei-varianten-der-umsetzung" class="md-nav__link">
    <span class="md-ellipsis">
      Drei Varianten der Umsetzung
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vorteile" class="md-nav__link">
    <span class="md-ellipsis">
      Vorteile
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tests-kurz" class="md-nav__link">
    <span class="md-ellipsis">
      Tests (kurz)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#befund" class="md-nav__link">
    <span class="md-ellipsis">
      Befund
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="webhook-und-dateispeicherung-im-filesystem">Webhook und Dateispeicherung im Filesystem<a class="headerlink" href="#webhook-und-dateispeicherung-im-filesystem" title="Permanent link">&para;</a></h1>
<p><em>Exported on 8/30/2025 at 11:42:41 GMT+2 from Cursor (1.5.5)</em></p>
<hr />
<p><strong>User</strong></p>
<p>Ich möchte mir nochmal diesen Webhook anschauen, wo Secretary Service Daten zurücksendet und wo wir Dateien entpacken und im Filesystem speichern. Wie schaut das genau aus? wie wird filiesystem storage und onedrive logik unterschieden? @route.ts </p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich schaue mir die beteiligten Dateien an, um die genaue Stelle zum Webhook, dem Entpacken und dem Speichern (Filesystem vs. OneDrive) präzise zu zitieren. Jetzt öffne ich die relevanten Implementierungen.</p>
<p>Ich habe den Callback-Webhook und die Speicherroutinen geöffnet und markiere die entscheidenden Stellen. Ich zitiere die genauen Codeabschnitte und erläutere kurz den Control-Flow.</p>
<h3 id="webhook-endpoint-callback-vom-secretary-service">Webhook-Endpoint (Callback vom Secretary Service)<a class="headerlink" href="#webhook-endpoint-callback-vom-secretary-service" title="Permanent link">&para;</a></h3>
<ul>
<li>Authentifizierung via <code>callback_token</code> (Body, Header oder Bearer), Verifikation gegen <code>jobSecretHash</code>:
```135:153:src/app/api/external/jobs/[jobId]/route.ts
// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen
let callbackToken: string | undefined = body?.callback_token;
// ...
if (!callbackToken) return NextResponse.json({ error: 'callback_token fehlt' }, { status: 400 });</li>
</ul>
<p>const repo = new ExternalJobsRepository();
const job = await repo.get(jobId);
// ...
const tokenHash = repo.hashSecret(callbackToken);
if (tokenHash !== job.jobSecretHash) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
<div class="highlight"><pre><span></span><code>- Progress-Events (Watchdog, Log-Puffer, SSE-Update):
```158:197:src/app/api/external/jobs/[jobId]/route.ts
const progressValue = typeof body?.progress === &#39;number&#39;
  ? body.progress
  : typeof body?.data?.progress === &#39;number&#39;
    ? body.data.progress
    : typeof body?.percent === &#39;number&#39;
      ? body.percent
      : typeof body?.data?.percent === &#39;number&#39;
        ? body.data.percent
        : undefined;
const phase = (typeof body?.phase === &#39;string&#39; &amp;&amp; body.phase) || (typeof body?.data?.phase === &#39;string&#39; &amp;&amp; body.data.phase) || undefined;
const message = (typeof body?.message === &#39;string&#39; &amp;&amp; body.message) || (typeof body?.data?.message === &#39;string&#39; &amp;&amp; body.data.message) || undefined;

const hasError = !!body?.error;
const hasFinalPayload = !!(body?.data?.extracted_text || body?.data?.images_archive_data || body?.status === &#39;completed&#39;);

if (!hasFinalPayload &amp;&amp; !hasError &amp;&amp; (progressValue !== undefined || phase || message)) {
  // Watchdog heartbeat
  bumpWatchdog(jobId);
  bufferLog(jobId, { phase: phase || &#39;progress&#39;, progress: typeof progressValue === &#39;number&#39; ? Math.max(0, Math.min(100, progressValue)) : undefined, message });
  // Push-Event für UI (SSE)
  getJobEventBus().emitUpdate(job.userEmail, {
    type: &#39;job_update&#39;,
    jobId,
    status: &#39;running&#39;,
    phase: phase || &#39;progress&#39;,
    progress: typeof progressValue === &#39;number&#39; ? Math.max(0, Math.min(100, progressValue)) : undefined,
    message,
    updatedAt: new Date().toISOString(),
    jobType: job.job_type,
    fileName: job.correlation?.source?.name,
  });
  return NextResponse.json({ status: &#39;ok&#39;, jobId, kind: &#39;progress&#39; });
}
</code></pre></div></p>
<ul>
<li>
<p>Fehlerbehandlung:
```199:210:src/app/api/external/jobs/[jobId]/route.ts
if (hasError) {
  clearWatchdog(jobId);
  bufferLog(jobId, { phase: 'failed', details: body.error });
  const buffered = drainBufferedLogs(jobId);
  for (const entry of buffered) {
    await repo.appendLog(jobId, entry as unknown as Record<string, unknown>);
  }
  await repo.setStatus(jobId, 'failed', { error: { code: 'worker_error', message: 'Externer Worker-Fehler', details: body.error } });
  getJobEventBus().emitUpdate(job.userEmail, { type: 'job_update', jobId, status: 'failed', updatedAt: new Date().toISOString(), message: body?.error?.message, jobType: job.job_type, fileName: job.correlation?.source?.name });
  return NextResponse.json({ status: 'ok', jobId, kind: 'failed' });
}
<div class="highlight"><pre><span></span><code>### Finale Payload und Branching (Filesystem vs. OneDrive)
- Extraktion der Payload und Auswahl der Ziel-Bibliothek:
```212:227:src/app/api/external/jobs/[jobId]/route.ts
// Finale Payload
const extractedText: string | undefined = body?.data?.extracted_text;
const imagesArchiveData: string | undefined = body?.data?.images_archive_data;
const imagesArchiveFilename: string | undefined = body?.data?.images_archive_filename;

if (!extractedText &amp;&amp; !imagesArchiveData) {
  bumpWatchdog(jobId);
  bufferLog(jobId, { phase: &#39;noop&#39; });
  return NextResponse.json({ status: &#39;ok&#39;, jobId, kind: &#39;noop&#39; });
}

// Bibliothek laden (um Typ zu bestimmen)
const libraryService = LibraryService.getInstance();
const libraries = await libraryService.getUserLibraries(job.userEmail);
const lib = libraries.find(l =&gt; l.id === job.libraryId);
</code></pre></div></p>
</li>
<li>
<p>Branch für Filesystem (<code>lib.type === 'local'</code>): Speichern via <code>FileSystemProvider</code> und Entpacken/Speichern der Bilder via <code>ImageExtractionService</code>:
```231:285:src/app/api/external/jobs/[jobId]/route.ts
if (lib &amp;&amp; extractedText) {
  if (lib.type === 'local') {
    const provider = new FileSystemProvider(lib.path);
    const sourceId = job.correlation?.source?.itemId;
    const targetParentId = job.correlation?.source?.parentId || 'root';</p>
<p>const markdown = typeof (TransformService as unknown as { createMarkdownWithFrontmatter?: (c: string, m: Record<string, unknown>) =&gt; string }).createMarkdownWithFrontmatter === 'function'
  ? (TransformService as unknown as { createMarkdownWithFrontmatter: (c: string, m: Record<string, unknown>) =&gt; string }).createMarkdownWithFrontmatter(extractedText, (body?.data?.metadata as Record<string, unknown>) || {})
  : extractedText;</p>
<p>const baseName = (job.correlation.source?.name || 'output').replace(/.[^/.]+$/, '');
const lang = (job.correlation.options?.targetLanguage as string | undefined) || 'de';
const uniqueName = <code>${baseName}.${lang}.md</code>;</p>
<p>const file = new File([new Blob([markdown], { type: 'text/markdown' })], uniqueName, { type: 'text/markdown' });
const saved = await provider.uploadFile(targetParentId, file);
bufferLog(jobId, { phase: 'stored_local', message: 'Shadow‑Twin gespeichert' });
savedItemId = saved.id;</p>
<p>if (imagesArchiveData) {
  const originalItemForImages = {
    id: sourceId || 'unknown',
    parentId: targetParentId,
    type: 'file' as const,
    metadata: {
      name: job.correlation.source?.name || 'source.pdf',
      size: 0,
      modifiedAt: new Date(),
      mimeType: job.correlation.source?.mimeType || 'application/pdf',
    },
  };</p>
<p>const imageResult = await ImageExtractionService.saveZipArchive(
    imagesArchiveData,
    imagesArchiveFilename || 'pdf_images.zip',
    originalItemForImages,
    provider,
    async () =&gt; [],
    extractedText,
    lang,
    body?.data?.metadata?.text_contents
  );
  for (const it of imageResult.savedItems) savedItems.push(it.id);</p>
<p>bufferLog(jobId, { phase: 'images_extracted', message: <code>Bilder gespeichert (${imageResult.savedItems.length})</code> });
}
<div class="highlight"><pre><span></span><code>- Branch für OneDrive (`lib.type === &#39;onedrive&#39;`): Uploads via Graph API, inkl. Bild-Entpacken und pro-Seite-Markdown:
```285:338:src/app/api/external/jobs/[jobId]/route.ts
} else if (lib &amp;&amp; lib.type === &#39;onedrive&#39;) {
  const accessToken = await ensureOneDriveAccessToken(lib);
  const targetParentId = job.correlation?.source?.parentId || &#39;root&#39;;
  const baseName = (job.correlation.source?.name || &#39;output&#39;).replace(/\.[^/.]+$/, &#39;&#39;);
  const lang = (job.correlation.options?.targetLanguage as string | undefined) || &#39;de&#39;;
  const uniqueName = `${baseName}.${lang}.md`;
  const md = typeof (TransformService as unknown as { createMarkdownWithFrontmatter?: (c: string, m: Record&lt;string, unknown&gt;) =&gt; string }).createMarkdownWithFrontmatter === &#39;function&#39;
    ? (TransformService as unknown as { createMarkdownWithFrontmatter: (c: string, m: Record&lt;string, unknown&gt;) =&gt; string }).createMarkdownWithFrontmatter(extractedText, (body?.data?.metadata as Record&lt;string, unknown&gt;) || {})
    : extractedText;
  const contentBuffer = Buffer.from(md, &#39;utf8&#39;);
  const saved = await onedriveUploadFile(accessToken, targetParentId, uniqueName, &#39;text/markdown&#39;, contentBuffer);
  savedItemId = saved.id;
  savedItems.push(saved.id);

  bufferLog(jobId, { phase: &#39;stored_cloud&#39;, message: &#39;Shadow‑Twin gespeichert&#39; });

  if (imagesArchiveData) {
    const imagesFolder = await onedriveEnsureFolder(accessToken, targetParentId, `.${baseName}`);
    const JSZip = await import(&#39;jszip&#39;);
    const zip = await new JSZip.default().loadAsync(Buffer.from(imagesArchiveData, &#39;base64&#39;));
    const entries = Object.entries(zip.files as Record&lt;string, unknown&gt;);
    let imagesSaved = 0;

    const textContents: Array&lt;{ page: number; content: string }&gt; | undefined = (body?.data?.metadata?.text_contents as Array&lt;{ page: number; content: string }&gt; | undefined);
    for (const [filePath, fileEntry] of entries) {
      if ((fileEntry as { dir?: boolean }).dir) continue;
      const ext = filePath.split(&#39;.&#39;).pop()?.toLowerCase();
      if (!ext || ![&#39;png&#39;, &#39;jpg&#39;, &#39;jpeg&#39;].includes(ext)) continue;
      const originalFileName = filePath.split(&#39;/&#39;).pop() || `image.${ext}`;
      const pageFileName = originalFileName.replace(/^image_(\d+)/, (_m, n) =&gt; `page_${String(n).padStart(3, &#39;0&#39;)}`);
      const mime = ext === &#39;png&#39; ? &#39;image/png&#39; : &#39;image/jpeg&#39;;
      const bin = await (fileEntry as { async: (t: &#39;nodebuffer&#39;) =&gt; Promise&lt;Buffer&gt; }).async(&#39;nodebuffer&#39;);
      const imgItem = await onedriveUploadFile(accessToken, imagesFolder.id, pageFileName, mime, bin);
      savedItems.push(imgItem.id);
      imagesSaved++;
      if (textContents &amp;&amp; textContents.length &gt; 0) {
        const match = pageFileName.match(/page_(\d+)/);
        if (match) {
          const page = Number(match[1]);
          const tc = textContents.find(t =&gt; t.page === page);
          if (tc) {
            const mdName = `${pageFileName.replace(/\.(png|jpg|jpeg)$/i, &#39;&#39;)}.${lang}.md`;
            const mdBuffer = Buffer.from(
              `# ${pageFileName}\n\n## Quelle\n**PDF-Datei:** ${job.correlation.source?.name || &#39;&#39;}\n**Bild:** ${pageFileName}\n**Sprache:** ${lang}\n**Seite:** ${page}\n\n## Extrahierter Text\n${tc.content}\n`,
              &#39;utf8&#39;
            );
            const mdItem = await onedriveUploadFile(accessToken, imagesFolder.id, mdName, &#39;text/markdown&#39;, mdBuffer);
            savedItems.push(mdItem.id);
          }
        }
      }
    }
    bufferLog(jobId, { phase: &#39;images_extracted&#39;, message: `Bilder gespeichert (${imagesSaved})` });
  }
}
</code></pre></div></p>
</li>
<li>
<p>Abschluss (Persistierung, Result, SSE):
```342:361:src/app/api/external/jobs/[jobId]/route.ts
await repo.setStatus(jobId, 'completed');
clearWatchdog(jobId);
const buffered = drainBufferedLogs(jobId);
for (const entry of buffered) {
  await repo.appendLog(jobId, entry as unknown as Record<string, unknown>);
}
await repo.setResult(jobId, {
  extracted_text: extractedText,
  images_archive_data: imagesArchiveData,
  images_archive_filename: imagesArchiveFilename,
  metadata: body?.data?.metadata,
}, { savedItemId, savedItems });</p>
</li>
</ul>
<p>await repo.appendLog(jobId, { phase: 'completed', message: 'Job abgeschlossen' });
FileLogger.info('external-jobs', 'Job completed', { jobId, savedItemId, savedItemsCount: savedItems.length });
getJobEventBus().emitUpdate(job.userEmail, { type: 'job_update', jobId, status: 'Job abgeschlossen', progress: 100, updatedAt: new Date().toISOString(), message: 'completed', jobType: job.job_type, fileName: job.correlation?.source?.name });
return NextResponse.json({ status: 'ok', jobId, kind: 'final', savedItemId, savedItemsCount: savedItems.length });
<div class="highlight"><pre><span></span><code>### OneDrive-Helferfunktionen
- Token-Refresh:
```21:39:src/app/api/external/jobs/[jobId]/route.ts
async function ensureOneDriveAccessToken(lib: Library): Promise&lt;string&gt; {
  const cfg = lib.config as unknown as OneDriveAuthConfig | undefined;
  const accessToken = cfg?.accessToken as string | undefined;
  const refreshToken = cfg?.refreshToken as string | undefined;
  const tokenExpiry = Number(cfg?.tokenExpiry || 0);
  const isExpired = !tokenExpiry || Date.now() / 1000 &gt; tokenExpiry - 60;

  if (accessToken &amp;&amp; !isExpired) return accessToken;
  if (!refreshToken) throw new Error(&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;);

  const resp = await fetch(`${process.env.NEXT_PUBLIC_APP_URL?.replace(/\/$/, &#39;&#39;)}/api/auth/onedrive/refresh`, {
    method: &#39;POST&#39;,
    headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
    body: JSON.stringify({ libraryId: lib.id, refreshToken })
  });
  if (!resp.ok) throw new Error(`OneDrive Token-Refresh fehlgeschlagen (${resp.status})`);
  const data = await resp.json();
  return data.accessToken as string;
}
</code></pre></div></p>
<ul>
<li>Datei-Upload und Ordner sicherstellen:
<code>``41:54:src/app/api/external/jobs/[jobId]/route.ts
async function onedriveUploadFile(accessToken: string, parentId: string, name: string, mime: string, buffer: Buffer): Promise&lt;{ id: string }&gt; {
  const base = parentId === 'root'
    ?</code>https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURIComponent(name)}:/content<code>:</code>https://graph.microsoft.com/v1.0/me/drive/items/${parentId}:/${encodeURIComponent(name)}:/content<code>;
  let url =</code>${base}?@microsoft.graph.conflictBehavior=replace<code>;
  let res = await fetch(url, { method: 'PUT', headers: { 'Authorization':</code>Bearer ${accessToken}<code>, 'Content-Type': mime }, body: buffer });
  if (res.status === 409) {
    url =</code>${base}?@microsoft.graph.conflictBehavior=rename<code>;
    res = await fetch(url, { method: 'PUT', headers: { 'Authorization':</code>Bearer ${accessToken}<code>, 'Content-Type': mime }, body: buffer });
  }
  if (!res.ok) throw new Error(</code>OneDrive Upload fehlgeschlagen: ${res.status}`);
  const json: unknown = await res.json();
  return { id: (json as { id?: string }).id as string };
}
<div class="highlight"><pre><span></span><code>```56:73:src/app/api/external/jobs/[jobId]/route.ts
async function onedriveEnsureFolder(accessToken: string, parentId: string, name: string): Promise&lt;{ id: string }&gt; {
  const url = parentId === &#39;root&#39;
    ? &#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;
    : `https://graph.microsoft.com/v1.0/me/drive/items/${parentId}/children`;
  const list = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
  if (!list.ok) throw new Error(`OneDrive children list fehlgeschlagen: ${list.status}`);
  const data: unknown = await list.json();
  const existing = (Array.isArray((data as { value?: unknown }).value) ? (data as { value: Array&lt;{ id?: string; name?: string; folder?: unknown }&gt; }).value : undefined)?.find((it) =&gt; it.folder &amp;&amp; it.name === name);
  if (existing) return { id: existing.id as string };
  const resp = await fetch(url, {
    method: &#39;POST&#39;,
    headers: { Authorization: `Bearer ${accessToken}`, &#39;Content-Type&#39;: &#39;application/json&#39; },
    body: JSON.stringify({ name, folder: {}, &#39;@microsoft.graph.conflictBehavior&#39;: &#39;rename&#39; })
  });
  if (!resp.ok) throw new Error(`OneDrive Ordnererstellung fehlgeschlagen: ${resp.status}`);
  const created: unknown = await resp.json();
  return { id: (created as { id?: string }).id as string };
}
</code></pre></div></li>
</ul>
<h3 id="entpacken-und-speichern-im-filesystem">Entpacken und Speichern im Filesystem<a class="headerlink" href="#entpacken-und-speichern-im-filesystem" title="Permanent link">&para;</a></h3>
<ul>
<li>Ordneranlage, ZIP laden (JSZip), dann Bilder extrahieren und speichern (über den generischen <code>StorageProvider</code>, hier <code>FileSystemProvider</code>):
```61:66:src/lib/transform/image-extraction-service.ts
// Erstelle den Ordner
const folderItem = await provider.createFolder(originalItem.parentId, folderName);</li>
</ul>
<p>FileLogger.info('ImageExtractionService', 'Ordner erstellt', {
  folderId: folderItem.id,
  folderName: folderName
});
<div class="highlight"><pre><span></span><code>```69:80:src/lib/transform/image-extraction-service.ts
// Base64 zu Buffer konvertieren
const buffer = Buffer.from(base64ZipData, &#39;base64&#39;);
// ZIP-Archiv mit JSZip entpacken
const JSZip = await import(&#39;jszip&#39;);
const zip = new JSZip.default();
const zipContent = await zip.loadAsync(buffer);
</code></pre></div></p>
<p><code>``108:157:src/lib/transform/image-extraction-service.ts
for (const [filePath, file] of Object.entries(zipContent.files)) {
  // ...
  if (!file.dir) {
    // Bestimme den Dateityp
    const fileExtension = filePath.split('.').pop()?.toLowerCase();
    let mimeType = 'application/octet-stream';
    if (fileExtension === 'png') mimeType = 'image/png';
    else if (fileExtension === 'jpg' || fileExtension === 'jpeg') mimeType = 'image/jpeg';
    // page_XXX Namensschema
    const originalFileName = filePath.split('/').pop() || filePath;
    const pageFileName = originalFileName.replace(/^image_(\d+)/, (match, pageNum) =&gt; {
      return</code>page_${pageNum.padStart(3, '0')}`;
    });
    // Bild-Blob extrahieren
    const imageBlob = await file.async('blob');
    // Speichern im Zielordner
    const imageFile = new File([imageBlob], pageFileName, { type: mimeType });
    const savedImageItem = await provider.uploadFile(folderItem.id, imageFile);
    savedItems.push(savedImageItem);
<div class="highlight"><pre><span></span><code>```166:187:src/lib/transform/image-extraction-service.ts
if (textContents &amp;&amp; textContents.length &gt; 0) {
  // Seitennummer bestimmen, Markdown-Datei mit Text anlegen
  const pageMatch = pageFileName.match(/page_(\d+)/);
  if (pageMatch) {
    const pageNumber = parseInt(pageMatch[1], 10);
    const pageText = textContents.find(tc =&gt; tc.page === pageNumber);
    if (pageText) {
      const baseFileName = pageFileName.replace(/\.(png|jpg|jpeg)$/i, &#39;&#39;);
      const markdownFileName = targetLanguage 
        ? `${baseFileName}.${targetLanguage}.md`
        : `${baseFileName}.md`;
      const markdownContent = this.createMarkdownContent(pageFileName, pageText.content, originalItem.metadata.name, targetLanguage, pageNumber);
      const markdownBlob = new Blob([markdownContent], { type: &#39;text/markdown&#39; });
      const markdownFile = new File([markdownBlob], markdownFileName, { type: &#39;text/markdown&#39; });
      const savedMarkdownItem = await provider.uploadFile(folderItem.id, markdownFile);
      savedItems.push(savedMarkdownItem);
</code></pre></div></p>
<ul>
<li>Tatsächliches Filesystem-Schreiben (lokaler Provider):
```338:346:src/lib/storage/filesystem-provider.ts
async uploadFile(parentId: string, file: File): Promise<StorageItem> {
  const parentPath = await this.findPathById(parentId);
  const filePath = path.join(parentPath, file.name);
  const buffer = Buffer.from(await file.arrayBuffer());</li>
</ul>
<p>await fs.writeFile(filePath, buffer);
  const stats = await fs.stat(filePath);
  return this.statsToStorageItem(filePath, stats);
}
<div class="highlight"><pre><span></span><code>### Antwort auf deine Fragen
- Unterschied Filesystem vs. OneDrive: Die Verzweigung passiert über `lib.type` aus der aktiven Bibliothek. Bei `local` wird über `FileSystemProvider` direkt ins Dateisystem geschrieben und Bilder werden mit `ImageExtractionService.saveZipArchive` entpackt und gespeichert. Bei `onedrive` werden Inhalte über Microsoft Graph (`onedriveUploadFile`, `onedriveEnsureFolder`) hochgeladen; das ZIP wird mit JSZip im Handler entpackt und die Einträge einzeln hochgeladen.
- Entpacken: Lokale Speicherung nutzt zentral `ImageExtractionService` (generischer `StorageProvider`). OneDrive entpackt inline im Route-Handler mit JSZip und lädt die Teile via Graph API.

- Abschluss: Nach Erfolg werden Status, Logs, Result-Objekt (inkl. `savedItemId`/`savedItems`) persistiert und ein SSE-Update verschickt.

Kurzfazit
- Branch anhand `lib.type`: `local` → `FileSystemProvider` + `ImageExtractionService`; `onedrive` → Graph API Uploads.
- ZIP-Handling: lokal im Service, OneDrive inline im Handler.
- Webhook prüft Tokens, streamt Progress, und finalisiert Status/Result robust mit Logging und SSE.

```typescript
// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen
let callbackToken: string | undefined = body?.callback_token;
// ...
if (!callbackToken) return NextResponse.json({ error: &#39;callback_token fehlt&#39; }, { status: 400 });

const repo = new ExternalJobsRepository();
const job = await repo.get(jobId);
// ...
const tokenHash = repo.hashSecret(callbackToken);
if (tokenHash !== job.jobSecretHash) return NextResponse.json({ error: &#39;Unauthorized&#39; }, { status: 401 });
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Watchdog heartbeat</span>
<span class="w">  </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">  </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">  </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="p">,</span>
<span class="w">    </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">  </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// Finale Payload</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveData</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">  </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">    </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">        </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">          </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">        </span><span class="nx">imagesArchiveData</span><span class="p">,</span>
<span class="w">        </span><span class="nx">imagesArchiveFilename</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;pdf_images.zip&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">        </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">  </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">  </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="sb">`.</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">JSZip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;jszip&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">JSZip</span><span class="p">.</span><span class="k">default</span><span class="p">().</span><span class="nx">loadAsync</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">zip</span><span class="p">.</span><span class="nx">files</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">imagesSaved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">fileEntry</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">entries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">dir?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">}).</span><span class="nx">dir</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ext</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpeg&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">ext</span><span class="p">))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`image.</span><span class="si">${</span><span class="nx">ext</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^image_(\d+)/</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">_m</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`page_</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;png&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;image/png&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">async</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Buffer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}).</span><span class="k">async</span><span class="p">(</span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">imgItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="p">,</span><span class="w"> </span><span class="nx">bin</span><span class="p">);</span>
<span class="w">      </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">imgItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">      </span><span class="nx">imagesSaved</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">textContents</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/page_(\d+)/</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mf">1</span><span class="p">]);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">page</span><span class="p">);</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.(png|jpg|jpeg)$/i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span>
<span class="w">              </span><span class="sb">`# </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n\n## Quelle\n**PDF-Datei:** </span><span class="si">${</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="sb">\n**Bild:** </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n**Sprache:** </span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">\n**Seite:** </span><span class="si">${</span><span class="nx">page</span><span class="si">}</span><span class="sb">\n\n## Extrahierter Text\n</span><span class="si">${</span><span class="nx">tc</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="sb">\n`</span><span class="p">,</span>
<span class="w">              </span><span class="s1">&#39;utf8&#39;</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">mdName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="p">);</span>
<span class="w">            </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mdItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imagesSaved</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">  </span><span class="nx">images_archive_data</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveData</span><span class="p">,</span>
<span class="w">  </span><span class="nx">images_archive_filename</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveFilename</span><span class="p">,</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">/children`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive children list fehlgeschlagen: </span><span class="si">${</span><span class="nx">list</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">folder?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="nx">.value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">it</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">folder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">existing.id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;@microsoft.graph.conflictBehavior&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rename&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Ordnererstellung fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">created</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// Erstelle den Ordner</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">folderItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">createFolder</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">,</span><span class="w"> </span><span class="nx">folderName</span><span class="p">);</span>

<span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;ImageExtractionService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Ordner erstellt&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">folderItem.id</span><span class="p">,</span>
<span class="w">  </span><span class="nx">folderName</span><span class="o">:</span><span class="w"> </span><span class="kt">folderName</span>
<span class="p">});</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// Base64 zu Buffer konvertieren</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">base64ZipData</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
<span class="c1">// ZIP-Archiv mit JSZip entpacken</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">JSZip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;jszip&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">JSZip</span><span class="p">.</span><span class="k">default</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">zipContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">zip</span><span class="p">.</span><span class="nx">loadAsync</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">zipContent</span><span class="p">.</span><span class="nx">files</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">file</span><span class="p">.</span><span class="nx">dir</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Bestimme den Dateityp</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">mimeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fileExtension</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;png&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">mimeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;image/png&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fileExtension</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;jpg&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">fileExtension</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;jpeg&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">mimeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// page_XXX Namensschema</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">filePath</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^image_(\d+)/</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">,</span><span class="w"> </span><span class="nx">pageNum</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="sb">`page_</span><span class="si">${</span><span class="nx">pageNum</span><span class="p">.</span><span class="nx">padStart</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// Bild-Blob extrahieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageBlob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="k">async</span><span class="p">(</span><span class="s1">&#39;blob&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Speichern im Zielordner</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">imageBlob</span><span class="p">],</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">mimeType</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedImageItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">folderItem</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">imageFile</span><span class="p">);</span>
<span class="w">    </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">savedImageItem</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">textContents</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Seitennummer bestimmen, Markdown-Datei mit Text anlegen</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/page_(\d+)/</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pageMatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">pageMatch</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">tc</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">pageNumber</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pageText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.(png|jpg|jpeg)$/i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="w"> </span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseFileName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">targetLanguage</span><span class="si">}</span><span class="sb">.md`</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseFileName</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createMarkdownContent</span><span class="p">(</span><span class="nx">pageFileName</span><span class="p">,</span><span class="w"> </span><span class="nx">pageText</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span><span class="w"> </span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="p">,</span><span class="w"> </span><span class="nx">pageNumber</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownBlob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdownContent</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">markdownBlob</span><span class="p">],</span><span class="w"> </span><span class="nx">markdownFileName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedMarkdownItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">folderItem</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">markdownFile</span><span class="p">);</span>
<span class="w">      </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">savedMarkdownItem</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findPathById</span><span class="p">(</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">parentPath</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">());</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">statsToStorageItem</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>Wir haben in unserem Projekt ja das Konzept von einem generischen Storage-Provider, der dann auf unterliegenden Ebenen dann unterschiedliche Libraries mit Storage-Typen, unterschiedlichen Storage-Typen beherrscht. Es wäre es nicht sinnvoll, hier bei diesem Webhook nicht direkt mit den unterschiedlichen Providern unterschiedliche Logik zu implementieren, sondern über diese generische Ebene auf diese Provider zuzugreifen, so dass wir hier nur einmal die Logik programmieren und wie der Provider das jetzt speichert oder die ZIP-Datei unsere Zeichnisse erstellt, dass das generisch nur einmal pro Provider programmiert ist und dann in seine eigene Library. Da könnte man diese Logik nicht abstrahieren und die Komplexität rausnehmen, weil es können jetzt drei, vier, fünf Libraries dazukommen.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich werde kurz die bestehenden Storage-Typen prüfen, um sicherzustellen, dass eine einheitliche Provider-Factory und ein OneDrive-Provider die benötigten Methoden abdecken. Danach skizziere ich den Refactor-Plan mit minimalen Edits im Webhook.</p>
<p>Ich prüfe kurz die vorhandenen Storage-Layer, um zu sehen, ob bereits eine Provider-Factory oder ein OneDrive-Provider existiert, damit ich die geplanten Edits minimal halten kann. Danach skizziere ich konkrete, kleine Edits am Webhook.</p>
<p>Ich habe geprüft: Für lokal existiert <code>FileSystemProvider</code> (vollständig). Für OneDrive gibt es einen Client-Provider und einen serverseitigen Auth‑Helper, aber keinen vollwertigen serverseitigen <code>StorageProvider</code>. Genau dort entsteht die Sonderlogik im Webhook.</p>
<h3 id="kurzantwort">Kurzantwort<a class="headerlink" href="#kurzantwort" title="Permanent link">&para;</a></h3>
<ul>
<li>Ja, die Logik sollte in eine generische Speicherebene abstrahiert werden.</li>
<li>Der Webhook sollte nur: Job validieren → Provider per Library ermitteln → “Text speichern + ZIP entpacken und speichern” an einen generischen Service delegieren.</li>
<li>Provider-spezifische Details (Token-Refresh, Ordner anlegen, Dateiupload) gehören in die jeweiligen Provider.</li>
</ul>
<h3 id="ist-zustand">Ist-Zustand<a class="headerlink" href="#ist-zustand" title="Permanent link">&para;</a></h3>
<ul>
<li>Filesystem-Branch nutzt bereits generische Wege: <code>FileSystemProvider</code> + <code>ImageExtractionService.saveZipArchive(provider, ...)</code>.</li>
<li>OneDrive-Branch umgeht den Provider und macht im Handler: Token-Refresh, Uploads, JSZip-Entpacken und pro-Seite-Markdown. Das dupliziert Logik und erschwert neue Provider.</li>
</ul>
<h3 id="zielbild-minimal-invasiv">Zielbild (minimal-invasiv)<a class="headerlink" href="#zielbild-minimal-invasiv" title="Permanent link">&para;</a></h3>
<ul>
<li>Einführung eines serverseitigen <code>OneDriveServerStorageProvider</code> der das Interface <code>StorageProvider</code> komplett implementiert (uploadFile, createFolder, …) inkl. Token-Refresh (aus <code>lib.config</code>).</li>
<li>Webhook ruft für beide Typen denselben Ablauf auf:
  1) <code>provider = resolveProviderFromLibrary(lib)</code><br />
  2) Shadow‑Twin speichern: <code>provider.uploadFile(...)</code><br />
  3) Bilder speichern: <code>ImageExtractionService.saveZipArchive(..., provider, ...)</code>  </li>
<li>Keine OneDrive‑Sonderpfade mehr in <code>route.ts</code>.</li>
</ul>
<p>Beispielhafter Ablauf im Handler (vereinfacht):
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProviderForLibrary</span><span class="p">(</span><span class="nx">lib</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>
<span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">markdownBlob</span><span class="p">],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">}));</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesArchiveFilename</span><span class="p">,</span><span class="w"> </span><span class="nx">originalItem</span><span class="p">,</span><span class="w"> </span><span class="nx">provider</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="nx">lang</span><span class="p">,</span><span class="w"> </span><span class="nx">textContents</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></p>
<h3 id="drei-varianten-der-umsetzung">Drei Varianten der Umsetzung<a class="headerlink" href="#drei-varianten-der-umsetzung" title="Permanent link">&para;</a></h3>
<ul>
<li>Variante A (kleinster Eingriff, empfohlen):  </li>
<li>Implementiere <code>OneDriveServerStorageProvider</code> mit <code>StorageProvider</code>-Interface (serverfähig, nutzt Graph API und bestehenden Refresh-Endpunkt intern).  </li>
<li>Erzeuge <code>getServerProviderForLibrary(lib)</code> → gibt <code>FileSystemProvider</code> oder <code>OneDriveServerStorageProvider</code> zurück.  </li>
<li>Ersetze im Webhook die OneDrive-Sonderlogik durch die generischen Aufrufe (Upload + <code>ImageExtractionService</code>).</li>
<li>Variante B (mittel, klarere Verantwortlichkeiten):  </li>
<li>Zusätzlich eine <code>ResultPersister</code>-Utility bauen: <code>saveShadowTwin(provider, ctx)</code> und <code>saveImagesFromZip(provider, ctx)</code>.  </li>
<li>Webhook ruft nur noch diese Utility; Utilities nutzen Provider + <code>ImageExtractionService</code>.</li>
<li>Variante C (größer, langfristig sauber):  </li>
<li>Verlege die gesamte “final payload handling”-Logik in <code>TransformService.saveFromWebhook(provider, job, payload)</code>;  </li>
<li>Webhook macht nur Auth, Job laden, Library → Provider, und delegiert an <code>TransformService</code>.</li>
</ul>
<h3 id="vorteile">Vorteile<a class="headerlink" href="#vorteile" title="Permanent link">&para;</a></h3>
<ul>
<li>Einmalige Implementierung pro Provider; keine Verzweigung mehr im Handler.  </li>
<li>Künftige Provider (S3, GDrive, …) fügen nur einen Provider hinzu; Webhook bleibt unverändert.  </li>
<li>Wiederverwendung der bewährten <code>ImageExtractionService.saveZipArchive</code> für alle Provider.</li>
</ul>
<h3 id="tests-kurz">Tests (kurz)<a class="headerlink" href="#tests-kurz" title="Permanent link">&para;</a></h3>
<ul>
<li>Unit: Provider-Mocks, <code>ResultPersister/ImageExtractionService</code> mit <code>StorageProvider</code>-Fake.  </li>
<li>Integrations-Test: Simulierter Webhook-POST (lokal + onedrive), erwartet: 1 Shadow‑Twin + N Bilder.  </li>
<li>E2E: Manuell mit echten Credentials auf OneDrive gegen ein Testverzeichnis.</li>
</ul>
<p>Wenn du möchtest, setze ich zuerst Variante A um: 1) neuen <code>OneDriveServerStorageProvider</code> erstellen, 2) kleine Edits im Webhook, 3) Tests für beide Provider-Flows.</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProviderForLibrary</span><span class="p">(</span><span class="nx">lib</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>
<span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">markdownBlob</span><span class="p">],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">}));</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesArchiveFilename</span><span class="p">,</span><span class="w"> </span><span class="nx">originalItem</span><span class="p">,</span><span class="w"> </span><span class="nx">provider</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="nx">lang</span><span class="p">,</span><span class="w"> </span><span class="nx">textContents</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>Ich habe es jetzt getestet, mit einem PDF-Dokument zu transformieren, mit Bilder extrahieren. Das Markdown-Datei wird generiert, aber das Unterverzeichnis mit den Bildern wird nicht geladen. Was kann sein?</p>
<p>{
  "_id": {
    "$oid": "68ac6ce202800bf7114f4a77"
  },
  "jobId": "78dc2009-fb4d-4355-8d90-cdc187a90582",
  "jobSecretHash": "2d974c1ef7fcef2dc14590490aadf0715b4ed16f6e1c608f17761e8b9f445514",
  "job_type": "pdf",
  "operation": "extract",
  "worker": "secretary",
  "status": "completed",
  "libraryId": "502a1384-553b-493e-bc66-75d48345b47e",
  "userEmail": "peter.aichner@crystal-design.com",
  "correlation": {
    "jobId": "78dc2009-fb4d-4355-8d90-cdc187a90582",
    "libraryId": "502a1384-553b-493e-bc66-75d48345b47e",
    "source": {
      "mediaType": "pdf",
      "mimeType": "application/pdf",
      "name": "350896dd-8826-446b-90c8-82273ab74eae.pdf",
      "itemId": "dGVtcC90ZXN0L2NvbW1vbmluZy8zNTA4OTZkZC04ODI2LTQ0NmItOTBjOC04MjI3M2FiNzRlYWUucGRm",
      "parentId": "dGVtcC90ZXN0L2NvbW1vbmluZw=="
    },
    "options": {
      "targetLanguage": "de",
      "extractionMethod": "native",
      "includeImages": true,
      "useCache": true
    }
  },
  "createdAt": {
    "$date": "2025-08-25T14:02:10.142Z"
  },
  "updatedAt": {
    "$date": "2025-08-25T14:02:31.090Z"
  },
  "logs": [
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:10.191Z"
      },
      "phase": "request_sent",
      "sourcePath": "dGVtcC90ZXN0L2NvbW1vbmluZy8zNTA4OTZkZC04ODI2LTQ0NmItOTBjOC04MjI3M2FiNzRlYWUucGRm",
      "targetParentId": "dGVtcC90ZXN0L2NvbW1vbmluZw==",
      "callbackUrl": "http://localhost:3000/api/external/jobs/78dc2009-fb4d-4355-8d90-cdc187a90582"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:11.027Z"
      },
      "phase": "request_ack",
      "status": 202,
      "statusText": "ACCEPTED"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:24.948Z"
      },
      "phase": "initializing",
      "progress": 5,
      "message": "Job initialisiert"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:25.149Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Verarbeite Datei: upload_9f255e1a-da8c-4aaa-bce2-46011c8bdb35.pdf - Args: {\"file_size\": 986364, \"working_dir\": \"cache\\pdf\\temp\\pdf\\7ea3af976ab2b0ea\", \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:25.299Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Starte Extraktion (Methoden: ['native'])"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:25.455Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 1"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:25.705Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 1 verarbeitet - Args: {\"duration\": 0.2550177574157715, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:25.854Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 2"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:26.056Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 2 verarbeitet - Args: {\"duration\": 0.20435857772827148, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:26.217Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 3"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:26.427Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 3 verarbeitet - Args: {\"duration\": 0.22599387168884277, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:26.577Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 4"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:26.765Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 4 verarbeitet - Args: {\"duration\": 0.18595242500305176, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:26.917Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 5"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:27.097Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 5 verarbeitet - Args: {\"duration\": 0.18729567527770996, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:27.254Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 6"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:27.467Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 6 verarbeitet - Args: {\"duration\": 0.2200455665588379, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:27.618Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 7"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:27.834Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 7 verarbeitet - Args: {\"duration\": 0.21577715873718262, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:27.977Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 8"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:28.171Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 8 verarbeitet - Args: {\"duration\": 0.20267057418823242, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:28.326Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 9"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:28.544Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 9 verarbeitet - Args: {\"duration\": 0.21231865882873535, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:28.687Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 10"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:28.893Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 10 verarbeitet - Args: {\"duration\": 0.2011258602142334, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:29.045Z"
      },
      "phase": "running",
      "progress": null,
      "message": "verarbeite Seite 11"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:29.230Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Seite 11 verarbeitet - Args: {\"duration\": 0.19214892387390137, \"extraction_methods\": [\"native\"]}"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:29.600Z"
      },
      "phase": "running",
      "progress": null,
      "message": "Bilder-Archiv erstellt: 11 Hauptbilder, 0 Vorschaubilder, 0 fehlgeschlagen"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:29.996Z"
      },
      "phase": "postprocessing",
      "progress": 95,
      "message": "Ergebnisse werden gespeichert"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:30.228Z"
      },
      "phase": "stored_local",
      "message": "Shadow‑Twin gespeichert"
    },
    {
      "timestamp": {
        "$date": "2025-08-25T14:02:31.121Z"
      },
      "phase": "completed",
      "message": "Job abgeschlossen"
    }
  ],
  "processId": "job-9cc5495a-d752-4789-ad26-9ce4e9653b6a",
  "payload": {
    "extracted_text": "\n--- Seite 1 ---\nNature of Innovation.\nSOFTWARE DEVELOPERS' THURSDAY\nStefano Seppi\n\n--- Seite 2 ---\n2\nSTRATEGY HOUSE DIGITAL \nVISION STATEMENT 2030 \nIOT (INTERNET OF THINGS)\nDATA COLLECTION\nIoT and Edge Computing create an \nenvironment in which micro-computers \nare all around us. This transforms the way \ncomputation is done, more on the edge or \nin the fog. New challenges like \"OTA \nProgramming Strategies\", \"Cyber-\nSecurity Risk Mitigation\" and \"Blockchain\" will \nbecome key for a sustainable digital \nenvironment.\nOPEN DATA HUB\nDATA SHARING AND COMMUNITY\nSoftware Development is rapidly changing, \ntopics like Agile Software Development, \nContinuous Compliance, Licensing, … require \na strong competence in Open Source, Open \nStandards and Open Data to connect as many \nsystems as possible and to open up data silos. \nEnabling the involved companies and research \ninstitutions to gain visibility and increase \nthe ROI for their I&amp;R&amp;D activities.\nAI (ARTIFICIAL INTELLIGENCE)\nDATA PROCESSING\nHyperconnected Services enable new Business \nModels like XaaS, everything as a service. MaaS\nis already in development and deep learning \nwill change how users will be involved in the \ncustomer journey.\nEXCELLENCE \n.PIONEERING \nSUSTAINABLE\n2030\nEstablish the digital backbone \nto enable smart green regions.\n\n--- Seite 3 ---\n3\nTODAY - SOFTWARE DEVELOPERS' THURSDAY\n\n--- Seite 4 ---\n4\nDISCUSSION TIME\nDISCUSSION TIME!\n\n--- Seite 5 ---\n5\nNOI TECHPARK SÜDTIROL/ALTO ADIGE\nUPCOMING EVENTS\n\n--- Seite 6 ---\n6\nNEXT SOFTWARE DEVELOPERS' THURSDAY\nMore info: https://noi.bz.it/it/eventi/software-developers-thursday/6f206455-c98b-4c11-\n913b-28d7b83a0e2b \n\n--- Seite 7 ---\n7\nSOFTWARE DEVELOPERS' THURSDAY 2025 – WE WANT YOU\n2025 EVENT CALENDAR\nContact: s.seppi@noi.bz.it\nThe 2025 Software Developers' Thursday \nCalendar:\n•\nJanuary 9th (Booked)\n•\nFebruary 6th (Booked)\n•\nMarch 6th (Booked)\n•\nApril 3rd (Booked)\n•\nMay 9th (Booked)\n•\nJune 5th (Booked)\n•\nJuly 3rd (Booked)\n•\nAugust 7th (Booked)\n•\nSeptember 4th (Booked)\n•\nOctober 2nd (Booked)\n•\nDecember 4th\n2025\n\n--- Seite 8 ---\n8\nNOI HACKATHON SUMMER EDITION – 1-2 AUGUST 2025 – CALL4VOLUTEERS\nMore info: https://hackathon.bz.it/ \n\n--- Seite 9 ---\n9\nSFSCON 2025 – 7-8 NOVEMBER 2025 – CALL4VOLUTEERS\nMore info: https://www.sfscon.it/call4volunteers/ \n\n--- Seite 10 ---\n10\nSFSCON 2025 – 7-8 NOVEMBER 2025\nMore info: https://www.sfscon.it/ \n\n--- Seite 11 ---\nNOI TECHPARK\nSÜDTIROL/ALTO ADIGE\nVIA A.-VOLTA-STRASSE 13/A\nI – 39100 BOZEN/BOLZANO\n+39 0471/066 600\nINFO@NOI.BZ.IT\nWWW.NOI.BZ.IT\nTHANK YOU.\n",
    "images_archive_url": "/api/jobs/job-9cc5495a-d752-4789-ad26-9ce4e9653b6a/download-archive",
    "metadata": {
      "text_contents": [
        {
          "page": 1,
          "content": "Nature of Innovation.\nSOFTWARE DEVELOPERS' THURSDAY\nStefano Seppi\n"
        },
        {
          "page": 2,
          "content": "2\nSTRATEGY HOUSE DIGITAL \nVISION STATEMENT 2030 \nIOT (INTERNET OF THINGS)\nDATA COLLECTION\nIoT and Edge Computing create an \nenvironment in which micro-computers \nare all around us. This transforms the way \ncomputation is done, more on the edge or \nin the fog. New challenges like \"OTA \nProgramming Strategies\", \"Cyber-\nSecurity Risk Mitigation\" and \"Blockchain\" will \nbecome key for a sustainable digital \nenvironment.\nOPEN DATA HUB\nDATA SHARING AND COMMUNITY\nSoftware Development is rapidly changing, \ntopics like Agile Software Development, \nContinuous Compliance, Licensing, … require \na strong competence in Open Source, Open \nStandards and Open Data to connect as many \nsystems as possible and to open up data silos. \nEnabling the involved companies and research \ninstitutions to gain visibility and increase \nthe ROI for their I&amp;R&amp;D activities.\nAI (ARTIFICIAL INTELLIGENCE)\nDATA PROCESSING\nHyperconnected Services enable new Business \nModels like XaaS, everything as a service. MaaS\nis already in development and deep learning \nwill change how users will be involved in the \ncustomer journey.\nEXCELLENCE \n.PIONEERING \nSUSTAINABLE\n2030\nEstablish the digital backbone \nto enable smart green regions.\n"
        },
        {
          "page": 3,
          "content": "3\nTODAY - SOFTWARE DEVELOPERS' THURSDAY\n"
        },
        {
          "page": 4,
          "content": "4\nDISCUSSION TIME\nDISCUSSION TIME!\n"
        },
        {
          "page": 5,
          "content": "5\nNOI TECHPARK SÜDTIROL/ALTO ADIGE\nUPCOMING EVENTS\n"
        },
        {
          "page": 6,
          "content": "6\nNEXT SOFTWARE DEVELOPERS' THURSDAY\nMore info: https://noi.bz.it/it/eventi/software-developers-thursday/6f206455-c98b-4c11-\n913b-28d7b83a0e2b \n"
        },
        {
          "page": 7,
          "content": "7\nSOFTWARE DEVELOPERS' THURSDAY 2025 – WE WANT YOU\n2025 EVENT CALENDAR\nContact: s.seppi@noi.bz.it\nThe 2025 Software Developers' Thursday \nCalendar:\n•\nJanuary 9th (Booked)\n•\nFebruary 6th (Booked)\n•\nMarch 6th (Booked)\n•\nApril 3rd (Booked)\n•\nMay 9th (Booked)\n•\nJune 5th (Booked)\n•\nJuly 3rd (Booked)\n•\nAugust 7th (Booked)\n•\nSeptember 4th (Booked)\n•\nOctober 2nd (Booked)\n•\nDecember 4th\n2025\n"
        },
        {
          "page": 8,
          "content": "8\nNOI HACKATHON SUMMER EDITION – 1-2 AUGUST 2025 – CALL4VOLUTEERS\nMore info: https://hackathon.bz.it/ \n"
        },
        {
          "page": 9,
          "content": "9\nSFSCON 2025 – 7-8 NOVEMBER 2025 – CALL4VOLUTEERS\nMore info: https://www.sfscon.it/call4volunteers/ \n"
        },
        {
          "page": 10,
          "content": "10\nSFSCON 2025 – 7-8 NOVEMBER 2025\nMore info: https://www.sfscon.it/ \n"
        },
        {
          "page": 11,
          "content": "NOI TECHPARK\nSÜDTIROL/ALTO ADIGE\nVIA A.-VOLTA-STRASSE 13/A\nI – 39100 BOZEN/BOLZANO\n+39 0471/066 600\nINFO@NOI.BZ.IT\nWWW.NOI.BZ.IT\nTHANK YOU.\n"
        }
      ]
    }
  },
  "result": {
    "savedItemId": "pC8OTwo6x88im17SZx2rHk",
    "savedItems": []
  }
}</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich prüfe die Webhook-Route und die Download-Proxy-Route, um zu verifizieren, ob wir die Bild-Extraktion bewusst deaktiviert haben. Danach zeige ich die konkrete Stelle im Code und leite die Ursache ab.</p>
<p>Kurzupdate: Ich habe die Webhook-Route und die Download-Proxy-Route geprüft. In der Webhook-Implementierung wurde die lokale Bild-Extraktion bewusst abgeschaltet; das erklärt, warum kein Unterordner entsteht.</p>
<h3 id="befund">Befund<a class="headerlink" href="#befund" title="Permanent link">&para;</a></h3>
<ul>
<li>In <code>src/app/api/external/jobs/[jobId]/route.ts</code> wird für lokale Libraries die ZIP‑Extraktion explizit nicht mehr ausgeführt:
```257:275:src/app/api/external/jobs/[jobId]/route.ts
// Ab jetzt keine Bild-Archive mehr aus dem Webhook speichern – nur Link bereitstellen
<div class="highlight"><pre><span></span><code>- Der Webhook speichert nur den Shadow‑Twin und persistiert den Link zum Archiv:
```285:291:src/app/api/external/jobs/[jobId]/route.ts
await repo.setResult(jobId, {
  extracted_text: extractedText,
  images_archive_url: imagesArchiveUrlFromWorker || undefined,
  metadata: body?.data?.metadata,
}, { savedItemId, savedItems });
</code></pre></div></li>
<li>Dein Job-Dokument zeigt genau das Muster: <code>savedItems: []</code> und <code>images_archive_url</code> gesetzt, aber kein <code>images_extracted</code>-Logeintrag.</li>
</ul>
<p>Konsequenz: Es wird kein lokaler Ordner <code>.&lt;basename&gt;</code> erstellt, weil <code>ImageExtractionService.saveZipArchive(...)</code> im Webhook nicht aufgerufen wird. Stattdessen ist das ZIP zum Download über die Proxy-Route verfügbar:
```17:45:src/app/api/external/jobs/[jobId]/download-archive/route.ts
// Liest job.payload.images_archive_url, baut ggf. mit SECRETARY_SERVICE_URL die absolute URL
// und streamt das Archiv mit Service-Auth durch
<div class="highlight"><pre><span></span><code>### Was kann sein / Checks
- Erwartung vs. aktuelles Verhalten: UI erwartet den Bilder-Unterordner, Webhook erzeugt ihn nicht mehr.
- Falls Download auch nicht klappt: prüfe `.env` auf `SECRETARY_SERVICE_URL` und `SECRETARY_SERVICE_API_KEY`.

### Optionen zur Behebung
- Variante A (kleiner Eingriff, lokal): Im Webhook für `lib.type === &#39;local&#39;` bei gesetztem `images_archive_url` das ZIP vom Secretary laden, in Base64 konvertieren und an `ImageExtractionService.saveZipArchive(...)` übergeben. Ergebnis: Ordner `.&lt;basename&gt;` plus Bilder und optional per‑Page‑Markdown wird wieder erstellt.
- Variante B (Upstream): Secretary-Webhooks so anpassen, dass statt `images_archive_url` wieder `images_archive_data` (Base64) gesendet wird. Dann kann der Webhook ohne zusätzlichen Download direkt extrahieren.
- Variante C (On‑Demand im UI): Beim Klick „Bilder anzeigen“ ZIP über die Proxy‑Route laden und serverseitig in einen API-Handler extrahieren, der `ImageExtractionService.saveZipArchive(...)` nutzt. Vorteil: lazy; Nachteil: zusätzlicher Klick.

Empfehlung: Variante A für konsistentes Verhalten mit „includeImages: true“. Wenn du möchtest, baue ich im Webhook den minimalen Block ein: ZIP via `images_archive_url` herunterladen, Base64 erstellen, `saveZipArchive(...)` aufrufen, Logs und `savedItems` aktualisieren.

```typescript
// Ab jetzt keine Bild-Archive mehr aus dem Webhook speichern – nur Link bereitstellen
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">  </span><span class="nx">images_archive_url</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// Liest job.payload.images_archive_url, baut ggf. mit SECRETARY_SERVICE_URL die absolute URL</span>
<span class="c1">// und streamt das Archiv mit Service-Auth durch</span>
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>wir haben das nicht richtig verstanden. Hier nochmal eine genaue erklärung von unserem Sercretary service:
Ich sehe das Verhalten: Der Client erwartet weiterhin, dass der Webhook ein Bilder‑Unterverzeichnis erzeugt. Mit Variante B gibt es aber nur noch den Link zum ZIP, kein Base64 mehr im Payload. Ja – der Client muss jetzt einen zusätzlichen API‑Call ausführen und das ZIP selbst laden und entpacken.
Was hat sich geändert
Früher: images_archive_data (Base64) im Webhook → Client entpackt direkt.
Jetzt: data.images_archive_url im Webhook → Client muss das ZIP vom Secretary‑Service abholen.
Die URL ist aktuell relativ (z. B. /api/jobs/<jobId>/download-archive). Der Client muss sie mit SECRETARY_SERVICE_URL zur absoluten URL zusammensetzen.
Was der Client jetzt tun muss
Beim Webhook:
payload.data.images_archive_url lesen.
Absolute URL bauen: SECRETARY_SERVICE_URL + images_archive_url.
GET darauf ausführen mit Service‑Auth.
ZIP entpacken und bisherigen lokalen Workflow ausführen (Bilder/Ordner anlegen, savedItems/Logs setzen).
Umsetzung in eurer Webhook‑Route (Next.js/Node, stark vereinfacht):</p>
<hr />
<p>// route.ts
import { NextRequest, NextResponse } from 'next/server';
// import ImageExtractionService from '...';</p>
<p>export async function POST(req: NextRequest) {
  const body = await req.json();</p>
<p>const imagesArchiveUrlRel: string | undefined = body?.data?.images_archive_url;
  const extractedText: string | undefined = body?.data?.extracted_text;
  const metadata: any = body?.data?.metadata;</p>
<p>// persistiere Shadow-Twin/Job-Dokument minimal (ohne Bilder)
  // await repo.setResult(jobId, { extracted_text: extractedText, images_archive_url: imagesArchiveUrlRel, metadata });</p>
<p>// Optional: nur bei lokalen Libraries/Workflows direkt entpacken
  const isLocal = process.env.LIB_TYPE === 'local';
  if (isLocal &amp;&amp; imagesArchiveUrlRel) {
    const base = process.env.SECRETARY_SERVICE_URL || '';
    const url = imagesArchiveUrlRel.startsWith('http')
      ? imagesArchiveUrlRel
      : <code>${base}${imagesArchiveUrlRel}</code>;</p>
<pre><code>const headers: Record&lt;string, string&gt; = {};
const apiKey = process.env.SECRETARY_SERVICE_API_KEY || '';
if (apiKey) {
  headers['Authorization'] = `Bearer ${apiKey}`;
  headers['X-Secretary-Api-Key'] = apiKey; // Server akzeptiert beides
}

const resp = await fetch(url, { headers });
if (!resp.ok) {
  // loggen und mit Rückgabe fortfahren
  return NextResponse.json({ status: 'error', message: `Archiv-Download fehlgeschlagen: ${resp.status}` }, { status: 500 });
}

const arrayBuf = await resp.arrayBuffer();
const zipBuffer = Buffer.from(arrayBuf);

const baseName = body?.process?.id || 'job';
// Entpacken in euren lokalen Zielordner, plus Rückgabe der gespeicherten Items
// const { savedItems } = await ImageExtractionService.saveZipArchive(zipBuffer, baseName);

// Persistiert Ergebnis so wie früher:
// await repo.setResult(jobId, {
//   extracted_text: extractedText,
//   images_archive_url: imagesArchiveUrlRel,
//   metadata,
//   savedItems,
// });

// optional: Log „images_extracted“
</code></pre>
<p>}</p>
<p>return NextResponse.json({ status: 'ok' });
}</p>
<hr />
<p>Wichtig für den Download:
SECRETARY_SERVICE_URL in der .env setzen, z. B. http://localhost:5001.
SECRETARY_SERVICE_API_KEY setzen und beim Download als Authorization: Bearer <KEY> bzw. X-Secretary-Api-Key: <KEY> mitsenden.
Falls der Link relativ ist, immer mit SECRETARY_SERVICE_URL prefixen.
Checks bei euch
Erwartung vs. Verhalten: Der automatische Bilder‑Unterordner entsteht nicht mehr „beim Webhook“; erst der zusätzliche Download+Entpacken erzeugt ihn.
Wenn der Download nicht klappt: .env prüfen (SECRETARY_SERVICE_URL, SECRETARY_SERVICE_API_KEY), und dass der Server unter …/api/jobs/<jobId>/download-archive erreichbar ist.
Für UI‑Kompatibilität könnt ihr weiter den lokalen Pfad und savedItems analog früher befüllen, nachdem ihr saveZipArchive(...) aufgerufen habt.
Optionale Varianten
Variante A (kleiner Eingriff clientseitig): Bei lib.type === 'local' das ZIP sofort laden, Base64 konvertieren und saveZipArchive(...) aufrufen. Ergebnis: Ordner <basename> und savedItems sind wieder da, ohne Serveränderung.
Variante B (Upstream‑Variante, jetzt aktiv): Webhook enthält images_archive_url. Der Client lädt nach Bedarf das ZIP. Vorteil: schlanke Payloads, keine Mongo‑Größenlimits.
Variante C (On‑Demand im UI): „Bilder anzeigen“ löst den Download aus (zusätzlicher Klick), entpackt serverseitig in einem API‑Handler und aktualisiert savedItems per nachgelagertem Call.
Empfehlung: Für konsistente Webhooks includeImages: true beibehalten. Der Client lädt das ZIP über images_archive_url, entpackt, aktualisiert savedItems und Logs.
Kurztests
Webhook empfangen → images_archive_url vorhanden.
GET auf SECRETARY_SERVICE_URL + images_archive_url mit Auth → 200, Content-Type: application/zip.
ZIP entpackt → lokaler Unterordner <basename> und savedItems gefüllt.
Wenn ihr möchtet, kann ich die Webhook‑URL serverseitig sofort auf absolute URL umstellen, damit ihr nicht mehr prefixen müsst.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich füge in der Webhook-Route bei lokalen Libraries das Herunterladen des ZIPs vom Secretary-Service (mit Service-Auth), die Base64-Konvertierung und den Aufruf von ImageExtractionService.saveZipArchive hinzu, sodass der Bilder-Unterordner wieder erzeugt wird. Danach aktualisiere ich Logs und savedItems.</p>
<div class="highlight"><pre><span></span><code><span class="o">***</span><span class="w"> </span><span class="nx">Begin</span><span class="w"> </span><span class="nx">Patch</span>
<span class="o">***</span><span class="w"> </span><span class="nx">Update</span><span class="w"> </span><span class="nx">File</span><span class="o">:</span><span class="w"> </span><span class="kt">src</span><span class="o">/</span><span class="nx">app</span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">external</span><span class="o">/</span><span class="nx">jobs</span><span class="o">/</span><span class="p">[</span><span class="nx">jobId</span><span class="p">]</span><span class="o">/</span><span class="nx">route</span><span class="p">.</span><span class="nx">ts</span>
<span class="err">@@</span>
<span class="o">-</span><span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="o">-</span><span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="o">-</span>
<span class="o">-</span><span class="w">        </span><span class="c1">// Ab jetzt keine Bild-Archive mehr aus dem Webhook speichern – nur Link bereitstellen</span>
<span class="o">+</span><span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">        </span><span class="c1">// Neu: Wenn der Worker nur eine images_archive_url liefert, ZIP herunterladen und lokal extrahieren</span>
<span class="o">+</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">isAbsolute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^https?:\/\//i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">);</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isAbsolute</span>
<span class="o">+</span><span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span>
<span class="o">+</span><span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="si">}${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="o">+</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="o">+</span><span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span>
<span class="o">+</span><span class="w">            </span><span class="p">}</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">archiveUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Archiv-Download fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">arrayBuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">();</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">base64Zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">arrayBuf</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="o">+</span><span class="w">                  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="o">+</span><span class="w">                  </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="o">+</span><span class="w">                  </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="p">},</span>
<span class="o">+</span><span class="w">              </span><span class="p">};</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="o">+</span><span class="w">                </span><span class="nx">base64Zip</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="s1">&#39;images.zip&#39;</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">provider</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">folderId</span><span class="p">),</span>
<span class="o">+</span><span class="w">                </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">lang</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">textContents</span>
<span class="o">+</span><span class="w">              </span><span class="p">);</span>
<span class="o">+</span><span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="o">+</span><span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">            </span><span class="p">}</span>
<span class="o">+</span><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">            </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Extraktion fehlgeschlagen&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">          </span><span class="p">}</span>
<span class="o">+</span><span class="w">        </span><span class="p">}</span>

<span class="w">       </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">***</span><span class="w"> </span><span class="nx">End</span><span class="w"> </span><span class="nx">Patch</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">***</span><span class="w"> </span><span class="nx">Begin</span><span class="w"> </span><span class="nx">Patch</span>
<span class="o">***</span><span class="w"> </span><span class="nx">Update</span><span class="w"> </span><span class="nx">File</span><span class="o">:</span><span class="w"> </span><span class="kt">src</span><span class="o">/</span><span class="nx">app</span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">external</span><span class="o">/</span><span class="nx">jobs</span><span class="o">/</span><span class="p">[</span><span class="nx">jobId</span><span class="p">]</span><span class="o">/</span><span class="nx">route</span><span class="p">.</span><span class="nx">ts</span>
<span class="err">@@</span>
<span class="o">-</span><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="o">-</span><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="o">-</span><span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="o">-</span><span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath und savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="o">-</span><span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="o">-</span><span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="o">-</span>
<span class="o">-</span><span class="w">        </span><span class="c1">// Ab jetzt keine Bild-Archive mehr aus dem Webhook speichern – nur Link bereitstellen</span>
<span class="o">+</span><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="o">+</span><span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="o">+</span><span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath und savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="o">+</span><span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">        </span><span class="c1">// Neu: Wenn der Worker nur eine images_archive_url liefert, ZIP herunterladen und lokal extrahieren</span>
<span class="o">+</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">isAbsolute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^https?:\/\//i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">);</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isAbsolute</span>
<span class="o">+</span><span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span>
<span class="o">+</span><span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="si">}${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="o">+</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="o">+</span><span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span>
<span class="o">+</span><span class="w">            </span><span class="p">}</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">archiveUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Archiv-Download fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">arrayBuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">();</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">base64Zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">arrayBuf</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">                  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="o">+</span><span class="w">                  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="o">+</span><span class="w">                  </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="o">+</span><span class="w">                  </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="p">},</span>
<span class="o">+</span><span class="w">              </span><span class="p">};</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="o">+</span><span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="o">+</span><span class="w">                </span><span class="nx">base64Zip</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="s1">&#39;images.zip&#39;</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">provider</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">folderId</span><span class="p">),</span>
<span class="o">+</span><span class="w">                </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">lang</span><span class="p">,</span>
<span class="o">+</span><span class="w">                </span><span class="nx">textContents</span>
<span class="o">+</span><span class="w">              </span><span class="p">);</span>
<span class="o">+</span><span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="o">+</span><span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">            </span><span class="p">}</span>
<span class="o">+</span><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="o">+</span><span class="w">            </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Extraktion fehlgeschlagen&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="o">+</span><span class="w">          </span><span class="p">}</span>
<span class="o">+</span><span class="w">        </span><span class="p">}</span>

<span class="w">       </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">***</span><span class="w"> </span><span class="nx">End</span><span class="w"> </span><span class="nx">Patch</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bumpWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">/children`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive children list fehlgeschlagen: </span><span class="si">${</span><span class="nx">list</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">folder?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="nx">.value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">it</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">folder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">existing.id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;@microsoft.graph.conflictBehavior&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rename&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Ordnererstellung fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">created</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Watchdog heartbeat</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Pfade nur bei Bedarf auflösen (derzeit nicht benötigt)</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(sourceId ?? &#39;&#39;).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(targetParentId).catch(() =&gt; &#39;/&#39;);</span>
<span class="w">        </span><span class="c1">// Pfade ermitteln (aktuell nur für Debugging/Logging nutzbar)</span>
<span class="w">        </span><span class="c1">// const sourceAbsPath = sourceRelPath &amp;&amp; sourceRelPath !== &#39;/&#39; ? path.join(lib.path, sourceRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>
<span class="w">        </span><span class="c1">// const targetAbsPath = targetRelPath &amp;&amp; targetRelPath !== &#39;/&#39; ? path.join(lib.path, targetRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath &amp;&amp; savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Lade ZIP-Archiv bei Bedarf vom Secretary-Service und extrahiere lokal</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">isAbsolute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^https?:\/\//i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isAbsolute</span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="si">}${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">archiveUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Archiv-Download fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">arrayBuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">();</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">base64Zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">arrayBuf</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">                </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">                </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">                  </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">              </span><span class="p">};</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">                </span><span class="nx">base64Zip</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;images.zip&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">                </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">                </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">folderId</span><span class="p">),</span>
<span class="w">                </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">                </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">                </span><span class="nx">textContents</span>
<span class="w">              </span><span class="p">);</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Extraktion fehlgeschlagen&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Bilder nicht mehr vom Webhook-ZIP extrahieren – Link wird bereitgestellt</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_url</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Kurzupdate: Ich habe im Webhook für lokale Libraries das Nachladen und Entpacken des ZIP-Archivs integriert. Damit wird bei includeImages wieder der Bilder-Unterordner erstellt.</p>
<p>Was war die Ursache
- Der Secretary sendet nur noch <code>data.images_archive_url</code>, kein <code>images_archive_data</code> Base64. In unserer Route wurde deshalb kein Unterordner erzeugt.</p>
<p>Was ich geändert habe
- In <code>src/app/api/external/jobs/[jobId]/route.ts</code>, im <code>lib.type === 'local'</code> Zweig:
  - Wenn <code>images_archive_url</code> vorhanden ist:
    - Absolute URL bilden via <code>SECRETARY_SERVICE_URL</code>.
    - Mit <code>SECRETARY_SERVICE_API_KEY</code> herunterladen.
    - ZIP in Base64 konvertieren.
    - <code>ImageExtractionService.saveZipArchive(...)</code> aufrufen (mit <code>FileSystemProvider</code>), inklusive <code>text_contents</code>.
    - Logs <code>images_extracted</code> setzen und <code>savedItems</code> füllen.
- Lint ist grün.</p>
<p>Worauf achten
- <code>.env</code> muss <code>SECRETARY_SERVICE_URL</code> und <code>SECRETARY_SERVICE_API_KEY</code> enthalten.
- Die URL vom Secretary kann relativ sein; wir prefixen korrekt.
- OneDrive-Zweig bleibt unverändert (kein lokales Entpacken).</p>
<p>Testhinweis
- PDF erneut mit includeImages: true laufen lassen.
- Erwartet:
  - Shadow‑Twin <code>.md</code> im Zielordner.
  - Unterordner <code>.&lt;basename&gt;</code> mit <code>page_###.(png|jpg)</code> und optional pro‑Seite‑Markdown.
  - Job-Logs enthalten <code>images_extracted</code>.</p>
<p>Kurzfassung der Änderungen
- Webhook speichert wieder Bilder lokal bei <code>lib.type === 'local'</code> durch Download+Entpacken des ZIP.</p>
<hr />
<p><strong>User</strong></p>
<p>Bilddownload funktioniert noch nicht. Ich glaube wir haben in der URL 2 x api .</p>
<p>24
Object
timestamp
2025-08-25T14:16:07.619+00:00
phase
"running"
progress
null
message
"Seite 10 verarbeitet - Args: {"duration": 0.20214533805847168, "extrac…"</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich passe jetzt die URL-Zusammensetzung im Webhook an, damit kein doppeltes '/api' entsteht. Danach teste ich mit einer robusten Normalisierung von Base-URL und Pfad.</p>
<p>Ich passe die URL-Konstruktion an beiden betroffenen Routen an, damit keine doppelten '/api' entstehen. Ich verwende die URL-API für robuste Normalisierung. Jetzt führe ich die Edits aus.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bumpWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">/children`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive children list fehlgeschlagen: </span><span class="si">${</span><span class="nx">list</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">folder?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="nx">.value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">it</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">folder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">existing.id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;@microsoft.graph.conflictBehavior&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rename&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Ordnererstellung fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">created</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Watchdog heartbeat</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Pfade nur bei Bedarf auflösen (derzeit nicht benötigt)</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(sourceId ?? &#39;&#39;).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(targetParentId).catch(() =&gt; &#39;/&#39;);</span>
<span class="w">        </span><span class="c1">// Pfade ermitteln (aktuell nur für Debugging/Logging nutzbar)</span>
<span class="w">        </span><span class="c1">// const sourceAbsPath = sourceRelPath &amp;&amp; sourceRelPath !== &#39;/&#39; ? path.join(lib.path, sourceRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>
<span class="w">        </span><span class="c1">// const targetAbsPath = targetRelPath &amp;&amp; targetRelPath !== &#39;/&#39; ? path.join(lib.path, targetRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath &amp;&amp; savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Lade ZIP-Archiv bei Bedarf vom Secretary-Service und extrahiere lokal</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">isAbsolute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^https?:\/\//i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isAbsolute</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">baseRaw</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseRaw</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">rel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`/</span><span class="si">${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">                </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">rel</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span><span class="p">)</span>
<span class="w">                  </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">rel</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
<span class="w">                  </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">rel</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">archiveUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Archiv-Download fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">arrayBuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">();</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">base64Zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">arrayBuf</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">                </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">                </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">                  </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">              </span><span class="p">};</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">                </span><span class="nx">base64Zip</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;images.zip&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">                </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">                </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">folderId</span><span class="p">),</span>
<span class="w">                </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">                </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">                </span><span class="nx">textContents</span>
<span class="w">              </span><span class="p">);</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Extraktion fehlgeschlagen&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Bilder nicht mehr vom Webhook-ZIP extrahieren – Link wird bereitgestellt</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_url</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Kurzupdate: Ich habe die Archiv-URL-Bildung im Webhook robust gemacht, sodass ein doppeltes „/api“ vermieden wird und relative Pfade korrekt gegen <code>SECRETARY_SERVICE_URL</code> aufgelöst werden.</p>
<p>Was geändert wurde
- In <code>src/app/api/external/jobs/[jobId]/route.ts</code>:
  - Wenn <code>images_archive_url</code> relativ ist, wird zuerst <code>new URL(rel, SECRETARY_SERVICE_URL)</code> versucht.
  - Fallback: manuelles Normalisieren mit Präfix-Slash und Spezialfall, wenn die Base bereits mit <code>/api</code> endet und der Pfad mit <code>/api/</code> beginnt, wird das doppelte <code>/api</code> entfernt.
  - Ergebnis: Ein Request wie <code>GET http://127.0.0.1:5001/api/api/jobs/...</code> wird zu <code>GET http://127.0.0.1:5001/api/jobs/...</code>.</p>
<p>Bitte erneut testen
- PDF mit includeImages: true.
- Im Log sollten kein 404 mehr mit doppeltem <code>/api</code> erscheinen.
- Erwartung: Unterordner <code>.&lt;basename&gt;</code> wird wieder erstellt und <code>images_extracted</code> geloggt.</p>
<p>Falls es noch 404 gibt
- Prüfe <code>SECRETARY_SERVICE_URL</code> (z. B. <code>http://127.0.0.1:5001</code>), ohne abschließenden Slash.
- Prüfe, ob der Secretary-Link rel ist wie <code>/api/jobs/&lt;jobId&gt;/download-archive</code> und Pfad tatsächlich existiert.
- API-Key: <code>SECRETARY_SERVICE_API_KEY</code> gesetzt.</p>
<hr />
<p><strong>User</strong></p>
<p>ok, diese logliste unter jobs ist nicht vertikal scrollbar:</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich suche jetzt die betroffene UI-Komponente, die die Job-Logliste rendert, um dort eine begrenzte Höhe und overflow-y: auto hinzuzufügen. Danach passe ich die Styles an.</p>
<p>Ich ergänze in der Log-HoverCard eine ScrollArea mit fixer Max-Höhe, damit der Inhalt vertikal scrollbar ist. Jetzt wende ich die UI-Änderung an.</p>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { Badge } from &quot;@/components/ui/badge&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const variant = status === &#39;completed&#39; ? &#39;default&#39;
    : status === &#39;running&#39; ? &#39;secondary&#39;
    : status === &#39;failed&#39; ? &#39;destructive&#39;
    : &#39;outline&#39;;
  return &lt;Badge variant={variant}&gt;{status}&lt;/Badge&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const isFetchingRef = useRef(false);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());

  // Initiale Seite laden
  useEffect(() =&gt; {
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const res = await fetch(`/api/external/jobs?page=${pageNum}&amp;limit=20`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    load(1, true);
    return () =&gt; { cancelled = true; };
  }, []);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const res = await fetch(`/api/external/jobs?page=1&amp;limit=20`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden (mit einfachem Reconnect und Initial-Refresh)
  useEffect(() =&gt; {
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      es.addEventListener(&#39;open&#39;, () =&gt; {
        void refreshNow();
      });

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job → vorne einfügen
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        retryTimer = setTimeout(connect, 3000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, []);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className=&quot;border rounded-md p-3&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-96 p-0&quot;&gt;
                          &lt;ScrollArea className=&quot;max-h-80 p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Kurzupdate: Ich habe die Job-Logliste im HoverCard-Overlay scrollbar gemacht.</p>
<p>Änderung
- In <code>src/components/shared/job-monitor-panel.tsx</code>:
  - <code>HoverCardContent</code> verbreitert und Padding angepasst.
  - <code>ScrollArea</code> mit <code>max-h-80</code> und <code>overflow-y</code> via Komponente um die Logs gelegt.</p>
<p>Ergebnis
- Die Log-Popover-Liste ist jetzt vertikal scrollbar und schneidet lange Logserien nicht mehr ab.</p>
<hr />
<p><strong>User</strong></p>
<p>Diese Popup-Liste ist leider noch nicht scrollbar. Sie ist jetzt nur noch halb so hoch. Sie kann schon die tolle Bildschirmhöhe haben. Sie sollte mit der Maus, mit dem Mausrad oder mit dem Fingerswipe fertig als scrollbar sein.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich passe die HoverCard so an, dass der Inhalt nahezu die gesamte Bildschirmhöhe nutzen kann und sicher scrollbar ist: Das Overlay bekommt eine maximale Höhe, und die ScrollArea darin erhält eine feste Höhe (80vh) plus Overflow. Ich führe jetzt den Edit durch.</p>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { Badge } from &quot;@/components/ui/badge&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const variant = status === &#39;completed&#39; ? &#39;default&#39;
    : status === &#39;running&#39; ? &#39;secondary&#39;
    : status === &#39;failed&#39; ? &#39;destructive&#39;
    : &#39;outline&#39;;
  return &lt;Badge variant={variant}&gt;{status}&lt;/Badge&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const isFetchingRef = useRef(false);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());

  // Initiale Seite laden
  useEffect(() =&gt; {
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const res = await fetch(`/api/external/jobs?page=${pageNum}&amp;limit=20`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    load(1, true);
    return () =&gt; { cancelled = true; };
  }, []);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const res = await fetch(`/api/external/jobs?page=1&amp;limit=20`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden (mit einfachem Reconnect und Initial-Refresh)
  useEffect(() =&gt; {
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      es.addEventListener(&#39;open&#39;, () =&gt; {
        void refreshNow();
      });

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job → vorne einfügen
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        retryTimer = setTimeout(connect, 3000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, []);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className=&quot;border rounded-md p-3&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-[36rem] p-0 max-h-[85vh]&quot;&gt;
                          &lt;ScrollArea className=&quot;h-[80vh] overflow-y-auto p-2 text-xs&quot;&gt;
                            &lt;JobLogs jobId={item.jobId} /&gt;
                          &lt;/ScrollArea&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Kurzupdate: Ich habe die HoverCard so erweitert, dass sie fast die gesamte Bildschirmhöhe nutzen kann und sicher scrollbar ist.</p>
<p>Anpassungen
- <code>HoverCardContent</code>: <code>max-h-[85vh]</code>, Breite <code>w-[36rem]</code>.
- <code>ScrollArea</code>: feste Höhe <code>h-[80vh]</code>, <code>overflow-y-auto</code>, Innenabstand <code>p-2</code>.</p>
<p>Erwartetes Verhalten
- Liste nutzt große Höhe, scrollt zuverlässig mit Maus, Mausrad und Touch.</p>
<hr />
<p><strong>User</strong></p>
<p>Der Download schlägt Fehl. Warum wird dann trotzdem Completed als ergänzend angezeigt? Was fehlschlägt, soll es als Fehler angemerkt werden.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich markiere den Job als failed, wenn der Bilder-Download (HTTP != 200) oder das Entpacken fehlschlägt: Ich setze Status 'failed' mit Fehlerdetails, persistiere gepufferte Logs, sende ein SSE-Update und beende die Route frühzeitig, statt unten 'completed' zu setzen. Jetzt führe ich die Edits in der Webhook-Route durch.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bumpWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">/children`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive children list fehlgeschlagen: </span><span class="si">${</span><span class="nx">list</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">folder?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="nx">.value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">it</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">folder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">existing.id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;@microsoft.graph.conflictBehavior&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rename&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Ordnererstellung fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">created</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Watchdog heartbeat</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Pfade nur bei Bedarf auflösen (derzeit nicht benötigt)</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(sourceId ?? &#39;&#39;).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(targetParentId).catch(() =&gt; &#39;/&#39;);</span>
<span class="w">        </span><span class="c1">// Pfade ermitteln (aktuell nur für Debugging/Logging nutzbar)</span>
<span class="w">        </span><span class="c1">// const sourceAbsPath = sourceRelPath &amp;&amp; sourceRelPath !== &#39;/&#39; ? path.join(lib.path, sourceRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>
<span class="w">        </span><span class="c1">// const targetAbsPath = targetRelPath &amp;&amp; targetRelPath !== &#39;/&#39; ? path.join(lib.path, targetRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath &amp;&amp; savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Lade ZIP-Archiv bei Bedarf vom Secretary-Service und extrahiere lokal</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">isAbsolute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^https?:\/\//i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isAbsolute</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">baseRaw</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseRaw</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">rel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`/</span><span class="si">${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">                </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">rel</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span><span class="p">)</span>
<span class="w">                  </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">rel</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
<span class="w">                  </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">rel</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">archiveUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Archiv-Download fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="c1">// Markiere Job als fehlgeschlagen und beende</span>
<span class="w">              </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bild-Archiv konnte nicht geladen werden&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">resp.status</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Archiv-Download fehlgeschlagen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed_images_download&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">arrayBuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">();</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">base64Zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">arrayBuf</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">                </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">                </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">                  </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">              </span><span class="p">};</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">                </span><span class="nx">base64Zip</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;images.zip&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">                </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">                </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">folderId</span><span class="p">),</span>
<span class="w">                </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">                </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">                </span><span class="nx">textContents</span>
<span class="w">              </span><span class="p">);</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Extraktion fehlgeschlagen&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="c1">// Markiere Job als fehlgeschlagen und beende</span>
<span class="w">            </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Archiv konnte nicht extrahiert werden&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bilder-Extraktion fehlgeschlagen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed_images_extract&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Bilder nicht mehr vom Webhook-ZIP extrahieren – Link wird bereitgestellt</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_url</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Kurzupdate: Ich habe den Webhook so geändert, dass ein Fehlschlag beim Bilder-Download oder beim Entpacken den Job korrekt als failed markiert, Logs persistiert und ein SSE-Failed-Update sendet. Damit wird nicht mehr „completed“ angezeigt, wenn die Bilder fehlen.</p>
<p>Änderungen
- In <code>src/app/api/external/jobs/[jobId]/route.ts</code>, im lokalen Zweig:
  - Wenn <code>fetch(archiveUrl)</code> nicht ok:
    - <code>images_download_failed</code> loggen.
    - Watchdog stoppen, gepufferte Logs persistieren.
    - <code>repo.setStatus(..., 'failed', { error: { code: 'images_download_failed', ... }})</code>.
    - SSE-Update mit Status <code>failed</code>.
    - Frühe Rückgabe, kein späteres <code>completed</code>.
  - Bei Catch während ZIP‑Extraktion analog mit <code>images_extract_failed</code>.</p>
<p>Erwartetes Verhalten
- Bei HTTP 400/404 o.ä. wird der Job als failed angezeigt.
- Erst wenn Download und Extraktion erfolgreich, läuft der Handler zum <code>completed</code>-Block weiter.</p>
<hr />
<p><strong>User</strong></p>
<p>??</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich behebe den Build-Fehler, indem ich die unbenutzte Funktion <code>onedriveEnsureFolder</code> aus <code>src/app/api/external/jobs/[jobId]/route.ts</code> entferne. Danach prüfe ich die Lints für diese Datei.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bumpWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// onedriveEnsureFolder wurde entfernt, da nicht verwendet</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Watchdog heartbeat</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Pfade nur bei Bedarf auflösen (derzeit nicht benötigt)</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(sourceId ?? &#39;&#39;).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(targetParentId).catch(() =&gt; &#39;/&#39;);</span>
<span class="w">        </span><span class="c1">// Pfade ermitteln (aktuell nur für Debugging/Logging nutzbar)</span>
<span class="w">        </span><span class="c1">// const sourceAbsPath = sourceRelPath &amp;&amp; sourceRelPath !== &#39;/&#39; ? path.join(lib.path, sourceRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>
<span class="w">        </span><span class="c1">// const targetAbsPath = targetRelPath &amp;&amp; targetRelPath !== &#39;/&#39; ? path.join(lib.path, targetRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath &amp;&amp; savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Lade ZIP-Archiv bei Bedarf vom Secretary-Service und extrahiere lokal</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">isAbsolute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^https?:\/\//i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isAbsolute</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">baseRaw</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseRaw</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">rel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`/</span><span class="si">${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">                </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">rel</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span><span class="p">)</span>
<span class="w">                  </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">rel</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
<span class="w">                  </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">rel</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">archiveUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Archiv-Download fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="c1">// Markiere Job als fehlgeschlagen und beende</span>
<span class="w">              </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bild-Archiv konnte nicht geladen werden&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">resp.status</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Archiv-Download fehlgeschlagen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed_images_download&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">arrayBuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">();</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">base64Zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">arrayBuf</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">                </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">                </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">                  </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">              </span><span class="p">};</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">                </span><span class="nx">base64Zip</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;images.zip&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">                </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">                </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">folderId</span><span class="p">),</span>
<span class="w">                </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">                </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">                </span><span class="nx">textContents</span>
<span class="w">              </span><span class="p">);</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Extraktion fehlgeschlagen&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="c1">// Markiere Job als fehlgeschlagen und beende</span>
<span class="w">            </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Archiv konnte nicht extrahiert werden&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bilder-Extraktion fehlgeschlagen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed_images_extract&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Bilder nicht mehr vom Webhook-ZIP extrahieren – Link wird bereitgestellt</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_url</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Kurzupdate: Der Build ist wegen einer unbenutzten Funktion fehlgeschlagen. Ich habe <code>onedriveEnsureFolder</code> entfernt; Lint für die Datei ist jetzt sauber.</p>
<ul>
<li>Fehler behoben: <code>src/app/api/external/jobs/[jobId]/route.ts</code> hatte <code>onedriveEnsureFolder</code> ungenutzt.</li>
<li>Du kannst <code>pnpm build</code> erneut ausführen. Warnings in anderen Dateien sind „nur“ Hinweise und blockieren den Build nicht; auf Wunsch können wir die Hook-Dependencies danach gezielt bereinigen.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js"></script>
      
        <script src="../../assets/javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>