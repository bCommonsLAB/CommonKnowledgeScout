
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://localhost:3000/docs/_history/08_august/cursor_2025.08.23_systematisches_beheben_von_linte.html">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Systematisches Beheben von Linterfehlern - Common Knowledge Scout</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/print.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#systematisches-beheben-von-linterfehlern" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Common Knowledge Scout" class="md-header__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Common Knowledge Scout
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Systematisches Beheben von Linterfehlern
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Common Knowledge Scout" class="md-nav__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Common Knowledge Scout
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/intro.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/features.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/architecture.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/core-components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core Components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/getting-started.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/settings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Settings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/library.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using the Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/event-monitor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event Monitor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/batch-session-import.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Session Import
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/troubleshooting.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/faq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/storage-provider.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage Provider
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/localstorage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileSystem (Local)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/image-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/pdf/extraction-methods.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/metadata.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metadata
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/global-state.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Global State
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/header.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Header
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/breadcrumb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Breadcrumb
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-tree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileTree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-list.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileList
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/upload.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Upload
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-preview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FilePreview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/batch-transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/error-handling-logging-testing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Error Handling & Tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/initialization-sequence.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Initialization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Library Components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/shadowtwins.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/extended-shadowtwin.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extended Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/transformation-service.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformation Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/video-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Video Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/glossary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/secretary-services.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Secretary Services
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/track-processor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Track Processor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chat-response-generation-process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat & Story Mode
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/deployment/docker.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker Deployment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/quick-setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Quick Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/package-strategy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Package Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="systematisches-beheben-von-linterfehlern">Systematisches Beheben von Linterfehlern<a class="headerlink" href="#systematisches-beheben-von-linterfehlern" title="Permanent link">&para;</a></h1>
<p><em>Exported on 8/30/2025 at 11:46:53 GMT+2 from Cursor (1.5.5)</em></p>
<hr />
<p><strong>User</strong></p>
<p>Wenn wir dieses Projekt jetzt builden, können wir das systematisch alle Linterfehler beheben, selbstständig.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich starte mit den drei API-Routen, die Build-blockierende Fehler haben, und lese ihren Code, um die konkreten <code>any</code>-Stellen gezielt zu typisieren. Danach wende ich minimal-invasive Edits an und prüfe erneut.</p>
<p>Ich lese die relevanten Typdeklarationen für Jobs, Event-Bus und verwandte Services, um die <code>any</code>-Verwendungen korrekt zu ersetzen und ungenutzte Variablen zu bereinigen. Danach setze ich gezielte Edits an genau den gemeldeten Stellen an.</p>
<p>Ich prüfe die Event-Bus- und Repository-Typen parallel, damit ich die <code>any</code>-Stellen in den API-Routen korrekt typisieren kann. Danach wende ich gezielte Edits an.</p>
<p>Ich beginne mit den API-Routen und dem Transform-Service: füge typsichere Repository-Methoden hinzu, ersetze alle any-Verwendungen in den betroffenen Routen, mache die Markdown-Hilfsfunktion öffentlich, und entferne ungenutzte Variablen/Importe. Danach baue ich erneut.</p>
<p>Ich erweitere das Repository um typsichere List-/Count-Methoden und passe die <code>external/jobs/route.ts</code> auf diese API an. Danach prüfe ich Linter erneut.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Collection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;mongodb&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getCollection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/mongodb-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="nx">ExternalJobStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">collectionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;external_jobs&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">getCollection</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Collection</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">getCollection</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collectionName</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">secret</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">create</span><span class="p">(</span><span class="nx">job</span><span class="o">:</span><span class="w"> </span><span class="kt">Omit</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;createdAt&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;updatedAt&#39;</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">job</span><span class="p">,</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJobStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">extra</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...</span><span class="nx">extra</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">modifiedCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">processId</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$push</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">logs</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">...</span><span class="nx">entry</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">payload</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExternalJob</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">col</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listByUserEmail</span><span class="p">(</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">[];</span><span class="w"> </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">20</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">col</span>
<span class="w">      </span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">skip</span><span class="p">((</span><span class="nx">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">limit</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">      </span><span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">col</span><span class="p">.</span><span class="nx">countDocuments</span><span class="p">({</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJob</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/external-job&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;20&#39;</span><span class="p">)));</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">curPage</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">curLimit</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">listByUserEmail</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">mapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">j</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalJob</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">[</span><span class="nx">j</span><span class="p">.</span><span class="nx">logs</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">j.jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">j.status</span><span class="p">,</span>
<span class="w">        </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">j.operation</span><span class="p">,</span>
<span class="w">        </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">j.worker</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">j.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">j.correlation?.source?.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">j.updatedAt</span><span class="p">,</span>
<span class="w">        </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">j.createdAt</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lastMessage</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">last</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">last.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lastProgress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">last</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">last.progress</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">curPage</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">curLimit</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">mapped</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="p">,</span><span class="w"> </span><span class="nx">JobUpdateEvent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;nodejs&#39;</span><span class="p">;</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">dynamic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;force-dynamic&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ReadableStream</span><span class="o">&lt;</span><span class="nb">Uint8Array</span><span class="o">&gt;</span><span class="p">({</span>
<span class="w">    </span><span class="nx">start</span><span class="p">(</span><span class="nx">controller</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">encoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="p">();</span>

<span class="w">      </span><span class="c1">// Initial event: connected</span>
<span class="w">      </span><span class="nx">controller</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="sb">`event: connected\n`</span><span class="p">));</span>
<span class="w">      </span><span class="nx">controller</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="sb">`data: </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="sb">)}\n\n`</span><span class="p">));</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">unsubscribe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">evt</span><span class="o">:</span><span class="w"> </span><span class="kt">JobUpdateEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">controller</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="sb">`event: job_update\n`</span><span class="p">));</span>
<span class="w">        </span><span class="nx">controller</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="sb">`data: </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span><span class="si">}</span><span class="sb">\n\n`</span><span class="p">));</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">keepAlive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">controller</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="sb">`event: ping\n`</span><span class="p">));</span>
<span class="w">        </span><span class="nx">controller</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">(</span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="sb">`data: </span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">\n\n`</span><span class="p">));</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">25000</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Cleanup</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">keepAlive</span><span class="p">);</span>
<span class="w">        </span><span class="nx">unsubscribe</span><span class="p">();</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="c1">// Cleanup über AbortSignal wenn vorhanden</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">signal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">signal?</span><span class="o">:</span><span class="w"> </span><span class="kt">AbortSignal</span><span class="w"> </span><span class="p">}).</span><span class="nx">signal</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">signal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">signal</span><span class="p">.</span><span class="nx">addEventListener</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">signal</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;abort&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">close</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/event-stream&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Cache-Control&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-cache, no-transform&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Connection&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;keep-alive&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;X-Accel-Buffering&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">/children`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive children list fehlgeschlagen: </span><span class="si">${</span><span class="nx">list</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">folder?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="nx">.value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">it</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">folder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">existing.id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;@microsoft.graph.conflictBehavior&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rename&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Ordnererstellung fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">created</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveData</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceRelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">sourceId</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetRelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceAbsPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sourceRelPath</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">sourceRelPath</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceRelPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetAbsPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">targetRelPath</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">targetRelPath</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">targetRelPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedRelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedAbsPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">savedRelPath</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">savedRelPath</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">savedRelPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">            </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">              </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">              </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">          </span><span class="p">};</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">            </span><span class="nx">imagesArchiveData</span><span class="p">,</span>
<span class="w">            </span><span class="nx">imagesArchiveFilename</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;pdf_images.zip&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">            </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">            </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">            </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">            </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span>
<span class="w">          </span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">,</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="sb">`.</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">JSZip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;jszip&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">JSZip</span><span class="p">.</span><span class="k">default</span><span class="p">().</span><span class="nx">loadAsync</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">zip</span><span class="p">.</span><span class="nx">files</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">imagesSaved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">fileEntry</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">entries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">dir?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">}).</span><span class="nx">dir</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ext</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpeg&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">ext</span><span class="p">))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`image.</span><span class="si">${</span><span class="nx">ext</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^image_(\d+)/</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">_m</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`page_</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;png&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;image/png&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">async</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Buffer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}).</span><span class="k">async</span><span class="p">(</span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">imgItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="p">,</span><span class="w"> </span><span class="nx">bin</span><span class="p">);</span>
<span class="w">            </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">imgItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">            </span><span class="nx">imagesSaved</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">textContents</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/page_(\d+)/</span><span class="p">);</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mf">1</span><span class="p">]);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">page</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.(png|jpg|jpeg)$/i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span>
<span class="w">                    </span><span class="sb">`# </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n\n## Quelle\n**PDF-Datei:** </span><span class="si">${</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="sb">\n**Bild:** </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n**Sprache:** </span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">\n**Seite:** </span><span class="si">${</span><span class="nx">page</span><span class="si">}</span><span class="sb">\n\n## Extrahierter Text\n</span><span class="si">${</span><span class="nx">tc</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="sb">\n`</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;utf8&#39;</span>
<span class="w">                  </span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">mdName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mdItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imagesSaved</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_data</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveData</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_filename</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveFilename</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StorageItem</span><span class="p">,</span><span class="w"> </span><span class="nx">StorageProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@/lib/storage/types&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">transformAudio</span><span class="p">,</span><span class="w"> </span><span class="nx">transformText</span><span class="p">,</span><span class="w"> </span><span class="nx">transformVideo</span><span class="p">,</span><span class="w"> </span><span class="nx">transformPdf</span><span class="p">,</span><span class="w"> </span><span class="nx">transformImage</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryAudioResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryVideoResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryPdfResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryImageResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@/lib/secretary/client&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">,</span><span class="w"> </span><span class="nx">ImageExtractionResult</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./image-extraction-service&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">useCache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="c1">// Neu: Cache-Option für alle Transformationen</span>
<span class="w">  </span><span class="nx">includeImages?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="c1">// Neu: Bilder mit extrahieren und speichern</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">PdfTransformOptions</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">TransformResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">savedItem?</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">;</span>
<span class="w">  </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">[];</span>
<span class="w">  </span><span class="nx">imageExtractionResult?</span><span class="o">:</span><span class="w"> </span><span class="kt">ImageExtractionResult</span><span class="p">;</span><span class="w"> </span><span class="c1">// Neu: Ergebnis der Bild-Extraktion</span>
<span class="w">  </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">VideoTransformOptions</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extractAudio</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">extractFrames</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">frameInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">sourceLanguage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">template?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ImageTransformOptions</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">context?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Typ für die Metadaten, die im Frontmatter gespeichert werden</span>
<span class="cm"> */</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">TransformMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">  </span><span class="nx">source_file?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source_file_id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source_file_size?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source_file_type?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Transformations-Informationen</span>
<span class="w">  </span><span class="nx">source_language?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">target_language?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Audio-Metadaten</span>
<span class="w">  </span><span class="nx">audio_duration?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_format?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_channels?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_sample_rate?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_bit_rate?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Prozess-Informationen</span>
<span class="w">  </span><span class="nx">process_id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">processor?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">processing_duration_ms?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">model_used?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokens_used?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">  </span><span class="nx">cache_used?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">cache_key?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Weitere Felder können hinzugefügt werden</span>
<span class="w">  </span><span class="p">[</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * TransformService - Zentraler Service für Transformations- und Speicheroperationen</span>
<span class="cm"> * Verantwortlich für:</span>
<span class="cm"> * - Transformation von Audio zu Text</span>
<span class="cm"> * - Transformation von Text zu optimiertem Text</span>
<span class="cm"> * - Speichern der Ergebnisse als Shadow-Twin oder als neue Datei</span>
<span class="cm"> * - Aktualisieren der Dateiliste</span>
<span class="cm"> * - Bereitstellen einer einheitlichen Schnittstelle für alle Transformationstypen</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Generiert einen standardisierten Namen für einen Shadow-Twin</span>
<span class="cm">   * @param originalName Der ursprüngliche Dateiname</span>
<span class="cm">   * @param targetLanguage Die Zielsprache</span>
<span class="cm">   * @returns Der generierte Shadow-Twin-Name ohne Dateiendung</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">generateShadowTwinName</span><span class="p">(</span><span class="nx">originalName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Entferne alle Dateiendungen aus dem Namen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">nameWithoutExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">nameWithoutExtension</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">targetLanguage</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert eine Audio-Datei in Text</span>
<span class="cm">   * @param file Die zu transformierende Audio-Datei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Speicheroptionen</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformAudio</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Audio-Datei wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformAudio</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Falls die Response nur ein String ist (alte API)</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Neue API mit vollständigen Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">audioResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryAudioResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">audioResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Sammle relevante Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">source_language</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.transcription.source_language</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Audio-Metadaten (falls vorhanden)</span>
<span class="w">        </span><span class="nx">audio_duration</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_format</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.format</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_channels</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.channels</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_sample_rate</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.sample_rate</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_bit_rate</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.bit_rate</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Erstelle Markdown-Inhalt mit Frontmatter</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">shadowTwinName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">generateShadowTwinName</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">shadowTwinName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert eine Video-Datei</span>
<span class="cm">   * @param file Die zu transformierende Video-Datei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Optionen für Video-Transformation und Speicherung</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis inklusive Video-spezifischer Daten</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformVideo</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">VideoTransformOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] transformVideo gestartet mit Optionen:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Video-Datei wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformVideo</span><span class="p">(</span>
<span class="w">      </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">extractAudio</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractAudio</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extractFrames</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractFrames</span><span class="p">,</span>
<span class="w">        </span><span class="nx">frameInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">options.frameInterval</span><span class="p">,</span>
<span class="w">        </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sourceLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.sourceLanguage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">options.template</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span>
<span class="w">      </span><span class="nx">libraryId</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Vollständige Video-Response:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Response-Check:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">responseType</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
<span class="w">      </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasTranscription</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">),</span>
<span class="w">      </span><span class="nx">transcriptionType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">transcriptionKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Transkription gefunden:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Vollständige Video-Response mit Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">videoResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryVideoResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">videoResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>

<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Extrahierter Text-Länge:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Text-Vorschau:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">));</span>

<span class="w">      </span><span class="c1">// Sammle relevante Video-Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">source_language</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.transcription.source_language</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">sourceLanguage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Video-Metadaten</span>
<span class="w">        </span><span class="nx">video_duration</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">video_duration_formatted</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.duration_formatted</span><span class="p">,</span>
<span class="w">        </span><span class="nx">video_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.file_size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">video_title</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.title</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_file</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.audio_file</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub_processors</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.sub_processors?.join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Extrahierte Metadaten:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TransformService] Keine Transkription in der Response gefunden!&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TransformService] Response-Struktur:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
<span class="w">        </span><span class="nx">hasTranscription</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">),</span>
<span class="w">        </span><span class="nx">responseKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Finaler transformierter Text-Länge:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Erstelle Markdown-Inhalt mit Frontmatter</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Speichere Shadow-Twin mit Länge:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">markdownContent</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Keine Speicherung:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert einen Text mithilfe des Secretary Services</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformText</span><span class="p">(</span>
<span class="w">    </span><span class="nx">textContent</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Besprechung&quot;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] transformText aufgerufen mit:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">originalItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">options</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">template</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Text wird transformiert</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformText</span><span class="p">(</span>
<span class="w">      </span><span class="nx">textContent</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert eine PDF-Datei mithilfe des Secretary Services</span>
<span class="cm">   * @param file Die zu transformierende PDF-Datei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Speicheroptionen</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformPdf</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">PdfTransformOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PDF-Transformation gestartet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">options.includeImages</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IncludeImages Option&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">options.includeImages</span><span class="p">,</span>
<span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// PDF-Datei wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformPdf</span><span class="p">(</span>
<span class="w">      </span><span class="nx">file</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">originalItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalFileName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Vollständige PDF-Response&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Asynchroner Flow: nur &quot;accepted&quot; → Ergebnis via Webhook, kein Client-Fehler</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">).</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">).</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job akzeptiert – Ergebnis kommt per Webhook&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">job</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fromCache</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">job</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Response-Check&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">responseType</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
<span class="w">      </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasExtractedText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">),</span>
<span class="w">      </span><span class="nx">extractedTextType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Prüfe auf images_archive_data</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Images Archive Check&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasImagesArchiveData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">),</span>
<span class="w">      </span><span class="nx">hasImagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="p">),</span>
<span class="w">      </span><span class="nx">imagesArchiveDataLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">response.data.images_archive_data.length</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extracted-Text gefunden&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textPreview</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Vollständige PDF-Response mit Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">pdfResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryPdfResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pdfResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Sammle relevante PDF-Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// PDF-Metadaten</span>
<span class="w">        </span><span class="nx">page_count</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.page_count</span><span class="p">,</span>
<span class="w">        </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.format</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extraction_method</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.extraction_method</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_name</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.file_name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.file_size</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub_processors</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.sub_processors?.join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extrahierte Metadaten&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Keine synchronen PDF-Daten erhalten&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">).</span><span class="nx">data</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">imageExtractionResult</span><span class="o">:</span><span class="w"> </span><span class="kt">ImageExtractionResult</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starte Bild-Extraktion&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.images_archive_filename</span><span class="p">,</span>
<span class="w">          </span><span class="nx">imagesArchiveDataLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.images_archive_data.length</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="nx">imageExtractionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">          </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">,</span>
<span class="w">          </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;pdf_images.zip&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">          </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">          </span><span class="nx">refreshItems</span><span class="p">,</span>
<span class="w">          </span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Extrahierten Text weitergeben</span>
<span class="w">          </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span><span class="w"> </span><span class="c1">// Target Language weitergeben</span>
<span class="w">          </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="c1">// Seiten-spezifische Texte weitergeben</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bild-Extraktion abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">folderCreated</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">imageExtractionResult</span><span class="p">.</span><span class="nx">folderItem</span><span class="p">,</span>
<span class="w">          </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">imageExtractionResult.savedItems.length</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Fehler bei der Bild-Extraktion&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Bild-Extraktion ist optional, daher weitermachen</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Finaler transformierter Text&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// NEU: Detaillierte Debug-Logs für das Speicherproblem</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speicher-Bedingungen prüfen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasTransformedText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">transformedTextLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">markdownContentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownContent.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">willSave</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speichere Shadow-Twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">markdownLength</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownContent.length</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Shadow-Twin erfolgreich gespeichert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">savedItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem?.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems.length</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span><span class="p">,</span>
<span class="w">        </span><span class="nx">imageExtractionResult</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Keine Speicherung - Bedingungen nicht erfüllt&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;createShadowTwin ist false&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transformedText ist leer&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">imageExtractionResult</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert ein Bild mithilfe des Secretary Services</span>
<span class="cm">   * @param file Die zu transformierende Bilddatei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Optionen für Bild-Transformation und Speicherung</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformImage</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">ImageTransformOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bild-Transformation gestartet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Bild wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformImage</span><span class="p">(</span>
<span class="w">      </span><span class="nx">file</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Vollständige Bild-Response&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extracted-Text gefunden&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textPreview</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Vollständige Bild-Response mit Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryImageResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imageResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Sammle relevante Bild-Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Bild-Metadaten</span>
<span class="w">        </span><span class="nx">dimensions</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.dimensions</span><span class="p">,</span>
<span class="w">        </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.format</span><span class="p">,</span>
<span class="w">        </span><span class="nx">color_mode</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.color_mode</span><span class="p">,</span>
<span class="w">        </span><span class="nx">dpi</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.dpi?.join</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">extraction_method</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.extraction_method</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_name</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.file_name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.file_size</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub_processors</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.sub_processors?.join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extrahierte Metadaten&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Kein Extracted-Text in der Response gefunden!&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">responseKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Finaler transformierter Text&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speichere Shadow-Twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">markdownLength</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownContent.length</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Keine Speicherung&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Hilfsmethode zum Speichern der transformierten Datei</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">savedItem?</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">;</span><span class="w"> </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">[]</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] saveTwinFile aufgerufen mit:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">originalItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">fileExtension</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// NEU: Detaillierte Debug-Logs</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;saveTwinFile gestartet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">originalItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">fileExtension</span><span class="p">,</span>
<span class="w">      </span><span class="nx">contentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">content.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Hole aktuelle Dateien im Verzeichnis</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">refreshItems</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Aktuelle Dateien im Verzeichnis&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">itemCount</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">existingFiles</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Funktion zum Generieren eines eindeutigen Dateinamens</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">generateUniqueFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">baseName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">extension</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">candidateName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">extension</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Prüfe ob der Name bereits existiert</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">currentItems</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">        </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">        </span><span class="nx">item</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">candidateName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="w">      </span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="nx">candidateName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">(</span><span class="si">${</span><span class="nx">counter</span><span class="si">}</span><span class="sb">).</span><span class="si">${</span><span class="nx">extension</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">candidateName</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Generiere eindeutigen Dateinamen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateUniqueFileName</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span><span class="w"> </span><span class="nx">fileExtension</span><span class="p">);</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Eindeutiger Dateiname generiert:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">baseNameWithLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">uniqueFileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">existingFiles</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Dateiname generiert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">baseName</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">uniqueFileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">existingFilesCount</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">length</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Markdown-Datei erstellen und speichern</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileBlob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">content</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text/markdown&quot;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">fileBlob</span><span class="p">],</span><span class="w"> </span><span class="nx">uniqueFileName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text/markdown&quot;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Datei vorbereitet für Upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileSize</span><span class="o">:</span><span class="w"> </span><span class="kt">file.size</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileType</span><span class="o">:</span><span class="w"> </span><span class="kt">file.type</span><span class="p">,</span>
<span class="w">      </span><span class="nx">contentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">content.length</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// In dasselbe Verzeichnis wie die Originaldatei hochladen</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starte Upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Upload erfolgreich&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItem.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">savedItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">savedItemSize</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItem.metadata.size</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Aktualisierte Dateiliste holen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">updatedItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">refreshItems</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Dateiliste aktualisiert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">updatedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">updatedItems.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">newFileFound</span><span class="o">:</span><span class="w"> </span><span class="kt">updatedItems.some</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">savedItem</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItem</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedItems</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Speichert einen bereits transformierten Text direkt ohne erneute Transformation</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">saveTransformedText</span><span class="p">(</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">saveTransformationResult</span><span class="p">(</span>
<span class="w">      </span><span class="nx">text</span><span class="p">,</span>
<span class="w">      </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">,</span>
<span class="w">      </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">      </span><span class="nx">refreshItems</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Speichert das Transformationsergebnis als Datei</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">saveTransformationResult</span><span class="p">(</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Als Shadow-Twin oder als normale Datei mit angegebenem Namen speichern</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">text</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="p">,</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Einfach das Transformationsergebnis zurückgeben ohne Datei zu speichern</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Erstellt Markdown-Inhalt mit YAML-Frontmatter</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Wenn keine Metadaten vorhanden sind, gebe nur den Inhalt zurück</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">metadata</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">content</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Erstelle YAML-Frontmatter</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;---\n&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Sortiere die Metadaten für bessere Lesbarkeit</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sortedKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Gruppiere nach Kategorien</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoryOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;source_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transformation_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;audio_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;process&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;secretary_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cache_&#39;</span><span class="p">];</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">getCategoryIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">categoryOrder</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">categoryOrder</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">categoryOrder</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoryA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getCategoryIndex</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoryB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getCategoryIndex</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">categoryA</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">categoryB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">categoryA</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">categoryB</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">localeCompare</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Füge Metadaten zum Frontmatter hinzu</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">sortedKeys</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>

<span class="w">      </span><span class="c1">// Überspringe undefined-Werte</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Formatiere den Wert je nach Typ</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Escape Anführungszeichen in Strings</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">escapedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;\\&quot;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: &quot;</span><span class="si">${</span><span class="nx">escapedValue</span><span class="si">}</span><span class="sb">&quot;\n`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">\n`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Für komplexe Objekte verwende JSON (sollte nicht vorkommen)</span>
<span class="w">        </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span><span class="sb">\n`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;---\n\n&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Kombiniere Frontmatter mit Inhalt</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">content</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">promises</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Stats</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">pathLib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;mime-types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StorageItem</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">LibraryType</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AuthLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="c1">// Force dynamic rendering - verhindert Caching</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">dynamic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;force-dynamic&#39;</span><span class="p">;</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;nodejs&#39;</span><span class="p">;</span>

<span class="c1">// Debug-Zeitstempel für jeden Request</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">REQUEST_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`REQ_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mf">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mf">7</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="c1">// Minimal-Logging über ENV schaltbar</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">VERBOSE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DEBUG_FILESYSTEM</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">vLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">...args</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">[])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">VERBOSE</span><span class="p">)</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(...</span><span class="nx">args</span><span class="p">);</span><span class="w"> </span><span class="p">};</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">vWarn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">...args</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">[])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">VERBOSE</span><span class="p">)</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(...</span><span class="nx">args</span><span class="p">);</span><span class="w"> </span><span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Hilfsfunktion zum Abrufen der Benutzer-E-Mail-Adresse</span>
<span class="cm"> * Verwendet den Test-E-Mail-Parameter, falls vorhanden, sonst die authentifizierte E-Mail</span>
<span class="cm"> */</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getUserEmail</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">searchParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Cookie-Analyse entfernt - nicht mehr benötigt</span>

<span class="w">  </span><span class="c1">// Debug-Log entfernt - nicht mehr benötigt</span>

<span class="w">  </span><span class="c1">// reduced noisy console logs</span>

<span class="w">  </span><span class="c1">// Wenn ein Email-Parameter übergeben wurde, diesen verwenden (für Tests)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">emailParam</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">emailParam</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Versuche, authentifizierten Benutzer zu erhalten</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailAddresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[];</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">user</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">emailAddresses</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">emailAddresses</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">emailAddress</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">email</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;FileSystemAPI&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;User has no email addresses&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">hasUser</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">user</span><span class="p">,</span>
<span class="w">          </span><span class="nx">emailAddressesCount</span><span class="o">:</span><span class="w"> </span><span class="kt">emailAddresses.length</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;FileSystemAPI&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No userId returned from Clerk auth()&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;FileSystemAPI&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Clerk authentication failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API][getUserEmail] 💥 Fehler bei Clerk-Authentifizierung:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">error.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack?.split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Fallback: Versuche E-Mail aus Headers zu extrahieren</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Platzhalter für mögliche Fallbacks (bewusst ungenutzt, um Linter ruhig zu halten)</span>
<span class="w">    </span><span class="ow">void</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">fallbackError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;FileSystemAPI&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Header fallback failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">fallbackError</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API][getUserEmail] 💥 Fallback-Fehler:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">fallbackError</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;FileSystemAPI&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;All authentication methods failed - no email found&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getLibrary</span><span class="p">(</span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">LibraryType</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Bibliothek aus MongoDB abrufen</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>


<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">isEnabled</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">match</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// Konvertiert eine ID zurück in einen Pfad</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">LibraryType</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fileId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">decodedPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">fileId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Always treat decoded path as relative path and normalize it</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">decodedPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Check for path traversal attempts</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">normalizedPath</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Join with base path using pathLib.join to handle separators correctly</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">normalizedPath</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Double check the result is within the library path</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedLibPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Verbesserte Sicherheitsprüfung für Windows-Pfade</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">isWithinLibrary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Fall 1: Standard-Prüfung</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">normalizedResult</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">normalizedLibPath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">isWithinLibrary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Fall 2: Windows-Laufwerk-Prüfung (z.B. W: vs W:/)</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">normalizedLibPath</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">normalizedResult</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">normalizedLibPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">isWithinLibrary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Fall 3: Windows-Laufwerk mit Punkt (z.B. W:. vs W:/)</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">normalizedLibPath</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;:.&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">normalizedResult</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">normalizedLibPath</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">isWithinLibrary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isWithinLibrary</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[getPathFromId] 💥 Error decoding path:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">error.name</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryPath</span><span class="o">:</span><span class="w"> </span><span class="kt">library.path</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Konvertiert einen Pfad in eine ID</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">getIdFromPath</span><span class="p">(</span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">LibraryType</span><span class="p">,</span><span class="w"> </span><span class="nx">absolutePath</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">absolutePath</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Normalize both paths to use forward slashes</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedBasePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalizedPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Get relative path by removing base path</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">relativePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">normalizedBasePath</span><span class="p">,</span><span class="w"> </span><span class="nx">normalizedPath</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Normalize to forward slashes</span>
<span class="w">    </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\/+|\/+$/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Remove leading/trailing slashes</span>

<span class="w">  </span><span class="c1">// If path tries to go up, return root</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">relativePath</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>


<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">relativePath</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">relativePath</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Konvertiert Stats in ein StorageItem</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">statsToStorageItem</span><span class="p">(</span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">LibraryType</span><span class="p">,</span><span class="w"> </span><span class="nx">absolutePath</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="o">:</span><span class="w"> </span><span class="kt">Stats</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getIdFromPath</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">absolutePath</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentPath</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">getIdFromPath</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">parentPath</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">parentId</span><span class="p">,</span>
<span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">pathLib.basename</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">),</span>
<span class="w">      </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">stats.size</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">stats.isFile</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">mime</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/octet-stream&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">stats.mtime</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Listet Items in einem Verzeichnis</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">listItems</span><span class="p">(</span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">LibraryType</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">absolutePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Prüfe zuerst, ob das Verzeichnis existiert</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">stats</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[API] Pfad ist kein Verzeichnis: &quot;</span><span class="si">${</span><span class="nx">absolutePath</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Der angegebene Pfad ist kein Verzeichnis: </span><span class="si">${</span><span class="nx">absolutePath</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;NotDirectoryError&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">itemPromises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">item</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">itemPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">);</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">itemPath</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">statsToStorageItem</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">itemPath</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">itemPromises</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">validResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">item</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">StorageItem</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">validResults</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[API] Fehler beim Lesen des Verzeichnisses &quot;</span><span class="si">${</span><span class="nx">absolutePath</span><span class="si">}</span><span class="sb">&quot;:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Spezifische Fehlerbehandlung für verschiedene Fehlertypen</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// NodeJS SystemError hat eine code Eigenschaft</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nodeError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nodeError</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ENOENT&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Verzeichnis existiert nicht</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">specificError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Die Bibliothek &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">&quot; konnte nicht gefunden werden. Pfad: &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">specificError</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;LibraryPathNotFoundError&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">specificError</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nodeError</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;EACCES&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Keine Berechtigung</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">specificError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Keine Berechtigung für den Zugriff auf die Bibliothek &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">&quot;. Pfad: &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">specificError</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;LibraryAccessDeniedError&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">specificError</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;NotDirectoryError&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Bereits behandelt</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Für alle anderen Fehler</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Verarbeitet Anfragen, wenn eine Bibliothek nicht gefunden wurde</span>
<span class="cm"> */</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleLibraryNotFound</span><span class="p">(</span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">NextResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bibliothek mit ID: </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> nicht gefunden`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;LIBRARY_NOT_FOUND&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">libraryId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// TEST: Sofortige Response um zu sehen ob die Route überhaupt erreicht wird</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">testParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">testParam</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ping&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">(</span><span class="s1">&#39;PONG - Route is reachable!&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/plain&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;X-Test-Response&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;X-Timestamp&#39;</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>


<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">requestId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">REQUEST_ID</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Auch in die Response schreiben</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">debugHeaders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Headers</span><span class="p">();</span>
<span class="w">  </span><span class="nx">debugHeaders</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;X-Debug-Request-Id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">requestId</span><span class="p">);</span>
<span class="w">  </span><span class="nx">debugHeaders</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;X-Debug-Timestamp&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">());</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;fileId&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;libraryId&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API][filesystem] GET Request:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">requestId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">action</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Validiere erforderliche Parameter</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">vWarn</span><span class="p">(</span><span class="sb">`[API][filesystem] ❌ Fehlender libraryId Parameter`</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;libraryId is required&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MISSING_LIBRARY_ID&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">requestId</span><span class="w"> </span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">fileId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">vWarn</span><span class="p">(</span><span class="sb">`[API][filesystem] ❌ Fehlender fileId Parameter`</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;fileId is required&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MISSING_FILE_ID&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">requestId</span><span class="w"> </span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// E-Mail aus Authentifizierung oder Parameter ermitteln</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserEmail</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">vWarn</span><span class="p">(</span><span class="sb">`[API][filesystem] ❌ Keine E-Mail gefunden`</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;No user email found&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;NO_USER_EMAIL&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">requestId</span><span class="w"> </span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>


<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getLibrary</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">library</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`[API][filesystem] ❌ Bibliothek nicht gefunden`</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">handleLibraryNotFound</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API][filesystem] Bibliothek gefunden:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">library.id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryLabel</span><span class="o">:</span><span class="w"> </span><span class="kt">library.label</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryPath</span><span class="o">:</span><span class="w"> </span><span class="kt">library.path</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryType</span><span class="o">:</span><span class="w"> </span><span class="kt">library.type</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;list&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API][filesystem][list] Starte Verzeichnisauflistung:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">requestId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryPath</span><span class="o">:</span><span class="w"> </span><span class="kt">library.path</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">listItems</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>

<span class="w">        </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API][filesystem][list] Erfolgreich </span><span class="si">${</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> Items geladen:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">requestId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">itemCount</span><span class="o">:</span><span class="w"> </span><span class="kt">items.length</span><span class="p">,</span>
<span class="w">          </span><span class="nx">fileId</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">items</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">debugHeaders</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;get&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">absolutePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">statsToStorageItem</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">absolutePath</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">debugHeaders</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;binary&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API][filesystem][binary] 🖼️ Binary-Request gestartet:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">requestId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">          </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">fileId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API][filesystem] Ungültige Datei-ID für binary:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">userEmail</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">            </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid file ID&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;INVALID_FILE_ID&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">requestId</span><span class="w"> </span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">absolutePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">stats</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API][filesystem] Keine Datei:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="kt">absolutePath</span><span class="p">,</span>
<span class="w">            </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">userEmail</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">            </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Not a file&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;NOT_A_FILE&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">requestId</span><span class="w"> </span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">mimeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mime</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API][filesystem][binary] 🏷️ MIME-Type erkannt:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">mimeType</span><span class="p">,</span>
<span class="w">          </span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="kt">pathLib.basename</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">),</span>
<span class="w">          </span><span class="nx">extension</span><span class="o">:</span><span class="w"> </span><span class="kt">pathLib.extname</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">)</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Spezielle Headers für PDFs, damit sie im Browser angezeigt werden</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">HeadersInit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mimeType</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;Content-Length&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
<span class="w">          </span><span class="s1">&#39;Cache-Control&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;X-Debug-Request-Id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">requestId</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;X-Debug-File-Path&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">absolutePath</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;X-Debug-File-Size&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
<span class="w">          </span><span class="s1">&#39;X-Debug-Mime-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mimeType</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// Für PDFs Content-Disposition auf inline setzen</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mimeType</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`inline; filename=&quot;</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">))</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API][filesystem][binary] 🚀 Sende Response:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span>
<span class="w">          </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Object.fromEntries</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">headers</span><span class="p">).</span><span class="nx">filter</span><span class="p">(([</span><span class="nx">key</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">key</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;X-Debug-&#39;</span><span class="p">))),</span>
<span class="w">          </span><span class="nx">contentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">content.length</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">handleGetPath</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">default</span><span class="o">:</span>
<span class="w">        </span><span class="kt">console.error</span><span class="p">(</span><span class="s1">&#39;[API][filesystem] Ungültige Aktion:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">action</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">userEmail</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">          </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid action&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;INVALID_ACTION&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">requestId</span><span class="w"> </span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[API][filesystem] 💥 FEHLER:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack</span><span class="p">,</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">error.name</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">action</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">requestId</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Spezifische Fehlerbehandlung</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Unbekannter Server-Fehler&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">statusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;LibraryPathNotFoundError&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
<span class="w">        </span><span class="nx">statusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">404</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;LibraryAccessDeniedError&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
<span class="w">        </span><span class="nx">statusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">403</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;NotDirectoryError&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
<span class="w">        </span><span class="nx">statusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">400</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">errorMessage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;SERVER_ERROR&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">requestId</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">statusCode</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">searchParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;fileId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;libraryId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API] POST </span><span class="si">${</span><span class="nx">action</span><span class="si">}</span><span class="sb"> fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">, libraryId=</span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// E-Mail aus Authentifizierung oder Parameter ermitteln</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserEmail</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;No user email found&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getLibrary</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">library</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">handleLibraryNotFound</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;createFolder&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">newFolderPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">parentPath</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">newFolderPath</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">recursive</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">newFolderPath</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">statsToStorageItem</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">newFolderPath</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;upload&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">formData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">formData</span><span class="p">();</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">file</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">File</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API] Invalid file object received&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;No valid file provided&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">parentPath</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">arrayBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">();</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">arrayBuffer</span><span class="p">);</span>
<span class="w">          </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="p">);</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">statsToStorageItem</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API] Upload processing error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span><span class="w"> </span><span class="c1">// Re-throw to be caught by the outer try-catch</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">default</span><span class="o">:</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid action&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API] Error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="w"> </span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">DELETE</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">searchParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;fileId&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;libraryId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API] DELETE fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">, libraryId=</span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">fileId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid file ID&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// E-Mail aus Authentifizierung oder Parameter ermitteln</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserEmail</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;No user email found&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getLibrary</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">library</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">handleLibraryNotFound</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">absolutePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">rm</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">recursive</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">absolutePath</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API] Error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="w"> </span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">PATCH</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">searchParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;fileId&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">newParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;newParentId&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;libraryId&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="nx">vLog</span><span class="p">(</span><span class="sb">`[API] PATCH fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">, newParentId=</span><span class="si">${</span><span class="nx">newParentId</span><span class="si">}</span><span class="sb">, libraryId=</span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">fileId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">newParentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid file or parent ID&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// E-Mail aus Authentifizierung oder Parameter ermitteln</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserEmail</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;No user email found&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getLibrary</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">library</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">handleLibraryNotFound</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourcePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">newParentId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">sourcePath</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">targetParentPath</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="p">);</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">rename</span><span class="p">(</span><span class="nx">sourcePath</span><span class="p">,</span><span class="w"> </span><span class="nx">targetPath</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API] Error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="w"> </span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleGetPath</span><span class="p">(</span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">LibraryType</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">vLog</span><span class="p">(</span><span class="s1">&#39;[API] GET path fileId=&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">absolutePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPathFromId</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Konvertiere absoluten Pfad zu relativem Pfad</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">relativePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathLib</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">absolutePath</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Normalisiere zu Forward Slashes</span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\/+|\/+$/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Entferne führende/nachfolgende Slashes</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">displayPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">relativePath</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="nx">displayPath</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[API] Error getting path:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="s1">&#39;Failed to get path&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<p>Ich öffne die betroffenen Dateien parallel, um die verbleibenden ESLint-Errors gezielt zu beheben. Danach nehme ich minimal-invasive Edits vor.</p>
<p>Ich bereinige jetzt die restlichen Build-blockierenden Linterfehler: entferne ungenutzte Parameter/Variablen, ersetze any durch präzise Typen in <code>job-monitor-panel.tsx</code>, <code>storage-context.tsx</code>, <code>use-storage-provider.tsx</code>, <code>logger.ts</code>, <code>storage-factory.ts</code> und typisiere die akzeptierten PDF-Responses in <code>transform-service.ts</code>. Danach baue ich erneut.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">/children`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive children list fehlgeschlagen: </span><span class="si">${</span><span class="nx">list</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">folder?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="nx">.value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">it</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">folder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">existing.id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;@microsoft.graph.conflictBehavior&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rename&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Ordnererstellung fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">created</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveData</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceRelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">sourceId</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetRelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Pfade ermitteln (aktuell nur für Debugging/Logging nutzbar)</span>
<span class="w">        </span><span class="c1">// const sourceAbsPath = sourceRelPath &amp;&amp; sourceRelPath !== &#39;/&#39; ? path.join(lib.path, sourceRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>
<span class="w">        </span><span class="c1">// const targetAbsPath = targetRelPath &amp;&amp; targetRelPath !== &#39;/&#39; ? path.join(lib.path, targetRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath &amp;&amp; savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">            </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">              </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">              </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">          </span><span class="p">};</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">            </span><span class="nx">imagesArchiveData</span><span class="p">,</span>
<span class="w">            </span><span class="nx">imagesArchiveFilename</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;pdf_images.zip&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">            </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">            </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">            </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">            </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span>
<span class="w">          </span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="sb">`.</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">JSZip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;jszip&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">JSZip</span><span class="p">.</span><span class="k">default</span><span class="p">().</span><span class="nx">loadAsync</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">zip</span><span class="p">.</span><span class="nx">files</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">imagesSaved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">fileEntry</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">entries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">dir?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">}).</span><span class="nx">dir</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ext</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpeg&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">ext</span><span class="p">))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`image.</span><span class="si">${</span><span class="nx">ext</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^image_(\d+)/</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">_m</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`page_</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;png&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;image/png&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">async</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Buffer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}).</span><span class="k">async</span><span class="p">(</span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">imgItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="p">,</span><span class="w"> </span><span class="nx">bin</span><span class="p">);</span>
<span class="w">            </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">imgItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">            </span><span class="nx">imagesSaved</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">textContents</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/page_(\d+)/</span><span class="p">);</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mf">1</span><span class="p">]);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">page</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.(png|jpg|jpeg)$/i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span>
<span class="w">                    </span><span class="sb">`# </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n\n## Quelle\n**PDF-Datei:** </span><span class="si">${</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="sb">\n**Bild:** </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n**Sprache:** </span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">\n**Seite:** </span><span class="si">${</span><span class="nx">page</span><span class="si">}</span><span class="sb">\n\n## Extrahierter Text\n</span><span class="si">${</span><span class="nx">tc</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="sb">\n`</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;utf8&#39;</span>
<span class="w">                  </span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">mdName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mdItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imagesSaved</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_data</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveData</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_filename</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveFilename</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { Badge } from &quot;@/components/ui/badge&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const variant = status === &#39;completed&#39; ? &#39;default&#39;
    : status === &#39;running&#39; ? &#39;secondary&#39;
    : status === &#39;failed&#39; ? &#39;destructive&#39;
    : &#39;outline&#39;;
  return &lt;Badge variant={variant}&gt;{status}&lt;/Badge&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const isFetchingRef = useRef(false);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());

  // Initiale Seite laden
  useEffect(() =&gt; {
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const res = await fetch(`/api/external/jobs?page=${pageNum}&amp;limit=20`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    load(1, true);
    return () =&gt; { cancelled = true; };
  }, []);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const res = await fetch(`/api/external/jobs?page=1&amp;limit=20`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden (mit einfachem Reconnect und Initial-Refresh)
  useEffect(() =&gt; {
    let retryTimer: any = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      es.addEventListener(&#39;open&#39;, () =&gt; {
        void refreshNow();
      });

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job → vorne einfügen
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        retryTimer = setTimeout(connect, 3000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, []);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className=&quot;border rounded-md p-3&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-80 text-xs&quot;&gt;
                          &lt;JobLogs jobId={item.jobId} /&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import React, { createContext, useContext, useEffect, useState } from &#39;react&#39;;
import { useAtom } from &#39;jotai&#39;;
import { librariesAtom, activeLibraryIdAtom, libraryStatusAtom } from &#39;@/atoms/library-atom&#39;;
import { StorageFactory } from &#39;@/lib/storage/storage-factory&#39;;
import { ClientLibrary } from &quot;@/types/library&quot;;
import { useStorageProvider } from &quot;@/hooks/use-storage-provider&quot;;
import { useAuth, useUser } from &#39;@clerk/nextjs&#39;;
import { StorageProvider, StorageItem, StorageError } from &#39;@/lib/storage/types&#39;;
import { AuthLogger } from &#39;@/lib/debug/logger&#39;;
import { isSupportedLibraryType } from &#39;@/lib/storage/supported-types&#39;;

// Erweitere den StorageProvider um getAuthInfo
interface ExtendedStorageProvider extends StorageProvider {
  getAuthInfo?: () =&gt; string;
  disconnect?: () =&gt; Promise&lt;void&gt;;
}

// Typ für den Lade-/Statuszustand der Bibliothek
export type LibraryStatus =
  | &#39;initializing&#39;
  | &#39;providerLoading&#39;
  | &#39;waitingForAuth&#39;
  | &#39;ready&#39;;

// Context-Typen
interface StorageContextType {
  libraries: ClientLibrary[];
  currentLibrary: ClientLibrary | null;
  isLoading: boolean;
  error: string | null;
  provider: ExtendedStorageProvider | null;
  refreshCurrentLibrary: () =&gt; Promise&lt;void&gt;;
  refreshLibraries: () =&gt; Promise&lt;void&gt;;
  listItems: (folderId: string) =&gt; Promise&lt;StorageItem[]&gt;;
  refreshItems: (folderId: string) =&gt; Promise&lt;StorageItem[]&gt;;
  isAuthRequired: boolean;
  authProvider: string | null;
  libraryStatus: LibraryStatus;
  lastRequestedLibraryId: string | null;
  refreshAuthStatus: () =&gt; void;
}

// Erstelle den Context
const StorageContext = createContext&lt;StorageContextType | undefined&gt;(undefined);

// Hook für den Zugriff auf den Context
export const useStorage = () =&gt; {
  const context = useContext(StorageContext);
  if (!context) {
    throw new Error(&#39;useStorage muss innerhalb eines StorageContextProvider verwendet werden&#39;);
  }
  return context;
};

// Type Guard für StorageError
export function isStorageError(error: unknown): error is StorageError {
  return (
    typeof error === &#39;object&#39; &amp;&amp;
    error !== null &amp;&amp;
    &#39;code&#39; in error &amp;&amp;
    typeof (error as { code: unknown }).code === &#39;string&#39;
  );
}

/**
 * Provider-Komponente für den Storage-Context
 * Verwaltet den Zustand der Bibliotheken und des aktiven Providers
 */
export const StorageContextProvider = ({ children }: { children: React.ReactNode }) =&gt; {
  const { isLoaded: isAuthLoaded, isSignedIn } = useAuth();
  const { user, isLoaded: isUserLoaded } = useUser();

  // Auth-Debug-Logging
  React.useEffect(() =&gt; {
    AuthLogger.clientAuth(&#39;StorageContext&#39;, {
      isSignedIn,
      isLoaded: isAuthLoaded,
      userId: user?.id,
      email: user?.primaryEmailAddress?.emailAddress
    });
  }, [isAuthLoaded, isSignedIn, user?.id, user?.primaryEmailAddress?.emailAddress]);

  const [libraries, setLibraries] = useAtom(librariesAtom);
  const [currentLibrary, setCurrentLibrary] = useState&lt;ClientLibrary | null&gt;(null);
  const [provider, setProvider] = useState&lt;ExtendedStorageProvider | null&gt;(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState&lt;string | null&gt;(null);
  const [activeLibraryId, setActiveLibraryId] = useAtom(activeLibraryIdAtom);
  const [, setLibraryStatusAtom] = useAtom(libraryStatusAtom);
  const providerFromHook = useStorageProvider();
  const [isProviderLoading, setIsProviderLoading] = useState(false);
  const previousProviderRef = React.useRef&lt;ExtendedStorageProvider | null&gt;(null);
  const [isAuthRequired, setIsAuthRequired] = useState(false);
  const [authProvider, setAuthProvider] = useState&lt;string | null&gt;(null);
  const [libraryStatus, setLibraryStatus] = useState&lt;LibraryStatus&gt;(&#39;initializing&#39;);
  const [lastRequestedLibraryId, setLastRequestedLibraryId] = useState&lt;string | null&gt;(null);
  const [hasRedirectedToSettings, setHasRedirectedToSettings] = useState(false);

  // Provider-Wechsel-Logik
  useEffect(() =&gt; {
    setLibraryStatus(&#39;initializing&#39;);
    if (providerFromHook) {
      console.log(`[StorageContext] Provider-Wechsel: ${previousProviderRef.current?.name || &#39;Kein Provider&#39;} -&gt; ${providerFromHook.name}`);

      // Cleanup des alten Providers
      if (previousProviderRef.current) {
        try {
          previousProviderRef.current.disconnect?.();
          console.log(`[StorageContext] Alten Provider ${previousProviderRef.current.name} aufgeräumt`);
        } catch (error) {
          console.error(&#39;[StorageContext] Fehler beim Aufräumen des alten Providers:&#39;, error);
        }
      }

      // Validierung des neuen Providers
      try {
        validateProvider(providerFromHook);
        console.log(`[StorageContext] Provider ${providerFromHook.name} validiert`);
      } catch (error) {
        console.error(&#39;[StorageContext] Provider-Validierung fehlgeschlagen:&#39;, error);
        setError(error instanceof Error ? error.message : &#39;Provider-Validierung fehlgeschlagen&#39;);
        return;
      }

      // Provider aktualisieren
      setIsProviderLoading(true);
      setProvider(providerFromHook);
      previousProviderRef.current = providerFromHook;
      setIsProviderLoading(false);
      setLibraryStatus(&#39;ready&#39;);
      setLibraryStatusAtom(&#39;ready&#39;);
    }
  }, [providerFromHook]);

  // Zusätzlicher Effect: Provider-Cache leeren bei Library-Wechsel
  useEffect(() =&gt; {
    if (activeLibraryId &amp;&amp; previousProviderRef.current &amp;&amp; previousProviderRef.current.id !== activeLibraryId) {
      console.log(&#39;[StorageContext] Aktive Bibliothek geändert, lösche alten Provider aus Cache&#39;, {
        alteBibliothek: previousProviderRef.current.id,
        neueBibliothek: activeLibraryId
      });

      // Lösche den alten Provider aus dem Factory-Cache
      const factory = StorageFactory.getInstance();
      factory.clearProvider(previousProviderRef.current.id);
    }
  }, [activeLibraryId]);

  // Provider-Validierung
  const validateProvider = (provider: ExtendedStorageProvider) =&gt; {
    if (!provider.listItemsById) {
      throw new Error(&#39;Provider unterstützt keine Ordnerauflistung&#39;);
    }
    // Weitere Validierungen hier...
  };

  // Aktuelle Bibliothek aktualisieren, wenn sich die aktive Bibliothek oder die Bibliotheksliste ändert
  useEffect(() =&gt; {
    if (!activeLibraryId || libraries.length === 0) {
      setCurrentLibrary(null);
      setLibraryStatus(&#39;initializing&#39;);
      setLibraryStatusAtom(&#39;loading&#39;);
      return;
    }
    const found = libraries.find(lib =&gt; lib.id === activeLibraryId) || null;
    setCurrentLibrary(found);
    // Status wird in einem anderen useEffect basierend auf der Library gesetzt
  }, [activeLibraryId, libraries]);

  // Bibliotheken aus der API laden
  useEffect(() =&gt; {
    AuthLogger.debug(&#39;StorageContext&#39;, &#39;Library Loading Effect triggered&#39;, {
      isAuthLoaded,
      isUserLoaded,
      isSignedIn
    });

    if (!isAuthLoaded || !isUserLoaded) {
      AuthLogger.debug(&#39;StorageContext&#39;, &#39;Waiting for auth/user to load&#39;);
      return;
    }

    if (!isSignedIn) {
      AuthLogger.warn(&#39;StorageContext&#39;, &#39;User not signed in&#39;);
      setError(&quot;Sie müssen angemeldet sein, um auf die Bibliothek zugreifen zu können.&quot;);
      setIsLoading(false);
      return;
    }

    const userEmail = user?.primaryEmailAddress?.emailAddress;
    if (!userEmail) {
      AuthLogger.error(&#39;StorageContext&#39;, &#39;No user email available&#39;, { 
        hasUser: !!user,
        emailAddressesCount: user?.emailAddresses?.length || 0 
      });
      setError(&quot;Keine Benutzer-Email verfügbar&quot;);
      setIsLoading(false);
      return;
    }

    AuthLogger.info(&#39;StorageContext&#39;, &#39;Starting library load&#39;, { 
      userEmail: `${userEmail.split(&#39;@&#39;)[0]}@...` 
    });
    console.log(&#39;[StorageContext] Lade Bibliotheken...&#39;);
    setIsLoading(true);

    let retryCount = 0;
    const maxRetries = 3;
    const retryDelay = 1000; // 1 Sekunde
    let isCancelled = false; // Flag um doppelte Loads zu verhindern

    const fetchLibraries = async () =&gt; {
      if (isCancelled) return; // Abbrechen wenn bereits gecancelt

      try {
        const apiEndpoint = `/api/libraries?email=${encodeURIComponent(userEmail)}`;
        AuthLogger.apiCall(&#39;StorageContext&#39;, apiEndpoint, &#39;start&#39;, { attempt: retryCount + 1 });

        const res = await fetch(apiEndpoint);

        if (!res.ok) {
          AuthLogger.apiCall(&#39;StorageContext&#39;, apiEndpoint, &#39;error&#39;, { 
            status: res.status,
            statusText: res.statusText,
            attempt: retryCount + 1 
          });
          if (res.status === 404 &amp;&amp; retryCount &lt; maxRetries) {
            console.log(`[StorageContext] API nicht verfügbar, versuche erneut (${retryCount + 1}/${maxRetries})...`);
            retryCount++;
            setTimeout(fetchLibraries, retryDelay);
            return;
          }

          // Versuche die Fehlermeldung aus dem Response-Body zu lesen
          let errorMessage = `HTTP-Fehler: ${res.status}`;
          try {
            const errorData = await res.json();
            if (errorData.error) {
              errorMessage = errorData.error;
            }
          } catch (jsonError) {
            // Falls JSON-Parsing fehlschlägt, verwende die Standard-Nachricht
            console.warn(&#39;[StorageContext] Konnte Fehlermeldung nicht aus Response lesen:&#39;, jsonError);
          }

          throw new Error(res.status === 404 
            ? `API-Endpunkt nicht gefunden (404). Bitte prüfen, ob &#39;/api/libraries&#39; existiert.`
            : errorMessage);
        }

        const data = await res.json();
        if (isCancelled) return; // Nochmal prüfen nach async Operation

        AuthLogger.apiCall(&#39;StorageContext&#39;, apiEndpoint, &#39;success&#39;, { 
          librariesCount: Array.isArray(data) ? data.length : 0,
          attempt: retryCount + 1 
        });

        if (data &amp;&amp; Array.isArray(data)) {
          // Erst valide IDs sicherstellen, dann unterstützte Typen filtern
          const supportedLibraries = data
            .filter(lib =&gt; typeof lib?.id === &#39;string&#39; &amp;&amp; lib.id.trim() !== &#39;&#39;)
            .filter(lib =&gt; {
              const isSupported = isSupportedLibraryType(lib.type);
              if (!isSupported) {
                console.warn(`[StorageContext] Nicht unterstützter Bibliothekstyp &quot;${lib.type}&quot; für Bibliothek &quot;${lib.label}&quot; - wird ausgeblendet`);
                AuthLogger.warn(&#39;StorageContext&#39;, `Unsupported library type filtered out`, {
                  libraryType: lib.type,
                  libraryLabel: lib.label,
                  libraryId: lib.id
                });
              }
              return isSupported;
            });

          console.log(`[StorageContext] Bibliotheken geladen: ${data.length} total, ${supportedLibraries.length} unterstützt`);
          setLibraries(supportedLibraries);

          // Setze StorageFactory Libraries (nur unterstützte)
          const factory = StorageFactory.getInstance();
          factory.setLibraries(supportedLibraries);

          // Setze User-Email für API-Calls
          factory.setUserEmail(userEmail);
          AuthLogger.info(&#39;StorageContext&#39;, &#39;User email set in StorageFactory&#39;, {
            email: `${userEmail.split(&#39;@&#39;)[0]}@...`
          });

          // Prüfe, ob der Benutzer keine unterstützten Bibliotheken hat und noch nicht zur Settings-Seite weitergeleitet wurde
          if (supportedLibraries.length === 0 &amp;&amp; !hasRedirectedToSettings &amp;&amp; typeof window !== &#39;undefined&#39;) {
            const currentPath = window.location.pathname;
            // Nur weiterleiten, wenn wir nicht bereits auf der Settings-Seite sind
            if (!currentPath.startsWith(&#39;/settings&#39;)) {
              console.log(&#39;[StorageContext] Neuer Benutzer ohne Bibliotheken - leite zur Settings-Seite weiter&#39;);
              setHasRedirectedToSettings(true);

              // Sanfte Weiterleitung mit kurzer Verzögerung
              setTimeout(() =&gt; {
                window.location.href = &#39;/settings?newUser=true&#39;;
              }, 500);
              return;
            }
          }

          // Setze die erste unterstützte Bibliothek als aktiv, falls noch keine ausgewählt ist
          if (supportedLibraries.length &gt; 0) {
            const storedLibraryId = localStorage.getItem(&#39;activeLibraryId&#39;);
            console.log(&#39;[StorageContext] Gespeicherte activeLibraryId aus localStorage:&#39;, storedLibraryId);

            // Zusätzliche Validierung: Prüfe, ob die ID ein gültiges UUID-Format hat
            const isValidUUID = storedLibraryId &amp;&amp; 
              storedLibraryId.length &gt; 10 &amp;&amp; 
              isNaN(Number(storedLibraryId));

            // Prüfen, ob die gespeicherte ID in den unterstützten Bibliotheken existiert und gültig ist
            const validStoredId = isValidUUID &amp;&amp; supportedLibraries.some(lib =&gt; lib.id === storedLibraryId);

            if (validStoredId) {
              console.log(`[StorageContext] Gespeicherte Bibliothek wird verwendet: ${storedLibraryId}`);
              setActiveLibraryId(storedLibraryId);
            } else {
              if (storedLibraryId &amp;&amp; !isValidUUID) {
                console.warn(`[StorageContext] Ungültige Library-ID im localStorage gefunden: &quot;${storedLibraryId}&quot; - wird bereinigt`);
                localStorage.removeItem(&#39;activeLibraryId&#39;);
              }

              const firstLibId = supportedLibraries[0].id;
              console.log(`[StorageContext] Setze erste unterstützte Bibliothek als aktiv: ${firstLibId}`);
              setActiveLibraryId(firstLibId);
              localStorage.setItem(&#39;activeLibraryId&#39;, firstLibId);
            }
          } else {
            console.warn(&#39;[StorageContext] Keine unterstützten Bibliotheken verfügbar&#39;);
            AuthLogger.warn(&#39;StorageContext&#39;, &#39;No supported libraries available&#39;, {
              totalLibraries: data.length,
              supportedLibraries: supportedLibraries.length
            });
            setActiveLibraryId(&quot;&quot;);
            localStorage.removeItem(&#39;activeLibraryId&#39;);
            setLibraries([]);
          }
        } else {
          console.error(&#39;[StorageContext] Ungültiges Format der Bibliotheksdaten:&#39;, data);
          setError(&#39;Fehler beim Laden der Bibliotheken: Ungültiges Format&#39;);
          setLibraries([]);
        }
      } catch (err) {
        if (isCancelled) return; // Ignoriere Fehler wenn gecancelt

        AuthLogger.error(&#39;StorageContext&#39;, &#39;Library fetch failed&#39;, err);
        console.error(&#39;[StorageContext] Fehler beim Laden der Bibliotheken:&#39;, err);

        if (retryCount &lt; maxRetries) {
          AuthLogger.warn(&#39;StorageContext&#39;, `Retrying library fetch (${retryCount + 1}/${maxRetries})`);
          console.log(`[StorageContext] Fehler, versuche erneut (${retryCount + 1}/${maxRetries})...`);
          retryCount++;
          setTimeout(fetchLibraries, retryDelay);
          return;
        }
        // Die Fehlermeldung ist jetzt bereits benutzerfreundlich vom Backend
        const errorMessage = err instanceof Error ? err.message : &#39;Unbekannter Fehler&#39;;
        AuthLogger.error(&#39;StorageContext&#39;, &#39;Final library fetch failure after retries&#39;, { errorMessage });
        setError(errorMessage);
      } finally {
        if (retryCount &gt;= maxRetries || !isCancelled) {
          setIsLoading(false);
        }
      }
    };

    fetchLibraries();

    // Cleanup function
    return () =&gt; {
      isCancelled = true;
    };
  }, [isAuthLoaded, isUserLoaded, isSignedIn, user, setLibraries, setActiveLibraryId, hasRedirectedToSettings]);

  // Aktuelle Bibliothek aktualisieren
  const refreshCurrentLibrary = async () =&gt; {
    if (!currentLibrary || !provider) return;

    try {
      // Aktualisiere die Bibliothek durch Neuladen der Bibliotheken
      await refreshLibraries();
    } catch (error) {
      console.error(&#39;[StorageContext] Fehler beim Aktualisieren der Bibliothek:&#39;, error);
    }
  };

  // Alle Bibliotheken aktualisieren
  const refreshLibraries = async () =&gt; {
    if (!user?.primaryEmailAddress?.emailAddress) return;

    try {
      const res = await fetch(`/api/libraries?email=${encodeURIComponent(user.primaryEmailAddress.emailAddress)}`);
      if (!res.ok) {
        // Versuche die Fehlermeldung aus dem Response-Body zu lesen
        let errorMessage = `HTTP-Fehler: ${res.status}`;
        try {
          const errorData = await res.json();
          if (errorData.error) {
            errorMessage = errorData.error;
          }
        } catch {
          // Falls JSON-Parsing fehlschlägt, verwende die Standard-Nachricht
        }
        throw new Error(errorMessage);
      }

      const data = await res.json();
      if (data &amp;&amp; Array.isArray(data)) {
        const filtered = data
          .filter((lib: { id?: unknown }) =&gt; typeof lib?.id === &#39;string&#39; &amp;&amp; String(lib.id).trim() !== &#39;&#39;)
          .filter((lib: { type?: unknown }) =&gt; isSupportedLibraryType(String(lib.type)));
        setLibraries(filtered);
      }
    } catch (error) {
      console.error(&#39;[StorageContext] Fehler beim Aktualisieren der Bibliotheken:&#39;, error);
    }
  };

  // Implementiere listItems und refreshItems
  const listItems = async (folderId: string): Promise&lt;StorageItem[]&gt; =&gt; {
    // Überprüfe, ob der Provider zur aktuellen Bibliothek passt
    if (!provider || !currentLibrary) {
      console.error(&#39;[StorageContext] Kein Provider oder keine aktuelle Bibliothek verfügbar für listItems&#39;);
      throw new Error(&#39;Keine aktive Bibliothek verfügbar. Bitte wählen Sie eine Bibliothek aus.&#39;);
    }

    // Wichtig: Stelle sicher, dass der Provider zur aktuellen Bibliothek gehört
    if (provider.id !== currentLibrary.id) {
      console.warn(&#39;[StorageContext][listItems] Provider-ID stimmt nicht mit aktueller Bibliothek überein!&#39;, {
        providerId: provider.id,
        currentLibraryId: currentLibrary.id,
        activeLibraryId
      });

      // Versuche den korrekten Provider zu laden
      try {
        const factory = StorageFactory.getInstance();
        const correctProvider = await factory.getProvider(currentLibrary.id);
        console.log(&#39;[StorageContext][listItems] Korrekter Provider geladen:&#39;, correctProvider.name);

        // Verwende den korrekten Provider für diesen Aufruf
        return await correctProvider.listItemsById(folderId);
      } catch (error) {
        console.error(&#39;[StorageContext][listItems] Fehler beim Laden des korrekten Providers:&#39;, error);
        throw error;
      }
    }

    // Logging: Library-IDs vergleichen
    setLastRequestedLibraryId(currentLibrary?.id || null);
    console.log(&#39;[StorageContext][listItems] Aufruf:&#39;, {
      requestedLibraryId: currentLibrary?.id,
      activeLibraryId,
      currentLibrary,
      providerId: provider.id,
      providerName: provider.name
    });

    // Prüfe zuerst, ob der Provider authentifiziert ist
    if (&#39;isAuthenticated&#39; in provider &amp;&amp; typeof provider.isAuthenticated === &#39;function&#39; &amp;&amp; !provider.isAuthenticated()) {
      console.log(&#39;[StorageContext][listItems] Provider ist nicht authentifiziert, überspringe Aufruf&#39;);
      setIsAuthRequired(true);
      setAuthProvider(provider.name);
      setLibraryStatus(&#39;waitingForAuth&#39;);
      // Werfe einen AUTH_REQUIRED Fehler, aber logge ihn nicht
      throw new StorageError(
        &quot;Nicht authentifiziert. Bitte authentifizieren Sie sich bei &quot; + provider.name + &quot;.&quot;,
        &quot;AUTH_REQUIRED&quot;,
        provider.id
      );
    }

    try {
      const items = await provider.listItemsById(folderId);
      console.log(`[StorageContext][listItems] Erfolgreich ${items.length} Items geladen`);
      return items;
    } catch (error) {
      if (isStorageError(error) &amp;&amp; error.code === &#39;AUTH_REQUIRED&#39;) {
        setIsAuthRequired(true);
        setAuthProvider(provider.name);
        setLibraryStatus(&#39;waitingForAuth&#39;);
        // Kein Logging für AUTH_REQUIRED
      } else {
        setIsAuthRequired(false);
        setAuthProvider(null);
        setLibraryStatus(&#39;ready&#39;);

        // Verbesserte Fehlerbehandlung
        let errorMessage = &#39;Unbekannter Fehler beim Laden der Dateien&#39;;

        if (error instanceof Error) {
          errorMessage = error.message;

          // Spezifische Fehlermeldungen für häufige Probleme
          if (error.message.includes(&#39;Bibliothek nicht gefunden&#39;)) {
            errorMessage = &#39;Die ausgewählte Bibliothek wurde nicht gefunden. Bitte überprüfen Sie die Bibliothekskonfiguration.&#39;;
          } else if (error.message.includes(&#39;Server-Fehler&#39;)) {
            errorMessage = &#39;Server-Fehler beim Laden der Bibliothek. Bitte überprüfen Sie, ob der Bibliothekspfad existiert und zugänglich ist.&#39;;
          } else if (error.message.includes(&#39;Keine Berechtigung&#39;)) {
            errorMessage = &#39;Keine Berechtigung für den Zugriff auf die Bibliothek. Bitte überprüfen Sie die Dateiberechtigungen.&#39;;
          } else if (error.message.includes(&#39;ENOENT&#39;)) {
            errorMessage = &#39;Der Bibliothekspfad existiert nicht. Bitte überprüfen Sie die Bibliothekskonfiguration.&#39;;
          }
        }

        console.error(&#39;[StorageContext] Fehler beim Auflisten der Items:&#39;, {
          error: error instanceof Error ? {
            message: error.message,
            name: error.name,
            stack: error.stack?.split(&#39;\n&#39;).slice(0, 3)
          } : error,
          libraryId: currentLibrary.id,
          libraryPath: currentLibrary.path,
          providerName: provider.name
        });

        // Erstelle einen benutzerfreundlichen Fehler
        const userFriendlyError = new Error(errorMessage);
        userFriendlyError.name = &#39;StorageError&#39;;
        throw userFriendlyError;
      }
      throw error;
    }
  };

  const refreshItems = async (folderId: string): Promise&lt;StorageItem[]&gt; =&gt; {
    // Überprüfe, ob der Provider zur aktuellen Bibliothek passt
    if (!provider || !currentLibrary) {
      console.error(&#39;[StorageContext] Kein Provider oder keine aktuelle Bibliothek verfügbar für refreshItems&#39;);
      return [];
    }

    // Wichtig: Stelle sicher, dass der Provider zur aktuellen Bibliothek gehört
    if (provider.id !== currentLibrary.id) {
      console.warn(&#39;[StorageContext][refreshItems] Provider-ID stimmt nicht mit aktueller Bibliothek überein!&#39;, {
        providerId: provider.id,
        currentLibraryId: currentLibrary.id,
        activeLibraryId
      });

      // Versuche den korrekten Provider zu laden
      try {
        const factory = StorageFactory.getInstance();
        const correctProvider = await factory.getProvider(currentLibrary.id);
        console.log(&#39;[StorageContext][refreshItems] Korrekter Provider geladen:&#39;, correctProvider.name);

        // Verwende den korrekten Provider für diesen Aufruf
        return await correctProvider.listItemsById(folderId);
      } catch (error) {
        console.error(&#39;[StorageContext][refreshItems] Fehler beim Laden des korrekten Providers:&#39;, error);
        throw error;
      }
    }

    setLastRequestedLibraryId(currentLibrary?.id || null);
    console.log(&#39;[StorageContext][refreshItems] Aufruf:&#39;, {
      requestedLibraryId: currentLibrary?.id,
      activeLibraryId,
      currentLibrary,
      providerId: provider.id,
      providerName: provider.name
    });

    // Prüfe zuerst, ob der Provider authentifiziert ist
    if (&#39;isAuthenticated&#39; in provider &amp;&amp; typeof provider.isAuthenticated === &#39;function&#39; &amp;&amp; !provider.isAuthenticated()) {
      console.log(&#39;[StorageContext][refreshItems] Provider ist nicht authentifiziert, überspringe Aufruf&#39;);
      setIsAuthRequired(true);
      setAuthProvider(provider.name);
      setLibraryStatus(&#39;waitingForAuth&#39;);
      // Werfe einen AUTH_REQUIRED Fehler, aber logge ihn nicht
      throw new StorageError(
        &quot;Nicht authentifiziert. Bitte authentifizieren Sie sich bei &quot; + provider.name + &quot;.&quot;,
        &quot;AUTH_REQUIRED&quot;,
        provider.id
      );
    }

    try {
      return await provider.listItemsById(folderId);
    } catch (error) {
      if (isStorageError(error) &amp;&amp; error.code === &#39;AUTH_REQUIRED&#39;) {
        setIsAuthRequired(true);
        setAuthProvider(provider.name);
      } else {
        setIsAuthRequired(false);
        setAuthProvider(null);
        console.error(&#39;[StorageContext] Fehler beim Aktualisieren der Items:&#39;, error);
      }
      throw error;
    }
  };

  // Neue Methode zum manuellen Aktualisieren des Auth-Status
  const refreshAuthStatus = React.useCallback(async () =&gt; {
    if (!currentLibrary) return;

    console.log(&#39;[StorageContext] Aktualisiere Authentifizierungsstatus manuell&#39;);

    try {
      // Versuche den Provider zu laden oder zu erstellen
      const factory = StorageFactory.getInstance();
      const provider = await factory.getProvider(currentLibrary.id);

      // Prüfe den Authentifizierungsstatus direkt beim Provider
      const isAuth = provider.isAuthenticated();

      console.log(&#39;[StorageContext] Provider Authentifizierungsstatus:&#39;, {
        libraryId: currentLibrary.id,
        providerName: provider.name,
        isAuthenticated: isAuth
      });

      if (isAuth) {
        setLibraryStatus(&#39;ready&#39;);
        setLibraryStatusAtom(&#39;ready&#39;);
        setIsAuthRequired(false);
        setAuthProvider(null);
        console.log(&#39;[StorageContext] Provider ist authentifiziert - Status auf &quot;ready&quot; gesetzt&#39;);
      } else {
        setLibraryStatus(&#39;waitingForAuth&#39;);
        setLibraryStatusAtom(&#39;waitingForAuth&#39;);
        setIsAuthRequired(true);
        setAuthProvider(currentLibrary.type);
        console.log(&#39;[StorageContext] Provider ist NICHT authentifiziert - Status auf &quot;waitingForAuth&quot; gesetzt&#39;);
      }
    } catch (error) {
      console.error(&#39;[StorageContext] Fehler beim Prüfen des Authentifizierungsstatus:&#39;, error);
      // Bei Fehler annehmen, dass Authentifizierung erforderlich ist
      setLibraryStatus(&#39;waitingForAuth&#39;);
      setLibraryStatusAtom(&#39;waitingForAuth&#39;);
      setIsAuthRequired(true);
      setAuthProvider(currentLibrary.type);
    }
  }, [currentLibrary]);

  // Context-Wert
  const value = {
    libraries,
    currentLibrary,
    isLoading: isLoading || isProviderLoading,
    error,
    provider,
    refreshCurrentLibrary,
    refreshLibraries,
    listItems,
    refreshItems,
    isAuthRequired,
    authProvider,
    libraryStatus,
    lastRequestedLibraryId,
    refreshAuthStatus
  };

  React.useEffect(() =&gt; {
    // TEMP: Logging für Bibliotheks-Reload nach Redirect
    // eslint-disable-next-line no-console
    console.log(&#39;[StorageContext] useEffect: currentLibrary&#39;, currentLibrary);
    if (currentLibrary) {
      // TEMP: Logging für Token in Konfiguration
      // eslint-disable-next-line no-console
      console.log(&#39;[StorageContext] Bibliothek geladen. Token vorhanden:&#39;, !!currentLibrary.config?.accessToken, &#39;Config:&#39;, currentLibrary.config);
      // TEMP: Logging für Provider-Status
      if (provider) {
        // eslint-disable-next-line no-console
        console.log(&#39;[StorageContext] Provider geladen:&#39;, provider.name, &#39;AuthInfo:&#39;, provider.getAuthInfo?.());
      }

      // Status-Logik: Nur OAuth-basierte Provider benötigen Authentifizierung
      // Lokale Dateisystem-Bibliotheken sind immer &quot;ready&quot;
      if (currentLibrary.type === &#39;local&#39;) {
        setLibraryStatus(&#39;ready&#39;);
        setLibraryStatusAtom(&#39;ready&#39;);
        // eslint-disable-next-line no-console
        console.log(&#39;[StorageContext] Lokale Bibliothek - Status auf &quot;ready&quot; gesetzt.&#39;);
      } else if (currentLibrary.type === &#39;onedrive&#39; || currentLibrary.type === &#39;gdrive&#39;) {
        // OAuth-basierte Provider: Token-Status aus localStorage prüfen
        let hasToken = false;

        if (typeof window !== &#39;undefined&#39;) {
          try {
            const localStorageKey = `onedrive_tokens_${currentLibrary.id}`;
            const tokensJson = localStorage.getItem(localStorageKey);
            hasToken = !!tokensJson;
          } catch (error) {
            console.error(&#39;[StorageContext] Fehler beim Prüfen der Tokens im localStorage:&#39;, error);
          }
        }

        if (hasToken) {
          setLibraryStatus(&#39;ready&#39;);
          setLibraryStatusAtom(&#39;ready&#39;);
          // eslint-disable-next-line no-console
          console.log(&#39;[StorageContext] OAuth-Provider: Status auf &quot;ready&quot; gesetzt, Token im localStorage gefunden.&#39;);
        } else {
          setLibraryStatus(&#39;waitingForAuth&#39;);
          setLibraryStatusAtom(&#39;waitingForAuth&#39;);
          // eslint-disable-next-line no-console
          console.log(&#39;[StorageContext] OAuth-Provider: Status auf &quot;waitingForAuth&quot; gesetzt, kein Token im localStorage.&#39;);
        }
      } else {
        // Unbekannter Provider-Typ - sicherheitshalber auf ready setzen
        setLibraryStatus(&#39;ready&#39;);
        setLibraryStatusAtom(&#39;ready&#39;);
        // eslint-disable-next-line no-console
        console.log(&#39;[StorageContext] Unbekannter Provider-Typ, Status auf &quot;ready&quot; gesetzt.&#39;);
      }
    }
  }, [currentLibrary, provider]);

  // TEMP: Logging für API-Calls
  React.useEffect(() =&gt; {
    // eslint-disable-next-line no-console
    console.log(&#39;[StorageContext] API-Call ausgelöst. Aktueller Status:&#39;, libraryStatus);
  }, [libraryStatus]);

  useEffect(() =&gt; {
    // Logging der Library-IDs im StorageContext
    // eslint-disable-next-line no-console
    console.log(&#39;[StorageContextProvider] Render:&#39;, {
      activeLibraryId,
      currentLibraryId: currentLibrary?.id,
      providerId: provider?.id
    });
  }, [activeLibraryId, currentLibrary, provider]);

  return (
    &lt;StorageContext.Provider value={value}&gt;
      {children}
    &lt;/StorageContext.Provider&gt;
  );
}; 
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;

import { useEffect, useState } from &quot;react&quot;
import { useAtomValue } from &quot;jotai&quot;
import { activeLibraryIdAtom, librariesAtom } from &quot;@/atoms/library-atom&quot;
import { StorageProvider } from &quot;@/lib/storage/types&quot;
import { StorageFactory } from &quot;@/lib/storage/storage-factory&quot;
import { SUPPORTED_LIBRARY_TYPES } from &quot;@/lib/storage/supported-types&quot;

export function useStorageProvider() {
  const activeLibraryId = useAtomValue(activeLibraryIdAtom)
  const libraries = useAtomValue(librariesAtom)
  const [provider, setProvider] = useState&lt;StorageProvider | null&gt;(null)

  useEffect(() =&gt; {
    // Logging der aktiven Library und Provider-Initialisierung
    // eslint-disable-next-line no-console
    console.log(&#39;[useStorageProvider] useEffect:&#39;, {
      activeLibraryId,
      libraries: libraries.map(lib =&gt; ({ id: lib.id, label: lib.label })),
    });

    if (!activeLibraryId) {
      console.log(&#39;[useStorageProvider] Keine aktive Bibliothek, setze Provider auf null&#39;)
      setProvider(null)
      return
    }

    if (libraries.length === 0) {
      console.log(&#39;[useStorageProvider] Bibliotheksliste ist leer, warte auf Bibliotheken&#39;)
      setProvider(null)
      return
    }

    const libraryExists = libraries.some(lib =&gt; lib.id === activeLibraryId)
    if (!libraryExists) {
      console.warn(`[useStorageProvider] Bibliothek mit ID ${activeLibraryId} existiert nicht in der Liste der verfügbaren Bibliotheken`)
      setProvider(null)
      return
    }

    console.log(`[useStorageProvider] Initialisiere Provider für Bibliothek: ${activeLibraryId}`)
    const factory = StorageFactory.getInstance()

    factory.getProvider(activeLibraryId)
      .then(provider =&gt; {
        console.log(`[useStorageProvider] Provider erfolgreich initialisiert: ${provider.name} (ID: ${provider.id})`)
        setProvider(provider)
      })
      .catch(error =&gt; {
        // Graceful handling für nicht unterstützte Bibliothekstypen
        if (error.name === &#39;UnsupportedLibraryTypeError&#39;) {
          const currentLibrary = libraries.find(lib =&gt; lib.id === activeLibraryId)
          console.warn(`[useStorageProvider] Nicht unterstützter Bibliothekstyp &quot;${error.libraryType}&quot; für Bibliothek &quot;${currentLibrary?.label}&quot; - Bibliothek wird übersprungen`, {
            libraryId: activeLibraryId,
            libraryType: error.libraryType,
            libraryLabel: currentLibrary?.label
          })

          // Versuche eine andere Bibliothek zu finden
          const supportedLibrary = libraries.find(lib =&gt; 
            lib.id !== activeLibraryId &amp;&amp; 
            SUPPORTED_LIBRARY_TYPES.includes(lib.type as unknown as (typeof SUPPORTED_LIBRARY_TYPES)[number])
          )

          if (supportedLibrary) {
            console.log(`[useStorageProvider] Wechsle zu unterstützter Bibliothek: ${supportedLibrary.label}`)
            // TODO: activeLibraryId auf supportedLibrary.id setzen
            // Für jetzt setzen wir Provider auf null
          }

          setProvider(null)
        } else {
          console.error(`[useStorageProvider] Fehler beim Laden des Storage Providers für ${activeLibraryId}:`, error)
          setProvider(null)
        }
      })
  }, [activeLibraryId, libraries])

  return provider
} 
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LogEntry</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/atoms/debug-atom&#39;</span><span class="p">;</span>

<span class="kr">type</span><span class="w"> </span><span class="nx">LogLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;debug&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">;</span>
<span class="kr">type</span><span class="w"> </span><span class="nx">LogArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;nav&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;state&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;ui&#39;</span><span class="p">;</span>

<span class="c1">// Event-System für Logs</span>
<span class="kr">type</span><span class="w"> </span><span class="nx">LogCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">entry</span><span class="o">:</span><span class="w"> </span><span class="kt">Omit</span><span class="o">&lt;</span><span class="nx">LogEntry</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">logCallbacks</span><span class="o">:</span><span class="w"> </span><span class="kt">Set</span><span class="o">&lt;</span><span class="nx">LogCallback</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">();</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">subscribeToLogs</span><span class="p">(</span><span class="nx">callback</span><span class="o">:</span><span class="w"> </span><span class="kt">LogCallback</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">logCallbacks</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">logCallbacks</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">BaseLogger</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">sequences</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="nx">LogArea</span><span class="p">,</span><span class="w"> </span><span class="kt">number</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">nav</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">ui</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">formatMessage</span><span class="p">(</span>
<span class="w">    </span><span class="nx">area</span><span class="o">:</span><span class="w"> </span><span class="kt">LogArea</span><span class="p">,</span>
<span class="w">    </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">LogLevel</span><span class="p">,</span>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">Omit</span><span class="o">&lt;</span><span class="nx">LogEntry</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">sequences</span><span class="p">[</span><span class="nx">area</span><span class="p">];</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="p">,</span>
<span class="w">      </span><span class="nx">area</span><span class="p">,</span>
<span class="w">      </span><span class="nx">sequence</span><span class="p">,</span>
<span class="w">      </span><span class="nx">component</span><span class="p">,</span>
<span class="w">      </span><span class="nx">level</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="p">,</span>
<span class="w">      </span><span class="nx">details</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">logToConsole</span><span class="p">(</span><span class="nx">entry</span><span class="o">:</span><span class="w"> </span><span class="kt">Omit</span><span class="o">&lt;</span><span class="nx">LogEntry</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;development&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">icon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">level</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;🔴&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>
<span class="w">                  </span><span class="nx">entry</span><span class="p">.</span><span class="nx">level</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;⚠️&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>
<span class="w">                  </span><span class="nx">entry</span><span class="p">.</span><span class="nx">level</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;ℹ️&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;🔍&#39;</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Formatiere den Zeitstempel für die Konsolenausgabe</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">timeOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">];</span>

<span class="w">      </span><span class="nx">console</span><span class="p">[</span><span class="nx">entry</span><span class="p">.</span><span class="nx">level</span><span class="p">](</span>
<span class="w">        </span><span class="sb">`[</span><span class="si">${</span><span class="nx">timeOnly</span><span class="si">}</span><span class="sb">][</span><span class="si">${</span><span class="nx">entry</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">entry</span><span class="p">.</span><span class="nx">sequence</span><span class="si">}</span><span class="sb">][</span><span class="si">${</span><span class="nx">entry</span><span class="p">.</span><span class="nx">component</span><span class="si">}</span><span class="sb">][</span><span class="si">${</span><span class="nx">entry</span><span class="p">.</span><span class="nx">level</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">icon</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">entry</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">entry</span><span class="p">.</span><span class="nx">details</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">protected</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">createLog</span><span class="p">(</span>
<span class="w">    </span><span class="nx">area</span><span class="o">:</span><span class="w"> </span><span class="kt">LogArea</span><span class="p">,</span>
<span class="w">    </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">LogLevel</span><span class="p">,</span>
<span class="w">    </span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">Omit</span><span class="o">&lt;</span><span class="nx">LogEntry</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">formatMessage</span><span class="p">(</span><span class="nx">area</span><span class="p">,</span><span class="w"> </span><span class="nx">level</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">logToConsole</span><span class="p">(</span><span class="nx">entry</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Verzögere die Callback-Ausführung, um React-Rendering-Konflikte zu vermeiden</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">logCallbacks</span><span class="p">.</span><span class="nx">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Verwende setTimeout mit 0ms Verzögerung, um die Ausführung nach dem aktuellen Render-Zyklus zu verschieben</span>
<span class="w">      </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">logCallbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">callback</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">callback</span><span class="p">(</span><span class="nx">entry</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Fehler in Logger-Callback:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">entry</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">resetSequences</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sequences</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">sequences</span><span class="p">[</span><span class="nx">key</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">LogArea</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">NavigationLogger</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">BaseLogger</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">debug</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;nav&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">info</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;nav&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">warn</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;nav&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">error</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;nav&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span><span class="w"> </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">StateLogger</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">BaseLogger</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">debug</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">info</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">warn</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">error</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span><span class="w"> </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">BaseLogger</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">debug</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">info</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">warn</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">error</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span><span class="w"> </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">UILogger</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">BaseLogger</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">debug</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;ui&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">info</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;ui&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">warn</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;ui&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">error</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;ui&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span><span class="w"> </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * AuthLogger - Spezieller Logger für Authentifizierungs-Events</span>
<span class="cm"> * Verwendet &#39;state&#39; area da Auth ein State-bezogenes Thema ist</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">AuthLogger</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">BaseLogger</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">debug</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="sb">`🔐 AUTH: </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">info</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="sb">`🔐 AUTH: </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">warn</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;warn&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="sb">`🔐 AUTH: </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">error</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">createLog</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="sb">`🔐 AUTH: </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack</span><span class="p">,</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">error.name</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Spezielle Methoden für verschiedene Auth-Events</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">clientAuth</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">isSignedIn?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">isLoaded?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="nx">userId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">email?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Client-Side Auth State&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">isSignedIn</span><span class="o">:</span><span class="w"> </span><span class="kt">result.isSignedIn</span><span class="p">,</span>
<span class="w">      </span><span class="nx">isLoaded</span><span class="o">:</span><span class="w"> </span><span class="kt">result.isLoaded</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasUserId</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">result</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasEmail</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">result</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">result.userId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">userId</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="si">}</span><span class="sb">...`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">result.email</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="si">}</span><span class="sb">@...`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">serverAuth</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="nx">user</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">emailAddresses?</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Server-Side Auth State&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasUserId</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">result</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasUser</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">result</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasError</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">result.userId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">userId</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="si">}</span><span class="sb">...`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nx">emailCount</span><span class="o">:</span><span class="w"> </span><span class="kt">result.user?.emailAddresses?.length</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">result.error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">result.error.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">result.error</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">apiCall</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">endpoint</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;start&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">icon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;start&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;🚀&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;✅&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;❌&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">icon</span><span class="si">}</span><span class="sb"> API Call </span><span class="si">${</span><span class="nx">endpoint</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">cookieAnalysis</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">cookies</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">clerkCookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">cookies</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(([</span><span class="nx">key</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">key</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;clerk&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">key</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">acc</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span><span class="p">)</span><span class="si">}</span><span class="sb">...`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">acc</span><span class="p">;</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="o">&gt;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Clerk Cookies Analysis&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">totalCookies</span><span class="o">:</span><span class="w"> </span><span class="kt">Object.keys</span><span class="p">(</span><span class="nx">cookies</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">clerkCookiesCount</span><span class="o">:</span><span class="w"> </span><span class="kt">Object.keys</span><span class="p">(</span><span class="nx">clerkCookies</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">clerkCookies</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StorageProvider</span><span class="p">,</span><span class="w"> </span><span class="nx">StorageItem</span><span class="p">,</span><span class="w"> </span><span class="nx">StorageValidationResult</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ClientLibrary</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OneDriveProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./onedrive-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">SUPPORTED_LIBRARY_TYPES</span><span class="p">,</span><span class="w"> </span><span class="nx">isSupportedLibraryType</span><span class="p">,</span><span class="w"> </span><span class="nx">getSupportedLibraryTypesString</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./supported-types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AuthLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">LibraryPathProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">_libraryPath?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">LocalStorageProvider</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">StorageProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">ClientLibrary</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">baseUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">ClientLibrary</span><span class="p">,</span><span class="w"> </span><span class="nx">baseUrl?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">library</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Im Server-Kontext kann baseUrl übergeben werden, sonst relative URL verwenden</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Prüft, ob der Provider authentifiziert ist.</span>
<span class="cm">   * Für das lokale Dateisystem ist dies immer true, da keine Authentifizierung erforderlich ist.</span>
<span class="cm">   * @returns Immer true für das lokale Dateisystem</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">isAuthenticated</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Setzt die Benutzer-E-Mail für Server-zu-Server API-Calls</span>
<span class="w">  </span><span class="nx">setUserEmail</span><span class="p">(</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">email</span><span class="p">;</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] User E-Mail gesetzt: </span><span class="si">${</span><span class="nx">email</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">get</span><span class="w"> </span><span class="nx">name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;Local Filesystem&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">get</span><span class="w"> </span><span class="nx">id</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">getApiUrl</span><span class="p">(</span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="si">}${</span><span class="nx">path</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// E-Mail als Parameter anhängen, wenn im Server-Kontext</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">separator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;&amp;&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">url</span><span class="si">}${</span><span class="nx">separator</span><span class="si">}</span><span class="sb">email=</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">url</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=list&amp;fileId=</span><span class="si">${</span><span class="nx">folderId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Calling API:`</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">);</span>

<span class="w">    </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;LocalStorageProvider&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starting listItemsById API call&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasUserEmail</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">this.userEmail</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="si">}</span><span class="sb">@...`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="kt">url.replace</span><span class="p">(</span><span class="sr">/email=[^&amp;]+/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;email=***&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] API call failed:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span>
<span class="w">          </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="p">,</span>
<span class="w">          </span><span class="nx">url</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span><span class="p">,</span>
<span class="w">          </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">this.userEmail</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Versuche, die spezifische Fehlermeldung aus der Response zu extrahieren</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`HTTP </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">errorData</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">errorCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Error code:`</span><span class="p">,</span><span class="w"> </span><span class="nx">errorData</span><span class="p">.</span><span class="nx">errorCode</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">parseError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Konnte Fehlermeldung nicht parsen:`</span><span class="p">,</span><span class="w"> </span><span class="nx">parseError</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Spezifische Behandlung für verschiedene HTTP-Status-Codes</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">404</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Bibliothek nicht gefunden. Bitte überprüfen Sie die Bibliothekskonfiguration.`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">400</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Ungültige Anfrage: </span><span class="si">${</span><span class="nx">errorMessage</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Server-Fehler beim Laden der Bibliothek. Bitte überprüfen Sie, ob der Bibliothekspfad existiert und zugänglich ist.`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Fehler beim Laden der Bibliothek: </span><span class="si">${</span><span class="nx">errorMessage</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// AuthLogger für Fehler</span>
<span class="w">        </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;LocalStorageProvider&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;API call failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span>
<span class="w">          </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="p">,</span>
<span class="w">          </span><span class="nx">errorMessage</span><span class="p">,</span>
<span class="w">          </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span><span class="p">,</span>
<span class="w">          </span><span class="nx">hasUserEmail</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Successfully loaded </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> items`</span><span class="p">);</span>

<span class="w">      </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;LocalStorageProvider&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;API call successful&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">itemCount</span><span class="o">:</span><span class="w"> </span><span class="kt">data.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Exception in listItemsById:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">error.name</span><span class="p">,</span>
<span class="w">          </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack?.split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">,</span>
<span class="w">        </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">this.userEmail</span><span class="p">,</span>
<span class="w">        </span><span class="nx">libraryPath</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.path</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;LocalStorageProvider&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Exception in listItemsById&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Re-throw den Fehler mit zusätzlichem Kontext</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Fehler beim Laden der Bibliothek &quot;</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">&quot;: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Unbekannter Fehler beim Laden der Bibliothek &quot;</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getItemById</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=get&amp;fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to get item&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">createFolder</span><span class="p">(</span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=createFolder&amp;fileId=</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">}),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to create folder&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">deleteItem</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to delete item&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">moveItem</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">newParentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;newParentId=</span><span class="si">${</span><span class="nx">newParentId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PATCH&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to move item&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">renameItem</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">newName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=rename&amp;fileId=</span><span class="si">${</span><span class="nx">itemId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PATCH&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">newName</span><span class="w"> </span><span class="p">}),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to rename item&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Preparing upload:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parentId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">file.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileSize</span><span class="o">:</span><span class="w"> </span><span class="kt">file.size</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileType</span><span class="o">:</span><span class="w"> </span><span class="kt">file.type</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">formData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=upload&amp;fileId=</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">formData</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="w"> </span><span class="p">}));</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Failed to upload file&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">downloadFile</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Blob</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=download&amp;fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to download file&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">blob</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">blob</span><span class="o">:</span><span class="w"> </span><span class="kt">Blob</span><span class="p">;</span><span class="w"> </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=binary&amp;fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to get binary&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">blob</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">blob</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">response.headers.get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>



<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=path&amp;fileId=</span><span class="si">${</span><span class="nx">itemId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to get path&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getPathItemsById</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">itemId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Root-Item erzeugen</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">            </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">            </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/folder&#39;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">itemId</span><span class="p">);</span><span class="w"> </span><span class="c1">// z.B. /foo/bar/baz</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">segments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pathItems</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">segment</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">segments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">folder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">children</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">segment</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">folder</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="nx">pathItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">folder</span><span class="p">);</span>
<span class="w">      </span><span class="nx">parentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">folder</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/folder&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">...</span><span class="nx">pathItems</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">validateConfiguration</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageValidationResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">isValid</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getStreamingUrl</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Für lokale Dateien verwenden wir die filesystem API-Route mit action=binary</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=binary&amp;fileId=</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getDownloadUrl</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Für lokale Dateien ist die Download-URL identisch mit der Streaming-URL</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getStreamingUrl</span><span class="p">(</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">instance</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageFactory</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">libraries</span><span class="o">:</span><span class="w"> </span><span class="kt">ClientLibrary</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">StorageProvider</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">apiBaseUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">getInstance</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">StorageFactory</span><span class="p">.</span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">StorageFactory</span><span class="p">.</span><span class="nx">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="p">.</span><span class="nx">instance</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Setzt die Basis-URL für API-Anfragen, wichtig für serverseitige Aufrufe</span>
<span class="w">  </span><span class="nx">setApiBaseUrl</span><span class="p">(</span><span class="nx">baseUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">apiBaseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseUrl</span><span class="p">;</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: API-Basis-URL gesetzt auf </span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Setzt die Benutzer-E-Mail für alle Provider</span>
<span class="cm">   * Wichtig für Client-zu-Server API-Aufrufe</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">setUserEmail</span><span class="p">(</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">email</span><span class="p">;</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[StorageFactory] User E-Mail gesetzt: </span><span class="si">${</span><span class="nx">email</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Update existing providers</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">provider</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;setUserEmail&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">setUserEmail</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}).</span><span class="nx">setUserEmail</span><span class="o">?</span><span class="p">.(</span><span class="nx">email</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[StorageFactory] E-Mail an Provider </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> übertragen`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setLibraries</span><span class="p">(</span><span class="nx">libraries</span><span class="o">:</span><span class="w"> </span><span class="kt">ClientLibrary</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: setLibraries aufgerufen mit </span><span class="si">${</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> Bibliotheken`</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`StorageFactory: Warnung - Leere Bibliotheksliste übergeben!`</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Bibliotheksliste nicht leeren, wenn eine neue leere Liste übergeben wird</span>
<span class="w">      </span><span class="c1">// Dies verhindert Probleme, wenn die Komponente mit einer leeren Liste initialisiert wird</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliotheksdaten protokollieren</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Bibliotheksdaten:`</span><span class="p">,</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.label</span><span class="p">,</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.path</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;kein Pfad&#39;</span>
<span class="w">    </span><span class="p">})));</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Die Provider nur zurücksetzen, wenn sich die IDs der Bibliotheken geändert haben</span>
<span class="w">    </span><span class="c1">// Dies verhindert unnötiges Neuladen bei redundanten setLibraries-Aufrufen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentProviderIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">keys</span><span class="p">());</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newLibraryIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasChanges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentProviderIds</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">newLibraryIds</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="o">||</span>
<span class="w">                       </span><span class="nx">newLibraryIds</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">currentProviderIds</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">id</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasChanges</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Bibliotheksliste hat sich geändert, setze Provider zurück`</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Bibliotheksliste unverändert, behalte bestehende Provider`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Löscht einen bestimmten Provider aus dem Cache, um eine Neuinitialisierung zu erzwingen</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">clearProvider</span><span class="p">(</span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Lösche Provider für Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> aus dem Cache`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Zusätzliche Debugging-Informationen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">existingProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existingProvider</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Lösche Provider-Details:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">providerId</span><span class="o">:</span><span class="w"> </span><span class="kt">libraryId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">providerName</span><span class="o">:</span><span class="w"> </span><span class="kt">existingProvider.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cachedLibraryPath</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">existingProvider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">LibraryPathProvider</span><span class="p">).</span><span class="nx">_libraryPath</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;nicht verfügbar&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">aktuelleBibliothekPath</span><span class="o">:</span><span class="w"> </span><span class="kt">library?.path</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;nicht verfügbar&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">zeitpunkt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Kein Provider im Cache für Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Provider für </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> wurde aus dem Cache entfernt`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getProvider</span><span class="p">(</span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageProvider</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: getProvider aufgerufen für Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Check if provider already exists</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Verwende existierenden Provider für Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Find library</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">library</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`StorageFactory: Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> nicht gefunden!`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Verfügbare Bibliotheken:`</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.label</span>
<span class="w">      </span><span class="p">})));</span>

<span class="w">      </span><span class="c1">// Spezifischen Fehler werfen, den wir später abfangen können</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> nicht gefunden`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;LibraryNotFoundError&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="kd">interface</span><span class="w"> </span><span class="nx">LibraryNotFoundError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">        </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">typedError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">LibraryNotFoundError</span><span class="p">;</span>
<span class="w">      </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">errorCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;LIBRARY_NOT_FOUND&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">typedError</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Erstelle neuen Provider für Bibliothek:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">library.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">library.label</span><span class="p">,</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="kt">library.path</span><span class="p">,</span>
<span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Create provider based on library type</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">;</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">LocalStorageProvider</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">apiBaseUrl</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: LocalStorageProvider erstellt für &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Set user email if available</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s1">&#39;setUserEmail&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}).</span><span class="nx">setUserEmail</span><span class="o">?</span><span class="p">.(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: User-Email an LocalStorageProvider gesetzt`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OneDriveProvider</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">apiBaseUrl</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: OneDriveProvider erstellt`</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Set user email if available</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s1">&#39;setUserEmail&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}).</span><span class="nx">setUserEmail</span><span class="o">?</span><span class="p">.(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: User-Email an OneDriveProvider gesetzt`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Add more provider types here</span>
<span class="w">      </span><span class="nx">default</span><span class="o">:</span>
<span class="w">        </span><span class="kt">console.warn</span><span class="p">(</span><span class="sb">`StorageFactory: Nicht unterstützter Bibliothekstyp &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span><span class="si">}</span><span class="sb">&quot; für Bibliothek &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="sb">`StorageFactory: Unterstützte Typen: </span><span class="si">${</span><span class="nx">getSupportedLibraryTypesString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Spezifischen Fehler werfen, den wir graceful handhaben können</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Bibliothekstyp &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span><span class="si">}</span><span class="sb">&quot; wird noch nicht unterstützt. Unterstützte Typen: </span><span class="si">${</span><span class="nx">getSupportedLibraryTypesString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;UnsupportedLibraryTypeError&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">interface</span><span class="w"> </span><span class="nx">UnsupportedLibraryTypeError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">          </span><span class="nx">libraryType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">typedError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">UnsupportedLibraryTypeError</span><span class="p">;</span>
<span class="w">        </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">errorCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;UNSUPPORTED_LIBRARY_TYPE&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">libraryType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span><span class="p">;</span>
<span class="w">        </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">typedError</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cache provider</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">provider</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">provider</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">/children`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive children list fehlgeschlagen: </span><span class="si">${</span><span class="nx">list</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">folder?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="nx">.value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">it</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">folder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">existing.id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;@microsoft.graph.conflictBehavior&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rename&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Ordnererstellung fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">created</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveData</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceRelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">sourceId</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetRelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Pfade ermitteln (aktuell nur für Debugging/Logging nutzbar)</span>
<span class="w">        </span><span class="c1">// const sourceAbsPath = sourceRelPath &amp;&amp; sourceRelPath !== &#39;/&#39; ? path.join(lib.path, sourceRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>
<span class="w">        </span><span class="c1">// const targetAbsPath = targetRelPath &amp;&amp; targetRelPath !== &#39;/&#39; ? path.join(lib.path, targetRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath &amp;&amp; savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">            </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">              </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">              </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">          </span><span class="p">};</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">            </span><span class="nx">imagesArchiveData</span><span class="p">,</span>
<span class="w">            </span><span class="nx">imagesArchiveFilename</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;pdf_images.zip&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">            </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">            </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">            </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">            </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span>
<span class="w">          </span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="sb">`.</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">JSZip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;jszip&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">JSZip</span><span class="p">.</span><span class="k">default</span><span class="p">().</span><span class="nx">loadAsync</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">zip</span><span class="p">.</span><span class="nx">files</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">imagesSaved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">fileEntry</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">entries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">dir?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">}).</span><span class="nx">dir</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ext</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpeg&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">ext</span><span class="p">))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`image.</span><span class="si">${</span><span class="nx">ext</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^image_(\d+)/</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">_m</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`page_</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;png&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;image/png&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">async</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Buffer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}).</span><span class="k">async</span><span class="p">(</span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">imgItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="p">,</span><span class="w"> </span><span class="nx">bin</span><span class="p">);</span>
<span class="w">            </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">imgItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">            </span><span class="nx">imagesSaved</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">textContents</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/page_(\d+)/</span><span class="p">);</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mf">1</span><span class="p">]);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">page</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.(png|jpg|jpeg)$/i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span>
<span class="w">                    </span><span class="sb">`# </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n\n## Quelle\n**PDF-Datei:** </span><span class="si">${</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="sb">\n**Bild:** </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n**Sprache:** </span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">\n**Seite:** </span><span class="si">${</span><span class="nx">page</span><span class="si">}</span><span class="sb">\n\n## Extrahierter Text\n</span><span class="si">${</span><span class="nx">tc</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="sb">\n`</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;utf8&#39;</span>
<span class="w">                  </span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">mdName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mdItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imagesSaved</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_data</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveData</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_filename</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveFilename</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">/children`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive children list fehlgeschlagen: </span><span class="si">${</span><span class="nx">list</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">folder?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="nx">.value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">it</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">folder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">existing.id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;@microsoft.graph.conflictBehavior&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rename&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Ordnererstellung fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">created</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveData</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceRelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">sourceId</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetRelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Pfade ermitteln (aktuell nur für Debugging/Logging nutzbar)</span>
<span class="w">        </span><span class="c1">// const sourceAbsPath = sourceRelPath &amp;&amp; sourceRelPath !== &#39;/&#39; ? path.join(lib.path, sourceRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>
<span class="w">        </span><span class="c1">// const targetAbsPath = targetRelPath &amp;&amp; targetRelPath !== &#39;/&#39; ? path.join(lib.path, targetRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath &amp;&amp; savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">            </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">              </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">              </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">          </span><span class="p">};</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">            </span><span class="nx">imagesArchiveData</span><span class="p">,</span>
<span class="w">            </span><span class="nx">imagesArchiveFilename</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;pdf_images.zip&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">            </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">            </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">            </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">            </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span>
<span class="w">          </span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="sb">`.</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">JSZip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;jszip&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">JSZip</span><span class="p">.</span><span class="k">default</span><span class="p">().</span><span class="nx">loadAsync</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">zip</span><span class="p">.</span><span class="nx">files</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">imagesSaved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">fileEntry</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">entries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">dir?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">}).</span><span class="nx">dir</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ext</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpeg&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">ext</span><span class="p">))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`image.</span><span class="si">${</span><span class="nx">ext</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^image_(\d+)/</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">_m</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`page_</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;png&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;image/png&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">async</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Buffer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}).</span><span class="k">async</span><span class="p">(</span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">imgItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="p">,</span><span class="w"> </span><span class="nx">bin</span><span class="p">);</span>
<span class="w">            </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">imgItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">            </span><span class="nx">imagesSaved</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">textContents</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/page_(\d+)/</span><span class="p">);</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mf">1</span><span class="p">]);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">page</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.(png|jpg|jpeg)$/i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span>
<span class="w">                    </span><span class="sb">`# </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n\n## Quelle\n**PDF-Datei:** </span><span class="si">${</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="sb">\n**Bild:** </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n**Sprache:** </span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">\n**Seite:** </span><span class="si">${</span><span class="nx">page</span><span class="si">}</span><span class="sb">\n\n## Extrahierter Text\n</span><span class="si">${</span><span class="nx">tc</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="sb">\n`</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;utf8&#39;</span>
<span class="w">                  </span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">mdName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mdItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imagesSaved</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_data</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveData</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_filename</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveFilename</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;https://graph.microsoft.com/v1.0/me/drive/root/children&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">/children`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">list</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive children list fehlgeschlagen: </span><span class="si">${</span><span class="nx">list</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">folder?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="nx">.value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">it</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">folder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">existing.id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Authorization</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">folder</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;@microsoft.graph.conflictBehavior&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;rename&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Ordnererstellung fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">created</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveData</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Pfade nur bei Bedarf auflösen (derzeit nicht benötigt)</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(sourceId ?? &#39;&#39;).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(targetParentId).catch(() =&gt; &#39;/&#39;);</span>
<span class="w">        </span><span class="c1">// Pfade ermitteln (aktuell nur für Debugging/Logging nutzbar)</span>
<span class="w">        </span><span class="c1">// const sourceAbsPath = sourceRelPath &amp;&amp; sourceRelPath !== &#39;/&#39; ? path.join(lib.path, sourceRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>
<span class="w">        </span><span class="c1">// const targetAbsPath = targetRelPath &amp;&amp; targetRelPath !== &#39;/&#39; ? path.join(lib.path, targetRelPath.replace(/^\//, &#39;&#39;)) : lib.path;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// const savedRelPath = await provider.getPathById(saved.id).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// const savedAbsPath = savedRelPath &amp;&amp; savedRelPath !== &#39;/&#39; ? path.join(lib.path, savedRelPath.replace(/^\//, &#39;&#39;)) : undefined;</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">            </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">              </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">              </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">          </span><span class="p">};</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">            </span><span class="nx">imagesArchiveData</span><span class="p">,</span>
<span class="w">            </span><span class="nx">imagesArchiveFilename</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;pdf_images.zip&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">            </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">            </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">            </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">            </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span>
<span class="w">          </span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveEnsureFolder</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="sb">`.</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">JSZip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;jszip&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">JSZip</span><span class="p">.</span><span class="k">default</span><span class="p">().</span><span class="nx">loadAsync</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">imagesArchiveData</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">zip</span><span class="p">.</span><span class="nx">files</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">imagesSaved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="nx">fileEntry</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">entries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">dir?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">}).</span><span class="nx">dir</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ext</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jpeg&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">ext</span><span class="p">))</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`image.</span><span class="si">${</span><span class="nx">ext</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^image_(\d+)/</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">_m</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`page_</span><span class="si">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;png&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;image/png&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="nx">fileEntry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">async</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Buffer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}).</span><span class="k">async</span><span class="p">(</span><span class="s1">&#39;nodebuffer&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">imgItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="p">,</span><span class="w"> </span><span class="nx">bin</span><span class="p">);</span>
<span class="w">            </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">imgItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">            </span><span class="nx">imagesSaved</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">textContents</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/page_(\d+)/</span><span class="p">);</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mf">1</span><span class="p">]);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">textContents</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">page</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">pageFileName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.(png|jpg|jpeg)$/i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span>
<span class="w">                    </span><span class="sb">`# </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n\n## Quelle\n**PDF-Datei:** </span><span class="si">${</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="sb">\n**Bild:** </span><span class="si">${</span><span class="nx">pageFileName</span><span class="si">}</span><span class="sb">\n**Sprache:** </span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">\n**Seite:** </span><span class="si">${</span><span class="nx">page</span><span class="si">}</span><span class="sb">\n\n## Extrahierter Text\n</span><span class="si">${</span><span class="nx">tc</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="sb">\n`</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;utf8&#39;</span>
<span class="w">                  </span><span class="p">);</span>
<span class="w">                  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mdItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">imagesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">mdName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdBuffer</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mdItem</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imagesSaved</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_data</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveData</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_filename</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveFilename</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;;

import { useEffect, useRef, useState } from &#39;react&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Progress } from &quot;@/components/ui/progress&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { ScrollArea } from &quot;@/components/ui/scroll-area&quot;;
import { Badge } from &quot;@/components/ui/badge&quot;;
import { HoverCard, HoverCardContent, HoverCardTrigger } from &quot;@/components/ui/hover-card&quot;;
import { FileText, FileAudio, FileVideo, Image as ImageIcon, File as FileIcon, FileType2, RefreshCw, Ban } from &quot;lucide-react&quot;;

interface JobListItem {
  jobId: string;
  status: string;
  operation?: string;
  worker?: string;
  jobType?: string;
  fileName?: string;
  updatedAt?: string;
  createdAt?: string;
  lastMessage?: string;
  lastProgress?: number;
}

interface JobUpdateEvent {
  type: &#39;job_update&#39;;
  jobId: string;
  status: string;
  phase?: string;
  progress?: number;
  message?: string;
  updatedAt: string;
  jobType?: string;
  fileName?: string;
}

function formatRelative(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const date = new Date(dateIso);
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins &lt; 1) return &#39;jetzt&#39;;
  if (mins &lt; 60) return `vor ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs &lt; 24) return `vor ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `vor ${days}d`;
}

function formatClock(dateIso?: string): string {
  if (!dateIso) return &#39;&#39;;
  const d = new Date(dateIso);
  const mm = String(d.getMinutes()).padStart(2, &#39;0&#39;);
  const ss = String(d.getSeconds()).padStart(2, &#39;0&#39;);
  return `${mm}:${ss}`;
}

function formatDuration(startIso?: string, endIso?: string): string {
  if (!startIso || !endIso) return &#39;&#39;;
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  if (!Number.isFinite(ms) || ms &lt; 0) return &#39;&#39;;
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h &gt; 0) return `${h}:${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
  return `${String(m).padStart(2, &#39;0&#39;)}:${String(s).padStart(2, &#39;0&#39;)}`;
}

function StatusBadge({ status }: { status: string }) {
  const variant = status === &#39;completed&#39; ? &#39;default&#39;
    : status === &#39;running&#39; ? &#39;secondary&#39;
    : status === &#39;failed&#39; ? &#39;destructive&#39;
    : &#39;outline&#39;;
  return &lt;Badge variant={variant}&gt;{status}&lt;/Badge&gt;;
}

export function JobMonitorPanel() {
  const [isOpen, setIsOpen] = useState(false);
  const [items, setItems] = useState&lt;JobListItem[]&gt;([]);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const eventRef = useRef&lt;EventSource | null&gt;(null);
  const isFetchingRef = useRef(false);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [hiddenIds, setHiddenIds] = useState&lt;Set&lt;string&gt;&gt;(new Set());

  // Initiale Seite laden
  useEffect(() =&gt; {
    let cancelled = false;
    async function load(pageNum: number, replace: boolean) {
      try {
        isFetchingRef.current = true;
        const res = await fetch(`/api/external/jobs?page=${pageNum}&amp;limit=20`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (cancelled) return;
        setItems(prev =&gt; replace ? json.items : [...prev, ...json.items]);
        setHasMore(json.items.length === 20);
      } finally {
        isFetchingRef.current = false;
      }
    }
    load(1, true);
    return () =&gt; { cancelled = true; };
  }, []);

  const refreshNow = async () =&gt; {
    if (isRefreshing) return;
    setIsRefreshing(true);
    try {
      const res = await fetch(`/api/external/jobs?page=1&amp;limit=20`, { cache: &#39;no-store&#39; });
      if (!res.ok) return;
      const json = await res.json();
      setItems(json.items || []);
      setPage(1);
      setHasMore((json.items || []).length === 20);
    } finally {
      setIsRefreshing(false);
    }
  };

  // SSE verbinden (mit einfachem Reconnect und Initial-Refresh)
  useEffect(() =&gt; {
    let retryTimer: ReturnType&lt;typeof setTimeout&gt; | null = null;
    function connect() {
      if (eventRef.current) {
        try { eventRef.current.close(); } catch {}
      }
      const es = new EventSource(&#39;/api/external/jobs/stream&#39;);
      eventRef.current = es;

      es.addEventListener(&#39;open&#39;, () =&gt; {
        void refreshNow();
      });

      const onUpdate = (e: MessageEvent) =&gt; {
        try {
          const evt: JobUpdateEvent = JSON.parse(e.data);
          setItems(prev =&gt; {
            const idx = prev.findIndex(p =&gt; p.jobId === evt.jobId);
            const patch: Partial&lt;JobListItem&gt; = {
              status: evt.status,
              lastMessage: evt.message ?? prev[idx]?.lastMessage,
              lastProgress: evt.progress ?? prev[idx]?.lastProgress,
              updatedAt: evt.updatedAt,
              jobType: evt.jobType ?? prev[idx]?.jobType,
              fileName: evt.fileName ?? prev[idx]?.fileName,
            };
            if (idx &gt;= 0) {
              const updated = { ...prev[idx], ...patch };
              const next = [...prev];
              next[idx] = updated;
              // bei Update nach oben reihen (neueste zuerst)
              next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
              return next;
            }
            // Neuer Job → vorne einfügen
            const inserted: JobListItem = {
              jobId: evt.jobId,
              status: evt.status,
              updatedAt: evt.updatedAt,
              lastMessage: evt.message,
              lastProgress: evt.progress,
              jobType: evt.jobType,
              fileName: evt.fileName,
            };
            return [inserted, ...prev];
          });
        } catch {}
      };
      es.addEventListener(&#39;job_update&#39;, onUpdate as unknown as EventListener);
      es.addEventListener(&#39;error&#39;, () =&gt; {
        try { es.close(); } catch {}
        if (retryTimer) clearTimeout(retryTimer);
        retryTimer = setTimeout(connect, 3000);
      });
    }
    connect();
    // Fallback: lokale Events (wenn wir selbst einen Job starten)
    const onLocal = (e: Event) =&gt; {
      const detail = (e as CustomEvent).detail as JobUpdateEvent;
      if (!detail?.jobId) return;
      setItems(prev =&gt; {
        const idx = prev.findIndex(p =&gt; p.jobId === detail.jobId);
        const patch: Partial&lt;JobListItem&gt; = {
          status: detail.status,
          lastMessage: detail.message ?? prev[idx]?.lastMessage,
          lastProgress: detail.progress ?? prev[idx]?.lastProgress,
          updatedAt: detail.updatedAt,
          jobType: detail.jobType ?? prev[idx]?.jobType,
          fileName: detail.fileName ?? prev[idx]?.fileName,
        };
        if (idx &gt;= 0) {
          const updated = { ...prev[idx], ...patch };
          const next = [...prev];
          next[idx] = updated;
          next.sort((a, b) =&gt; (new Date(b.updatedAt || 0).getTime()) - (new Date(a.updatedAt || 0).getTime()));
          return next;
        }
        const inserted: JobListItem = {
          jobId: detail.jobId,
          status: detail.status,
          updatedAt: detail.updatedAt,
          lastMessage: detail.message,
          lastProgress: detail.progress,
          jobType: detail.jobType,
          fileName: detail.fileName,
        };
        return [inserted, ...prev];
      });
    };
    window.addEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    return () =&gt; {
      if (retryTimer) clearTimeout(retryTimer);
      if (eventRef.current) try { eventRef.current.close(); } catch {}
      window.removeEventListener(&#39;job_update_local&#39;, onLocal as unknown as EventListener);
    };
  }, []);

  const handleToggle = () =&gt; setIsOpen(v =&gt; !v);
  const loadMore = async () =&gt; {
    if (!hasMore || isFetchingRef.current) return;
    const next = page + 1;
    const res = await fetch(`/api/external/jobs?page=${next}&amp;limit=20`, { cache: &#39;no-store&#39; });
    if (!res.ok) return;
    const json = await res.json();
    setItems(prev =&gt; [...prev, ...json.items]);
    setPage(next);
    setHasMore(json.items.length === 20);
  };

  function JobTypeIcon({ jobType }: { jobType?: string }) {
    const type = (jobType || &#39;&#39;).toLowerCase();
    const Icon = type === &#39;pdf&#39; ? FileText
      : type === &#39;audio&#39; ? FileAudio
      : type === &#39;video&#39; ? FileVideo
      : type === &#39;image&#39; ? ImageIcon
      : type === &#39;text&#39; ? FileType2
      : FileIcon;
    return &lt;Icon className=&quot;w-4 h-4 text-muted-foreground&quot; aria-hidden /&gt;;
  }

  function hideJob(jobId: string) {
    setHiddenIds(prev =&gt; new Set(prev).add(jobId));
  }

  function hideAllJobs() {
    setHiddenIds(new Set(items.map(i =&gt; i.jobId)));
  }

  return (
    &lt;div className=&quot;pointer-events-none&quot;&gt;
      {/* Handle */}
      &lt;div className={cn(
        &quot;fixed top-16 right-0 z-40 transition-transform&quot;,
        isOpen ? &quot;translate-x-[calc(0px)]&quot; : &quot;translate-x-0&quot;
      )}&gt;
        &lt;button
          onClick={handleToggle}
          className={cn(
            &quot;pointer-events-auto select-none&quot;,
            &quot;bg-primary text-primary-foreground&quot;,
            &quot;rounded-l-md shadow&quot;,
            &quot;px-2 py-1&quot;,
            &quot;hover:opacity-90&quot;
          )}
          aria-label={isOpen ? &#39;Panel schließen&#39; : &#39;Job-Monitor öffnen&#39;}
        &gt;
          {isOpen ? &#39;×&#39; : &#39;≡&#39;}
        &lt;/button&gt;
      &lt;/div&gt;

      {/* Panel */}
      &lt;div className={cn(
        &quot;fixed top-0 right-0 h-screen z-30&quot;,
        &quot;w-[380px] md:w-[420px]&quot;,
        &quot;bg-background border-l&quot;,
        &quot;shadow-lg&quot;,
        &quot;transition-transform duration-300&quot;,
        isOpen ? &quot;translate-x-0&quot; : &quot;translate-x-full&quot;,
        &quot;pointer-events-auto&quot;
      )}&gt;
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;div className=&quot;px-4 py-3 border-b flex items-center justify-between&quot;&gt;
            &lt;div className=&quot;font-semibold flex items-center gap-2&quot;&gt;
              &lt;span&gt;Secretary Jobs&lt;/span&gt;
              &lt;button
                onClick={refreshNow}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Liste aktualisieren&quot;
                title=&quot;Liste aktualisieren&quot;
              &gt;
                &lt;RefreshCw className={cn(&quot;h-4 w-4&quot;, isRefreshing &amp;&amp; &quot;animate-spin&quot;)} /&gt;
              &lt;/button&gt;
              &lt;button
                onClick={hideAllJobs}
                className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                aria-label=&quot;Alle ausblenden&quot;
                title=&quot;Alle ausblenden&quot;
              &gt;
                &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
              &lt;/button&gt;
            &lt;/div&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;ghost&quot; onClick={handleToggle} aria-label=&quot;Schließen&quot;&gt;×&lt;/Button&gt;
          &lt;/div&gt;
          &lt;ScrollArea className=&quot;flex-1&quot;&gt;
            &lt;ul className=&quot;p-3 space-y-2&quot;&gt;
              {items.filter(it =&gt; !hiddenIds.has(it.jobId)).map(item =&gt; (
                &lt;li key={item.jobId} className=&quot;border rounded-md p-3&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;flex items-center gap-2 min-w-0&quot;&gt;
                      &lt;div className=&quot;shrink-0&quot; title={item.jobType || &#39;job&#39;}&gt;
                        &lt;JobTypeIcon jobType={item.jobType} /&gt;
                      &lt;/div&gt;
                      &lt;HoverCard openDelay={200} closeDelay={100}&gt;
                        &lt;HoverCardTrigger asChild&gt;
                          &lt;div className=&quot;truncate text-sm font-medium cursor-default&quot; title={item.fileName || item.jobId}&gt;{item.fileName || (item.operation || &#39;job&#39;)}&lt;/div&gt;
                        &lt;/HoverCardTrigger&gt;
                        &lt;HoverCardContent side=&quot;top&quot; align=&quot;start&quot; className=&quot;w-80 text-xs&quot;&gt;
                          &lt;JobLogs jobId={item.jobId} /&gt;
                        &lt;/HoverCardContent&gt;
                      &lt;/HoverCard&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-1&quot;&gt;
                      &lt;button
                        onClick={() =&gt; hideJob(item.jobId)}
                        className=&quot;pointer-events-auto inline-flex items-center justify-center rounded p-1 hover:bg-muted&quot;
                        aria-label=&quot;Ausblenden&quot;
                        title=&quot;Ausblenden&quot;
                      &gt;
                        &lt;Ban className=&quot;h-4 w-4&quot; /&gt;
                      &lt;/button&gt;
                      &lt;StatusBadge status={item.status} /&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 relative&quot;&gt;
                    &lt;Progress value={typeof item.lastProgress === &#39;number&#39; ? Math.max(0, Math.min(100, item.lastProgress)) : 0} /&gt;
                    {item.status === &#39;completed&#39; &amp;&amp; (
                      &lt;div className=&quot;absolute inset-0 flex items-center justify-center text-[11px] text-muted-foreground&quot;&gt;
                        {formatDuration(item.createdAt, item.updatedAt)}
                      &lt;/div&gt;
                    )}
                  &lt;/div&gt;
                  &lt;div className=&quot;mt-2 text-xs text-muted-foreground flex items-center justify-between gap-2&quot;&gt;
                    &lt;div className=&quot;truncate&quot; title={item.lastMessage}&gt;{item.lastMessage || &#39;—&#39;}&lt;/div&gt;
                    &lt;div&gt;{formatRelative(item.updatedAt)}&lt;/div&gt;
                  &lt;/div&gt;
                &lt;/li&gt;
              ))}
              {items.length === 0 &amp;&amp; (
                &lt;li className=&quot;text-sm text-muted-foreground py-6 text-center&quot;&gt;Keine Jobs&lt;/li&gt;
              )}
            &lt;/ul&gt;
          &lt;/ScrollArea&gt;
          &lt;div className=&quot;p-3 border-t flex items-center justify-center&quot;&gt;
            &lt;Button size=&quot;sm&quot; variant=&quot;outline&quot; onClick={loadMore} disabled={!hasMore}&gt;Ältere laden&lt;/Button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function JobLogs({ jobId }: { jobId: string }) {
  const [logs, setLogs] = useState&lt;Array&lt;{ timestamp: string; phase?: string; progress?: number; message?: string }&gt;&gt;([]);
  const [loaded, setLoaded] = useState(false);

  useEffect(() =&gt; {
    let active = true;
    async function load() {
      try {
        const res = await fetch(`/api/external/jobs/${jobId}?limit=50`, { cache: &#39;no-store&#39; });
        if (!res.ok) return;
        const json = await res.json();
        if (!active) return;
        const l: Array&lt;{ timestamp?: string; phase?: string; progress?: number; message?: string }&gt; = Array.isArray(json.logs) ? json.logs : [];
        setLogs(l.map((e) =&gt; ({
          timestamp: String(e.timestamp),
          phase: typeof e.phase === &#39;string&#39; ? e.phase : undefined,
          progress: typeof e.progress === &#39;number&#39; ? e.progress : undefined,
          message: typeof e.message === &#39;string&#39; ? e.message : undefined,
        })));
        setLoaded(true);
      } catch {
        // ignore
      }
    }
    if (!loaded) load();
    return () =&gt; { active = false; };
  }, [jobId, loaded]);

  if (!loaded) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Lade Logs…&lt;/div&gt;;
  // Filter: keinerlei reine Worker-Details ohne message nicht anzeigen
  const visible = logs.filter(l =&gt; (l.message &amp;&amp; l.message.trim() !== &#39;&#39;));
  if (visible.length === 0) return &lt;div className=&quot;text-muted-foreground&quot;&gt;Keine Logs&lt;/div&gt;;

  return (
    &lt;div className=&quot;space-y-2&quot;&gt;
      {visible.map((l, idx) =&gt; (
        &lt;div key={idx} className=&quot;flex items-start justify-between gap-2&quot;&gt;
          &lt;div className=&quot;truncate&quot;&gt;
            &lt;div className=&quot;font-medium truncate&quot;&gt;{l.message || &#39;—&#39;} {typeof l.progress === &#39;number&#39; ? `(${Math.round(l.progress)}%)` : &#39;&#39;}&lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;text-muted-foreground&quot;&gt;{formatClock(l.timestamp)}&lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StorageItem</span><span class="p">,</span><span class="w"> </span><span class="nx">StorageProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@/lib/storage/types&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">transformAudio</span><span class="p">,</span><span class="w"> </span><span class="nx">transformText</span><span class="p">,</span><span class="w"> </span><span class="nx">transformVideo</span><span class="p">,</span><span class="w"> </span><span class="nx">transformPdf</span><span class="p">,</span><span class="w"> </span><span class="nx">transformImage</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryAudioResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryVideoResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryPdfResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryImageResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@/lib/secretary/client&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">,</span><span class="w"> </span><span class="nx">ImageExtractionResult</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./image-extraction-service&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">useCache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="c1">// Neu: Cache-Option für alle Transformationen</span>
<span class="w">  </span><span class="nx">includeImages?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="c1">// Neu: Bilder mit extrahieren und speichern</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">PdfTransformOptions</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">TransformResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">savedItem?</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">;</span>
<span class="w">  </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">[];</span>
<span class="w">  </span><span class="nx">imageExtractionResult?</span><span class="o">:</span><span class="w"> </span><span class="kt">ImageExtractionResult</span><span class="p">;</span><span class="w"> </span><span class="c1">// Neu: Ergebnis der Bild-Extraktion</span>
<span class="w">  </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">VideoTransformOptions</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extractAudio</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">extractFrames</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">frameInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">sourceLanguage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">template?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ImageTransformOptions</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">context?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Typ für die Metadaten, die im Frontmatter gespeichert werden</span>
<span class="cm"> */</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">TransformMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">  </span><span class="nx">source_file?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source_file_id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source_file_size?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source_file_type?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Transformations-Informationen</span>
<span class="w">  </span><span class="nx">source_language?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">target_language?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Audio-Metadaten</span>
<span class="w">  </span><span class="nx">audio_duration?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_format?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_channels?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_sample_rate?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_bit_rate?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Prozess-Informationen</span>
<span class="w">  </span><span class="nx">process_id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">processor?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">processing_duration_ms?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">model_used?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokens_used?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">  </span><span class="nx">cache_used?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">cache_key?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Weitere Felder können hinzugefügt werden</span>
<span class="w">  </span><span class="p">[</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * TransformService - Zentraler Service für Transformations- und Speicheroperationen</span>
<span class="cm"> * Verantwortlich für:</span>
<span class="cm"> * - Transformation von Audio zu Text</span>
<span class="cm"> * - Transformation von Text zu optimiertem Text</span>
<span class="cm"> * - Speichern der Ergebnisse als Shadow-Twin oder als neue Datei</span>
<span class="cm"> * - Aktualisieren der Dateiliste</span>
<span class="cm"> * - Bereitstellen einer einheitlichen Schnittstelle für alle Transformationstypen</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Generiert einen standardisierten Namen für einen Shadow-Twin</span>
<span class="cm">   * @param originalName Der ursprüngliche Dateiname</span>
<span class="cm">   * @param targetLanguage Die Zielsprache</span>
<span class="cm">   * @returns Der generierte Shadow-Twin-Name ohne Dateiendung</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">generateShadowTwinName</span><span class="p">(</span><span class="nx">originalName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Entferne alle Dateiendungen aus dem Namen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">nameWithoutExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">nameWithoutExtension</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">targetLanguage</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert eine Audio-Datei in Text</span>
<span class="cm">   * @param file Die zu transformierende Audio-Datei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Speicheroptionen</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformAudio</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Audio-Datei wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformAudio</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Falls die Response nur ein String ist (alte API)</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Neue API mit vollständigen Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">audioResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryAudioResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">audioResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Sammle relevante Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">source_language</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.transcription.source_language</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Audio-Metadaten (falls vorhanden)</span>
<span class="w">        </span><span class="nx">audio_duration</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_format</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.format</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_channels</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.channels</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_sample_rate</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.sample_rate</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_bit_rate</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.bit_rate</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Erstelle Markdown-Inhalt mit Frontmatter</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">shadowTwinName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">generateShadowTwinName</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">shadowTwinName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert eine Video-Datei</span>
<span class="cm">   * @param file Die zu transformierende Video-Datei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Optionen für Video-Transformation und Speicherung</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis inklusive Video-spezifischer Daten</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformVideo</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">VideoTransformOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] transformVideo gestartet mit Optionen:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Video-Datei wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformVideo</span><span class="p">(</span>
<span class="w">      </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">extractAudio</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractAudio</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extractFrames</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractFrames</span><span class="p">,</span>
<span class="w">        </span><span class="nx">frameInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">options.frameInterval</span><span class="p">,</span>
<span class="w">        </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sourceLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.sourceLanguage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">options.template</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span>
<span class="w">      </span><span class="nx">libraryId</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Vollständige Video-Response:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Response-Check:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">responseType</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
<span class="w">      </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasTranscription</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">),</span>
<span class="w">      </span><span class="nx">transcriptionType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">transcriptionKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Transkription gefunden:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Vollständige Video-Response mit Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">videoResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryVideoResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">videoResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>

<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Extrahierter Text-Länge:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Text-Vorschau:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">));</span>

<span class="w">      </span><span class="c1">// Sammle relevante Video-Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">source_language</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.transcription.source_language</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">sourceLanguage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Video-Metadaten</span>
<span class="w">        </span><span class="nx">video_duration</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">video_duration_formatted</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.duration_formatted</span><span class="p">,</span>
<span class="w">        </span><span class="nx">video_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.file_size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">video_title</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.title</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_file</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.audio_file</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub_processors</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.sub_processors?.join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Extrahierte Metadaten:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TransformService] Keine Transkription in der Response gefunden!&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TransformService] Response-Struktur:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
<span class="w">        </span><span class="nx">hasTranscription</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">),</span>
<span class="w">        </span><span class="nx">responseKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Finaler transformierter Text-Länge:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Erstelle Markdown-Inhalt mit Frontmatter</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Speichere Shadow-Twin mit Länge:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">markdownContent</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Keine Speicherung:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert einen Text mithilfe des Secretary Services</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformText</span><span class="p">(</span>
<span class="w">    </span><span class="nx">textContent</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Besprechung&quot;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] transformText aufgerufen mit:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">originalItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">options</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">template</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Text wird transformiert</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformText</span><span class="p">(</span>
<span class="w">      </span><span class="nx">textContent</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert eine PDF-Datei mithilfe des Secretary Services</span>
<span class="cm">   * @param file Die zu transformierende PDF-Datei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Speicheroptionen</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformPdf</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">PdfTransformOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PDF-Transformation gestartet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">options.includeImages</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IncludeImages Option&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">options.includeImages</span><span class="p">,</span>
<span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// PDF-Datei wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformPdf</span><span class="p">(</span>
<span class="w">      </span><span class="nx">file</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">originalItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalFileName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Vollständige PDF-Response&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Asynchroner Flow: nur &quot;accepted&quot; → Ergebnis via Webhook, kein Client-Fehler</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">data</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">extracted_text?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">((</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">extracted_text?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="nx">process</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">is_from_cache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job akzeptiert – Ergebnis kommt per Webhook&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">r?.job?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">r?.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fromCache</span><span class="o">:</span><span class="w"> </span><span class="kt">r?.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">r?.job?.id</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Response-Check&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">responseType</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
<span class="w">      </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasExtractedText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">),</span>
<span class="w">      </span><span class="nx">extractedTextType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Prüfe auf images_archive_data</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Images Archive Check&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasImagesArchiveData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">),</span>
<span class="w">      </span><span class="nx">hasImagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="p">),</span>
<span class="w">      </span><span class="nx">imagesArchiveDataLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">response.data.images_archive_data.length</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extracted-Text gefunden&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textPreview</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Vollständige PDF-Response mit Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">pdfResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryPdfResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pdfResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Sammle relevante PDF-Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// PDF-Metadaten</span>
<span class="w">        </span><span class="nx">page_count</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.page_count</span><span class="p">,</span>
<span class="w">        </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.format</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extraction_method</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.extraction_method</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_name</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.file_name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.file_size</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub_processors</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.sub_processors?.join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extrahierte Metadaten&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Keine synchronen PDF-Daten erhalten&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">any</span><span class="p">).</span><span class="nx">data</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">imageExtractionResult</span><span class="o">:</span><span class="w"> </span><span class="kt">ImageExtractionResult</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starte Bild-Extraktion&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.images_archive_filename</span><span class="p">,</span>
<span class="w">          </span><span class="nx">imagesArchiveDataLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.images_archive_data.length</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="nx">imageExtractionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">          </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">,</span>
<span class="w">          </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;pdf_images.zip&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">          </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">          </span><span class="nx">refreshItems</span><span class="p">,</span>
<span class="w">          </span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Extrahierten Text weitergeben</span>
<span class="w">          </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span><span class="w"> </span><span class="c1">// Target Language weitergeben</span>
<span class="w">          </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="c1">// Seiten-spezifische Texte weitergeben</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bild-Extraktion abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">folderCreated</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">imageExtractionResult</span><span class="p">.</span><span class="nx">folderItem</span><span class="p">,</span>
<span class="w">          </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">imageExtractionResult.savedItems.length</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Fehler bei der Bild-Extraktion&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Bild-Extraktion ist optional, daher weitermachen</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Finaler transformierter Text&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// NEU: Detaillierte Debug-Logs für das Speicherproblem</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speicher-Bedingungen prüfen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasTransformedText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">transformedTextLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">markdownContentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownContent.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">willSave</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speichere Shadow-Twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">markdownLength</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownContent.length</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Shadow-Twin erfolgreich gespeichert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">savedItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem?.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems.length</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span><span class="p">,</span>
<span class="w">        </span><span class="nx">imageExtractionResult</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Keine Speicherung - Bedingungen nicht erfüllt&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;createShadowTwin ist false&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transformedText ist leer&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">imageExtractionResult</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert ein Bild mithilfe des Secretary Services</span>
<span class="cm">   * @param file Die zu transformierende Bilddatei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Optionen für Bild-Transformation und Speicherung</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformImage</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">ImageTransformOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bild-Transformation gestartet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Bild wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformImage</span><span class="p">(</span>
<span class="w">      </span><span class="nx">file</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Vollständige Bild-Response&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extracted-Text gefunden&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textPreview</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Vollständige Bild-Response mit Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryImageResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imageResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Sammle relevante Bild-Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Bild-Metadaten</span>
<span class="w">        </span><span class="nx">dimensions</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.dimensions</span><span class="p">,</span>
<span class="w">        </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.format</span><span class="p">,</span>
<span class="w">        </span><span class="nx">color_mode</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.color_mode</span><span class="p">,</span>
<span class="w">        </span><span class="nx">dpi</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.dpi?.join</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">extraction_method</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.extraction_method</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_name</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.file_name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.file_size</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub_processors</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.sub_processors?.join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extrahierte Metadaten&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Kein Extracted-Text in der Response gefunden!&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">responseKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Finaler transformierter Text&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speichere Shadow-Twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">markdownLength</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownContent.length</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Keine Speicherung&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Hilfsmethode zum Speichern der transformierten Datei</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">savedItem?</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">;</span><span class="w"> </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">[]</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] saveTwinFile aufgerufen mit:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">originalItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">fileExtension</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// NEU: Detaillierte Debug-Logs</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;saveTwinFile gestartet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">originalItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">fileExtension</span><span class="p">,</span>
<span class="w">      </span><span class="nx">contentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">content.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Hole aktuelle Dateien im Verzeichnis</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">refreshItems</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Aktuelle Dateien im Verzeichnis&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">itemCount</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">existingFiles</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Funktion zum Generieren eines eindeutigen Dateinamens</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">generateUniqueFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">baseName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">extension</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">candidateName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">extension</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Prüfe ob der Name bereits existiert</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">currentItems</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">        </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">        </span><span class="nx">item</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">candidateName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="w">      </span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="nx">candidateName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">(</span><span class="si">${</span><span class="nx">counter</span><span class="si">}</span><span class="sb">).</span><span class="si">${</span><span class="nx">extension</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">candidateName</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Generiere eindeutigen Dateinamen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateUniqueFileName</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span><span class="w"> </span><span class="nx">fileExtension</span><span class="p">);</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Eindeutiger Dateiname generiert:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">baseNameWithLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">uniqueFileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">existingFiles</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Dateiname generiert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">baseName</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">uniqueFileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">existingFilesCount</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">length</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Markdown-Datei erstellen und speichern</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileBlob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">content</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text/markdown&quot;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">fileBlob</span><span class="p">],</span><span class="w"> </span><span class="nx">uniqueFileName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text/markdown&quot;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Datei vorbereitet für Upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileSize</span><span class="o">:</span><span class="w"> </span><span class="kt">file.size</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileType</span><span class="o">:</span><span class="w"> </span><span class="kt">file.type</span><span class="p">,</span>
<span class="w">      </span><span class="nx">contentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">content.length</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// In dasselbe Verzeichnis wie die Originaldatei hochladen</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starte Upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Upload erfolgreich&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItem.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">savedItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">savedItemSize</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItem.metadata.size</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Aktualisierte Dateiliste holen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">updatedItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">refreshItems</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Dateiliste aktualisiert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">updatedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">updatedItems.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">newFileFound</span><span class="o">:</span><span class="w"> </span><span class="kt">updatedItems.some</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">savedItem</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItem</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedItems</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Speichert einen bereits transformierten Text direkt ohne erneute Transformation</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">saveTransformedText</span><span class="p">(</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">saveTransformationResult</span><span class="p">(</span>
<span class="w">      </span><span class="nx">text</span><span class="p">,</span>
<span class="w">      </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">,</span>
<span class="w">      </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">      </span><span class="nx">refreshItems</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Speichert das Transformationsergebnis als Datei</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">saveTransformationResult</span><span class="p">(</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Als Shadow-Twin oder als normale Datei mit angegebenem Namen speichern</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">text</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="p">,</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Einfach das Transformationsergebnis zurückgeben ohne Datei zu speichern</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Erstellt Markdown-Inhalt mit YAML-Frontmatter</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Wenn keine Metadaten vorhanden sind, gebe nur den Inhalt zurück</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">metadata</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">content</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Erstelle YAML-Frontmatter</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;---\n&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Sortiere die Metadaten für bessere Lesbarkeit</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sortedKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Gruppiere nach Kategorien</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoryOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;source_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transformation_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;audio_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;process&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;secretary_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cache_&#39;</span><span class="p">];</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">getCategoryIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">categoryOrder</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">categoryOrder</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">categoryOrder</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoryA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getCategoryIndex</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoryB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getCategoryIndex</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">categoryA</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">categoryB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">categoryA</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">categoryB</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">localeCompare</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Füge Metadaten zum Frontmatter hinzu</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">sortedKeys</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>

<span class="w">      </span><span class="c1">// Überspringe undefined-Werte</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Formatiere den Wert je nach Typ</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Escape Anführungszeichen in Strings</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">escapedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;\\&quot;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: &quot;</span><span class="si">${</span><span class="nx">escapedValue</span><span class="si">}</span><span class="sb">&quot;\n`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">\n`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Für komplexe Objekte verwende JSON (sollte nicht vorkommen)</span>
<span class="w">        </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span><span class="sb">\n`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;---\n\n&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Kombiniere Frontmatter mit Inhalt</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">content</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StorageItem</span><span class="p">,</span><span class="w"> </span><span class="nx">StorageProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@/lib/storage/types&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">transformAudio</span><span class="p">,</span><span class="w"> </span><span class="nx">transformText</span><span class="p">,</span><span class="w"> </span><span class="nx">transformVideo</span><span class="p">,</span><span class="w"> </span><span class="nx">transformPdf</span><span class="p">,</span><span class="w"> </span><span class="nx">transformImage</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryAudioResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryVideoResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryPdfResponse</span><span class="p">,</span><span class="w"> </span><span class="nx">SecretaryImageResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@/lib/secretary/client&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">,</span><span class="w"> </span><span class="nx">ImageExtractionResult</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./image-extraction-service&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">useCache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="c1">// Neu: Cache-Option für alle Transformationen</span>
<span class="w">  </span><span class="nx">includeImages?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="c1">// Neu: Bilder mit extrahieren und speichern</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">PdfTransformOptions</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">TransformResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">savedItem?</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">;</span>
<span class="w">  </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">[];</span>
<span class="w">  </span><span class="nx">imageExtractionResult?</span><span class="o">:</span><span class="w"> </span><span class="kt">ImageExtractionResult</span><span class="p">;</span><span class="w"> </span><span class="c1">// Neu: Ergebnis der Bild-Extraktion</span>
<span class="w">  </span><span class="nx">jobId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">VideoTransformOptions</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extractAudio</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">extractFrames</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">frameInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">sourceLanguage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">template?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">ImageTransformOptions</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TransformSaveOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">context?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Typ für die Metadaten, die im Frontmatter gespeichert werden</span>
<span class="cm"> */</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">TransformMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">  </span><span class="nx">source_file?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source_file_id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source_file_size?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">source_file_type?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Transformations-Informationen</span>
<span class="w">  </span><span class="nx">source_language?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">target_language?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Audio-Metadaten</span>
<span class="w">  </span><span class="nx">audio_duration?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_format?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_channels?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_sample_rate?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">audio_bit_rate?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Prozess-Informationen</span>
<span class="w">  </span><span class="nx">process_id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">processor?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">processing_duration_ms?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">model_used?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokens_used?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">  </span><span class="nx">cache_used?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">cache_key?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Weitere Felder können hinzugefügt werden</span>
<span class="w">  </span><span class="p">[</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * TransformService - Zentraler Service für Transformations- und Speicheroperationen</span>
<span class="cm"> * Verantwortlich für:</span>
<span class="cm"> * - Transformation von Audio zu Text</span>
<span class="cm"> * - Transformation von Text zu optimiertem Text</span>
<span class="cm"> * - Speichern der Ergebnisse als Shadow-Twin oder als neue Datei</span>
<span class="cm"> * - Aktualisieren der Dateiliste</span>
<span class="cm"> * - Bereitstellen einer einheitlichen Schnittstelle für alle Transformationstypen</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Generiert einen standardisierten Namen für einen Shadow-Twin</span>
<span class="cm">   * @param originalName Der ursprüngliche Dateiname</span>
<span class="cm">   * @param targetLanguage Die Zielsprache</span>
<span class="cm">   * @returns Der generierte Shadow-Twin-Name ohne Dateiendung</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">generateShadowTwinName</span><span class="p">(</span><span class="nx">originalName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Entferne alle Dateiendungen aus dem Namen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">nameWithoutExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">nameWithoutExtension</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">targetLanguage</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert eine Audio-Datei in Text</span>
<span class="cm">   * @param file Die zu transformierende Audio-Datei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Speicheroptionen</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformAudio</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Audio-Datei wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformAudio</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Falls die Response nur ein String ist (alte API)</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Neue API mit vollständigen Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">audioResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryAudioResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">audioResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Sammle relevante Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">source_language</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.transcription.source_language</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Audio-Metadaten (falls vorhanden)</span>
<span class="w">        </span><span class="nx">audio_duration</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_format</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.format</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_channels</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.channels</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_sample_rate</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.sample_rate</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_bit_rate</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.data.metadata?.bit_rate</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">audioResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Erstelle Markdown-Inhalt mit Frontmatter</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">shadowTwinName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">generateShadowTwinName</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">shadowTwinName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert eine Video-Datei</span>
<span class="cm">   * @param file Die zu transformierende Video-Datei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Optionen für Video-Transformation und Speicherung</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis inklusive Video-spezifischer Daten</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformVideo</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">VideoTransformOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] transformVideo gestartet mit Optionen:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Video-Datei wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformVideo</span><span class="p">(</span>
<span class="w">      </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">extractAudio</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractAudio</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extractFrames</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractFrames</span><span class="p">,</span>
<span class="w">        </span><span class="nx">frameInterval</span><span class="o">:</span><span class="w"> </span><span class="kt">options.frameInterval</span><span class="p">,</span>
<span class="w">        </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sourceLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.sourceLanguage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">options.template</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span>
<span class="w">      </span><span class="nx">libraryId</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Vollständige Video-Response:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Response-Check:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">responseType</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
<span class="w">      </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasTranscription</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">),</span>
<span class="w">      </span><span class="nx">transcriptionType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">transcriptionKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Transkription gefunden:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Vollständige Video-Response mit Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">videoResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryVideoResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">videoResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>

<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Extrahierter Text-Länge:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Text-Vorschau:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">));</span>

<span class="w">      </span><span class="c1">// Sammle relevante Video-Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">source_language</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.transcription.source_language</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">sourceLanguage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Video-Metadaten</span>
<span class="w">        </span><span class="nx">video_duration</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">video_duration_formatted</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.duration_formatted</span><span class="p">,</span>
<span class="w">        </span><span class="nx">video_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.file_size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">video_title</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.title</span><span class="p">,</span>
<span class="w">        </span><span class="nx">audio_file</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.data.metadata?.audio_file</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub_processors</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.sub_processors?.join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">videoResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Extrahierte Metadaten:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TransformService] Keine Transkription in der Response gefunden!&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[TransformService] Response-Struktur:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
<span class="w">        </span><span class="nx">hasTranscription</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">transcription</span><span class="p">),</span>
<span class="w">        </span><span class="nx">responseKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Finaler transformierter Text-Länge:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Erstelle Markdown-Inhalt mit Frontmatter</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Speichere Shadow-Twin mit Länge:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">markdownContent</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Keine Speicherung:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert einen Text mithilfe des Secretary Services</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformText</span><span class="p">(</span>
<span class="w">    </span><span class="nx">textContent</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Besprechung&quot;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] transformText aufgerufen mit:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">originalItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">options</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">template</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Text wird transformiert</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformText</span><span class="p">(</span>
<span class="w">      </span><span class="nx">textContent</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert eine PDF-Datei mithilfe des Secretary Services</span>
<span class="cm">   * @param file Die zu transformierende PDF-Datei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Speicheroptionen</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformPdf</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">PdfTransformOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PDF-Transformation gestartet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">options.includeImages</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IncludeImages Option&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">includeImages</span><span class="o">:</span><span class="w"> </span><span class="kt">options.includeImages</span><span class="p">,</span>
<span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// PDF-Datei wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformPdf</span><span class="p">(</span>
<span class="w">      </span><span class="nx">file</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">originalItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalFileName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Vollständige PDF-Response&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Asynchroner Flow: nur &quot;accepted&quot; → Ergebnis via Webhook, kein Client-Fehler</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">data</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">extracted_text?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">((</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">extracted_text?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">job</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="nx">process</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">is_from_cache?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job akzeptiert – Ergebnis kommt per Webhook&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">r?.job?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">r?.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fromCache</span><span class="o">:</span><span class="w"> </span><span class="kt">r?.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">r?.job?.id</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Response-Check&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">responseType</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
<span class="w">      </span><span class="nx">dataType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasExtractedText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">),</span>
<span class="w">      </span><span class="nx">extractedTextType</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Prüfe auf images_archive_data</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Images Archive Check&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasImagesArchiveData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">),</span>
<span class="w">      </span><span class="nx">hasImagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="p">),</span>
<span class="w">      </span><span class="nx">imagesArchiveDataLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">response.data.images_archive_data.length</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extracted-Text gefunden&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textPreview</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Vollständige PDF-Response mit Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">pdfResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryPdfResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pdfResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Sammle relevante PDF-Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// PDF-Metadaten</span>
<span class="w">        </span><span class="nx">page_count</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.page_count</span><span class="p">,</span>
<span class="w">        </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.format</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extraction_method</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.extraction_method</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_name</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.file_name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.data.metadata?.file_size</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub_processors</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.sub_processors?.join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">pdfResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extrahierte Metadaten&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Keine synchronen PDF-Daten erhalten&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">hasResponse</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">response</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasData</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">data</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">imageExtractionResult</span><span class="o">:</span><span class="w"> </span><span class="kt">ImageExtractionResult</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeImages</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starte Bild-Extraktion&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">imagesArchiveFilename</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.images_archive_filename</span><span class="p">,</span>
<span class="w">          </span><span class="nx">imagesArchiveDataLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.images_archive_data.length</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="nx">imageExtractionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">          </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_data</span><span class="p">,</span>
<span class="w">          </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">images_archive_filename</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;pdf_images.zip&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">          </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">          </span><span class="nx">refreshItems</span><span class="p">,</span>
<span class="w">          </span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Extrahierten Text weitergeben</span>
<span class="w">          </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span><span class="w"> </span><span class="c1">// Target Language weitergeben</span>
<span class="w">          </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="c1">// Seiten-spezifische Texte weitergeben</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bild-Extraktion abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">folderCreated</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">imageExtractionResult</span><span class="p">.</span><span class="nx">folderItem</span><span class="p">,</span>
<span class="w">          </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">imageExtractionResult.savedItems.length</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Fehler bei der Bild-Extraktion&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Bild-Extraktion ist optional, daher weitermachen</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Finaler transformierter Text&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// NEU: Detaillierte Debug-Logs für das Speicherproblem</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speicher-Bedingungen prüfen&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasTransformedText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">transformedTextLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">markdownContentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownContent.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">willSave</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speichere Shadow-Twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">markdownLength</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownContent.length</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Shadow-Twin erfolgreich gespeichert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">savedItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem?.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems.length</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span><span class="p">,</span>
<span class="w">        </span><span class="nx">imageExtractionResult</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Keine Speicherung - Bedingungen nicht erfüllt&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;createShadowTwin ist false&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transformedText ist leer&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">imageExtractionResult</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Transformiert ein Bild mithilfe des Secretary Services</span>
<span class="cm">   * @param file Die zu transformierende Bilddatei</span>
<span class="cm">   * @param originalItem Das ursprüngliche StorageItem</span>
<span class="cm">   * @param options Optionen für Bild-Transformation und Speicherung</span>
<span class="cm">   * @param provider Der Storage-Provider</span>
<span class="cm">   * @param refreshItems Callback zum Aktualisieren der Dateiliste</span>
<span class="cm">   * @param libraryId ID der aktiven Bibliothek</span>
<span class="cm">   * @returns Das Transformationsergebnis</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">transformImage</span><span class="p">(</span>
<span class="w">    </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">ImageTransformOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bild-Transformation gestartet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">extractionMethod</span><span class="o">:</span><span class="w"> </span><span class="kt">options.extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Bild wird transformiert - hole die vollständige Response</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">transformImage</span><span class="p">(</span>
<span class="w">      </span><span class="nx">file</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">extractionMethod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">.</span><span class="nx">useCache</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Vollständige Bild-Response&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Extrahiere den Text aus der Response</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extracted-Text gefunden&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textPreview</span><span class="o">:</span><span class="w"> </span><span class="kt">response.data.extracted_text.substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Vollständige Bild-Response mit Metadaten</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">SecretaryImageResponse</span><span class="p">;</span>
<span class="w">      </span><span class="nx">transformedText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imageResponse</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Sammle relevante Bild-Metadaten</span>
<span class="w">      </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Quelldatei-Informationen</span>
<span class="w">        </span><span class="nx">source_file</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_id</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">source_file_type</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.mimeType</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Transformations-Informationen</span>
<span class="w">        </span><span class="nx">target_language</span><span class="o">:</span><span class="w"> </span><span class="kt">options.targetLanguage</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Bild-Metadaten</span>
<span class="w">        </span><span class="nx">dimensions</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.dimensions</span><span class="p">,</span>
<span class="w">        </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.format</span><span class="p">,</span>
<span class="w">        </span><span class="nx">color_mode</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.color_mode</span><span class="p">,</span>
<span class="w">        </span><span class="nx">dpi</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.dpi?.join</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">extraction_method</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.extraction_method</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_name</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.file_name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">file_size</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.data.metadata?.file_size</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Prozess-Informationen</span>
<span class="w">        </span><span class="nx">process_id</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processor</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.main_processor</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sub_processors</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.sub_processors?.join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">processing_duration_ms</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.llm_info?.total_duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">model_used</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.llm_info?.requests?.</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tokens_used</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.llm_info?.total_tokens</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Secretary Service Informationen</span>
<span class="w">        </span><span class="nx">cache_used</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.is_from_cache</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cache_key</span><span class="o">:</span><span class="w"> </span><span class="kt">imageResponse.process?.cache_key</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Extrahierte Metadaten&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Entferne undefined-Werte</span>
<span class="w">      </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ow">delete</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Kein Extracted-Text in der Response gefunden!&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">responseKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nx">dataKeys</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Finaler transformierter Text&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdownContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">transformedText</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Ergebnis wird gespeichert, wenn gewünscht</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">transformedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Speichere Shadow-Twin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">markdownLength</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownContent.length</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">markdownContent</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gebe nur den Text zurück, nicht das Markdown mit Frontmatter</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Keine Speicherung&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">createShadowTwin</span><span class="o">:</span><span class="w"> </span><span class="kt">options.createShadowTwin</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hasText</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">transformedText</span><span class="p">,</span>
<span class="w">        </span><span class="nx">textLength</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText.length</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">transformedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Hilfsmethode zum Speichern der transformierten Datei</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">    </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">savedItem?</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">;</span><span class="w"> </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">[]</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] saveTwinFile aufgerufen mit:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">originalItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">fileExtension</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// NEU: Detaillierte Debug-Logs</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;saveTwinFile gestartet&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">originalItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileExtension</span><span class="o">:</span><span class="w"> </span><span class="kt">fileExtension</span><span class="p">,</span>
<span class="w">      </span><span class="nx">contentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">content.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Hole aktuelle Dateien im Verzeichnis</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">refreshItems</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Aktuelle Dateien im Verzeichnis&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">itemCount</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">existingFiles</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Funktion zum Generieren eines eindeutigen Dateinamens</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">generateUniqueFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">baseName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">extension</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">candidateName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">extension</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Prüfe ob der Name bereits existiert</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">currentItems</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">        </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">        </span><span class="nx">item</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">candidateName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="w">      </span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="nx">candidateName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">(</span><span class="si">${</span><span class="nx">counter</span><span class="si">}</span><span class="sb">).</span><span class="si">${</span><span class="nx">extension</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">candidateName</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Generiere eindeutigen Dateinamen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateUniqueFileName</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span><span class="w"> </span><span class="nx">fileExtension</span><span class="p">);</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[TransformService] Eindeutiger Dateiname generiert:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">baseNameWithLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">uniqueFileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">existingFiles</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Dateiname generiert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">baseName</span><span class="o">:</span><span class="w"> </span><span class="kt">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">uniqueFileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">existingFilesCount</span><span class="o">:</span><span class="w"> </span><span class="kt">currentItems.filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="p">).</span><span class="nx">length</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Markdown-Datei erstellen und speichern</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileBlob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">content</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text/markdown&quot;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="nx">fileBlob</span><span class="p">],</span><span class="w"> </span><span class="nx">uniqueFileName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text/markdown&quot;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Datei vorbereitet für Upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileSize</span><span class="o">:</span><span class="w"> </span><span class="kt">file.size</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileType</span><span class="o">:</span><span class="w"> </span><span class="kt">file.type</span><span class="p">,</span>
<span class="w">      </span><span class="nx">contentLength</span><span class="o">:</span><span class="w"> </span><span class="kt">content.length</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// In dasselbe Verzeichnis wie die Originaldatei hochladen</span>
<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starte Upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">originalItem.parentId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">uniqueFileName</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Upload erfolgreich&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItem.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">savedItemName</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItem.metadata.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">savedItemSize</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItem.metadata.size</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Aktualisierte Dateiliste holen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">updatedItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">refreshItems</span><span class="p">(</span><span class="nx">originalItem</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;TransformService&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Dateiliste aktualisiert&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">updatedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">updatedItems.length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">newFileFound</span><span class="o">:</span><span class="w"> </span><span class="kt">updatedItems.some</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">savedItem</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItem</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedItems</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Speichert einen bereits transformierten Text direkt ohne erneute Transformation</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">saveTransformedText</span><span class="p">(</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">saveTransformationResult</span><span class="p">(</span>
<span class="w">      </span><span class="nx">text</span><span class="p">,</span>
<span class="w">      </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">      </span><span class="nx">options</span><span class="p">,</span>
<span class="w">      </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">      </span><span class="nx">refreshItems</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Speichert das Transformationsergebnis als Datei</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">saveTransformationResult</span><span class="p">(</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">originalItem</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">,</span>
<span class="w">    </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformSaveOptions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">,</span>
<span class="w">    </span><span class="nx">refreshItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransformResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Als Shadow-Twin oder als normale Datei mit angegebenem Namen speichern</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createShadowTwin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TransformService</span><span class="p">.</span><span class="nx">saveTwinFile</span><span class="p">(</span>
<span class="w">        </span><span class="nx">text</span><span class="p">,</span>
<span class="w">        </span><span class="nx">originalItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="p">.</span><span class="nx">fileExtension</span><span class="p">,</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">        </span><span class="nx">refreshItems</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="p">,</span>
<span class="w">        </span><span class="nx">savedItem</span><span class="o">:</span><span class="w"> </span><span class="kt">result.savedItem</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">result.updatedItems</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Einfach das Transformationsergebnis zurückgeben ohne Datei zu speichern</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">text</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedItems</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Erstellt Markdown-Inhalt mit YAML-Frontmatter</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">TransformMetadata</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Wenn keine Metadaten vorhanden sind, gebe nur den Inhalt zurück</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">metadata</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">content</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Erstelle YAML-Frontmatter</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;---\n&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Sortiere die Metadaten für bessere Lesbarkeit</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sortedKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">metadata</span><span class="p">).</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Gruppiere nach Kategorien</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoryOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;source_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;transformation_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;audio_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;process&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;secretary_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cache_&#39;</span><span class="p">];</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">getCategoryIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">categoryOrder</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">categoryOrder</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">categoryOrder</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoryA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getCategoryIndex</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoryB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getCategoryIndex</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">categoryA</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">categoryB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">categoryA</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">categoryB</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">localeCompare</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Füge Metadaten zum Frontmatter hinzu</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">sortedKeys</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>

<span class="w">      </span><span class="c1">// Überspringe undefined-Werte</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Formatiere den Wert je nach Typ</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Escape Anführungszeichen in Strings</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">escapedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;\\&quot;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: &quot;</span><span class="si">${</span><span class="nx">escapedValue</span><span class="si">}</span><span class="sb">&quot;\n`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">\n`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Für komplexe Objekte verwende JSON (sollte nicht vorkommen)</span>
<span class="w">        </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span><span class="sb">\n`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;---\n\n&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Kombiniere Frontmatter mit Inhalt</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">frontmatter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">content</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StorageProvider</span><span class="p">,</span><span class="w"> </span><span class="nx">StorageItem</span><span class="p">,</span><span class="w"> </span><span class="nx">StorageValidationResult</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ClientLibrary</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OneDriveProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./onedrive-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getSupportedLibraryTypesString</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./supported-types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AuthLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">LibraryPathProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">_libraryPath?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">LocalStorageProvider</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">StorageProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">ClientLibrary</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">baseUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">ClientLibrary</span><span class="p">,</span><span class="w"> </span><span class="nx">baseUrl?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">library</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Im Server-Kontext kann baseUrl übergeben werden, sonst relative URL verwenden</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Prüft, ob der Provider authentifiziert ist.</span>
<span class="cm">   * Für das lokale Dateisystem ist dies immer true, da keine Authentifizierung erforderlich ist.</span>
<span class="cm">   * @returns Immer true für das lokale Dateisystem</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">isAuthenticated</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Setzt die Benutzer-E-Mail für Server-zu-Server API-Calls</span>
<span class="w">  </span><span class="nx">setUserEmail</span><span class="p">(</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">email</span><span class="p">;</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] User E-Mail gesetzt: </span><span class="si">${</span><span class="nx">email</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">get</span><span class="w"> </span><span class="nx">name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;Local Filesystem&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">get</span><span class="w"> </span><span class="nx">id</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">getApiUrl</span><span class="p">(</span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="si">}${</span><span class="nx">path</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// E-Mail als Parameter anhängen, wenn im Server-Kontext</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">separator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;&amp;&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">url</span><span class="si">}${</span><span class="nx">separator</span><span class="si">}</span><span class="sb">email=</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">url</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=list&amp;fileId=</span><span class="si">${</span><span class="nx">folderId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Calling API:`</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">);</span>

<span class="w">    </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;LocalStorageProvider&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starting listItemsById API call&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">hasUserEmail</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">this.userEmail</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="si">}</span><span class="sb">@...`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="kt">url.replace</span><span class="p">(</span><span class="sr">/email=[^&amp;]+/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;email=***&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] API call failed:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span>
<span class="w">          </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="p">,</span>
<span class="w">          </span><span class="nx">url</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span><span class="p">,</span>
<span class="w">          </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">this.userEmail</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Versuche, die spezifische Fehlermeldung aus der Response zu extrahieren</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`HTTP </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">errorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">errorData</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">errorCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Error code:`</span><span class="p">,</span><span class="w"> </span><span class="nx">errorData</span><span class="p">.</span><span class="nx">errorCode</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">parseError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Konnte Fehlermeldung nicht parsen:`</span><span class="p">,</span><span class="w"> </span><span class="nx">parseError</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Spezifische Behandlung für verschiedene HTTP-Status-Codes</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">404</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Bibliothek nicht gefunden. Bitte überprüfen Sie die Bibliothekskonfiguration.`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">400</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Ungültige Anfrage: </span><span class="si">${</span><span class="nx">errorMessage</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Server-Fehler beim Laden der Bibliothek. Bitte überprüfen Sie, ob der Bibliothekspfad existiert und zugänglich ist.`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Fehler beim Laden der Bibliothek: </span><span class="si">${</span><span class="nx">errorMessage</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// AuthLogger für Fehler</span>
<span class="w">        </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;LocalStorageProvider&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;API call failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.status</span><span class="p">,</span>
<span class="w">          </span><span class="nx">statusText</span><span class="o">:</span><span class="w"> </span><span class="kt">response.statusText</span><span class="p">,</span>
<span class="w">          </span><span class="nx">errorMessage</span><span class="p">,</span>
<span class="w">          </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span><span class="p">,</span>
<span class="w">          </span><span class="nx">hasUserEmail</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Successfully loaded </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> items`</span><span class="p">);</span>

<span class="w">      </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;LocalStorageProvider&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;API call successful&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">itemCount</span><span class="o">:</span><span class="w"> </span><span class="kt">data.length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[LocalStorageProvider] Exception in listItemsById:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">error.name</span><span class="p">,</span>
<span class="w">          </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack?.split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">,</span>
<span class="w">        </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">folderId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">this.userEmail</span><span class="p">,</span>
<span class="w">        </span><span class="nx">libraryPath</span><span class="o">:</span><span class="w"> </span><span class="kt">this.library.path</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">AuthLogger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;LocalStorageProvider&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Exception in listItemsById&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Re-throw den Fehler mit zusätzlichem Kontext</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Fehler beim Laden der Bibliothek &quot;</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">&quot;: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Unbekannter Fehler beim Laden der Bibliothek &quot;</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getItemById</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=get&amp;fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to get item&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">createFolder</span><span class="p">(</span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=createFolder&amp;fileId=</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">}),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to create folder&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">deleteItem</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to delete item&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">moveItem</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">newParentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;newParentId=</span><span class="si">${</span><span class="nx">newParentId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PATCH&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to move item&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">renameItem</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">newName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=rename&amp;fileId=</span><span class="si">${</span><span class="nx">itemId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PATCH&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">newName</span><span class="w"> </span><span class="p">}),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to rename item&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="o">:</span><span class="w"> </span><span class="kt">File</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Preparing upload:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parentId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">file.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileSize</span><span class="o">:</span><span class="w"> </span><span class="kt">file.size</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileType</span><span class="o">:</span><span class="w"> </span><span class="kt">file.type</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">formData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=upload&amp;fileId=</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">formData</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="w"> </span><span class="p">}));</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Failed to upload file&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">downloadFile</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Blob</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=download&amp;fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to download file&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">blob</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">blob</span><span class="o">:</span><span class="w"> </span><span class="kt">Blob</span><span class="p">;</span><span class="w"> </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=binary&amp;fileId=</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to get binary&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">blob</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">blob</span><span class="p">,</span>
<span class="w">      </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">response.headers.get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>



<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=path&amp;fileId=</span><span class="si">${</span><span class="nx">itemId</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to get path&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getPathItemsById</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">itemId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Root-Item erzeugen</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">            </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">            </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/folder&#39;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getPathById</span><span class="p">(</span><span class="nx">itemId</span><span class="p">);</span><span class="w"> </span><span class="c1">// z.B. /foo/bar/baz</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">segments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pathItems</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageItem</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">segment</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">segments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">parentId</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">folder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">children</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">segment</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">folder</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="nx">pathItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">folder</span><span class="p">);</span>
<span class="w">      </span><span class="nx">parentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">folder</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/folder&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">...</span><span class="nx">pathItems</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">validateConfiguration</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageValidationResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">isValid</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getStreamingUrl</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Für lokale Dateien verwenden wir die filesystem API-Route mit action=binary</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getApiUrl</span><span class="p">(</span><span class="sb">`/api/storage/filesystem?action=binary&amp;fileId=</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span><span class="si">}</span><span class="sb">&amp;libraryId=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getDownloadUrl</span><span class="p">(</span><span class="nx">itemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Für lokale Dateien ist die Download-URL identisch mit der Streaming-URL</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getStreamingUrl</span><span class="p">(</span><span class="nx">itemId</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">instance</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageFactory</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">libraries</span><span class="o">:</span><span class="w"> </span><span class="kt">ClientLibrary</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">StorageProvider</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">apiBaseUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">getInstance</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">StorageFactory</span><span class="p">.</span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">StorageFactory</span><span class="p">.</span><span class="nx">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="p">.</span><span class="nx">instance</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Setzt die Basis-URL für API-Anfragen, wichtig für serverseitige Aufrufe</span>
<span class="w">  </span><span class="nx">setApiBaseUrl</span><span class="p">(</span><span class="nx">baseUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">apiBaseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseUrl</span><span class="p">;</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: API-Basis-URL gesetzt auf </span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Setzt die Benutzer-E-Mail für alle Provider</span>
<span class="cm">   * Wichtig für Client-zu-Server API-Aufrufe</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">setUserEmail</span><span class="p">(</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">email</span><span class="p">;</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[StorageFactory] User E-Mail gesetzt: </span><span class="si">${</span><span class="nx">email</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Update existing providers</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">provider</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;setUserEmail&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">setUserEmail</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}).</span><span class="nx">setUserEmail</span><span class="o">?</span><span class="p">.(</span><span class="nx">email</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[StorageFactory] E-Mail an Provider </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> übertragen`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setLibraries</span><span class="p">(</span><span class="nx">libraries</span><span class="o">:</span><span class="w"> </span><span class="kt">ClientLibrary</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: setLibraries aufgerufen mit </span><span class="si">${</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> Bibliotheken`</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`StorageFactory: Warnung - Leere Bibliotheksliste übergeben!`</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Bibliotheksliste nicht leeren, wenn eine neue leere Liste übergeben wird</span>
<span class="w">      </span><span class="c1">// Dies verhindert Probleme, wenn die Komponente mit einer leeren Liste initialisiert wird</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliotheksdaten protokollieren</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Bibliotheksdaten:`</span><span class="p">,</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.label</span><span class="p">,</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.path</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;kein Pfad&#39;</span>
<span class="w">    </span><span class="p">})));</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Die Provider nur zurücksetzen, wenn sich die IDs der Bibliotheken geändert haben</span>
<span class="w">    </span><span class="c1">// Dies verhindert unnötiges Neuladen bei redundanten setLibraries-Aufrufen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentProviderIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">keys</span><span class="p">());</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newLibraryIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasChanges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentProviderIds</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">newLibraryIds</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="o">||</span>
<span class="w">                       </span><span class="nx">newLibraryIds</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">currentProviderIds</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">id</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasChanges</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Bibliotheksliste hat sich geändert, setze Provider zurück`</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Bibliotheksliste unverändert, behalte bestehende Provider`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Löscht einen bestimmten Provider aus dem Cache, um eine Neuinitialisierung zu erzwingen</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">clearProvider</span><span class="p">(</span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Lösche Provider für Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> aus dem Cache`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Zusätzliche Debugging-Informationen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">existingProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existingProvider</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Lösche Provider-Details:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">providerId</span><span class="o">:</span><span class="w"> </span><span class="kt">libraryId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">providerName</span><span class="o">:</span><span class="w"> </span><span class="kt">existingProvider.name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cachedLibraryPath</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">existingProvider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">LibraryPathProvider</span><span class="p">).</span><span class="nx">_libraryPath</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;nicht verfügbar&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">aktuelleBibliothekPath</span><span class="o">:</span><span class="w"> </span><span class="kt">library?.path</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;nicht verfügbar&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">zeitpunkt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Kein Provider im Cache für Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Provider für </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> wurde aus dem Cache entfernt`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getProvider</span><span class="p">(</span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">StorageProvider</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: getProvider aufgerufen für Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Check if provider already exists</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Verwende existierenden Provider für Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Find library</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">library</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`StorageFactory: Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> nicht gefunden!`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Verfügbare Bibliotheken:`</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">libraries</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.label</span>
<span class="w">      </span><span class="p">})));</span>

<span class="w">      </span><span class="c1">// Spezifischen Fehler werfen, den wir später abfangen können</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Bibliothek </span><span class="si">${</span><span class="nx">libraryId</span><span class="si">}</span><span class="sb"> nicht gefunden`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;LibraryNotFoundError&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="kd">interface</span><span class="w"> </span><span class="nx">LibraryNotFoundError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">        </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">typedError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">LibraryNotFoundError</span><span class="p">;</span>
<span class="w">      </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">errorCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;LIBRARY_NOT_FOUND&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">;</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">typedError</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: Erstelle neuen Provider für Bibliothek:`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">library.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">library.label</span><span class="p">,</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="kt">library.path</span><span class="p">,</span>
<span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Create provider based on library type</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">provider</span><span class="o">:</span><span class="w"> </span><span class="kt">StorageProvider</span><span class="p">;</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">LocalStorageProvider</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">apiBaseUrl</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: LocalStorageProvider erstellt für &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="nx">path</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Set user email if available</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s1">&#39;setUserEmail&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}).</span><span class="nx">setUserEmail</span><span class="o">?</span><span class="p">.(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: User-Email an LocalStorageProvider gesetzt`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OneDriveProvider</span><span class="p">(</span><span class="nx">library</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">apiBaseUrl</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: OneDriveProvider erstellt`</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Set user email if available</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s1">&#39;setUserEmail&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setUserEmail</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">}).</span><span class="nx">setUserEmail</span><span class="o">?</span><span class="p">.(</span><span class="k">this</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`StorageFactory: User-Email an OneDriveProvider gesetzt`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Add more provider types here</span>
<span class="w">      </span><span class="nx">default</span><span class="o">:</span>
<span class="w">        </span><span class="kt">console.warn</span><span class="p">(</span><span class="sb">`StorageFactory: Nicht unterstützter Bibliothekstyp &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span><span class="si">}</span><span class="sb">&quot; für Bibliothek &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="sb">`StorageFactory: Unterstützte Typen: </span><span class="si">${</span><span class="nx">getSupportedLibraryTypesString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Spezifischen Fehler werfen, den wir graceful handhaben können</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Bibliothekstyp &quot;</span><span class="si">${</span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span><span class="si">}</span><span class="sb">&quot; wird noch nicht unterstützt. Unterstützte Typen: </span><span class="si">${</span><span class="nx">getSupportedLibraryTypesString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;UnsupportedLibraryTypeError&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">interface</span><span class="w"> </span><span class="nx">UnsupportedLibraryTypeError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">          </span><span class="nx">libraryType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">typedError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">UnsupportedLibraryTypeError</span><span class="p">;</span>
<span class="w">        </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">errorCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;UNSUPPORTED_LIBRARY_TYPE&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">libraryType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="kr">type</span><span class="p">;</span>
<span class="w">        </span><span class="nx">typedError</span><span class="p">.</span><span class="nx">libraryId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">library</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">typedError</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cache provider</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">provider</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">provider</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<p>Ich habe die Build-blockierenden Linterfehler behoben und den Build erfolgreich durchlaufen lassen.</p>
<ul>
<li>In <code>src/lib/external-jobs-repository.ts</code> typsichere <code>listByUserEmail</code>-API ergänzt.</li>
<li>In <code>src/app/api/external/jobs/route.ts</code> <code>any</code> entfernt, Mappings typisiert.</li>
<li>In <code>src/app/api/external/jobs/stream/route.ts</code> AbortSignal ohne <code>any</code> genutzt.</li>
<li>In <code>src/app/api/external/jobs/[jobId]/route.ts</code> alle <code>any</code> entfernt, ungenutzte Variablen bereinigt, OneDrive-Helper typisiert; ungenutzte Pfadauflösungen auskommentiert.</li>
<li>In <code>src/lib/transform/transform-service.ts</code> Hilfsfunktion public gemacht und verbleibende <code>any</code> bei PDF-Webhook-Fall und Logging entfernt.</li>
<li>In <code>src/app/api/storage/filesystem/route.ts</code> ungenutzte Importe/Variablen bereinigt.</li>
<li>In <code>src/components/shared/job-monitor-panel.tsx</code> ungenutzte Imports entfernt, <code>any</code> typisiert und Timer typisiert.</li>
<li>In <code>src/contexts/storage-context.tsx</code>, <code>src/hooks/use-storage-provider.tsx</code>, <code>src/lib/debug/logger.ts</code>, <code>src/lib/storage/storage-factory.ts</code> <code>any</code>-Verwendungen und ungenutzte Importe korrigiert.</li>
</ul>
<p>Status: Build läuft durch; es bleiben nur React-Hook-Warnungen, die den Build nicht blockieren.</p>
<ul>
<li>Falls gewünscht, kann ich die verbleibenden Warnungen im UI-Code gezielt adressieren (Dependencies der Hooks anpassen, <code>useCallback</code>-Scopes prüfen, <code>&lt;Image /&gt;</code> einsetzen).</li>
</ul>
<p>Kurztest: Bitte einmal lokal die relevanten APIs anstoßen und den Job-Monitor öffnen, um sicherzustellen, dass SSE-Updates weiterhin korrekt erscheinen.</p>
<hr />
<p><strong>User</strong></p>
<p>Haben wir zugriff auf unser git repo? wie kann ich diesen pdf4rag Branch in den master branch mergen? Da gibt es fehlermeldungen</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich prüfe erst den Git-Status und ob der Branch <code>pdf4rag</code> lokal/remot existiert, dann hole ich alle Remotes und erkenne den korrekten Hauptbranch. Danach zeige ich dir den sicheren Merge-Ablauf und teste einen Merge ohne Commit, um Konflikte sichtbar zu machen. Jetzt lese ich die Repo-Infos.</p>
<p>Ich hole erst die Remote-Infos und identifiziere den Default-Branch, dann mergen wir den Default-Branch in <code>pdf4rag</code>, lösen Konflikte, bauen zur Verifikation und mergen anschließend zurück in den Default-Branch. Jetzt prüfe ich die Remotes und den Default-Branch.</p>
<hr />
<p><strong>User</strong></p>
<p>??</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich hole und aktualisiere zuerst <code>master</code> und teste dann einen Merge von <code>pdf4rag</code> in <code>master</code> ohne Commit, um Konflikte sichtbar zu machen. Ich breche ab, falls Konflikte entstehen, damit nichts persistiert. Jetzt führe ich die Befehle aus.</p>
<p>Ich teste den Merge von <code>pdf4rag</code> in <code>master</code> ohne Commit, um Konflikte zu erkennen, und zeige dir sofort die Konfliktdateien. Wenn Konflikte auftreten, breche ich den Merge wieder ab, damit dein Working Tree sauber bleibt.</p>
<p>Kurz: Ja, wir haben Zugriff. <code>origin</code> zeigt auf GitHub, Default-Branch ist <code>master</code>.</p>
<p>Empfohlener Weg: Konflikte zuerst auf <code>pdf4rag</code> lösen, dann sauber in <code>master</code> mergen.
1) Merge vorbereiten
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>merge<span class="w"> </span>--abort<span class="w">  </span><span class="c1"># falls gerade ein Merge offen ist</span>
git<span class="w"> </span>checkout<span class="w"> </span>pdf4rag
git<span class="w"> </span>pull<span class="w"> </span>--ff-only
git<span class="w"> </span>fetch<span class="w"> </span>origin
git<span class="w"> </span>merge<span class="w"> </span>--no-ff<span class="w"> </span>--no-commit<span class="w"> </span>origin/master
</code></pre></div>
2) Konflikte auflösen (aus deinem Merge-Log)
- Docs: die Struktur <code>docs/_history/</code> aus master behalten, alte <code>docs/history/</code> verwerfen
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>--ours<span class="w"> </span>docs/_history/cursor_25.06.17_batch_transcribing_files_in_file.md
git<span class="w"> </span>checkout<span class="w"> </span>--ours<span class="w"> </span>docs/_history/cursor_25.06.18.2_debugging_global_state_update_is.md
git<span class="w"> </span>checkout<span class="w"> </span>--ours<span class="w"> </span>docs/_history/cursor_25.06.25_eventmanager.md
git<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>docs/history/cursor_batch_transcribing_files_in_file.md<span class="w"> </span>docs/history/cursor_24.06.18.2_debugging_global_state_update_is.md<span class="w"> </span>docs/history/cursor_25..06.25_eventmanager.md
git<span class="w"> </span>add<span class="w"> </span>docs/_history
</code></pre></div>
- Code: <code>src/components/library/audio-recorder-client.tsx</code>
  - Wenn pdf4rag dort nichts Relevantes hat: master-Version behalten
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>--theirs<span class="w"> </span>src/components/library/audio-recorder-client.tsx<span class="w">  </span><span class="c1"># --theirs = master, weil wir master in pdf4rag mergen</span>
git<span class="w"> </span>add<span class="w"> </span>src/components/library/audio-recorder-client.tsx
</code></pre></div>
3) Merge abschließen und verifizieren
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Merge origin/master into pdf4rag: resolve docs renames and audio-recorder conflict&quot;</span>
pnpm<span class="w"> </span>build
</code></pre></div>
4) In master mergen
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>master
git<span class="w"> </span>pull<span class="w"> </span>--ff-only
git<span class="w"> </span>merge<span class="w"> </span>--no-ff<span class="w"> </span>pdf4rag
pnpm<span class="w"> </span>build
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>master
</code></pre></div></p>
<p>Alternative (wenn du direkt im master bleiben willst): Jetzt offene Conflicts so auflösen:
- Für die drei Doc-Dateien: <code>git checkout --ours docs/_history/...</code> und die alten <code>docs/history/...</code> entfernen.
- Für <code>audio-recorder-client.tsx</code>: <code>git checkout --ours</code> (master behalten) oder <code>--theirs</code> (pdf4rag), je nach Wunsch.
Dann:
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>-A
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Merge pdf4rag into master: resolve docs renames and audio-recorder conflict&quot;</span>
pnpm<span class="w"> </span>build
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>master
</code></pre></div></p>
<p>Hinweis: Wenn du magst, übernehme ich Option A jetzt automatisiert und pushe, sag mir nur, ob wir beim <code>audio-recorder-client.tsx</code> master oder pdf4rag bevorzugen sollen.</p>
<div class="highlight"><pre><span></span><code>git merge --abort  # falls gerade ein Merge offen ist
git checkout pdf4rag
git pull --ff-only
git fetch origin
git merge --no-ff --no-commit origin/master
</code></pre></div>
<div class="highlight"><pre><span></span><code>git checkout --ours docs/_history/cursor_25.06.17_batch_transcribing_files_in_file.md
git checkout --ours docs/_history/cursor_25.06.18.2_debugging_global_state_update_is.md
git checkout --ours docs/_history/cursor_25.06.25_eventmanager.md
git rm -f docs/history/cursor_batch_transcribing_files_in_file.md docs/history/cursor_24.06.18.2_debugging_global_state_update_is.md docs/history/cursor_25..06.25_eventmanager.md
git add docs/_history
</code></pre></div>
<div class="highlight"><pre><span></span><code>git checkout --theirs src/components/library/audio-recorder-client.tsx  # --theirs = master, weil wir master in pdf4rag mergen
git add src/components/library/audio-recorder-client.tsx
</code></pre></div>
<div class="highlight"><pre><span></span><code>git commit -m &quot;Merge origin/master into pdf4rag: resolve docs renames and audio-recorder conflict&quot;
pnpm build
</code></pre></div>
<div class="highlight"><pre><span></span><code>git checkout master
git pull --ff-only
git merge --no-ff pdf4rag
pnpm build
git push origin master
</code></pre></div>
<div class="highlight"><pre><span></span><code>git add -A
git commit -m &quot;Merge pdf4rag into master: resolve docs renames and audio-recorder conflict&quot;
pnpm build
git push origin master
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>Kannst du mir die unterschiede von audio-recorder-client.tsx master und pdf4rag erklären?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich vergleiche die Datei zwischen den Branches, um dir die konkreten Unterschiede prägnant aufzuzählen.</p>
<p>Kurzfassung der Unterschiede <code>master</code> → <code>pdf4rag</code> in <code>src/components/library/audio-recorder-client.tsx</code>:</p>
<ul>
<li>useCallback-Dependencies reduziert:</li>
<li>Entfernt <code>activeLibraryId</code> aus der Dependency-Liste des Upload-Handlings:<ul>
<li>vorher: <code>[provider, currentFolderId, activeLibraryId, generateFileName, refreshItems, onUploadComplete]</code></li>
<li>jetzt: <code>[provider, currentFolderId, generateFileName, refreshItems, onUploadComplete]</code></li>
</ul>
</li>
<li>
<p>Wirkung: verhindert unnötige Re-Creation, wenn sich nur <code>activeLibraryId</code> ändert. Prüfen, ob <code>activeLibraryId</code> wirklich nicht gebraucht wird (indirekter Einfluss auf <code>provider</code>/<code>currentFolderId</code>).</p>
</li>
<li>
<p>Fehlerbehandlung bei Recording-Start vereinfacht:</p>
</li>
<li><code>catch (error)</code> → <code>catch { ... }</code></li>
<li>
<p>Wirkung: Entfernt ungenutzte Variable (Linter-konform), keine Änderung am Verhalten.</p>
</li>
<li>
<p>Dialog-Schließen-Handler entfernt:</p>
</li>
<li>Block <code>handleDialogClose</code> wurde gelöscht.</li>
<li>Wirkung: Beim Schließen des Dialogs wird eine evtl. laufende Aufnahme nicht mehr automatisch gestoppt. Prüfen, ob das UI weiterhin einen sauberen Stop-Flow hat (z. B. Schließen verhindert oder Stop woanders getriggert). Falls nicht, könnte es zu “hängenden” MediaRecorder-Streams kommen.</li>
</ul>
<p>Empfehlung:
- Wenn <code>activeLibraryId</code> nicht im Upload-Callback verwendet wird: Änderung behalten.
- Den entfernten <code>handleDialogClose</code> prüfen: Soll Schließen die Aufnahme stoppen? Falls ja, Funktion wiederherstellen oder Schließen disabled lassen solange <code>isRecording</code> true ist.</p>
<hr />
<p><strong>User</strong></p>
<p>bitte die neuere Version beibehalten und mergen</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich löse den Merge fort: behalte die neuere pdf4rag-Version für <code>audio-recorder-client.tsx</code>, übernehme die <code>docs/_history</code>-Struktur aus <code>master</code>, committe den Merge, baue zur Verifikation und pushe nach <code>origin/master</code>. Jetzt prüfe ich die offenen Konflikte.</p>
<p>Ich setze den Merge fort: nehme für <code>audio-recorder-client.tsx</code> die Version aus <code>pdf4rag</code>, behalte die <code>docs/_history</code>-Struktur aus <code>master</code>, markiere Konflikte als gelöst und committe. Danach baue ich zur Verifikation. Jetzt führe ich die Befehle aus.</p>
<p>Erledigt: Ich habe den Merge in <code>master</code> abgeschlossen und dabei die pdf4rag-Version von <code>src/components/library/audio-recorder-client.tsx</code> übernommen. Die <code>docs/_history</code>-Struktur aus <code>master</code> habe ich beibehalten; die alten <code>docs/history</code>-Pfade wurden entfernt. Build nach Merge ist grün.</p>
<p>Nächster Schritt:
- Push nach GitHub:
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>master
</code></pre></div></p>
<p>Wenn du willst, pushe ich das jetzt direkt.</p>
<div class="highlight"><pre><span></span><code>git push origin master
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>ja bitte</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich pushe den Merge-Commit nach GitHub.</p>
<ul>
<li>Push nach <code>origin/master</code> ist durch. Branch <code>master</code> enthält jetzt die pdf4rag-Version von <code>audio-recorder-client.tsx</code> und die konsolidierte <code>docs/_history</code>-Struktur.</li>
<li>Build lokal grün. Bitte kurz im CI prüfen, ob alles ok ist.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js"></script>
      
        <script src="../../assets/javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>