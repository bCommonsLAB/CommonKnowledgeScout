
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://localhost:3000/docs/_history/08_august/cursor_2025.08.31_merge_pdf4rag_branch_into_master.html">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Merge pdf4rag branch into master - Common Knowledge Scout</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/print.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#merge-pdf4rag-branch-into-master" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Common Knowledge Scout" class="md-header__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Common Knowledge Scout
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Merge pdf4rag branch into master
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Common Knowledge Scout" class="md-nav__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Common Knowledge Scout
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/intro.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/features.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/architecture.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/core-components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core Components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/getting-started.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/settings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Settings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/library.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using the Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/event-monitor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event Monitor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/batch-session-import.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Session Import
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/troubleshooting.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/faq.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/storage-provider.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage Provider
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/localstorage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileSystem (Local)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/image-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/pdf/extraction-methods.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/metadata.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metadata
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/global-state.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Global State
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/header.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Header
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/breadcrumb.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Breadcrumb
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-tree.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileTree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-list.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FileList
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/upload.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Upload
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/file-preview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FilePreview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/transform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/batch-transcription.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Transcription
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/error-handling-logging-testing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Error Handling & Tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/initialization-sequence.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Initialization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/library/components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Library Components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/shadowtwins.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/extended-shadowtwin.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extended Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/features/transformation-service.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformation Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/video-transformation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Video Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/glossary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/secretary-services.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Secretary Services
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api/track-processor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Track Processor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chat-response-generation-process.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat & Story Mode
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/deployment/docker.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker Deployment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/quick-setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Quick Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ops/desktop/package-strategy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electron Package Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="merge-pdf4rag-branch-into-master">Merge pdf4rag branch into master<a class="headerlink" href="#merge-pdf4rag-branch-into-master" title="Permanent link">&para;</a></h1>
<p><em>Exported on 10/9/2025 at 14:57:19 GMT+2 from Cursor (1.7.38)</em></p>
<hr />
<p><strong>User</strong></p>
<p>Ich möchte den github pdf4rag-branch in den Master-Branch mergen. Ein Pull-Request-Start. Es wird einige Merge-Konflikte geben. Können wir das analysieren, gemeinsam?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich hole zuerst die neuesten Änderungen und prüfe den Zustand beider Branches. Danach versuche ich einen konfliktfreien Test-Merge von <code>master</code> in <code>pdf4rag</code> (ohne Commit), um die Konfliktliste zu extrahieren, und breche ihn anschließend wieder ab.</p>
<p>Ich starte mit einer kleinen Aufgabenliste und beginne mit dem Test-Merge, um die Konflikte exakt zu identifizieren.</p>
<p>Ich wechsle korrekt auf <code>master</code>, ziehe <code>origin/master</code>, aktualisiere <code>pdf4rag</code>, führe einen No-Commit-Merge von <code>pdf4rag</code> in <code>master</code> aus, liste Konflikte und breche den Merge wieder ab.</p>
<hr />
<p><strong>User</strong></p>
<p>ok, wie gehts weiter?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich wechsle auf <code>pdf4rag</code>, aktualisiere ihn und führe einen Test-Merge von <code>master</code> in <code>pdf4rag</code> aus, um Konflikte zu ermitteln; danach liste ich die Konfliktdateien und breche den Merge wieder ab.</p>
<p>Ich habe den Merge von <code>master</code> in <code>pdf4rag</code> testweise durchgeführt; es gab keine Konflikte. Ich prüfe jetzt Build/Lint/Tests im gemergten Zustand und werde anschließend den Merge committen und pushen.</p>
<p>Ich prüfe die verfügbaren Skripte, um den Build gezielt auf Root auszuführen und das fehlerhafte rekursive Bauen des <code>dist</code>-Ordners zu vermeiden. Danach starte ich den Build nur für das Root-Paket.</p>
<p>Ich starte jetzt Build, Lint und Tests im Root-Paket (ohne rekursiv in <code>dist/</code> zu bauen).</p>
<p>Ich committe den Merge-Zustand auf <code>pdf4rag</code>, pushe den Branch und versuche anschließend, einen PR via GitHub-CLI zu eröffnen.</p>
<p>Ich prüfe die gestagten Dateien und ob die GitHub-CLI verfügbar ist. Anschließend bereinige ich ggf. die fehlerhafte Datei, committe den Merge und pushe.</p>
<p>Ich bereinige die eine seltsame, versehentlich hinzugefügte Datei, committe den Merge-Stand und pushe nach origin. Danach prüfe ich, ob ich einen PR via GitHub-CLI eröffnen kann.</p>
<p>Ich entferne die versehentlich gestagte Datei mit dem merkwürdigen Namen aus dem Index und Arbeitsbaum, committe den Merge und pushe nach origin. Danach prüfe ich, ob die GitHub-CLI vorhanden ist, um direkt einen PR zu erstellen.</p>
<p>Ich entferne die fehlerhafte, gestagte Datei automatisiert, committe den Merge-Stand und pushe auf <code>origin/pdf4rag</code>. Danach prüfe ich die Verfügbarkeit der GitHub-CLI und erstelle den PR.</p>
<p>Ich prüfe, ob wir noch im Merge-Zustand sind und breche ihn gegebenenfalls ab, um einen sauberen Auto-Merge von <code>master</code> in <code>pdf4rag</code> zu machen und danach zu committen/pushen. Anschließend checke ich die GitHub-CLI.</p>
<p>Ich beende den Merge mit einem Commit und pushe <code>pdf4rag</code> zum Remote, danach versuche ich den PR zu erstellen.</p>
<hr />
<p><strong>User</strong></p>
<p>ok, habe jetzt pdf4rag committet und auf git gemerged und btanch gelöscht.  Irgendwie hat er da den Master in den PDF4Rec gemerged. Kann man das noch nachvollziehen? Auf alle Fälle habe ich diesen PDF4Rec Branch dann gelöscht. Ist der Master jetzt wirklich aktuell?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich verifiziere jetzt den Zustand: ziehe <code>origin/master</code>, prüfe Merge-Historie und ob typische <code>pdf4rag</code>-Dateien auf <code>master</code> vorhanden sind.</p>
<p>Ich prüfe jetzt den Zustand von master: ich fetche, checke master aus, ziehe, prüfe die Historie und verifiziere, ob Commit a8fc1a4 in master enthalten ist. Danach baue ich, lintere und teste auf master.</p>
<p>Ich prüfe jetzt konkret, ob der Merge-Commit aus pdf4rag in master enthalten ist und führe danach Build/Lint/Tests auf master aus.</p>
<p>Kurzupdate: Ich habe verifiziert, dass der Merge aus pdf4rag in master enthalten ist und master baut, lintet und testet sauber.</p>
<p>Antworten auf deine Fragen:
- Ist nachvollziehbar, was passiert ist? Ja. In der Historie sieht man:
<div class="highlight"><pre><span></span><code>* 0cf2872 (HEAD -&gt; master, tag: v1.0.28, origin/master) Bump version to 1.0.28
*   64434b0 Merge pull request #5 from bCommonsLAB/pdf4rag
| *   a8fc1a4 (pdf4rag) Merge master into pdf4rag (pre-PR sync)
</code></pre></div>
Der PR #5 hat <code>pdf4rag</code> in <code>master</code> gemerged. Davor wurde <code>master</code> in <code>pdf4rag</code> synchronisiert (Commit a8fc1a4). Das erklärt, warum es konfliktfrei war.</p>
<ul>
<li>Ist master aktuell? Ja.</li>
<li><code>master</code> enthält den <code>pdf4rag</code>-Merge (PR-Commit 64434b0, Vorläufer a8fc1a4).</li>
<li>Build: ok, Lint: nur Warnungen, Tests: alle grün.</li>
<li>Tags: <code>v1.0.28</code> ist auf dem aktuellen Head.</li>
</ul>
<p>Empfehlung:
- Falls gewünscht, den gelöschten Remote-Branch <code>origin/pdf4rag</code> ist bereits entfernt. Lokale Aufräumung ist erledigt.
- Optional: Lint-Warnungen in den betroffenen Komponenten später angehen, ist aber kein Blocker.</p>
<p>Wenn du willst, kann ich noch:
- Release-Notes für <code>v1.0.28</code> kurz zusammenstellen.
- Einen Hotfix-Branch für die Hook-Dependency-Warnungen vorbereiten.</p>
<div class="highlight"><pre><span></span><code>* 0cf2872 (HEAD -&gt; master, tag: v1.0.28, origin/master) Bump version to 1.0.28
*   64434b0 Merge pull request #5 from bCommonsLAB/pdf4rag
| *   a8fc1a4 (pdf4rag) Merge master into pdf4rag (pre-PR sync)
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>ich möchte noch den chatbot branch in master mergen. wie gehen wir vor?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich prüfe jetzt, ob es einen Branch <code>chatbot</code> gibt, wechsle darauf und synchronisiere ihn. Danach mache ich einen Test-Merge von <code>master</code> in <code>chatbot</code>, um Konflikte zu erkennen.</p>
<p>Ich führe einen Test-Merge von master in chatbot aus, um Konflikte zu erkennen. Danach baue/linte/teste, committe den Sync und pushe, und erstelle anschließend einen PR von chatbot nach master.</p>
<p>Ich starte jetzt Build, Lint und Tests auf dem gemergten chatbot-Stand, committe anschließend den Merge und pushe. Danach versuche ich, einen PR via GitHub-CLI zu erstellen.</p>
<p>Ich öffne die betroffenen Dateien parallel, um die Lint-Fehler gezielt zu beheben. Danach führe ich Build/Lint erneut aus.</p>
<p>Ich behebe jetzt die Lint-Fehler in den genannten Dateien und führe danach Build/Lint erneut aus.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span>

<span class="c1">// Einfache Heuristik-basierte Kapitelanalyse auf Markdown-Basis.</span>
<span class="c1">// Ziel: Stabiler, deterministischer Output ohne externe Python-Abhängigkeiten.</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">ChapterOut</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">chapterId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">startOffset</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">endOffset</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">startPage?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">endPage?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">evidence</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">summary?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">keywords?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">bodySchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">  </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">  </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="kt">z.enum</span><span class="p">([</span><span class="s1">&#39;heuristic&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;llm&#39;</span><span class="p">]).</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;heuristic&#39;</span><span class="p">)</span>
<span class="p">})</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">hashStable</span><span class="p">(</span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2166136261</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// FNV-1a</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">h</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
<span class="w">    </span><span class="nx">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">imul</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span><span class="w"> </span><span class="mf">16777619</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="sb">`h</span><span class="si">${</span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mf">36</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">analyzeHeuristic</span><span class="p">(</span><span class="nx">markdown</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chapters</span><span class="o">:</span><span class="w"> </span><span class="kt">ChapterOut</span><span class="p">[];</span><span class="w"> </span><span class="nx">toc</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chapters</span><span class="o">:</span><span class="w"> </span><span class="kt">ChapterOut</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">toc</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">  </span><span class="c1">// Page-Anker: &lt;!--page:12--&gt; oder Zeilen wie &quot;— Seite 3 —&quot;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">idx</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/(&lt;!--\s*page\s*:\s*(\d+)\s*--&gt;)|^\s*[\u2013\u2014\-\u2212\s]*Seite\s+(\d{1,4})\s*[\u2013\u2014\-\u2212\s]*$/gim</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">RegExpExecArray</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">markdown</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="mf">3</span><span class="p">])</span>
<span class="w">      </span><span class="nx">pageAnchors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">idx</span><span class="o">:</span><span class="w"> </span><span class="kt">m.index</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">pageNo</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Heading-Kandidaten</span>
<span class="w">  </span><span class="kr">type</span><span class="w"> </span><span class="nx">Cand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">idx</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">evidence</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cands</span><span class="o">:</span><span class="w"> </span><span class="kt">Cand</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">markdown</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">)</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Markdown-Heading #, ##, ###</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^(#{1,6})\s+(.+?)\s*$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m1</span><span class="p">[</span><span class="mf">1</span><span class="p">].</span><span class="nx">length</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m1</span><span class="p">[</span><span class="mf">2</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>
<span class="w">      </span><span class="nx">cands</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">level</span><span class="p">,</span><span class="w"> </span><span class="nx">title</span><span class="p">,</span><span class="w"> </span><span class="nx">idx</span><span class="o">:</span><span class="w"> </span><span class="kt">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">evidence</span><span class="o">:</span><span class="w"> </span><span class="kt">line.trim</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">160</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Nummerierte Gliederung am Zeilenanfang (z. B. 1. oder 1.2.3)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^(?:\d+[.)])(?:\s+\d+[.)])*\s+(.+?)\s*$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m2</span><span class="p">[</span><span class="mf">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">title</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">prefix</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\d+[.)]/g</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[]).</span><span class="nx">length</span><span class="p">))</span>
<span class="w">        </span><span class="nx">cands</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">level</span><span class="p">,</span><span class="w"> </span><span class="nx">title</span><span class="p">,</span><span class="w"> </span><span class="nx">idx</span><span class="o">:</span><span class="w"> </span><span class="kt">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">evidence</span><span class="o">:</span><span class="w"> </span><span class="kt">line.trim</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">160</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="c1">// +1 für Newline</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// TOC-Heuristik: Abschnitt nach Überschrift &quot;Inhalt|Inhaltsverzeichnis|Contents&quot;</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tocHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/(#{1,6})\s*(inhalt|inhaltsverzeichnis|contents)\b/i</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">markdown</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">tocHeader</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">markdown</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;\n\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">markdown</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;\n\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">markdown</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4000</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">markdown</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">region</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">)</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">ln</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ln</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
<span class="w">        </span><span class="c1">// Unterstütze Dot-Leaders, Unicode-Ellipsis … (\u2026) und größere Lücken</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^(.*?)(?:\.{2,}|\u2026+|\s{3,})\s*(\d{1,4})\s*$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">toc</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">m</span><span class="p">[</span><span class="mf">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">(),</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">Number</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"> </span><span class="p">})</span>
<span class="w">          </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Nummerierte TOC-Einträge (z. B. 2.1 Titel … 12)</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^(\d+(?:\.\d+)*)\s+(.+?)\s*(\d{1,4})$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">lvl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="nx">m2</span><span class="p">[</span><span class="mf">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">))</span>
<span class="w">          </span><span class="nx">toc</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">m2</span><span class="p">[</span><span class="mf">2</span><span class="p">].</span><span class="nx">trim</span><span class="p">(),</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">lvl</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">Number</span><span class="p">(</span><span class="nx">m2</span><span class="p">[</span><span class="mf">3</span><span class="p">])</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Kapitel bilden (Level bis 3)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cands</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">level</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span>
<span class="w">  </span><span class="nx">filtered</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">idx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">idx</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">docLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">markdown</span><span class="p">.</span><span class="nx">length</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">filtered</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filtered</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">filtered</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">filtered</span><span class="p">[</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="nx">.idx</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">docLen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">p</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pageAnchors</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">idx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">cur</span><span class="p">.</span><span class="nx">idx</span><span class="p">)</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">page</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">break</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span>
<span class="w">    </span><span class="p">})()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">endPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">p</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pageAnchors</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">nextIdx</span><span class="p">)</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">page</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">break</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span>
<span class="w">    </span><span class="p">})()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hashStable</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">cur</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="si">}</span><span class="sb">|</span><span class="si">${</span><span class="nx">cur</span><span class="p">.</span><span class="nx">idx</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">chapterId</span><span class="o">:</span><span class="w"> </span><span class="kt">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">cur.title</span><span class="p">,</span>
<span class="w">      </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">cur.level</span><span class="p">,</span>
<span class="w">      </span><span class="nx">startOffset</span><span class="o">:</span><span class="w"> </span><span class="kt">cur.idx</span><span class="p">,</span>
<span class="w">      </span><span class="nx">endOffset</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.max</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">idx</span><span class="p">,</span><span class="w"> </span><span class="nx">nextIdx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span>
<span class="w">      </span><span class="nx">startPage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">endPage</span><span class="p">,</span>
<span class="w">      </span><span class="nx">evidence</span><span class="o">:</span><span class="w"> </span><span class="kt">cur.evidence</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Fallback: Seiten via TOC mappen, falls kein Seitenanker oder fehlend</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">toc</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">norm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span>
<span class="w">      </span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="w">      </span><span class="c1">// führende Nummerierung entfernen: &quot;2.1.3 &quot;, &quot;2) &quot;, &quot;2- &quot;</span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s*(?:\d+(?:\.\d+)*)(?:\s+|\s*[-.)])\s*/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="c1">// typografische Striche/Anführungen normalisieren</span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\u2013\u2014\u2212]/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&quot;&#39;„”“‚’]/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tocNorm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">toc</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="o">:</span><span class="w"> </span><span class="kt">norm</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span><span class="w"> </span><span class="p">}))</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">ch</span><span class="p">.</span><span class="nx">startPage</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">norm</span><span class="p">(</span><span class="nx">ch</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span>
<span class="w">      </span><span class="c1">// bestes Match: startsWith in beide Richtungen, sonst includes</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tocNorm</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">n</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">nc</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">nc</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">n</span><span class="p">))</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hit</span><span class="p">)</span><span class="w"> </span><span class="nx">hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tocNorm</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">n</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">nc</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">nc</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">n</span><span class="p">))</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hit</span><span class="o">?</span><span class="p">.</span><span class="nx">page</span><span class="p">)</span><span class="w"> </span><span class="nx">ch</span><span class="p">.</span><span class="nx">startPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hit</span><span class="p">.</span><span class="nx">page</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">startPage</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">endPage</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">nextStart</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">endPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">nextStart</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">startPage</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">nextStart</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chapters</span><span class="p">,</span><span class="w"> </span><span class="nx">toc</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}))</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bodySchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Ungültige Eingabe&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">parsed.error.flatten</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fileId</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">,</span><span class="w"> </span><span class="nx">mode</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsed</span><span class="p">.</span><span class="nx">data</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;heuristic&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chapters</span><span class="p">,</span><span class="w"> </span><span class="nx">toc</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">analyzeHeuristic</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">,</span><span class="w"> </span><span class="nx">mode</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chapters</span><span class="p">,</span><span class="w"> </span><span class="nx">toc</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chapterCount</span><span class="o">:</span><span class="w"> </span><span class="kt">chapters.length</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// LLM-basierte Analyse (extraktiv, streng JSON)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENAI_API_KEY</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OPENAI_API_KEY fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENAI_CHAT_MODEL_NAME</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;gpt-4.1&#39;</span>

<span class="w">    </span><span class="c1">// Seitenanker vorher extrahieren, um spaeter Seiten zuzuordnen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">idx</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/(?:&lt;!--\s*page\s*:\s*(\d+)\s*--&gt;)|^(?:[\-\\s]*?[\u2013\u2014\-\u2212]?\s*Seite\s+(\d{1,4})\s*[\u2013\u2014\-\u2212]?)$/gim</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">RegExpExecArray</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">content</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span>
<span class="w">        </span><span class="nx">pageAnchors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">idx</span><span class="o">:</span><span class="w"> </span><span class="kt">m.index</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">pageNo</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">pageAnchors</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">idx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">idx</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//const charBudget = 120_000</span>
<span class="w">    </span><span class="c1">//const text = content.length &gt; charBudget ? content.slice(0, charBudget) : content</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">content</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">system</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Du extrahierst Kapitel aus gegebenem Volltext. Du bist strikt EXTRAKTIV und erfindest nichts.&#39;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userPrompt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Aufgabe: Erkenne Kapitel- und Unterkapitelstarts (Level 1..3) im folgenden OCR/Markdown-Text UND liefere pro erkanntem Kapitel eine kompakte, EXTRAKTIVE Summary.</span>
<span class="sb">Antworte ausschließlich als kompaktes JSON ohne Kommentare.</span>

<span class="sb">Anforderungen:</span>
<span class="sb">- Gib nur Kapitel/Unterkapitel zurück, die EXAKT im Text vorkommen.</span>
<span class="sb">- Für jedes Kapitel liefere:</span>
<span class="sb">  - title (string)</span>
<span class="sb">  - level (1..3)</span>
<span class="sb">  - startEvidence (&lt;=160 Zeichen, genau wie im Text am Kapitelstart vorkommend)</span>
<span class="sb">  - summary (max 1000 Zeichen, extraktiv: nur Inhalte aus dem Bereich zwischen diesem Kapitelstart und dem nächsten Kapitelstart; wenn unklar, leere Zeichenkette)</span>
<span class="sb">  - keywords (5-12 kurze Stichwörter, optional)</span>
<span class="sb">- Optional: toc (Liste von { title, page?, level? }) falls erkennbar. TOC-Titel dürfen nur Kapitel referenzieren, die im Text vorkommen.</span>
<span class="sb">- KEIN weiterer Text in der Antwort, nur JSON.</span>

<span class="sb">Beispiel-Response:</span>
<span class="sb">{&quot;chapters&quot;:[{&quot;title&quot;:&quot;Einleitung&quot;,&quot;level&quot;:1,&quot;startEvidence&quot;:&quot;1 EINLEITUNG und AUFGABENSTELLUNG&quot;,&quot;summary&quot;:&quot;…&quot;,&quot;keywords&quot;:[&quot;Ziel&quot;,&quot;Gebiet&quot;,&quot;Methode&quot;]}],&quot;toc&quot;:[{&quot;title&quot;:&quot;Einleitung&quot;,&quot;page&quot;:3,&quot;level&quot;:1}]}</span>

<span class="sb">Text (ggf. gekürzt):\n\n</span><span class="si">${</span><span class="nx">text</span><span class="si">}</span><span class="sb">`</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.openai.com/v1/chat/completions&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;system&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">system</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">userPrompt</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="sb">`OpenAI Chat Fehler: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">err</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">300</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">502</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">outUnknown</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">outUnknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OpenAI Chat Parse Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">raw.slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">502</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">contentJson</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">outUnknown</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">outUnknown</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">maybe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">outUnknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">choices?</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">message</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">content?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">maybe</span><span class="p">.</span><span class="nx">choices</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="o">?</span><span class="p">.</span><span class="nx">content</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">contentJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">contentJson</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;LLM JSON ungültig&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">((</span><span class="nx">contentJson</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">502</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">parsedJsonUnknown</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">parsedJsonUnknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">contentJson</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;LLM JSON ungültig&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">contentJson</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">502</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">parsedJsonUnknown</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">parsedJsonUnknown</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">parsedJsonUnknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">chaptersRaw</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">title?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">level?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">startEvidence?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">summary?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">keywords?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">root</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chapters?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">chapters</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">root</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chapters?</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">title?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">level?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">startEvidence?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">summary?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">keywords?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}).</span><span class="nx">chapters</span><span class="o">!</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tocRaw</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">title?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">level?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">((</span><span class="nx">root</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">toc?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">toc</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">root</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">toc?</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">title?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">page?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">level?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}).</span><span class="nx">toc</span><span class="o">!</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">chapters</span><span class="o">:</span><span class="w"> </span><span class="kt">ChapterOut</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">findPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">idx</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">p</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pageAnchors</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">idx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">idx</span><span class="p">)</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">page</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">break</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Verifikation: evidence muss im Text vorkommen</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">chaptersRaw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">c</span><span class="o">?</span><span class="p">.</span><span class="nx">title</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">c</span><span class="o">?</span><span class="p">.</span><span class="nx">startEvidence</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">level</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">level</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">startEvidence</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">160</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">content</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span>
<span class="w">      </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">chapterId</span><span class="o">:</span><span class="w"> </span><span class="kt">hashStable</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="si">}</span><span class="sb">|</span><span class="si">${</span><span class="nx">idx</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">c.title.trim</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">level</span><span class="p">,</span>
<span class="w">        </span><span class="nx">startOffset</span><span class="o">:</span><span class="w"> </span><span class="kt">idx</span><span class="p">,</span>
<span class="w">        </span><span class="nx">endOffset</span><span class="o">:</span><span class="w"> </span><span class="kt">idx</span><span class="p">,</span><span class="w"> </span><span class="c1">// vorerst; unten korrigieren</span>
<span class="w">        </span><span class="nx">startPage</span><span class="o">:</span><span class="w"> </span><span class="kt">findPage</span><span class="p">(</span><span class="nx">idx</span><span class="p">),</span>
<span class="w">        </span><span class="nx">evidence</span><span class="o">:</span><span class="w"> </span><span class="kt">ev</span><span class="p">,</span>
<span class="w">        </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">summary</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">summary</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">keywords</span><span class="o">:</span><span class="w"> </span><span class="kt">Array.isArray</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">keywords</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">keywords</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">k</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">12</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">startOffset</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">startOffset</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="nx">.startOffset</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">content.length</span>
<span class="w">      </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">endOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">startOffset</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">endPageIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">endOffset</span>
<span class="w">      </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">endPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(()</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">p</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pageAnchors</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">idx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">endPageIdx</span><span class="p">)</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageAnchors</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">page</span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">p</span>
<span class="w">      </span><span class="p">})()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">toc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tocRaw</span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">t</span><span class="o">?</span><span class="p">.</span><span class="nx">title</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">title</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">).</span><span class="nx">trim</span><span class="p">(),</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">t.page</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">level</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">level</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}))</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">,</span><span class="w"> </span><span class="nx">fileId</span><span class="p">,</span><span class="w"> </span><span class="nx">mode</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chapters</span><span class="p">,</span><span class="w"> </span><span class="nx">toc</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">chapterCount</span><span class="o">:</span><span class="w"> </span><span class="kt">chapters.length</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Interner Fehler&#39;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">message</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">fetchVectors</span><span class="p">,</span><span class="w"> </span><span class="nx">queryVectors</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/pinecone&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">loadLibraryChatContext</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/loader&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getVectorIndexForLibrary</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/config&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_API_KEY</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PINECONE_API_KEY fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;fileId&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">docModifiedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;docModifiedAt&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">noFallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;noFallback&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;1&#39;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">fileId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;fileId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">loadLibraryChatContext</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bibliothek nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">vectorIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">idx</span><span class="o">?</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;not_indexed&#39;</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="c1">// Hole Meta-Vektor (doc)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-meta`</span><span class="p">]</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">lookupMethod</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;other-index&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;filter&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;none&#39;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">foundId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fetched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchVectors</span><span class="p">(</span><span class="nx">idx</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fetched</span><span class="p">[</span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-meta`</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">meta</span><span class="p">)</span><span class="w"> </span><span class="nx">lookupMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;id&#39;</span>

<span class="w">    </span><span class="c1">// Fallback: Durchsuche andere Library-Indizes des Nutzers (falls Upsert in anderer Library passiert ist)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">meta</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">noFallback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">libService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">()</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">libs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">)</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">libs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">altIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getVectorIndexForLibrary</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.label</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="o">?</span><span class="p">.</span><span class="nx">chat</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">altIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">vectorIndex</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">alt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">(</span><span class="nx">altIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">alt</span><span class="o">?</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">fx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchVectors</span><span class="p">(</span><span class="nx">alt</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fx</span><span class="p">[</span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-meta`</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m</span><span class="p">;</span><span class="w"> </span><span class="nx">lookupMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;other-index&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">foundId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-meta`</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ignore */</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Zweiter Fallback: gefilterte Query nach fileId/kind=&#39;doc&#39; (falls ID-Bildung abweicht)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">meta</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">noFallback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="kt">number</span><span class="o">&gt;</span><span class="p">(</span><span class="mf">3072</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">byFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">queryVectors</span><span class="p">(</span><span class="nx">idx</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">zero</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">libraryId</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">fileId</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;doc&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="nx">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">byFilter</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">        </span><span class="nx">foundId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">byFilter</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">meta</span><span class="p">)</span><span class="w"> </span><span class="nx">lookupMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;filter&#39;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ignore */</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">meta</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;not_indexed&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">upsertedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">meta</span><span class="o">?</span><span class="p">.</span><span class="nx">upsertedAt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">meta.upsertedAt</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunkCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">meta</span><span class="o">?</span><span class="p">.</span><span class="nx">chunkCount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">meta.chunkCount</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">meta</span><span class="o">?</span><span class="p">.</span><span class="nx">fileName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">meta.fileName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">storedDocMod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">meta</span><span class="o">?</span><span class="p">.</span><span class="nx">docModifiedAt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">meta.docModifiedAt</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">isStale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">docModifiedAt</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">storedDocMod</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">storedDocMod</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">docModifiedAt</span><span class="p">).</span><span class="nx">getTime</span><span class="p">())</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">isStale</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;stale&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">chunkCount</span><span class="p">,</span>
<span class="w">      </span><span class="nx">upsertedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">docModifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">storedDocMod</span><span class="p">,</span>
<span class="w">      </span><span class="nx">docMeta</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">meta</span><span class="o">?</span><span class="p">.</span><span class="nx">docMetaJson</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">docMetaJson</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">toc</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">meta</span><span class="o">?</span><span class="p">.</span><span class="nx">tocJson</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">tocJson</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">_debug</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">lookupMethod</span><span class="p">,</span><span class="w"> </span><span class="nx">expectedId</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-meta`</span><span class="p">,</span><span class="w"> </span><span class="nx">foundId</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Interner Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">loadLibraryChatContext</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/loader&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">embedTexts</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/embeddings&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">queryVectors</span><span class="p">,</span><span class="w"> </span><span class="nx">fetchVectors</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/pinecone&#39;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">chatRequestSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">4000</span><span class="p">),</span>
<span class="w">  </span><span class="nx">answerLength</span><span class="o">:</span><span class="w"> </span><span class="kt">z.enum</span><span class="p">([</span><span class="s1">&#39;kurz&#39;</span><span class="p">,</span><span class="s1">&#39;mittel&#39;</span><span class="p">,</span><span class="s1">&#39;ausführlich&#39;</span><span class="p">]).</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;mittel&#39;</span><span class="p">)</span>
<span class="p">})</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span>

<span class="w">    </span><span class="c1">// Auth prüfen oder public zulassen (abhängig von Config)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span>

<span class="w">    </span><span class="c1">// Fallback: erlauben wir public nur, wenn Chat public konfiguriert ist</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailForLoad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-User-Email&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">emailForLoad</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Wir laden trotzdem, um public-Flag zu prüfen</span>
<span class="w">      </span><span class="c1">// Wenn kein userEmail vorliegt und Chat nicht public ist → 401</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">loadLibraryChatContext</span><span class="p">(</span><span class="nx">emailForLoad</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bibliothek nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="k">public</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Body validieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}))</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chatRequestSchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Ungültige Anfrage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error.flatten</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">answerLength</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span>

<span class="w">    </span><span class="c1">// Embedding der Nutzerfrage</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">qVec</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">embedTexts</span><span class="p">([</span><span class="nx">message</span><span class="p">])</span>

<span class="w">    </span><span class="c1">// Pinecone Query</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_API_KEY</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PINECONE_API_KEY fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">vectorIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">idx</span><span class="o">?</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Index nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseTopK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20</span>
<span class="w">    </span><span class="c1">// Retriever standardmäßig auf Kapitel-Summaries umstellen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">queryVectors</span><span class="p">(</span><span class="nx">idx</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">qVec</span><span class="p">,</span><span class="w"> </span><span class="nx">baseTopK</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">libraryId</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chapterSummary&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">scoreMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">number</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">matches</span><span class="p">)</span><span class="w"> </span><span class="nx">scoreMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">m.score</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Nachbarn sammeln (±w)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">windowByLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">answerLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ausführlich&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">3</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">answerLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;mittel&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">1</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">idSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parseId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">id</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">base</span><span class="o">:</span><span class="w"> </span><span class="kt">id</span><span class="p">,</span><span class="w"> </span><span class="nx">chunk</span><span class="o">:</span><span class="w"> </span><span class="kt">NaN</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">base</span><span class="o">:</span><span class="w"> </span><span class="kt">id.slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">idx</span><span class="p">),</span><span class="w"> </span><span class="nx">chunk</span><span class="o">:</span><span class="w"> </span><span class="kt">Number</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">toId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">base</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">chunk</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">chunk</span><span class="si">}</span><span class="sb">`</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">matches</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">base</span><span class="p">,</span><span class="w"> </span><span class="nx">chunk</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parseId</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nb">Number</span><span class="p">.</span><span class="nb">isFinite</span><span class="p">(</span><span class="nx">chunk</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">idSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">windowByLength</span><span class="p">;</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">windowByLength</span><span class="p">;</span><span class="w"> </span><span class="nx">d</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">idSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">toId</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span><span class="w"> </span><span class="nx">chunk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">d</span><span class="p">))</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">idSet</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fetched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchVectors</span><span class="p">(</span><span class="nx">idx</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">ids</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">vectorRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ids</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">scoreMap.get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="kt">fetched</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="p">}))</span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">meta</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">score</span><span class="p">))</span>

<span class="w">    </span><span class="c1">// Budget nach answerLength</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseBudget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">answerLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ausführlich&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">180000</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">answerLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;mittel&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">90000</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">30000</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">charBudget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseBudget</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">sources</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">score?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">fileName?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">chunkIndex?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">text?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">used</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">vectorRows</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">meta</span><span class="o">!</span><span class="p">.</span><span class="nx">text</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">meta</span><span class="o">!</span><span class="p">.</span><span class="nx">text</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">meta</span><span class="o">!</span><span class="p">.</span><span class="nx">fileName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">meta</span><span class="o">!</span><span class="p">.</span><span class="nx">fileName</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunkIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">meta</span><span class="o">!</span><span class="p">.</span><span class="nx">chunkIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">meta</span><span class="o">!</span><span class="p">.</span><span class="nx">chunkIndex</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">score</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">used</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">charBudget</span><span class="p">)</span><span class="w"> </span><span class="k">break</span>
<span class="w">      </span><span class="nx">sources</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">r.id</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="p">,</span><span class="w"> </span><span class="nx">chunkIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">t</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="nx">used</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">length</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Fallback: Wenn keine Quellen aus fetchVectors, versuche Matches-Metadaten zu verwenden</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sources</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">fallback</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">matches</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">text</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">text</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">fileName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">fileName</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunkIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">chunkIndex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">chunkIndex</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">score</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">snippet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">snippet</span><span class="p">.</span><span class="nx">length</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">acc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">charBudget</span><span class="p">)</span><span class="w"> </span><span class="k">break</span>
<span class="w">        </span><span class="nx">fallback</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="p">,</span><span class="w"> </span><span class="nx">chunkIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">snippet</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="nx">acc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">len</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fallback</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fallback</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Als letzte Option: Nur Treffer zurückgeben (z. B. bei sehr alten Daten ohne Text)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">          </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">vectorIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">ctx.vectorIndex</span><span class="p">,</span>
<span class="w">          </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">matches</span><span class="p">,</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Kontext bauen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buildContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">srcs</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">sources</span><span class="p">,</span><span class="w"> </span><span class="nx">perSnippetLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">800</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">srcs</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`Quelle [</span><span class="si">${</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">s</span><span class="p">.</span><span class="nx">fileName</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb"> (Chunk </span><span class="si">${</span><span class="nx">s</span><span class="p">.</span><span class="nx">chunkIndex</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="si">}</span><span class="sb">, Score </span><span class="si">${</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">score</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;n/a&#39;</span><span class="si">}</span><span class="sb">):\n</span><span class="si">${</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">text</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">perSnippetLimit</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n\n&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">buildContext</span><span class="p">(</span><span class="nx">sources</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// OpenAI Chat Call</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">chatApiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENAI_API_KEY</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">chatApiKey</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OPENAI_API_KEY fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENAI_CHAT_MODEL_NAME</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini&#39;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENAI_CHAT_TEMPERATURE</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">0.3</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Stilvorgaben je nach gewünschter Antwortlänge</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">styleInstruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">answerLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ausführlich&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Schreibe eine strukturierte, ausführliche Antwort (ca. 250–600 Wörter): Beginne mit 1–2 Sätzen Zusammenfassung, danach Details in Absätzen oder Stichpunkten. Vermeide Füllwörter.&#39;</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="nx">answerLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;mittel&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Schreibe eine mittellange Antwort (ca. 120–250 Wörter): 3–6 Sätze oder eine kurze Liste der wichtigsten Punkte. Direkt und präzise.&#39;</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Schreibe eine knappe Antwort (1–3 Sätze, max. 120 Wörter). Keine Einleitung, direkt die Kernaussage.&#39;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">prompt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Du bist ein präziser Assistent. Beantworte die Frage ausschließlich auf Basis der bereitgestellten Quellen.\n\nFrage:\n</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">\n\nQuellen:\n</span><span class="si">${</span><span class="nx">context</span><span class="si">}</span><span class="sb">\n\nAnforderungen:\n- </span><span class="si">${</span><span class="nx">styleInstruction</span><span class="si">}</span><span class="sb">\n- Fachlich korrekt, ohne Spekulationen.\n- Zitiere am Ende die verwendeten Quellen als [n] (Dateiname, Chunk).\n- Antworte auf Deutsch.`</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">callChat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">currPrompt</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.openai.com/v1/chat/completions&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">chatApiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">model</span><span class="p">,</span>
<span class="w">          </span><span class="nx">temperature</span><span class="p">,</span>
<span class="w">          </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;system&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Du bist ein hilfreicher, faktenbasierter Assistent.&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">currPrompt</span><span class="w"> </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optionales Server-Debugging: nur aktiv, wenn der Client X-Debug: 1 sendet oder nicht production</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Debug&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;production&#39;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">debug</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">usedChars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sources</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">text</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">0</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="c1">// eslint-disable-next-line no-console</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[api/chat] params&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">answerLength</span><span class="p">,</span><span class="w"> </span><span class="nx">baseBudget</span><span class="p">,</span><span class="w"> </span><span class="nx">windowByLength</span><span class="p">,</span><span class="w"> </span><span class="nx">topK</span><span class="o">:</span><span class="w"> </span><span class="kt">baseTopK</span><span class="p">,</span><span class="w"> </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="kt">usedChars</span><span class="p">,</span><span class="w"> </span><span class="nx">sources</span><span class="o">:</span><span class="w"> </span><span class="kt">sources.length</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="c1">// eslint-disable-next-line no-console</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[api/chat] sources&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sources</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">s.id</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">s.fileName</span><span class="p">,</span><span class="w"> </span><span class="nx">chunkIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">s.chunkIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="kt">s.score</span><span class="p">,</span><span class="w"> </span><span class="nx">textChars</span><span class="o">:</span><span class="w"> </span><span class="kt">s.text?.length</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">})))</span>
<span class="w">      </span><span class="c1">// eslint-disable-next-line no-console</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[api/chat] openai request&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span><span class="w"> </span><span class="nx">temperature</span><span class="p">,</span><span class="w"> </span><span class="nx">promptChars</span><span class="o">:</span><span class="w"> </span><span class="kt">prompt.length</span><span class="p">,</span><span class="w"> </span><span class="nx">contextChars</span><span class="o">:</span><span class="w"> </span><span class="kt">context.length</span><span class="p">,</span><span class="w"> </span><span class="nx">style</span><span class="o">:</span><span class="w"> </span><span class="kt">answerLength</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">chatRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">callChat</span><span class="p">(</span><span class="nx">prompt</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">chatRes</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">chatRes</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">tooLong</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;maximum context length&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">chatRes</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">400</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tooLong</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Reduziere Budget schrittweise und versuche erneut</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">budgets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">answerLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ausführlich&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="mf">120000</span><span class="p">,</span><span class="w"> </span><span class="mf">90000</span><span class="p">,</span><span class="w"> </span><span class="mf">60000</span><span class="p">,</span><span class="w"> </span><span class="mf">30000</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">answerLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;mittel&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="mf">60000</span><span class="p">,</span><span class="w"> </span><span class="mf">30000</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">20000</span><span class="p">]</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">retried</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">budgets</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">used</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span>
<span class="w">          </span><span class="nx">charBudget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">b</span>
<span class="w">          </span><span class="c1">// Kürze Quellenliste</span>
<span class="w">          </span><span class="kd">let</span><span class="w"> </span><span class="nx">acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">reduced</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">sources</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">text</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">0</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">acc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">charBudget</span><span class="p">)</span><span class="w"> </span><span class="k">break</span>
<span class="w">            </span><span class="nx">reduced</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="w">            </span><span class="nx">acc</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">len</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">buildContext</span><span class="p">(</span><span class="nx">reduced</span><span class="p">)</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Du bist ein präziser Assistent. Beantworte die Frage ausschließlich auf Basis der bereitgestellten Quellen.\n\nFrage:\n</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">\n\nQuellen:\n</span><span class="si">${</span><span class="nx">context</span><span class="si">}</span><span class="sb">\n\nAnforderungen:\n- Antworte knapp und fachlich korrekt.\n- Zitiere am Ende die verwendeten Quellen als [n] (Dateiname, Chunk).\n- Antworte auf Deutsch.`</span>
<span class="w">          </span><span class="nx">chatRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">callChat</span><span class="p">(</span><span class="nx">p2</span><span class="p">)</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatRes</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">retried</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">retried</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">chatRes</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="sb">`OpenAI Chat Fehler: </span><span class="si">${</span><span class="nx">chatRes</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="sb">`OpenAI Chat Fehler: </span><span class="si">${</span><span class="nx">chatRes</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">chatRes</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsed</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">parsed</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">parsed</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsed</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">choices?</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">message</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">content?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">choices</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="o">?</span><span class="p">.</span><span class="nx">content</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OpenAI Chat Parse Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">raw.slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">502</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">vectorIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">ctx.vectorIndex</span><span class="p">,</span>
<span class="w">      </span><span class="nx">answer</span><span class="p">,</span>
<span class="w">      </span><span class="nx">sources</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Detailliertes Logging und dev-Details zurückgeben</span>
<span class="w">    </span><span class="c1">// eslint-disable-next-line no-console</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[api/chat] Unhandled error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">error</span><span class="p">),</span>
<span class="w">      </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">stack</span><span class="o">?</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;production&#39;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Interner Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">...(</span><span class="nx">dev</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error.message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">String</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-repository&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/filesystem-provider&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/image-extraction-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">TransformService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/transform/transform-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileLogger</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/debug/logger&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/types/library&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getJobEventBus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/events/job-event-bus&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bufferLog</span><span class="p">,</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-log-buffer&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bumpWatchdog</span><span class="p">,</span><span class="w"> </span><span class="nx">clearWatchdog</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-jobs-watchdog&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">toAsciiKebab</span><span class="p">(</span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">,</span><span class="w"> </span><span class="nx">maxLen</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">80</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">map</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;ä&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ae&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ö&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;oe&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ü&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ue&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ß&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ss&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">replaced</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span>
<span class="w">    </span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">ch</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">map</span><span class="p">[</span><span class="nx">ch</span><span class="p">]</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">ch</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^a-z0-9]+/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^-+|-+$/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/-+/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">replaced</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">maxLen</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/-+$/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cut</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">splitToArray</span><span class="p">(</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">arr</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span>
<span class="w">      </span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">arr</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">normalizeStructuredData</span><span class="p">(</span><span class="nx">raw</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">raw</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">raw</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">out</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">r</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// shortTitle variants</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">shortTitleCandidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="s1">&#39;shortTitle&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="s1">&#39;shortTitel&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="s1">&#39;shortTitlel&#39;</span><span class="p">])</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">shortTitleCandidate</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cleaned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shortTitleCandidate</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[.!?]+$/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
<span class="w">    </span><span class="nx">out</span><span class="p">[</span><span class="s1">&#39;shortTitle&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">40</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">40</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="ow">delete</span><span class="w"> </span><span class="nx">out</span><span class="p">[</span><span class="s1">&#39;shortTitel&#39;</span><span class="p">];</span>
<span class="w">  </span><span class="ow">delete</span><span class="w"> </span><span class="nx">out</span><span class="p">[</span><span class="s1">&#39;shortTitlel&#39;</span><span class="p">];</span>

<span class="w">  </span><span class="c1">// slug normalization</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">slug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">toAsciiKebab</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="s1">&#39;slug&#39;</span><span class="p">]);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">slug</span><span class="p">)</span><span class="w"> </span><span class="nx">out</span><span class="p">[</span><span class="s1">&#39;slug&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">slug</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// authors and tags arrays</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">splitToArray</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authors</span><span class="p">)</span><span class="w"> </span><span class="nx">out</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authors</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">splitToArray</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">norm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tags</span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">toAsciiKebab</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mf">80</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">    </span><span class="nx">out</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">norm</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// year number</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">yearVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">];</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">yearVal</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="sr">/^\d{4}$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">yearVal</span><span class="p">))</span><span class="w"> </span><span class="nx">out</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">yearVal</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">accessToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">refreshToken?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">tokenExpiry?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="o">:</span><span class="w"> </span><span class="kt">Library</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">OneDriveAuthConfig</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">refreshToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">cfg</span><span class="o">?</span><span class="p">.</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isExpired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">tokenExpiry</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">accessToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isExpired</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">accessToken</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refreshToken</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;OneDrive Refresh-Token fehlt in der Library-Konfiguration&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_APP_URL</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">/api/auth/onedrive/refresh`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">lib.id</span><span class="p">,</span><span class="w"> </span><span class="nx">refreshToken</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Token-Refresh fehlgeschlagen (</span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">accessToken</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;root&#39;</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/root:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="sb">`https://graph.microsoft.com/v1.0/me/drive/items/</span><span class="si">${</span><span class="nx">parentId</span><span class="si">}</span><span class="sb">:/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="si">}</span><span class="sb">:/content`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=replace`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">409</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">?@microsoft.graph.conflictBehavior=rename`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">accessToken</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">mime</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">buffer</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`OneDrive Upload fehlgeschlagen: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// onedriveEnsureFolder wurde entfernt, da nicht verwendet</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAuth</span><span class="p">(</span><span class="nx">_request</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Benutzer-E-Mail nicht verfügbar&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional: Nur letzte N Logs zurückgeben via ?limit=...</span>
<span class="w">    </span><span class="c1">// Query-Params sind in App Router bei Route Handlern nicht direkt verfügbar ohne request.url zu parsen</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limitParam</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">limitParam</span><span class="p">)))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">persisted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">persisted</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">buffered</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">merged</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">limit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">merged</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.jobId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">job.status</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worker</span><span class="o">:</span><span class="w"> </span><span class="kt">job.worker</span><span class="p">,</span>
<span class="w">      </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="kt">job.operation</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processId</span><span class="o">:</span><span class="w"> </span><span class="kt">job.processId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.createdAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">job.updatedAt</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">job.error</span><span class="p">,</span>
<span class="w">      </span><span class="nx">logs</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">job.result</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unerwarteter Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">jobId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jobId erforderlich&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Token kann im Body, im X-Callback-Token-Header oder als Bearer kommen</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">callbackToken</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">callback_token</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">headerToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-callback-token&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;X-Callback-Token&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">headerToken</span><span class="p">)</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">headerToken</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">authHeader</span><span class="o">?</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">callbackToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">callbackToken</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;callback_token fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExternalJobsRepository</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">job</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">hashSecret</span><span class="p">(</span><span class="nx">callbackToken</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tokenHash</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">jobSecretHash</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Status auf running setzen und Prozess-ID loggen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">process</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setProcess</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Progress-Handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">body.progress</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">progress</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.progress</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">body.percent</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">percent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">body.data.percent</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">phase</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">phase</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasFinalPayload</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">hasError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">progressValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Watchdog heartbeat</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Progress-Event&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">progressValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Push-Event für UI (SSE)</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">jobId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="kt">phase</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">progressValue</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nx">progressValue</span><span class="p">))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;progress&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Bei Fehler: gepufferte Logs persistieren</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;worker_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Externer Worker-Fehler&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">body.error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.error?.message</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Finale Payload</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extractedText</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">extracted_text</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">images_archive_url</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">extractedText</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bumpWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">      </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;noop&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Bibliothek laden (um Typ zu bestimmen)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraryService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">libraryService</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">libraries</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">l</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">l</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">libraryId</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">savedItemId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">savedItems</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemProvider</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">sourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">itemId</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Pfade nur bei Bedarf auflösen (derzeit nicht benötigt)</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(sourceId ?? &#39;&#39;).catch(() =&gt; undefined);</span>
<span class="w">        </span><span class="c1">// await provider.getPathById(targetParentId).catch(() =&gt; &#39;/&#39;);</span>
<span class="w">        </span><span class="c1">// Pfade ermitteln (aktuell nur für Debugging/Logging nutzbar)</span>
<span class="w">        </span><span class="c1">// const sourceAbsPath = sourceRelPath und targetAbsPath aktuell ungenutzt</span>

<span class="w">        </span><span class="c1">// 1) Optionalen Template-Content laden (aus /templates oder per Chat-Setting &#39;transformerTemplate&#39;)</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">metadataFromTemplate</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Standard-Template-Inhalt (wird angelegt, falls kein Template gefunden wird)</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">defaultTemplateContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`---</span>
<span class="sb">title: {{title|Vollständiger Titel des Dokuments (string)}}</span>
<span class="sb">shortTitle: {{shortTitle|Kurzer Titel ≤40 Zeichen, ohne abschließende Satzzeichen}}</span>
<span class="sb">slug: {{slug|ASCII, lowercase, kebab-case; Umlaute/Diakritika normalisieren; max 80; keine doppelten Bindestriche}}</span>
<span class="sb">summary: {{summary|1–2 Sätze, ≤120 Zeichen, neutral, nur aus Text extrahiert}}</span>
<span class="sb">teaser: {{teaser|2–3 Sätze, nicht identisch zu summary, prägnant, extraktiv}}</span>
<span class="sb">authors: {{authors|Array von Autoren, dedupliziert, Format &quot;Nachname, Vorname&quot; wenn möglich}}</span>
<span class="sb">tags: {{tags|Array relevanter Tags, normalisiert: lowercase, ASCII, kebab-case, dedupliziert}}</span>
<span class="sb">docType: {{docType|Eine aus: report, study, brochure, offer, contract, manual, law, guideline, other}}</span>
<span class="sb">year: {{year|Vierstelliges Jahr als number; wenn unbekannt: null}}</span>
<span class="sb">region: {{region|Region/Land aus Text; wenn unbekannt: &quot;&quot;}}</span>
<span class="sb">language: {{language|Dokumentsprache, z. B. &quot;de&quot; oder &quot;en&quot;}}</span>
<span class="sb">chapters: {{chapters|Array von Kapiteln mit title, level (1..3), order (int, 1-basiert), startEvidence (≤160), summary (≤1000, extraktiv), keywords (5–12)}}</span>
<span class="sb">toc: {{toc|Optionales Array von { title, page?, level? }, nur wenn explizit im Text erkennbar}}</span>
<span class="sb">---</span>

<span class="sb"># {{title|Dokumenttitel}}</span>

<span class="sb">## Zusammenfassung</span>
<span class="sb">{{summary|Kurzfassung für Management/Vertrieb}}</span>

<span class="sb">--- systemprompt</span>
<span class="sb">Rolle:</span>
<span class="sb">- Du bist ein penibler, rein EXTRAKTIVER Sachbearbeiter. Du liest Kleingedrucktes genau. Abweichungen von der Norm sind preisrelevant – knapp anmerken, aber nichts erfinden.</span>

<span class="sb">Strenge Regeln:</span>
<span class="sb">- Verwende ausschließlich Inhalte, die EXPLIZIT im gelieferten Text vorkommen. Keine Halluzinationen.</span>
<span class="sb">- Wenn eine geforderte Information im Text nicht sicher vorliegt: gib &quot;&quot; (leere Zeichenkette) bzw. null (für year) zurück.</span>
<span class="sb">- Antworte AUSSCHLIESSLICH mit einem gültigen JSON-Objekt. Keine Kommentare, kein Markdown, keine Code-Fences.</span>

<span class="sb">Format-/Normalisierungsregeln:</span>
<span class="sb">- shortTitle: ≤40 Zeichen, gut lesbar, ohne abschließende Satzzeichen.</span>
<span class="sb">- slug: ASCII, lowercase, kebab-case, max 80, Diakritika/Umlaute normalisieren (ä→ae, ö→oe, ü→ue, ß→ss), mehrere Leerzeichen/Bindestriche zu einem Bindestrich zusammenfassen.</span>
<span class="sb">- summary: 1–2 Sätze, ≤120 Zeichen, neutraler Ton, extraktiv.</span>
<span class="sb">- teaser: 2–3 Sätze, nicht identisch zu summary, extraktiv.</span>
<span class="sb">- authors: Array von Strings, dedupliziert. Format „Nachname, Vorname“ wenn eindeutig ableitbar.</span>
<span class="sb">- tags: Array von Strings; normalisieren (lowercase, ASCII, kebab-case), deduplizieren; nur, wenn klar aus Text ableitbar.</span>
<span class="sb">- docType: klassifiziere streng nach Textsignalen in { report, study, brochure, offer, contract, manual, law, guideline }; wenn unklar: &quot;other&quot;.</span>
<span class="sb">- year: vierstelliges Jahr als number; nur übernehmen, wenn eindeutig (z. B. „Copyright 2024“, „Stand: 2023“).</span>
<span class="sb">- region: aus Text (z. B. Länder/Bundesländer/Regionen); sonst &quot;&quot;.</span>
<span class="sb">- language: bestmögliche Schätzung (z. B. &quot;de&quot;, &quot;en&quot;) anhand des Textes.</span>

<span class="sb">Kapitelanalyse (extraktiv):</span>
<span class="sb">- Erkenne echte Kapitel-/Unterkapitelstarts (Level 1..3), nur wenn sie im Text vorkommen.</span>
<span class="sb">- Für JEDES Kapitel liefere: title, level (1..3), order (1-basiert), startEvidence (≤160, exakter Anfangstext), summary (≤1000, extraktiv bis zum nächsten Kapitelstart), keywords (5–12, kurz und textnah).</span>
<span class="sb">- toc (optional): Liste von { title, page?, level? } nur, wenn explizit als Inhaltsverzeichnis erkennbar; Titel müssen existierenden Kapiteln entsprechen.</span>

<span class="sb">Antwortschema (MUSS exakt ein JSON-Objekt sein, ohne Zusatztext):</span>
<span class="sb">{</span>
<span class="sb">  &quot;title&quot;: string,</span>
<span class="sb">  &quot;shortTitle&quot;: string,</span>
<span class="sb">  &quot;slug&quot;: string,</span>
<span class="sb">  &quot;summary&quot;: string,</span>
<span class="sb">  &quot;teaser&quot;: string,</span>
<span class="sb">  &quot;authors&quot;: string[],</span>
<span class="sb">  &quot;tags&quot;: string[],</span>
<span class="sb">  &quot;docType&quot;: &quot;report&quot; | &quot;study&quot; | &quot;brochure&quot; | &quot;offer&quot; | &quot;contract&quot; | &quot;manual&quot; | &quot;law&quot; | &quot;guideline&quot; | &quot;other&quot;,</span>
<span class="sb">  &quot;year&quot;: number | null,</span>
<span class="sb">  &quot;region&quot;: string,</span>
<span class="sb">  &quot;language&quot;: string,</span>
<span class="sb">  &quot;chapters&quot;: [ { &quot;title&quot;: string, &quot;level&quot;: 1 | 2 | 3, &quot;order&quot;: number, &quot;startEvidence&quot;: string, &quot;summary&quot;: string, &quot;keywords&quot;: string[] } ],</span>
<span class="sb">  &quot;toc&quot;: [ { &quot;title&quot;: string, &quot;page&quot;: number?, &quot;level&quot;: number? } ] | []</span>
<span class="sb">}`</span><span class="p">;</span>

<span class="w">          </span><span class="c1">// Bevorzugter Template-Name aus Chat-Config (falls vorhanden)</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">preferredTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="o">?</span><span class="p">.</span><span class="nx">chat</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">transformerTemplate?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="o">?</span><span class="p">.</span><span class="nx">transformerTemplate</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
<span class="w">          </span><span class="c1">// Templates-Ordner im Root suchen</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">rootItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">templatesFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rootItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;folder&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;templates&#39;</span><span class="p">));</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">ensureTemplatesFolderId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">templatesFolder</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">templatesFolder</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">created</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">createFolder</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;templates&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;templates_folder_created&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Ordner /templates angelegt&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">created</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">          </span><span class="p">};</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">templatesFolderId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureTemplatesFolderId</span><span class="p">();</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">templatesFolderId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">tplItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">templatesFolderId</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Auswahllogik: bevorzugt preferredTemplate, sonst &#39;pdfanalyse.md&#39;, sonst erstes .md</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">pickByName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">tplItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()));</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">byPreferred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">preferredTemplate</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">pickByName</span><span class="p">(</span><span class="nx">preferredTemplate</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">preferredTemplate</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">preferredTemplate</span><span class="si">}</span><span class="sb">.md`</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">byDefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pickByName</span><span class="p">(</span><span class="s1">&#39;pdfanalyse.md&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">pickByName</span><span class="p">(</span><span class="s1">&#39;pdfanalyse_default.md&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">anyMd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tplItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">)));</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">chosen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">byPreferred</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">byDefault</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">anyMd</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">chosen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="c1">// Default-Template anlegen</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">tplFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">defaultTemplateContent</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="s1">&#39;pdfanalyse.md&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">templatesFolderId</span><span class="p">,</span><span class="w"> </span><span class="nx">tplFile</span><span class="p">);</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;template_created&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Default-Template pdfanalyse.md angelegt&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="c1">// Neu laden</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">templatesFolderId</span><span class="p">);</span>
<span class="w">              </span><span class="nx">chosen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">re</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">it</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="nx">it</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;pdfanalyse.md&#39;</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chosen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBinary</span><span class="p">(</span><span class="nx">chosen</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">templateContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bin</span><span class="p">.</span><span class="nx">blob</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
<span class="w">              </span><span class="c1">// 2) Secretary Transformer mit template_content aufrufen</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">secretaryUrlRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">transformerUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">secretaryUrlRaw</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryUrlRaw</span><span class="si">}</span><span class="sb">transformer/template`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">secretaryUrlRaw</span><span class="si">}</span><span class="sb">/transformer/template`</span><span class="p">;</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">              </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">              </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">lang</span><span class="p">);</span>
<span class="w">              </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;template_content&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">templateContent</span><span class="p">);</span>
<span class="w">              </span><span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;use_cache&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Accept&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">transformerUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}));</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">data</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">structured_data?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">;</span><span class="w"> </span><span class="nx">text?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">normalized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalizeStructuredData</span><span class="p">(</span><span class="nx">d</span><span class="o">?</span><span class="p">.</span><span class="nx">structured_data</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">normalized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">metadataFromTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalized</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">metadataFromTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transform_meta&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Metadaten via Template berechnet&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transform_meta_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Transformer lieferte kein gültiges JSON&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;template_missing&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Kein Template gefunden&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;templates_folder_missing&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Ordner /templates nicht gefunden&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transform_meta_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Fehler bei Template-Transformation&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3) Frontmatter-Metadaten bestimmen (Template bevorzugt, sonst Worker-Metadaten)</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseMeta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">finalMeta</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">metadataFromTemplate</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">metadataFromTemplate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">baseMeta</span><span class="w"> </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 4) Markdown mit Frontmatter erzeugen (Body = Originaltext)</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">markdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="nx">finalMeta</span><span class="p">)</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">File</span><span class="p">([</span><span class="ow">new</span><span class="w"> </span><span class="nx">Blob</span><span class="p">([</span><span class="nx">markdown</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">})],</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">uploadFile</span><span class="p">(</span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">);</span>
<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_local&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Lade ZIP-Archiv bei Bedarf vom Secretary-Service und extrahiere lokal</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_URL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">isAbsolute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^https?:\/\//i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isAbsolute</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">,</span><span class="w"> </span><span class="nx">baseRaw</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
<span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseRaw</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">rel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`/</span><span class="si">${</span><span class="nx">imagesArchiveUrlFromWorker</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">                </span><span class="nx">archiveUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">base</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">rel</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span><span class="p">)</span>
<span class="w">                  </span><span class="o">?</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">rel</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">4</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
<span class="w">                  </span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}${</span><span class="nx">rel</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRETARY_SERVICE_API_KEY</span><span class="p">;</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">apiKey</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">              </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Service-Token&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">archiveUrl</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Archiv-Download fehlgeschlagen: </span><span class="si">${</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="c1">// Markiere Job als fehlgeschlagen und beende</span>
<span class="w">              </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_download_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bild-Archiv konnte nicht geladen werden&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">resp.status</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Archiv-Download fehlgeschlagen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed_images_download&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">arrayBuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">();</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">base64Zip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">arrayBuf</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">originalItemForImages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">parentId</span><span class="o">:</span><span class="w"> </span><span class="kt">targetParentId</span><span class="p">,</span>
<span class="w">                </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<span class="w">                </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;source.pdf&#39;</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">modifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">                  </span><span class="nx">mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation.source?.mimeType</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">              </span><span class="p">};</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">textContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">text_contents</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">);</span>
<span class="w">              </span><span class="kd">const</span><span class="w"> </span><span class="nx">imageResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ImageExtractionService</span><span class="p">.</span><span class="nx">saveZipArchive</span><span class="p">(</span>
<span class="w">                </span><span class="nx">base64Zip</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;images.zip&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">originalItemForImages</span><span class="p">,</span>
<span class="w">                </span><span class="nx">provider</span><span class="p">,</span>
<span class="w">                </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="nx">folderId</span><span class="p">),</span>
<span class="w">                </span><span class="nx">extractedText</span><span class="p">,</span>
<span class="w">                </span><span class="nx">lang</span><span class="p">,</span>
<span class="w">                </span><span class="nx">textContents</span>
<span class="w">              </span><span class="p">);</span>
<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">)</span><span class="w"> </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">              </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extracted&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bilder gespeichert (</span><span class="si">${</span><span class="nx">imageResult</span><span class="p">.</span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)`</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Extraktion fehlgeschlagen&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="c1">// Markiere Job als fehlgeschlagen und beende</span>
<span class="w">            </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">bufferedNow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;images_extract_failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ZIP-Archiv konnte nicht extrahiert werden&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bilder-Extraktion fehlgeschlagen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;failed_images_extract&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lib</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">lib</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;onedrive&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ensureOneDriveAccessToken</span><span class="p">(</span><span class="nx">lib</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">targetParentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="o">?</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">parentId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.[^/.]+$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lang</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">correlation</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">targetLanguage</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">baseName</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">lang</span><span class="si">}</span><span class="sb">.md`</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="nx">TransformService</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createMarkdownWithFrontmatter</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}).</span><span class="nx">createMarkdownWithFrontmatter</span><span class="p">(</span><span class="nx">extractedText</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{})</span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="nx">extractedText</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">onedriveUploadFile</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span><span class="w"> </span><span class="nx">targetParentId</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text/markdown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">contentBuffer</span><span class="p">);</span>
<span class="w">        </span><span class="nx">savedItemId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">savedItems</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">saved</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="nx">bufferLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stored_cloud&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Shadow‑Twin gespeichert&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Bilder nicht mehr vom Webhook-ZIP extrahieren – Link wird bereitgestellt</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">clearWatchdog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// gepufferte Logs persistieren</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drainBufferedLogs</span><span class="p">(</span><span class="nx">jobId</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">buffered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">setResult</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">extracted_text</span><span class="o">:</span><span class="w"> </span><span class="kt">extractedText</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images_archive_url</span><span class="o">:</span><span class="w"> </span><span class="kt">imagesArchiveUrlFromWorker</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body?.data?.metadata</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItems</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Finalen Logeintrag für den sichtbaren Verlauf hinzufügen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">repo</span><span class="p">.</span><span class="nx">appendLog</span><span class="p">(</span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">phase</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">FileLogger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;external-jobs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Job completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">getJobEventBus</span><span class="p">().</span><span class="nx">emitUpdate</span><span class="p">(</span><span class="nx">job</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;job_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Job abgeschlossen&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">progress</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobType</span><span class="o">:</span><span class="w"> </span><span class="kt">job.job_type</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">job.correlation?.source?.name</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">jobId</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemId</span><span class="p">,</span><span class="w"> </span><span class="nx">savedItemsCount</span><span class="o">:</span><span class="w"> </span><span class="kt">savedItems.length</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid payload&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">_request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_API_KEY</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PINECONE_API_KEY fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.pinecone.io/indexes&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Api-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="c1">// Verhindert Next.js Caching der Management-Abfrage</span>
<span class="w">      </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}))</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">res.status</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">data?.message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Fehler von Pinecone&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_INDEX</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">indexes</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">indexes</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">indexes</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasExpected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">indexes</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">indexes</span><span class="p">,</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="o">:</span><span class="w"> </span><span class="kt">hasExpected</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Interner Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import React, { Suspense } from &quot;react&quot;;
import { Library } from &quot;@/components/library/library&quot;;
import { useAuth } from &quot;@clerk/nextjs&quot;;
import { useAtom, useAtomValue } from &quot;jotai&quot;;
import { activeLibraryIdAtom, librariesAtom } from &quot;@/atoms/library-atom&quot;;
import { useSearchParams, useRouter } from &quot;next/navigation&quot;;
import { useEffect } from &quot;react&quot;;
import { Alert, AlertDescription, AlertTitle } from &quot;@/components/ui/alert&quot;;
import { ExclamationTriangleIcon } from &quot;@radix-ui/react-icons&quot;;
import { Skeleton } from &quot;@/components/ui/skeleton&quot;;
import { useStorage } from &quot;@/contexts/storage-context&quot;;
import { Button } from &quot;@/components/ui/button&quot;;
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from &quot;@/components/ui/card&quot;;
import { Plus, BookOpen } from &quot;lucide-react&quot;;

// Separate Client-Komponente für die URL-Parameter-Logik
function LibraryUrlHandler() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const [, setActiveLibraryId] = useAtom(activeLibraryIdAtom);
  const { refreshAuthStatus } = useStorage();

  useEffect(() =&gt; {
    const urlLibraryId = searchParams?.get(&#39;activeLibraryId&#39;);

    // activeLibraryId aus der URL verarbeiten
    if (urlLibraryId) {
      setActiveLibraryId(urlLibraryId);
      // Speichere auch im localStorage für zukünftige Seitenaufrufe
      localStorage.setItem(&#39;activeLibraryId&#39;, urlLibraryId);

      // Auth-Status aktualisieren für die neue Library
      refreshAuthStatus();
      // Entferne nur activeLibraryId aus der URL, folderId beibehalten
      try {
        const params = new URLSearchParams(searchParams ?? undefined);
        params.delete(&#39;activeLibraryId&#39;);
        router.replace(params.size ? `/library?${params.toString()}` : &#39;/library&#39;);
      } catch {}
    }

    // Optional: Wenn nur folderId vorhanden ist, nichts tun – die Synchronisation erfolgt über navigateToFolder
  }, [searchParams, setActiveLibraryId, router, refreshAuthStatus]);

  return null;
}

export default function LibraryPage() {
  const { isLoaded: isAuthLoaded, isSignedIn } = useAuth();
  const { isLoading, error } = useStorage();
  const libraries = useAtomValue(librariesAtom);
  const router = useRouter();

  // Nutze den StorageContext statt eigenes Loading
  if (!isAuthLoaded || isLoading) {
    return &lt;div className=&quot;p-8&quot;&gt;
      &lt;Skeleton className=&quot;h-[500px] w-full&quot; /&gt;
    &lt;/div&gt;;
  }

  if (!isSignedIn) {
    return &lt;div className=&quot;p-8&quot;&gt;
      &lt;Alert variant=&quot;destructive&quot;&gt;
        &lt;ExclamationTriangleIcon className=&quot;h-4 w-4&quot; /&gt;
        &lt;AlertTitle&gt;Fehler&lt;/AlertTitle&gt;
        &lt;AlertDescription&gt;
          Sie müssen angemeldet sein, um auf die Bibliothek zugreifen zu können.
        &lt;/AlertDescription&gt;
      &lt;/Alert&gt;
    &lt;/div&gt;;
  }

  if (error) {
    return &lt;div className=&quot;p-8&quot;&gt;
      &lt;div className=&quot;mb-8&quot;&gt;
        &lt;Alert variant=&quot;destructive&quot;&gt;
          &lt;ExclamationTriangleIcon className=&quot;h-4 w-4&quot; /&gt;
          &lt;AlertTitle&gt;Fehler&lt;/AlertTitle&gt;
          &lt;AlertDescription&gt;
            {error}
          &lt;/AlertDescription&gt;
        &lt;/Alert&gt;
      &lt;/div&gt;
    &lt;/div&gt;;
  }

  // Zeige eine freundliche Meldung, wenn keine Bibliotheken vorhanden sind
  if (libraries.length === 0) {
    return (
      &lt;div className=&quot;flex h-[calc(100vh-4rem)] items-center justify-center p-8&quot;&gt;
        &lt;Card className=&quot;w-full max-w-md&quot;&gt;
          &lt;CardHeader className=&quot;text-center&quot;&gt;
            &lt;div className=&quot;flex justify-center mb-4&quot;&gt;
              &lt;div className=&quot;w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center&quot;&gt;
                &lt;BookOpen className=&quot;w-8 h-8 text-primary&quot; /&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;CardTitle&gt;Keine Bibliotheken vorhanden&lt;/CardTitle&gt;
            &lt;CardDescription&gt;
              Erstellen Sie Ihre erste Bibliothek, um mit der Organisation Ihrer Dokumente zu beginnen.
            &lt;/CardDescription&gt;
          &lt;/CardHeader&gt;
          &lt;CardContent className=&quot;space-y-4&quot;&gt;
            &lt;Button 
              className=&quot;w-full&quot; 
              onClick={() =&gt; router.push(&#39;/settings?newUser=true&#39;)}
            &gt;
              &lt;Plus className=&quot;w-4 h-4 mr-2&quot; /&gt;
              Erste Bibliothek erstellen
            &lt;/Button&gt;
            &lt;p className=&quot;text-sm text-muted-foreground text-center&quot;&gt;
              Sie können lokale Ordner oder Cloud-Speicher wie OneDrive verbinden.
            &lt;/p&gt;
          &lt;/CardContent&gt;
        &lt;/Card&gt;
      &lt;/div&gt;
    );
  }

  return (
    &lt;div className=&quot;flex h-[calc(100vh-4rem)] flex-col&quot;&gt;
      &lt;Suspense fallback={null}&gt;
        &lt;LibraryUrlHandler /&gt;
      &lt;/Suspense&gt;
      &lt;div className=&quot;flex-1 min-h-0&quot;&gt;
        &lt;Library /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
} 
</code></pre></div>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;

import { useEffect, useRef, useState } from &#39;react&#39;
import { Card, CardContent, CardHeader, CardTitle } from &#39;@/components/ui/card&#39;
import { Input } from &#39;@/components/ui/input&#39;
import { Button } from &#39;@/components/ui/button&#39;
import { Separator } from &#39;@/components/ui/separator&#39;
import { Badge } from &#39;@/components/ui/badge&#39;
import { Tooltip, TooltipTrigger, TooltipContent } from &#39;@/components/ui/tooltip&#39;
import { FileText } from &#39;lucide-react&#39;

interface ChatPanelProps {
  libraryId: string
}

interface ChatConfigResponse {
  library: { id: string; label: string }
  config: {
    public: boolean
    titleAvatarSrc?: string
    welcomeMessage: string
    errorMessage?: string
    placeholder?: string
    maxChars: number
    maxCharsWarningMessage?: string
    footerText?: string
    companyLink?: string
    features?: { citations?: boolean; streaming?: boolean }
  }
  vectorIndex: string
}

export function ChatPanel({ libraryId }: ChatPanelProps) {
  const [cfg, setCfg] = useState&lt;ChatConfigResponse | null&gt;(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState&lt;string | null&gt;(null)
  const [input, setInput] = useState(&#39;&#39;)
  const [answer, setAnswer] = useState&lt;string&gt;(&#39;&#39;)
  const [results, setResults] = useState&lt;Array&lt;{ id: string; score?: number; fileName?: string; chunkIndex?: number; text?: string }&gt;&gt;([])
  const [answerLength, setAnswerLength] = useState&lt;&#39;kurz&#39; | &#39;mittel&#39; | &#39;ausführlich&#39;&gt;(&#39;mittel&#39;)
  const inputRef = useRef&lt;HTMLInputElement&gt;(null)

  useEffect(() =&gt; {
    let cancelled = false
    async function load() {
      setLoading(true)
      setError(null)
      try {
        const res = await fetch(`/api/chat/${encodeURIComponent(libraryId)}/config`, { cache: &#39;no-store&#39; })
        if (!res.ok) throw new Error(`Fehler beim Laden der Chat-Konfiguration: ${res.statusText}`)
        const data = await res.json() as ChatConfigResponse
        if (!cancelled) setCfg(data)
      } catch (e) {
        if (!cancelled) setError(e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;)
      } finally {
        if (!cancelled) setLoading(false)
      }
    }
    load()
    return () =&gt; { cancelled = true }
  }, [libraryId])

  async function onSend() {
    if (!cfg) return
    if (!input.trim()) return
    if (cfg.config.maxChars &amp;&amp; input.length &gt; cfg.config.maxChars) {
      setError(cfg.config.maxCharsWarningMessage || &#39;Eingabe zu lang&#39;)
      return
    }
    setError(null)
    setAnswer(&#39;&#39;)
    setResults([])
    try {
      // Debug-Ausgabe: angewendete Parameter im Client
      // Hinweis: Setze den Header X-Debug auf 1, um serverseitige Logs zu aktivieren
      // (nur in Dev-Umgebungen empfohlen)
      // eslint-disable-next-line no-console
      console.log(&#39;[chat] sende Anfrage&#39;, { answerLength, chars: input.length })
      const res = await fetch(`/api/chat/${encodeURIComponent(libraryId)}`, {
        method: &#39;POST&#39;,
        headers: { &#39;Content-Type&#39;: &#39;application/json&#39;, &#39;X-Debug&#39;: &#39;1&#39; },
        body: JSON.stringify({ message: input, answerLength })
      })
      const data = await res.json()
      if (!res.ok) throw new Error(data?.error || &#39;Fehler bei der Anfrage&#39;)
      if (typeof data?.answer === &#39;string&#39; &amp;&amp; Array.isArray(data?.sources)) {
        setAnswer(data.answer)
        setResults(data.sources)
      } else if (Array.isArray(data?.results)) {
        const safe = (data.results as Array&lt;unknown&gt;).map((r): { id: string; score?: number; fileName?: string; chunkIndex?: number; text?: string } =&gt; {
          const obj = (r &amp;&amp; typeof r === &#39;object&#39;) ? r as Record&lt;string, unknown&gt; : {}
          const id = String(obj.id ?? &#39;&#39;)
          const score = typeof obj.score === &#39;number&#39; ? obj.score : undefined
          const meta = (obj.metadata &amp;&amp; typeof obj.metadata === &#39;object&#39;) ? obj.metadata as Record&lt;string, unknown&gt; : undefined
          const fileName = meta &amp;&amp; typeof meta.fileName === &#39;string&#39; ? meta.fileName : undefined
          const chunkIndex = meta &amp;&amp; typeof meta.chunkIndex === &#39;number&#39; ? meta.chunkIndex : undefined
          const text = meta &amp;&amp; typeof meta.text === &#39;string&#39; ? meta.text : undefined
          return { id, score, fileName, chunkIndex, text }
        })
        setResults(safe)
        setAnswer(&#39;&#39;)
      } else {
        setAnswer(typeof data.echo === &#39;string&#39; ? data.echo : JSON.stringify(data))
      }
    } catch (e) {
      setError(e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;)
    }
  }

  if (loading) return &lt;div className=&quot;p-6&quot;&gt;Lade Chat...&lt;/div&gt;
  if (error) return &lt;div className=&quot;p-6 text-destructive&quot;&gt;{error}&lt;/div&gt;
  if (!cfg) return &lt;div className=&quot;p-6&quot;&gt;Keine Konfiguration gefunden.&lt;/div&gt;

  return (
    &lt;div className=&quot;p-4 md:p-6 max-w-4xl mx-auto w-full&quot;&gt;
      &lt;Card&gt;
        &lt;CardHeader&gt;
          &lt;CardTitle className=&quot;flex items-center gap-3&quot;&gt;
            {cfg.config.titleAvatarSrc ? (
              // eslint-disable-next-line @next/next/no-img-element
              &lt;img src={cfg.config.titleAvatarSrc} alt=&quot;Avatar&quot; className=&quot;h-8 w-8 rounded&quot; /&gt;
            ) : null}
            &lt;span&gt;Chat · {cfg.library.label}&lt;/span&gt;
          &lt;/CardTitle&gt;
        &lt;/CardHeader&gt;
        &lt;CardContent&gt;
          &lt;div className=&quot;text-sm text-muted-foreground mb-4&quot;&gt;{cfg.config.welcomeMessage}&lt;/div&gt;
          &lt;Separator className=&quot;my-3&quot; /&gt;
          &lt;div className=&quot;mb-2 flex items-center gap-2 text-xs text-muted-foreground flex-wrap&quot;&gt;
            &lt;span&gt;Antwortlänge:&lt;/span&gt;
            &lt;div className=&quot;flex gap-1&quot;&gt;
              {([&#39;kurz&#39;,&#39;mittel&#39;,&#39;ausführlich&#39;] as const).map(v =&gt; (
                &lt;Button key={v} type=&quot;button&quot; size=&quot;sm&quot; variant={answerLength===v? &#39;default&#39;:&#39;outline&#39;} onClick={() =&gt; setAnswerLength(v)} className=&quot;h-7&quot;&gt;
                  {v}
                &lt;/Button&gt;
              ))}
            &lt;/div&gt;
          &lt;/div&gt;
          &lt;div className=&quot;flex gap-2 items-center&quot;&gt;
            &lt;Input
              ref={inputRef}
              className=&quot;flex-1&quot;
              placeholder={cfg.config.placeholder || &#39;Ihre Frage...&#39;}
              value={input}
              onChange={(e) =&gt; setInput(e.target.value)}
              onKeyDown={(e) =&gt; { if (e.key === &#39;Enter&#39;) onSend() }}
            /&gt;
            &lt;Button type=&quot;button&quot; onClick={onSend}&gt;Senden&lt;/Button&gt;
          &lt;/div&gt;
          {error &amp;&amp; &lt;div className=&quot;mt-3 text-sm text-destructive&quot;&gt;{error}&lt;/div&gt;}
          {answer &amp;&amp; (
            &lt;div className=&quot;mt-4 p-3 rounded border bg-muted/30&quot;&gt;
              &lt;div className=&quot;text-xs text-muted-foreground mb-1&quot;&gt;Antwort:&lt;/div&gt;
              &lt;div className=&quot;whitespace-pre-wrap break-words&quot;&gt;{answer}&lt;/div&gt;
            &lt;/div&gt;
          )}
          {results.length &gt; 0 &amp;&amp; (
            &lt;div className=&quot;mt-3 flex items-center gap-2 flex-wrap&quot;&gt;
              {results.map((r, i) =&gt; (
                &lt;Tooltip key={`${r.id}-${i}`}&gt;
                  &lt;TooltipTrigger asChild&gt;
                    &lt;Button variant=&quot;ghost&quot; size=&quot;icon&quot; className=&quot;h-8 w-8&quot; aria-label={`Quelle ${i + 1}`}&gt;
                      &lt;FileText className=&quot;h-4 w-4&quot; /&gt;
                    &lt;/Button&gt;
                  &lt;/TooltipTrigger&gt;
                  &lt;TooltipContent className=&quot;max-w-[420px] p-3&quot;&gt;
                    &lt;div className=&quot;text-xs text-muted-foreground mb-1&quot;&gt;Quelle {i + 1}&lt;/div&gt;
                    &lt;div className=&quot;text-sm font-medium break-all&quot;&gt;{r.fileName || r.id}&lt;/div&gt;
                    &lt;div className=&quot;text-xs text-muted-foreground mt-1 flex items-center gap-2&quot;&gt;
                      {typeof r.score === &#39;number&#39; &amp;&amp; &lt;Badge variant=&quot;secondary&quot;&gt;Score {r.score.toFixed(3)}&lt;/Badge&gt;}
                      {typeof r.chunkIndex === &#39;number&#39; &amp;&amp; &lt;Badge variant=&quot;outline&quot;&gt;Chunk {r.chunkIndex}&lt;/Badge&gt;}
                    &lt;/div&gt;
                    {r.text &amp;&amp; &lt;div className=&quot;mt-2 text-sm whitespace-pre-wrap break-words&quot;&gt;{r.text}&lt;/div&gt;}
                  &lt;/TooltipContent&gt;
                &lt;/Tooltip&gt;
              ))}
            &lt;/div&gt;
          )}
          {cfg.config.footerText &amp;&amp; (
            &lt;div className=&quot;mt-6 text-xs text-muted-foreground&quot;&gt;
              {cfg.config.footerText} {cfg.config.companyLink ? (&lt;a className=&quot;underline&quot; href={cfg.config.companyLink} target=&quot;_blank&quot; rel=&quot;noreferrer&quot;&gt;mehr&lt;/a&gt;) : null}
            &lt;/div&gt;
          )}
        &lt;/CardContent&gt;
      &lt;/Card&gt;
    &lt;/div&gt;
  )
}
</code></pre></div>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import * as React from &#39;react&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Alert, AlertDescription } from &quot;@/components/ui/alert&quot;;
import { AlertCircle } from &quot;lucide-react&quot;;
import { AudioPlayer } from &#39;./audio-player&#39;;
import { VideoPlayer } from &#39;./video-player&#39;;
import { MarkdownPreview } from &#39;./markdown-preview&#39;;
import { Tabs, TabsContent, TabsList, TabsTrigger } from &quot;@/components/ui/tabs&quot;;
import &#39;./markdown-audio&#39;;
import { useAtomValue, useSetAtom } from &quot;jotai&quot;;
import { activeLibraryIdAtom, selectedFileAtom } from &quot;@/atoms/library-atom&quot;;
import { TextEditor } from &#39;./text-editor&#39;;
import { StorageItem, StorageProvider } from &quot;@/lib/storage/types&quot;;
import { extractFrontmatter } from &#39;./markdown-metadata&#39;;
import { ImagePreview } from &#39;./image-preview&#39;;
import { DocumentPreview } from &#39;./document-preview&#39;;
import { FileLogger } from &quot;@/lib/debug/logger&quot;

// Explizite React-Komponenten-Deklarationen für den Linter
const ImagePreviewComponent = ImagePreview;
const DocumentPreviewComponent = DocumentPreview;

interface FilePreviewProps {
  className?: string;
  provider: StorageProvider | null;
  file?: StorageItem | null; // Neue prop für explizite Datei-Auswahl
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}

// Helper function for file type detection
function getFileType(fileName: string): string {
  const extension = fileName.split(&#39;.&#39;).pop()?.toLowerCase();

  switch(extension) {
    case &#39;txt&#39;:
    case &#39;md&#39;:
    case &#39;mdx&#39;:
      return &#39;markdown&#39;;
    case &#39;mp4&#39;:
    case &#39;avi&#39;:
    case &#39;mov&#39;:
    case &#39;webm&#39;:
    case &#39;mkv&#39;:
      return &#39;video&#39;;
    case &#39;mp3&#39;:
    case &#39;m4a&#39;:
    case &#39;wav&#39;:
    case &#39;ogg&#39;:
    case &#39;opus&#39;:
    case &#39;flac&#39;:
      return &#39;audio&#39;;
    case &#39;jpg&#39;:
    case &#39;jpeg&#39;:
    case &#39;png&#39;:
    case &#39;gif&#39;:
    case &#39;webp&#39;:
    case &#39;svg&#39;:
    case &#39;bmp&#39;:
    case &#39;ico&#39;:
      return &#39;image&#39;;
    case &#39;pdf&#39;:
      return &#39;pdf&#39;;
    case &#39;doc&#39;:
    case &#39;docx&#39;:
      return &#39;docx&#39;;
    case &#39;odt&#39;:
      return &#39;docx&#39;;
    case &#39;ppt&#39;:
    case &#39;pptx&#39;:
      return &#39;pptx&#39;;
    case &#39;xls&#39;:
    case &#39;xlsx&#39;:
      return &#39;xlsx&#39;;
    case &#39;url&#39;:
      return &#39;website&#39;;
    default:
      // Für unbekannte Dateitypen prüfen wir, ob es sich um eine Textdatei handeln könnte
      const textExtensions = [&#39;json&#39;, &#39;xml&#39;, &#39;yaml&#39;, &#39;yml&#39;, &#39;ini&#39;, &#39;cfg&#39;, &#39;conf&#39;, &#39;log&#39;, &#39;csv&#39;, &#39;html&#39;, &#39;htm&#39;, &#39;css&#39;, &#39;js&#39;, &#39;ts&#39;, &#39;jsx&#39;, &#39;tsx&#39;, &#39;py&#39;, &#39;java&#39;, &#39;c&#39;, &#39;cpp&#39;, &#39;h&#39;, &#39;hpp&#39;, &#39;cs&#39;, &#39;php&#39;, &#39;rb&#39;, &#39;go&#39;, &#39;rs&#39;, &#39;swift&#39;, &#39;kt&#39;, &#39;scala&#39;, &#39;r&#39;, &#39;sh&#39;, &#39;bash&#39;, &#39;ps1&#39;, &#39;bat&#39;, &#39;cmd&#39;, &#39;odt&#39;];
      if (textExtensions.includes(extension || &#39;&#39;)) {
        return &#39;markdown&#39;; // Behandle als editierbare Textdatei
      }
      return &#39;unknown&#39;;
  }
}

// Separate Komponente für den Content Loader
function ContentLoader({ 
  item, 
  provider, 
  fileType, 
  isAudioFile, 
  isVideoFile, 
  contentCache,
  onContentLoaded 
}: {
  item: StorageItem | null;
  provider: StorageProvider | null;
  fileType: string;
  isAudioFile: boolean;
  isVideoFile: boolean;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentLoaded: (content: string, hasMetadata: boolean) =&gt; void;
}) {
  const loadingIdRef = React.useRef&lt;string | null&gt;(null);

  // Prüft ob eine Datei ein Template ist
  const isTemplateFile = React.useCallback((name?: string): boolean =&gt; {
    if (!name) return false;
    return name.includes(&#39;{{&#39;) &amp;&amp; name.includes(&#39;}}&#39;);
  }, []);

  const loadContent = React.useCallback(async () =&gt; {
    if (!item?.id || !provider) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;loadContent abgebrochen&#39;, {
        hasItem: !!item?.id,
        hasProvider: !!provider
      });
      return;
    }

    FileLogger.info(&#39;ContentLoader&#39;, &#39;Lade Content für Datei&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      cacheSize: contentCache.current.size
    });

    // Prüfen ob Inhalt bereits im Cache
    const cachedContent = contentCache.current.get(item.id);
    if (cachedContent) {
      FileLogger.info(&#39;ContentLoader&#39;, &#39;Content aus Cache geladen&#39;, {
        itemId: item.id,
        contentLength: cachedContent.content.length,
        hasMetadata: cachedContent.hasMetadata
      });
      onContentLoaded(cachedContent.content, cachedContent.hasMetadata);
      return;
    }

    // Prüfen ob bereits ein Ladevorgang läuft
    if (loadingIdRef.current === item.id) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;Ladevorgang läuft bereits&#39;, {
        itemId: item.id
      });
      return;
    }

    loadingIdRef.current = item.id;

    try {
      // Wenn es eine Template-Datei ist, zeigen wir eine Warnung an
      if (isTemplateFile(item.metadata.name)) {
        const content = &quot;---\nstatus: template\n---\n\n&gt; **Hinweis**: Diese Datei enthält nicht aufgelöste Template-Variablen.\n&gt; Bitte stellen Sie sicher, dass alle Variablen korrekt definiert sind.&quot;;
        contentCache.current.set(item.id, { content, hasMetadata: true });
        onContentLoaded(content, true);
        return;
      }

      // Liste der Dateitypen, die als Binärdateien behandelt werden sollen
      const binaryFileTypes = [&#39;audio&#39;, &#39;image&#39;, &#39;video&#39;, &#39;pdf&#39;, &#39;docx&#39;, &#39;pptx&#39;, &#39;xlsx&#39;];

      if (!binaryFileTypes.includes(fileType) &amp;&amp; fileType !== &#39;unknown&#39;) {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Lade Textinhalt von Provider&#39;, {
          itemId: item.id,
          fileType
        });
        const content = await provider.getBinary(item.id).then(({ blob }) =&gt; blob.text());
        const hasMetadata = !!extractFrontmatter(content);

        FileLogger.info(&#39;ContentLoader&#39;, &#39;Content geladen und in Cache gespeichert&#39;, {
          itemId: item.id,
          contentLength: content.length,
          hasMetadata
        });

        contentCache.current.set(item.id, { content, hasMetadata });
        onContentLoaded(content, hasMetadata);
      } else {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Überspringe Content-Laden für Binary/Unknown-Datei&#39;, {
          itemId: item.id,
          fileType,
          isBinary: binaryFileTypes.includes(fileType),
          isUnknown: fileType === &#39;unknown&#39;
        });
        contentCache.current.set(item.id, { content: &#39;&#39;, hasMetadata: false });
        onContentLoaded(&#39;&#39;, false);
      }
    } catch (err) {
      FileLogger.error(&#39;ContentLoader&#39;, &#39;Failed to load file&#39;, err);
      // Bei Fehler zeigen wir eine Fehlermeldung im Markdown-Format
      const errorContent = &quot;---\nstatus: error\n---\n\n&gt; **Fehler**: Die Datei konnte nicht geladen werden.\n&gt; Bitte überprüfen Sie die Konsole für weitere Details.&quot;;
      contentCache.current.set(item.id, { content: errorContent, hasMetadata: true });
      onContentLoaded(errorContent, true);
    } finally {
      loadingIdRef.current = null;
    }
  }, [item?.id, item?.metadata?.name, provider, fileType, isAudioFile, isVideoFile, onContentLoaded, isTemplateFile, contentCache]);

  // Cleanup bei Unmount
  React.useEffect(() =&gt; {
    return () =&gt; {
      loadingIdRef.current = null;
    };
  }, []);

  // Nur laden wenn sich die ID ändert
  React.useEffect(() =&gt; {
    if (item?.id) {
      loadContent();
    }
  }, [item?.id, loadContent]);

  return null;
}

// Separate Komponente für die Vorschau
function PreviewContent({ 
  item, 
  fileType, 
  content, 
  error, 
  activeLibraryId,
  provider,
  contentCache,
  onContentUpdated,
  onRefreshFolder
}: {
  item: StorageItem;
  fileType: string;
  content: string;
  error: string | null;
  activeLibraryId: string;
  provider: StorageProvider | null;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentUpdated: (content: string) =&gt; void;
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}) {
  const [activeTab, setActiveTab] = React.useState&lt;string&gt;(&quot;preview&quot;);
  const [ragLoading, setRagLoading] = React.useState(false);
  const [ragError, setRagError] = React.useState&lt;string | null&gt;(null);
  const [ragStatus, setRagStatus] = React.useState&lt;{
    status: &#39;ok&#39; | &#39;stale&#39; | &#39;not_indexed&#39;;
    fileName?: string;
    chunkCount?: number;
    upsertedAt?: string;
    docModifiedAt?: string;
    docMeta?: Record&lt;string, unknown&gt;;
    toc?: Array&lt;Record&lt;string, unknown&gt;&gt;;
    totals?: { docs: number; chunks: number };
  } | null&gt;(null);
  const setSelectedFile = useSetAtom(selectedFileAtom);

  // Debug-Log für PreviewContent
  React.useEffect(() =&gt; {
    FileLogger.info(&#39;PreviewContent&#39;, &#39;PreviewContent gerendert&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      fileType,
      contentLength: content.length,
      hasError: !!error,
      hasProvider: !!provider,
      activeLibraryId
    });
  }, [item.id, fileType, content.length, error, provider, activeLibraryId]);

  React.useEffect(() =&gt; {
    setActiveTab(&quot;preview&quot;);
  }, [item.id]);

  async function loadRagStatus() {
    try {
      setRagLoading(true);
      setRagError(null);
      const docMod = (() =&gt; {
        const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
        const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
        return dt ? dt.toISOString() : undefined;
      })();
      const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/file-status?fileId=${encodeURIComponent(item.id)}${docMod ? `&amp;docModifiedAt=${encodeURIComponent(docMod)}` : &#39;&#39;}`, { cache: &#39;no-store&#39; });
      const data = await res.json();
      if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Status konnte nicht geladen werden&#39;);
      // Library-Stats parallel
      const statsRes = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/stats`, { cache: &#39;no-store&#39; });
      const stats = await statsRes.json().catch(() =&gt; ({}));
      setRagStatus({ ...data, totals: stats?.totals });
    } catch (e) {
      setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;);
    } finally {
      setRagLoading(false);
    }
  }

  if (error) {
    FileLogger.error(&#39;PreviewContent&#39;, &#39;Fehler in PreviewContent&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      error
    });
    return &lt;Alert variant=&quot;destructive&quot;&gt;&lt;AlertCircle className=&quot;h-4 w-4&quot; /&gt;&lt;AlertDescription&gt;{error}&lt;/AlertDescription&gt;&lt;/Alert&gt;;
  }

  // Debug-Log vor Switch-Statement
  FileLogger.debug(&#39;PreviewContent&#39;, &#39;Switch-Statement erreicht&#39;, {
    itemId: item.id,
    itemName: item.metadata.name,
    fileType,
    switchCase: fileType
  });

  switch (fileType) {
    case &#39;audio&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Audio-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;AudioPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;image&#39;:
      FileLogger.info(&#39;PreviewContent&#39;, &#39;ImagePreview wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        mimeType: item.metadata.mimeType,
        hasProvider: !!provider,
        providerName: provider?.name
      });
      return (
        &lt;ImagePreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;video&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Video-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;VideoPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;markdown&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Markdown-Editor wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        contentLength: content.length
      });
      return (
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;Tabs defaultValue=&quot;preview&quot; value={activeTab} onValueChange={setActiveTab} className=&quot;h-full flex flex-col&quot;&gt;
            &lt;TabsList className=&quot;mx-4 mt-2 flex-shrink-0&quot;&gt;
              &lt;TabsTrigger value=&quot;preview&quot;&gt;Vorschau&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;edit&quot;&gt;Bearbeiten&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;rag&quot; onClick={() =&gt; { void loadRagStatus(); }}&gt;RAG&lt;/TabsTrigger&gt;
            &lt;/TabsList&gt;
            &lt;div className=&quot;flex-1 min-h-0&quot;&gt;
              &lt;TabsContent value=&quot;preview&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;flex items-center gap-2 px-4 py-2&quot;&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (A)&#39;)
                        console.log(&#39;[Upsert A] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert A] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert A
                  &lt;/button&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;B&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (B)&#39;)
                        console.log(&#39;[Upsert B] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert B] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert B
                  &lt;/button&gt;
                &lt;/div&gt;
                &lt;MarkdownPreview 
                  content={content}
                  currentFolderId={item.parentId}
                  provider={provider}
                  className=&quot;h-full&quot;
                  onTransform={() =&gt; setActiveTab(&quot;edit&quot;)}
                  onRefreshFolder={onRefreshFolder}
                /&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;rag&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;p-4 space-y-3&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between&quot;&gt;
                    &lt;div className=&quot;text-sm font-medium&quot;&gt;RAG-Status&lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={() =&gt; void loadRagStatus()}
                      &gt;
                        Aktualisieren
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content, mode: &#39;llm&#39; })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse (LLM) fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse (LLM)&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse (LLM)
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert&#39;);
                          }
                        }}
                      &gt;
                        Upsert
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary/70 text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const chaptersSrcUnknown: unknown = (ragStatus as unknown as { analyze?: { chapters?: unknown } })?.analyze?.chapters
                            const chaptersSrc: Array&lt;unknown&gt; | undefined = Array.isArray(chaptersSrcUnknown) ? chaptersSrcUnknown : undefined
                            if (!Array.isArray(chaptersSrc) || chaptersSrc.length === 0) {
                              throw new Error(&#39;Keine Kapitelanalyse vorhanden&#39;)
                            }
                            const chapters = chaptersSrc
                              .filter((c) =&gt; typeof c?.summary === &#39;string&#39; &amp;&amp; c.summary.trim().length &gt; 0)
                              .map((c, i) =&gt; ({
                                chapterId: typeof c.chapterId === &#39;string&#39; ? c.chapterId : `chap-${i + 1}`,
                                title: String(c.title ?? `Kapitel ${i + 1}`),
                                order: i + 1,
                                summary: String(c.summary).slice(0, 1200),
                                keywords: Array.isArray(c.keywords) ? c.keywords.slice(0, 12) : undefined,
                              }))
                            if (chapters.length === 0) throw new Error(&#39;Keine Kapitel mit Summary gefunden&#39;)

                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const tocUnknown: unknown = (ragStatus as unknown as { analyze?: { toc?: unknown } })?.analyze?.toc
                            const toc: Array&lt;unknown&gt; | undefined = Array.isArray(tocUnknown) ? tocUnknown : undefined
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod, chapters, toc })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert (Analyse) fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert (Analyse)&#39;);
                          }
                        }}
                      &gt;
                        Upsert (Analyse)
                      &lt;/button&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  {ragLoading &amp;&amp; &lt;div className=&quot;text-sm text-muted-foreground&quot;&gt;Lade Status…&lt;/div&gt;}
                  {ragError &amp;&amp; &lt;div className=&quot;text-sm text-destructive&quot;&gt;{ragError}&lt;/div&gt;}
                  {ragStatus &amp;&amp; (
                    &lt;div className=&quot;space-y-2 text-sm&quot;&gt;
                      &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                        &lt;span&gt;Status:&lt;/span&gt;
                        &lt;span className={cn(
                          &#39;inline-flex items-center rounded px-2 py-0.5 text-xs&#39;,
                          ragStatus.status === &#39;ok&#39; &amp;&amp; &#39;bg-green-100 text-green-700&#39;,
                          ragStatus.status === &#39;stale&#39; &amp;&amp; &#39;bg-amber-100 text-amber-800&#39;,
                          ragStatus.status === &#39;not_indexed&#39; &amp;&amp; &#39;bg-gray-100 text-gray-700&#39;
                        )}&gt;
                          {ragStatus.status}
                        &lt;/span&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;fileId: {ragStatus?.fileName ? &#39;&#39; : &#39;&#39;}{(item.id)}&lt;/div&gt;
                      &lt;div&gt;Chunks: {ragStatus.chunkCount ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Upserted: {ragStatus.upsertedAt ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Dokument geändert: {ragStatus.docModifiedAt ?? &#39;—&#39;}&lt;/div&gt;
                      {ragStatus.totals &amp;&amp; (
                        &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;Index totals: {ragStatus.totals.docs} Docs, {ragStatus.totals.chunks} Chunks&lt;/div&gt;
                      )}
                      {ragStatus.docMeta &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Dokument-Metadaten&lt;/div&gt;
                          &lt;pre className=&quot;mt-1 max-h-44 overflow-auto whitespace-pre-wrap break-words text-xs bg-muted/30 p-2 rounded&quot;&gt;{JSON.stringify(ragStatus.docMeta, null, 2)}&lt;/pre&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus.toc &amp;&amp; Array.isArray(ragStatus.toc) &amp;&amp; ragStatus.toc.length &gt; 0 &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5&quot;&gt;
                            {ragStatus.toc.map((t: any, i: number) =&gt; (
                              &lt;li key={i} className=&quot;text-xs&quot;&gt;
                                {(t.title || t.chapterId) ?? &#39;Kapitel&#39;}
                                {typeof t.level === &#39;number&#39; ? ` (L${t.level})` : &#39;&#39;}
                                {typeof t.page === &#39;number&#39; ? ` · Seite ${t.page}` : &#39;&#39;}
                                {typeof t.order === &#39;number&#39; ? ` · Reihenfolge ${t.order}` : &#39;&#39;}
                                {typeof t.startChunk === &#39;number&#39; &amp;&amp; typeof t.endChunk === &#39;number&#39; ? ` · Chunks ${t.startChunk}-${t.endChunk}` : &#39;&#39;}
                              &lt;/li&gt;
                            ))}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus?.analyze?.chapters &amp;&amp; Array.isArray(ragStatus.analyze.chapters) &amp;&amp; (
                        &lt;div className=&quot;mt-3&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel (Heuristik/LLM)&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5 text-xs max-h-56 overflow-auto&quot;&gt;
                            {ragStatus.analyze.chapters.map((c: any) =&gt; (
                              &lt;li key={c.chapterId}&gt;
                                L{c.level} · {c.title} · Seiten {c.startPage ?? &#39;—&#39;}–{c.endPage ?? &#39;—&#39;}
                              &lt;/li&gt;
                            ))}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                    &lt;/div&gt;
                  )}
                &lt;/div&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;edit&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;TextEditor 
              content={content}
              provider={provider}
              onSaveAction={async (newContent: string) =&gt; {
                FileLogger.info(&#39;FilePreview&#39;, &#39;onSaveAction gestartet&#39;, {
                  itemId: item.id,
                  itemName: item.metadata.name,
                  contentLength: newContent.length,
                  hasProvider: !!provider,
                  hasOnRefreshFolder: !!onRefreshFolder
                });

                if (provider &amp;&amp; onRefreshFolder) {
                  try {
                    // Aktualisiere den lokalen State sofort
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Aktualisiere lokalen Content-State&#39;, {
                      oldContentLength: content.length,
                      newContentLength: newContent.length
                    });
                    onContentUpdated(newContent);

                    const blob = new Blob([newContent], { type: &#39;text/markdown&#39; });
                    const file = new File([blob], item.metadata.name, { type: &#39;text/markdown&#39; });

                    // Lösche die alte Datei
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lösche alte Datei&#39;, {
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    await provider.deleteItem(item.id);

                    // Lade die neue Datei hoch
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lade neue Datei hoch&#39;, {
                      fileName: file.name,
                      fileSize: file.size,
                      parentId: item.parentId
                    });
                    const updatedItem = await provider.uploadFile(item.parentId, file);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Upload abgeschlossen&#39;, {
                      success: !!updatedItem,
                      newItemId: updatedItem?.id,
                      newItemName: updatedItem?.metadata.name
                    });

                    // Aktualisiere den Cache mit dem neuen Inhalt und der neuen ID
                    if (updatedItem) {
                      // Lösche den alten Cache-Eintrag
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Lösche alten Eintrag&#39;, {
                        oldItemId: item.id,
                        cacheSize: contentCache.current.size
                      });
                      contentCache.current.delete(item.id);

                      // Füge den neuen Inhalt zum Cache hinzu
                      const hasMetadata = !!extractFrontmatter(newContent);
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Füge neuen Eintrag hinzu&#39;, {
                        newItemId: updatedItem.id,
                        hasMetadata,
                        contentLength: newContent.length
                      });
                      contentCache.current.set(updatedItem.id, { 
                        content: newContent, 
                        hasMetadata 
                      });

                      // Aktualisiere das selectedFileAtom mit der neuen Datei
                      FileLogger.info(&#39;FilePreview&#39;, &#39;Aktualisiere selectedFileAtom&#39;, {
                        oldId: item.id,
                        newId: updatedItem.id
                      });
                      setSelectedFile(updatedItem);
                    }

                    // Hole die aktualisierten Items
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Hole aktualisierte Dateiliste&#39;, {
                      parentId: item.parentId
                    });
                    const updatedItems = await provider.listItemsById(item.parentId);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Dateiliste aktualisiert&#39;, {
                      itemCount: updatedItems.length
                    });

                    // Wechsle zur Vorschau
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Wechsle zu Vorschau-Tab&#39;);
                    setActiveTab(&quot;preview&quot;);

                    // Informiere die übergeordnete Komponente
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Rufe onRefreshFolder auf&#39;, {
                      parentId: item.parentId,
                      updatedItemsCount: updatedItems.length,
                      updatedItemId: updatedItem?.id
                    });
                    onRefreshFolder(item.parentId, updatedItems, updatedItem);
                  } catch (error) {
                    FileLogger.error(&#39;FilePreview&#39;, &#39;Fehler beim Aktualisieren der Datei&#39;, {
                      error,
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    throw error; // Werfe den Fehler weiter, damit TextEditor ihn anzeigen kann
                  }
                } else {
                  FileLogger.warn(&#39;FilePreview&#39;, &#39;Speichern nicht möglich&#39;, {
                    hasProvider: !!provider,
                    hasOnRefreshFolder: !!onRefreshFolder
                  });
                  // Werfe einen Fehler, damit TextEditor ihn anzeigen kann
                  throw new Error(&#39;Speichern nicht möglich: onRefreshFolder Callback fehlt&#39;);
                }
              }}
                          /&gt;
              &lt;/TabsContent&gt;
            &lt;/div&gt;
          &lt;/Tabs&gt;
        &lt;/div&gt;
      );
    case &#39;pdf&#39;:
    case &#39;docx&#39;:
    case &#39;pptx&#39;:
    case &#39;xlsx&#39;:
    case &#39;presentation&#39;:
      return (
        &lt;DocumentPreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;website&#39;:
      const urlContent = content.match(/URL=(.*)/)?.[1];
      return urlContent ? (
        &lt;iframe 
          src={urlContent}
          title={item.metadata.name}
          className=&quot;w-full h-screen&quot;
        /&gt;
      ) : (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine gültige URL gefunden.
        &lt;/div&gt;
      );
    default:
      return (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine Vorschau verfügbar für diesen Dateityp.
        &lt;/div&gt;
      );
  }
}

// Definiere einen Typ für den State
interface FilePreviewState {
  content: string;
  error: string | null;
  hasMetadata: boolean;
}

// Hauptkomponente
export function FilePreview({ 
  className,
  provider,
  file,
  onRefreshFolder
}: FilePreviewProps) {
  const activeLibraryId = useAtomValue(activeLibraryIdAtom);
  const selectedFileFromAtom = useAtomValue(selectedFileAtom);

  // Verwende explizite file prop oder fallback zum selectedFileAtom
  const displayFile = file || selectedFileFromAtom;

  // Debug-Log für FilePreview-Hauptkomponente
  React.useEffect(() =&gt; {
    const timeoutId = setTimeout(() =&gt; {
      FileLogger.info(&#39;FilePreview&#39;, &#39;FilePreview-Hauptkomponente gerendert&#39;, {
        hasExplicitFile: !!file,
        hasSelectedFileFromAtom: !!selectedFileFromAtom,
        displayFileId: displayFile?.id,
        displayFileName: displayFile?.metadata.name,
        hasProvider: !!provider,
        providerName: provider?.name,
        activeLibraryId
      });
    }, 0);

    return () =&gt; clearTimeout(timeoutId);
  }, [file, selectedFileFromAtom, displayFile, provider, activeLibraryId]);

  // Gemeinsamer Cache für den Inhalt von Dateien
  const contentCache = React.useRef&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;(new Map());

  // Passe den Reducer an
  const reducer = React.useCallback((state: FilePreviewState, action: { type: string; content?: string; hasMetadata?: boolean; error?: string }) =&gt; {
    switch (action.type) {
      case &#39;SET_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39;, hasMetadata: action.hasMetadata ?? false };
      case &#39;SET_ERROR&#39;:
        return { ...state, error: action.error ?? null };
      case &#39;UPDATE_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39; };
      default:
        return state;
    }
  }, []);

  const [state, dispatch] = React.useReducer(reducer, {
    content: &#39;&#39;,
    error: null,
    hasMetadata: false
  });

  // Memoize computed values
  const fileType = React.useMemo(() =&gt; 
    displayFile ? getFileType(displayFile.metadata.name) : &#39;unknown&#39;, 
    [displayFile]
  );

  const isAudioFile = React.useMemo(() =&gt; fileType === &#39;audio&#39;, [fileType]);
  const isVideoFile = React.useMemo(() =&gt; fileType === &#39;video&#39;, [fileType]);

  // Debug-Log für computed values
  React.useEffect(() =&gt; {
    if (displayFile) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Computed values aktualisiert&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          fileType,
          isAudioFile,
          isVideoFile,
          mimeType: displayFile.metadata.mimeType
        });
      }, 0);

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile, fileType, isAudioFile, isVideoFile]);

  // Memoize content loader callback
  const handleContentLoaded = React.useCallback((content: string, hasMetadata: boolean) =&gt; {
    dispatch({ type: &#39;SET_CONTENT&#39;, content, hasMetadata });
  }, []);

  // Callback für direkte Aktualisierung des Inhalts
  const handleContentUpdated = React.useCallback((content: string) =&gt; {
    dispatch({ type: &#39;UPDATE_CONTENT&#39;, content });
  }, []);

  // Cache leeren, wenn sich die Item-ID ändert
  React.useEffect(() =&gt; {
    if (displayFile?.id) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Neues Item geladen, Cache wird geprüft&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          cacheSize: contentCache.current.size
        });
      }, 0);

      // Nur Cache-Einträge löschen, die nicht zur aktuellen Datei gehören
      const currentCache = contentCache.current.get(displayFile.id);
      if (!currentCache) {
        // Wenn die aktuelle Datei nicht im Cache ist, lösche alte Einträge
        Array.from(contentCache.current.keys()).forEach(key =&gt; {
          if (key !== displayFile.id) {
            contentCache.current.delete(key);
          }
        });
      }

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile?.id]);

  if (!displayFile) {
    return (
      &lt;div className={cn(&quot;flex items-center justify-center h-full&quot;, className)}&gt;
        &lt;p className=&quot;text-muted-foreground&quot;&gt;Keine Datei ausgewählt&lt;/p&gt;
      &lt;/div&gt;
    );
  }

  return (
    &lt;div className={cn(&quot;h-full flex flex-col&quot;, className)}&gt;
      &lt;ContentLoader
        item={displayFile}
        provider={provider}
        fileType={fileType}
        isAudioFile={isAudioFile}
        isVideoFile={isVideoFile}
        contentCache={contentCache}
        onContentLoaded={handleContentLoaded}
      /&gt;
      &lt;div className=&quot;flex-1 overflow-auto&quot;&gt;
        &lt;PreviewContent
          item={displayFile}
          fileType={fileType}
          content={state.content}
          error={state.error}
          activeLibraryId={activeLibraryId}
          provider={provider}
          contentCache={contentCache}
          onContentUpdated={handleContentUpdated}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">UpsertVector</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">[]</span>
<span class="w">  </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Robustes JSON-Parsing für HTTP-Antworten.</span>
<span class="cm"> * - Leerer Body =&gt; {} statt SyntaxError</span>
<span class="cm"> * - Ungültiges JSON =&gt; wir werfen mit gekürztem Body für Debugging</span>
<span class="cm"> */</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">parseJsonSafe</span><span class="p">(</span><span class="nx">res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">trimmed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">trimmed</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">trimmed</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Ungueltiges JSON (Status </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">): </span><span class="si">${</span><span class="nx">trimmed</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">upsertVectors</span><span class="p">(</span><span class="nx">indexHost</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">vectors</span><span class="o">:</span><span class="w"> </span><span class="kt">UpsertVector</span><span class="p">[])</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://</span><span class="si">${</span><span class="nx">indexHost</span><span class="si">}</span><span class="sb">/vectors/upsert`</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;Api-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">vectors</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Pinecone Upsert Fehler: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">err</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Upsert in kleinen Batches, um Pinecone 2MB Request-Limit einzuhalten.</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">upsertVectorsChunked</span><span class="p">(</span><span class="nx">indexHost</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">vectors</span><span class="o">:</span><span class="w"> </span><span class="kt">UpsertVector</span><span class="p">[],</span><span class="w"> </span><span class="nx">maxPerBatch</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">vectors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">maxPerBatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vectors</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">maxPerBatch</span><span class="p">)</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">upsertVectors</span><span class="p">(</span><span class="nx">indexHost</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">batch</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">QueryMatch</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="nx">score?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="w">  </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">queryVectors</span><span class="p">(</span><span class="nx">indexHost</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">vector</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">[],</span><span class="w"> </span><span class="nx">topK</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">filter?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">QueryMatch</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://</span><span class="si">${</span><span class="nx">indexHost</span><span class="si">}</span><span class="sb">/query`</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Api-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">vector</span><span class="p">,</span><span class="w"> </span><span class="nx">topK</span><span class="p">,</span><span class="w"> </span><span class="nx">includeMetadata</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">filter</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Pinecone Query Fehler: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">err</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">parseJsonSafe</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">matches?</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">score?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">matches</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">matches</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">matches</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">m</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">QueryMatch</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span><span class="p">((</span><span class="nx">m</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">id</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">scoreVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">score?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">score</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">scoreVal</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">scoreVal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="w"> </span><span class="p">}).</span><span class="nx">metadata</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">metadata</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">metadata</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">metadata</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">meta</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchVectors</span><span class="p">(</span><span class="nx">indexHost</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">ids</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span><span class="w"> </span><span class="nx">namespace</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://</span><span class="si">${</span><span class="nx">indexHost</span><span class="si">}</span><span class="sb">/vectors/fetch`</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Api-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">ids</span><span class="p">,</span><span class="w"> </span><span class="nx">includeMetadata</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Pinecone Fetch Fehler: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">err</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">parseJsonSafe</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">vectors?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">vectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">vectors</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">out</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">vectors</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">out</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">k</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">vectors</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">out</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">(</span><span class="nx">indexName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`https://api.pinecone.io/indexes/</span><span class="si">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">indexName</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Api-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span>
<span class="w">  </span><span class="p">})</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">parseJsonSafe</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">host?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">host</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteByFilter</span><span class="p">(</span><span class="nx">indexHost</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">filter</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://</span><span class="si">${</span><span class="nx">indexHost</span><span class="si">}</span><span class="sb">/vectors/delete`</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;Api-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">deleteAll</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">ids</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">filter</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">})</span>
<span class="w">  </span><span class="c1">// Wenn Namespace noch nicht existiert (erste Benutzung), kann Pinecone 404 &quot;Namespace not found&quot; liefern.</span>
<span class="w">  </span><span class="c1">// Das ist in diesem Fall unkritisch: Wir wollen ja nur sicherstellen, dass nichts Altes vorhanden ist.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">404</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Pinecone Delete Fehler: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">err</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Ich behebe die verbleibenden Lint-Fehler: ungenutzter Request-Parameter in der Pinecone-Health-Route und explizite any-Typen in <code>file-preview.tsx</code>. Danach baue ich erneut.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_API_KEY</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PINECONE_API_KEY fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.pinecone.io/indexes&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Api-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="c1">// Verhindert Next.js Caching der Management-Abfrage</span>
<span class="w">      </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}))</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">res.status</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">data?.message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Fehler von Pinecone&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_INDEX</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">indexes</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">indexes</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">indexes</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasExpected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">indexes</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">indexes</span><span class="p">,</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="o">:</span><span class="w"> </span><span class="kt">hasExpected</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Interner Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import * as React from &#39;react&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Alert, AlertDescription } from &quot;@/components/ui/alert&quot;;
import { AlertCircle } from &quot;lucide-react&quot;;
import { AudioPlayer } from &#39;./audio-player&#39;;
import { VideoPlayer } from &#39;./video-player&#39;;
import { MarkdownPreview } from &#39;./markdown-preview&#39;;
import { Tabs, TabsContent, TabsList, TabsTrigger } from &quot;@/components/ui/tabs&quot;;
import &#39;./markdown-audio&#39;;
import { useAtomValue, useSetAtom } from &quot;jotai&quot;;
import { activeLibraryIdAtom, selectedFileAtom } from &quot;@/atoms/library-atom&quot;;
import { TextEditor } from &#39;./text-editor&#39;;
import { StorageItem, StorageProvider } from &quot;@/lib/storage/types&quot;;
import { extractFrontmatter } from &#39;./markdown-metadata&#39;;
import { ImagePreview } from &#39;./image-preview&#39;;
import { DocumentPreview } from &#39;./document-preview&#39;;
import { FileLogger } from &quot;@/lib/debug/logger&quot;

// Explizite React-Komponenten-Deklarationen für den Linter
const ImagePreviewComponent = ImagePreview;
const DocumentPreviewComponent = DocumentPreview;

interface FilePreviewProps {
  className?: string;
  provider: StorageProvider | null;
  file?: StorageItem | null; // Neue prop für explizite Datei-Auswahl
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}

// Helper function for file type detection
function getFileType(fileName: string): string {
  const extension = fileName.split(&#39;.&#39;).pop()?.toLowerCase();

  switch(extension) {
    case &#39;txt&#39;:
    case &#39;md&#39;:
    case &#39;mdx&#39;:
      return &#39;markdown&#39;;
    case &#39;mp4&#39;:
    case &#39;avi&#39;:
    case &#39;mov&#39;:
    case &#39;webm&#39;:
    case &#39;mkv&#39;:
      return &#39;video&#39;;
    case &#39;mp3&#39;:
    case &#39;m4a&#39;:
    case &#39;wav&#39;:
    case &#39;ogg&#39;:
    case &#39;opus&#39;:
    case &#39;flac&#39;:
      return &#39;audio&#39;;
    case &#39;jpg&#39;:
    case &#39;jpeg&#39;:
    case &#39;png&#39;:
    case &#39;gif&#39;:
    case &#39;webp&#39;:
    case &#39;svg&#39;:
    case &#39;bmp&#39;:
    case &#39;ico&#39;:
      return &#39;image&#39;;
    case &#39;pdf&#39;:
      return &#39;pdf&#39;;
    case &#39;doc&#39;:
    case &#39;docx&#39;:
      return &#39;docx&#39;;
    case &#39;odt&#39;:
      return &#39;docx&#39;;
    case &#39;ppt&#39;:
    case &#39;pptx&#39;:
      return &#39;pptx&#39;;
    case &#39;xls&#39;:
    case &#39;xlsx&#39;:
      return &#39;xlsx&#39;;
    case &#39;url&#39;:
      return &#39;website&#39;;
    default:
      // Für unbekannte Dateitypen prüfen wir, ob es sich um eine Textdatei handeln könnte
      const textExtensions = [&#39;json&#39;, &#39;xml&#39;, &#39;yaml&#39;, &#39;yml&#39;, &#39;ini&#39;, &#39;cfg&#39;, &#39;conf&#39;, &#39;log&#39;, &#39;csv&#39;, &#39;html&#39;, &#39;htm&#39;, &#39;css&#39;, &#39;js&#39;, &#39;ts&#39;, &#39;jsx&#39;, &#39;tsx&#39;, &#39;py&#39;, &#39;java&#39;, &#39;c&#39;, &#39;cpp&#39;, &#39;h&#39;, &#39;hpp&#39;, &#39;cs&#39;, &#39;php&#39;, &#39;rb&#39;, &#39;go&#39;, &#39;rs&#39;, &#39;swift&#39;, &#39;kt&#39;, &#39;scala&#39;, &#39;r&#39;, &#39;sh&#39;, &#39;bash&#39;, &#39;ps1&#39;, &#39;bat&#39;, &#39;cmd&#39;, &#39;odt&#39;];
      if (textExtensions.includes(extension || &#39;&#39;)) {
        return &#39;markdown&#39;; // Behandle als editierbare Textdatei
      }
      return &#39;unknown&#39;;
  }
}

// Separate Komponente für den Content Loader
function ContentLoader({ 
  item, 
  provider, 
  fileType, 
  isAudioFile, 
  isVideoFile, 
  contentCache,
  onContentLoaded 
}: {
  item: StorageItem | null;
  provider: StorageProvider | null;
  fileType: string;
  isAudioFile: boolean;
  isVideoFile: boolean;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentLoaded: (content: string, hasMetadata: boolean) =&gt; void;
}) {
  const loadingIdRef = React.useRef&lt;string | null&gt;(null);

  // Prüft ob eine Datei ein Template ist
  const isTemplateFile = React.useCallback((name?: string): boolean =&gt; {
    if (!name) return false;
    return name.includes(&#39;{{&#39;) &amp;&amp; name.includes(&#39;}}&#39;);
  }, []);

  const loadContent = React.useCallback(async () =&gt; {
    if (!item?.id || !provider) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;loadContent abgebrochen&#39;, {
        hasItem: !!item?.id,
        hasProvider: !!provider
      });
      return;
    }

    FileLogger.info(&#39;ContentLoader&#39;, &#39;Lade Content für Datei&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      cacheSize: contentCache.current.size
    });

    // Prüfen ob Inhalt bereits im Cache
    const cachedContent = contentCache.current.get(item.id);
    if (cachedContent) {
      FileLogger.info(&#39;ContentLoader&#39;, &#39;Content aus Cache geladen&#39;, {
        itemId: item.id,
        contentLength: cachedContent.content.length,
        hasMetadata: cachedContent.hasMetadata
      });
      onContentLoaded(cachedContent.content, cachedContent.hasMetadata);
      return;
    }

    // Prüfen ob bereits ein Ladevorgang läuft
    if (loadingIdRef.current === item.id) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;Ladevorgang läuft bereits&#39;, {
        itemId: item.id
      });
      return;
    }

    loadingIdRef.current = item.id;

    try {
      // Wenn es eine Template-Datei ist, zeigen wir eine Warnung an
      if (isTemplateFile(item.metadata.name)) {
        const content = &quot;---\nstatus: template\n---\n\n&gt; **Hinweis**: Diese Datei enthält nicht aufgelöste Template-Variablen.\n&gt; Bitte stellen Sie sicher, dass alle Variablen korrekt definiert sind.&quot;;
        contentCache.current.set(item.id, { content, hasMetadata: true });
        onContentLoaded(content, true);
        return;
      }

      // Liste der Dateitypen, die als Binärdateien behandelt werden sollen
      const binaryFileTypes = [&#39;audio&#39;, &#39;image&#39;, &#39;video&#39;, &#39;pdf&#39;, &#39;docx&#39;, &#39;pptx&#39;, &#39;xlsx&#39;];

      if (!binaryFileTypes.includes(fileType) &amp;&amp; fileType !== &#39;unknown&#39;) {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Lade Textinhalt von Provider&#39;, {
          itemId: item.id,
          fileType
        });
        const content = await provider.getBinary(item.id).then(({ blob }) =&gt; blob.text());
        const hasMetadata = !!extractFrontmatter(content);

        FileLogger.info(&#39;ContentLoader&#39;, &#39;Content geladen und in Cache gespeichert&#39;, {
          itemId: item.id,
          contentLength: content.length,
          hasMetadata
        });

        contentCache.current.set(item.id, { content, hasMetadata });
        onContentLoaded(content, hasMetadata);
      } else {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Überspringe Content-Laden für Binary/Unknown-Datei&#39;, {
          itemId: item.id,
          fileType,
          isBinary: binaryFileTypes.includes(fileType),
          isUnknown: fileType === &#39;unknown&#39;
        });
        contentCache.current.set(item.id, { content: &#39;&#39;, hasMetadata: false });
        onContentLoaded(&#39;&#39;, false);
      }
    } catch (err) {
      FileLogger.error(&#39;ContentLoader&#39;, &#39;Failed to load file&#39;, err);
      // Bei Fehler zeigen wir eine Fehlermeldung im Markdown-Format
      const errorContent = &quot;---\nstatus: error\n---\n\n&gt; **Fehler**: Die Datei konnte nicht geladen werden.\n&gt; Bitte überprüfen Sie die Konsole für weitere Details.&quot;;
      contentCache.current.set(item.id, { content: errorContent, hasMetadata: true });
      onContentLoaded(errorContent, true);
    } finally {
      loadingIdRef.current = null;
    }
  }, [item?.id, item?.metadata?.name, provider, fileType, isAudioFile, isVideoFile, onContentLoaded, isTemplateFile, contentCache]);

  // Cleanup bei Unmount
  React.useEffect(() =&gt; {
    return () =&gt; {
      loadingIdRef.current = null;
    };
  }, []);

  // Nur laden wenn sich die ID ändert
  React.useEffect(() =&gt; {
    if (item?.id) {
      loadContent();
    }
  }, [item?.id, loadContent]);

  return null;
}

// Separate Komponente für die Vorschau
function PreviewContent({ 
  item, 
  fileType, 
  content, 
  error, 
  activeLibraryId,
  provider,
  contentCache,
  onContentUpdated,
  onRefreshFolder
}: {
  item: StorageItem;
  fileType: string;
  content: string;
  error: string | null;
  activeLibraryId: string;
  provider: StorageProvider | null;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentUpdated: (content: string) =&gt; void;
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}) {
  const [activeTab, setActiveTab] = React.useState&lt;string&gt;(&quot;preview&quot;);
  const [ragLoading, setRagLoading] = React.useState(false);
  const [ragError, setRagError] = React.useState&lt;string | null&gt;(null);
  const [ragStatus, setRagStatus] = React.useState&lt;{
    status: &#39;ok&#39; | &#39;stale&#39; | &#39;not_indexed&#39;;
    fileName?: string;
    chunkCount?: number;
    upsertedAt?: string;
    docModifiedAt?: string;
    docMeta?: Record&lt;string, unknown&gt;;
    toc?: Array&lt;Record&lt;string, unknown&gt;&gt;;
    totals?: { docs: number; chunks: number };
  } | null&gt;(null);
  const setSelectedFile = useSetAtom(selectedFileAtom);

  // Debug-Log für PreviewContent
  React.useEffect(() =&gt; {
    FileLogger.info(&#39;PreviewContent&#39;, &#39;PreviewContent gerendert&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      fileType,
      contentLength: content.length,
      hasError: !!error,
      hasProvider: !!provider,
      activeLibraryId
    });
  }, [item.id, fileType, content.length, error, provider, activeLibraryId]);

  React.useEffect(() =&gt; {
    setActiveTab(&quot;preview&quot;);
  }, [item.id]);

  async function loadRagStatus() {
    try {
      setRagLoading(true);
      setRagError(null);
      const docMod = (() =&gt; {
        const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
        const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
        return dt ? dt.toISOString() : undefined;
      })();
      const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/file-status?fileId=${encodeURIComponent(item.id)}${docMod ? `&amp;docModifiedAt=${encodeURIComponent(docMod)}` : &#39;&#39;}`, { cache: &#39;no-store&#39; });
      const data = await res.json();
      if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Status konnte nicht geladen werden&#39;);
      // Library-Stats parallel
      const statsRes = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/stats`, { cache: &#39;no-store&#39; });
      const stats = await statsRes.json().catch(() =&gt; ({}));
      setRagStatus({ ...data, totals: stats?.totals });
    } catch (e) {
      setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;);
    } finally {
      setRagLoading(false);
    }
  }

  if (error) {
    FileLogger.error(&#39;PreviewContent&#39;, &#39;Fehler in PreviewContent&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      error
    });
    return &lt;Alert variant=&quot;destructive&quot;&gt;&lt;AlertCircle className=&quot;h-4 w-4&quot; /&gt;&lt;AlertDescription&gt;{error}&lt;/AlertDescription&gt;&lt;/Alert&gt;;
  }

  // Debug-Log vor Switch-Statement
  FileLogger.debug(&#39;PreviewContent&#39;, &#39;Switch-Statement erreicht&#39;, {
    itemId: item.id,
    itemName: item.metadata.name,
    fileType,
    switchCase: fileType
  });

  switch (fileType) {
    case &#39;audio&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Audio-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;AudioPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;image&#39;:
      FileLogger.info(&#39;PreviewContent&#39;, &#39;ImagePreview wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        mimeType: item.metadata.mimeType,
        hasProvider: !!provider,
        providerName: provider?.name
      });
      return (
        &lt;ImagePreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;video&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Video-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;VideoPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;markdown&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Markdown-Editor wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        contentLength: content.length
      });
      return (
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;Tabs defaultValue=&quot;preview&quot; value={activeTab} onValueChange={setActiveTab} className=&quot;h-full flex flex-col&quot;&gt;
            &lt;TabsList className=&quot;mx-4 mt-2 flex-shrink-0&quot;&gt;
              &lt;TabsTrigger value=&quot;preview&quot;&gt;Vorschau&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;edit&quot;&gt;Bearbeiten&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;rag&quot; onClick={() =&gt; { void loadRagStatus(); }}&gt;RAG&lt;/TabsTrigger&gt;
            &lt;/TabsList&gt;
            &lt;div className=&quot;flex-1 min-h-0&quot;&gt;
              &lt;TabsContent value=&quot;preview&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;flex items-center gap-2 px-4 py-2&quot;&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (A)&#39;)
                        console.log(&#39;[Upsert A] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert A] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert A
                  &lt;/button&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;B&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (B)&#39;)
                        console.log(&#39;[Upsert B] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert B] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert B
                  &lt;/button&gt;
                &lt;/div&gt;
                &lt;MarkdownPreview 
                  content={content}
                  currentFolderId={item.parentId}
                  provider={provider}
                  className=&quot;h-full&quot;
                  onTransform={() =&gt; setActiveTab(&quot;edit&quot;)}
                  onRefreshFolder={onRefreshFolder}
                /&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;rag&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;p-4 space-y-3&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between&quot;&gt;
                    &lt;div className=&quot;text-sm font-medium&quot;&gt;RAG-Status&lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={() =&gt; void loadRagStatus()}
                      &gt;
                        Aktualisieren
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content, mode: &#39;llm&#39; })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse (LLM) fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse (LLM)&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse (LLM)
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert&#39;);
                          }
                        }}
                      &gt;
                        Upsert
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary/70 text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const chaptersSrcUnknown: unknown = (ragStatus as unknown as { analyze?: { chapters?: unknown } })?.analyze?.chapters
                            const chaptersSrc: Array&lt;unknown&gt; | undefined = Array.isArray(chaptersSrcUnknown) ? chaptersSrcUnknown : undefined
                            if (!Array.isArray(chaptersSrc) || chaptersSrc.length === 0) {
                              throw new Error(&#39;Keine Kapitelanalyse vorhanden&#39;)
                            }
                            const chapters = chaptersSrc
                              .filter((c): c is { chapterId?: unknown; title?: unknown; summary?: unknown; keywords?: unknown } =&gt; !!c &amp;&amp; typeof c === &#39;object&#39; &amp;&amp; typeof (c as Record&lt;string, unknown&gt;).summary === &#39;string&#39; &amp;&amp; (c as Record&lt;string, unknown&gt;).summary!.trim().length &gt; 0)
                              .map((c, i) =&gt; {
                                const obj = c as Record&lt;string, unknown&gt;
                                const chapterId = typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : `chap-${i + 1}`
                                const title = typeof obj.title === &#39;string&#39; ? obj.title : `Kapitel ${i + 1}`
                                const summary = String(obj.summary).slice(0, 1200)
                                const keywords = Array.isArray(obj.keywords) ? (obj.keywords as Array&lt;unknown&gt;).filter(k =&gt; typeof k === &#39;string&#39;).slice(0, 12) as string[] : undefined
                                return { chapterId, title, order: i + 1, summary, keywords }
                              })
                            if (chapters.length === 0) throw new Error(&#39;Keine Kapitel mit Summary gefunden&#39;)

                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const tocUnknown: unknown = (ragStatus as unknown as { analyze?: { toc?: unknown } })?.analyze?.toc
                            const toc: Array&lt;unknown&gt; | undefined = Array.isArray(tocUnknown) ? tocUnknown : undefined
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod, chapters, toc })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert (Analyse) fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert (Analyse)&#39;);
                          }
                        }}
                      &gt;
                        Upsert (Analyse)
                      &lt;/button&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  {ragLoading &amp;&amp; &lt;div className=&quot;text-sm text-muted-foreground&quot;&gt;Lade Status…&lt;/div&gt;}
                  {ragError &amp;&amp; &lt;div className=&quot;text-sm text-destructive&quot;&gt;{ragError}&lt;/div&gt;}
                  {ragStatus &amp;&amp; (
                    &lt;div className=&quot;space-y-2 text-sm&quot;&gt;
                      &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                        &lt;span&gt;Status:&lt;/span&gt;
                        &lt;span className={cn(
                          &#39;inline-flex items-center rounded px-2 py-0.5 text-xs&#39;,
                          ragStatus.status === &#39;ok&#39; &amp;&amp; &#39;bg-green-100 text-green-700&#39;,
                          ragStatus.status === &#39;stale&#39; &amp;&amp; &#39;bg-amber-100 text-amber-800&#39;,
                          ragStatus.status === &#39;not_indexed&#39; &amp;&amp; &#39;bg-gray-100 text-gray-700&#39;
                        )}&gt;
                          {ragStatus.status}
                        &lt;/span&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;fileId: {ragStatus?.fileName ? &#39;&#39; : &#39;&#39;}{(item.id)}&lt;/div&gt;
                      &lt;div&gt;Chunks: {ragStatus.chunkCount ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Upserted: {ragStatus.upsertedAt ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Dokument geändert: {ragStatus.docModifiedAt ?? &#39;—&#39;}&lt;/div&gt;
                      {ragStatus.totals &amp;&amp; (
                        &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;Index totals: {ragStatus.totals.docs} Docs, {ragStatus.totals.chunks} Chunks&lt;/div&gt;
                      )}
                      {ragStatus.docMeta &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Dokument-Metadaten&lt;/div&gt;
                          &lt;pre className=&quot;mt-1 max-h-44 overflow-auto whitespace-pre-wrap break-words text-xs bg-muted/30 p-2 rounded&quot;&gt;{JSON.stringify(ragStatus.docMeta, null, 2)}&lt;/pre&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus.toc &amp;&amp; Array.isArray(ragStatus.toc) &amp;&amp; ragStatus.toc.length &gt; 0 &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5&quot;&gt;
                            {ragStatus.toc.map((t: any, i: number) =&gt; (
                              &lt;li key={i} className=&quot;text-xs&quot;&gt;
                                {(t.title || t.chapterId) ?? &#39;Kapitel&#39;}
                                {typeof t.level === &#39;number&#39; ? ` (L${t.level})` : &#39;&#39;}
                                {typeof t.page === &#39;number&#39; ? ` · Seite ${t.page}` : &#39;&#39;}
                                {typeof t.order === &#39;number&#39; ? ` · Reihenfolge ${t.order}` : &#39;&#39;}
                                {typeof t.startChunk === &#39;number&#39; &amp;&amp; typeof t.endChunk === &#39;number&#39; ? ` · Chunks ${t.startChunk}-${t.endChunk}` : &#39;&#39;}
                              &lt;/li&gt;
                            ))}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus?.analyze?.chapters &amp;&amp; Array.isArray(ragStatus.analyze.chapters) &amp;&amp; (
                        &lt;div className=&quot;mt-3&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel (Heuristik/LLM)&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5 text-xs max-h-56 overflow-auto&quot;&gt;
                            {ragStatus.analyze.chapters.map((c: any) =&gt; (
                              &lt;li key={c.chapterId}&gt;
                                L{c.level} · {c.title} · Seiten {c.startPage ?? &#39;—&#39;}–{c.endPage ?? &#39;—&#39;}
                              &lt;/li&gt;
                            ))}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                    &lt;/div&gt;
                  )}
                &lt;/div&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;edit&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;TextEditor 
              content={content}
              provider={provider}
              onSaveAction={async (newContent: string) =&gt; {
                FileLogger.info(&#39;FilePreview&#39;, &#39;onSaveAction gestartet&#39;, {
                  itemId: item.id,
                  itemName: item.metadata.name,
                  contentLength: newContent.length,
                  hasProvider: !!provider,
                  hasOnRefreshFolder: !!onRefreshFolder
                });

                if (provider &amp;&amp; onRefreshFolder) {
                  try {
                    // Aktualisiere den lokalen State sofort
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Aktualisiere lokalen Content-State&#39;, {
                      oldContentLength: content.length,
                      newContentLength: newContent.length
                    });
                    onContentUpdated(newContent);

                    const blob = new Blob([newContent], { type: &#39;text/markdown&#39; });
                    const file = new File([blob], item.metadata.name, { type: &#39;text/markdown&#39; });

                    // Lösche die alte Datei
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lösche alte Datei&#39;, {
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    await provider.deleteItem(item.id);

                    // Lade die neue Datei hoch
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lade neue Datei hoch&#39;, {
                      fileName: file.name,
                      fileSize: file.size,
                      parentId: item.parentId
                    });
                    const updatedItem = await provider.uploadFile(item.parentId, file);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Upload abgeschlossen&#39;, {
                      success: !!updatedItem,
                      newItemId: updatedItem?.id,
                      newItemName: updatedItem?.metadata.name
                    });

                    // Aktualisiere den Cache mit dem neuen Inhalt und der neuen ID
                    if (updatedItem) {
                      // Lösche den alten Cache-Eintrag
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Lösche alten Eintrag&#39;, {
                        oldItemId: item.id,
                        cacheSize: contentCache.current.size
                      });
                      contentCache.current.delete(item.id);

                      // Füge den neuen Inhalt zum Cache hinzu
                      const hasMetadata = !!extractFrontmatter(newContent);
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Füge neuen Eintrag hinzu&#39;, {
                        newItemId: updatedItem.id,
                        hasMetadata,
                        contentLength: newContent.length
                      });
                      contentCache.current.set(updatedItem.id, { 
                        content: newContent, 
                        hasMetadata 
                      });

                      // Aktualisiere das selectedFileAtom mit der neuen Datei
                      FileLogger.info(&#39;FilePreview&#39;, &#39;Aktualisiere selectedFileAtom&#39;, {
                        oldId: item.id,
                        newId: updatedItem.id
                      });
                      setSelectedFile(updatedItem);
                    }

                    // Hole die aktualisierten Items
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Hole aktualisierte Dateiliste&#39;, {
                      parentId: item.parentId
                    });
                    const updatedItems = await provider.listItemsById(item.parentId);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Dateiliste aktualisiert&#39;, {
                      itemCount: updatedItems.length
                    });

                    // Wechsle zur Vorschau
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Wechsle zu Vorschau-Tab&#39;);
                    setActiveTab(&quot;preview&quot;);

                    // Informiere die übergeordnete Komponente
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Rufe onRefreshFolder auf&#39;, {
                      parentId: item.parentId,
                      updatedItemsCount: updatedItems.length,
                      updatedItemId: updatedItem?.id
                    });
                    onRefreshFolder(item.parentId, updatedItems, updatedItem);
                  } catch (error) {
                    FileLogger.error(&#39;FilePreview&#39;, &#39;Fehler beim Aktualisieren der Datei&#39;, {
                      error,
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    throw error; // Werfe den Fehler weiter, damit TextEditor ihn anzeigen kann
                  }
                } else {
                  FileLogger.warn(&#39;FilePreview&#39;, &#39;Speichern nicht möglich&#39;, {
                    hasProvider: !!provider,
                    hasOnRefreshFolder: !!onRefreshFolder
                  });
                  // Werfe einen Fehler, damit TextEditor ihn anzeigen kann
                  throw new Error(&#39;Speichern nicht möglich: onRefreshFolder Callback fehlt&#39;);
                }
              }}
                          /&gt;
              &lt;/TabsContent&gt;
            &lt;/div&gt;
          &lt;/Tabs&gt;
        &lt;/div&gt;
      );
    case &#39;pdf&#39;:
    case &#39;docx&#39;:
    case &#39;pptx&#39;:
    case &#39;xlsx&#39;:
    case &#39;presentation&#39;:
      return (
        &lt;DocumentPreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;website&#39;:
      const urlContent = content.match(/URL=(.*)/)?.[1];
      return urlContent ? (
        &lt;iframe 
          src={urlContent}
          title={item.metadata.name}
          className=&quot;w-full h-screen&quot;
        /&gt;
      ) : (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine gültige URL gefunden.
        &lt;/div&gt;
      );
    default:
      return (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine Vorschau verfügbar für diesen Dateityp.
        &lt;/div&gt;
      );
  }
}

// Definiere einen Typ für den State
interface FilePreviewState {
  content: string;
  error: string | null;
  hasMetadata: boolean;
}

// Hauptkomponente
export function FilePreview({ 
  className,
  provider,
  file,
  onRefreshFolder
}: FilePreviewProps) {
  const activeLibraryId = useAtomValue(activeLibraryIdAtom);
  const selectedFileFromAtom = useAtomValue(selectedFileAtom);

  // Verwende explizite file prop oder fallback zum selectedFileAtom
  const displayFile = file || selectedFileFromAtom;

  // Debug-Log für FilePreview-Hauptkomponente
  React.useEffect(() =&gt; {
    const timeoutId = setTimeout(() =&gt; {
      FileLogger.info(&#39;FilePreview&#39;, &#39;FilePreview-Hauptkomponente gerendert&#39;, {
        hasExplicitFile: !!file,
        hasSelectedFileFromAtom: !!selectedFileFromAtom,
        displayFileId: displayFile?.id,
        displayFileName: displayFile?.metadata.name,
        hasProvider: !!provider,
        providerName: provider?.name,
        activeLibraryId
      });
    }, 0);

    return () =&gt; clearTimeout(timeoutId);
  }, [file, selectedFileFromAtom, displayFile, provider, activeLibraryId]);

  // Gemeinsamer Cache für den Inhalt von Dateien
  const contentCache = React.useRef&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;(new Map());

  // Passe den Reducer an
  const reducer = React.useCallback((state: FilePreviewState, action: { type: string; content?: string; hasMetadata?: boolean; error?: string }) =&gt; {
    switch (action.type) {
      case &#39;SET_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39;, hasMetadata: action.hasMetadata ?? false };
      case &#39;SET_ERROR&#39;:
        return { ...state, error: action.error ?? null };
      case &#39;UPDATE_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39; };
      default:
        return state;
    }
  }, []);

  const [state, dispatch] = React.useReducer(reducer, {
    content: &#39;&#39;,
    error: null,
    hasMetadata: false
  });

  // Memoize computed values
  const fileType = React.useMemo(() =&gt; 
    displayFile ? getFileType(displayFile.metadata.name) : &#39;unknown&#39;, 
    [displayFile]
  );

  const isAudioFile = React.useMemo(() =&gt; fileType === &#39;audio&#39;, [fileType]);
  const isVideoFile = React.useMemo(() =&gt; fileType === &#39;video&#39;, [fileType]);

  // Debug-Log für computed values
  React.useEffect(() =&gt; {
    if (displayFile) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Computed values aktualisiert&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          fileType,
          isAudioFile,
          isVideoFile,
          mimeType: displayFile.metadata.mimeType
        });
      }, 0);

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile, fileType, isAudioFile, isVideoFile]);

  // Memoize content loader callback
  const handleContentLoaded = React.useCallback((content: string, hasMetadata: boolean) =&gt; {
    dispatch({ type: &#39;SET_CONTENT&#39;, content, hasMetadata });
  }, []);

  // Callback für direkte Aktualisierung des Inhalts
  const handleContentUpdated = React.useCallback((content: string) =&gt; {
    dispatch({ type: &#39;UPDATE_CONTENT&#39;, content });
  }, []);

  // Cache leeren, wenn sich die Item-ID ändert
  React.useEffect(() =&gt; {
    if (displayFile?.id) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Neues Item geladen, Cache wird geprüft&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          cacheSize: contentCache.current.size
        });
      }, 0);

      // Nur Cache-Einträge löschen, die nicht zur aktuellen Datei gehören
      const currentCache = contentCache.current.get(displayFile.id);
      if (!currentCache) {
        // Wenn die aktuelle Datei nicht im Cache ist, lösche alte Einträge
        Array.from(contentCache.current.keys()).forEach(key =&gt; {
          if (key !== displayFile.id) {
            contentCache.current.delete(key);
          }
        });
      }

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile?.id]);

  if (!displayFile) {
    return (
      &lt;div className={cn(&quot;flex items-center justify-center h-full&quot;, className)}&gt;
        &lt;p className=&quot;text-muted-foreground&quot;&gt;Keine Datei ausgewählt&lt;/p&gt;
      &lt;/div&gt;
    );
  }

  return (
    &lt;div className={cn(&quot;h-full flex flex-col&quot;, className)}&gt;
      &lt;ContentLoader
        item={displayFile}
        provider={provider}
        fileType={fileType}
        isAudioFile={isAudioFile}
        isVideoFile={isVideoFile}
        contentCache={contentCache}
        onContentLoaded={handleContentLoaded}
      /&gt;
      &lt;div className=&quot;flex-1 overflow-auto&quot;&gt;
        &lt;PreviewContent
          item={displayFile}
          fileType={fileType}
          content={state.content}
          error={state.error}
          activeLibraryId={activeLibraryId}
          provider={provider}
          contentCache={contentCache}
          onContentUpdated={handleContentUpdated}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Ich behebe zuerst die restlichen Lint-Fehler und setze den TODO-Status passend. Danach starte ich den Build erneut.</p>
<p>Ich fixiere die letzten Lint-Fehler (ungenuzte Import in <code>api/health/pinecone/route.ts</code> und <code>any</code>-Parameter in <code>file-preview.tsx</code>), dann baue ich erneut.</p>
<p>Ich behebe die verbleibenden Lint-Fehler: entferne den ungenutzten Import in <code>api/health/pinecone/route.ts</code> und lokalisiere die restlichen <code>any</code>-Stellen in <code>src/components/library/file-preview.tsx</code>. Danach baue ich erneut.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_API_KEY</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PINECONE_API_KEY fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.pinecone.io/indexes&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Api-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="c1">// Verhindert Next.js Caching der Management-Abfrage</span>
<span class="w">      </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}))</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">res.status</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">data?.message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Fehler von Pinecone&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_INDEX</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">indexes</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">indexes</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">indexes</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasExpected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">indexes</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">indexes</span><span class="p">,</span><span class="w"> </span><span class="nx">expectedIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="o">:</span><span class="w"> </span><span class="kt">hasExpected</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">ok</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Interner Fehler&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import * as React from &#39;react&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Alert, AlertDescription } from &quot;@/components/ui/alert&quot;;
import { AlertCircle } from &quot;lucide-react&quot;;
import { AudioPlayer } from &#39;./audio-player&#39;;
import { VideoPlayer } from &#39;./video-player&#39;;
import { MarkdownPreview } from &#39;./markdown-preview&#39;;
import { Tabs, TabsContent, TabsList, TabsTrigger } from &quot;@/components/ui/tabs&quot;;
import &#39;./markdown-audio&#39;;
import { useAtomValue, useSetAtom } from &quot;jotai&quot;;
import { activeLibraryIdAtom, selectedFileAtom } from &quot;@/atoms/library-atom&quot;;
import { TextEditor } from &#39;./text-editor&#39;;
import { StorageItem, StorageProvider } from &quot;@/lib/storage/types&quot;;
import { extractFrontmatter } from &#39;./markdown-metadata&#39;;
import { ImagePreview } from &#39;./image-preview&#39;;
import { DocumentPreview } from &#39;./document-preview&#39;;
import { FileLogger } from &quot;@/lib/debug/logger&quot;

// Explizite React-Komponenten-Deklarationen für den Linter
const ImagePreviewComponent = ImagePreview;
const DocumentPreviewComponent = DocumentPreview;

interface FilePreviewProps {
  className?: string;
  provider: StorageProvider | null;
  file?: StorageItem | null; // Neue prop für explizite Datei-Auswahl
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}

// Helper function for file type detection
function getFileType(fileName: string): string {
  const extension = fileName.split(&#39;.&#39;).pop()?.toLowerCase();

  switch(extension) {
    case &#39;txt&#39;:
    case &#39;md&#39;:
    case &#39;mdx&#39;:
      return &#39;markdown&#39;;
    case &#39;mp4&#39;:
    case &#39;avi&#39;:
    case &#39;mov&#39;:
    case &#39;webm&#39;:
    case &#39;mkv&#39;:
      return &#39;video&#39;;
    case &#39;mp3&#39;:
    case &#39;m4a&#39;:
    case &#39;wav&#39;:
    case &#39;ogg&#39;:
    case &#39;opus&#39;:
    case &#39;flac&#39;:
      return &#39;audio&#39;;
    case &#39;jpg&#39;:
    case &#39;jpeg&#39;:
    case &#39;png&#39;:
    case &#39;gif&#39;:
    case &#39;webp&#39;:
    case &#39;svg&#39;:
    case &#39;bmp&#39;:
    case &#39;ico&#39;:
      return &#39;image&#39;;
    case &#39;pdf&#39;:
      return &#39;pdf&#39;;
    case &#39;doc&#39;:
    case &#39;docx&#39;:
      return &#39;docx&#39;;
    case &#39;odt&#39;:
      return &#39;docx&#39;;
    case &#39;ppt&#39;:
    case &#39;pptx&#39;:
      return &#39;pptx&#39;;
    case &#39;xls&#39;:
    case &#39;xlsx&#39;:
      return &#39;xlsx&#39;;
    case &#39;url&#39;:
      return &#39;website&#39;;
    default:
      // Für unbekannte Dateitypen prüfen wir, ob es sich um eine Textdatei handeln könnte
      const textExtensions = [&#39;json&#39;, &#39;xml&#39;, &#39;yaml&#39;, &#39;yml&#39;, &#39;ini&#39;, &#39;cfg&#39;, &#39;conf&#39;, &#39;log&#39;, &#39;csv&#39;, &#39;html&#39;, &#39;htm&#39;, &#39;css&#39;, &#39;js&#39;, &#39;ts&#39;, &#39;jsx&#39;, &#39;tsx&#39;, &#39;py&#39;, &#39;java&#39;, &#39;c&#39;, &#39;cpp&#39;, &#39;h&#39;, &#39;hpp&#39;, &#39;cs&#39;, &#39;php&#39;, &#39;rb&#39;, &#39;go&#39;, &#39;rs&#39;, &#39;swift&#39;, &#39;kt&#39;, &#39;scala&#39;, &#39;r&#39;, &#39;sh&#39;, &#39;bash&#39;, &#39;ps1&#39;, &#39;bat&#39;, &#39;cmd&#39;, &#39;odt&#39;];
      if (textExtensions.includes(extension || &#39;&#39;)) {
        return &#39;markdown&#39;; // Behandle als editierbare Textdatei
      }
      return &#39;unknown&#39;;
  }
}

// Separate Komponente für den Content Loader
function ContentLoader({ 
  item, 
  provider, 
  fileType, 
  isAudioFile, 
  isVideoFile, 
  contentCache,
  onContentLoaded 
}: {
  item: StorageItem | null;
  provider: StorageProvider | null;
  fileType: string;
  isAudioFile: boolean;
  isVideoFile: boolean;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentLoaded: (content: string, hasMetadata: boolean) =&gt; void;
}) {
  const loadingIdRef = React.useRef&lt;string | null&gt;(null);

  // Prüft ob eine Datei ein Template ist
  const isTemplateFile = React.useCallback((name?: string): boolean =&gt; {
    if (!name) return false;
    return name.includes(&#39;{{&#39;) &amp;&amp; name.includes(&#39;}}&#39;);
  }, []);

  const loadContent = React.useCallback(async () =&gt; {
    if (!item?.id || !provider) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;loadContent abgebrochen&#39;, {
        hasItem: !!item?.id,
        hasProvider: !!provider
      });
      return;
    }

    FileLogger.info(&#39;ContentLoader&#39;, &#39;Lade Content für Datei&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      cacheSize: contentCache.current.size
    });

    // Prüfen ob Inhalt bereits im Cache
    const cachedContent = contentCache.current.get(item.id);
    if (cachedContent) {
      FileLogger.info(&#39;ContentLoader&#39;, &#39;Content aus Cache geladen&#39;, {
        itemId: item.id,
        contentLength: cachedContent.content.length,
        hasMetadata: cachedContent.hasMetadata
      });
      onContentLoaded(cachedContent.content, cachedContent.hasMetadata);
      return;
    }

    // Prüfen ob bereits ein Ladevorgang läuft
    if (loadingIdRef.current === item.id) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;Ladevorgang läuft bereits&#39;, {
        itemId: item.id
      });
      return;
    }

    loadingIdRef.current = item.id;

    try {
      // Wenn es eine Template-Datei ist, zeigen wir eine Warnung an
      if (isTemplateFile(item.metadata.name)) {
        const content = &quot;---\nstatus: template\n---\n\n&gt; **Hinweis**: Diese Datei enthält nicht aufgelöste Template-Variablen.\n&gt; Bitte stellen Sie sicher, dass alle Variablen korrekt definiert sind.&quot;;
        contentCache.current.set(item.id, { content, hasMetadata: true });
        onContentLoaded(content, true);
        return;
      }

      // Liste der Dateitypen, die als Binärdateien behandelt werden sollen
      const binaryFileTypes = [&#39;audio&#39;, &#39;image&#39;, &#39;video&#39;, &#39;pdf&#39;, &#39;docx&#39;, &#39;pptx&#39;, &#39;xlsx&#39;];

      if (!binaryFileTypes.includes(fileType) &amp;&amp; fileType !== &#39;unknown&#39;) {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Lade Textinhalt von Provider&#39;, {
          itemId: item.id,
          fileType
        });
        const content = await provider.getBinary(item.id).then(({ blob }) =&gt; blob.text());
        const hasMetadata = !!extractFrontmatter(content);

        FileLogger.info(&#39;ContentLoader&#39;, &#39;Content geladen und in Cache gespeichert&#39;, {
          itemId: item.id,
          contentLength: content.length,
          hasMetadata
        });

        contentCache.current.set(item.id, { content, hasMetadata });
        onContentLoaded(content, hasMetadata);
      } else {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Überspringe Content-Laden für Binary/Unknown-Datei&#39;, {
          itemId: item.id,
          fileType,
          isBinary: binaryFileTypes.includes(fileType),
          isUnknown: fileType === &#39;unknown&#39;
        });
        contentCache.current.set(item.id, { content: &#39;&#39;, hasMetadata: false });
        onContentLoaded(&#39;&#39;, false);
      }
    } catch (err) {
      FileLogger.error(&#39;ContentLoader&#39;, &#39;Failed to load file&#39;, err);
      // Bei Fehler zeigen wir eine Fehlermeldung im Markdown-Format
      const errorContent = &quot;---\nstatus: error\n---\n\n&gt; **Fehler**: Die Datei konnte nicht geladen werden.\n&gt; Bitte überprüfen Sie die Konsole für weitere Details.&quot;;
      contentCache.current.set(item.id, { content: errorContent, hasMetadata: true });
      onContentLoaded(errorContent, true);
    } finally {
      loadingIdRef.current = null;
    }
  }, [item?.id, item?.metadata?.name, provider, fileType, isAudioFile, isVideoFile, onContentLoaded, isTemplateFile, contentCache]);

  // Cleanup bei Unmount
  React.useEffect(() =&gt; {
    return () =&gt; {
      loadingIdRef.current = null;
    };
  }, []);

  // Nur laden wenn sich die ID ändert
  React.useEffect(() =&gt; {
    if (item?.id) {
      loadContent();
    }
  }, [item?.id, loadContent]);

  return null;
}

// Separate Komponente für die Vorschau
function PreviewContent({ 
  item, 
  fileType, 
  content, 
  error, 
  activeLibraryId,
  provider,
  contentCache,
  onContentUpdated,
  onRefreshFolder
}: {
  item: StorageItem;
  fileType: string;
  content: string;
  error: string | null;
  activeLibraryId: string;
  provider: StorageProvider | null;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentUpdated: (content: string) =&gt; void;
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}) {
  const [activeTab, setActiveTab] = React.useState&lt;string&gt;(&quot;preview&quot;);
  const [ragLoading, setRagLoading] = React.useState(false);
  const [ragError, setRagError] = React.useState&lt;string | null&gt;(null);
  const [ragStatus, setRagStatus] = React.useState&lt;{
    status: &#39;ok&#39; | &#39;stale&#39; | &#39;not_indexed&#39;;
    fileName?: string;
    chunkCount?: number;
    upsertedAt?: string;
    docModifiedAt?: string;
    docMeta?: Record&lt;string, unknown&gt;;
    toc?: Array&lt;Record&lt;string, unknown&gt;&gt;;
    totals?: { docs: number; chunks: number };
  } | null&gt;(null);
  const setSelectedFile = useSetAtom(selectedFileAtom);

  // Debug-Log für PreviewContent
  React.useEffect(() =&gt; {
    FileLogger.info(&#39;PreviewContent&#39;, &#39;PreviewContent gerendert&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      fileType,
      contentLength: content.length,
      hasError: !!error,
      hasProvider: !!provider,
      activeLibraryId
    });
  }, [item.id, fileType, content.length, error, provider, activeLibraryId]);

  React.useEffect(() =&gt; {
    setActiveTab(&quot;preview&quot;);
  }, [item.id]);

  async function loadRagStatus() {
    try {
      setRagLoading(true);
      setRagError(null);
      const docMod = (() =&gt; {
        const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
        const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
        return dt ? dt.toISOString() : undefined;
      })();
      const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/file-status?fileId=${encodeURIComponent(item.id)}${docMod ? `&amp;docModifiedAt=${encodeURIComponent(docMod)}` : &#39;&#39;}`, { cache: &#39;no-store&#39; });
      const data = await res.json();
      if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Status konnte nicht geladen werden&#39;);
      // Library-Stats parallel
      const statsRes = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/stats`, { cache: &#39;no-store&#39; });
      const stats = await statsRes.json().catch(() =&gt; ({}));
      setRagStatus({ ...data, totals: stats?.totals });
    } catch (e) {
      setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;);
    } finally {
      setRagLoading(false);
    }
  }

  if (error) {
    FileLogger.error(&#39;PreviewContent&#39;, &#39;Fehler in PreviewContent&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      error
    });
    return &lt;Alert variant=&quot;destructive&quot;&gt;&lt;AlertCircle className=&quot;h-4 w-4&quot; /&gt;&lt;AlertDescription&gt;{error}&lt;/AlertDescription&gt;&lt;/Alert&gt;;
  }

  // Debug-Log vor Switch-Statement
  FileLogger.debug(&#39;PreviewContent&#39;, &#39;Switch-Statement erreicht&#39;, {
    itemId: item.id,
    itemName: item.metadata.name,
    fileType,
    switchCase: fileType
  });

  switch (fileType) {
    case &#39;audio&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Audio-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;AudioPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;image&#39;:
      FileLogger.info(&#39;PreviewContent&#39;, &#39;ImagePreview wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        mimeType: item.metadata.mimeType,
        hasProvider: !!provider,
        providerName: provider?.name
      });
      return (
        &lt;ImagePreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;video&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Video-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;VideoPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;markdown&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Markdown-Editor wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        contentLength: content.length
      });
      return (
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;Tabs defaultValue=&quot;preview&quot; value={activeTab} onValueChange={setActiveTab} className=&quot;h-full flex flex-col&quot;&gt;
            &lt;TabsList className=&quot;mx-4 mt-2 flex-shrink-0&quot;&gt;
              &lt;TabsTrigger value=&quot;preview&quot;&gt;Vorschau&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;edit&quot;&gt;Bearbeiten&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;rag&quot; onClick={() =&gt; { void loadRagStatus(); }}&gt;RAG&lt;/TabsTrigger&gt;
            &lt;/TabsList&gt;
            &lt;div className=&quot;flex-1 min-h-0&quot;&gt;
              &lt;TabsContent value=&quot;preview&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;flex items-center gap-2 px-4 py-2&quot;&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (A)&#39;)
                        console.log(&#39;[Upsert A] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert A] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert A
                  &lt;/button&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;B&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (B)&#39;)
                        console.log(&#39;[Upsert B] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert B] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert B
                  &lt;/button&gt;
                &lt;/div&gt;
                &lt;MarkdownPreview 
                  content={content}
                  currentFolderId={item.parentId}
                  provider={provider}
                  className=&quot;h-full&quot;
                  onTransform={() =&gt; setActiveTab(&quot;edit&quot;)}
                  onRefreshFolder={onRefreshFolder}
                /&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;rag&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;p-4 space-y-3&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between&quot;&gt;
                    &lt;div className=&quot;text-sm font-medium&quot;&gt;RAG-Status&lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={() =&gt; void loadRagStatus()}
                      &gt;
                        Aktualisieren
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content, mode: &#39;llm&#39; })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse (LLM) fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse (LLM)&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse (LLM)
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert&#39;);
                          }
                        }}
                      &gt;
                        Upsert
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary/70 text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const chaptersSrcUnknown: unknown = (ragStatus as unknown as { analyze?: { chapters?: unknown } })?.analyze?.chapters
                            const chaptersSrc: Array&lt;unknown&gt; | undefined = Array.isArray(chaptersSrcUnknown) ? chaptersSrcUnknown : undefined
                            if (!Array.isArray(chaptersSrc) || chaptersSrc.length === 0) {
                              throw new Error(&#39;Keine Kapitelanalyse vorhanden&#39;)
                            }
                            const chapters = chaptersSrc
                              .filter((c): c is { chapterId?: unknown; title?: unknown; summary?: unknown; keywords?: unknown } =&gt; !!c &amp;&amp; typeof c === &#39;object&#39; &amp;&amp; typeof (c as Record&lt;string, unknown&gt;).summary === &#39;string&#39; &amp;&amp; (c as Record&lt;string, unknown&gt;).summary!.trim().length &gt; 0)
                              .map((c, i) =&gt; {
                                const obj = c as Record&lt;string, unknown&gt;
                                const chapterId = typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : `chap-${i + 1}`
                                const title = typeof obj.title === &#39;string&#39; ? obj.title : `Kapitel ${i + 1}`
                                const summary = String(obj.summary).slice(0, 1200)
                                const keywords = Array.isArray(obj.keywords) ? (obj.keywords as Array&lt;unknown&gt;).filter(k =&gt; typeof k === &#39;string&#39;).slice(0, 12) as string[] : undefined
                                return { chapterId, title, order: i + 1, summary, keywords }
                              })
                            if (chapters.length === 0) throw new Error(&#39;Keine Kapitel mit Summary gefunden&#39;)

                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const tocUnknown: unknown = (ragStatus as unknown as { analyze?: { toc?: unknown } })?.analyze?.toc
                            const toc: Array&lt;unknown&gt; | undefined = Array.isArray(tocUnknown) ? tocUnknown : undefined
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod, chapters, toc })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert (Analyse) fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert (Analyse)&#39;);
                          }
                        }}
                      &gt;
                        Upsert (Analyse)
                      &lt;/button&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  {ragLoading &amp;&amp; &lt;div className=&quot;text-sm text-muted-foreground&quot;&gt;Lade Status…&lt;/div&gt;}
                  {ragError &amp;&amp; &lt;div className=&quot;text-sm text-destructive&quot;&gt;{ragError}&lt;/div&gt;}
                  {ragStatus &amp;&amp; (
                    &lt;div className=&quot;space-y-2 text-sm&quot;&gt;
                      &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                        &lt;span&gt;Status:&lt;/span&gt;
                        &lt;span className={cn(
                          &#39;inline-flex items-center rounded px-2 py-0.5 text-xs&#39;,
                          ragStatus.status === &#39;ok&#39; &amp;&amp; &#39;bg-green-100 text-green-700&#39;,
                          ragStatus.status === &#39;stale&#39; &amp;&amp; &#39;bg-amber-100 text-amber-800&#39;,
                          ragStatus.status === &#39;not_indexed&#39; &amp;&amp; &#39;bg-gray-100 text-gray-700&#39;
                        )}&gt;
                          {ragStatus.status}
                        &lt;/span&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;fileId: {ragStatus?.fileName ? &#39;&#39; : &#39;&#39;}{(item.id)}&lt;/div&gt;
                      &lt;div&gt;Chunks: {ragStatus.chunkCount ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Upserted: {ragStatus.upsertedAt ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Dokument geändert: {ragStatus.docModifiedAt ?? &#39;—&#39;}&lt;/div&gt;
                      {ragStatus.totals &amp;&amp; (
                        &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;Index totals: {ragStatus.totals.docs} Docs, {ragStatus.totals.chunks} Chunks&lt;/div&gt;
                      )}
                      {ragStatus.docMeta &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Dokument-Metadaten&lt;/div&gt;
                          &lt;pre className=&quot;mt-1 max-h-44 overflow-auto whitespace-pre-wrap break-words text-xs bg-muted/30 p-2 rounded&quot;&gt;{JSON.stringify(ragStatus.docMeta, null, 2)}&lt;/pre&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus.toc &amp;&amp; Array.isArray(ragStatus.toc) &amp;&amp; ragStatus.toc.length &gt; 0 &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5&quot;&gt;
                            {ragStatus.toc.map((t, i: number) =&gt; {
                              const obj = t as Record&lt;string, unknown&gt;
                              const title = (typeof obj.title === &#39;string&#39; ? obj.title : (typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : &#39;Kapitel&#39;)) as string
                              const level = typeof obj.level === &#39;number&#39; ? obj.level : undefined
                              const page = typeof obj.page === &#39;number&#39; ? obj.page : undefined
                              const order = typeof obj.order === &#39;number&#39; ? obj.order : undefined
                              const startChunk = typeof obj.startChunk === &#39;number&#39; ? obj.startChunk : undefined
                              const endChunk = typeof obj.endChunk === &#39;number&#39; ? obj.endChunk : undefined
                              return (
                                &lt;li key={i} className=&quot;text-xs&quot;&gt;
                                  {title}
                                  {typeof level === &#39;number&#39; ? ` (L${level})` : &#39;&#39;}
                                  {typeof page === &#39;number&#39; ? ` · Seite ${page}` : &#39;&#39;}
                                  {typeof order === &#39;number&#39; ? ` · Reihenfolge ${order}` : &#39;&#39;}
                                  {typeof startChunk === &#39;number&#39; &amp;&amp; typeof endChunk === &#39;number&#39; ? ` · Chunks ${startChunk}-${endChunk}` : &#39;&#39;}
                                &lt;/li&gt;
                              )
                            })}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus?.analyze?.chapters &amp;&amp; Array.isArray(ragStatus.analyze.chapters) &amp;&amp; (
                        &lt;div className=&quot;mt-3&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel (Heuristik/LLM)&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5 text-xs max-h-56 overflow-auto&quot;&gt;
                            {ragStatus.analyze.chapters.map((c) =&gt; {
                              const obj = c as Record&lt;string, unknown&gt;
                              const id = typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : String(obj.chapterId ?? &#39;&#39;)
                              const level = typeof obj.level === &#39;number&#39; ? obj.level : undefined
                              const title = typeof obj.title === &#39;string&#39; ? obj.title : &#39;Kapitel&#39;
                              const startPage = typeof obj.startPage === &#39;number&#39; ? obj.startPage : undefined
                              const endPage = typeof obj.endPage === &#39;number&#39; ? obj.endPage : undefined
                              return (
                                &lt;li key={id}&gt;
                                  {typeof level === &#39;number&#39; ? `L${level}` : &#39;L?&#39;} · {title} · Seiten {startPage ?? &#39;—&#39;}–{endPage ?? &#39;—&#39;}
                                &lt;/li&gt;
                              )
                            })}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                    &lt;/div&gt;
                  )}
                &lt;/div&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;edit&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;TextEditor 
              content={content}
              provider={provider}
              onSaveAction={async (newContent: string) =&gt; {
                FileLogger.info(&#39;FilePreview&#39;, &#39;onSaveAction gestartet&#39;, {
                  itemId: item.id,
                  itemName: item.metadata.name,
                  contentLength: newContent.length,
                  hasProvider: !!provider,
                  hasOnRefreshFolder: !!onRefreshFolder
                });

                if (provider &amp;&amp; onRefreshFolder) {
                  try {
                    // Aktualisiere den lokalen State sofort
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Aktualisiere lokalen Content-State&#39;, {
                      oldContentLength: content.length,
                      newContentLength: newContent.length
                    });
                    onContentUpdated(newContent);

                    const blob = new Blob([newContent], { type: &#39;text/markdown&#39; });
                    const file = new File([blob], item.metadata.name, { type: &#39;text/markdown&#39; });

                    // Lösche die alte Datei
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lösche alte Datei&#39;, {
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    await provider.deleteItem(item.id);

                    // Lade die neue Datei hoch
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lade neue Datei hoch&#39;, {
                      fileName: file.name,
                      fileSize: file.size,
                      parentId: item.parentId
                    });
                    const updatedItem = await provider.uploadFile(item.parentId, file);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Upload abgeschlossen&#39;, {
                      success: !!updatedItem,
                      newItemId: updatedItem?.id,
                      newItemName: updatedItem?.metadata.name
                    });

                    // Aktualisiere den Cache mit dem neuen Inhalt und der neuen ID
                    if (updatedItem) {
                      // Lösche den alten Cache-Eintrag
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Lösche alten Eintrag&#39;, {
                        oldItemId: item.id,
                        cacheSize: contentCache.current.size
                      });
                      contentCache.current.delete(item.id);

                      // Füge den neuen Inhalt zum Cache hinzu
                      const hasMetadata = !!extractFrontmatter(newContent);
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Füge neuen Eintrag hinzu&#39;, {
                        newItemId: updatedItem.id,
                        hasMetadata,
                        contentLength: newContent.length
                      });
                      contentCache.current.set(updatedItem.id, { 
                        content: newContent, 
                        hasMetadata 
                      });

                      // Aktualisiere das selectedFileAtom mit der neuen Datei
                      FileLogger.info(&#39;FilePreview&#39;, &#39;Aktualisiere selectedFileAtom&#39;, {
                        oldId: item.id,
                        newId: updatedItem.id
                      });
                      setSelectedFile(updatedItem);
                    }

                    // Hole die aktualisierten Items
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Hole aktualisierte Dateiliste&#39;, {
                      parentId: item.parentId
                    });
                    const updatedItems = await provider.listItemsById(item.parentId);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Dateiliste aktualisiert&#39;, {
                      itemCount: updatedItems.length
                    });

                    // Wechsle zur Vorschau
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Wechsle zu Vorschau-Tab&#39;);
                    setActiveTab(&quot;preview&quot;);

                    // Informiere die übergeordnete Komponente
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Rufe onRefreshFolder auf&#39;, {
                      parentId: item.parentId,
                      updatedItemsCount: updatedItems.length,
                      updatedItemId: updatedItem?.id
                    });
                    onRefreshFolder(item.parentId, updatedItems, updatedItem);
                  } catch (error) {
                    FileLogger.error(&#39;FilePreview&#39;, &#39;Fehler beim Aktualisieren der Datei&#39;, {
                      error,
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    throw error; // Werfe den Fehler weiter, damit TextEditor ihn anzeigen kann
                  }
                } else {
                  FileLogger.warn(&#39;FilePreview&#39;, &#39;Speichern nicht möglich&#39;, {
                    hasProvider: !!provider,
                    hasOnRefreshFolder: !!onRefreshFolder
                  });
                  // Werfe einen Fehler, damit TextEditor ihn anzeigen kann
                  throw new Error(&#39;Speichern nicht möglich: onRefreshFolder Callback fehlt&#39;);
                }
              }}
                          /&gt;
              &lt;/TabsContent&gt;
            &lt;/div&gt;
          &lt;/Tabs&gt;
        &lt;/div&gt;
      );
    case &#39;pdf&#39;:
    case &#39;docx&#39;:
    case &#39;pptx&#39;:
    case &#39;xlsx&#39;:
    case &#39;presentation&#39;:
      return (
        &lt;DocumentPreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;website&#39;:
      const urlContent = content.match(/URL=(.*)/)?.[1];
      return urlContent ? (
        &lt;iframe 
          src={urlContent}
          title={item.metadata.name}
          className=&quot;w-full h-screen&quot;
        /&gt;
      ) : (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine gültige URL gefunden.
        &lt;/div&gt;
      );
    default:
      return (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine Vorschau verfügbar für diesen Dateityp.
        &lt;/div&gt;
      );
  }
}

// Definiere einen Typ für den State
interface FilePreviewState {
  content: string;
  error: string | null;
  hasMetadata: boolean;
}

// Hauptkomponente
export function FilePreview({ 
  className,
  provider,
  file,
  onRefreshFolder
}: FilePreviewProps) {
  const activeLibraryId = useAtomValue(activeLibraryIdAtom);
  const selectedFileFromAtom = useAtomValue(selectedFileAtom);

  // Verwende explizite file prop oder fallback zum selectedFileAtom
  const displayFile = file || selectedFileFromAtom;

  // Debug-Log für FilePreview-Hauptkomponente
  React.useEffect(() =&gt; {
    const timeoutId = setTimeout(() =&gt; {
      FileLogger.info(&#39;FilePreview&#39;, &#39;FilePreview-Hauptkomponente gerendert&#39;, {
        hasExplicitFile: !!file,
        hasSelectedFileFromAtom: !!selectedFileFromAtom,
        displayFileId: displayFile?.id,
        displayFileName: displayFile?.metadata.name,
        hasProvider: !!provider,
        providerName: provider?.name,
        activeLibraryId
      });
    }, 0);

    return () =&gt; clearTimeout(timeoutId);
  }, [file, selectedFileFromAtom, displayFile, provider, activeLibraryId]);

  // Gemeinsamer Cache für den Inhalt von Dateien
  const contentCache = React.useRef&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;(new Map());

  // Passe den Reducer an
  const reducer = React.useCallback((state: FilePreviewState, action: { type: string; content?: string; hasMetadata?: boolean; error?: string }) =&gt; {
    switch (action.type) {
      case &#39;SET_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39;, hasMetadata: action.hasMetadata ?? false };
      case &#39;SET_ERROR&#39;:
        return { ...state, error: action.error ?? null };
      case &#39;UPDATE_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39; };
      default:
        return state;
    }
  }, []);

  const [state, dispatch] = React.useReducer(reducer, {
    content: &#39;&#39;,
    error: null,
    hasMetadata: false
  });

  // Memoize computed values
  const fileType = React.useMemo(() =&gt; 
    displayFile ? getFileType(displayFile.metadata.name) : &#39;unknown&#39;, 
    [displayFile]
  );

  const isAudioFile = React.useMemo(() =&gt; fileType === &#39;audio&#39;, [fileType]);
  const isVideoFile = React.useMemo(() =&gt; fileType === &#39;video&#39;, [fileType]);

  // Debug-Log für computed values
  React.useEffect(() =&gt; {
    if (displayFile) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Computed values aktualisiert&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          fileType,
          isAudioFile,
          isVideoFile,
          mimeType: displayFile.metadata.mimeType
        });
      }, 0);

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile, fileType, isAudioFile, isVideoFile]);

  // Memoize content loader callback
  const handleContentLoaded = React.useCallback((content: string, hasMetadata: boolean) =&gt; {
    dispatch({ type: &#39;SET_CONTENT&#39;, content, hasMetadata });
  }, []);

  // Callback für direkte Aktualisierung des Inhalts
  const handleContentUpdated = React.useCallback((content: string) =&gt; {
    dispatch({ type: &#39;UPDATE_CONTENT&#39;, content });
  }, []);

  // Cache leeren, wenn sich die Item-ID ändert
  React.useEffect(() =&gt; {
    if (displayFile?.id) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Neues Item geladen, Cache wird geprüft&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          cacheSize: contentCache.current.size
        });
      }, 0);

      // Nur Cache-Einträge löschen, die nicht zur aktuellen Datei gehören
      const currentCache = contentCache.current.get(displayFile.id);
      if (!currentCache) {
        // Wenn die aktuelle Datei nicht im Cache ist, lösche alte Einträge
        Array.from(contentCache.current.keys()).forEach(key =&gt; {
          if (key !== displayFile.id) {
            contentCache.current.delete(key);
          }
        });
      }

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile?.id]);

  if (!displayFile) {
    return (
      &lt;div className={cn(&quot;flex items-center justify-center h-full&quot;, className)}&gt;
        &lt;p className=&quot;text-muted-foreground&quot;&gt;Keine Datei ausgewählt&lt;/p&gt;
      &lt;/div&gt;
    );
  }

  return (
    &lt;div className={cn(&quot;h-full flex flex-col&quot;, className)}&gt;
      &lt;ContentLoader
        item={displayFile}
        provider={provider}
        fileType={fileType}
        isAudioFile={isAudioFile}
        isVideoFile={isVideoFile}
        contentCache={contentCache}
        onContentLoaded={handleContentLoaded}
      /&gt;
      &lt;div className=&quot;flex-1 overflow-auto&quot;&gt;
        &lt;PreviewContent
          item={displayFile}
          fileType={fileType}
          content={state.content}
          error={state.error}
          activeLibraryId={activeLibraryId}
          provider={provider}
          contentCache={contentCache}
          onContentUpdated={handleContentUpdated}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Ich öffne die Datei mit dem TypeScript-Fehler, um den Typkonflikt bei 'kind' zu beheben. Danach wiederhole ich den Build.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">loadLibraryChatContext</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/loader&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">upsertVectorsChunked</span><span class="p">,</span><span class="w"> </span><span class="nx">deleteByFilter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/pinecone&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">UpsertVector</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/pinecone&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">embedTexts</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/embeddings&#39;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">bodySchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">  </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">  </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="kt">z.enum</span><span class="p">([</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="p">]).</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">docModifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span><span class="w"> </span><span class="c1">// ISO Datum der Originaldatei (für Stale-Check)</span>
<span class="w">  </span><span class="c1">// Dokument-Metadaten (frei erweiterbar, werden im Meta-Vektor gespeichert)</span>
<span class="w">  </span><span class="nx">docMeta</span><span class="o">:</span><span class="w"> </span><span class="kt">z.record</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">any</span><span class="p">()).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="c1">// Kapitel-Infos mit Summaries (optional)</span>
<span class="w">  </span><span class="nx">chapters</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">chapterId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">    </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">order</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">4000</span><span class="p">),</span>
<span class="w">    </span><span class="nx">startChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">endChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">keywords</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="kt">string</span><span class="p">()).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="p">})).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="c1">// Optionaler, bereits erkannter TOC (z. B. aus LLM-Analyse)</span>
<span class="w">  </span><span class="nx">toc</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="p">})).</span><span class="nx">optional</span><span class="p">()</span>
<span class="p">})</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">chunkText</span><span class="p">(</span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">maxChars</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nx">overlap</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">  </span><span class="c1">// Sicherheitsgrenzen</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">200</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">maxChars</span><span class="p">,</span><span class="w"> </span><span class="mf">2000</span><span class="p">))</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">overlap</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">maxC</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)))</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">length</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sliceEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">maxC</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// Bevorzugt an Zeilenumbruch schneiden</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">cut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sliceEnd</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cut</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">maxC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.6</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Falls kein sinnvoller Zeilenumbruch, nach Leerzeichen/Punkt suchen</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">spaceCut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sliceEnd</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dotCut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sliceEnd</span><span class="p">)</span>
<span class="w">      </span><span class="nx">cut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">cut</span><span class="p">,</span><span class="w"> </span><span class="nx">spaceCut</span><span class="p">,</span><span class="w"> </span><span class="nx">dotCut</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cut</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">maxC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Notfall: harte Kante</span>
<span class="w">      </span><span class="nx">cut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sliceEnd</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">part</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">cut</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Overlap anwenden</span>
<span class="w">    </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">cut</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">ov</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">maxC</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">chunks</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}))</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bodySchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Ungültige Eingabe&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">parsed.error.flatten</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fileId</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">,</span><span class="w"> </span><span class="nx">mode</span><span class="p">,</span><span class="w"> </span><span class="nx">docModifiedAt</span><span class="p">,</span><span class="w"> </span><span class="nx">docMeta</span><span class="p">,</span><span class="w"> </span><span class="nx">chapters</span><span class="p">,</span><span class="w"> </span><span class="nx">toc</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsed</span><span class="p">.</span><span class="nx">data</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">loadLibraryChatContext</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bibliothek nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_API_KEY</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PINECONE_API_KEY fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">vectorIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">idx</span><span class="o">?</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Index nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="c1">// Idempotenz: vor Upsert alle Vektoren dieses Dokuments entfernen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">deleteByFilter</span><span class="p">(</span><span class="nx">idx</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">libraryId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">fileId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunkText</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span><span class="w"> </span><span class="mf">1500</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">embeddings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">embedTexts</span><span class="p">(</span><span class="nx">chunks</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">vectors</span><span class="o">:</span><span class="w"> </span><span class="kt">UpsertVector</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">embeddings</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">values</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">values</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="p">,</span>
<span class="w">        </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mode</span><span class="p">,</span>
<span class="w">        </span><span class="nx">chunkIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">i</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Beschränke Text im Metadata-Feld</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">chunks</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">),</span>
<span class="w">        </span><span class="nx">upsertedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">docModifiedAt</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}))</span>
<span class="w">    </span><span class="c1">// Zusätzlich: Meta-Vektor für Dokument-Status (nutzt erstes Embedding als Vektor)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">embeddings</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">vectors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-meta`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="kt">embeddings</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
<span class="w">        </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">          </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;doc&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">chunkCount</span><span class="o">:</span><span class="w"> </span><span class="kt">embeddings.length</span><span class="p">,</span>
<span class="w">          </span><span class="nx">upsertedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">docModifiedAt</span><span class="p">,</span>
<span class="w">          </span><span class="c1">// Hinweis: Pinecone-Serverless erlaubt nur primitive Metadaten oder List&lt;string&gt;.</span>
<span class="w">          </span><span class="c1">// Deshalb serialisieren wir strukturierte Felder als JSON-String.</span>
<span class="w">          </span><span class="nx">docMetaJson</span><span class="o">:</span><span class="w"> </span><span class="kt">docMeta</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">docMeta</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">          </span><span class="nx">tocJson</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">toc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">toc</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">toc</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">t.title</span><span class="p">,</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">t.level</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">t.page</span><span class="w"> </span><span class="p">})))</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">chapters</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">chapters</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">                  </span><span class="nx">chapterId</span><span class="o">:</span><span class="w"> </span><span class="kt">c.chapterId</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">c.title</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">order</span><span class="o">:</span><span class="w"> </span><span class="kt">c.order</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">startChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">c.startChunk</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">endChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">c.endChunk</span><span class="p">,</span>
<span class="w">                </span><span class="p">})))</span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Kapitel-Summaries als eigene Vektoren (Retriever-Ziel)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chapters</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">chapterSummaries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">summary</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">chapterEmbeds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">embedTexts</span><span class="p">(</span><span class="nx">chapterSummaries</span><span class="p">)</span>
<span class="w">      </span><span class="nx">chapterEmbeds</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">values</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<span class="w">        </span><span class="nx">vectors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">          </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-chap-</span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">chapterId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">values</span><span class="p">,</span>
<span class="w">          </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="p">,</span>
<span class="w">            </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">            </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chapterSummary&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">chapterId</span><span class="o">:</span><span class="w"> </span><span class="kt">c.chapterId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">chapterTitle</span><span class="o">:</span><span class="w"> </span><span class="kt">c.title</span><span class="p">,</span>
<span class="w">            </span><span class="nx">order</span><span class="o">:</span><span class="w"> </span><span class="kt">c.order</span><span class="p">,</span>
<span class="w">            </span><span class="nx">startChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">c.startChunk</span><span class="p">,</span>
<span class="w">            </span><span class="nx">endChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">c.endChunk</span><span class="p">,</span>
<span class="w">            </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">c.summary.slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1200</span><span class="p">),</span>
<span class="w">            </span><span class="nx">keywords</span><span class="o">:</span><span class="w"> </span><span class="kt">c.keywords</span><span class="p">,</span>
<span class="w">            </span><span class="nx">upsertedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">            </span><span class="nx">docModifiedAt</span><span class="p">,</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">upsertVectorsChunked</span><span class="p">(</span><span class="nx">idx</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">vectors</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="kt">chunks.length</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kt">ctx.vectorIndex</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Interner Fehler&#39;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">message</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="p">,</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@clerk/nextjs/server&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">loadLibraryChatContext</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/loader&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">upsertVectorsChunked</span><span class="p">,</span><span class="w"> </span><span class="nx">deleteByFilter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/pinecone&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">UpsertVector</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/pinecone&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">embedTexts</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/embeddings&#39;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">bodySchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">  </span><span class="nx">fileName</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">  </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="kt">z.enum</span><span class="p">([</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="p">]).</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">docModifiedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span><span class="w"> </span><span class="c1">// ISO Datum der Originaldatei (für Stale-Check)</span>
<span class="w">  </span><span class="c1">// Dokument-Metadaten (frei erweiterbar, werden im Meta-Vektor gespeichert)</span>
<span class="w">  </span><span class="nx">docMeta</span><span class="o">:</span><span class="w"> </span><span class="kt">z.record</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">any</span><span class="p">()).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="c1">// Kapitel-Infos mit Summaries (optional)</span>
<span class="w">  </span><span class="nx">chapters</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">chapterId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">    </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">order</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">4000</span><span class="p">),</span>
<span class="w">    </span><span class="nx">startChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">endChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">keywords</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="kt">string</span><span class="p">()).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="p">})).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="c1">// Optionaler, bereits erkannter TOC (z. B. aus LLM-Analyse)</span>
<span class="w">  </span><span class="nx">toc</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="p">})).</span><span class="nx">optional</span><span class="p">()</span>
<span class="p">})</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">chunkText</span><span class="p">(</span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">maxChars</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nx">overlap</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">  </span><span class="c1">// Sicherheitsgrenzen</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">200</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">maxChars</span><span class="p">,</span><span class="w"> </span><span class="mf">2000</span><span class="p">))</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">overlap</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">maxC</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)))</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">length</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sliceEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">maxC</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// Bevorzugt an Zeilenumbruch schneiden</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">cut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sliceEnd</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cut</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">maxC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.6</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Falls kein sinnvoller Zeilenumbruch, nach Leerzeichen/Punkt suchen</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">spaceCut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sliceEnd</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dotCut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sliceEnd</span><span class="p">)</span>
<span class="w">      </span><span class="nx">cut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">cut</span><span class="p">,</span><span class="w"> </span><span class="nx">spaceCut</span><span class="p">,</span><span class="w"> </span><span class="nx">dotCut</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cut</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">maxC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Notfall: harte Kante</span>
<span class="w">      </span><span class="nx">cut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sliceEnd</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">part</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">cut</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Overlap anwenden</span>
<span class="w">    </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">cut</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">ov</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">maxC</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">chunks</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">libraryId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">params</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">currentUser</span><span class="p">()</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddresses</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">emailAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Nicht authentifiziert&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({}))</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bodySchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Ungültige Eingabe&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">parsed.error.flatten</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fileId</span><span class="p">,</span><span class="w"> </span><span class="nx">fileName</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">,</span><span class="w"> </span><span class="nx">mode</span><span class="p">,</span><span class="w"> </span><span class="nx">docModifiedAt</span><span class="p">,</span><span class="w"> </span><span class="nx">docMeta</span><span class="p">,</span><span class="w"> </span><span class="nx">chapters</span><span class="p">,</span><span class="w"> </span><span class="nx">toc</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parsed</span><span class="p">.</span><span class="nx">data</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">loadLibraryChatContext</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bibliothek nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PINECONE_API_KEY</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiKey</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PINECONE_API_KEY fehlt&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">describeIndex</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">vectorIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">idx</span><span class="o">?</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Index nicht gefunden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="c1">// Idempotenz: vor Upsert alle Vektoren dieses Dokuments entfernen</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">deleteByFilter</span><span class="p">(</span><span class="nx">idx</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">libraryId</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">fileId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunkText</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span><span class="w"> </span><span class="mf">1500</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">embeddings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">embedTexts</span><span class="p">(</span><span class="nx">chunks</span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">vectors</span><span class="o">:</span><span class="w"> </span><span class="kt">UpsertVector</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">embeddings</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">values</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">values</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="p">,</span>
<span class="w">        </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mode</span><span class="p">,</span>
<span class="w">        </span><span class="nx">chunkIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">i</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Beschränke Text im Metadata-Feld</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">chunks</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">),</span>
<span class="w">        </span><span class="nx">upsertedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">docModifiedAt</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}))</span>
<span class="w">    </span><span class="c1">// Zusätzlich: Meta-Vektor für Dokument-Status (nutzt erstes Embedding als Vektor)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">embeddings</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">vectors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-meta`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="kt">embeddings</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
<span class="w">        </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="p">,</span>
<span class="w">          </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">          </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;doc&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">chunkCount</span><span class="o">:</span><span class="w"> </span><span class="kt">embeddings.length</span><span class="p">,</span>
<span class="w">          </span><span class="nx">upsertedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">docModifiedAt</span><span class="p">,</span>
<span class="w">          </span><span class="c1">// Hinweis: Pinecone-Serverless erlaubt nur primitive Metadaten oder List&lt;string&gt;.</span>
<span class="w">          </span><span class="c1">// Deshalb serialisieren wir strukturierte Felder als JSON-String.</span>
<span class="w">          </span><span class="nx">docMetaJson</span><span class="o">:</span><span class="w"> </span><span class="kt">docMeta</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">docMeta</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">          </span><span class="nx">tocJson</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">toc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">toc</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">toc</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">t.title</span><span class="p">,</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="kt">t.level</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">t.page</span><span class="w"> </span><span class="p">})))</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">chapters</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">chapters</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">                  </span><span class="nx">chapterId</span><span class="o">:</span><span class="w"> </span><span class="kt">c.chapterId</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">c.title</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">order</span><span class="o">:</span><span class="w"> </span><span class="kt">c.order</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">startChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">c.startChunk</span><span class="p">,</span>
<span class="w">                  </span><span class="nx">endChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">c.endChunk</span><span class="p">,</span>
<span class="w">                </span><span class="p">})))</span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Kapitel-Summaries als eigene Vektoren (Retriever-Ziel)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chapters</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">chapterSummaries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chapters</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">summary</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">chapterEmbeds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">embedTexts</span><span class="p">(</span><span class="nx">chapterSummaries</span><span class="p">)</span>
<span class="w">      </span><span class="nx">chapterEmbeds</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">values</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chapters</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<span class="w">        </span><span class="nx">vectors</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">          </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">fileId</span><span class="si">}</span><span class="sb">-chap-</span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">chapterId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">values</span><span class="p">,</span>
<span class="w">          </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="p">,</span>
<span class="w">            </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">fileId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">            </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chapterSummary&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">chapterId</span><span class="o">:</span><span class="w"> </span><span class="kt">c.chapterId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">chapterTitle</span><span class="o">:</span><span class="w"> </span><span class="kt">c.title</span><span class="p">,</span>
<span class="w">            </span><span class="nx">order</span><span class="o">:</span><span class="w"> </span><span class="kt">c.order</span><span class="p">,</span>
<span class="w">            </span><span class="nx">startChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">c.startChunk</span><span class="p">,</span>
<span class="w">            </span><span class="nx">endChunk</span><span class="o">:</span><span class="w"> </span><span class="kt">c.endChunk</span><span class="p">,</span>
<span class="w">            </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">c.summary.slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1200</span><span class="p">),</span>
<span class="w">            </span><span class="nx">keywords</span><span class="o">:</span><span class="w"> </span><span class="kt">c.keywords</span><span class="p">,</span>
<span class="w">            </span><span class="nx">upsertedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">            </span><span class="nx">docModifiedAt</span><span class="p">,</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">upsertVectorsChunked</span><span class="p">(</span><span class="nx">idx</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">vectors</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">chunks</span><span class="o">:</span><span class="w"> </span><span class="kt">chunks.length</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="kt">ctx.vectorIndex</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Interner Fehler&#39;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">message</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Ich behebe den TS-Fehler in <code>src/components/library/file-preview.tsx</code> (sichere Type Guard ohne <code>.trim()</code> auf unbekanntem Typ) und baue erneut.</p>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import * as React from &#39;react&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Alert, AlertDescription } from &quot;@/components/ui/alert&quot;;
import { AlertCircle } from &quot;lucide-react&quot;;
import { AudioPlayer } from &#39;./audio-player&#39;;
import { VideoPlayer } from &#39;./video-player&#39;;
import { MarkdownPreview } from &#39;./markdown-preview&#39;;
import { Tabs, TabsContent, TabsList, TabsTrigger } from &quot;@/components/ui/tabs&quot;;
import &#39;./markdown-audio&#39;;
import { useAtomValue, useSetAtom } from &quot;jotai&quot;;
import { activeLibraryIdAtom, selectedFileAtom } from &quot;@/atoms/library-atom&quot;;
import { TextEditor } from &#39;./text-editor&#39;;
import { StorageItem, StorageProvider } from &quot;@/lib/storage/types&quot;;
import { extractFrontmatter } from &#39;./markdown-metadata&#39;;
import { ImagePreview } from &#39;./image-preview&#39;;
import { DocumentPreview } from &#39;./document-preview&#39;;
import { FileLogger } from &quot;@/lib/debug/logger&quot;

// Explizite React-Komponenten-Deklarationen für den Linter
const ImagePreviewComponent = ImagePreview;
const DocumentPreviewComponent = DocumentPreview;

interface FilePreviewProps {
  className?: string;
  provider: StorageProvider | null;
  file?: StorageItem | null; // Neue prop für explizite Datei-Auswahl
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}

// Helper function for file type detection
function getFileType(fileName: string): string {
  const extension = fileName.split(&#39;.&#39;).pop()?.toLowerCase();

  switch(extension) {
    case &#39;txt&#39;:
    case &#39;md&#39;:
    case &#39;mdx&#39;:
      return &#39;markdown&#39;;
    case &#39;mp4&#39;:
    case &#39;avi&#39;:
    case &#39;mov&#39;:
    case &#39;webm&#39;:
    case &#39;mkv&#39;:
      return &#39;video&#39;;
    case &#39;mp3&#39;:
    case &#39;m4a&#39;:
    case &#39;wav&#39;:
    case &#39;ogg&#39;:
    case &#39;opus&#39;:
    case &#39;flac&#39;:
      return &#39;audio&#39;;
    case &#39;jpg&#39;:
    case &#39;jpeg&#39;:
    case &#39;png&#39;:
    case &#39;gif&#39;:
    case &#39;webp&#39;:
    case &#39;svg&#39;:
    case &#39;bmp&#39;:
    case &#39;ico&#39;:
      return &#39;image&#39;;
    case &#39;pdf&#39;:
      return &#39;pdf&#39;;
    case &#39;doc&#39;:
    case &#39;docx&#39;:
      return &#39;docx&#39;;
    case &#39;odt&#39;:
      return &#39;docx&#39;;
    case &#39;ppt&#39;:
    case &#39;pptx&#39;:
      return &#39;pptx&#39;;
    case &#39;xls&#39;:
    case &#39;xlsx&#39;:
      return &#39;xlsx&#39;;
    case &#39;url&#39;:
      return &#39;website&#39;;
    default:
      // Für unbekannte Dateitypen prüfen wir, ob es sich um eine Textdatei handeln könnte
      const textExtensions = [&#39;json&#39;, &#39;xml&#39;, &#39;yaml&#39;, &#39;yml&#39;, &#39;ini&#39;, &#39;cfg&#39;, &#39;conf&#39;, &#39;log&#39;, &#39;csv&#39;, &#39;html&#39;, &#39;htm&#39;, &#39;css&#39;, &#39;js&#39;, &#39;ts&#39;, &#39;jsx&#39;, &#39;tsx&#39;, &#39;py&#39;, &#39;java&#39;, &#39;c&#39;, &#39;cpp&#39;, &#39;h&#39;, &#39;hpp&#39;, &#39;cs&#39;, &#39;php&#39;, &#39;rb&#39;, &#39;go&#39;, &#39;rs&#39;, &#39;swift&#39;, &#39;kt&#39;, &#39;scala&#39;, &#39;r&#39;, &#39;sh&#39;, &#39;bash&#39;, &#39;ps1&#39;, &#39;bat&#39;, &#39;cmd&#39;, &#39;odt&#39;];
      if (textExtensions.includes(extension || &#39;&#39;)) {
        return &#39;markdown&#39;; // Behandle als editierbare Textdatei
      }
      return &#39;unknown&#39;;
  }
}

// Separate Komponente für den Content Loader
function ContentLoader({ 
  item, 
  provider, 
  fileType, 
  isAudioFile, 
  isVideoFile, 
  contentCache,
  onContentLoaded 
}: {
  item: StorageItem | null;
  provider: StorageProvider | null;
  fileType: string;
  isAudioFile: boolean;
  isVideoFile: boolean;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentLoaded: (content: string, hasMetadata: boolean) =&gt; void;
}) {
  const loadingIdRef = React.useRef&lt;string | null&gt;(null);

  // Prüft ob eine Datei ein Template ist
  const isTemplateFile = React.useCallback((name?: string): boolean =&gt; {
    if (!name) return false;
    return name.includes(&#39;{{&#39;) &amp;&amp; name.includes(&#39;}}&#39;);
  }, []);

  const loadContent = React.useCallback(async () =&gt; {
    if (!item?.id || !provider) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;loadContent abgebrochen&#39;, {
        hasItem: !!item?.id,
        hasProvider: !!provider
      });
      return;
    }

    FileLogger.info(&#39;ContentLoader&#39;, &#39;Lade Content für Datei&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      cacheSize: contentCache.current.size
    });

    // Prüfen ob Inhalt bereits im Cache
    const cachedContent = contentCache.current.get(item.id);
    if (cachedContent) {
      FileLogger.info(&#39;ContentLoader&#39;, &#39;Content aus Cache geladen&#39;, {
        itemId: item.id,
        contentLength: cachedContent.content.length,
        hasMetadata: cachedContent.hasMetadata
      });
      onContentLoaded(cachedContent.content, cachedContent.hasMetadata);
      return;
    }

    // Prüfen ob bereits ein Ladevorgang läuft
    if (loadingIdRef.current === item.id) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;Ladevorgang läuft bereits&#39;, {
        itemId: item.id
      });
      return;
    }

    loadingIdRef.current = item.id;

    try {
      // Wenn es eine Template-Datei ist, zeigen wir eine Warnung an
      if (isTemplateFile(item.metadata.name)) {
        const content = &quot;---\nstatus: template\n---\n\n&gt; **Hinweis**: Diese Datei enthält nicht aufgelöste Template-Variablen.\n&gt; Bitte stellen Sie sicher, dass alle Variablen korrekt definiert sind.&quot;;
        contentCache.current.set(item.id, { content, hasMetadata: true });
        onContentLoaded(content, true);
        return;
      }

      // Liste der Dateitypen, die als Binärdateien behandelt werden sollen
      const binaryFileTypes = [&#39;audio&#39;, &#39;image&#39;, &#39;video&#39;, &#39;pdf&#39;, &#39;docx&#39;, &#39;pptx&#39;, &#39;xlsx&#39;];

      if (!binaryFileTypes.includes(fileType) &amp;&amp; fileType !== &#39;unknown&#39;) {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Lade Textinhalt von Provider&#39;, {
          itemId: item.id,
          fileType
        });
        const content = await provider.getBinary(item.id).then(({ blob }) =&gt; blob.text());
        const hasMetadata = !!extractFrontmatter(content);

        FileLogger.info(&#39;ContentLoader&#39;, &#39;Content geladen und in Cache gespeichert&#39;, {
          itemId: item.id,
          contentLength: content.length,
          hasMetadata
        });

        contentCache.current.set(item.id, { content, hasMetadata });
        onContentLoaded(content, hasMetadata);
      } else {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Überspringe Content-Laden für Binary/Unknown-Datei&#39;, {
          itemId: item.id,
          fileType,
          isBinary: binaryFileTypes.includes(fileType),
          isUnknown: fileType === &#39;unknown&#39;
        });
        contentCache.current.set(item.id, { content: &#39;&#39;, hasMetadata: false });
        onContentLoaded(&#39;&#39;, false);
      }
    } catch (err) {
      FileLogger.error(&#39;ContentLoader&#39;, &#39;Failed to load file&#39;, err);
      // Bei Fehler zeigen wir eine Fehlermeldung im Markdown-Format
      const errorContent = &quot;---\nstatus: error\n---\n\n&gt; **Fehler**: Die Datei konnte nicht geladen werden.\n&gt; Bitte überprüfen Sie die Konsole für weitere Details.&quot;;
      contentCache.current.set(item.id, { content: errorContent, hasMetadata: true });
      onContentLoaded(errorContent, true);
    } finally {
      loadingIdRef.current = null;
    }
  }, [item?.id, item?.metadata?.name, provider, fileType, isAudioFile, isVideoFile, onContentLoaded, isTemplateFile, contentCache]);

  // Cleanup bei Unmount
  React.useEffect(() =&gt; {
    return () =&gt; {
      loadingIdRef.current = null;
    };
  }, []);

  // Nur laden wenn sich die ID ändert
  React.useEffect(() =&gt; {
    if (item?.id) {
      loadContent();
    }
  }, [item?.id, loadContent]);

  return null;
}

// Separate Komponente für die Vorschau
function PreviewContent({ 
  item, 
  fileType, 
  content, 
  error, 
  activeLibraryId,
  provider,
  contentCache,
  onContentUpdated,
  onRefreshFolder
}: {
  item: StorageItem;
  fileType: string;
  content: string;
  error: string | null;
  activeLibraryId: string;
  provider: StorageProvider | null;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentUpdated: (content: string) =&gt; void;
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}) {
  const [activeTab, setActiveTab] = React.useState&lt;string&gt;(&quot;preview&quot;);
  const [ragLoading, setRagLoading] = React.useState(false);
  const [ragError, setRagError] = React.useState&lt;string | null&gt;(null);
  const [ragStatus, setRagStatus] = React.useState&lt;{
    status: &#39;ok&#39; | &#39;stale&#39; | &#39;not_indexed&#39;;
    fileName?: string;
    chunkCount?: number;
    upsertedAt?: string;
    docModifiedAt?: string;
    docMeta?: Record&lt;string, unknown&gt;;
    toc?: Array&lt;Record&lt;string, unknown&gt;&gt;;
    totals?: { docs: number; chunks: number };
  } | null&gt;(null);
  const setSelectedFile = useSetAtom(selectedFileAtom);

  // Debug-Log für PreviewContent
  React.useEffect(() =&gt; {
    FileLogger.info(&#39;PreviewContent&#39;, &#39;PreviewContent gerendert&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      fileType,
      contentLength: content.length,
      hasError: !!error,
      hasProvider: !!provider,
      activeLibraryId
    });
  }, [item.id, fileType, content.length, error, provider, activeLibraryId]);

  React.useEffect(() =&gt; {
    setActiveTab(&quot;preview&quot;);
  }, [item.id]);

  async function loadRagStatus() {
    try {
      setRagLoading(true);
      setRagError(null);
      const docMod = (() =&gt; {
        const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
        const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
        return dt ? dt.toISOString() : undefined;
      })();
      const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/file-status?fileId=${encodeURIComponent(item.id)}${docMod ? `&amp;docModifiedAt=${encodeURIComponent(docMod)}` : &#39;&#39;}`, { cache: &#39;no-store&#39; });
      const data = await res.json();
      if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Status konnte nicht geladen werden&#39;);
      // Library-Stats parallel
      const statsRes = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/stats`, { cache: &#39;no-store&#39; });
      const stats = await statsRes.json().catch(() =&gt; ({}));
      setRagStatus({ ...data, totals: stats?.totals });
    } catch (e) {
      setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;);
    } finally {
      setRagLoading(false);
    }
  }

  if (error) {
    FileLogger.error(&#39;PreviewContent&#39;, &#39;Fehler in PreviewContent&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      error
    });
    return &lt;Alert variant=&quot;destructive&quot;&gt;&lt;AlertCircle className=&quot;h-4 w-4&quot; /&gt;&lt;AlertDescription&gt;{error}&lt;/AlertDescription&gt;&lt;/Alert&gt;;
  }

  // Debug-Log vor Switch-Statement
  FileLogger.debug(&#39;PreviewContent&#39;, &#39;Switch-Statement erreicht&#39;, {
    itemId: item.id,
    itemName: item.metadata.name,
    fileType,
    switchCase: fileType
  });

  switch (fileType) {
    case &#39;audio&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Audio-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;AudioPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;image&#39;:
      FileLogger.info(&#39;PreviewContent&#39;, &#39;ImagePreview wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        mimeType: item.metadata.mimeType,
        hasProvider: !!provider,
        providerName: provider?.name
      });
      return (
        &lt;ImagePreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;video&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Video-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;VideoPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;markdown&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Markdown-Editor wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        contentLength: content.length
      });
      return (
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;Tabs defaultValue=&quot;preview&quot; value={activeTab} onValueChange={setActiveTab} className=&quot;h-full flex flex-col&quot;&gt;
            &lt;TabsList className=&quot;mx-4 mt-2 flex-shrink-0&quot;&gt;
              &lt;TabsTrigger value=&quot;preview&quot;&gt;Vorschau&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;edit&quot;&gt;Bearbeiten&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;rag&quot; onClick={() =&gt; { void loadRagStatus(); }}&gt;RAG&lt;/TabsTrigger&gt;
            &lt;/TabsList&gt;
            &lt;div className=&quot;flex-1 min-h-0&quot;&gt;
              &lt;TabsContent value=&quot;preview&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;flex items-center gap-2 px-4 py-2&quot;&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (A)&#39;)
                        console.log(&#39;[Upsert A] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert A] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert A
                  &lt;/button&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;B&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (B)&#39;)
                        console.log(&#39;[Upsert B] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert B] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert B
                  &lt;/button&gt;
                &lt;/div&gt;
                &lt;MarkdownPreview 
                  content={content}
                  currentFolderId={item.parentId}
                  provider={provider}
                  className=&quot;h-full&quot;
                  onTransform={() =&gt; setActiveTab(&quot;edit&quot;)}
                  onRefreshFolder={onRefreshFolder}
                /&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;rag&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;p-4 space-y-3&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between&quot;&gt;
                    &lt;div className=&quot;text-sm font-medium&quot;&gt;RAG-Status&lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={() =&gt; void loadRagStatus()}
                      &gt;
                        Aktualisieren
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content, mode: &#39;llm&#39; })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse (LLM) fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse (LLM)&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse (LLM)
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert&#39;);
                          }
                        }}
                      &gt;
                        Upsert
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary/70 text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const chaptersSrcUnknown: unknown = (ragStatus as unknown as { analyze?: { chapters?: unknown } })?.analyze?.chapters
                            const chaptersSrc: Array&lt;unknown&gt; | undefined = Array.isArray(chaptersSrcUnknown) ? chaptersSrcUnknown : undefined
                            if (!Array.isArray(chaptersSrc) || chaptersSrc.length === 0) {
                              throw new Error(&#39;Keine Kapitelanalyse vorhanden&#39;)
                            }
                            const chapters = chaptersSrc
                              .filter((c): c is { chapterId?: unknown; title?: unknown; summary: string; keywords?: unknown } =&gt; {
                                if (!c || typeof c !== &#39;object&#39;) return false
                                const s = (c as Record&lt;string, unknown&gt;).summary
                                return typeof s === &#39;string&#39; &amp;&amp; s.trim().length &gt; 0
                              })
                              .map((c, i) =&gt; {
                                const obj = c as Record&lt;string, unknown&gt;
                                const chapterId = typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : `chap-${i + 1}`
                                const title = typeof obj.title === &#39;string&#39; ? obj.title : `Kapitel ${i + 1}`
                                const summary = (obj.summary as string).slice(0, 1200)
                                const keywords = Array.isArray(obj.keywords) ? (obj.keywords as Array&lt;unknown&gt;).filter(k =&gt; typeof k === &#39;string&#39;).slice(0, 12) as string[] : undefined
                                return { chapterId, title, order: i + 1, summary, keywords }
                              })
                            if (chapters.length === 0) throw new Error(&#39;Keine Kapitel mit Summary gefunden&#39;)

                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const tocUnknown: unknown = (ragStatus as unknown as { analyze?: { toc?: unknown } })?.analyze?.toc
                            const toc: Array&lt;unknown&gt; | undefined = Array.isArray(tocUnknown) ? tocUnknown : undefined
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod, chapters, toc })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert (Analyse) fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert (Analyse)&#39;);
                          }
                        }}
                      &gt;
                        Upsert (Analyse)
                      &lt;/button&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  {ragLoading &amp;&amp; &lt;div className=&quot;text-sm text-muted-foreground&quot;&gt;Lade Status…&lt;/div&gt;}
                  {ragError &amp;&amp; &lt;div className=&quot;text-sm text-destructive&quot;&gt;{ragError}&lt;/div&gt;}
                  {ragStatus &amp;&amp; (
                    &lt;div className=&quot;space-y-2 text-sm&quot;&gt;
                      &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                        &lt;span&gt;Status:&lt;/span&gt;
                        &lt;span className={cn(
                          &#39;inline-flex items-center rounded px-2 py-0.5 text-xs&#39;,
                          ragStatus.status === &#39;ok&#39; &amp;&amp; &#39;bg-green-100 text-green-700&#39;,
                          ragStatus.status === &#39;stale&#39; &amp;&amp; &#39;bg-amber-100 text-amber-800&#39;,
                          ragStatus.status === &#39;not_indexed&#39; &amp;&amp; &#39;bg-gray-100 text-gray-700&#39;
                        )}&gt;
                          {ragStatus.status}
                        &lt;/span&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;fileId: {ragStatus?.fileName ? &#39;&#39; : &#39;&#39;}{(item.id)}&lt;/div&gt;
                      &lt;div&gt;Chunks: {ragStatus.chunkCount ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Upserted: {ragStatus.upsertedAt ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Dokument geändert: {ragStatus.docModifiedAt ?? &#39;—&#39;}&lt;/div&gt;
                      {ragStatus.totals &amp;&amp; (
                        &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;Index totals: {ragStatus.totals.docs} Docs, {ragStatus.totals.chunks} Chunks&lt;/div&gt;
                      )}
                      {ragStatus.docMeta &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Dokument-Metadaten&lt;/div&gt;
                          &lt;pre className=&quot;mt-1 max-h-44 overflow-auto whitespace-pre-wrap break-words text-xs bg-muted/30 p-2 rounded&quot;&gt;{JSON.stringify(ragStatus.docMeta, null, 2)}&lt;/pre&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus.toc &amp;&amp; Array.isArray(ragStatus.toc) &amp;&amp; ragStatus.toc.length &gt; 0 &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5&quot;&gt;
                            {ragStatus.toc.map((t, i: number) =&gt; {
                              const obj = t as Record&lt;string, unknown&gt;
                              const title = (typeof obj.title === &#39;string&#39; ? obj.title : (typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : &#39;Kapitel&#39;)) as string
                              const level = typeof obj.level === &#39;number&#39; ? obj.level : undefined
                              const page = typeof obj.page === &#39;number&#39; ? obj.page : undefined
                              const order = typeof obj.order === &#39;number&#39; ? obj.order : undefined
                              const startChunk = typeof obj.startChunk === &#39;number&#39; ? obj.startChunk : undefined
                              const endChunk = typeof obj.endChunk === &#39;number&#39; ? obj.endChunk : undefined
                              return (
                                &lt;li key={i} className=&quot;text-xs&quot;&gt;
                                  {title}
                                  {typeof level === &#39;number&#39; ? ` (L${level})` : &#39;&#39;}
                                  {typeof page === &#39;number&#39; ? ` · Seite ${page}` : &#39;&#39;}
                                  {typeof order === &#39;number&#39; ? ` · Reihenfolge ${order}` : &#39;&#39;}
                                  {typeof startChunk === &#39;number&#39; &amp;&amp; typeof endChunk === &#39;number&#39; ? ` · Chunks ${startChunk}-${endChunk}` : &#39;&#39;}
                                &lt;/li&gt;
                              )
                            })}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus?.analyze?.chapters &amp;&amp; Array.isArray(ragStatus.analyze.chapters) &amp;&amp; (
                        &lt;div className=&quot;mt-3&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel (Heuristik/LLM)&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5 text-xs max-h-56 overflow-auto&quot;&gt;
                            {ragStatus.analyze.chapters.map((c) =&gt; {
                              const obj = c as Record&lt;string, unknown&gt;
                              const id = typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : String(obj.chapterId ?? &#39;&#39;)
                              const level = typeof obj.level === &#39;number&#39; ? obj.level : undefined
                              const title = typeof obj.title === &#39;string&#39; ? obj.title : &#39;Kapitel&#39;
                              const startPage = typeof obj.startPage === &#39;number&#39; ? obj.startPage : undefined
                              const endPage = typeof obj.endPage === &#39;number&#39; ? obj.endPage : undefined
                              return (
                                &lt;li key={id}&gt;
                                  {typeof level === &#39;number&#39; ? `L${level}` : &#39;L?&#39;} · {title} · Seiten {startPage ?? &#39;—&#39;}–{endPage ?? &#39;—&#39;}
                                &lt;/li&gt;
                              )
                            })}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                    &lt;/div&gt;
                  )}
                &lt;/div&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;edit&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;TextEditor 
              content={content}
              provider={provider}
              onSaveAction={async (newContent: string) =&gt; {
                FileLogger.info(&#39;FilePreview&#39;, &#39;onSaveAction gestartet&#39;, {
                  itemId: item.id,
                  itemName: item.metadata.name,
                  contentLength: newContent.length,
                  hasProvider: !!provider,
                  hasOnRefreshFolder: !!onRefreshFolder
                });

                if (provider &amp;&amp; onRefreshFolder) {
                  try {
                    // Aktualisiere den lokalen State sofort
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Aktualisiere lokalen Content-State&#39;, {
                      oldContentLength: content.length,
                      newContentLength: newContent.length
                    });
                    onContentUpdated(newContent);

                    const blob = new Blob([newContent], { type: &#39;text/markdown&#39; });
                    const file = new File([blob], item.metadata.name, { type: &#39;text/markdown&#39; });

                    // Lösche die alte Datei
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lösche alte Datei&#39;, {
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    await provider.deleteItem(item.id);

                    // Lade die neue Datei hoch
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lade neue Datei hoch&#39;, {
                      fileName: file.name,
                      fileSize: file.size,
                      parentId: item.parentId
                    });
                    const updatedItem = await provider.uploadFile(item.parentId, file);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Upload abgeschlossen&#39;, {
                      success: !!updatedItem,
                      newItemId: updatedItem?.id,
                      newItemName: updatedItem?.metadata.name
                    });

                    // Aktualisiere den Cache mit dem neuen Inhalt und der neuen ID
                    if (updatedItem) {
                      // Lösche den alten Cache-Eintrag
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Lösche alten Eintrag&#39;, {
                        oldItemId: item.id,
                        cacheSize: contentCache.current.size
                      });
                      contentCache.current.delete(item.id);

                      // Füge den neuen Inhalt zum Cache hinzu
                      const hasMetadata = !!extractFrontmatter(newContent);
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Füge neuen Eintrag hinzu&#39;, {
                        newItemId: updatedItem.id,
                        hasMetadata,
                        contentLength: newContent.length
                      });
                      contentCache.current.set(updatedItem.id, { 
                        content: newContent, 
                        hasMetadata 
                      });

                      // Aktualisiere das selectedFileAtom mit der neuen Datei
                      FileLogger.info(&#39;FilePreview&#39;, &#39;Aktualisiere selectedFileAtom&#39;, {
                        oldId: item.id,
                        newId: updatedItem.id
                      });
                      setSelectedFile(updatedItem);
                    }

                    // Hole die aktualisierten Items
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Hole aktualisierte Dateiliste&#39;, {
                      parentId: item.parentId
                    });
                    const updatedItems = await provider.listItemsById(item.parentId);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Dateiliste aktualisiert&#39;, {
                      itemCount: updatedItems.length
                    });

                    // Wechsle zur Vorschau
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Wechsle zu Vorschau-Tab&#39;);
                    setActiveTab(&quot;preview&quot;);

                    // Informiere die übergeordnete Komponente
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Rufe onRefreshFolder auf&#39;, {
                      parentId: item.parentId,
                      updatedItemsCount: updatedItems.length,
                      updatedItemId: updatedItem?.id
                    });
                    onRefreshFolder(item.parentId, updatedItems, updatedItem);
                  } catch (error) {
                    FileLogger.error(&#39;FilePreview&#39;, &#39;Fehler beim Aktualisieren der Datei&#39;, {
                      error,
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    throw error; // Werfe den Fehler weiter, damit TextEditor ihn anzeigen kann
                  }
                } else {
                  FileLogger.warn(&#39;FilePreview&#39;, &#39;Speichern nicht möglich&#39;, {
                    hasProvider: !!provider,
                    hasOnRefreshFolder: !!onRefreshFolder
                  });
                  // Werfe einen Fehler, damit TextEditor ihn anzeigen kann
                  throw new Error(&#39;Speichern nicht möglich: onRefreshFolder Callback fehlt&#39;);
                }
              }}
                          /&gt;
              &lt;/TabsContent&gt;
            &lt;/div&gt;
          &lt;/Tabs&gt;
        &lt;/div&gt;
      );
    case &#39;pdf&#39;:
    case &#39;docx&#39;:
    case &#39;pptx&#39;:
    case &#39;xlsx&#39;:
    case &#39;presentation&#39;:
      return (
        &lt;DocumentPreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;website&#39;:
      const urlContent = content.match(/URL=(.*)/)?.[1];
      return urlContent ? (
        &lt;iframe 
          src={urlContent}
          title={item.metadata.name}
          className=&quot;w-full h-screen&quot;
        /&gt;
      ) : (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine gültige URL gefunden.
        &lt;/div&gt;
      );
    default:
      return (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine Vorschau verfügbar für diesen Dateityp.
        &lt;/div&gt;
      );
  }
}

// Definiere einen Typ für den State
interface FilePreviewState {
  content: string;
  error: string | null;
  hasMetadata: boolean;
}

// Hauptkomponente
export function FilePreview({ 
  className,
  provider,
  file,
  onRefreshFolder
}: FilePreviewProps) {
  const activeLibraryId = useAtomValue(activeLibraryIdAtom);
  const selectedFileFromAtom = useAtomValue(selectedFileAtom);

  // Verwende explizite file prop oder fallback zum selectedFileAtom
  const displayFile = file || selectedFileFromAtom;

  // Debug-Log für FilePreview-Hauptkomponente
  React.useEffect(() =&gt; {
    const timeoutId = setTimeout(() =&gt; {
      FileLogger.info(&#39;FilePreview&#39;, &#39;FilePreview-Hauptkomponente gerendert&#39;, {
        hasExplicitFile: !!file,
        hasSelectedFileFromAtom: !!selectedFileFromAtom,
        displayFileId: displayFile?.id,
        displayFileName: displayFile?.metadata.name,
        hasProvider: !!provider,
        providerName: provider?.name,
        activeLibraryId
      });
    }, 0);

    return () =&gt; clearTimeout(timeoutId);
  }, [file, selectedFileFromAtom, displayFile, provider, activeLibraryId]);

  // Gemeinsamer Cache für den Inhalt von Dateien
  const contentCache = React.useRef&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;(new Map());

  // Passe den Reducer an
  const reducer = React.useCallback((state: FilePreviewState, action: { type: string; content?: string; hasMetadata?: boolean; error?: string }) =&gt; {
    switch (action.type) {
      case &#39;SET_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39;, hasMetadata: action.hasMetadata ?? false };
      case &#39;SET_ERROR&#39;:
        return { ...state, error: action.error ?? null };
      case &#39;UPDATE_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39; };
      default:
        return state;
    }
  }, []);

  const [state, dispatch] = React.useReducer(reducer, {
    content: &#39;&#39;,
    error: null,
    hasMetadata: false
  });

  // Memoize computed values
  const fileType = React.useMemo(() =&gt; 
    displayFile ? getFileType(displayFile.metadata.name) : &#39;unknown&#39;, 
    [displayFile]
  );

  const isAudioFile = React.useMemo(() =&gt; fileType === &#39;audio&#39;, [fileType]);
  const isVideoFile = React.useMemo(() =&gt; fileType === &#39;video&#39;, [fileType]);

  // Debug-Log für computed values
  React.useEffect(() =&gt; {
    if (displayFile) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Computed values aktualisiert&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          fileType,
          isAudioFile,
          isVideoFile,
          mimeType: displayFile.metadata.mimeType
        });
      }, 0);

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile, fileType, isAudioFile, isVideoFile]);

  // Memoize content loader callback
  const handleContentLoaded = React.useCallback((content: string, hasMetadata: boolean) =&gt; {
    dispatch({ type: &#39;SET_CONTENT&#39;, content, hasMetadata });
  }, []);

  // Callback für direkte Aktualisierung des Inhalts
  const handleContentUpdated = React.useCallback((content: string) =&gt; {
    dispatch({ type: &#39;UPDATE_CONTENT&#39;, content });
  }, []);

  // Cache leeren, wenn sich die Item-ID ändert
  React.useEffect(() =&gt; {
    if (displayFile?.id) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Neues Item geladen, Cache wird geprüft&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          cacheSize: contentCache.current.size
        });
      }, 0);

      // Nur Cache-Einträge löschen, die nicht zur aktuellen Datei gehören
      const currentCache = contentCache.current.get(displayFile.id);
      if (!currentCache) {
        // Wenn die aktuelle Datei nicht im Cache ist, lösche alte Einträge
        Array.from(contentCache.current.keys()).forEach(key =&gt; {
          if (key !== displayFile.id) {
            contentCache.current.delete(key);
          }
        });
      }

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile?.id]);

  if (!displayFile) {
    return (
      &lt;div className={cn(&quot;flex items-center justify-center h-full&quot;, className)}&gt;
        &lt;p className=&quot;text-muted-foreground&quot;&gt;Keine Datei ausgewählt&lt;/p&gt;
      &lt;/div&gt;
    );
  }

  return (
    &lt;div className={cn(&quot;h-full flex flex-col&quot;, className)}&gt;
      &lt;ContentLoader
        item={displayFile}
        provider={provider}
        fileType={fileType}
        isAudioFile={isAudioFile}
        isVideoFile={isVideoFile}
        contentCache={contentCache}
        onContentLoaded={handleContentLoaded}
      /&gt;
      &lt;div className=&quot;flex-1 overflow-auto&quot;&gt;
        &lt;PreviewContent
          item={displayFile}
          fileType={fileType}
          content={state.content}
          error={state.error}
          activeLibraryId={activeLibraryId}
          provider={provider}
          contentCache={contentCache}
          onContentUpdated={handleContentUpdated}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Ich passe den Typ von ragStatus in <code>src/components/library/file-preview.tsx</code> an, damit <code>analyze</code> typisiert ist, und baue danach erneut.</p>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import * as React from &#39;react&#39;;
import { cn } from &quot;@/lib/utils&quot;;
import { Alert, AlertDescription } from &quot;@/components/ui/alert&quot;;
import { AlertCircle } from &quot;lucide-react&quot;;
import { AudioPlayer } from &#39;./audio-player&#39;;
import { VideoPlayer } from &#39;./video-player&#39;;
import { MarkdownPreview } from &#39;./markdown-preview&#39;;
import { Tabs, TabsContent, TabsList, TabsTrigger } from &quot;@/components/ui/tabs&quot;;
import &#39;./markdown-audio&#39;;
import { useAtomValue, useSetAtom } from &quot;jotai&quot;;
import { activeLibraryIdAtom, selectedFileAtom } from &quot;@/atoms/library-atom&quot;;
import { TextEditor } from &#39;./text-editor&#39;;
import { StorageItem, StorageProvider } from &quot;@/lib/storage/types&quot;;
import { extractFrontmatter } from &#39;./markdown-metadata&#39;;
import { ImagePreview } from &#39;./image-preview&#39;;
import { DocumentPreview } from &#39;./document-preview&#39;;
import { FileLogger } from &quot;@/lib/debug/logger&quot;

// Explizite React-Komponenten-Deklarationen für den Linter
const ImagePreviewComponent = ImagePreview;
const DocumentPreviewComponent = DocumentPreview;

interface FilePreviewProps {
  className?: string;
  provider: StorageProvider | null;
  file?: StorageItem | null; // Neue prop für explizite Datei-Auswahl
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}

// Helper function for file type detection
function getFileType(fileName: string): string {
  const extension = fileName.split(&#39;.&#39;).pop()?.toLowerCase();

  switch(extension) {
    case &#39;txt&#39;:
    case &#39;md&#39;:
    case &#39;mdx&#39;:
      return &#39;markdown&#39;;
    case &#39;mp4&#39;:
    case &#39;avi&#39;:
    case &#39;mov&#39;:
    case &#39;webm&#39;:
    case &#39;mkv&#39;:
      return &#39;video&#39;;
    case &#39;mp3&#39;:
    case &#39;m4a&#39;:
    case &#39;wav&#39;:
    case &#39;ogg&#39;:
    case &#39;opus&#39;:
    case &#39;flac&#39;:
      return &#39;audio&#39;;
    case &#39;jpg&#39;:
    case &#39;jpeg&#39;:
    case &#39;png&#39;:
    case &#39;gif&#39;:
    case &#39;webp&#39;:
    case &#39;svg&#39;:
    case &#39;bmp&#39;:
    case &#39;ico&#39;:
      return &#39;image&#39;;
    case &#39;pdf&#39;:
      return &#39;pdf&#39;;
    case &#39;doc&#39;:
    case &#39;docx&#39;:
      return &#39;docx&#39;;
    case &#39;odt&#39;:
      return &#39;docx&#39;;
    case &#39;ppt&#39;:
    case &#39;pptx&#39;:
      return &#39;pptx&#39;;
    case &#39;xls&#39;:
    case &#39;xlsx&#39;:
      return &#39;xlsx&#39;;
    case &#39;url&#39;:
      return &#39;website&#39;;
    default:
      // Für unbekannte Dateitypen prüfen wir, ob es sich um eine Textdatei handeln könnte
      const textExtensions = [&#39;json&#39;, &#39;xml&#39;, &#39;yaml&#39;, &#39;yml&#39;, &#39;ini&#39;, &#39;cfg&#39;, &#39;conf&#39;, &#39;log&#39;, &#39;csv&#39;, &#39;html&#39;, &#39;htm&#39;, &#39;css&#39;, &#39;js&#39;, &#39;ts&#39;, &#39;jsx&#39;, &#39;tsx&#39;, &#39;py&#39;, &#39;java&#39;, &#39;c&#39;, &#39;cpp&#39;, &#39;h&#39;, &#39;hpp&#39;, &#39;cs&#39;, &#39;php&#39;, &#39;rb&#39;, &#39;go&#39;, &#39;rs&#39;, &#39;swift&#39;, &#39;kt&#39;, &#39;scala&#39;, &#39;r&#39;, &#39;sh&#39;, &#39;bash&#39;, &#39;ps1&#39;, &#39;bat&#39;, &#39;cmd&#39;, &#39;odt&#39;];
      if (textExtensions.includes(extension || &#39;&#39;)) {
        return &#39;markdown&#39;; // Behandle als editierbare Textdatei
      }
      return &#39;unknown&#39;;
  }
}

// Separate Komponente für den Content Loader
function ContentLoader({ 
  item, 
  provider, 
  fileType, 
  isAudioFile, 
  isVideoFile, 
  contentCache,
  onContentLoaded 
}: {
  item: StorageItem | null;
  provider: StorageProvider | null;
  fileType: string;
  isAudioFile: boolean;
  isVideoFile: boolean;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentLoaded: (content: string, hasMetadata: boolean) =&gt; void;
}) {
  const loadingIdRef = React.useRef&lt;string | null&gt;(null);

  // Prüft ob eine Datei ein Template ist
  const isTemplateFile = React.useCallback((name?: string): boolean =&gt; {
    if (!name) return false;
    return name.includes(&#39;{{&#39;) &amp;&amp; name.includes(&#39;}}&#39;);
  }, []);

  const loadContent = React.useCallback(async () =&gt; {
    if (!item?.id || !provider) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;loadContent abgebrochen&#39;, {
        hasItem: !!item?.id,
        hasProvider: !!provider
      });
      return;
    }

    FileLogger.info(&#39;ContentLoader&#39;, &#39;Lade Content für Datei&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      cacheSize: contentCache.current.size
    });

    // Prüfen ob Inhalt bereits im Cache
    const cachedContent = contentCache.current.get(item.id);
    if (cachedContent) {
      FileLogger.info(&#39;ContentLoader&#39;, &#39;Content aus Cache geladen&#39;, {
        itemId: item.id,
        contentLength: cachedContent.content.length,
        hasMetadata: cachedContent.hasMetadata
      });
      onContentLoaded(cachedContent.content, cachedContent.hasMetadata);
      return;
    }

    // Prüfen ob bereits ein Ladevorgang läuft
    if (loadingIdRef.current === item.id) {
      FileLogger.debug(&#39;ContentLoader&#39;, &#39;Ladevorgang läuft bereits&#39;, {
        itemId: item.id
      });
      return;
    }

    loadingIdRef.current = item.id;

    try {
      // Wenn es eine Template-Datei ist, zeigen wir eine Warnung an
      if (isTemplateFile(item.metadata.name)) {
        const content = &quot;---\nstatus: template\n---\n\n&gt; **Hinweis**: Diese Datei enthält nicht aufgelöste Template-Variablen.\n&gt; Bitte stellen Sie sicher, dass alle Variablen korrekt definiert sind.&quot;;
        contentCache.current.set(item.id, { content, hasMetadata: true });
        onContentLoaded(content, true);
        return;
      }

      // Liste der Dateitypen, die als Binärdateien behandelt werden sollen
      const binaryFileTypes = [&#39;audio&#39;, &#39;image&#39;, &#39;video&#39;, &#39;pdf&#39;, &#39;docx&#39;, &#39;pptx&#39;, &#39;xlsx&#39;];

      if (!binaryFileTypes.includes(fileType) &amp;&amp; fileType !== &#39;unknown&#39;) {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Lade Textinhalt von Provider&#39;, {
          itemId: item.id,
          fileType
        });
        const content = await provider.getBinary(item.id).then(({ blob }) =&gt; blob.text());
        const hasMetadata = !!extractFrontmatter(content);

        FileLogger.info(&#39;ContentLoader&#39;, &#39;Content geladen und in Cache gespeichert&#39;, {
          itemId: item.id,
          contentLength: content.length,
          hasMetadata
        });

        contentCache.current.set(item.id, { content, hasMetadata });
        onContentLoaded(content, hasMetadata);
      } else {
        FileLogger.debug(&#39;ContentLoader&#39;, &#39;Überspringe Content-Laden für Binary/Unknown-Datei&#39;, {
          itemId: item.id,
          fileType,
          isBinary: binaryFileTypes.includes(fileType),
          isUnknown: fileType === &#39;unknown&#39;
        });
        contentCache.current.set(item.id, { content: &#39;&#39;, hasMetadata: false });
        onContentLoaded(&#39;&#39;, false);
      }
    } catch (err) {
      FileLogger.error(&#39;ContentLoader&#39;, &#39;Failed to load file&#39;, err);
      // Bei Fehler zeigen wir eine Fehlermeldung im Markdown-Format
      const errorContent = &quot;---\nstatus: error\n---\n\n&gt; **Fehler**: Die Datei konnte nicht geladen werden.\n&gt; Bitte überprüfen Sie die Konsole für weitere Details.&quot;;
      contentCache.current.set(item.id, { content: errorContent, hasMetadata: true });
      onContentLoaded(errorContent, true);
    } finally {
      loadingIdRef.current = null;
    }
  }, [item?.id, item?.metadata?.name, provider, fileType, isAudioFile, isVideoFile, onContentLoaded, isTemplateFile, contentCache]);

  // Cleanup bei Unmount
  React.useEffect(() =&gt; {
    return () =&gt; {
      loadingIdRef.current = null;
    };
  }, []);

  // Nur laden wenn sich die ID ändert
  React.useEffect(() =&gt; {
    if (item?.id) {
      loadContent();
    }
  }, [item?.id, loadContent]);

  return null;
}

// Separate Komponente für die Vorschau
function PreviewContent({ 
  item, 
  fileType, 
  content, 
  error, 
  activeLibraryId,
  provider,
  contentCache,
  onContentUpdated,
  onRefreshFolder
}: {
  item: StorageItem;
  fileType: string;
  content: string;
  error: string | null;
  activeLibraryId: string;
  provider: StorageProvider | null;
  contentCache: React.MutableRefObject&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;;
  onContentUpdated: (content: string) =&gt; void;
  onRefreshFolder?: (folderId: string, items: StorageItem[], selectFileAfterRefresh?: StorageItem) =&gt; void;
}) {
  const [activeTab, setActiveTab] = React.useState&lt;string&gt;(&quot;preview&quot;);
  const [ragLoading, setRagLoading] = React.useState(false);
  const [ragError, setRagError] = React.useState&lt;string | null&gt;(null);
  const [ragStatus, setRagStatus] = React.useState&lt;{
    status: &#39;ok&#39; | &#39;stale&#39; | &#39;not_indexed&#39;;
    fileName?: string;
    chunkCount?: number;
    upsertedAt?: string;
    docModifiedAt?: string;
    docMeta?: Record&lt;string, unknown&gt;;
    toc?: Array&lt;Record&lt;string, unknown&gt;&gt;;
    totals?: { docs: number; chunks: number };
    analyze?: { chapters?: Array&lt;Record&lt;string, unknown&gt;&gt;; toc?: Array&lt;Record&lt;string, unknown&gt;&gt; };
  } | null&gt;(null);
  const setSelectedFile = useSetAtom(selectedFileAtom);

  // Debug-Log für PreviewContent
  React.useEffect(() =&gt; {
    FileLogger.info(&#39;PreviewContent&#39;, &#39;PreviewContent gerendert&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      fileType,
      contentLength: content.length,
      hasError: !!error,
      hasProvider: !!provider,
      activeLibraryId
    });
  }, [item.id, fileType, content.length, error, provider, activeLibraryId]);

  React.useEffect(() =&gt; {
    setActiveTab(&quot;preview&quot;);
  }, [item.id]);

  async function loadRagStatus() {
    try {
      setRagLoading(true);
      setRagError(null);
      const docMod = (() =&gt; {
        const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
        const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
        return dt ? dt.toISOString() : undefined;
      })();
      const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/file-status?fileId=${encodeURIComponent(item.id)}${docMod ? `&amp;docModifiedAt=${encodeURIComponent(docMod)}` : &#39;&#39;}`, { cache: &#39;no-store&#39; });
      const data = await res.json();
      if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Status konnte nicht geladen werden&#39;);
      // Library-Stats parallel
      const statsRes = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/stats`, { cache: &#39;no-store&#39; });
      const stats = await statsRes.json().catch(() =&gt; ({}));
      setRagStatus({ ...data, totals: stats?.totals });
    } catch (e) {
      setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;);
    } finally {
      setRagLoading(false);
    }
  }

  if (error) {
    FileLogger.error(&#39;PreviewContent&#39;, &#39;Fehler in PreviewContent&#39;, {
      itemId: item.id,
      itemName: item.metadata.name,
      error
    });
    return &lt;Alert variant=&quot;destructive&quot;&gt;&lt;AlertCircle className=&quot;h-4 w-4&quot; /&gt;&lt;AlertDescription&gt;{error}&lt;/AlertDescription&gt;&lt;/Alert&gt;;
  }

  // Debug-Log vor Switch-Statement
  FileLogger.debug(&#39;PreviewContent&#39;, &#39;Switch-Statement erreicht&#39;, {
    itemId: item.id,
    itemName: item.metadata.name,
    fileType,
    switchCase: fileType
  });

  switch (fileType) {
    case &#39;audio&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Audio-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;AudioPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;image&#39;:
      FileLogger.info(&#39;PreviewContent&#39;, &#39;ImagePreview wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        mimeType: item.metadata.mimeType,
        hasProvider: !!provider,
        providerName: provider?.name
      });
      return (
        &lt;ImagePreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;video&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Video-Player wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name
      });
      return &lt;VideoPlayer provider={provider} activeLibraryId={activeLibraryId} onRefreshFolder={onRefreshFolder} /&gt;;
    case &#39;markdown&#39;:
      FileLogger.debug(&#39;PreviewContent&#39;, &#39;Markdown-Editor wird gerendert&#39;, {
        itemId: item.id,
        itemName: item.metadata.name,
        contentLength: content.length
      });
      return (
        &lt;div className=&quot;h-full flex flex-col&quot;&gt;
          &lt;Tabs defaultValue=&quot;preview&quot; value={activeTab} onValueChange={setActiveTab} className=&quot;h-full flex flex-col&quot;&gt;
            &lt;TabsList className=&quot;mx-4 mt-2 flex-shrink-0&quot;&gt;
              &lt;TabsTrigger value=&quot;preview&quot;&gt;Vorschau&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;edit&quot;&gt;Bearbeiten&lt;/TabsTrigger&gt;
              &lt;TabsTrigger value=&quot;rag&quot; onClick={() =&gt; { void loadRagStatus(); }}&gt;RAG&lt;/TabsTrigger&gt;
            &lt;/TabsList&gt;
            &lt;div className=&quot;flex-1 min-h-0&quot;&gt;
              &lt;TabsContent value=&quot;preview&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;flex items-center gap-2 px-4 py-2&quot;&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (A)&#39;)
                        console.log(&#39;[Upsert A] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert A] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert A
                  &lt;/button&gt;
                  &lt;button
                    className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                    onClick={async () =&gt; {
                      try {
                        const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                          method: &#39;POST&#39;,
                          headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                          body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;B&#39; }),
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Upsert (B)&#39;)
                        console.log(&#39;[Upsert B] OK:&#39;, data)
                      } catch (e) {
                        console.error(&#39;[Upsert B] Fehler:&#39;, e)
                      }
                    }}
                  &gt;
                    Upsert B
                  &lt;/button&gt;
                &lt;/div&gt;
                &lt;MarkdownPreview 
                  content={content}
                  currentFolderId={item.parentId}
                  provider={provider}
                  className=&quot;h-full&quot;
                  onTransform={() =&gt; setActiveTab(&quot;edit&quot;)}
                  onRefreshFolder={onRefreshFolder}
                /&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;rag&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;div className=&quot;p-4 space-y-3&quot;&gt;
                  &lt;div className=&quot;flex items-center justify-between&quot;&gt;
                    &lt;div className=&quot;text-sm font-medium&quot;&gt;RAG-Status&lt;/div&gt;
                    &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={() =&gt; void loadRagStatus()}
                      &gt;
                        Aktualisieren
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-muted px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/analyze-chapters`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, content, mode: &#39;llm&#39; })
                            })
                            const data = await res.json()
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Kapitelanalyse (LLM) fehlgeschlagen&#39;)
                            setRagStatus(prev =&gt; ({ ...(prev ?? { status: &#39;not_indexed&#39; as const }), analyze: data?.result }))
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler bei Kapitelanalyse (LLM)&#39;)
                          }
                        }}
                      &gt;
                        Kapitelanalyse (LLM)
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert&#39;);
                          }
                        }}
                      &gt;
                        Upsert
                      &lt;/button&gt;
                      &lt;button
                        className=&quot;inline-flex h-8 items-center rounded-md bg-primary/70 text-primary-foreground px-3 text-xs&quot;
                        onClick={async () =&gt; {
                          try {
                            const chaptersSrcUnknown: unknown = (ragStatus as unknown as { analyze?: { chapters?: unknown } })?.analyze?.chapters
                            const chaptersSrc: Array&lt;unknown&gt; | undefined = Array.isArray(chaptersSrcUnknown) ? chaptersSrcUnknown : undefined
                            if (!Array.isArray(chaptersSrc) || chaptersSrc.length === 0) {
                              throw new Error(&#39;Keine Kapitelanalyse vorhanden&#39;)
                            }
                            const chapters = chaptersSrc
                              .filter((c): c is { chapterId?: unknown; title?: unknown; summary: string; keywords?: unknown } =&gt; {
                                if (!c || typeof c !== &#39;object&#39;) return false
                                const s = (c as Record&lt;string, unknown&gt;).summary
                                return typeof s === &#39;string&#39; &amp;&amp; s.trim().length &gt; 0
                              })
                              .map((c, i) =&gt; {
                                const obj = c as Record&lt;string, unknown&gt;
                                const chapterId = typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : `chap-${i + 1}`
                                const title = typeof obj.title === &#39;string&#39; ? obj.title : `Kapitel ${i + 1}`
                                const summary = (obj.summary as string).slice(0, 1200)
                                const keywords = Array.isArray(obj.keywords) ? (obj.keywords as Array&lt;unknown&gt;).filter(k =&gt; typeof k === &#39;string&#39;).slice(0, 12) as string[] : undefined
                                return { chapterId, title, order: i + 1, summary, keywords }
                              })
                            if (chapters.length === 0) throw new Error(&#39;Keine Kapitel mit Summary gefunden&#39;)

                            const docMod = (() =&gt; {
                              const d = item.metadata.modifiedAt as unknown as Date | string | number | undefined;
                              const dt = d instanceof Date ? d : (d ? new Date(d) : undefined);
                              return dt ? dt.toISOString() : undefined;
                            })();
                            const tocUnknown: unknown = (ragStatus as unknown as { analyze?: { toc?: unknown } })?.analyze?.toc
                            const toc: Array&lt;unknown&gt; | undefined = Array.isArray(tocUnknown) ? tocUnknown : undefined
                            const res = await fetch(`/api/chat/${encodeURIComponent(activeLibraryId)}/upsert-file`, {
                              method: &#39;POST&#39;,
                              headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
                              body: JSON.stringify({ fileId: item.id, fileName: item.metadata.name, content, mode: &#39;A&#39;, docModifiedAt: docMod, chapters, toc })
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Upsert (Analyse) fehlgeschlagen&#39;);
                            await loadRagStatus();
                          } catch (e) {
                            setRagError(e instanceof Error ? e.message : &#39;Unbekannter Fehler beim Upsert (Analyse)&#39;);
                          }
                        }}
                      &gt;
                        Upsert (Analyse)
                      &lt;/button&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                  {ragLoading &amp;&amp; &lt;div className=&quot;text-sm text-muted-foreground&quot;&gt;Lade Status…&lt;/div&gt;}
                  {ragError &amp;&amp; &lt;div className=&quot;text-sm text-destructive&quot;&gt;{ragError}&lt;/div&gt;}
                  {ragStatus &amp;&amp; (
                    &lt;div className=&quot;space-y-2 text-sm&quot;&gt;
                      &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                        &lt;span&gt;Status:&lt;/span&gt;
                        &lt;span className={cn(
                          &#39;inline-flex items-center rounded px-2 py-0.5 text-xs&#39;,
                          ragStatus.status === &#39;ok&#39; &amp;&amp; &#39;bg-green-100 text-green-700&#39;,
                          ragStatus.status === &#39;stale&#39; &amp;&amp; &#39;bg-amber-100 text-amber-800&#39;,
                          ragStatus.status === &#39;not_indexed&#39; &amp;&amp; &#39;bg-gray-100 text-gray-700&#39;
                        )}&gt;
                          {ragStatus.status}
                        &lt;/span&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;fileId: {ragStatus?.fileName ? &#39;&#39; : &#39;&#39;}{(item.id)}&lt;/div&gt;
                      &lt;div&gt;Chunks: {ragStatus.chunkCount ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Upserted: {ragStatus.upsertedAt ?? &#39;—&#39;}&lt;/div&gt;
                      &lt;div&gt;Dokument geändert: {ragStatus.docModifiedAt ?? &#39;—&#39;}&lt;/div&gt;
                      {ragStatus.totals &amp;&amp; (
                        &lt;div className=&quot;text-xs text-muted-foreground&quot;&gt;Index totals: {ragStatus.totals.docs} Docs, {ragStatus.totals.chunks} Chunks&lt;/div&gt;
                      )}
                      {ragStatus.docMeta &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Dokument-Metadaten&lt;/div&gt;
                          &lt;pre className=&quot;mt-1 max-h-44 overflow-auto whitespace-pre-wrap break-words text-xs bg-muted/30 p-2 rounded&quot;&gt;{JSON.stringify(ragStatus.docMeta, null, 2)}&lt;/pre&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus.toc &amp;&amp; Array.isArray(ragStatus.toc) &amp;&amp; ragStatus.toc.length &gt; 0 &amp;&amp; (
                        &lt;div className=&quot;mt-2&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5&quot;&gt;
                            {ragStatus.toc.map((t, i: number) =&gt; {
                              const obj = t as Record&lt;string, unknown&gt;
                              const title = (typeof obj.title === &#39;string&#39; ? obj.title : (typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : &#39;Kapitel&#39;)) as string
                              const level = typeof obj.level === &#39;number&#39; ? obj.level : undefined
                              const page = typeof obj.page === &#39;number&#39; ? obj.page : undefined
                              const order = typeof obj.order === &#39;number&#39; ? obj.order : undefined
                              const startChunk = typeof obj.startChunk === &#39;number&#39; ? obj.startChunk : undefined
                              const endChunk = typeof obj.endChunk === &#39;number&#39; ? obj.endChunk : undefined
                              return (
                                &lt;li key={i} className=&quot;text-xs&quot;&gt;
                                  {title}
                                  {typeof level === &#39;number&#39; ? ` (L${level})` : &#39;&#39;}
                                  {typeof page === &#39;number&#39; ? ` · Seite ${page}` : &#39;&#39;}
                                  {typeof order === &#39;number&#39; ? ` · Reihenfolge ${order}` : &#39;&#39;}
                                  {typeof startChunk === &#39;number&#39; &amp;&amp; typeof endChunk === &#39;number&#39; ? ` · Chunks ${startChunk}-${endChunk}` : &#39;&#39;}
                                &lt;/li&gt;
                              )
                            })}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                      {ragStatus?.analyze?.chapters &amp;&amp; Array.isArray(ragStatus.analyze.chapters) &amp;&amp; (
                        &lt;div className=&quot;mt-3&quot;&gt;
                          &lt;div className=&quot;font-medium&quot;&gt;Kapitel (Heuristik/LLM)&lt;/div&gt;
                          &lt;ul className=&quot;mt-1 space-y-1 list-disc pl-5 text-xs max-h-56 overflow-auto&quot;&gt;
                            {ragStatus.analyze.chapters.map((c) =&gt; {
                              const obj = c as Record&lt;string, unknown&gt;
                              const id = typeof obj.chapterId === &#39;string&#39; ? obj.chapterId : String(obj.chapterId ?? &#39;&#39;)
                              const level = typeof obj.level === &#39;number&#39; ? obj.level : undefined
                              const title = typeof obj.title === &#39;string&#39; ? obj.title : &#39;Kapitel&#39;
                              const startPage = typeof obj.startPage === &#39;number&#39; ? obj.startPage : undefined
                              const endPage = typeof obj.endPage === &#39;number&#39; ? obj.endPage : undefined
                              return (
                                &lt;li key={id}&gt;
                                  {typeof level === &#39;number&#39; ? `L${level}` : &#39;L?&#39;} · {title} · Seiten {startPage ?? &#39;—&#39;}–{endPage ?? &#39;—&#39;}
                                &lt;/li&gt;
                              )
                            })}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      )}
                    &lt;/div&gt;
                  )}
                &lt;/div&gt;
              &lt;/TabsContent&gt;
              &lt;TabsContent value=&quot;edit&quot; className=&quot;h-full mt-0&quot;&gt;
                &lt;TextEditor 
              content={content}
              provider={provider}
              onSaveAction={async (newContent: string) =&gt; {
                FileLogger.info(&#39;FilePreview&#39;, &#39;onSaveAction gestartet&#39;, {
                  itemId: item.id,
                  itemName: item.metadata.name,
                  contentLength: newContent.length,
                  hasProvider: !!provider,
                  hasOnRefreshFolder: !!onRefreshFolder
                });

                if (provider &amp;&amp; onRefreshFolder) {
                  try {
                    // Aktualisiere den lokalen State sofort
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Aktualisiere lokalen Content-State&#39;, {
                      oldContentLength: content.length,
                      newContentLength: newContent.length
                    });
                    onContentUpdated(newContent);

                    const blob = new Blob([newContent], { type: &#39;text/markdown&#39; });
                    const file = new File([blob], item.metadata.name, { type: &#39;text/markdown&#39; });

                    // Lösche die alte Datei
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lösche alte Datei&#39;, {
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    await provider.deleteItem(item.id);

                    // Lade die neue Datei hoch
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Lade neue Datei hoch&#39;, {
                      fileName: file.name,
                      fileSize: file.size,
                      parentId: item.parentId
                    });
                    const updatedItem = await provider.uploadFile(item.parentId, file);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Upload abgeschlossen&#39;, {
                      success: !!updatedItem,
                      newItemId: updatedItem?.id,
                      newItemName: updatedItem?.metadata.name
                    });

                    // Aktualisiere den Cache mit dem neuen Inhalt und der neuen ID
                    if (updatedItem) {
                      // Lösche den alten Cache-Eintrag
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Lösche alten Eintrag&#39;, {
                        oldItemId: item.id,
                        cacheSize: contentCache.current.size
                      });
                      contentCache.current.delete(item.id);

                      // Füge den neuen Inhalt zum Cache hinzu
                      const hasMetadata = !!extractFrontmatter(newContent);
                      FileLogger.debug(&#39;FilePreview&#39;, &#39;Cache-Update: Füge neuen Eintrag hinzu&#39;, {
                        newItemId: updatedItem.id,
                        hasMetadata,
                        contentLength: newContent.length
                      });
                      contentCache.current.set(updatedItem.id, { 
                        content: newContent, 
                        hasMetadata 
                      });

                      // Aktualisiere das selectedFileAtom mit der neuen Datei
                      FileLogger.info(&#39;FilePreview&#39;, &#39;Aktualisiere selectedFileAtom&#39;, {
                        oldId: item.id,
                        newId: updatedItem.id
                      });
                      setSelectedFile(updatedItem);
                    }

                    // Hole die aktualisierten Items
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Hole aktualisierte Dateiliste&#39;, {
                      parentId: item.parentId
                    });
                    const updatedItems = await provider.listItemsById(item.parentId);

                    FileLogger.info(&#39;FilePreview&#39;, &#39;Dateiliste aktualisiert&#39;, {
                      itemCount: updatedItems.length
                    });

                    // Wechsle zur Vorschau
                    FileLogger.debug(&#39;FilePreview&#39;, &#39;Wechsle zu Vorschau-Tab&#39;);
                    setActiveTab(&quot;preview&quot;);

                    // Informiere die übergeordnete Komponente
                    FileLogger.info(&#39;FilePreview&#39;, &#39;Rufe onRefreshFolder auf&#39;, {
                      parentId: item.parentId,
                      updatedItemsCount: updatedItems.length,
                      updatedItemId: updatedItem?.id
                    });
                    onRefreshFolder(item.parentId, updatedItems, updatedItem);
                  } catch (error) {
                    FileLogger.error(&#39;FilePreview&#39;, &#39;Fehler beim Aktualisieren der Datei&#39;, {
                      error,
                      itemId: item.id,
                      itemName: item.metadata.name
                    });
                    throw error; // Werfe den Fehler weiter, damit TextEditor ihn anzeigen kann
                  }
                } else {
                  FileLogger.warn(&#39;FilePreview&#39;, &#39;Speichern nicht möglich&#39;, {
                    hasProvider: !!provider,
                    hasOnRefreshFolder: !!onRefreshFolder
                  });
                  // Werfe einen Fehler, damit TextEditor ihn anzeigen kann
                  throw new Error(&#39;Speichern nicht möglich: onRefreshFolder Callback fehlt&#39;);
                }
              }}
                          /&gt;
              &lt;/TabsContent&gt;
            &lt;/div&gt;
          &lt;/Tabs&gt;
        &lt;/div&gt;
      );
    case &#39;pdf&#39;:
    case &#39;docx&#39;:
    case &#39;pptx&#39;:
    case &#39;xlsx&#39;:
    case &#39;presentation&#39;:
      return (
        &lt;DocumentPreviewComponent
          provider={provider}
          activeLibraryId={activeLibraryId}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      );
    case &#39;website&#39;:
      const urlContent = content.match(/URL=(.*)/)?.[1];
      return urlContent ? (
        &lt;iframe 
          src={urlContent}
          title={item.metadata.name}
          className=&quot;w-full h-screen&quot;
        /&gt;
      ) : (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine gültige URL gefunden.
        &lt;/div&gt;
      );
    default:
      return (
        &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;
          Keine Vorschau verfügbar für diesen Dateityp.
        &lt;/div&gt;
      );
  }
}

// Definiere einen Typ für den State
interface FilePreviewState {
  content: string;
  error: string | null;
  hasMetadata: boolean;
}

// Hauptkomponente
export function FilePreview({ 
  className,
  provider,
  file,
  onRefreshFolder
}: FilePreviewProps) {
  const activeLibraryId = useAtomValue(activeLibraryIdAtom);
  const selectedFileFromAtom = useAtomValue(selectedFileAtom);

  // Verwende explizite file prop oder fallback zum selectedFileAtom
  const displayFile = file || selectedFileFromAtom;

  // Debug-Log für FilePreview-Hauptkomponente
  React.useEffect(() =&gt; {
    const timeoutId = setTimeout(() =&gt; {
      FileLogger.info(&#39;FilePreview&#39;, &#39;FilePreview-Hauptkomponente gerendert&#39;, {
        hasExplicitFile: !!file,
        hasSelectedFileFromAtom: !!selectedFileFromAtom,
        displayFileId: displayFile?.id,
        displayFileName: displayFile?.metadata.name,
        hasProvider: !!provider,
        providerName: provider?.name,
        activeLibraryId
      });
    }, 0);

    return () =&gt; clearTimeout(timeoutId);
  }, [file, selectedFileFromAtom, displayFile, provider, activeLibraryId]);

  // Gemeinsamer Cache für den Inhalt von Dateien
  const contentCache = React.useRef&lt;Map&lt;string, { content: string; hasMetadata: boolean }&gt;&gt;(new Map());

  // Passe den Reducer an
  const reducer = React.useCallback((state: FilePreviewState, action: { type: string; content?: string; hasMetadata?: boolean; error?: string }) =&gt; {
    switch (action.type) {
      case &#39;SET_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39;, hasMetadata: action.hasMetadata ?? false };
      case &#39;SET_ERROR&#39;:
        return { ...state, error: action.error ?? null };
      case &#39;UPDATE_CONTENT&#39;:
        return { ...state, content: action.content ?? &#39;&#39; };
      default:
        return state;
    }
  }, []);

  const [state, dispatch] = React.useReducer(reducer, {
    content: &#39;&#39;,
    error: null,
    hasMetadata: false
  });

  // Memoize computed values
  const fileType = React.useMemo(() =&gt; 
    displayFile ? getFileType(displayFile.metadata.name) : &#39;unknown&#39;, 
    [displayFile]
  );

  const isAudioFile = React.useMemo(() =&gt; fileType === &#39;audio&#39;, [fileType]);
  const isVideoFile = React.useMemo(() =&gt; fileType === &#39;video&#39;, [fileType]);

  // Debug-Log für computed values
  React.useEffect(() =&gt; {
    if (displayFile) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Computed values aktualisiert&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          fileType,
          isAudioFile,
          isVideoFile,
          mimeType: displayFile.metadata.mimeType
        });
      }, 0);

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile, fileType, isAudioFile, isVideoFile]);

  // Memoize content loader callback
  const handleContentLoaded = React.useCallback((content: string, hasMetadata: boolean) =&gt; {
    dispatch({ type: &#39;SET_CONTENT&#39;, content, hasMetadata });
  }, []);

  // Callback für direkte Aktualisierung des Inhalts
  const handleContentUpdated = React.useCallback((content: string) =&gt; {
    dispatch({ type: &#39;UPDATE_CONTENT&#39;, content });
  }, []);

  // Cache leeren, wenn sich die Item-ID ändert
  React.useEffect(() =&gt; {
    if (displayFile?.id) {
      const timeoutId = setTimeout(() =&gt; {
        FileLogger.debug(&#39;FilePreview&#39;, &#39;Neues Item geladen, Cache wird geprüft&#39;, {
          itemId: displayFile.id,
          itemName: displayFile.metadata.name,
          cacheSize: contentCache.current.size
        });
      }, 0);

      // Nur Cache-Einträge löschen, die nicht zur aktuellen Datei gehören
      const currentCache = contentCache.current.get(displayFile.id);
      if (!currentCache) {
        // Wenn die aktuelle Datei nicht im Cache ist, lösche alte Einträge
        Array.from(contentCache.current.keys()).forEach(key =&gt; {
          if (key !== displayFile.id) {
            contentCache.current.delete(key);
          }
        });
      }

      return () =&gt; clearTimeout(timeoutId);
    }
  }, [displayFile?.id]);

  if (!displayFile) {
    return (
      &lt;div className={cn(&quot;flex items-center justify-center h-full&quot;, className)}&gt;
        &lt;p className=&quot;text-muted-foreground&quot;&gt;Keine Datei ausgewählt&lt;/p&gt;
      &lt;/div&gt;
    );
  }

  return (
    &lt;div className={cn(&quot;h-full flex flex-col&quot;, className)}&gt;
      &lt;ContentLoader
        item={displayFile}
        provider={provider}
        fileType={fileType}
        isAudioFile={isAudioFile}
        isVideoFile={isVideoFile}
        contentCache={contentCache}
        onContentLoaded={handleContentLoaded}
      /&gt;
      &lt;div className=&quot;flex-1 overflow-auto&quot;&gt;
        &lt;PreviewContent
          item={displayFile}
          fileType={fileType}
          content={state.content}
          error={state.error}
          activeLibraryId={activeLibraryId}
          provider={provider}
          contentCache={contentCache}
          onContentUpdated={handleContentUpdated}
          onRefreshFolder={onRefreshFolder}
        /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
</code></pre></div>
<p>Ich behebe den Typfehler in <code>src/components/settings/chat-form.tsx</code>, baue erneut und führe Lint/Tests aus. Anschließend committe ich den Merge-Stand und erstelle den PR von <code>chatbot</code> nach <code>master</code>.</p>
<div class="highlight"><pre><span></span><code>&quot;use client&quot;

import { zodResolver } from &quot;@hookform/resolvers/zod&quot;
import { useForm } from &quot;react-hook-form&quot;
import * as z from &quot;zod&quot;
import { useEffect, useState } from &quot;react&quot;
import { useAtom } from &quot;jotai&quot;
import { activeLibraryIdAtom, librariesAtom } from &quot;@/atoms/library-atom&quot;
import { Button } from &quot;@/components/ui/button&quot;
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from &quot;@/components/ui/form&quot;
import { Input } from &quot;@/components/ui/input&quot;
import { Textarea } from &quot;@/components/ui/textarea&quot;
import { Switch } from &quot;@/components/ui/switch&quot;
import { toast } from &quot;@/components/ui/use-toast&quot;

// Zod-Schema für Chat-Konfiguration
const chatFormSchema = z.object({
  public: z.boolean().default(false),
  titleAvatarSrc: z.string().url().optional().or(z.literal(&quot;&quot;)).transform(v =&gt; v || undefined),
  welcomeMessage: z.string().min(1, &quot;Bitte geben Sie eine Begrüßungsnachricht ein.&quot;),
  errorMessage: z.string().optional(),
  placeholder: z.string().optional(),
  maxChars: z.coerce.number().int().positive().max(4000).optional(),
  maxCharsWarningMessage: z.string().optional(),
  footerText: z.string().optional(),
  companyLink: z.string().url().optional().or(z.literal(&quot;&quot;)).transform(v =&gt; v || undefined),
  features: z.object({
    citations: z.boolean().default(true),
    streaming: z.boolean().default(true),
  }).default({ citations: true, streaming: true }),
  rateLimit: z.object({
    windowSec: z.coerce.number().int().positive().default(60),
    max: z.coerce.number().int().positive().default(30),
  }).optional(),
  vectorStore: z.object({
    indexOverride: z.string().optional(),
  }).optional(),
})

type ChatFormValues = z.infer&lt;typeof chatFormSchema&gt;

export function ChatForm() {
  const [libraries, setLibraries] = useAtom(librariesAtom)
  const [activeLibraryId] = useAtom(activeLibraryIdAtom)
  const [isLoading, setIsLoading] = useState(false)
  const [isChecking, setIsChecking] = useState(false)
  const [healthResult, setHealthResult] = useState&lt;{
    ok: boolean;
    indexes?: Array&lt;{ name: string }&gt;;
    expectedIndex?: string;
    exists?: boolean;
    status?: number;
    error?: string;
  } | null&gt;(null)
  const [healthError, setHealthError] = useState&lt;string | null&gt;(null)

  const activeLibrary = libraries.find(lib =&gt; lib.id === activeLibraryId)

  const form = useForm&lt;ChatFormValues&gt;({
    resolver: zodResolver(chatFormSchema),
    defaultValues: {
      public: false,
      titleAvatarSrc: undefined,
      welcomeMessage: &quot;Hallo! Ich bin dein wissensbasierter Chatbot.&quot;,
      errorMessage: &quot;Etwas ist schiefgegangen. Versuche es bitte nochmal.&quot;,
      placeholder: &quot;Schreibe deine Frage...&quot;,
      maxChars: 500,
      maxCharsWarningMessage: &quot;Deine Frage ist zu lang, bitte kürze sie.&quot;,
      footerText: &quot;&quot;,
      companyLink: undefined,
      features: { citations: true, streaming: true },
      rateLimit: { windowSec: 60, max: 30 },
      vectorStore: { indexOverride: undefined },
    },
  })

  useEffect(() =&gt; {
    if (activeLibrary?.config?.chat) {
      const c = activeLibrary.config.chat as unknown as Record&lt;string, unknown&gt;
      form.reset({
        public: Boolean(c.public ?? false),
        titleAvatarSrc: typeof c.titleAvatarSrc === &#39;string&#39; ? c.titleAvatarSrc : undefined,
        welcomeMessage: typeof c.welcomeMessage === &#39;string&#39; &amp;&amp; c.welcomeMessage ? c.welcomeMessage : &quot;Hallo! Ich bin dein wissensbasierter Chatbot.&quot;,
        errorMessage: typeof c.errorMessage === &#39;string&#39; ? c.errorMessage : &quot;Etwas ist schiefgegangen. Versuche es bitte nochmal.&quot;,
        placeholder: typeof c.placeholder === &#39;string&#39; ? c.placeholder : &quot;Schreibe deine Frage...&quot;,
        maxChars: typeof c.maxChars === &#39;number&#39; ? c.maxChars : 500,
        maxCharsWarningMessage: typeof c.maxCharsWarningMessage === &#39;string&#39; ? c.maxCharsWarningMessage : &quot;Deine Frage ist zu lang, bitte kürze sie.&quot;,
        footerText: typeof c.footerText === &#39;string&#39; ? c.footerText : &quot;&quot;,
        companyLink: typeof c.companyLink === &#39;string&#39; ? c.companyLink : undefined,
        features: {
          citations: Boolean((c.features as { citations?: boolean })?.citations ?? true),
          streaming: Boolean((c.features as { streaming?: boolean })?.streaming ?? true),
        },
        rateLimit: {
          windowSec: Number((c.rateLimit as { windowSec?: number })?.windowSec ?? 60),
          max: Number((c.rateLimit as { max?: number })?.max ?? 30),
        },
        vectorStore: {
          indexOverride: typeof (c.vectorStore as { indexOverride?: string })?.indexOverride === &#39;string&#39;
            ? (c.vectorStore as { indexOverride?: string })!.indexOverride
            : undefined,
        },
      })
    }
  }, [activeLibrary, form])

  async function onSubmit(data: ChatFormValues) {
    setIsLoading(true)
    try {
      if (!activeLibrary) throw new Error(&quot;Keine Bibliothek ausgewählt&quot;)

      const updatedLibrary = {
        ...activeLibrary,
        config: {
          ...activeLibrary.config,
          chat: data,
        }
      }

      const response = await fetch(&#39;/api/libraries&#39;, {
        method: &#39;POST&#39;,
        headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
        body: JSON.stringify(updatedLibrary),
      })
      if (!response.ok) throw new Error(`Fehler beim Speichern: ${response.statusText}`)

      const updatedLibraries = libraries.map(lib =&gt; lib.id === activeLibrary.id
        ? { ...lib, config: { ...lib.config, chat: data } }
        : lib)
      setLibraries(updatedLibraries)

      toast({
        title: &quot;Chat-Einstellungen gespeichert&quot;,
        description: `Die Chat-Einstellungen für &quot;${activeLibrary.label}&quot; wurden aktualisiert.`,
      })
    } catch (error) {
      console.error(&#39;Fehler beim Speichern der Chat-Einstellungen:&#39;, error)
      toast({
        title: &quot;Fehler&quot;,
        description: error instanceof Error ? error.message : &quot;Unbekannter Fehler beim Speichern&quot;,
        variant: &quot;destructive&quot;,
      })
    } finally {
      setIsLoading(false)
    }
  }

  if (!activeLibrary) {
    return (
      &lt;div className=&quot;text-center text-muted-foreground&quot;&gt;Bitte wählen Sie eine Bibliothek aus.&lt;/div&gt;
    )
  }

  return (
    &lt;Form {...form}&gt;
      &lt;form onSubmit={form.handleSubmit(onSubmit)} className=&quot;space-y-8&quot;&gt;
        &lt;div className=&quot;grid gap-6&quot;&gt;
          &lt;FormField
            control={form.control}
            name=&quot;public&quot;
            render={({ field }) =&gt; (
              &lt;FormItem className=&quot;flex items-center justify-between&quot;&gt;
                &lt;div&gt;
                  &lt;FormLabel&gt;Öffentlich zugänglich&lt;/FormLabel&gt;
                  &lt;FormDescription&gt;
                    Wenn aktiviert, kann der Chat ohne Anmeldung verwendet werden (Rate-Limit beachten).
                  &lt;/FormDescription&gt;
                &lt;/div&gt;
                &lt;FormControl&gt;
                  &lt;Switch checked={field.value} onCheckedChange={field.onChange} /&gt;
                &lt;/FormControl&gt;
                &lt;FormMessage /&gt;
              &lt;/FormItem&gt;
            )}
          /&gt;

          &lt;FormField
            control={form.control}
            name=&quot;titleAvatarSrc&quot;
            render={({ field }) =&gt; (
              &lt;FormItem&gt;
                &lt;FormLabel&gt;Avatar URL&lt;/FormLabel&gt;
                &lt;FormControl&gt;
                  &lt;Input placeholder=&quot;https://.../avatar.png&quot; {...field} /&gt;
                &lt;/FormControl&gt;
                &lt;FormDescription&gt;Optionales Avatarbild für die Chat-Ansicht.&lt;/FormDescription&gt;
                &lt;FormMessage /&gt;
              &lt;/FormItem&gt;
            )}
          /&gt;

          &lt;FormField
            control={form.control}
            name=&quot;welcomeMessage&quot;
            render={({ field }) =&gt; (
              &lt;FormItem&gt;
                &lt;FormLabel&gt;Begrüßung&lt;/FormLabel&gt;
                &lt;FormControl&gt;
                  &lt;Textarea rows={3} placeholder=&quot;Willkommensnachricht...&quot; {...field} /&gt;
                &lt;/FormControl&gt;
                &lt;FormMessage /&gt;
              &lt;/FormItem&gt;
            )}
          /&gt;

          &lt;FormField
            control={form.control}
            name=&quot;errorMessage&quot;
            render={({ field }) =&gt; (
              &lt;FormItem&gt;
                &lt;FormLabel&gt;Fehlermeldung&lt;/FormLabel&gt;
                &lt;FormControl&gt;
                  &lt;Input placeholder=&quot;Allgemeine Fehlermeldung...&quot; {...field} /&gt;
                &lt;/FormControl&gt;
                &lt;FormMessage /&gt;
              &lt;/FormItem&gt;
            )}
          /&gt;

          &lt;div className=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;
            &lt;FormField
              control={form.control}
              name=&quot;placeholder&quot;
              render={({ field }) =&gt; (
                &lt;FormItem&gt;
                  &lt;FormLabel&gt;Platzhalter&lt;/FormLabel&gt;
                  &lt;FormControl&gt;
                    &lt;Input placeholder=&quot;Schreibe deine Frage...&quot; {...field} /&gt;
                  &lt;/FormControl&gt;
                  &lt;FormMessage /&gt;
                &lt;/FormItem&gt;
              )}
            /&gt;
            &lt;FormField
              control={form.control}
              name=&quot;maxChars&quot;
              render={({ field }) =&gt; (
                &lt;FormItem&gt;
                  &lt;FormLabel&gt;Max. Zeichen pro Nachricht&lt;/FormLabel&gt;
                  &lt;FormControl&gt;
                    &lt;Input type=&quot;number&quot; min={1} max={4000} {...field} /&gt;
                  &lt;/FormControl&gt;
                  &lt;FormMessage /&gt;
                &lt;/FormItem&gt;
              )}
            /&gt;
          &lt;/div&gt;

          &lt;FormField
            control={form.control}
            name=&quot;maxCharsWarningMessage&quot;
            render={({ field }) =&gt; (
              &lt;FormItem&gt;
                &lt;FormLabel&gt;Warnhinweis bei Überschreitung&lt;/FormLabel&gt;
                &lt;FormControl&gt;
                  &lt;Input placeholder=&quot;Deine Frage ist zu lang, bitte kürze sie.&quot; {...field} /&gt;
                &lt;/FormControl&gt;
                &lt;FormMessage /&gt;
              &lt;/FormItem&gt;
            )}
          /&gt;

          &lt;div className=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;
            &lt;FormField
              control={form.control}
              name=&quot;footerText&quot;
              render={({ field }) =&gt; (
                &lt;FormItem&gt;
                  &lt;FormLabel&gt;Footer-Text&lt;/FormLabel&gt;
                  &lt;FormControl&gt;
                    &lt;Input placeholder=&quot;Powered by ...&quot; {...field} /&gt;
                  &lt;/FormControl&gt;
                  &lt;FormMessage /&gt;
                &lt;/FormItem&gt;
              )}
            /&gt;
            &lt;FormField
              control={form.control}
              name=&quot;companyLink&quot;
              render={({ field }) =&gt; (
                &lt;FormItem&gt;
                  &lt;FormLabel&gt;Footer-Link&lt;/FormLabel&gt;
                  &lt;FormControl&gt;
                    &lt;Input placeholder=&quot;https://www.example.org&quot; {...field} /&gt;
                  &lt;/FormControl&gt;
                  &lt;FormMessage /&gt;
                &lt;/FormItem&gt;
              )}
            /&gt;
          &lt;/div&gt;

          &lt;div className=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;
            &lt;FormField
              control={form.control}
              name=&quot;features.citations&quot;
              render={({ field }) =&gt; (
                &lt;FormItem className=&quot;flex items-center justify-between&quot;&gt;
                  &lt;div&gt;
                    &lt;FormLabel&gt;Zitate/Quellen anzeigen&lt;/FormLabel&gt;
                    &lt;FormDescription&gt;Quellverweise zu Antworten im Chat einblenden.&lt;/FormDescription&gt;
                  &lt;/div&gt;
                  &lt;FormControl&gt;
                    &lt;Switch checked={field.value} onCheckedChange={field.onChange} /&gt;
                  &lt;/FormControl&gt;
                  &lt;FormMessage /&gt;
                &lt;/FormItem&gt;
              )}
            /&gt;
            &lt;FormField
              control={form.control}
              name=&quot;features.streaming&quot;
              render={({ field }) =&gt; (
                &lt;FormItem className=&quot;flex items-center justify-between&quot;&gt;
                  &lt;div&gt;
                    &lt;FormLabel&gt;Streaming aktivieren&lt;/FormLabel&gt;
                    &lt;FormDescription&gt;Antworten während der Generierung anzeigen.&lt;/FormDescription&gt;
                  &lt;/div&gt;
                  &lt;FormControl&gt;
                    &lt;Switch checked={field.value} onCheckedChange={field.onChange} /&gt;
                  &lt;/FormControl&gt;
                  &lt;FormMessage /&gt;
                &lt;/FormItem&gt;
              )}
            /&gt;
          &lt;/div&gt;

          &lt;div className=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;
            &lt;FormField
              control={form.control}
              name=&quot;rateLimit.windowSec&quot;
              render={({ field }) =&gt; (
                &lt;FormItem&gt;
                  &lt;FormLabel&gt;Rate-Limit Fenster (Sekunden)&lt;/FormLabel&gt;
                  &lt;FormControl&gt;
                    &lt;Input type=&quot;number&quot; min={1} {...field} /&gt;
                  &lt;/FormControl&gt;
                  &lt;FormMessage /&gt;
                &lt;/FormItem&gt;
              )}
            /&gt;
            &lt;FormField
              control={form.control}
              name=&quot;rateLimit.max&quot;
              render={({ field }) =&gt; (
                &lt;FormItem&gt;
                  &lt;FormLabel&gt;Max. Requests pro Fenster&lt;/FormLabel&gt;
                  &lt;FormControl&gt;
                    &lt;Input type=&quot;number&quot; min={1} {...field} /&gt;
                  &lt;/FormControl&gt;
                  &lt;FormMessage /&gt;
                &lt;/FormItem&gt;
              )}
            /&gt;
          &lt;/div&gt;

          &lt;FormField
            control={form.control}
            name=&quot;vectorStore.indexOverride&quot;
            render={({ field }) =&gt; (
              &lt;FormItem&gt;
                &lt;FormLabel&gt;Index-Override (optional)&lt;/FormLabel&gt;
                &lt;FormControl&gt;
                  &lt;Input placeholder=&quot;Standard: Library-Name als Index&quot; {...field} /&gt;
                &lt;/FormControl&gt;
                &lt;FormDescription&gt;
                  Nur ausfüllen, wenn der Standardindex (Libraryname) nicht verwendet werden soll.
                &lt;/FormDescription&gt;
                &lt;FormMessage /&gt;
              &lt;/FormItem&gt;
            )}
          /&gt;
        &lt;/div&gt;

        &lt;div className=&quot;flex items-center justify-between gap-4&quot;&gt;
          &lt;Button type=&quot;button&quot; variant=&quot;outline&quot; onClick={async () =&gt; {
            setIsChecking(true)
            setHealthError(null)
            setHealthResult(null)
            try {
              const res = await fetch(&#39;/api/health/pinecone&#39;, { method: &#39;GET&#39;, cache: &#39;no-store&#39; })
              const data = await res.json()
              if (!res.ok || data?.ok === false) {
                const message = typeof data?.error === &#39;string&#39; ? data.error : `Fehlerstatus ${res.status}`
                throw new Error(message)
              }
              setHealthResult(data)
              toast({ title: &#39;Index Status&#39;, description: &#39;Pinecone-Verbindung OK&#39; })
            } catch (e) {
              const msg = e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;
              setHealthError(msg)
              toast({ title: &#39;Fehler&#39;, description: msg, variant: &#39;destructive&#39; })
            } finally {
              setIsChecking(false)
            }
          }}&gt;
            {isChecking ? &#39;Prüfe...&#39; : &#39;Index Status prüfen&#39;}
          &lt;/Button&gt;
          &lt;Button type=&quot;button&quot; variant=&quot;outline&quot; onClick={async () =&gt; {
            try {
              if (!activeLibrary) throw new Error(&#39;Keine Bibliothek ausgewählt&#39;)
              const res = await fetch(`/api/chat/${encodeURIComponent(activeLibrary.id)}/index`, { method: &#39;POST&#39; })
              const data = await res.json()
              if (!res.ok) throw new Error(typeof data?.error === &#39;string&#39; ? data.error : &#39;Fehler beim Anlegen des Index&#39;)
              toast({ title: data.status === &#39;exists&#39; ? &#39;Index vorhanden&#39; : &#39;Index angelegt&#39;, description: typeof data?.index === &#39;object&#39; ? JSON.stringify(data.index) : undefined })
            } catch (e) {
              toast({ title: &#39;Fehler&#39;, description: e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;, variant: &#39;destructive&#39; })
            }
          }}&gt;
            Index anlegen
          &lt;/Button&gt;
          &lt;Button type=&quot;button&quot; variant=&quot;secondary&quot; onClick={async () =&gt; {
            try {
              if (!activeLibrary) throw new Error(&#39;Keine Bibliothek ausgewählt&#39;)
              const res = await fetch(`/api/chat/${encodeURIComponent(activeLibrary.id)}/ingest`, { method: &#39;POST&#39; })
              if (!res.ok) throw new Error(`Fehler beim Starten der Ingestion: ${res.statusText}`)
              const data = await res.json()
              toast({ title: &#39;Index-Aufbau gestartet&#39;, description: `Job-ID: ${data.jobId}` })
            } catch (e) {
              toast({ title: &#39;Fehler&#39;, description: e instanceof Error ? e.message : &#39;Unbekannter Fehler&#39;, variant: &#39;destructive&#39; })
            }
          }}&gt;
            Index neu aufbauen
          &lt;/Button&gt;
          &lt;Button type=&quot;submit&quot; disabled={isLoading || !form.formState.isDirty}&gt;
            {isLoading ? &quot;Wird gespeichert...&quot; : &quot;Einstellungen speichern&quot;}
          &lt;/Button&gt;
        &lt;/div&gt;

        {(healthResult || healthError) &amp;&amp; (
          &lt;div className=&quot;rounded-md border bg-muted/30 p-3&quot;&gt;
            &lt;div className=&quot;text-xs text-muted-foreground mb-2&quot;&gt;Pinecone Health Check&lt;/div&gt;
            {healthError ? (
              &lt;div className=&quot;text-sm text-destructive&quot;&gt;{healthError}&lt;/div&gt;
            ) : (
              &lt;pre className=&quot;text-xs whitespace-pre-wrap break-words&quot;&gt;{healthResult ? JSON.stringify(healthResult, null, 2) : &#39;&#39;}&lt;/pre&gt;
            )}
          &lt;/div&gt;
        )}
      &lt;/form&gt;
    &lt;/Form&gt;
  )
}
</code></pre></div>
<p>Status: chatbot ist mit master synchronisiert, baut erfolgreich. Ich committe den Merge, pushe und eröffne den PR.</p>
<p>Ich führe jetzt aus:
- Merge committen und pushen
- Optional: PR via gh erstellen (falls installiert)</p>
<p>Soll ich den PR automatisch anlegen lassen?</p>
<hr />
<p><strong>User</strong></p>
<p>ok</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich prüfe Lint und Tests, committe dann den Merge-Stand auf <code>chatbot</code>, pushe zu <code>origin</code> und erstelle im Anschluss den PR gegen <code>master</code>.</p>
<p>Ich analysiere jetzt die fehlgeschlagenen Tests und öffne die betroffene Implementierung sowie die Tests parallel, um die Slug-Logik zu korrigieren. Danach passe ich entweder die Implementierung an die erwarteten Tests an oder umgekehrt, je nachdem was fachlich korrekt ist, und lasse Tests erneut laufen.</p>
<hr />
<p><strong>User</strong></p>
<p>ich habe die tests deaktiviert (datei umbenannt)</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich schließe die Build-Fixes ab und erstelle jetzt den PR: ich committe die Änderungen auf <code>chatbot</code>, pushe und versuche anschließend, den PR via GitHub-CLI zu öffnen.</p>
<p>Kurzstatus: Änderungen sind auf <code>origin/chatbot</code> gepusht. PR-Erstellung via gh schlug wegen fehlender Auth fehl.</p>
<p>Vorschlag:
- Entweder im Browser PR öffnen: GitHub → bCommonsLAB/CommonKnowledgeScout → Compare &amp; pull request → base: master, compare: chatbot.
- Oder gh authentifizieren und ich erstelle den PR per CLI:
  1) gh auth login
  2) danach erneut: gh pr create --base master --head chatbot ...</p>
<p>Sag mir, welche Variante du möchtest.</p>
<hr />
<p><strong>User</strong></p>
<p>Habe auf github den branch mit pull request gemerged und branch gelöscht.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich synchronisiere lokal den Stand von master nach deinem Merge, lösche ggf. den lokalen Branch, und prüfe Build/Lint/Tests.</p>
<ul>
<li>Master ist lokal synchron und baut sauber. Lint zeigt nur Warnungen, keine Fehler.</li>
<li>Lokaler <code>chatbot</code>-Branch wurde gelöscht; Remote ist bereits gelöscht.</li>
</ul>
<p>Willst du die deaktivierten Tests wieder aktivieren und die Slug-Logik später fixen, oder vorerst so lassen?</p>
<hr />
<p><strong>User</strong></p>
<p>@cursor_2025.08.27-panel_resizing_issue_with_file_t.md ich habe in diesem chat was programmiert, um in der library aktuellen Crumbpath als Favorit zu speichern und mit einem dropdown wieder zuverwenden. Das sehe ich jetzt im code nicht mehr.@cursor_2025.08.28-optimizing_pdf_processing_and_me.md @favorites.ts können wir das analysieren?</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich suche jetzt nach der Favorites-Implementierung und deren Verwendung in der Library-UI (Breadcrumb/Dropdown) und öffne die <code>src/lib/library/favorites.ts</code>, um den aktuellen Stand zu prüfen. Danach entscheide ich, ob der UI-Teil fehlt und wo er ergänzt werden muss.</p>
<p>Ich suche jetzt die <code>Breadcrumb</code>-Komponente und prüfe, ob dort Favoriten/Favorites-Logik existiert, und scanne parallel auf Vorkommen von loadFavorites/toggleFavorite im UI. Danach sage ich dir, ob die UI fehlt und wo wir sie ergänzen sollten.</p>
<p>Ich prüfe die UI-Dateien, speziell <code>src/components/library/breadcrumb.tsx</code>, ob die Favoriten-Logik verdrahtet ist, und bestätige, dass nur <code>favorites.ts</code> existiert. Danach gebe ich dir eine präzise Integrationsempfehlung.</p>
<p>Kurzes Update: Ich habe <code>src/lib/library/favorites.ts</code> gefunden (Persistenz in <code>.ck-meta/favorites.json</code> ist da), aber in <code>src/components/library/breadcrumb.tsx</code> ist keine Favoriten-UI verdrahtet. Die in den Docs beschriebene Dropdown/Star-Logik fehlt aktuell im UI.</p>
<p>Analyse
- Vorhanden:
  - <code>src/lib/library/favorites.ts</code>: <code>loadFavorites(provider, libraryId)</code>, <code>toggleFavorite(provider, libraryId, folder)</code>.
- Nicht vorhanden:
  - Einbindung in <code>Breadcrumb</code> oder <code>LibraryHeader</code> (Dropdown mit Favoriten, Stern/Toggle).
  - Aufrufe von <code>loadFavorites</code>/<code>toggleFavorite</code> im UI.
- Doku-Referenzen zeigen geplante UI in <code>Breadcrumb</code> (Dropdown + Star), aber diese Implementierung ist nicht im Code.</p>
<p>Vorschlag (präzise Einbindung)
- Zielort: <code>src/components/library/breadcrumb.tsx</code>
  - Importiere <code>useStorage</code> (für <code>provider</code>) und <code>activeLibraryAtom</code>.
  - Lade Favoriten bei Wechsel von <code>activeLibrary.id</code>:
    - <code>const { provider } = useStorage();</code>
    - <code>const activeLibrary = useAtomValue(activeLibraryAtom);</code>
    - <code>useEffect(() =&gt; { if (provider &amp;&amp; activeLibrary?.id) setFavorites(await loadFavorites(provider, activeLibrary.id)); }, [...])</code>
  - Dropdown “Favoriten” rechts vom Pfad:
    - Anzeige: Liste der Favoriten mit Label = vollständiger Pfadname (aus <code>FavoriteEntry.path?.join(' / ') ?? name</code>).
    - Klick navigiert via <code>useFolderNavigation()</code> zu <code>favorite.id</code>.
  - Stern-Button (Toggle) nahe des aktuellen Ordnernamens:
    - Ruft <code>toggleFavorite(provider, activeLibrary.id, currentFolder)</code> auf.
    - Danach <code>setFavorites</code> mit Rückgabewert aktualisieren.
- Optional alternativ: Menü im <code>src/components/library/library-header.tsx</code> statt Breadcrumb.</p>
<p>Benötigte Daten im Breadcrumb
- <code>provider</code> aus <code>useStorage()</code>
- <code>activeLibrary.id</code> (ist bereits per Atom verfügbar)
- <code>currentPath</code> und <code>currentFolderId</code> (bereits vorhanden), um den aktuell ausgewählten Ordner als Favorit zu togglen.</p>
<p>Nächste Schritte
- Soll ich die Favoriten-UI (Dropdown + Stern) jetzt in <code>breadcrumb.tsx</code> integrieren? Wenn ja, mache ich die Edits minimal-invasiv und teste Navigation/Toggling.</p>
<hr />
<p><strong>User</strong></p>
<p>ja bitte in breadcrumb integrieren. Dropdown symbol ist vor dem breadcrum ein Pfeil nach unten. so ähnlich wie pfeile in Filetree. Favoriten Star am Ende des Breadcrumbs.</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich erweitere jetzt die Breadcrumb-UI um das Favoriten-Dropdown (Chevron-Trigger links) und den Favoriten-Stern (rechts), lade/persistiere Favoriten über <code>loadFavorites</code>/<code>toggleFavorite</code>, und validiere anschließend den Build.</p>
<div class="highlight"><pre><span></span><code>&#39;use client&#39;;

import * as React from &quot;react&quot;;
import { useAtomValue } from &quot;jotai&quot;;
import { cn } from &quot;@/lib/utils&quot;;
import { NavigationLogger, UILogger } from &quot;@/lib/debug/logger&quot;;
import { currentPathAtom, currentFolderIdAtom, activeLibraryAtom } from &quot;@/atoms/library-atom&quot;;
import { useCallback } from &quot;react&quot;;
import { useFolderNavigation } from &#39;@/hooks/use-folder-navigation&#39;;
import { useStorage } from &quot;@/contexts/storage-context&quot;;
import { loadFavorites, toggleFavorite } from &quot;@/lib/library/favorites&quot;;
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from &quot;@/components/ui/dropdown-menu&quot;;
import { ChevronDown, ChevronUp, Star, StarOff } from &quot;lucide-react&quot;;

interface BreadcrumbProps {
  className?: string;
}

export function Breadcrumb({ className }: BreadcrumbProps) {
  // Globale Atoms
  const currentPath = useAtomValue(currentPathAtom);
  const currentFolderId = useAtomValue(currentFolderIdAtom);
  const activeLibrary = useAtomValue(activeLibraryAtom);

  // Ref für horizontales Scrollen
  const breadcrumbRef = React.useRef&lt;HTMLDivElement&gt;(null);
  const scrollStartTime = React.useRef&lt;number | null&gt;(null);

  const navigateToFolder = useFolderNavigation();
  const { provider } = useStorage();

  const [favoritesOpen, setFavoritesOpen] = React.useState(false);
  const [favorites, setFavorites] = React.useState&lt;Array&lt;{ id: string; name: string; label: string }&gt;&gt;([]);

  // Favoriten laden bei Wechsel der aktiven Library oder Provider-Verfügbarkeit
  React.useEffect(() =&gt; {
    let cancelled = false;
    async function load() {
      try {
        if (!provider || !activeLibrary?.id) return;
        const data = await loadFavorites(provider, activeLibrary.id);
        if (cancelled) return;
        const list = (data.favorites || []).map(f =&gt; ({
          id: f.id,
          name: f.name,
          label: Array.isArray(f.path) &amp;&amp; f.path.length &gt; 0 ? f.path.join(&#39; / &#39;) : f.name,
        }));
        setFavorites(list);
      } catch {
        // Ignoriere Ladefehler still
      }
    }
    void load();
    return () =&gt; { cancelled = true; };
  }, [provider, activeLibrary?.id]);

  // Handler für Root-Klick
  const handleRootClick = useCallback(() =&gt; {
    const startTime = performance.now();

    NavigationLogger.info(&#39;Breadcrumb&#39;, &#39;Root navigation requested&#39;, {
      currentPath: currentPath.length,
      activeLibrary: activeLibrary?.label
    });

    navigateToFolder(&#39;root&#39;);

    const duration = performance.now() - startTime;
    UILogger.debug(&#39;Breadcrumb&#39;, &#39;Root click handled&#39;, {
      duration: `${duration.toFixed(2)}ms`,
      activeLibrary: activeLibrary?.label
    });
  }, [currentPath.length, activeLibrary, navigateToFolder]);

  // Handler für Ordner-Klick
  const handleFolderClick = useCallback((folderId: string) =&gt; {
    const startTime = performance.now();
    const targetFolder = currentPath.find(item =&gt; item.id === folderId);

    NavigationLogger.info(&#39;Breadcrumb&#39;, &#39;Folder navigation requested&#39;, {
      folderId,
      folderName: targetFolder?.metadata.name,
      pathDepth: currentPath.length,
      currentFolderId
    });

    navigateToFolder(folderId);

    const duration = performance.now() - startTime;
    UILogger.debug(&#39;Breadcrumb&#39;, &#39;Folder click handled&#39;, {
      duration: `${duration.toFixed(2)}ms`,
      folderId,
      folderName: targetFolder?.metadata.name,
      isCurrentFolder: currentFolderId === folderId
    });
  }, [currentPath, currentFolderId, navigateToFolder]);

  // Auto-Scroll zum Ende des Breadcrumbs
  React.useEffect(() =&gt; {
    if (!breadcrumbRef.current) return;

    const startTime = performance.now();
    scrollStartTime.current = startTime;

    UILogger.debug(&#39;Breadcrumb&#39;, &#39;Starting auto-scroll&#39;, {
      pathDepth: currentPath.length,
      currentScrollLeft: breadcrumbRef.current.scrollLeft,
      targetScrollLeft: breadcrumbRef.current.scrollWidth,
      activeLibrary: activeLibrary?.label
    });

    breadcrumbRef.current.scrollLeft = breadcrumbRef.current.scrollWidth;

    const timeoutId = setTimeout(() =&gt; {
      if (scrollStartTime.current === startTime) {
        const duration = performance.now() - startTime;
        UILogger.info(&#39;Breadcrumb&#39;, &#39;Auto-scroll completed&#39;, {
          duration: `${duration.toFixed(2)}ms`,
          finalScrollLeft: breadcrumbRef.current?.scrollLeft,
          pathDepth: currentPath.length
        });
        scrollStartTime.current = null;
      }
    }, 100);

    return () =&gt; clearTimeout(timeoutId);
  }, [currentPath, activeLibrary]);

  // Aktuellen Folder für Star-Button ermitteln
  const currentFolder = React.useMemo(() =&gt; (
    currentFolderId === &#39;root&#39; ? null : currentPath.find(item =&gt; item.id === currentFolderId) || null
  ), [currentFolderId, currentPath]);

  const isCurrentFavorite = React.useMemo(() =&gt; (
    !!currentFolder &amp;&amp; favorites.some(f =&gt; f.id === currentFolder.id)
  ), [currentFolder, favorites]);

  async function handleToggleFavorite() {
    if (!provider || !activeLibrary?.id || !currentFolder) return;
    const updated = await toggleFavorite(provider, activeLibrary.id, currentFolder);
    const list = (updated.favorites || []).map(f =&gt; ({
      id: f.id,
      name: f.name,
      label: Array.isArray(f.path) &amp;&amp; f.path.length &gt; 0 ? f.path.join(&#39; / &#39;) : f.name,
    }));
    setFavorites(list);
  }

  return (
    &lt;div className={cn(&quot;flex items-center gap-4 min-w-0&quot;, className)}&gt;
      &lt;div className=&quot;text-sm flex items-center gap-2 min-w-0 overflow-hidden&quot;&gt;
        {/* Favoriten-Dropdown Trigger links vor dem Breadcrumb */}
        &lt;DropdownMenu open={favoritesOpen} onOpenChange={setFavoritesOpen}&gt;
          &lt;DropdownMenuTrigger asChild&gt;
            &lt;button
              aria-label=&quot;Favoriten öffnen&quot;
              className=&quot;inline-flex h-6 w-6 items-center justify-center rounded hover:bg-muted&quot;
            &gt;
              {favoritesOpen ? &lt;ChevronUp className=&quot;h-4 w-4&quot; /&gt; : &lt;ChevronDown className=&quot;h-4 w-4&quot; /&gt;}
            &lt;/button&gt;
          &lt;/DropdownMenuTrigger&gt;
          &lt;DropdownMenuContent align=&quot;start&quot; className=&quot;min-w-[260px]&quot;&gt;
            {favorites.length === 0 ? (
              &lt;div className=&quot;px-3 py-2 text-xs text-muted-foreground&quot;&gt;Keine Favoriten vorhanden&lt;/div&gt;
            ) : favorites.map(f =&gt; (
              &lt;DropdownMenuItem key={f.id} onClick={() =&gt; navigateToFolder(f.id)} className=&quot;text-sm&quot;&gt;
                &lt;div className=&quot;truncate&quot; title={f.label}&gt;{f.label}&lt;/div&gt;
              &lt;/DropdownMenuItem&gt;
            ))}
          &lt;/DropdownMenuContent&gt;
        &lt;/DropdownMenu&gt;
        &lt;span className=&quot;text-muted-foreground flex-shrink-0&quot;&gt;Pfad:&lt;/span&gt;
        &lt;div 
          ref={breadcrumbRef}
          className=&quot;flex items-center gap-1 overflow-auto whitespace-nowrap no-scrollbar&quot; 
          style={{ maxWidth: &#39;60vw&#39; }}
          onScroll={() =&gt; {
            if (scrollStartTime.current) {
              const duration = performance.now() - scrollStartTime.current;
              UILogger.debug(&#39;Breadcrumb&#39;, &#39;Manual scroll detected&#39;, {
                duration: `${duration.toFixed(2)}ms`,
                scrollLeft: breadcrumbRef.current?.scrollLeft
              });
              scrollStartTime.current = null;
            }
          }}
        &gt;
          &lt;button
            onClick={handleRootClick}
            className={cn(
              &quot;hover:text-foreground flex-shrink-0 font-medium&quot;,
              currentFolderId === &#39;root&#39; ? &quot;text-foreground&quot; : &quot;text-muted-foreground&quot;
            )}
            title=&quot;Zurück zum Hauptverzeichnis&quot;
          &gt;
            {activeLibrary?.label || &#39;/&#39;}
          &lt;/button&gt;

          {currentPath
            .filter(item =&gt; item.id !== &#39;root&#39; &amp;&amp; item.metadata.name.toLowerCase() !== &#39;root&#39;)
            .map((item) =&gt; (
              &lt;React.Fragment key={item.id}&gt;
                &lt;span className=&quot;text-muted-foreground flex-shrink-0&quot;&gt;/&lt;/span&gt;
                &lt;button
                  onClick={() =&gt; handleFolderClick(item.id)}
                  className={cn(
                    &quot;hover:text-foreground truncate max-w-[150px]&quot;,
                    currentFolderId === item.id ? &quot;text-foreground font-medium&quot; : &quot;text-muted-foreground&quot;
                  )}
                  title={item.metadata.name}
                &gt;
                  {item.metadata.name}
                &lt;/button&gt;
              &lt;/React.Fragment&gt;
          ))}
          {/* Favoriten-Star am Ende des Breadcrumbs */}
          &lt;span className=&quot;text-muted-foreground flex-shrink-0&quot;&gt;/&lt;/span&gt;
          &lt;button
            disabled={!currentFolder || !provider || !activeLibrary?.id}
            onClick={handleToggleFavorite}
            className={cn(
              &quot;inline-flex h-6 w-6 items-center justify-center rounded&quot;,
              currentFolder ? &quot;hover:bg-muted&quot; : &quot;opacity-50 cursor-not-allowed&quot;
            )}
            aria-label={isCurrentFavorite ? &quot;Favorit entfernen&quot; : &quot;Als Favorit speichern&quot;}
            title={isCurrentFavorite ? &quot;Favorit entfernen&quot; : &quot;Als Favorit speichern&quot;}
          &gt;
            {isCurrentFavorite ? &lt;Star className=&quot;h-4 w-4&quot; /&gt; : &lt;StarOff className=&quot;h-4 w-4&quot; /&gt;}
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
} 
</code></pre></div>
<hr />
<p><strong>User</strong></p>
<p>??</p>
<hr />
<p><strong>Cursor</strong></p>
<p>Ich prüfe kurz den Build nach der Breadcrumb-Erweiterung und schließe dann die Aufgabenliste ab.</p>
<p>Ich baue jetzt das Projekt, um die Breadcrumb-Änderungen zu verifizieren. Anschließend melde ich dir den Status.</p>
<ul>
<li>Favoriten sind integriert:</li>
<li>Dropdown-Trigger (Chevron) links vor dem Breadcrumb.</li>
<li>Stern-Button am Ende des Breadcrumbs zum Hinzufügen/Entfernen.</li>
<li>Persistenz: <code>.ck-meta/favorites.json</code> pro Library über den aktiven <code>StorageProvider</code>.</li>
</ul>
<p>So testest du es:
- In die Library gehen, in einen Unterordner navigieren.
- Stern rechts klicken → Favorit wird gespeichert/entfernt.
- Chevron links öffnen → Favoritenliste, Klick navigiert direkt.
- Falls noch keine Favoriten existieren, wird die Datei automatisch angelegt.</p>
<p>Build ist grün; es gibt nur ESLint-Warnungen (Hooks-Dependencies), die die Funktion nicht blockieren. Passt dir die Position/Interaktion so?</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js"></script>
      
        <script src="../../assets/javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>