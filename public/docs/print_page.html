
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://localhost:3000/docs/print_page.html">
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Common Knowledge Scout – Complete Document - Common Knowledge Scout</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="css/print-site.css">
    
      <link rel="stylesheet" href="css/print-site-material.css">
    
      <link rel="stylesheet" href="assets/stylesheets/print.css">
    
    <script>__md_scope=new URL("/docs/",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#index" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Common Knowledge Scout" class="md-header__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Common Knowledge Scout
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Common Knowledge Scout – Complete Document
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Common Knowledge Scout" class="md-nav__button md-logo" aria-label="Common Knowledge Scout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Common Knowledge Scout
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bCommonsLAB/CommonKnowledgeScout" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture/module-hierarchy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Module Hierarchy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture/dependency-graph.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dependency Graph
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture/shadow-twin.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shadow-Twin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture/pdf-transformation-phases.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Transformation Phases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture/mongodb-vector-search.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MongoDB Vector Search
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="analysis/shadow-twin-v2-only.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shadow-Twin (v2-only)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="analysis/wizard-and-jobs.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Wizard & External Jobs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="analysis/audio-jobs-transcript-only.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Audio/Video (no template)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="analysis/ingestion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ingestion
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="analysis/storage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="analysis/markdown-page-splitting.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Markdown Page Splitting
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Use Cases
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Use Cases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="use-cases/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="use-cases/library-setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Library Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="use-cases/file-transformation-pdf.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="use-cases/file-transformation-media.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Media Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="use-cases/file-to-story.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    File → Story (End-to-End)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="use-cases/web-scraping.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web Scraping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="use-cases/publishing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Publishing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="use-cases/chat-exploration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat & Story Mode
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="use-cases/batch-operations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Batch Operations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="reference/file-index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    File Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="reference/modules/library.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="reference/modules/storage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="reference/modules/chat.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#index" class="md-nav__link">
    <span class="md-ellipsis">
      1 Home
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-2" class="md-nav__link">
    <span class="md-ellipsis">
      2 Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture-module-hierarchy" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Module Hierarchy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-dependency-graph" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Dependency Graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-shadow-twin" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 Shadow-Twin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-pdf-transformation-phases" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 PDF Transformation Phases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-mongodb-vector-search" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 MongoDB Vector Search
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-3" class="md-nav__link">
    <span class="md-ellipsis">
      3 Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#analysis-shadow-twin-v2-only" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Shadow-Twin (v2-only)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analysis-wizard-and-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Wizard & External Jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analysis-audio-jobs-transcript-only" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Audio/Video (no template)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analysis-ingestion" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 Ingestion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analysis-storage" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 Storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analysis-markdown-page-splitting" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 Markdown Page Splitting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-4" class="md-nav__link">
    <span class="md-ellipsis">
      4 Use Cases
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4 Use Cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-cases-index" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases-library-setup" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Library Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases-file-transformation-pdf" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 PDF Transformation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases-file-transformation-media" class="md-nav__link">
    <span class="md-ellipsis">
      4.4 Media Transformation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases-file-to-story" class="md-nav__link">
    <span class="md-ellipsis">
      4.5 File → Story (End-to-End)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases-web-scraping" class="md-nav__link">
    <span class="md-ellipsis">
      4.6 Web Scraping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases-publishing" class="md-nav__link">
    <span class="md-ellipsis">
      4.7 Publishing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases-chat-exploration" class="md-nav__link">
    <span class="md-ellipsis">
      4.8 Chat & Story Mode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases-batch-operations" class="md-nav__link">
    <span class="md-ellipsis">
      4.9 Batch Operations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-5" class="md-nav__link">
    <span class="md-ellipsis">
      5 Reference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5 Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reference-file-index" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 File Index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-5-2" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Modules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.2 Modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reference-modules-library" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.1 Library
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reference-modules-storage" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.2 Storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reference-modules-chat" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.3 Chat
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<div id="print-site-page" class="print-site-enumerate-headings print-site-enumerate-figures">
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index" heading-number="1"><h1 id="index-common-knowledge-scout-documentation">Common Knowledge Scout Documentation<a class="headerlink" href="#index-common-knowledge-scout-documentation" title="Permanent link">&para;</a></h1>
<p>Welcome to the Common Knowledge Scout documentation.</p>
<h2 id="index-quick-start">Quick Start<a class="headerlink" href="#index-quick-start" title="Permanent link">&para;</a></h2>
<ul>
<li><strong><a href="#use-cases-index">Use Cases</a></strong> - Step-by-step guides for common tasks</li>
<li><strong><a href="#architecture-module-hierarchy">Architecture</a></strong> - System architecture and module structure</li>
<li><strong><a href="#analysis-shadow-twin-v2-only">Analysis</a></strong> - Current runtime behavior and decisions</li>
<li><strong><a href="#reference-file-index">Reference</a></strong> - Complete file index and API reference</li>
</ul>
<h2 id="index-documentation-structure">Documentation Structure<a class="headerlink" href="#index-documentation-structure" title="Permanent link">&para;</a></h2>
<h3 id="index-use-cases">Use Cases<a class="headerlink" href="#index-use-cases" title="Permanent link">&para;</a></h3>
<p>Practical guides for end users:
- Library Setup
- File Transformation (PDF, Audio, Video)
- Web Scraping &amp; Event Import
- Publishing &amp; Gallery
- Chat &amp; Story Mode
- Batch Operations</p>
<h3 id="index-architecture">Architecture<a class="headerlink" href="#index-architecture" title="Permanent link">&para;</a></h3>
<p>System design and module documentation:
- Module Hierarchy
- Dependency Graph</p>
<h3 id="index-analysis">Analysis<a class="headerlink" href="#index-analysis" title="Permanent link">&para;</a></h3>
<p>Current runtime behavior and validated decisions:
- Shadow-Twin v2-only runtime
- Wizard &amp; External Jobs (contracts)
- Ingestion (MongoDB Vector Search)
- Storage providers (filesystem/OneDrive)
 - Audio/Video transcript-only when no template is selected</p>
<h3 id="index-reference">Reference<a class="headerlink" href="#index-reference" title="Permanent link">&para;</a></h3>
<p>Technical reference documentation:
- File Index
- Module Documentation (Storage, Library, Chat)</p>
<h2 id="index-getting-help">Getting Help<a class="headerlink" href="#index-getting-help" title="Permanent link">&para;</a></h2>
<p>For detailed technical information, see the <a href="#reference-file-index">Reference Documentation</a>.</p>
<h2 id="index-notes">Notes<a class="headerlink" href="#index-notes" title="Permanent link">&para;</a></h2>
<ul>
<li><code>docs/_analysis/</code> contains short-lived scratch notes and is intentionally <strong>not</strong> linked from MkDocs navigation.</li>
</ul></section>
                    <section class='print-page md-section' id='section-2' heading-number='2'>
                        <h1>Architecture<a class='headerlink' href='#section-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="architecture-module-hierarchy" heading-number="2.1"><h1 id="architecture-module-hierarchy-module-hierarchy">Module Hierarchy<a class="headerlink" href="#architecture-module-hierarchy-module-hierarchy" title="Permanent link">&para;</a></h1>
<p>Visual representation of the Common Knowledge Scout module organization and dependencies.</p>
<h2 id="architecture-module-hierarchy-module-tree">Module Tree<a class="headerlink" href="#architecture-module-hierarchy-module-tree" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>Common Knowledge Scout
│
├── Core Infrastructure (Layer 1)
│   ├── middleware.ts
│   │   └── Authentication &amp; Routing
│   ├── app/layout.tsx
│   │   └── Root Layout &amp; Providers
│   ├── instrumentation.ts
│   │   └── External Jobs Worker Startup
│   └── lib/
│       ├── env.ts
│       │   └── Environment Variables
│       ├── auth.ts
│       │   └── Authentication Helpers
│       └── mongodb-service.ts
│           └── Database Connection
│
├── Storage Layer (Layer 2)
│   ├── lib/storage/
│   │   ├── types.ts
│   │   │   └── Type Definitions
│   │   ├── storage-factory.ts
│   │   │   ├── LocalStorageProvider
│   │   │   └── StorageFactory
│   │   ├── filesystem-provider.ts
│   │   │   └── FileSystemProvider
│   │   ├── onedrive-provider.ts
│   │   │   └── OneDriveProvider
│   │   ├── onedrive-provider-server.ts
│   │   │   └── OneDriveServerProvider
│   │   ├── filesystem-client.ts
│   │   │   └── FilesystemClient
│   │   ├── server-provider.ts
│   │   │   └── Server Provider Helper
│   │   ├── storage-factory-mongodb.ts
│   │   │   └── MongoDBStorageFactory
│   │   ├── storage-service.ts
│   │   ├── shadow-twin.ts
│   │   └── supported-types.ts
│   ├── contexts/storage-context.tsx
│   │   └── StorageContextProvider
│   └── hooks/use-storage-provider.tsx
│       └── useStorageProvider Hook
│
├── Library System (Layer 3)
│   ├── types/library.ts
│   │   └── Library Type Definitions
│   ├── atoms/library-atom.ts
│   │   └── Library State Atoms
│   ├── lib/services/library-service.ts
│   │   └── LibraryService
│   └── components/library/
│       ├── library.tsx
│       │   └── Main Library Component
│       ├── library-header.tsx
│       ├── library-switcher.tsx
│       ├── file-tree.tsx
│       ├── file-list.tsx
│       ├── file-preview.tsx
│       └── ... (other library components)
│
├── Chat System (Layer 4)
│   ├── types/chat.ts
│   │   └── Chat Type Definitions
│   ├── lib/chat/
│   │   ├── constants.ts
│   │   ├── orchestrator.ts
│   │   ├── loader.ts
│   │   ├── config.ts
│   │   ├── common/
│   │   │   ├── prompt.ts
│   │   │   ├── filters.ts
│   │   │   ├── llm.ts
│   │   │   └── question-analyzer.ts
│   │   └── retrievers/
│   │       ├── chunks.ts
│   │       └── summaries-mongo.ts
│   ├── app/api/chat/[libraryId]/
│   │   └── stream/route.ts
│   └── components/library/chat/
│       └── ... (chat components)
│
└── API Routes &amp; Components (Layer 5)
    ├── app/api/
    │   ├── storage/
    │   ├── chat/
    │   ├── libraries/
    │   ├── external/jobs/
    │   └── ... (other API routes)
    └── components/
        ├── ui/ (Shadcn UI components)
        ├── shared/
        └── ... (other components)
</code></pre></div>
<h2 id="architecture-module-hierarchy-dependency-flow">Dependency Flow<a class="headerlink" href="#architecture-module-hierarchy-dependency-flow" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>Layer 1 (Core Infrastructure)
    ↓
Layer 2 (Storage Layer)
    ↓
Layer 3 (Library System)
    ↓
Layer 4 (Chat System)
    ↓
Layer 5 (API Routes &amp; Components)
</code></pre></div>
<h2 id="architecture-module-hierarchy-module-descriptions">Module Descriptions<a class="headerlink" href="#architecture-module-hierarchy-module-descriptions" title="Permanent link">&para;</a></h2>
<h3 id="architecture-module-hierarchy-core-infrastructure">Core Infrastructure<a class="headerlink" href="#architecture-module-hierarchy-core-infrastructure" title="Permanent link">&para;</a></h3>
<p>Foundation layer providing authentication, database, and environment configuration. No internal dependencies.</p>
<h3 id="architecture-module-hierarchy-storage-layer">Storage Layer<a class="headerlink" href="#architecture-module-hierarchy-storage-layer" title="Permanent link">&para;</a></h3>
<p>Abstracts file storage operations across multiple backends (local filesystem, OneDrive). Depends on Core Infrastructure.</p>
<h3 id="architecture-module-hierarchy-library-system">Library System<a class="headerlink" href="#architecture-module-hierarchy-library-system" title="Permanent link">&para;</a></h3>
<p>Manages library data and provides UI components for file browsing and management. Depends on Storage Layer.</p>
<h3 id="architecture-module-hierarchy-chat-system">Chat System<a class="headerlink" href="#architecture-module-hierarchy-chat-system" title="Permanent link">&para;</a></h3>
<p>Provides RAG-based chat functionality for knowledge exploration. Depends on Library System and Storage Layer.</p>
<h3 id="architecture-module-hierarchy-api-routes-components">API Routes &amp; Components<a class="headerlink" href="#architecture-module-hierarchy-api-routes-components" title="Permanent link">&para;</a></h3>
<p>User-facing API endpoints and React components. Depends on all previous layers.</p>
<h2 id="architecture-module-hierarchy-key-principles">Key Principles<a class="headerlink" href="#architecture-module-hierarchy-key-principles" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>Layered Architecture</strong>: Each layer depends only on layers below it</li>
<li><strong>Dependency Injection</strong>: Higher layers receive dependencies from lower layers</li>
<li><strong>Type Safety</strong>: TypeScript interfaces ensure contract compliance</li>
<li><strong>Separation of Concerns</strong>: Each module has a single, well-defined responsibility</li>
</ol></section><section class="print-page" id="architecture-dependency-graph" heading-number="2.2"><h1 id="architecture-dependency-graph-dependency-graph">Dependency Graph<a class="headerlink" href="#architecture-dependency-graph-dependency-graph" title="Permanent link">&para;</a></h1>
<p>Visual representation of module dependencies in the Common Knowledge Scout application.</p>
<h2 id="architecture-dependency-graph-mermaid-dependency-graph">Mermaid Dependency Graph<a class="headerlink" href="#architecture-dependency-graph-mermaid-dependency-graph" title="Permanent link">&para;</a></h2>
<pre class="mermaid"><code>graph TB
    subgraph "Layer 1: Core Infrastructure"
        MW[middleware.ts]
        LAYOUT[app/layout.tsx]
        INST[instrumentation.ts]
        ENV[lib/env.ts]
        AUTH[lib/auth.ts]
        DB[lib/mongodb-service.ts]
    end

    subgraph "Layer 2: Storage Layer"
        STYPES[lib/storage/types.ts]
        SFACTORY[lib/storage/storage-factory.ts]
        FSPROVIDER[lib/storage/filesystem-provider.ts]
        ODPROVIDER[lib/storage/onedrive-provider.ts]
        SERVERPROV[lib/storage/server-provider.ts]
        SCONTEXT[contexts/storage-context.tsx]
        USEPROV[hooks/use-storage-provider.tsx]
    end

    subgraph "Layer 3: Library System"
        LTYPES[types/library.ts]
        LATOMS[atoms/library-atom.ts]
        LSERVICE[lib/services/library-service.ts]
        LIBCOMP[components/library/library.tsx]
    end

    subgraph "Layer 4: Chat System"
        CTYPES[types/chat.ts]
        CCONST[lib/chat/constants.ts]
        CORCH[lib/chat/orchestrator.ts]
        CLOADER[lib/chat/loader.ts]
        CSTREAM[app/api/chat/.../stream/route.ts]
    end

    subgraph "Layer 5: API Routes &amp; Components"
        APIROUTES[app/api/**/*.ts]
        COMPONENTS[components/**/*.tsx]
    end

    %% Core Infrastructure (no dependencies)

    %% Storage Layer dependencies
    SFACTORY --&gt; STYPES
    SFACTORY --&gt; FSPROVIDER
    SFACTORY --&gt; ODPROVIDER
    FSPROVIDER --&gt; STYPES
    ODPROVIDER --&gt; STYPES
    ODPROVIDER --&gt; LTYPES
    SERVERPROV --&gt; SFACTORY
    SERVERPROV --&gt; LSERVICE
    SERVERPROV --&gt; ENV
    SCONTEXT --&gt; SFACTORY
    SCONTEXT --&gt; LATOMS
    USEPROV --&gt; LATOMS
    USEPROV --&gt; SFACTORY

    %% Library System dependencies
    LATOMS --&gt; LTYPES
    LATOMS --&gt; STYPES
    LSERVICE --&gt; DB
    LSERVICE --&gt; LTYPES
    LIBCOMP --&gt; SCONTEXT
    LIBCOMP --&gt; LATOMS

    %% Chat System dependencies
    CORCH --&gt; CLOADER
    CORCH --&gt; CCONST
    CORCH --&gt; CTYPES
    CLOADER --&gt; LSERVICE
    CLOADER --&gt; DB
    CSTREAM --&gt; CORCH
    CSTREAM --&gt; CLOADER
    CSTREAM --&gt; CCONST

    %% API Routes dependencies
    APIROUTES --&gt; LSERVICE
    APIROUTES --&gt; SFACTORY
    APIROUTES --&gt; DB
    APIROUTES --&gt; CORCH

    %% Components dependencies
    COMPONENTS --&gt; SCONTEXT
    COMPONENTS --&gt; LATOMS
    COMPONENTS --&gt; LIBCOMP</code></pre>
<h2 id="architecture-dependency-graph-dependency-layers">Dependency Layers<a class="headerlink" href="#architecture-dependency-graph-dependency-layers" title="Permanent link">&para;</a></h2>
<h3 id="architecture-dependency-graph-layer-1-core-infrastructure">Layer 1: Core Infrastructure<a class="headerlink" href="#architecture-dependency-graph-layer-1-core-infrastructure" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>No internal dependencies</strong></li>
<li>Provides foundational services (auth, database, env)</li>
<li>Used by all other layers</li>
</ul>
<h3 id="architecture-dependency-graph-layer-2-storage-layer">Layer 2: Storage Layer<a class="headerlink" href="#architecture-dependency-graph-layer-2-storage-layer" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Depends on</strong>: Layer 1 (env, auth, db)</li>
<li><strong>Provides</strong>: Storage abstraction</li>
<li><strong>Used by</strong>: Layer 3 (Library System), Layer 5 (API Routes)</li>
</ul>
<h3 id="architecture-dependency-graph-layer-3-library-system">Layer 3: Library System<a class="headerlink" href="#architecture-dependency-graph-layer-3-library-system" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Depends on</strong>: Layer 2 (Storage Layer)</li>
<li><strong>Provides</strong>: Library management and UI</li>
<li><strong>Used by</strong>: Layer 4 (Chat System), Layer 5 (Components)</li>
</ul>
<h3 id="architecture-dependency-graph-layer-4-chat-system">Layer 4: Chat System<a class="headerlink" href="#architecture-dependency-graph-layer-4-chat-system" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Depends on</strong>: Layer 3 (Library System), Layer 2 (Storage)</li>
<li><strong>Provides</strong>: RAG-based chat functionality</li>
<li><strong>Used by</strong>: Layer 5 (API Routes, Components)</li>
</ul>
<h3 id="architecture-dependency-graph-layer-5-api-routes-components">Layer 5: API Routes &amp; Components<a class="headerlink" href="#architecture-dependency-graph-layer-5-api-routes-components" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Depends on</strong>: All previous layers</li>
<li><strong>Provides</strong>: User-facing interfaces</li>
<li><strong>No dependencies from other modules</strong></li>
</ul>
<h2 id="architecture-dependency-graph-key-dependencies">Key Dependencies<a class="headerlink" href="#architecture-dependency-graph-key-dependencies" title="Permanent link">&para;</a></h2>
<h3 id="architecture-dependency-graph-most-imported-modules">Most Imported Modules<a class="headerlink" href="#architecture-dependency-graph-most-imported-modules" title="Permanent link">&para;</a></h3>
<ol>
<li><code>@/lib/storage/storage-factory.ts</code> - Used by contexts, API routes, components</li>
<li><code>@/lib/storage/types.ts</code> - Used by all storage-related files</li>
<li><code>@/lib/services/library-service.ts</code> - Used by API routes, storage, chat</li>
<li><code>@/types/library.ts</code> - Used throughout the application</li>
<li><code>@/lib/mongodb-service.ts</code> - Used by services and repositories</li>
</ol>
<h3 id="architecture-dependency-graph-critical-paths">Critical Paths<a class="headerlink" href="#architecture-dependency-graph-critical-paths" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Storage Access</strong>: <code>components</code> → <code>contexts/storage-context</code> → <code>storage-factory</code> → <code>providers</code></li>
<li><strong>Chat Flow</strong>: <code>api/chat/stream</code> → <code>chat/orchestrator</code> → <code>chat/loader</code> → <code>library-service</code> → <code>mongodb-service</code></li>
<li><strong>Library Management</strong>: <code>components/library</code> → <code>atoms/library-atom</code> → <code>services/library-service</code> → <code>mongodb-service</code></li>
</ul>
<h2 id="architecture-dependency-graph-circular-dependencies">Circular Dependencies<a class="headerlink" href="#architecture-dependency-graph-circular-dependencies" title="Permanent link">&para;</a></h2>
<h3 id="architecture-dependency-graph-potential-issues-to-verify">Potential Issues (To Verify)<a class="headerlink" href="#architecture-dependency-graph-potential-issues-to-verify" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Storage Factory ↔ Providers</strong>: Factory creates providers, providers may reference factory</li>
<li><strong>Library Service ↔ Storage Factory</strong>: Service uses storage, storage may reference library types</li>
<li><strong>Chat Orchestrator ↔ Chat Loader</strong>: Orchestrator uses loader, loader may use orchestrator utilities</li>
</ol>
<h2 id="architecture-dependency-graph-notes">Notes<a class="headerlink" href="#architecture-dependency-graph-notes" title="Permanent link">&para;</a></h2>
<ul>
<li>Dependencies flow downward (Layer 1 → Layer 5)</li>
<li>Each layer can only depend on layers below it</li>
<li>Type definitions (types/) have no runtime dependencies</li>
<li>Components depend on hooks, contexts, and library code</li>
<li>API routes depend on services, storage, and chat systems</li>
</ul></section><section class="print-page" id="architecture-shadow-twin" heading-number="2.3"><h1 id="architecture-shadow-twin-shadowtwin-architecture">Shadow‑Twin (architecture)<a class="headerlink" href="#architecture-shadow-twin-shadowtwin-architecture" title="Permanent link">&para;</a></h1>
<p>Status: active<br />
Last verified: 2026-01-06  </p>
<blockquote>
<p>User-facing overview: <code>docs/guides/shadow-twin.md</code></p>
</blockquote>
<h2 id="architecture-shadow-twin-scope">Scope<a class="headerlink" href="#architecture-shadow-twin-scope" title="Permanent link">&para;</a></h2>
<p>This document describes the <strong>intended storage model and contracts</strong> for Shadow‑Twin artifacts in the current system.
It is intentionally focused on <strong>naming, layout, and resolver/writer contracts</strong> (not UI details).</p>
<h2 id="architecture-shadow-twin-glossary">Glossary<a class="headerlink" href="#architecture-shadow-twin-glossary" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Source file</strong>: the original file (PDF/audio/video/image/…).</li>
<li><strong>Shadow‑Twin</strong>: derived artifacts (Markdown + assets) stored next to the source.</li>
<li><strong>Transcript</strong>: extracted text as Markdown (typically without frontmatter).</li>
<li><strong>Transformation</strong>: template-based Markdown with frontmatter/metadata.</li>
<li><strong>Dot-folder</strong>: hidden folder <code>.{originalName}</code> grouping multiple related artifacts.</li>
</ul>
<h2 id="architecture-shadow-twin-concept">Concept<a class="headerlink" href="#architecture-shadow-twin-concept" title="Permanent link">&para;</a></h2>
<p>A <strong>Shadow‑Twin</strong> is the text/metadata representation of an original file (PDF, audio, video, image, …). It may include:
- <strong>Markdown artifacts</strong> (transcript + transformation)
- <strong>Images/assets</strong> (e.g. extracted from PDFs)</p>
<p>Shadow‑Twins exist to enable:
- searchability
- structured metadata
- reliable downstream ingestion / RAG</p>
<h2 id="architecture-shadow-twin-user-story-mapping-how-this-feels-in-the-ui">User story mapping (how this feels in the UI)<a class="headerlink" href="#architecture-shadow-twin-user-story-mapping-how-this-feels-in-the-ui" title="Permanent link">&para;</a></h2>
<p>Even for expert users, the mental model is usually <strong>intent-driven</strong>, not file-driven. We therefore describe the pipeline as a 3‑step story:</p>
<ol>
<li><strong>Text erzeugen</strong> (media-dependent)</li>
<li>PDF/Image: OCR/Extract → transcript artifact</li>
<li>Audio/Video: Transkription → transcript artifact</li>
<li><strong>Transformieren</strong> (journalistic moment)</li>
<li>LLM/template converts raw text into structured, meaningful content → transformation artifact</li>
<li><strong>Veröffentlichen</strong></li>
<li>ingestion into the Library/RAG index → Mongo Vector Search (meta + chunks)</li>
</ol>
<p>Storage-wise these steps map deterministically to Shadow‑Twin artifacts:
- Step 1 → Transcript <code>{base}.{lang}.md</code>
- Step 2 → Transformation <code>{base}.{template}.{lang}.md</code>
- Step 3 → Ingestion records keyed by the <strong>source fileId</strong> (index/chunks)</p>
<h2 id="architecture-shadow-twin-storage-layout">Storage layout<a class="headerlink" href="#architecture-shadow-twin-storage-layout" title="Permanent link">&para;</a></h2>
<p>Shadow‑Twins have a <strong>single canonical write layout</strong> and one legacy read fallback.</p>
<h3 id="architecture-shadow-twin-1-dotfolder-canonical">1) Dot‑folder (canonical)<a class="headerlink" href="#architecture-shadow-twin-1-dotfolder-canonical" title="Permanent link">&para;</a></h3>
<p>Hidden folder (starts with <code>.</code>), containing all related files:</p>
<div class="highlight"><pre><span></span><code>.document.pdf/
├── document.de.md                 (Transcript)
├── document.&lt;template&gt;.de.md      (Transformation)
├── page-001.png                   (Extracted images)
└── ...
</code></pre></div>
<p><strong>Folder naming</strong>: <code>.{originalName}</code> (e.g. <code>.document.pdf/</code>)<br />
<strong>Length limit</strong>: 255 characters (truncated if necessary).</p>
<h3 id="architecture-shadow-twin-2-siblings-legacy-read-fallback-only">2) Siblings (legacy read fallback only)<a class="headerlink" href="#architecture-shadow-twin-2-siblings-legacy-read-fallback-only" title="Permanent link">&para;</a></h3>
<p>Files stored next to the original (legacy). The system may still resolve these for backwards compatibility,
but <strong>new writes should not create siblings</strong>. A future repair/migration run is expected to move siblings into
the dot-folder and remove them.</p>
<div class="highlight"><pre><span></span><code>document.pdf
document.de.md                 (Transcript)
document.&lt;template&gt;.de.md      (Transformation)
</code></pre></div>
<h2 id="architecture-shadow-twin-naming-conventions-current">Naming conventions (current)<a class="headerlink" href="#architecture-shadow-twin-naming-conventions-current" title="Permanent link">&para;</a></h2>
<h3 id="architecture-shadow-twin-transcript-artifact">Transcript artifact<a class="headerlink" href="#architecture-shadow-twin-transcript-artifact" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Format</strong>: <code>{baseName}.{language}.md</code></li>
<li><strong>Example</strong>: <code>document.de.md</code></li>
<li><strong>Created</strong>: after Extract/Transcribe</li>
<li><strong>Content</strong>: extracted markdown (typically without frontmatter)</li>
</ul>
<h3 id="architecture-shadow-twin-transformation-artifact">Transformation artifact<a class="headerlink" href="#architecture-shadow-twin-transformation-artifact" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Format</strong>: <code>{baseName}.{templateName}.{language}.md</code></li>
<li><strong>Example</strong>: <code>document.pdfanalyse.de.md</code></li>
<li><strong>Created</strong>: after Template transformation</li>
<li><strong>Content</strong>: markdown with frontmatter/metadata</li>
</ul>
<h3 id="architecture-shadow-twin-dotfolder">Dot‑folder<a class="headerlink" href="#architecture-shadow-twin-dotfolder" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Format</strong>: <code>.{originalName}</code></li>
<li><strong>Example</strong>: <code>.document.pdf/</code></li>
</ul>
<h2 id="architecture-shadow-twin-resolution-model-how-the-ui-finds-the-right-artifact">Resolution model (how the UI finds the “right” artifact)<a class="headerlink" href="#architecture-shadow-twin-resolution-model-how-the-ui-finds-the-right-artifact" title="Permanent link">&para;</a></h2>
<p>For library browsing (e.g. <code>file-list.tsx</code>) the UI does <strong>not</strong> implement filename heuristics. Instead:</p>
<ol>
<li>UI calls <code>POST /api/library/[libraryId]/artifacts/batch-resolve</code> (in batches of ≤100).</li>
<li>Server resolves each source via <code>resolveArtifact()</code>:</li>
<li>checks the dot‑folder first (if present)</li>
<li>falls back to siblings</li>
<li>if <code>preferredKind === 'transformation'</code> and no <code>templateName</code> is provided, the resolver selects the best matching transformation for the language (currently: newest by <code>modifiedAt</code>)</li>
<li>Server returns <code>ResolvedArtifactWithItem</code> so the UI does <strong>not</strong> need additional per-item fetches.</li>
</ol>
<p>Entry points:
- <code>src/app/api/library/[libraryId]/artifacts/batch-resolve/route.ts</code>
- <code>src/lib/shadow-twin/artifact-resolver.ts</code>
- <code>src/lib/shadow-twin/artifact-client.ts</code>
- <code>src/hooks/use-shadow-twin-analysis.ts</code></p>
<h2 id="architecture-shadow-twin-writing-model-how-artifacts-are-stored">Writing model (how artifacts are stored)<a class="headerlink" href="#architecture-shadow-twin-writing-model-how-artifacts-are-stored" title="Permanent link">&para;</a></h2>
<p>Writing is centralized to avoid duplicates and to enforce deterministic updates:
- <code>writeArtifact()</code> uses a canonical filename derived from the artifact key
- if the target file already exists → it is overwritten (update, not duplicate)
- optionally writes into a dot‑folder (when needed for related assets)</p>
<p>Entry point:
- <code>src/lib/shadow-twin/artifact-writer.ts</code></p>
<h2 id="architecture-shadow-twin-code-references-current">Code references (current)<a class="headerlink" href="#architecture-shadow-twin-code-references-current" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Naming &amp; parsing</strong>: <code>src/lib/shadow-twin/artifact-naming.ts</code></li>
<li><strong>Resolver</strong>: <code>src/lib/shadow-twin/artifact-resolver.ts</code></li>
<li><strong>Writer</strong>: <code>src/lib/shadow-twin/artifact-writer.ts</code></li>
<li><strong>Bulk API</strong>: <code>src/app/api/library/[libraryId]/artifacts/batch-resolve/route.ts</code></li>
<li><strong>Client wrapper</strong>: <code>src/lib/shadow-twin/artifact-client.ts</code></li>
</ul>
<h2 id="architecture-shadow-twin-usage-examples">Usage examples<a class="headerlink" href="#architecture-shadow-twin-usage-examples" title="Permanent link">&para;</a></h2>
<h3 id="architecture-shadow-twin-resolve-an-artifact-server-side">Resolve an artifact (server-side)<a class="headerlink" href="#architecture-shadow-twin-resolve-an-artifact-server-side" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">resolveArtifact</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/shadow-twin/artifact-resolver&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">resolved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">resolveArtifact</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">sourceItemId</span><span class="p">,</span>
<span class="w">  </span><span class="nx">sourceName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">parentId</span><span class="p">,</span>
<span class="w">  </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">preferredKind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transformation&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">templateName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdfanalyse&#39;</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="architecture-shadow-twin-write-an-artifact-server-side">Write an artifact (server-side)<a class="headerlink" href="#architecture-shadow-twin-write-an-artifact-server-side" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">writeArtifact</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/shadow-twin/artifact-writer&#39;</span><span class="p">;</span>

<span class="k">await</span><span class="w"> </span><span class="nx">writeArtifact</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sourceId</span><span class="o">:</span><span class="w"> </span><span class="kt">sourceItemId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;transformation&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">templateName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pdfanalyse&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">sourceName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">parentId</span><span class="p">,</span>
<span class="w">  </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">markdownWithFrontmatter</span><span class="p">,</span>
<span class="w">  </span><span class="nx">createFolder</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
<h2 id="architecture-shadow-twin-best-practices">Best practices<a class="headerlink" href="#architecture-shadow-twin-best-practices" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>UI must not implement filename heuristics</strong>: use the bulk resolver API.</li>
<li><strong>Use centralized naming</strong>: <code>buildArtifactName()</code> for canonical filenames.</li>
<li><strong>Use centralized writing</strong>: <code>writeArtifact()</code> to enforce update semantics.</li>
<li><strong>Dot‑folder naming must respect the 255 char limit</strong>: rely on <code>generateShadowTwinFolderName()</code>.</li>
</ol></section><section class="print-page" id="architecture-pdf-transformation-phases" heading-number="2.4"><h1 id="architecture-pdf-transformation-phases-pdf-transformation-phases">PDF Transformation Phases<a class="headerlink" href="#architecture-pdf-transformation-phases-pdf-transformation-phases" title="Permanent link">&para;</a></h1>
<p>Status: active<br />
Last verified: 2026-01-06  </p>
<h3 id="architecture-pdf-transformation-phases-scope">Scope<a class="headerlink" href="#architecture-pdf-transformation-phases-scope" title="Permanent link">&para;</a></h3>
<p>This document describes the <strong>current PDF processing pipeline</strong> (Extract → Template → Ingestion) and how it maps to the external-jobs runtime.
It also documents the <strong>artifact contracts</strong> (Shadow‑Twin) that downstream UI and ingestion rely on.</p>
<h3 id="architecture-pdf-transformation-phases-glossary">Glossary<a class="headerlink" href="#architecture-pdf-transformation-phases-glossary" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Transcript</strong>: extracted Markdown without frontmatter (Phase 1 output)</li>
<li><strong>Transformation</strong>: template-based Markdown with frontmatter/metadata (Phase 2 output)</li>
<li><strong>Ingestion</strong>: RAG upsert into MongoDB Atlas Vector Search (Phase 3)</li>
<li><strong>Shadow‑Twin</strong>: derived artifacts stored next to the source file (often in a dot-folder)</li>
</ul>
<h2 id="architecture-pdf-transformation-phases-overview">Overview<a class="headerlink" href="#architecture-pdf-transformation-phases-overview" title="Permanent link">&para;</a></h2>
<p>PDF transformation consists of three sequential phases that convert a PDF file into a searchable, structured document ready for RAG (Retrieval Augmented Generation). Each phase builds upon the previous one, creating intermediate artifacts that can be reused or skipped based on policies.</p>
<p>In the <strong>current implementation (IST)</strong>, these three phases are not executed via three separate HTTP endpoints, but through a combination of:</p>
<ul>
<li><strong>Worker</strong>: <code>src/lib/external-jobs-worker.ts</code> – polls jobs and calls the start route</li>
<li><strong>Start route</strong>: <code>src/app/api/external/jobs/[jobId]/start/route.ts</code> – initializes the job and starts Phase 1 (Extract) or an ingest-only path</li>
<li><strong>Secretary Service (external)</strong> – performs PDF/OCR/template transformation and sends webhooks back</li>
<li><strong>Callback route</strong>: <code>src/app/api/external/jobs/[jobId]/route.ts</code> – processes webhooks and orchestrates Phase 1–3 (Extract, Template, Ingestion)</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-runtime-orchestration-high-level">Runtime Orchestration (high level)<a class="headerlink" href="#architecture-pdf-transformation-phases-runtime-orchestration-high-level" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Worker (jobs queue)
  ↓ POST /api/external/jobs/{jobId}/start
Start route
  - loads PDF from storage
  - decides Extract/Template/Ingest-only via gates + policies
  - calls Secretary Service (PDF/OCR)
  ↓ Webhook: POST /api/external/jobs/{jobId}
Secretary Service (external)
  - extracts text/images
  - sends extracted_text, pages_archive_url, mistral_ocr_raw_url, ...
  ↓
Callback route
  - processes extract result (Phase 1)
  - runs or skips template phase (Phase 2)
  - runs or skips ingestion (Phase 3)
</code></pre></div>
<h2 id="architecture-pdf-transformation-phases-phase-1-extract-extraction">Phase 1: Extract (Extraction)<a class="headerlink" href="#architecture-pdf-transformation-phases-phase-1-extract-extraction" title="Permanent link">&para;</a></h2>
<h3 id="architecture-pdf-transformation-phases-purpose">Purpose<a class="headerlink" href="#architecture-pdf-transformation-phases-purpose" title="Permanent link">&para;</a></h3>
<p>Extract text and images from PDF files using OCR or native text extraction.</p>
<h3 id="architecture-pdf-transformation-phases-what-happens">What Happens<a class="headerlink" href="#architecture-pdf-transformation-phases-what-happens" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>PDF Processing</strong>:</li>
<li>PDF file is sent to Secretary Service</li>
<li>Text extraction via native PDF parsing or OCR (Mistral OCR)</li>
<li>
<p>Image extraction (if enabled)</p>
</li>
<li>
<p><strong>Image Processing</strong>:</p>
</li>
<li>Mistral OCR images: Extracted via <code>mistral_ocr_images_url</code> (ZIP archive) - separate from <code>mistral_ocr_raw</code></li>
<li>PDF page images: Extracted as ZIP archive (<code>pages_archive_url</code> or <code>pages_archive_data</code>)</li>
<li>Images saved to Shadow-Twin directory (if present)</li>
<li>
<p><strong>Note</strong>: Asynchronous webhook sends <code>mistral_ocr_raw_url</code> and <code>mistral_ocr_raw_metadata</code> only. Full <code>mistral_ocr_raw</code> data must be downloaded via <code>GET /api/pdf/jobs/{job_id}/mistral-ocr-raw</code></p>
</li>
<li>
<p><strong>Markdown Creation</strong>:</p>
</li>
<li>Extracted text saved as Markdown <strong>without frontmatter</strong></li>
<li>File name (v2): <code>{baseName}.{language}.md</code> (transcript, language suffix)</li>
</ol>
<h3 id="architecture-pdf-transformation-phases-input">Input<a class="headerlink" href="#architecture-pdf-transformation-phases-input" title="Permanent link">&para;</a></h3>
<ul>
<li>PDF file (<code>document.pdf</code>)</li>
<li>Extraction method (<code>native</code> or <code>mistral_ocr</code>)</li>
<li>Target language (for OCR)</li>
<li>Image extraction flags (<code>includeOcrImages</code>, <code>includePageImages</code>)</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-output">Output<a class="headerlink" href="#architecture-pdf-transformation-phases-output" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Transcript File</strong>: <code>document.de.md</code> (Markdown without frontmatter; language suffix)</li>
<li><strong>Images</strong>: Saved to <code>.document.pdf/</code> directory (if images extracted)</li>
<li><strong>Shadow-Twin Directory</strong>: Created automatically if images are present</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-code-references-ist">Code References (IST)<a class="headerlink" href="#architecture-pdf-transformation-phases-code-references-ist" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Worker &amp; routes</strong></li>
<li><strong><code>src/lib/external-jobs-worker.ts</code></strong>: Background worker that polls jobs from the queue and triggers the start route (<code>POST /api/external/jobs/[jobId]/start</code>)</li>
<li><strong><code>src/app/api/external/jobs/[jobId]/start/route.ts</code></strong>: Start route; loads the PDF from storage, sets watchdog/steps, calls Secretary Service (standard or Mistral OCR endpoint) and can run an ingest-only flow</li>
<li><strong><code>src/app/api/external/jobs/[jobId]/route.ts</code></strong>: Callback route; processes webhooks from Secretary Service (including <code>extracted_text</code>, <code>pages_archive_url</code>, <code>mistral_ocr_raw_url</code>) and decides whether to run Extract-only, Extract+Template+Ingest or a skip path</li>
<li><strong>Extract-Phase (Core-Module)</strong></li>
<li><strong><code>src/lib/external-jobs/extract-only.ts</code></strong>: Extract-only processing logic (Transcript speichern, Bilder verarbeiten, Job abschließen)</li>
<li><strong><code>src/lib/external-jobs/images.ts</code></strong>: Image extraction and processing (pages-Archive, images-Archive, Mistral OCR)</li>
<li><strong><code>src/lib/external-jobs/storage.ts</code></strong>: Markdown storage in the shadow twin or parent folder</li>
<li><strong><code>src/lib/processing/gates.ts</code></strong> (<code>gateExtractPdf</code>): Gate that checks whether a shadow twin (transcript or transformed) already exists and allows Extract to be skipped</li>
<li><strong><code>src/lib/transform/image-extraction-service.ts</code></strong>: Image extraction service (deeper image-processing pipeline)</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-execution-in-code-ist">Execution in Code (IST)<a class="headerlink" href="#architecture-pdf-transformation-phases-execution-in-code-ist" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Start route</strong></li>
<li>Loads the PDF from storage via <code>getServerProvider</code>.</li>
<li>Runs preprocessing and initializes steps (<code>extract_pdf</code>, <code>transform_template</code>, <code>ingest_rag</code>).</li>
<li>Calls <code>gateExtractPdf</code> and phase policies to decide:<ul>
<li>whether Extract should actually be sent to Secretary Service (<code>runExtract</code>),</li>
<li>whether only Template/Ingestion should run,</li>
<li>whether an <strong>ingest-only</strong> path without a new Secretary call is possible.</li>
</ul>
</li>
<li>
<p>When <code>runExtract</code> is true, sends an HTTP request to Secretary Service (<code>/api/pdf/process</code> or <code>/api/pdf/process-mistral-ocr</code>) with <code>callback_url</code> = <code>/api/external/jobs/{jobId}</code>.</p>
</li>
<li>
<p><strong>Callback route</strong></p>
</li>
<li>Receives webhooks with <code>extracted_text</code> and image archives.</li>
<li>Marks <code>extract_pdf</code> as completed as soon as a stable OCR result is available.</li>
<li>If template and ingest phases are explicitly disabled, calls <code>runExtractOnly</code>, stores the transcript without frontmatter and optionally processes images.</li>
<li>In all other cases it only ensures that Phase 1 is completed and passes the results to the template/ingestion logic.</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-example-output">Example Output<a class="headerlink" href="#architecture-pdf-transformation-phases-example-output" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>.document.pdf/
├── document.de.md       (Transcript - extracted text, no frontmatter)
├── page-001.png        (Extracted images)
└── page-002.png
</code></pre></div>
<h2 id="architecture-pdf-transformation-phases-phase-2-template-metadata">Phase 2: Template (Metadata)<a class="headerlink" href="#architecture-pdf-transformation-phases-phase-2-template-metadata" title="Permanent link">&para;</a></h2>
<h3 id="architecture-pdf-transformation-phases-purpose_1">Purpose<a class="headerlink" href="#architecture-pdf-transformation-phases-purpose_1" title="Permanent link">&para;</a></h3>
<p>Add structured metadata (frontmatter) to the extracted text, enabling structured queries and RAG integration.</p>
<h3 id="architecture-pdf-transformation-phases-what-happens_1">What Happens<a class="headerlink" href="#architecture-pdf-transformation-phases-what-happens_1" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Template Processing</strong>:</li>
<li>Transcript Markdown (<code>document.md</code>) is sent to Secretary Service template transformer</li>
<li>LLM analyzes content and extracts structured metadata</li>
<li>Frontmatter is generated with chapters, topics etc.</li>
<li>
<p><strong>The total page count (<code>pages</code>) is not computed by the template but always reconstructed from the <code>--- Seite N ---</code> markers in the Markdown body.</strong></p>
</li>
<li>
<p><strong>Markdown Creation</strong>:</p>
</li>
<li>Transcript content + frontmatter = transformed Markdown</li>
<li>File name: <code>{originalName}.{language}.md</code> (with language suffix - transformed)</li>
</ol>
<h3 id="architecture-pdf-transformation-phases-input_1">Input<a class="headerlink" href="#architecture-pdf-transformation-phases-input_1" title="Permanent link">&para;</a></h3>
<ul>
<li>Transcript Markdown (<code>document.md</code>)</li>
<li>Template content (structured schema)</li>
<li>Target language</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-output_1">Output<a class="headerlink" href="#architecture-pdf-transformation-phases-output_1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Transformed File</strong>: <code>document.de.md</code> (Markdown with frontmatter)</li>
<li><strong>Metadata</strong>: Structured data in YAML frontmatter</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-code-references-ist_1">Code References (IST)<a class="headerlink" href="#architecture-pdf-transformation-phases-code-references-ist_1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Routes &amp; orchestration</strong></li>
<li><strong><code>src/app/api/external/jobs/[jobId]/route.ts</code></strong>: Central callback route that, after receiving extract results, decides whether the template phase runs or is skipped and then saves the transformed Markdown.</li>
<li><strong>Template phase (core modules)</strong></li>
<li><strong><code>src/lib/external-jobs/phase-template.ts</code></strong>: Consolidated template phase (decision logic, repair cases, saving transformed Markdown)</li>
<li><strong><code>src/lib/external-jobs/template-run.ts</code></strong>: Template transformation execution (calls the Secretary template transformer and parses the response)</li>
<li><strong><code>src/lib/external-jobs/chapters.ts</code></strong>: Chapter detection and merge based on text</li>
<li><strong><code>src/lib/external-jobs/template-files.ts</code></strong>: Template-Auswahl für External Jobs (<strong>MongoDB Source of Truth</strong>), serialisiert Secretary-kompatibel (ohne <code>creation</code>)</li>
<li><strong><code>src/lib/templates/template-service-mongodb.ts</code></strong>: MongoDB Template-Service inkl. Serialisierung zu Template-Markdown (Frontmatter + Body + systemprompt)</li>
<li><strong>Hinweis (Legacy)</strong>: <code>src/lib/templates/template-service.ts</code> lädt Templates aus dem Library-Storage <code>/templates</code> Ordner und wird primär für Import/Migration genutzt.</li>
<li><strong><code>src/lib/processing/gates.ts</code></strong> (<code>gateTransformTemplate</code>): Gate checking (e.g. skip if chapter metadata already exists)</li>
<li><strong><code>src/lib/external-jobs/storage.ts</code></strong>: Saves transformed Markdown (<code>{originalName}.{language}.md</code>)</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-execution-in-code-ist_1">Execution in Code (IST)<a class="headerlink" href="#architecture-pdf-transformation-phases-execution-in-code-ist_1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Callback route</strong></li>
<li>Runs a preprocess span (if not already present) to detect existing frontmatter and its quality.</li>
<li>Reads policies and phase flags via <code>readPhasesAndPolicies</code> and <code>job.parameters.phases</code>.</li>
<li>Determines from the callback body whether chapter metadata (<code>chapters</code>) is already present.</li>
<li>Calls the consolidated template phase (<code>runTemplatePhase</code> in <code>phase-template.ts</code>), which:<ul>
<li>combines policies (<code>metadata: force/skip/auto/ignore</code>),</li>
<li>gates (<code>gateTransformTemplate</code>), and</li>
<li>the repair needs of an existing shadow twin.</li>
</ul>
</li>
<li><strong>Template transformation is only executed if no chapter metadata (<code>chapters</code>) exists yet.</strong> If only <code>pages</code> are missing, they are reconstructed from the <code>--- Seite N ---</code> markers in the body.</li>
<li>When template processing is executed:<ul>
<li>it selects a template from <strong>MongoDB</strong> (TemplateDocument) and serialisiert es als Secretary-kompatibles Template-Markdown (ohne <code>creation</code>),</li>
<li>calls the Secretary template endpoint and adds chapter information,</li>
<li>strips old frontmatter and stores the new Markdown with frontmatter via <code>saveMarkdown</code> as <code>{originalName}.{language}.md</code>,</li>
<li>and reliably marks the <code>transform_template</code> step as <code>completed</code> or <code>failed</code>.</li>
</ul>
</li>
<li>When the template phase is skipped (chapters already exist), only missing <code>pages</code> are reconstructed and the existing frontmatter is used directly as the basis for ingestion.</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-example-output_1">Example Output<a class="headerlink" href="#architecture-pdf-transformation-phases-example-output_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>---
title: &quot;Document Title&quot;
pages: 42
chapters:
<span class="w">  </span><span class="k">-</span><span class="w"> </span>title: &quot;Chapter 1&quot;
    page: 1
<span class="w">  </span><span class="k">-</span><span class="w"> </span>title: &quot;Chapter 2&quot;
<span class="gu">    page: 15</span>
<span class="gu">---</span>
<span class="gh"># Document Title</span>

[Extracted content...]
</code></pre></div>
<h3 id="architecture-pdf-transformation-phases-skip-conditions">Skip Conditions<a class="headerlink" href="#architecture-pdf-transformation-phases-skip-conditions" title="Permanent link">&para;</a></h3>
<ul>
<li>Chapter metadata (<code>chapters</code>) already exists (frontmatter is complete with respect to chapters).</li>
<li>Template phase disabled via policy.</li>
<li>Previous job already completed the template phase.</li>
</ul>
<p>If only the page count (<code>pages</code>) is missing, the template phase is skipped and <code>pages</code> is silently reconstructed from the <code>--- Seite N ---</code> markers in the body.</p>
<h2 id="architecture-pdf-transformation-phases-phase-3-ingestion-rag">Phase 3: Ingestion (RAG)<a class="headerlink" href="#architecture-pdf-transformation-phases-phase-3-ingestion-rag" title="Permanent link">&para;</a></h2>
<h3 id="architecture-pdf-transformation-phases-purpose_2">Purpose<a class="headerlink" href="#architecture-pdf-transformation-phases-purpose_2" title="Permanent link">&para;</a></h3>
<p>Ingest transformed Markdown into MongoDB Atlas Vector Search for RAG queries.</p>
<h3 id="architecture-pdf-transformation-phases-what-happens_2">What Happens<a class="headerlink" href="#architecture-pdf-transformation-phases-what-happens_2" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Markdown Processing</strong>:</li>
<li>Transformed Markdown (<code>document.de.md</code>) is parsed</li>
<li>Images are processed and uploaded to Azure Storage (Slides, Cover, Markdown images)</li>
<li>
<p>Final Markdown (with Azure image URLs) is stored in MongoDB</p>
</li>
<li>
<p><strong>Vector Storage</strong>:</p>
</li>
<li><strong>Complete document</strong> is sent to Secretary Service RAG API (<code>/api/rag/embed-text</code>)</li>
<li>Secretary Service performs Markdown-aware chunking and embedding generation</li>
<li>Chunks with embeddings are received and stored in MongoDB Vector Search Collection</li>
<li>Meta-documents (without embeddings) are stored alongside chunks for gallery display</li>
<li>
<p>Facet metadata is duplicated into chunks for direct filtering during vector search</p>
</li>
<li>
<p><strong>MongoDB Storage</strong>:</p>
</li>
<li>All data stored in MongoDB: Meta-documents, chunks, and chapter summaries in same collection</li>
<li>Collection structure: <code>vectors__${libraryId}</code> per library</li>
<li>Document metadata stored as <code>kind: 'meta'</code> documents (no embeddings)</li>
<li>
<p>Chapter summaries stored as <code>kind: 'chapterSummary'</code> documents (with embeddings)</p>
</li>
<li>
<p><strong>Image Upload (Shadow-Twin → Azure Storage)</strong>:</p>
</li>
<li>All image handling in Phase 3 is based on the <strong>Shadow-Twin directory</strong> and is centralized in the ingestion service.</li>
<li><strong>Session-mode documents (events with slides)</strong>:<ul>
<li><code>docMetaJson.slides[].image_url</code> is interpreted as a reference into the Shadow-Twin.</li>
<li>Each slide image is resolved via <code>findShadowTwinImage</code>, uploaded to Azure Storage under the scoped path <code>…/{libraryId}/sessions/{fileId}/{hash}.{ext}</code> and de-duplicated by hash.</li>
<li>The resulting Azure URLs replace the original <code>slides[].image_url</code> values and are used directly by the frontend (<code>EventSlides</code>).</li>
</ul>
</li>
<li><strong>Book-mode documents (no slides)</strong>:<ul>
<li>A <strong>cover image</strong> is detected in the Shadow-Twin directory (<code>preview_001.jpg</code>), uploaded to Azure under <code>…/{libraryId}/books/{fileId}/{hash}.{ext}</code> and stored as <code>docMetaJson.coverImageUrl</code>; this field is also available as a facet and is used by the gallery and book-detail views.</li>
<li>Inline images in the Markdown body (Markdown <code>![]()</code>, HTML <code>&lt;img&gt;</code> and Obsidian <code>&lt;img-x.ext&gt;</code> syntax) are resolved against the Shadow-Twin, uploaded to Azure under the <code>books</code> scope and <strong>all references in the Markdown are rewritten</strong> to use the Azure URLs.</li>
</ul>
</li>
<li>Frontend components (gallery cards, document detail, markdown viewer) use <strong>only these Azure URLs</strong>; direct access to Shadow-Twin image files from the browser is no longer required.</li>
</ol>
<h3 id="architecture-pdf-transformation-phases-input_2">Input<a class="headerlink" href="#architecture-pdf-transformation-phases-input_2" title="Permanent link">&para;</a></h3>
<ul>
<li>Transformed Markdown (<code>document.de.md</code>)</li>
<li>Shadow-Twin directory (transcript, transformed Markdown, extracted images)</li>
<li>Library configuration (including ingestion policies and facets)</li>
<li>Storage provider + <code>shadowTwinFolderId</code> from the job’s <code>shadowTwinState</code></li>
</ul>
<h3 id="architecture-pdf-transformation-phases-output_2">Output<a class="headerlink" href="#architecture-pdf-transformation-phases-output_2" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Vector embeddings</strong>: Stored in MongoDB Vector Search Collection (<code>vectors__${libraryId}</code>)</li>
<li><strong>Document metadata</strong>: Stored as meta-documents (<code>kind: 'meta'</code>) in same collection</li>
<li><strong>Image URLs</strong>: Azure Storage URLs in metadata</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-code-references-ist_2">Code References (IST)<a class="headerlink" href="#architecture-pdf-transformation-phases-code-references-ist_2" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Routes &amp; orchestration</strong></li>
<li><strong><code>src/app/api/external/jobs/[jobId]/start/route.ts</code></strong>: Can execute an ingest-only path if a transformed shadow-twin Markdown already exists (without another Secretary request).</li>
<li><strong><code>src/app/api/external/jobs/[jobId]/route.ts</code></strong>: Runs the regular ingestion after the template phase (including gates, policies, and error handling).</li>
<li><strong>Ingestion phase (core modules)</strong></li>
<li><strong><code>src/lib/external-jobs/ingest.ts</code></strong>: RAG ingestion pipeline (wrapper around the ingestion service)</li>
<li><strong><code>src/lib/chat/ingestion-service.ts</code></strong>: Ingestion service (Secretary Service RAG API integration, MongoDB Vector Search upsert, <strong>image processing and Azure upload</strong> via <code>processSlideImagesToAzure</code>, <code>processMarkdownImagesToAzure</code>, <code>processCoverImageToAzure</code>)</li>
<li><strong><code>src/lib/chat/rag-embeddings.ts</code></strong>: RAG embedding abstraction (Secretary Service client wrapper)</li>
<li><strong><code>src/lib/secretary/client.ts</code></strong>: Secretary Service client (<code>embedTextRag()</code> for RAG API)</li>
<li><strong><code>src/lib/repositories/vector-repo.ts</code></strong>: MongoDB Vector Search repository (upsert, query, meta-documents)</li>
<li><strong><code>src/lib/processing/gates.ts</code></strong> (<code>gateIngestRag</code>): Gate checking (skip if already ingested; uses MongoDB query)</li>
<li><strong><code>src/lib/external-jobs/complete.ts</code></strong>: Job completion handler (status, result, events)</li>
<li><strong>Storage &amp; metadata</strong></li>
<li><strong><code>src/lib/repositories/doc-meta-repo.ts</code></strong>: MongoDB document metadata repository (incl. <code>coverImageUrl</code>)</li>
<li><strong><code>src/lib/storage/shadow-twin.ts</code></strong>: Shadow-Twin utilities (<code>findShadowTwinImage</code>, <code>resolveShadowTwinImageUrl</code>) for resolving images by relative path</li>
<li><strong><code>src/lib/services/azure-storage-service.ts</code></strong>: Azure Storage client (scoped blob paths <code>books</code> / <code>sessions</code>, hash-based de-duplication)</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-execution-in-code-ist_2">Execution in Code (IST)<a class="headerlink" href="#architecture-pdf-transformation-phases-execution-in-code-ist_2" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Start route (ingest-only path)</strong></li>
<li>
<p>If policies/gates decide that Extract/Template are not needed but ingestion should run:</p>
<ul>
<li>it searches for the already transformed Markdown in the shadow twin (directory first, then file),</li>
<li>loads the Markdown text and parses frontmatter via <code>parseSecretaryMarkdownStrict</code>,</li>
<li>calls <code>runIngestion</code> directly and completes the job after successful ingestion.</li>
</ul>
</li>
<li>
<p><strong>Callback route (regular path)</strong></p>
</li>
<li>Uses <code>gateIngestRag</code> and optionally <code>ingestionCheck</code> to determine whether vectors for this document already exist in the MongoDB Vector Search collection.</li>
<li>Reads ingestion policies (<code>ingestPolicy: 'do' | 'force' | 'skip'</code> plus legacy flags from <code>job.parameters</code>).</li>
<li>Determines <code>useIngestion</code> and marks <code>ingest_rag</code> as <code>skipped</code> if appropriate (including reason).</li>
<li>When ingestion runs:<ul>
<li>determines <code>fileId</code> and <code>fileName</code> of the document to ingest,</li>
<li>loads Markdown for ingestion (directly from the current callback context or via storage fallback),</li>
<li>calls <code>runIngestion</code>, which:</li>
<li>calls <code>IngestionService.upsertMarkdown(...)</code>,</li>
<li>stores chunks in Pinecone, and</li>
<li>writes metadata (including chapter summaries) to MongoDB,</li>
<li>updates the ingestion status in the job (<code>setIngestion</code>) and sets the <code>ingest_rag</code> step to <code>completed</code>.</li>
</ul>
</li>
<li>Finally calls <code>setJobCompleted</code>, updates the shadow-twin state to <code>processingStatus: 'ready'</code> and sends a final <code>job_update</code> event with <code>refreshFolderIds</code>.</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-skip-conditions_1">Skip Conditions<a class="headerlink" href="#architecture-pdf-transformation-phases-skip-conditions_1" title="Permanent link">&para;</a></h3>
<ul>
<li>Document already ingested (check via <code>ingestionCheck</code>)</li>
<li>Ingestion phase disabled via policy</li>
</ul>
<h2 id="architecture-pdf-transformation-phases-phase-control">Phase Control<a class="headerlink" href="#architecture-pdf-transformation-phases-phase-control" title="Permanent link">&para;</a></h2>
<h3 id="architecture-pdf-transformation-phases-policies">Policies<a class="headerlink" href="#architecture-pdf-transformation-phases-policies" title="Permanent link">&para;</a></h3>
<p>Phases can be controlled via policies:</p>
<div class="highlight"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nx">PhasePolicies</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">extract</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;force&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;skip&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;ignore&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;force&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;skip&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;ignore&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">ingest</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;force&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;skip&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;ignore&#39;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><strong><code>force</code></strong>: Always execute phase (even if artifacts exist)</li>
<li><strong><code>skip</code></strong>: Skip phase (even if artifacts don't exist)</li>
<li><strong><code>auto</code></strong>: Execute if needed (check gates)</li>
<li><strong><code>ignore</code></strong>: Phase disabled</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-gates">Gates<a class="headerlink" href="#architecture-pdf-transformation-phases-gates" title="Permanent link">&para;</a></h3>
<p>Gates check if phases should be skipped:</p>
<ul>
<li><strong><code>gateExtractPdf()</code></strong>: Checks for existing Shadow-Twin files</li>
<li><strong><code>gateTransformTemplate()</code></strong>: Checks for existing frontmatter</li>
<li><strong><code>gateIngestRag()</code></strong>: Checks for existing ingestion</li>
</ul>
<h3 id="architecture-pdf-transformation-phases-execution-flow">Execution Flow<a class="headerlink" href="#architecture-pdf-transformation-phases-execution-flow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>PDF File
  ↓
[Gate: Extract] → Skip if Shadow-Twin exists
  ↓
Phase 1: Extract → document.md + images
  ↓
[Gate: Template] → Skip if frontmatter exists
  ↓
Phase 2: Template → document.de.md
  ↓
[Gate: Ingestion] → Skip if already ingested
  ↓
Phase 3: Ingestion → Vector storage + MongoDB
  ↓
Complete
</code></pre></div>
<h2 id="architecture-pdf-transformation-phases-file-naming-convention">File Naming Convention<a class="headerlink" href="#architecture-pdf-transformation-phases-file-naming-convention" title="Permanent link">&para;</a></h2>
<h3 id="architecture-pdf-transformation-phases-v2-only-artifact-naming-shadowtwin">v2-only artifact naming (Shadow‑Twin)<a class="headerlink" href="#architecture-pdf-transformation-phases-v2-only-artifact-naming-shadowtwin" title="Permanent link">&para;</a></h3>
<p>In the current runtime, file naming is <strong>deterministic</strong> and shared across all media types.
Do not rely on legacy “<code>originalName.md</code>” heuristics.</p>
<h4 id="architecture-pdf-transformation-phases-transcript-artifact-phase-1">Transcript artifact (Phase 1)<a class="headerlink" href="#architecture-pdf-transformation-phases-transcript-artifact-phase-1" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Format</strong>: <code>{baseName}.{language}.md</code></li>
<li><strong>Example</strong>: <code>document.de.md</code></li>
<li><strong>Content</strong>: extracted Markdown (typically <strong>without</strong> frontmatter)</li>
</ul>
<h4 id="architecture-pdf-transformation-phases-transformation-artifact-phase-2">Transformation artifact (Phase 2)<a class="headerlink" href="#architecture-pdf-transformation-phases-transformation-artifact-phase-2" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Format</strong>: <code>{baseName}.{templateName}.{language}.md</code></li>
<li><strong>Example</strong>: <code>document.pdfanalyse.de.md</code></li>
<li><strong>Content</strong>: Markdown <strong>with</strong> frontmatter/metadata</li>
</ul>
<h4 id="architecture-pdf-transformation-phases-location">Location<a class="headerlink" href="#architecture-pdf-transformation-phases-location" title="Permanent link">&para;</a></h4>
<p>Artifacts can live either:
1) inside a <strong>dot-folder</strong> <code>.{originalName}/</code> (recommended when multiple assets exist), or<br />
2) as <strong>siblings</strong> next to the PDF (common when only Markdown exists).</p>
<h4 id="architecture-pdf-transformation-phases-update-semantics">Update semantics<a class="headerlink" href="#architecture-pdf-transformation-phases-update-semantics" title="Permanent link">&para;</a></h4>
<p>Re-running the same phase <strong>updates</strong> (overwrites) the canonical artifact instead of creating duplicates.</p>
<h2 id="architecture-pdf-transformation-phases-error-handling">Error Handling<a class="headerlink" href="#architecture-pdf-transformation-phases-error-handling" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Phase failures</strong>: Logged in job document, job status set to <code>failed</code></li>
<li><strong>Partial completion</strong>: Intermediate artifacts preserved</li>
<li><strong>Retry</strong>: Failed phases can be retried independently</li>
<li><strong>Skip on error</strong>: Subsequent phases can still execute if previous phase failed (depending on policy)</li>
</ul>
<h2 id="architecture-pdf-transformation-phases-performance-considerations">Performance Considerations<a class="headerlink" href="#architecture-pdf-transformation-phases-performance-considerations" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Parallel processing</strong>: Images processed in parallel with text extraction</li>
<li><strong>Caching</strong>: Secretary Service caches OCR results</li>
<li><strong>Batch processing</strong>: Multiple PDFs processed in parallel</li>
<li><strong>Incremental updates</strong>: Only changed phases re-executed</li>
</ul></section><section class="print-page" id="architecture-mongodb-vector-search" heading-number="2.5"><h1 id="architecture-mongodb-vector-search-architecture-mongodb-vector-search">MongoDB Vector Search</h1><h2 id="mongodb-vector-search-architecture">MongoDB Vector Search (architecture)<a class="headerlink" href="#architecture-mongodb-vector-search-mongodb-vector-search-architecture" title="Permanent link">&para;</a></h2>
<p>Status: active<br />
Last verified: 2026-01-06  </p>
<h3 id="architecture-mongodb-vector-search-scope">Scope<a class="headerlink" href="#architecture-mongodb-vector-search-scope" title="Permanent link">&para;</a></h3>
<p>This document describes the <strong>data model and index shape</strong> for MongoDB Atlas Vector Search in this repo.
Operational “what to debug” notes live in <code>docs/analysis/ingestion.md</code>.</p>
<h3 id="architecture-mongodb-vector-search-glossary">Glossary<a class="headerlink" href="#architecture-mongodb-vector-search-glossary" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Vector collection</strong>: MongoDB collection <code>vectors__${libraryId}</code> (one per library)</li>
<li><strong>Vector search index</strong>: Atlas search index <code>vector_search_idx</code></li>
<li><strong>meta</strong>: metadata-only document (no embedding)</li>
<li><strong>chunk</strong>: text chunk + embedding</li>
<li><strong>chapterSummary</strong>: chapter summary + embedding</li>
</ul>
<p>This project uses <strong>MongoDB Atlas Vector Search</strong> for semantic search and RAG.
Embeddings and metadata live in MongoDB. No separate vector database is required.</p>
<h3 id="architecture-mongodb-vector-search-collection-layout">Collection layout<a class="headerlink" href="#architecture-mongodb-vector-search-collection-layout" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>One collection per library</strong>: <code>vectors__${libraryId}</code></li>
<li>Multiple document kinds live in the same collection (distinguished by <code>kind</code>)</li>
<li><code>meta</code>: full metadata (no embedding)</li>
<li><code>chunk</code>: text chunk + embedding</li>
<li><code>chapterSummary</code>: chapter summary + embedding</li>
</ul>
<h3 id="architecture-mongodb-vector-search-why-we-keep-meta-without-embeddings">Why we keep <code>meta</code> without embeddings<a class="headerlink" href="#architecture-mongodb-vector-search-why-we-keep-meta-without-embeddings" title="Permanent link">&para;</a></h3>
<ul>
<li>The gallery and facet aggregation need full metadata.</li>
<li>Storing meta without embeddings saves space and keeps writes cheaper.</li>
</ul>
<h3 id="architecture-mongodb-vector-search-vector-search-index">Vector search index<a class="headerlink" href="#architecture-mongodb-vector-search-vector-search-index" title="Permanent link">&para;</a></h3>
<ul>
<li>Index name: <code>vector_search_idx</code></li>
<li>Created lazily (first access) via Mongo admin commands</li>
</ul>
<p>Example (simplified):
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vector_search_idx&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;definition&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;mappings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;dynamic&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;fields&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;embedding&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;knnVector&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;dimensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;similarity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cosine&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<h3 id="architecture-mongodb-vector-search-token-indexes-for-filtering-important">Token indexes for filtering (important)<a class="headerlink" href="#architecture-mongodb-vector-search-token-indexes-for-filtering-important" title="Permanent link">&para;</a></h3>
<p>Atlas Vector Search requires fields used in <code>$vectorSearch.filter</code> to be indexed in a compatible way.
In practice, this means:</p>
<ul>
<li>fields filtered via <code>$in</code> must be indexed as <strong>token</strong> (not plain string)</li>
<li>this includes <strong>arrays</strong> (e.g. <code>authors</code>, <code>tags</code>) and also “single string facets” if the code always uses <code>$in</code></li>
</ul>
<p>If you see errors like:</p>
<blockquote>
<p><code>Path 'authors' needs to be indexed as token</code></p>
</blockquote>
<p>the fix is to ensure the search index mapping contains token entries for those fields.</p>
<h3 id="architecture-mongodb-vector-search-recommended-mapping-additions-example">Recommended mapping additions (example)<a class="headerlink" href="#architecture-mongodb-vector-search-recommended-mapping-additions-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;mappings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;dynamic&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fields&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;embedding&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;knnVector&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;dimensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;similarity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cosine&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;libraryId&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;fileId&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;authors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;speakers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;topics&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;token&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Notes:
- The exact list depends on which facet fields you use in filters.
- When in doubt: index every filterable facet as token to avoid runtime failures.</p>
<h3 id="architecture-mongodb-vector-search-query-patterns">Query patterns<a class="headerlink" href="#architecture-mongodb-vector-search-query-patterns" title="Permanent link">&para;</a></h3>
<p>Vector search query (simplified):
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">pipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">$vectorSearch</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">index</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;vector_search_idx&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;embedding&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">queryVector</span><span class="p">,</span>
<span class="w">      </span><span class="nx">numCandidates</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.max</span><span class="p">(</span><span class="nx">topK</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">100</span><span class="p">),</span>
<span class="w">      </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">topK</span><span class="p">,</span>
<span class="w">      </span><span class="nx">filter</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$in</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;chunk&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;chapterSummary&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">libraryId</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$eq</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$project</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$meta</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;vectorSearchScore&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div></p>
<p>Direct Mongo query (no vector search), e.g. for neighbor chunks:
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
<span class="w">  </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chunk&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="p">,</span>
<span class="w">  </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">userEmail</span><span class="p">,</span>
<span class="w">  </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$in</span><span class="o">:</span><span class="w"> </span><span class="kt">fileIds</span><span class="w"> </span><span class="p">},</span>
<span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">fileId</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">chunkIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">toArray</span><span class="p">()</span>
</code></pre></div></p>
<h3 id="architecture-mongodb-vector-search-facet-duplication">Facet duplication<a class="headerlink" href="#architecture-mongodb-vector-search-facet-duplication" title="Permanent link">&para;</a></h3>
<p>Facet fields are copied into <code>chunk</code> and <code>chapterSummary</code> documents so filtering can happen directly inside <code>$vectorSearch</code>.</p>
<h3 id="architecture-mongodb-vector-search-code-references">Code references<a class="headerlink" href="#architecture-mongodb-vector-search-code-references" title="Permanent link">&para;</a></h3>
<ul>
<li>Repository: <code>src/lib/repositories/vector-repo.ts</code></li>
<li>Ingestion: <code>src/lib/chat/ingestion-service.ts</code></li>
<li>Retrievers:</li>
<li><code>src/lib/chat/retrievers/chunks.ts</code></li>
<li><code>src/lib/chat/retrievers/chunk-summary.ts</code></li>
</ul>
<h3 id="architecture-mongodb-vector-search-related-docs">Related docs<a class="headerlink" href="#architecture-mongodb-vector-search-related-docs" title="Permanent link">&para;</a></h3>
<ul>
<li>Runtime/operations notes: <code>docs/analysis/ingestion.md</code></li>
</ul></section></section>
                    <section class='print-page md-section' id='section-3' heading-number='3'>
                        <h1>Analysis<a class='headerlink' href='#section-3' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="analysis-shadow-twin-v2-only" heading-number="3.1"><h1 id="analysis-shadow-twin-v2-only-analysis-shadow-twin-v2-only">Shadow-Twin (v2-only)</h1><h2 id="shadow-twin-v2-only-runtime">Shadow-Twin (v2-only runtime)<a class="headerlink" href="#analysis-shadow-twin-v2-only-shadow-twin-v2-only-runtime" title="Permanent link">&para;</a></h2>
<p>Status: active<br />
Last verified: 2026-01-04  </p>
<h3 id="analysis-shadow-twin-v2-only-scope">Scope<a class="headerlink" href="#analysis-shadow-twin-v2-only-scope" title="Permanent link">&para;</a></h3>
<p>This document describes <strong>how Shadow-Twin works in the current runtime</strong> (v2-only).<br />
It does <strong>not</strong> describe migration/repair of old data (Phase B, deferred).</p>
<h3 id="analysis-shadow-twin-v2-only-summary-what-is-true-today">Summary (what is true today)<a class="headerlink" href="#analysis-shadow-twin-v2-only-summary-what-is-true-today" title="Permanent link">&para;</a></h3>
<ul>
<li>The application runtime is <strong>v2-only</strong> for Shadow-Twin artifact resolve/write.</li>
<li>Transcript + Transformation artifacts use <strong>deterministic names</strong>.</li>
<li>The UI must not guess filenames. It uses the backend resolver (bulk).</li>
<li>Legacy/V1 repair paths were removed from the runtime path.</li>
</ul>
<h3 id="analysis-shadow-twin-v2-only-glossary">Glossary<a class="headerlink" href="#analysis-shadow-twin-v2-only-glossary" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Artifact</strong>: a generated file related to a source file (Markdown, images).</li>
<li><strong>Transcript</strong>: extracted text (usually without frontmatter).</li>
<li><strong>Transformation</strong>: template-based Markdown with frontmatter/metadata.</li>
<li><strong>Dot-folder</strong>: hidden folder <code>.{originalName}</code> that groups multiple related artifacts.</li>
</ul>
<h3 id="analysis-shadow-twin-v2-only-v2-only-enforcement">v2-only enforcement<a class="headerlink" href="#analysis-shadow-twin-v2-only-v2-only-enforcement" title="Permanent link">&para;</a></h3>
<p>We treat any “legacy/v1 Shadow-Twin logic” as unsupported in runtime.</p>
<ul>
<li>Config may still contain <code>shadowTwin.mode = legacy|v2</code> for historical libraries.</li>
<li>The runtime does <strong>not</strong> execute legacy heuristics or legacy adoption/cleanup.</li>
<li>UI/Settings provides a safe action: set the config flag to <strong>v2</strong> (no migration).</li>
</ul>
<h3 id="analysis-shadow-twin-v2-only-artifact-locations-storage">Artifact locations (storage)<a class="headerlink" href="#analysis-shadow-twin-v2-only-artifact-locations-storage" title="Permanent link">&para;</a></h3>
<p>Artifacts can live either:
1) inside a <strong>dot-folder</strong> <code>.{originalName}/</code> (recommended when multiple assets exist), or<br />
2) as <strong>siblings</strong> next to the source file (common for “only Markdown” cases).</p>
<p>The resolver checks dot-folder first (if present), then siblings.</p>
<h3 id="analysis-shadow-twin-v2-only-naming-v2">Naming (v2)<a class="headerlink" href="#analysis-shadow-twin-v2-only-naming-v2" title="Permanent link">&para;</a></h3>
<p>Transcript:
- <code>{baseName}.{language}.md</code>
- Example: <code>document.de.md</code></p>
<p>Transformation:
- <code>{baseName}.{templateName}.{language}.md</code>
- Example: <code>document.pdfanalyse.de.md</code></p>
<h3 id="analysis-shadow-twin-v2-only-central-entry-points-code">Central entry points (code)<a class="headerlink" href="#analysis-shadow-twin-v2-only-central-entry-points-code" title="Permanent link">&para;</a></h3>
<p>Resolve:
- <code>src/lib/shadow-twin/artifact-resolver.ts</code> (<code>resolveArtifact</code>)
- <code>src/app/api/library/[libraryId]/artifacts/batch-resolve/route.ts</code></p>
<p>Write:
- <code>src/lib/shadow-twin/artifact-writer.ts</code> (<code>writeArtifact</code>)
- Used by external jobs and creation flows</p>
<h3 id="analysis-shadow-twin-v2-only-known-fixed-issue-processingstatus-in-extract-only">Known fixed issue: processingStatus in extract-only<a class="headerlink" href="#analysis-shadow-twin-v2-only-known-fixed-issue-processingstatus-in-extract-only" title="Permanent link">&para;</a></h3>
<p>Observed issue: <code>shadowTwinState.processingStatus</code> could end up missing for extract-only jobs.<br />
Current behavior: after transcript is saved, extract-only recomputes the Shadow-Twin state and writes <code>processingStatus = 'ready'</code>, plus a final idempotent fallback at job end.</p>
<p>Implementation reference:
- <code>src/lib/external-jobs/extract-only.ts</code></p></section><section class="print-page" id="analysis-wizard-and-jobs" heading-number="3.2"><h1 id="analysis-wizard-and-jobs-analysis-wizard-and-jobs">Wizard & External Jobs</h1><h2 id="wizard-external-jobs-current-runtime">Wizard &amp; External Jobs (current runtime)<a class="headerlink" href="#analysis-wizard-and-jobs-wizard-external-jobs-current-runtime" title="Permanent link">&para;</a></h2>
<p>Status: active<br />
Last verified: 2026-01-04  </p>
<h3 id="analysis-wizard-and-jobs-scope">Scope<a class="headerlink" href="#analysis-wizard-and-jobs-scope" title="Permanent link">&para;</a></h3>
<p>This document explains the <strong>current</strong> PDF wizard and external-jobs pipeline behavior.
It focuses on the runtime contracts that must hold (so the UI does not need “fixups”).</p>
<h3 id="analysis-wizard-and-jobs-glossary">Glossary<a class="headerlink" href="#analysis-wizard-and-jobs-glossary" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>External Job</strong>: a server-side job document orchestrated by worker + routes.</li>
<li><strong>Start route</strong>: <code>POST /api/external/jobs/[jobId]/start</code></li>
<li><strong>Callback route</strong>: <code>POST /api/external/jobs/[jobId]</code> (webhook receiver)</li>
<li><strong>Extract-only</strong>: job runs extraction/transcript creation only.</li>
<li><strong>Template-only</strong>: job runs template transformation only (metadata/frontmatter).</li>
<li><strong>Publish (Wizard)</strong>: human confirms and we write final frontmatter + ingestion.</li>
</ul>
<h3 id="analysis-wizard-and-jobs-why-this-exists-key-principle">Why this exists (key principle)<a class="headerlink" href="#analysis-wizard-and-jobs-why-this-exists-key-principle" title="Permanent link">&para;</a></h3>
<p>The UI must stay simple. It must not repair/guess results.
So we enforce correctness <strong>centrally</strong> in server code and test it end-to-end.</p>
<h2 id="analysis-wizard-and-jobs-pipeline-overview-pdf">Pipeline overview (PDF)<a class="headerlink" href="#analysis-wizard-and-jobs-pipeline-overview-pdf" title="Permanent link">&para;</a></h2>
<p>High level:
- Worker triggers the start route.
- Start route decides which phases to run via gates + policies.
- Secretary Service does OCR/template and calls back.
- Callback route orchestrates the remaining phases and stores artifacts.</p>
<p>Canonical architecture reference:
- <code>docs/architecture/pdf-transformation-phases.md</code></p>
<h2 id="analysis-wizard-and-jobs-contracts-must-always-hold">Contracts (must always hold)<a class="headerlink" href="#analysis-wizard-and-jobs-contracts-must-always-hold" title="Permanent link">&para;</a></h2>
<h3 id="analysis-wizard-and-jobs-contract-1-completed-resultsaveditemid-exists">Contract 1: completed =&gt; result.savedItemId exists<a class="headerlink" href="#analysis-wizard-and-jobs-contract-1-completed-resultsaveditemid-exists" title="Permanent link">&para;</a></h3>
<p>If a job is <code>completed</code>, it must already have a persisted <code>result.savedItemId</code>.
Otherwise polling clients can see <code>completed</code> with empty <code>result</code> (race condition).</p>
<h3 id="analysis-wizard-and-jobs-contract-2-saveditemid-points-to-the-correct-artifact-kind">Contract 2: savedItemId points to the correct artifact kind<a class="headerlink" href="#analysis-wizard-and-jobs-contract-2-saveditemid-points-to-the-correct-artifact-kind" title="Permanent link">&para;</a></h3>
<p>Stronger rule:
- <strong>Template enabled</strong> =&gt; <code>savedItemId</code> must point to the <strong>transformation</strong> artifact (with frontmatter).
- <strong>Extract-only</strong> =&gt; <code>savedItemId</code> must point to the <strong>transcript</strong> artifact.</p>
<p>This is critical because transcript files typically do not have frontmatter.
If <code>savedItemId</code> points to a transcript in a template job, the wizard preview and metadata will appear empty.</p>
<p>Enforcement location:
- <code>src/lib/external-jobs/complete.ts</code> (central contract enforcement)</p>
<h2 id="analysis-wizard-and-jobs-pdfanalyse-publish-contract-no-extra-final-markdown">PDFAnalyse “publish contract” (no extra final markdown)<a class="headerlink" href="#analysis-wizard-and-jobs-pdfanalyse-publish-contract-no-extra-final-markdown" title="Permanent link">&para;</a></h2>
<p>Goal:
- The canonical published document is the <strong>transformation markdown inside the Shadow-Twin</strong>:
  - <code>.{PDF-Name}/{PDF-Stem}.pdfanalyse.{lang}.md</code></p>
<p>Publish behavior:
- Wizard overwrites <strong>that</strong> transformation file’s <strong>frontmatter</strong> (body stays from transformation).
- Wizard triggers ingestion (RAG) for that same file.
- The wizard must <strong>not</strong> create an additional “final” markdown outside the Shadow-Twin.</p>
<h2 id="analysis-wizard-and-jobs-testing-strategy-how-we-catch-regressions">Testing strategy (how we catch regressions)<a class="headerlink" href="#analysis-wizard-and-jobs-testing-strategy-how-we-catch-regressions" title="Permanent link">&para;</a></h2>
<ul>
<li>Integration test validators assert:</li>
<li>completed jobs have <code>result.savedItemId</code></li>
<li><code>savedItemId</code> matches expected artifact kind for the job type</li>
<li>template name matches when template jobs are configured</li>
</ul>
<p>Key files:
- <code>src/lib/integration-tests/validators.ts</code>
- <code>src/lib/integration-tests/test-cases.ts</code>
- <code>src/lib/integration-tests/orchestrator.ts</code></p></section><section class="print-page" id="analysis-audio-jobs-transcript-only" heading-number="3.3"><h1 id="analysis-audio-jobs-transcript-only-analysis-audio-jobs-transcript-only">Audio/Video (no template)</h1><h2 id="audiovideo-jobs-without-template-transcript-only-runtime-decision">Audio/Video jobs without template: transcript-only (runtime decision)<a class="headerlink" href="#analysis-audio-jobs-transcript-only-audiovideo-jobs-without-template-transcript-only-runtime-decision" title="Permanent link">&para;</a></h2>
<p>Status: active<br />
Last verified: 2026-01-06  </p>
<h3 id="analysis-audio-jobs-transcript-only-scope">Scope<a class="headerlink" href="#analysis-audio-jobs-transcript-only-scope" title="Permanent link">&para;</a></h3>
<p>This document captures the runtime contract for <strong>audio/video transcription</strong> when the user does <strong>not</strong> select a template.
It focuses on preventing accidental template runs and “template not found” failures.</p>
<h3 id="analysis-audio-jobs-transcript-only-glossary">Glossary<a class="headerlink" href="#analysis-audio-jobs-transcript-only-glossary" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Transcript-only</strong>: job writes a transcript Markdown and stops (no template, no ingest)</li>
<li><strong>Template phase</strong>: metadata/frontmatter transformation using a template</li>
<li><strong>Ingest phase</strong>: RAG ingestion into MongoDB Vector Search</li>
</ul>
<h2 id="analysis-audio-jobs-transcript-only-problem">Problem<a class="headerlink" href="#analysis-audio-jobs-transcript-only-problem" title="Permanent link">&para;</a></h2>
<p>Users can start audio/video transcription <strong>without selecting a template</strong>.
In that case, the expected behavior is:</p>
<ul>
<li>produce the transcript Markdown (Shadow‑Twin transcript artifact)</li>
<li>do <strong>not</strong> run template transformation</li>
<li>do <strong>not</strong> run ingestion</li>
<li>finish successfully with a meaningful <code>result.savedItemId</code></li>
</ul>
<h2 id="analysis-audio-jobs-transcript-only-decision-contract">Decision (contract)<a class="headerlink" href="#analysis-audio-jobs-transcript-only-decision-contract" title="Permanent link">&para;</a></h2>
<p><strong>If <code>template</code> is missing/empty, audio/video jobs must behave as transcript-only.</strong></p>
<p>That implies:
- <code>policies.metadata = 'ignore'</code>
- <code>policies.ingest = 'ignore'</code>
- final output is the <strong>transcript artifact</strong>, and <code>result.savedItemId</code> must point to that transcript file</p>
<h2 id="analysis-audio-jobs-transcript-only-why">Why<a class="headerlink" href="#analysis-audio-jobs-transcript-only-why" title="Permanent link">&para;</a></h2>
<ul>
<li>It matches explicit user intent (“no template”).</li>
<li>It avoids implicit defaults and prevents <code>template_not_found</code> failures.</li>
<li>It keeps the job semantics deterministic and easy to reason about.</li>
</ul>
<h2 id="analysis-audio-jobs-transcript-only-implementation-notes-where-this-must-be-enforced">Implementation notes (where this must be enforced)<a class="headerlink" href="#analysis-audio-jobs-transcript-only-implementation-notes-where-this-must-be-enforced" title="Permanent link">&para;</a></h2>
<ul>
<li>Start routes must not introduce a default template when the client did not select one.</li>
<li>Callback completion must treat “completed transcription payload” as final and persist <code>savedItemId</code>.</li>
</ul>
<p>Relevant code areas (non-exhaustive):
- <code>src/app/api/secretary/process-audio/job/route.ts</code>
- <code>src/app/api/secretary/process-video/job/route.ts</code>
- <code>src/lib/external-jobs/progress.ts</code>
- <code>src/app/api/external/jobs/[jobId]/route.ts</code></p></section><section class="print-page" id="analysis-ingestion" heading-number="3.4"><h1 id="analysis-ingestion-analysis-ingestion">Ingestion</h1><h2 id="ingestion-current-runtime">Ingestion (current runtime)<a class="headerlink" href="#analysis-ingestion-ingestion-current-runtime" title="Permanent link">&para;</a></h2>
<p>Status: active<br />
Last verified: 2026-01-04  </p>
<h3 id="analysis-ingestion-scope">Scope<a class="headerlink" href="#analysis-ingestion-scope" title="Permanent link">&para;</a></h3>
<p>This document describes how ingestion and vector storage work <strong>today</strong>.
It is meant to be simple and operational (what to look at when something breaks).</p>
<h3 id="analysis-ingestion-glossary">Glossary<a class="headerlink" href="#analysis-ingestion-glossary" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Vector collection</strong>: MongoDB collection <code>vectors__${libraryId}</code></li>
<li><strong>meta</strong>: metadata-only doc (no embedding)</li>
<li><strong>chunk</strong>: text chunk + embedding</li>
<li><strong>chapterSummary</strong>: chapter summary + embedding</li>
</ul>
<h2 id="analysis-ingestion-data-model-mongodb">Data model (MongoDB)<a class="headerlink" href="#analysis-ingestion-data-model-mongodb" title="Permanent link">&para;</a></h2>
<p>We use one collection per library:
- <code>vectors__${libraryId}</code></p>
<p>Kinds:
- <code>meta</code>: used for gallery + facets
- <code>chunk</code>: used for semantic search
- <code>chapterSummary</code>: used for chapter-based search</p>
<p>Canonical architecture reference:
- <code>docs/architecture/mongodb-vector-search.md</code></p>
<h2 id="analysis-ingestion-main-entry-points-code">Main entry points (code)<a class="headerlink" href="#analysis-ingestion-main-entry-points-code" title="Permanent link">&para;</a></h2>
<ul>
<li>Ingestion service: <code>src/lib/chat/ingestion-service.ts</code></li>
<li>Vector repo: <code>src/lib/repositories/vector-repo.ts</code></li>
</ul>
<h2 id="analysis-ingestion-practical-debugging-checklist">Practical debugging checklist<a class="headerlink" href="#analysis-ingestion-practical-debugging-checklist" title="Permanent link">&para;</a></h2>
<p>When ingestion “looks wrong”, check:
1) Does a <code>meta</code> document exist for the fileId?
2) Do <code>chunk</code> documents exist for the same fileId?
3) Does <code>vector_search_idx</code> exist for the collection?
4) Are facet fields present on chunks (so filters work)?</p>
<h2 id="analysis-ingestion-common-failure-modes-what-it-usually-is">Common failure modes (what it usually is)<a class="headerlink" href="#analysis-ingestion-common-failure-modes-what-it-usually-is" title="Permanent link">&para;</a></h2>
<h3 id="analysis-ingestion-1-ingestion-input-is-empty-too-short">1) Ingestion input is empty / too short<a class="headerlink" href="#analysis-ingestion-1-ingestion-input-is-empty-too-short" title="Permanent link">&para;</a></h3>
<p>Symptoms:</p>
<ul>
<li><code>ingest_rag</code> fails early</li>
<li>ingestion appears “successful” but results in 0 useful chunks</li>
</ul>
<p>Typical causes:</p>
<ul>
<li>upstream artifact (transformation/transcript) is empty</li>
<li>wrong artifact selected (e.g. missing/incorrect template context)</li>
</ul>
<p>Fix direction:</p>
<ul>
<li>treat empty ingestion input as a hard error (pipeline must not mark success)</li>
<li>verify transformation output first (frontmatter + body)</li>
</ul>
<h3 id="analysis-ingestion-2-vector-search-index-not-ready-initial_sync">2) Vector Search index not READY (INITIAL_SYNC)<a class="headerlink" href="#analysis-ingestion-2-vector-search-index-not-ready-initial_sync" title="Permanent link">&para;</a></h3>
<p>Symptoms:</p>
<ul>
<li>retrieval fails even though docs were upserted</li>
<li>errors or very slow/no results right after index creation</li>
</ul>
<p>Fix direction:</p>
<ul>
<li>check index status in Atlas; INITIAL_SYNC can take minutes depending on size</li>
</ul>
<h3 id="analysis-ingestion-3-token-index-missing-for-array-filters">3) Token-index missing for array filters<a class="headerlink" href="#analysis-ingestion-3-token-index-missing-for-array-filters" title="Permanent link">&para;</a></h3>
<p>Symptoms:</p>
<ul>
<li>errors like: “Path 'authors' needs to be indexed as token”</li>
<li>filters work for scalar fields but break for array fields (authors/tags/topics/…)</li>
</ul>
<p>Fix direction:</p>
<ul>
<li>update the Atlas Search index definition (token indexing for array fields you filter on)</li>
<li>rebuild/recreate index if needed</li>
</ul>
<h3 id="analysis-ingestion-4-wrong-fileid-used-for-upserts-mismatched-namespaces">4) Wrong <code>fileId</code> used for upserts (mismatched namespaces)<a class="headerlink" href="#analysis-ingestion-4-wrong-fileid-used-for-upserts-mismatched-namespaces" title="Permanent link">&para;</a></h3>
<p>Symptoms:</p>
<ul>
<li>meta doc exists for a different id than the file you query</li>
<li>ingestion-status says “not indexed” although ingestion ran</li>
</ul>
<p>Fix direction:</p>
<ul>
<li>ensure <code>fileId</code> used for vector upserts matches the source fileId used by the UI</li>
</ul>
<h2 id="analysis-ingestion-operational-probes-fast-checks">Operational probes (fast checks)<a class="headerlink" href="#analysis-ingestion-operational-probes-fast-checks" title="Permanent link">&para;</a></h2>
<h3 id="analysis-ingestion-a-ingestion-status-endpoint-ui-friendly">A) Ingestion status endpoint (UI-friendly)<a class="headerlink" href="#analysis-ingestion-a-ingestion-status-endpoint-ui-friendly" title="Permanent link">&para;</a></h3>
<p>Use:</p>
<ul>
<li><code>GET /api/chat/{libraryId}/ingestion-status?fileId=...</code></li>
</ul>
<p>What to look for:</p>
<ul>
<li><code>doc.exists=true</code></li>
<li>reasonable <code>chunkCount</code> and <code>chaptersCount</code></li>
<li>staleness (docModifiedAt vs stored docModifiedAt)</li>
</ul>
<h3 id="analysis-ingestion-b-retrieval-sanity-check-chat-stream">B) Retrieval sanity check (chat stream)<a class="headerlink" href="#analysis-ingestion-b-retrieval-sanity-check-chat-stream" title="Permanent link">&para;</a></h3>
<p>Use:</p>
<ul>
<li><code>POST /api/chat/{libraryId}/stream</code></li>
</ul>
<p>What to look for:</p>
<ul>
<li>retriever selection (chunk vs summary)</li>
<li>retrieval steps returning sources (non-empty)</li>
</ul>
<h2 id="analysis-ingestion-related-docs">Related docs<a class="headerlink" href="#analysis-ingestion-related-docs" title="Permanent link">&para;</a></h2>
<ul>
<li>End-to-end overview: <code>docs/use-cases/file-to-story.md</code></li>
<li>Vector architecture: <code>docs/architecture/mongodb-vector-search.md</code></li>
</ul></section><section class="print-page" id="analysis-storage" heading-number="3.5"><h1 id="analysis-storage-analysis-storage">Storage</h1><h2 id="storage-current-runtime">Storage (current runtime)<a class="headerlink" href="#analysis-storage-storage-current-runtime" title="Permanent link">&para;</a></h2>
<p>Status: active<br />
Last verified: 2026-01-04  </p>
<h3 id="analysis-storage-scope">Scope<a class="headerlink" href="#analysis-storage-scope" title="Permanent link">&para;</a></h3>
<p>This document explains how storage providers behave in this project and which errors are common.</p>
<h3 id="analysis-storage-glossary">Glossary<a class="headerlink" href="#analysis-storage-glossary" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Provider</strong>: a backend adapter (filesystem, OneDrive, ...)</li>
<li><strong>itemId</strong>: provider-specific identifier for a file/folder</li>
<li><strong>parentId</strong>: folder itemId that contains the item</li>
</ul>
<h2 id="analysis-storage-providers">Providers<a class="headerlink" href="#analysis-storage-providers" title="Permanent link">&para;</a></h2>
<p>This codebase supports multiple providers (examples):
- local filesystem
- OneDrive (Microsoft Graph)</p>
<p>Provider types live under:
- <code>src/lib/storage/*</code></p>
<h2 id="analysis-storage-common-issue-fileidundefined-requests-filesystem">Common issue: <code>fileId=undefined</code> requests (filesystem)<a class="headerlink" href="#analysis-storage-common-issue-fileidundefined-requests-filesystem" title="Permanent link">&para;</a></h2>
<p>Symptom:
- after upload, a list request is made with <code>fileId=undefined</code>, leading to ENOENT/404.</p>
<p>Root cause (typical):
- caller calls <code>refreshItems()</code> without a folder id, so the URL contains <code>undefined</code>.</p>
<p>Fix strategy:
- fix the caller to always pass a folder id (or default to <code>root</code>)
- optionally harden server parsing to treat <code>"undefined"|"null"|""</code> as <code>root</code> (safety net)</p>
<h2 id="analysis-storage-related-reference-docs">Related reference docs<a class="headerlink" href="#analysis-storage-related-reference-docs" title="Permanent link">&para;</a></h2>
<ul>
<li><code>docs/reference/modules/storage.md</code></li>
</ul></section><section class="print-page" id="analysis-markdown-page-splitting" heading-number="3.6"><h1 id="analysis-markdown-page-splitting-markdown-page-splitting-for-pdf-measures">Markdown Page Splitting for PDF Measures<a class="headerlink" href="#analysis-markdown-page-splitting-markdown-page-splitting-for-pdf-measures" title="Permanent link">&para;</a></h1>
<h2 id="analysis-markdown-page-splitting-context">Context<a class="headerlink" href="#analysis-markdown-page-splitting-context" title="Permanent link">&para;</a></h2>
<p>We need one document per PDF page (each page represents a single measure). The current PDF pipeline already inserts explicit page markers in the transcript markdown (<code>--- Seite N ---</code>). These markers are reliable enough for deterministic splitting without re-running OCR.</p>
<h2 id="analysis-markdown-page-splitting-options-considered">Options Considered<a class="headerlink" href="#analysis-markdown-page-splitting-options-considered" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Split transcript markdown into per-page files, then transform per file.</strong><br />
  Low risk and minimal new logic, but requires a per-file transform mode to avoid combined output.</li>
<li><strong>Create one external job per page.</strong><br />
  Accurate but creates high orchestration overhead.</li>
<li><strong>Re-OCR page images.</strong><br />
  Expensive and unnecessary because transcript markers already exist.</li>
</ul>
<h2 id="analysis-markdown-page-splitting-decision">Decision<a class="headerlink" href="#analysis-markdown-page-splitting-decision" title="Permanent link">&para;</a></h2>
<p>Implement a <strong>page splitter</strong> that turns transcript markdown into <code>page-XXX.md</code> files inside a folder named after the source file. Then extend batch transformation with a <strong>per-file mode</strong> so each page gets its own template output.</p>
<h2 id="analysis-markdown-page-splitting-risks-mitigations">Risks &amp; Mitigations<a class="headerlink" href="#analysis-markdown-page-splitting-risks-mitigations" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Missing or malformed page markers</strong> → return a clear error and avoid partial output.</li>
<li><strong>Unsafe folder names</strong> → sanitize source file name to a filesystem-safe folder name.</li>
<li><strong>Output collisions</strong> → use deterministic <code>page-XXX</code> names and template-specific output names.</li>
</ul>
<h2 id="analysis-markdown-page-splitting-validation-plan">Validation Plan<a class="headerlink" href="#analysis-markdown-page-splitting-validation-plan" title="Permanent link">&para;</a></h2>
<ul>
<li>Unit test for page splitting using real marker format.</li>
<li>Manual test: split a PDF transcript and confirm 1 file per page.</li>
<li>Batch test: per-file transform yields one output document per page.</li>
</ul></section></section>
                    <section class='print-page md-section' id='section-4' heading-number='4'>
                        <h1>Use Cases<a class='headerlink' href='#section-4' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="use-cases-index" heading-number="4.1"><h1 id="use-cases-index-use-cases">Use Cases<a class="headerlink" href="#use-cases-index-use-cases" title="Permanent link">&para;</a></h1>
<p>Short guides for common tasks in Common Knowledge Scout.</p>
<h2 id="use-cases-index-basic-use-cases">Basic Use Cases<a class="headerlink" href="#use-cases-index-basic-use-cases" title="Permanent link">&para;</a></h2>
<ul>
<li><strong><a href="#use-cases-library-setup">Library Setup</a></strong> – Create and configure a library</li>
<li><strong><a href="#use-cases-file-transformation-pdf">PDF Transformation</a></strong> – Transform PDF files to Markdown</li>
<li><strong><a href="#use-cases-file-transformation-media">Media Transformation</a></strong> – Transcribe audio and video files</li>
</ul>
<h2 id="use-cases-index-advanced-use-cases">Advanced Use Cases<a class="headerlink" href="#use-cases-index-advanced-use-cases" title="Permanent link">&para;</a></h2>
<ul>
<li><strong><a href="#use-cases-web-scraping">Web Scraping</a></strong> – Scrape web content and import events</li>
<li><strong><a href="#use-cases-publishing">Publishing</a></strong> – Publish library publicly</li>
<li><strong><a href="#use-cases-chat-exploration">Chat &amp; Story Mode</a></strong> – Explore knowledge with chat</li>
</ul>
<h2 id="use-cases-index-advanced-features">Advanced Features<a class="headerlink" href="#use-cases-index-advanced-features" title="Permanent link">&para;</a></h2>
<ul>
<li><strong><a href="#use-cases-batch-operations">Batch Operations</a></strong> – Process multiple files simultaneously</li>
</ul>
<h2 id="use-cases-index-further-information">Further Information<a class="headerlink" href="#use-cases-index-further-information" title="Permanent link">&para;</a></h2>
<p>For detailed technical information see:
- <a href="#architecture">Architecture Documentation</a>
- <a href="#reference">Reference Documentation</a>
- <a href="#concepts">Concepts Documentation</a></p></section><section class="print-page" id="use-cases-library-setup" heading-number="4.2"><h1 id="use-cases-library-setup-library-setup">Library Setup<a class="headerlink" href="#use-cases-library-setup-library-setup" title="Permanent link">&para;</a></h1>
<h2 id="use-cases-library-setup-what-is-achieved">What is achieved?<a class="headerlink" href="#use-cases-library-setup-what-is-achieved" title="Permanent link">&para;</a></h2>
<p>Create a new library to organize your knowledge. Libraries serve as containers for documents, media files, and transformed content.</p>
<h2 id="use-cases-library-setup-prerequisites">Prerequisites<a class="headerlink" href="#use-cases-library-setup-prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Authenticated user</li>
<li>Access to storage provider (Local Filesystem or OneDrive)</li>
</ul>
<h2 id="use-cases-library-setup-steps">Steps<a class="headerlink" href="#use-cases-library-setup-steps" title="Permanent link">&para;</a></h2>
<ol>
<li>Go to <strong>Settings → Library</strong></li>
<li>Click <strong>"Create New Library"</strong> (if no library exists yet)</li>
<li>Fill out the form:</li>
<li><strong>Name</strong>: Enter a meaningful name (at least 3 characters)</li>
<li><strong>Storage Type</strong>: Choose between "Local" (local filesystem) or "OneDrive"</li>
<li><strong>Storage Path</strong>: Enter the path where files should be stored</li>
<li><strong>Description</strong> (optional): Short description of the library</li>
<li>Configure the transcription strategy:</li>
<li><strong>Shadow Twin</strong>: Transformed files are saved as separate Markdown files</li>
<li><strong>Database</strong>: Transcripts are stored in the database</li>
<li>Click <strong>"Save"</strong></li>
</ol>
<h2 id="use-cases-library-setup-result">Result<a class="headerlink" href="#use-cases-library-setup-result" title="Permanent link">&para;</a></h2>
<p>A new library is created and can be used for files. The library appears in the Library Switcher and can be selected as the active library.</p>
<h2 id="use-cases-library-setup-further-information">Further Information<a class="headerlink" href="#use-cases-library-setup-further-information" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#reference-modules-library">Library Module Documentation</a></li>
<li><a href="#reference-modules-storage">Storage Provider Concepts</a></li>
</ul></section><section class="print-page" id="use-cases-file-transformation-pdf" heading-number="4.3"><h1 id="use-cases-file-transformation-pdf-pdf-transformation">PDF Transformation<a class="headerlink" href="#use-cases-file-transformation-pdf-pdf-transformation" title="Permanent link">&para;</a></h1>
<h2 id="use-cases-file-transformation-pdf-what-is-achieved">What is achieved?<a class="headerlink" href="#use-cases-file-transformation-pdf-what-is-achieved" title="Permanent link">&para;</a></h2>
<p>Transform PDF files into structured Markdown documents. Text, images, and structure are extracted and saved as searchable Markdown files. The transformation process consists of three phases: <strong>Extract</strong>, <strong>Template/Metadata</strong>, and <strong>Ingestion</strong>.</p>
<h2 id="use-cases-file-transformation-pdf-prerequisites">Prerequisites<a class="headerlink" href="#use-cases-file-transformation-pdf-prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Active library selected</li>
<li>PDF file available in Library Browser</li>
</ul>
<h2 id="use-cases-file-transformation-pdf-steps">Steps<a class="headerlink" href="#use-cases-file-transformation-pdf-steps" title="Permanent link">&para;</a></h2>
<ol>
<li>Open the <strong>Library</strong> view</li>
<li>Navigate to the folder containing the PDF file</li>
<li>Select the PDF file (single file or multiple for batch processing)</li>
<li>Click the <strong>Transformation icon</strong> or use the context menu</li>
<li>In the transformation dialog:</li>
<li>Select the <strong>target language</strong> for transformation</li>
<li>Optional: Choose a <strong>template</strong> for structured output</li>
<li>Optional: Enable <strong>"Extract OCR images"</strong> for Mistral OCR extracted images</li>
<li>Optional: Enable <strong>"Extract page images"</strong> for PDF pages as images</li>
<li>Click <strong>"Start Transformation"</strong></li>
<li>Monitor progress in the dialog (three phases: Extract → Template → Ingestion)</li>
<li>After completion: The transformed Markdown files (Shadow Twins) appear next to the original</li>
</ol>
<h2 id="use-cases-file-transformation-pdf-transformation-execution-modes">Transformation Execution Modes<a class="headerlink" href="#use-cases-file-transformation-pdf-transformation-execution-modes" title="Permanent link">&para;</a></h2>
<p>The transformation can run in two modes:</p>
<h3 id="use-cases-file-transformation-pdf-asynchronous-mode-default">Asynchronous Mode (Default)<a class="headerlink" href="#use-cases-file-transformation-pdf-asynchronous-mode-default" title="Permanent link">&para;</a></h3>
<ul>
<li>Used for larger files or when processing requires time</li>
<li>Creates a background job that processes the PDF in three sequential phases</li>
<li>Results are delivered via webhooks</li>
<li><strong>Creates two separate files</strong>: Transcript (<code>document.md</code>) and Transformed (<code>document.de.md</code>)</li>
</ul>
<h3 id="use-cases-file-transformation-pdf-synchronous-mode-legacycache">Synchronous Mode (Legacy/Cache)<a class="headerlink" href="#use-cases-file-transformation-pdf-synchronous-mode-legacycache" title="Permanent link">&para;</a></h3>
<ul>
<li>Used for small files or when results are cached</li>
<li>Returns results immediately in the API response</li>
<li><strong>Creates only one file</strong>: Transformed (<code>document.de.md</code>) with frontmatter</li>
<li>No separate transcript file is created</li>
</ul>
<p><strong>Note</strong>: The mode is automatically selected based on file size and cache availability. Most transformations use the asynchronous mode.</p>
<h2 id="use-cases-file-transformation-pdf-transformation-phases">Transformation Phases<a class="headerlink" href="#use-cases-file-transformation-pdf-transformation-phases" title="Permanent link">&para;</a></h2>
<p>The three phases are executed sequentially in <strong>asynchronous mode</strong>. In <strong>synchronous mode</strong>, phases 1 and 2 are combined into a single operation.</p>
<h3 id="use-cases-file-transformation-pdf-phase-1-extract-extraction">Phase 1: Extract (Extraction)<a class="headerlink" href="#use-cases-file-transformation-pdf-phase-1-extract-extraction" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>What happens</strong>: PDF → Text + Images extraction</li>
<li><strong>Output</strong> (async mode): Markdown file without frontmatter (<code>document.md</code> - Transcript)</li>
<li><strong>Output</strong> (sync mode): Directly proceeds to Phase 2, no separate transcript file</li>
<li><strong>Images</strong>: Extracted as ZIP archives or Base64 (Mistral OCR)</li>
<li><strong>Shadow-Twin Directory</strong>: Created automatically if images are present (<code>.document.pdf/</code>)</li>
</ul>
<h3 id="use-cases-file-transformation-pdf-phase-2-templatemetadata">Phase 2: Template/Metadata<a class="headerlink" href="#use-cases-file-transformation-pdf-phase-2-templatemetadata" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>What happens</strong>: Frontmatter is added and the document is structured (chapters, topics, etc.).</li>
<li><strong>Input</strong> (async mode): Markdown without frontmatter (<code>document.md</code>)</li>
<li><strong>Input</strong> (sync mode): Extracted text directly from Phase 1</li>
<li><strong>Output</strong>: Markdown with frontmatter (<code>document.de.md</code> - Transformed)</li>
<li><strong>Automatic skipping</strong>:</li>
<li>If the document already has chapter metadata (<code>chapters</code> in frontmatter), the template phase is skipped.</li>
<li>If only <code>pages</code> are missing, they are automatically reconstructed from the <code>--- Seite N ---</code> markers in the body (no extra analysis needed).</li>
</ul>
<h4 id="use-cases-file-transformation-pdf-how-metadata-is-extracted-via-templates">How Metadata is Extracted via Templates<a class="headerlink" href="#use-cases-file-transformation-pdf-how-metadata-is-extracted-via-templates" title="Permanent link">&para;</a></h4>
<p>The template phase uses <strong>LLM-based extraction</strong> to analyze the document content and extract structured metadata:</p>
<ol>
<li><strong>Template Selection</strong>:</li>
<li>
<p>Template is selected from MongoDB based on:</p>
<ul>
<li>Job parameters (<code>job.parameters.template</code>)</li>
<li>Library configuration (<code>library.config.secretaryService.pdfDefaults.template</code>)</li>
<li>Fallback to default templates if none specified</li>
</ul>
</li>
<li>
<p><strong>Template Structure</strong>:</p>
</li>
<li>Templates contain:<ul>
<li><strong>Frontmatter Schema</strong>: Defines metadata fields with placeholders like <code>{{title|Description}}</code></li>
<li><strong>System Prompt</strong>: Instructions for the LLM on how to extract and structure data</li>
<li><strong>Markdown Body</strong>: Optional template structure for the output</li>
</ul>
</li>
</ol>
<p>Example template field:
   <div class="highlight"><pre><span></span><code><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">title|Vollständiger Titel des Dokuments (extraktiv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">aus Heading/Frontseite)</span><span class="p p-Indicator">}}</span>
<span class="nt">chapters</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">chapters|Array von Kapiteln mit title</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">level (1–3)</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">order</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">startPage</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">endPage</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pageCount</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">summary</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">keywords</span><span class="p p-Indicator">}}</span>
</code></pre></div></p>
<ol>
<li><strong>LLM Processing</strong>:</li>
<li>The extracted text (from Phase 1) and template content are sent to the <strong>Secretary Service</strong> (<code>/transformer/template</code> endpoint)</li>
<li>The LLM analyzes the document content according to the system prompt</li>
<li>The LLM extracts metadata fields defined in the template frontmatter</li>
<li>
<p>Returns structured JSON with all metadata fields</p>
</li>
<li>
<p><strong>Metadata Sources</strong> (as defined in template system prompts):</p>
</li>
<li><strong>Document content</strong>: Headings, text, TOC, metadata sections</li>
<li><strong>Filename</strong>: Parsed for author, year, title, topic, source, issue, status</li>
<li><strong>Directory path</strong>: Extracted for document type, series/journal, project, region</li>
<li>
<p><strong>Acronym mapping</strong>: Resolves abbreviations from filename/path/document</p>
</li>
<li>
<p><strong>Response Processing</strong>:</p>
</li>
<li>The Secretary Service returns <code>structured_data</code> as JSON</li>
<li>This JSON is normalized and converted to YAML frontmatter</li>
<li>
<p>Fields are validated and cleaned (e.g., <code>shortTitle</code> max 40 chars, slug normalization)</p>
</li>
<li>
<p><strong>Chapter Analysis</strong> (if chapters missing after template):</p>
</li>
<li>If the template didn't extract chapters, an additional analysis step runs</li>
<li>Calls internal <code>/api/chat/{libraryId}/analyze-chapters</code> endpoint</li>
<li>Merges detected chapters with any existing chapters</li>
<li>
<p>Extracts page numbers from <code>--- Seite N ---</code> markers in the text</p>
</li>
<li>
<p><strong>Pages Reconstruction</strong>:</p>
</li>
<li><strong>Important</strong>: The <code>pages</code> field is <strong>never</strong> computed by the template/LLM</li>
<li>Always reconstructed from <code>--- Seite N ---</code> markers in the Markdown body</li>
<li>Extracts the highest page number found in the document</li>
</ol>
<p><strong>Example Flow</strong>:
<div class="highlight"><pre><span></span><code>Extracted Text (Phase 1)
    ↓
Template Content (from MongoDB)
    ↓
Secretary Service /transformer/template
    ↓ (LLM analyzes text + template instructions)
Structured JSON Response
    ↓ (normalize &amp; validate)
YAML Frontmatter
    ↓ (merge with existing metadata)
Final Markdown with Frontmatter
</code></pre></div></p>
<h3 id="use-cases-file-transformation-pdf-phase-3-ingestion-rag">Phase 3: Ingestion (RAG)<a class="headerlink" href="#use-cases-file-transformation-pdf-phase-3-ingestion-rag" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>What happens</strong>: Markdown → Vector storage, MongoDB</li>
<li><strong>Images</strong>: Uploaded to Azure Storage for frontend access</li>
<li><strong>Result</strong>: Document is searchable via RAG (Retrieval Augmented Generation)</li>
<li><strong>Note</strong>: Only executed in <strong>asynchronous mode</strong>. In synchronous mode, ingestion must be triggered separately if needed.</li>
<li><strong>Note</strong>: Only executed in <strong>asynchronous mode</strong>. In synchronous mode, ingestion must be triggered separately if needed.</li>
</ul>
<h2 id="use-cases-file-transformation-pdf-result-structure">Result Structure<a class="headerlink" href="#use-cases-file-transformation-pdf-result-structure" title="Permanent link">&para;</a></h2>
<p>The structure depends on whether images are extracted and which execution mode was used:</p>
<h3 id="use-cases-file-transformation-pdf-shadow-twin-directory-when-images-are-present">Shadow-Twin Directory (when images are present)<a class="headerlink" href="#use-cases-file-transformation-pdf-shadow-twin-directory-when-images-are-present" title="Permanent link">&para;</a></h3>
<p>If images are extracted, a Shadow-Twin directory is created:</p>
<p><strong>Asynchronous mode</strong> (two files):
<div class="highlight"><pre><span></span><code>.document.pdf/
├── document.md          (Transcript - Phase 1 output, no frontmatter)
├── document.de.md       (Transformed - Phase 2 output, with frontmatter)
├── page-001.png        (Extracted images)
├── page-002.png
└── ...
</code></pre></div></p>
<p><strong>Synchronous mode</strong> (one file):
<div class="highlight"><pre><span></span><code>.document.pdf/
├── document.de.md       (Transformed - Phase 1+2 combined output, with frontmatter)
├── page-001.png        (Extracted images)
├── page-002.png
└── ...
</code></pre></div></p>
<h3 id="use-cases-file-transformation-pdf-shadow-twin-files-when-no-images">Shadow-Twin Files (when no images)<a class="headerlink" href="#use-cases-file-transformation-pdf-shadow-twin-files-when-no-images" title="Permanent link">&para;</a></h3>
<p>If no images are extracted, files are saved directly next to the PDF:</p>
<p><strong>Asynchronous mode</strong> (two files):
<div class="highlight"><pre><span></span><code>document.pdf
document.md          (Transcript - Phase 1 output, no frontmatter)
document.de.md       (Transformed - Phase 2 output, with frontmatter)
</code></pre></div></p>
<p><strong>Synchronous mode</strong> (one file):
<div class="highlight"><pre><span></span><code>document.pdf
document.de.md       (Transformed - Phase 1+2 combined output, with frontmatter)
</code></pre></div></p>
<p>For more detailed information about the Shadow-Twin structure, see the <strong>Shadow-Twin Architecture Documentation</strong>.</p>
<h2 id="use-cases-file-transformation-pdf-file-naming-convention">File Naming Convention<a class="headerlink" href="#use-cases-file-transformation-pdf-file-naming-convention" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Transcript File</strong> (<code>document.md</code>): </li>
<li>Created after Phase 1 (Extract) in <strong>asynchronous mode only</strong></li>
<li>Contains extracted text without frontmatter</li>
<li><strong>No language suffix</strong> (original language of source)</li>
<li>
<p><strong>Not created in synchronous mode</strong> (phases are combined)</p>
</li>
<li>
<p><strong>Transformed File</strong> (<code>document.de.md</code>):</p>
</li>
<li>Created after Phase 2 (Template) in <strong>asynchronous mode</strong></li>
<li>Created after Phase 1+2 (combined) in <strong>synchronous mode</strong></li>
<li>Contains text with frontmatter and metadata</li>
<li><strong>With language suffix</strong> (target language for transformation)</li>
</ul>
<h2 id="use-cases-file-transformation-pdf-parameters">Parameters<a class="headerlink" href="#use-cases-file-transformation-pdf-parameters" title="Permanent link">&para;</a></h2>
<ul>
<li><strong><code>includeOcrImages</code></strong>: Request Mistral OCR images as Base64 (default: <code>true</code> for Mistral OCR)</li>
<li><strong><code>includePageImages</code></strong>: Extract PDF pages as images and return as ZIP archive (default: <code>true</code> for Mistral OCR)</li>
</ul>
<h2 id="use-cases-file-transformation-pdf-tips">Tips<a class="headerlink" href="#use-cases-file-transformation-pdf-tips" title="Permanent link">&para;</a></h2>
<ul>
<li>Shadow Twins are automatically linked with the original</li>
<li>Transformation runs in the background - you can continue working</li>
<li>Errors are displayed in an error message</li>
<li>Both transcript and transformed files can coexist (different names)</li>
<li>Shadow-Twin directory is hidden (starts with <code>.</code>)</li>
</ul>
<h2 id="use-cases-file-transformation-pdf-further-information">Further Information<a class="headerlink" href="#use-cases-file-transformation-pdf-further-information" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#architecture-shadow-twin">Shadow-Twin Architecture Documentation</a></li>
<li><a href="#architecture-pdf-transformation-phases">PDF Transformation Phases</a></li>
<li><a href="#reference-file-index-transform--processing">Transform Service Documentation</a></li>
<li><a href="#use-cases-batch-operations">Batch Operations</a> for multiple files</li>
</ul></section><section class="print-page" id="use-cases-file-transformation-media" heading-number="4.4"><h1 id="use-cases-file-transformation-media-media-transformation-audiovideo">Media Transformation (Audio/Video)<a class="headerlink" href="#use-cases-file-transformation-media-media-transformation-audiovideo" title="Permanent link">&para;</a></h1>
<h2 id="use-cases-file-transformation-media-what-is-achieved">What is achieved?<a class="headerlink" href="#use-cases-file-transformation-media-what-is-achieved" title="Permanent link">&para;</a></h2>
<p>Transcribe audio and video files to text. Extract transcripts with speaker identification and save them as searchable Markdown files.</p>
<h2 id="use-cases-file-transformation-media-prerequisites">Prerequisites<a class="headerlink" href="#use-cases-file-transformation-media-prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Active library selected</li>
<li>Audio or video file available in Library Browser</li>
</ul>
<h2 id="use-cases-file-transformation-media-steps">Steps<a class="headerlink" href="#use-cases-file-transformation-media-steps" title="Permanent link">&para;</a></h2>
<ol>
<li>Open the <strong>Library</strong> view</li>
<li>Navigate to the folder containing the audio/video file</li>
<li>Select the media file (single file or multiple for batch processing)</li>
<li>Click the <strong>Transcription icon</strong> or use the context menu</li>
<li>In the transcription dialog:</li>
<li>Select the <strong>target language</strong> for transcription</li>
<li>Optional: Choose a <strong>template</strong> for structured output</li>
<li>Click <strong>"Start Transcription"</strong></li>
<li>Monitor progress in the dialog</li>
<li>After completion: The transcript Markdown file appears next to the original</li>
</ol>
<h2 id="use-cases-file-transformation-media-result">Result<a class="headerlink" href="#use-cases-file-transformation-media-result" title="Permanent link">&para;</a></h2>
<p>A new Markdown file named <code>[OriginalName].md</code> is created. It contains the transcribed text, speaker identification (if available), and metadata in frontmatter.</p>
<h2 id="use-cases-file-transformation-media-tips">Tips<a class="headerlink" href="#use-cases-file-transformation-media-tips" title="Permanent link">&para;</a></h2>
<ul>
<li>Transcription runs in the background - you can continue working</li>
<li>For video files, transcripts can be extracted from VTT files if available</li>
<li>Errors are displayed in an error message</li>
<li>Batch processing is supported for multiple files</li>
</ul>
<h2 id="use-cases-file-transformation-media-further-information">Further Information<a class="headerlink" href="#use-cases-file-transformation-media-further-information" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#reference-file-index-transform--processing">Transform Service Documentation</a></li>
<li><a href="#use-cases-batch-operations">Batch Operations</a> for multiple files</li>
</ul></section><section class="print-page" id="use-cases-file-to-story" heading-number="4.5"><h1 id="use-cases-file-to-story-use-cases-file-to-story">File → Story (End-to-End)</h1><h2 id="file-story-askable-end-to-end">File → Story → Askable (End-to-End)<a class="headerlink" href="#use-cases-file-to-story-file-story-askable-end-to-end" title="Permanent link">&para;</a></h2>
<h3 id="use-cases-file-to-story-1-goal-from-file-story-askable">1) Goal: “From file → story → askable”<a class="headerlink" href="#use-cases-file-to-story-1-goal-from-file-story-askable" title="Permanent link">&para;</a></h3>
<p>This page explains the <strong>end-to-end path</strong> of a file (PDF / audio / video / markdown) through:</p>
<ul>
<li><strong>Shadow‑Twin</strong> (transcript + transformation artifacts)</li>
<li><strong>Ingestion</strong> (MongoDB Vector Search: meta + chunks)</li>
<li><strong>Explorer / Chat</strong> (story UI + RAG Q&amp;A)</li>
</ul>
<p>It is designed as an <strong>operational overview</strong> and links to the deeper architecture docs where needed.</p>
<h3 id="use-cases-file-to-story-2-terms-quick-glossary">2) Terms (quick glossary)<a class="headerlink" href="#use-cases-file-to-story-2-terms-quick-glossary" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Source</strong>: the original file in a library (PDF/audio/video/markdown).</li>
<li><strong>Shadow‑Twin</strong>: derived artifacts for a source (markdown artifacts + binary fragments).</li>
<li><strong>Transcript</strong>: extracted text as markdown (often minimal frontmatter).</li>
<li><strong>Transformation</strong>: template-based markdown with frontmatter/metadata (structured “story input”).</li>
<li><strong>Ingestion</strong>: converting transformation/transcript into:</li>
<li><strong>meta doc</strong> (for gallery/explorer + facets)</li>
<li><strong>chunk docs</strong> (for semantic retrieval)</li>
<li><strong>MetaDoc</strong>: the per-document “metadata record” stored in the vector collection (<code>kind: 'meta'</code>).</li>
<li><strong>Chunk</strong>: a text segment with an embedding (<code>kind: 'chunk'</code>).</li>
</ul>
<h3 id="use-cases-file-to-story-3-end-to-end-flow-numbered">3) End-to-end flow (numbered)<a class="headerlink" href="#use-cases-file-to-story-3-end-to-end-flow-numbered" title="Permanent link">&para;</a></h3>
<h4 id="use-cases-file-to-story-step-0-the-file-exists-in-a-library-storage-provider">Step 0 — The file exists in a Library (Storage Provider)<a class="headerlink" href="#use-cases-file-to-story-step-0-the-file-exists-in-a-library-storage-provider" title="Permanent link">&para;</a></h4>
<p>The source file lives in your library storage (filesystem / OneDrive / … via a provider abstraction).</p>
<h4 id="use-cases-file-to-story-step-1-start-a-pipeline-job-unified-endpoint">Step 1 — Start a pipeline job (Unified endpoint)<a class="headerlink" href="#use-cases-file-to-story-step-1-start-a-pipeline-job-unified-endpoint" title="Permanent link">&para;</a></h4>
<p>You trigger processing via the unified endpoint:</p>
<ul>
<li><code>POST /api/pipeline/process</code></li>
</ul>
<p>This creates an <strong>External Job</strong> with steps:</p>
<ul>
<li><code>extract_*</code> (pdf/audio/video)</li>
<li><code>transform_template</code></li>
<li><code>ingest_rag</code></li>
</ul>
<p>Reference: <code>docs/architecture/pipeline-phases.md</code></p>
<h4 id="use-cases-file-to-story-step-2-job-start-load-source-binary-analyze-shadowtwin">Step 2 — Job start: load source binary + analyze Shadow‑Twin<a class="headerlink" href="#use-cases-file-to-story-step-2-job-start-load-source-binary-analyze-shadowtwin" title="Permanent link">&para;</a></h4>
<p>The worker starts the job:</p>
<ul>
<li>loads source bytes from the provider (<code>getBinary</code>)</li>
<li>analyzes existing Shadow‑Twin state (so gates can skip redundant work)</li>
</ul>
<h4 id="use-cases-file-to-story-step-3-extract-transcribeocr-transcript-artifact">Step 3 — Extract (transcribe/OCR) → Transcript artifact<a class="headerlink" href="#use-cases-file-to-story-step-3-extract-transcribeocr-transcript-artifact" title="Permanent link">&para;</a></h4>
<p>For PDFs/audio/video, phase 1 creates a <strong>transcript</strong> artifact (markdown).</p>
<p>For markdown sources, “extract” is effectively skipped: the source is already text.</p>
<h4 id="use-cases-file-to-story-step-4-transform-template-transformation-artifact-story-ready-markdown">Step 4 — Transform (template) → Transformation artifact (story-ready markdown)<a class="headerlink" href="#use-cases-file-to-story-step-4-transform-template-transformation-artifact-story-ready-markdown" title="Permanent link">&para;</a></h4>
<p>Template transformation generates the “story-ready” markdown:</p>
<ul>
<li>validated/extended frontmatter</li>
<li>chapters / summary / teaser / facets, etc.</li>
</ul>
<p>This is the best ingestion input because it includes structured metadata.</p>
<p>Reference: <code>docs/architecture/shadow-twin.md</code>, <code>docs/architecture/template-system.md</code></p>
<h4 id="use-cases-file-to-story-step-5-ingest-rag-mongodb-vector-search-meta-chunks">Step 5 — Ingest (RAG) → MongoDB Vector Search (meta + chunks)<a class="headerlink" href="#use-cases-file-to-story-step-5-ingest-rag-mongodb-vector-search-meta-chunks" title="Permanent link">&para;</a></h4>
<p>Ingestion turns the (preferably transformed) markdown into:</p>
<ul>
<li><code>kind: 'meta'</code> document: for gallery/explorer + facets</li>
<li><code>kind: 'chunk'</code> documents: for semantic retrieval</li>
<li><code>kind: 'chapterSummary'</code> docs (optional) for chapter-focused retrieval</li>
</ul>
<p>Reference: <code>docs/analysis/ingestion.md</code>, <code>docs/architecture/mongodb-vector-search.md</code></p>
<h4 id="use-cases-file-to-story-step-6-explorer-chat-askable-story">Step 6 — Explorer &amp; Chat (askable story)<a class="headerlink" href="#use-cases-file-to-story-step-6-explorer-chat-askable-story" title="Permanent link">&para;</a></h4>
<ul>
<li>Explorer/Gallery reads meta documents to render cards (title, teaser, cover, etc.)</li>
<li>Chat retrieves relevant chunks using <code>$vectorSearch</code> and generates answers (RAG)</li>
</ul>
<p>Reference: <code>docs/use-cases/chat-exploration.md</code></p>
<h3 id="use-cases-file-to-story-mermaid-sequence-overview-systems-apis">Mermaid: Sequence overview (systems + APIs)<a class="headerlink" href="#use-cases-file-to-story-mermaid-sequence-overview-systems-apis" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>sequenceDiagram
  autonumber
  actor User
  participant UI as Library UI
  participant API as Next.js API
  participant Jobs as External Jobs (MongoDB)
  participant Provider as Storage Provider
  participant ST as Shadow‑Twin Store (Mongo/FS)
  participant Sec as Secretary Service
  participant V as Vector Store (MongoDB Vector Search)

  User-&gt;&gt;UI: Choose file + start processing
  UI-&gt;&gt;API: POST /api/pipeline/process
  API-&gt;&gt;Jobs: create job (steps: extract, transform, ingest)

  API-&gt;&gt;API: best-effort trigger worker tick
  API-&gt;&gt;API: POST /api/external/jobs/{jobId}/start (worker)

  API-&gt;&gt;Provider: getBinary(sourceId)
  API-&gt;&gt;ST: analyze existing artifacts (gates)

  alt extract needed (pdf/audio/video)
    API-&gt;&gt;Sec: submit extract/transcribe request
    Sec--&gt;&gt;API: callback with transcript markdown
    API-&gt;&gt;ST: upsert transcript artifact
  else extract skipped
    API-&gt;&gt;ST: (use existing transcript/source text)
  end

  alt template enabled
    API-&gt;&gt;Sec: transform-by-template
    Sec--&gt;&gt;API: callback with transformation markdown
    API-&gt;&gt;ST: upsert transformation artifact
  end

  alt ingest enabled
    API-&gt;&gt;V: upsert meta + chunks (+ chapterSummary)
  end

  UI-&gt;&gt;API: Load artifacts + ingestion status
  UI-&gt;&gt;API: POST /api/library/{libraryId}/artifacts/batch-resolve
  UI-&gt;&gt;API: GET /api/chat/{libraryId}/ingestion-status?fileId=...
  User-&gt;&gt;UI: Ask question
  UI-&gt;&gt;API: POST /api/chat/{libraryId}/stream
  API-&gt;&gt;V: $vectorSearch (retrieve chunks)
  API--&gt;&gt;UI: streamed answer + citations</code></pre>
<h3 id="use-cases-file-to-story-4-storage-matrix-what-lives-where">4) Storage matrix (what lives where?)<a class="headerlink" href="#use-cases-file-to-story-4-storage-matrix-what-lives-where" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Data</th>
<th>What it is</th>
<th style="text-align: right;">File Storage (Provider)</th>
<th style="text-align: right;">MongoDB (Shadow‑Twin)</th>
<th style="text-align: right;">Azure Blob (Binary)</th>
<th style="text-align: right;">MongoDB Vector Search</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source file</td>
<td>PDF/audio/video/markdown</td>
<td style="text-align: right;">✅</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">(optional)</td>
<td style="text-align: right;">✖️</td>
</tr>
<tr>
<td>Transcript artifact</td>
<td>extracted markdown</td>
<td style="text-align: right;">✅ (FS mode)</td>
<td style="text-align: right;">✅ (mongo mode)</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✖️</td>
</tr>
<tr>
<td>Transformation artifact</td>
<td>template markdown + frontmatter</td>
<td style="text-align: right;">✅ (FS mode)</td>
<td style="text-align: right;">✅ (mongo mode)</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✖️</td>
</tr>
<tr>
<td>Binary fragments metadata</td>
<td>image references (cover, slides, etc.)</td>
<td style="text-align: right;">(possible)</td>
<td style="text-align: right;">✅</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✖️</td>
</tr>
<tr>
<td>Binary fragments bytes</td>
<td>images, PDFs (optional)</td>
<td style="text-align: right;">✅ (FS fallback)</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✅</td>
<td style="text-align: right;">✖️</td>
</tr>
<tr>
<td>MetaDoc</td>
<td><code>kind: 'meta'</code></td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✅</td>
</tr>
<tr>
<td>Chunks</td>
<td><code>kind: 'chunk'</code></td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✅</td>
</tr>
<tr>
<td>Chapter summaries</td>
<td><code>kind: 'chapterSummary'</code></td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✖️</td>
<td style="text-align: right;">✅</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li>Shadow‑Twin “primary store” is configurable per library (<code>filesystem</code> vs <code>mongo</code>).</li>
<li>In mongo mode, binaries are typically served via <strong>Azure URLs</strong> (fallback exists via <code>/api/storage/filesystem</code> when a <code>fileId</code> exists).</li>
</ul>
<h3 id="use-cases-file-to-story-5-typical-failure-modes-and-how-to-recognize-them">5) Typical failure modes (and how to recognize them)<a class="headerlink" href="#use-cases-file-to-story-5-typical-failure-modes-and-how-to-recognize-them" title="Permanent link">&para;</a></h3>
<h4 id="use-cases-file-to-story-a-missing-templatename-for-transformations-determinism-break">A) Missing <code>templateName</code> for transformations (determinism break)<a class="headerlink" href="#use-cases-file-to-story-a-missing-templatename-for-transformations-determinism-break" title="Permanent link">&para;</a></h4>
<p>Symptoms:</p>
<ul>
<li>transformation not found / wrong transformation chosen</li>
<li>cover upload/frontmatter patch fails or updates “the wrong one”</li>
</ul>
<p>Fix direction:</p>
<ul>
<li>treat <code>templateName</code> as required input for transformation operations</li>
<li>avoid “pick newest transformation” as a default behavior in new call-sites</li>
</ul>
<h4 id="use-cases-file-to-story-b-azure-container-missing-misconfigured">B) Azure container missing / misconfigured<a class="headerlink" href="#use-cases-file-to-story-b-azure-container-missing-misconfigured" title="Permanent link">&para;</a></h4>
<p>Symptoms:</p>
<ul>
<li>cover/slides/pdf upload fails with “container does not exist”</li>
<li>ingestion completes but without expected URLs</li>
</ul>
<p>Fix direction:</p>
<ul>
<li>ensure Azure storage configuration is present and the container exists</li>
<li>keep FS fallback for development where Azure is unavailable</li>
</ul>
<h4 id="use-cases-file-to-story-c-ingestion-input-empty-too-short">C) Ingestion input empty / too short<a class="headerlink" href="#use-cases-file-to-story-c-ingestion-input-empty-too-short" title="Permanent link">&para;</a></h4>
<p>Symptoms:</p>
<ul>
<li><code>ingest_rag</code> fails early, or results in “no chunks”</li>
</ul>
<p>Fix direction:</p>
<ul>
<li>treat empty ingestion input as a hard error (pipeline should not mark success)</li>
<li>verify transformation/transcript output first</li>
</ul>
<h4 id="use-cases-file-to-story-d-vector-search-index-not-ready-missing-token-index-fields">D) Vector Search index not READY / missing token-index fields<a class="headerlink" href="#use-cases-file-to-story-d-vector-search-index-not-ready-missing-token-index-fields" title="Permanent link">&para;</a></h4>
<p>Symptoms:</p>
<ul>
<li><code>$vectorSearch</code> errors</li>
<li>errors like “Path 'authors' needs to be indexed as token”</li>
</ul>
<p>Fix direction:</p>
<ul>
<li>check index status (can take time: INITIAL_SYNC)</li>
<li>ensure the index definition includes token indexing for array fields used in filters</li>
</ul>
<h3 id="use-cases-file-to-story-6-debug-entry-points-fastest-way-to-locate-the-break">6) Debug entry points (fastest way to locate the break)<a class="headerlink" href="#use-cases-file-to-story-6-debug-entry-points-fastest-way-to-locate-the-break" title="Permanent link">&para;</a></h3>
<h4 id="use-cases-file-to-story-external-job-steps">External Job steps<a class="headerlink" href="#use-cases-file-to-story-external-job-steps" title="Permanent link">&para;</a></h4>
<p>Look at job steps for:</p>
<ul>
<li><code>extract_pdf</code> / <code>extract_audio</code> / <code>extract_video</code></li>
<li><code>transform_template</code></li>
<li><code>ingest_rag</code></li>
</ul>
<p>Key contract:</p>
<ul>
<li>job <code>completed</code> must not have any step still <code>pending</code> or <code>running</code></li>
</ul>
<h4 id="use-cases-file-to-story-ingestion-status-api">Ingestion status API<a class="headerlink" href="#use-cases-file-to-story-ingestion-status-api" title="Permanent link">&para;</a></h4>
<ul>
<li><code>GET /api/chat/{libraryId}/ingestion-status?fileId=...</code></li>
</ul>
<p>Use it to verify:</p>
<ul>
<li>meta doc exists</li>
<li>chunkCount / chaptersCount make sense</li>
<li>doc is not stale compared to your current artifact</li>
</ul>
<h4 id="use-cases-file-to-story-chat-stream-processing-steps-live">Chat stream processing steps (live)<a class="headerlink" href="#use-cases-file-to-story-chat-stream-processing-steps-live" title="Permanent link">&para;</a></h4>
<ul>
<li><code>POST /api/chat/{libraryId}/stream</code> emits structured steps such as:</li>
<li>retriever selection</li>
<li>retrieval start/progress</li>
<li>(optional) cache checks</li>
<li>completion or error</li>
</ul>
<p>Use these steps to decide whether the failure is:</p>
<ul>
<li>“retrieval” (Vector Search) vs</li>
<li>“generation” (LLM) vs</li>
<li>“missing ingestion” (no indexed docs)</li>
</ul>
<h3 id="use-cases-file-to-story-related-docs-deep-dives">Related docs (deep dives)<a class="headerlink" href="#use-cases-file-to-story-related-docs-deep-dives" title="Permanent link">&para;</a></h3>
<ul>
<li>Pipeline phases: <code>docs/architecture/pipeline-phases.md</code></li>
<li>Shadow‑Twin model: <code>docs/architecture/shadow-twin.md</code></li>
<li>Ingestion runtime: <code>docs/analysis/ingestion.md</code></li>
<li>Vector search architecture: <code>docs/architecture/mongodb-vector-search.md</code></li>
<li>Chat use case: <code>docs/use-cases/chat-exploration.md</code></li>
</ul></section><section class="print-page" id="use-cases-web-scraping" heading-number="4.6"><h1 id="use-cases-web-scraping-web-scraping-event-import">Web Scraping &amp; Event Import<a class="headerlink" href="#use-cases-web-scraping-web-scraping-event-import" title="Permanent link">&para;</a></h1>
<h2 id="use-cases-web-scraping-what-is-achieved">What is achieved?<a class="headerlink" href="#use-cases-web-scraping-what-is-achieved" title="Permanent link">&para;</a></h2>
<p>Scrape web content and import event data (conferences, workshops, talks) into your library. Extract structured data from web pages, convert them to Markdown format, and organize them by events and tracks.</p>
<h2 id="use-cases-web-scraping-prerequisites">Prerequisites<a class="headerlink" href="#use-cases-web-scraping-prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Active library selected</li>
<li>Event Monitor access</li>
<li>Event URL or web page with structured content</li>
</ul>
<h2 id="use-cases-web-scraping-steps">Steps<a class="headerlink" href="#use-cases-web-scraping-steps" title="Permanent link">&para;</a></h2>
<ol>
<li>Navigate to <strong>Event Monitor</strong> page</li>
<li>Click <strong>"Create Track"</strong> to start a new batch</li>
<li>Enter event information:</li>
<li><strong>Event Name</strong>: Name of the event/conference</li>
<li><strong>Track Name</strong>: Track or session category</li>
<li><strong>Source URL</strong>: URL of the web page to scrape</li>
<li>Configure scraping options:</li>
<li>Select <strong>target language</strong> for transformation</li>
<li>Choose <strong>template</strong> for structured output (optional)</li>
<li>Start the scraping process</li>
<li>Monitor progress in the Event Monitor:</li>
<li>View job status (pending, running, completed, failed)</li>
<li>Filter by event name</li>
<li>Check individual job details</li>
<li>After completion: Sessions are transformed to Markdown files in your library</li>
</ol>
<h2 id="use-cases-web-scraping-result">Result<a class="headerlink" href="#use-cases-web-scraping-result" title="Permanent link">&para;</a></h2>
<p>Event sessions are imported as structured Markdown files organized by event and track. Each session contains metadata, transcripts (if available), and associated media files.</p>
<h2 id="use-cases-web-scraping-tips">Tips<a class="headerlink" href="#use-cases-web-scraping-tips" title="Permanent link">&para;</a></h2>
<ul>
<li>Use the Event Filter to focus on specific events</li>
<li>Batch operations allow processing multiple tracks simultaneously</li>
<li>Failed jobs can be retried individually</li>
<li>Archive completed batches for organization</li>
</ul>
<h2 id="use-cases-web-scraping-further-information">Further Information<a class="headerlink" href="#use-cases-web-scraping-further-information" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#reference-file-index-event-job-system">Event Job System Documentation</a></li>
<li><a href="#use-cases-batch-operations">Batch Operations</a> for multiple files</li>
</ul></section><section class="print-page" id="use-cases-publishing" heading-number="4.7"><h1 id="use-cases-publishing-publishing-gallery">Publishing &amp; Gallery<a class="headerlink" href="#use-cases-publishing-publishing-gallery" title="Permanent link">&para;</a></h1>
<h2 id="use-cases-publishing-what-is-achieved">What is achieved?<a class="headerlink" href="#use-cases-publishing-what-is-achieved" title="Permanent link">&para;</a></h2>
<p>Publish your library publicly so others can access and explore your knowledge base. Create a public gallery with a custom URL, API access, and configurable display settings.</p>
<h2 id="use-cases-publishing-prerequisites">Prerequisites<a class="headerlink" href="#use-cases-publishing-prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Active library configured</li>
<li>Library owner permissions</li>
</ul>
<h2 id="use-cases-publishing-steps">Steps<a class="headerlink" href="#use-cases-publishing-steps" title="Permanent link">&para;</a></h2>
<ol>
<li>Go to <strong>Settings → Public</strong></li>
<li>Enable <strong>"Public Library"</strong> toggle</li>
<li>Configure public settings:</li>
<li><strong>Slug Name</strong>: URL-friendly identifier (lowercase, numbers, hyphens only)</li>
<li><strong>Public Name</strong>: Display name for your library</li>
<li><strong>Description</strong>: Public description of your library</li>
<li><strong>Icon</strong>: Choose an icon from common options (optional)</li>
<li>Configure gallery display:</li>
<li><strong>Headline</strong>: Main headline for the gallery page</li>
<li><strong>Subtitle</strong>: Subtitle text</li>
<li><strong>Description</strong>: Gallery description</li>
<li><strong>Filter Description</strong>: Help text for filters</li>
<li>Generate <strong>API Key</strong> (if needed for programmatic access)</li>
<li>Click <strong>"Save"</strong></li>
<li>Your library is now accessible at: <code>/public/[slug-name]</code></li>
</ol>
<h2 id="use-cases-publishing-result">Result<a class="headerlink" href="#use-cases-publishing-result" title="Permanent link">&para;</a></h2>
<p>Your library is publicly accessible. Visitors can browse documents, use the chat interface, and explore your knowledge base without authentication.</p>
<h2 id="use-cases-publishing-tips">Tips<a class="headerlink" href="#use-cases-publishing-tips" title="Permanent link">&para;</a></h2>
<ul>
<li>The slug name must be unique across all public libraries</li>
<li>API keys provide programmatic access to your library</li>
<li>Gallery settings customize the public-facing interface</li>
<li>You can disable public access at any time</li>
</ul>
<h2 id="use-cases-publishing-further-information">Further Information<a class="headerlink" href="#use-cases-publishing-further-information" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#reference-modules-library">Library Module Documentation</a></li>
<li><a href="#reference-file-index-library-system">Public Publishing Settings</a></li>
</ul></section><section class="print-page" id="use-cases-chat-exploration" heading-number="4.8"><h1 id="use-cases-chat-exploration-chat-story-mode">Chat &amp; Story Mode<a class="headerlink" href="#use-cases-chat-exploration-chat-story-mode" title="Permanent link">&para;</a></h1>
<h2 id="use-cases-chat-exploration-what-is-achieved">What is achieved?<a class="headerlink" href="#use-cases-chat-exploration-what-is-achieved" title="Permanent link">&para;</a></h2>
<p>Explore your knowledge base using natural language queries. The Chat interface uses RAG (Retrieval-Augmented Generation) to find relevant content and generate answers based on your library's documents.</p>
<h2 id="use-cases-chat-exploration-prerequisites">Prerequisites<a class="headerlink" href="#use-cases-chat-exploration-prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Active library selected</li>
<li>Documents transformed and ingested into the library</li>
</ul>
<h2 id="use-cases-chat-exploration-how-the-data-gets-there-quick-link">How the data gets there (quick link)<a class="headerlink" href="#use-cases-chat-exploration-how-the-data-gets-there-quick-link" title="Permanent link">&para;</a></h2>
<p>If you want the full “file → story → askable” pipeline explained end-to-end (including Shadow‑Twin, ingestion, storage backends and typical failure modes), see:</p>
<ul>
<li><code>use-cases/file-to-story.md</code></li>
</ul>
<h2 id="use-cases-chat-exploration-steps">Steps<a class="headerlink" href="#use-cases-chat-exploration-steps" title="Permanent link">&para;</a></h2>
<ol>
<li>Open the <strong>Library</strong> view</li>
<li>Click the <strong>Chat</strong> icon or open the chat panel</li>
<li>Configure chat settings (optional):</li>
<li><strong>Answer Length</strong>: Short, medium, or long answers</li>
<li><strong>Retriever</strong>: Chunk-based or summary-based retrieval</li>
<li><strong>Target Language</strong>: Language for responses</li>
<li><strong>Character</strong>: Perspective for answers (e.g., expert, beginner)</li>
<li><strong>Social Context</strong>: Context for answer generation</li>
<li>Type your question in the chat input</li>
<li>The system will:</li>
<li>Analyze your question</li>
<li>Retrieve relevant documents</li>
<li>Generate an answer based on your library content</li>
<li>Display sources used for the answer</li>
<li>Continue the conversation with follow-up questions</li>
<li>Use <strong>Story Mode</strong> for narrative-style exploration</li>
</ol>
<h2 id="use-cases-chat-exploration-result">Result<a class="headerlink" href="#use-cases-chat-exploration-result" title="Permanent link">&para;</a></h2>
<p>You receive answers based on your library's content with source citations. The chat history is saved for future reference.</p>
<h2 id="use-cases-chat-exploration-tips">Tips<a class="headerlink" href="#use-cases-chat-exploration-tips" title="Permanent link">&para;</a></h2>
<ul>
<li>Use specific questions for better results</li>
<li>Check source citations to verify information</li>
<li>Story Mode provides narrative-style exploration</li>
<li>Chat history is saved automatically</li>
<li>Filter by facets/metadata for focused queries</li>
</ul>
<h2 id="use-cases-chat-exploration-further-information">Further Information<a class="headerlink" href="#use-cases-chat-exploration-further-information" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#reference-modules-chat">Chat System Documentation</a></li>
<li><a href="#reference-file-index-chat-system">Chat Orchestration</a></li>
</ul></section><section class="print-page" id="use-cases-batch-operations" heading-number="4.9"><h1 id="use-cases-batch-operations-batch-operations">Batch Operations<a class="headerlink" href="#use-cases-batch-operations-batch-operations" title="Permanent link">&para;</a></h1>
<h2 id="use-cases-batch-operations-what-is-achieved">What is achieved?<a class="headerlink" href="#use-cases-batch-operations-what-is-achieved" title="Permanent link">&para;</a></h2>
<p>Process multiple files simultaneously for transformation, transcription, or ingestion. Save time by handling multiple operations in parallel.</p>
<h2 id="use-cases-batch-operations-prerequisites">Prerequisites<a class="headerlink" href="#use-cases-batch-operations-prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Active library selected</li>
<li>Multiple files available in Library Browser</li>
</ul>
<h2 id="use-cases-batch-operations-steps">Steps<a class="headerlink" href="#use-cases-batch-operations-steps" title="Permanent link">&para;</a></h2>
<ol>
<li>Open the <strong>Library</strong> view</li>
<li>Navigate to the folder containing files</li>
<li>Select multiple files:</li>
<li>Use checkboxes to select individual files</li>
<li>Or select all files in a folder</li>
<li>Choose the operation:</li>
<li><strong>Transformation</strong>: Transform PDFs to Markdown</li>
<li><strong>Transcription</strong>: Transcribe audio/video files</li>
<li><strong>Ingestion</strong>: Ingest documents into RAG system</li>
<li>Configure options:</li>
<li>Select <strong>target language</strong></li>
<li>Choose <strong>template</strong> (if applicable)</li>
<li>Set processing options</li>
<li>Click <strong>"Start Batch Processing"</strong></li>
<li>Monitor progress:</li>
<li>View overall progress bar</li>
<li>See individual file status</li>
<li>Check success/failure counts</li>
<li>Review results:</li>
<li>Successful transformations appear as Shadow Twins</li>
<li>Failed files show error messages</li>
<li>Retry failed operations if needed</li>
</ol>
<h2 id="use-cases-batch-operations-result">Result<a class="headerlink" href="#use-cases-batch-operations-result" title="Permanent link">&para;</a></h2>
<p>Multiple files are processed in parallel. Results appear as they complete, with success/failure status for each file.
Internally the same three phases are used as for single-file PDF transformation (Extract → Template → Ingestion); depending on existing artifacts, individual phases may be skipped automatically.</p>
<h2 id="use-cases-batch-operations-tips">Tips<a class="headerlink" href="#use-cases-batch-operations-tips" title="Permanent link">&para;</a></h2>
<ul>
<li>Batch operations run in the background</li>
<li>You can continue working while processing</li>
<li>Failed files can be retried individually</li>
<li>Progress is saved - you can refresh without losing state</li>
<li>Large batches may take time - be patient</li>
</ul>
<h2 id="use-cases-batch-operations-further-information">Further Information<a class="headerlink" href="#use-cases-batch-operations-further-information" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#reference-file-index-transform--processing">Transform Service Documentation</a></li>
<li><a href="#use-cases-file-transformation-pdf">PDF Transformation</a> for single files</li>
<li><a href="#use-cases-file-transformation-media">Media Transformation</a> for single files</li>
</ul></section></section>
                    <section class='print-page md-section' id='section-5' heading-number='5'>
                        <h1>Reference<a class='headerlink' href='#section-5' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="reference-file-index" heading-number="5.1"><h1 id="reference-file-index-file-index">File Index<a class="headerlink" href="#reference-file-index-file-index" title="Permanent link">&para;</a></h1>
<p>Complete index of all documented source files with descriptions, exports, and usage information.</p>
<h2 id="reference-file-index-core-infrastructure">Core Infrastructure ✅<a class="headerlink" href="#reference-file-index-core-infrastructure" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/middleware.ts</code></td>
<td>core</td>
<td>Authentication and routing middleware</td>
<td><code>default</code>, <code>config</code></td>
<td>Next.js framework, all routes</td>
</tr>
<tr>
<td><code>src/app/layout.tsx</code></td>
<td>core</td>
<td>Root layout component</td>
<td><code>default</code>, <code>metadata</code></td>
<td>Next.js framework, all pages</td>
</tr>
<tr>
<td><code>src/instrumentation.ts</code></td>
<td>core</td>
<td>Next.js instrumentation hook</td>
<td><code>register</code></td>
<td>Next.js framework</td>
</tr>
<tr>
<td><code>src/lib/env.ts</code></td>
<td>core</td>
<td>Environment variable helpers</td>
<td><code>getPublicAppUrl</code>, <code>getSelfBaseUrl</code>, <code>getSecretaryConfig</code>, <code>getVimeoConfig</code></td>
<td>API routes, services</td>
</tr>
<tr>
<td><code>src/lib/auth.ts</code></td>
<td>core</td>
<td>Authentication helpers</td>
<td><code>getLibraryId</code>, <code>isAuthenticated</code>, <code>getUserInfo</code></td>
<td>API routes, components</td>
</tr>
<tr>
<td><code>src/lib/mongodb-service.ts</code></td>
<td>core</td>
<td>MongoDB database service</td>
<td><code>connectToDatabase</code>, <code>getCollection</code></td>
<td>Services, repositories, API routes</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-storage-layer">Storage Layer ✅<a class="headerlink" href="#reference-file-index-storage-layer" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/lib/storage/types.ts</code></td>
<td>storage</td>
<td>Storage type definitions</td>
<td><code>StorageItemMetadata</code>, <code>StorageItem</code>, <code>StorageValidationResult</code>, <code>StorageProvider</code></td>
<td>All storage files</td>
</tr>
<tr>
<td><code>src/lib/storage/storage-factory.ts</code></td>
<td>storage</td>
<td>Storage provider factory</td>
<td><code>StorageFactory</code>, <code>LocalStorageProvider</code></td>
<td>Contexts, API routes, components</td>
</tr>
<tr>
<td><code>src/lib/storage/filesystem-provider.ts</code></td>
<td>storage</td>
<td>Local filesystem provider</td>
<td><code>FileSystemProvider</code></td>
<td>Storage factory</td>
</tr>
<tr>
<td><code>src/lib/storage/onedrive-provider.ts</code></td>
<td>storage</td>
<td>OneDrive provider</td>
<td><code>OneDriveProvider</code></td>
<td>Storage factory</td>
</tr>
<tr>
<td><code>src/lib/storage/storage-factory-mongodb.ts</code></td>
<td>storage</td>
<td>MongoDB storage factory</td>
<td><code>MongoDBStorageFactory</code></td>
<td>MongoDB operations</td>
</tr>
<tr>
<td><code>src/lib/storage/filesystem-client.ts</code></td>
<td>storage</td>
<td>Filesystem client</td>
<td><code>FileSystemClient</code></td>
<td>Client-side operations</td>
</tr>
<tr>
<td><code>src/lib/storage/server-provider.ts</code></td>
<td>storage</td>
<td>Server-side provider helper</td>
<td><code>getServerProvider</code></td>
<td>API routes</td>
</tr>
<tr>
<td><code>src/lib/storage/supported-types.ts</code></td>
<td>storage</td>
<td>Supported library types</td>
<td><code>SUPPORTED_LIBRARY_TYPES</code>, <code>isSupportedLibraryType</code>, <code>getSupportedLibraryTypesString</code></td>
<td>Storage factory</td>
</tr>
<tr>
<td><code>src/contexts/storage-context.tsx</code></td>
<td>storage</td>
<td>Storage React context</td>
<td><code>StorageContextProvider</code>, <code>useStorage</code></td>
<td>Components</td>
</tr>
<tr>
<td><code>src/hooks/use-storage-provider.tsx</code></td>
<td>storage</td>
<td>Storage provider hook</td>
<td><code>useStorageProvider</code></td>
<td>Components</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-library-system">Library System ✅<a class="headerlink" href="#reference-file-index-library-system" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/types/library.ts</code></td>
<td>library</td>
<td>Library type definitions</td>
<td><code>ClientLibrary</code>, <code>Library</code>, <code>LibraryChatConfig</code>, <code>StorageConfig</code>, <code>PublicLibraryConfig</code></td>
<td>All library files</td>
</tr>
<tr>
<td><code>src/atoms/library-atom.ts</code></td>
<td>library</td>
<td>Library state atoms</td>
<td><code>libraryAtom</code>, <code>activeLibraryIdAtom</code>, <code>librariesAtom</code>, <code>activeLibraryAtom</code>, <code>currentFolderIdAtom</code></td>
<td>Components</td>
</tr>
<tr>
<td><code>src/lib/services/library-service.ts</code></td>
<td>library</td>
<td>Library service</td>
<td><code>LibraryService</code>, <code>UserLibraries</code></td>
<td>API routes, components</td>
</tr>
<tr>
<td><code>src/components/library/library.tsx</code></td>
<td>library</td>
<td>Main library component</td>
<td><code>Library</code></td>
<td>Library page</td>
</tr>
<tr>
<td><code>src/components/library/library-header.tsx</code></td>
<td>library</td>
<td>Library header component</td>
<td>TBD</td>
<td>Library component</td>
</tr>
<tr>
<td><code>src/components/library/library-switcher.tsx</code></td>
<td>library</td>
<td>Library switcher component</td>
<td>TBD</td>
<td>Library header</td>
</tr>
<tr>
<td><code>src/components/library/file-list.tsx</code></td>
<td>library</td>
<td>File list with header actions and record operations</td>
<td><code>FileList</code></td>
<td>Library component</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-chat-system">Chat System ✅<a class="headerlink" href="#reference-file-index-chat-system" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/types/chat.ts</code></td>
<td>chat</td>
<td>Chat type definitions</td>
<td><code>Chat</code></td>
<td>Chat system</td>
</tr>
<tr>
<td><code>src/lib/chat/constants.ts</code></td>
<td>chat</td>
<td>Chat constants</td>
<td><code>AnswerLength</code>, <code>Retriever</code>, <code>TargetLanguage</code>, <code>Character</code>, <code>SocialContext</code></td>
<td>Chat system</td>
</tr>
<tr>
<td><code>src/lib/chat/orchestrator.ts</code></td>
<td>chat</td>
<td>Chat orchestration</td>
<td><code>runChatOrchestrated</code>, <code>OrchestratorInput</code>, <code>OrchestratorOutput</code></td>
<td>Chat API routes</td>
</tr>
<tr>
<td><code>src/lib/chat/loader.ts</code></td>
<td>chat</td>
<td>Chat loader</td>
<td><code>loadLibraryChatContext</code>, <code>LibraryChatContext</code></td>
<td>Chat orchestrator</td>
</tr>
<tr>
<td><code>src/lib/chat/config.ts</code></td>
<td>chat</td>
<td>Chat configuration</td>
<td><code>chatConfigSchema</code>, <code>normalizeChatConfig</code>, <code>getVectorIndexForLibrary(library, chatConfig?)</code></td>
<td>Chat system</td>
</tr>
<tr>
<td><code>src/lib/chat/retrievers/chunks.ts</code></td>
<td>chat</td>
<td>Chunk retriever</td>
<td><code>chunksRetriever</code></td>
<td>Chat orchestrator</td>
</tr>
<tr>
<td><code>src/lib/chat/retrievers/summaries-mongo.ts</code></td>
<td>chat</td>
<td>Summary retriever</td>
<td><code>summariesMongoRetriever</code></td>
<td>Chat orchestrator</td>
</tr>
<tr>
<td><code>src/lib/chat/common/prompt.ts</code></td>
<td>chat</td>
<td>Prompt building</td>
<td><code>buildPrompt</code>, <code>buildTOCPrompt</code>, <code>getSourceDescription</code></td>
<td>Chat orchestrator</td>
</tr>
<tr>
<td><code>src/lib/chat/common/llm.ts</code></td>
<td>chat</td>
<td>LLM calling</td>
<td><code>callOpenAI</code>, <code>parseOpenAIResponseWithUsage</code>, <code>parseStructuredLLMResponse</code></td>
<td>Chat orchestrator</td>
</tr>
<tr>
<td><code>src/app/api/chat/[libraryId]/stream/route.ts</code></td>
<td>chat</td>
<td>Chat streaming endpoint</td>
<td><code>POST</code></td>
<td>Chat components</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-external-jobs-system">External Jobs System ✅<a class="headerlink" href="#reference-file-index-external-jobs-system" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/lib/external-jobs-repository.ts</code></td>
<td>external-jobs</td>
<td>MongoDB repository for external jobs</td>
<td><code>ExternalJobsRepository</code></td>
<td>Worker, watchdog, API routes, orchestration</td>
</tr>
<tr>
<td><code>src/lib/external-jobs-worker.ts</code></td>
<td>external-jobs</td>
<td>Background worker for processing jobs</td>
<td><code>ExternalJobsWorker</code></td>
<td>Instrumentation, worker status endpoint</td>
</tr>
<tr>
<td><code>src/lib/external-jobs-watchdog.ts</code></td>
<td>external-jobs</td>
<td>Timeout monitoring for jobs</td>
<td><code>startWatchdog</code>, <code>bumpWatchdog</code>, <code>clearWatchdog</code></td>
<td>Job callbacks, job start</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/context.ts</code></td>
<td>external-jobs</td>
<td>Request context parsing</td>
<td><code>readContext</code></td>
<td>Job callback</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/auth.ts</code></td>
<td>external-jobs</td>
<td>Authorization and bypass checks</td>
<td><code>isInternalAuthorized</code>, <code>authorizeCallback</code>, <code>guardProcessId</code></td>
<td>Job callbacks, job start</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/policies.ts</code></td>
<td>external-jobs</td>
<td>Phase policy extraction</td>
<td><code>readPhasesAndPolicies</code></td>
<td>Job callback</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/template-decision.ts</code></td>
<td>external-jobs</td>
<td>Template execution decision logic</td>
<td><code>decideTemplateRun</code></td>
<td>Job callback</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/template-run.ts</code></td>
<td>external-jobs</td>
<td>Template transformation execution</td>
<td><code>runTemplateTransform</code></td>
<td>Job callback</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/chapters.ts</code></td>
<td>external-jobs</td>
<td>Chapter detection and merging</td>
<td><code>analyzeAndMergeChapters</code></td>
<td>Job callback</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/storage.ts</code></td>
<td>external-jobs</td>
<td>Markdown file storage</td>
<td><code>saveMarkdown</code></td>
<td>Job callback</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/images.ts</code></td>
<td>external-jobs</td>
<td>Image archive extraction</td>
<td><code>processAllImageSources</code></td>
<td>Job callback</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/ingest.ts</code></td>
<td>external-jobs</td>
<td>RAG ingestion pipeline</td>
<td><code>runIngestion</code></td>
<td>Job callback, job start</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/complete.ts</code></td>
<td>external-jobs</td>
<td>Job completion handler</td>
<td><code>setJobCompleted</code></td>
<td>Job callback, job start</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/preprocess.ts</code></td>
<td>external-jobs</td>
<td>Job preprocessing and analysis</td>
<td><code>preprocess</code>, <code>PreprocessResult</code></td>
<td>Job start, job callback</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/provider.ts</code></td>
<td>external-jobs</td>
<td>Storage provider construction</td>
<td><code>buildProvider</code></td>
<td>Preprocessing, job callback</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/progress.ts</code></td>
<td>external-jobs</td>
<td>Progress update processing</td>
<td><code>handleProgressIfAny</code></td>
<td>Job callback</td>
</tr>
<tr>
<td><code>src/app/api/external/jobs/[jobId]/route.ts</code></td>
<td>external-jobs</td>
<td>Main job processing endpoint</td>
<td><code>GET</code>, <code>POST</code></td>
<td>Secretary Service, worker</td>
</tr>
<tr>
<td><code>src/app/api/external/jobs/[jobId]/start/route.ts</code></td>
<td>external-jobs</td>
<td>Job execution trigger</td>
<td><code>POST</code></td>
<td>Worker</td>
</tr>
<tr>
<td><code>src/app/api/external/jobs/route.ts</code></td>
<td>external-jobs</td>
<td>Job query endpoint</td>
<td><code>GET</code></td>
<td>Event monitor components</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-secretary-service">Secretary Service ✅<a class="headerlink" href="#reference-file-index-secretary-service" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/lib/secretary/client.ts</code></td>
<td>secretary</td>
<td>HTTP client for Secretary Service API</td>
<td><code>SecretaryServiceClient</code>, <code>SecretaryServiceError</code>, response interfaces</td>
<td>Secretary API routes, external jobs</td>
</tr>
<tr>
<td><code>src/lib/secretary/adapter.ts</code></td>
<td>secretary</td>
<td>Low-level API call functions</td>
<td><code>callPdfProcess</code>, <code>callTemplateTransform</code></td>
<td>Secretary client, template runner</td>
</tr>
<tr>
<td><code>src/lib/secretary/response-parser.ts</code></td>
<td>secretary</td>
<td>Markdown response parsing</td>
<td><code>parseSecretaryMarkdownStrict</code>, <code>FrontmatterParseResult</code></td>
<td>External jobs, Secretary API routes</td>
</tr>
<tr>
<td><code>src/lib/secretary/types.ts</code></td>
<td>secretary</td>
<td>Type definitions for Secretary Service</td>
<td>Request/response interfaces</td>
<td>Secretary client, API routes, external jobs</td>
</tr>
<tr>
<td><code>src/app/api/secretary/process-pdf/route.ts</code></td>
<td>secretary</td>
<td>PDF transformation endpoint</td>
<td><code>POST</code></td>
<td>Library components</td>
</tr>
<tr>
<td><code>src/app/api/secretary/process-audio/route.ts</code></td>
<td>secretary</td>
<td>Audio transformation endpoint</td>
<td><code>POST</code></td>
<td>Library components</td>
</tr>
<tr>
<td><code>src/app/api/secretary/process-video/route.ts</code></td>
<td>secretary</td>
<td>Video transformation endpoint</td>
<td><code>POST</code></td>
<td>Library components</td>
</tr>
<tr>
<td><code>src/app/api/secretary/process-image/route.ts</code></td>
<td>secretary</td>
<td>Image OCR endpoint</td>
<td><code>POST</code></td>
<td>Library components</td>
</tr>
<tr>
<td><code>src/app/api/secretary/session/process/route.ts</code></td>
<td>secretary</td>
<td>Session import endpoint</td>
<td><code>POST</code></td>
<td>Event monitor components, session processing</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-event-job-system">Event Job System ✅<a class="headerlink" href="#reference-file-index-event-job-system" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/lib/event-job-repository.ts</code></td>
<td>event-job</td>
<td>MongoDB repository for event jobs</td>
<td><code>EventJobRepository</code></td>
<td>API routes, session processor, event monitor</td>
</tr>
<tr>
<td><code>src/lib/session/session-processor.ts</code></td>
<td>event-job</td>
<td>Session data processing utilities</td>
<td><code>vttToPlainText</code>, <code>extractVideoTranscript</code>, <code>buildSessionPayload</code></td>
<td>API routes, event monitor components</td>
</tr>
<tr>
<td><code>src/lib/session-repository.ts</code></td>
<td>event-job</td>
<td>MongoDB repository for sessions</td>
<td><code>SessionRepository</code></td>
<td>API routes, event monitor components</td>
</tr>
<tr>
<td><code>src/app/api/event-job/jobs/[jobId]/route.ts</code></td>
<td>event-job</td>
<td>Individual job operations</td>
<td><code>GET</code>, <code>DELETE</code>, <code>PATCH</code></td>
<td>Event monitor components</td>
</tr>
<tr>
<td><code>src/app/api/event-job/batches/[batchId]/route.ts</code></td>
<td>event-job</td>
<td>Individual batch operations</td>
<td><code>GET</code>, <code>DELETE</code></td>
<td>Event monitor components</td>
</tr>
<tr>
<td><code>src/app/api/event-job/events/route.ts</code></td>
<td>event-job</td>
<td>Event list and migration</td>
<td><code>GET</code>, <code>POST</code></td>
<td>Event monitor components</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-transform-processing">Transform &amp; Processing ✅<a class="headerlink" href="#reference-file-index-transform-processing" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/lib/transform/transform-service.ts</code></td>
<td>transform</td>
<td>Central transformation service</td>
<td><code>TransformService</code>, transform option interfaces, <code>TransformResult</code></td>
<td>Library components, transform API routes</td>
</tr>
<tr>
<td><code>src/lib/transform/image-extraction-service.ts</code></td>
<td>transform</td>
<td>PDF image extraction and storage</td>
<td><code>ImageExtractionService</code>, <code>ExtractedPageImage</code>, <code>ImageExtractionResult</code></td>
<td>Transform service, external jobs</td>
</tr>
<tr>
<td><code>src/lib/processing/gates.ts</code></td>
<td>processing</td>
<td>Phase gate checking utilities</td>
<td><code>gateExtractPdf</code>, <code>gateTransformTemplate</code>, <code>gateIngestRag</code>, <code>GateContext</code>, <code>GateResult</code></td>
<td>Template decision, external jobs</td>
</tr>
<tr>
<td><code>src/lib/processing/phase-policy.ts</code></td>
<td>processing</td>
<td>Processing phase control policies</td>
<td><code>PhaseDirective</code>, <code>PhasePolicies</code>, policy utilities</td>
<td>External jobs, gates, Secretary API routes</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-shadow-twin-system">Shadow-Twin System ✅<a class="headerlink" href="#reference-file-index-shadow-twin-system" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/lib/shadow-twin/shared.ts</code></td>
<td>shadow-twin</td>
<td>Shared Shadow-Twin types and utilities</td>
<td><code>ShadowTwinState</code>, <code>toMongoShadowTwinState</code></td>
<td>Backend (Job documents), Frontend (Atoms)</td>
</tr>
<tr>
<td><code>src/lib/shadow-twin/analyze-shadow-twin.ts</code></td>
<td>shadow-twin</td>
<td>Shadow-Twin analysis logic</td>
<td><code>analyzeShadowTwin</code></td>
<td>Frontend hooks, job start</td>
</tr>
<tr>
<td><code>src/lib/storage/shadow-twin.ts</code></td>
<td>shadow-twin</td>
<td>Shadow-Twin file and directory utilities</td>
<td><code>generateShadowTwinName</code>, <code>generateShadowTwinFolderName</code>, <code>findShadowTwinFolder</code>, <code>findShadowTwinMarkdown</code></td>
<td>External jobs, gates, analysis</td>
</tr>
<tr>
<td><code>src/lib/external-jobs/shadow-twin-helpers.ts</code></td>
<td>shadow-twin</td>
<td>Shadow-Twin folder creation utilities</td>
<td><code>findOrCreateShadowTwinFolder(provider, parentId, originalName, jobId)</code> → <code>string | undefined</code></td>
<td>External jobs</td>
</tr>
<tr>
<td><code>src/atoms/shadow-twin-atom.ts</code></td>
<td>shadow-twin</td>
<td>Frontend Shadow-Twin state atom</td>
<td><code>shadowTwinStateAtom</code>, <code>FrontendShadowTwinState</code></td>
<td>Library components, file list, file preview</td>
</tr>
<tr>
<td><code>src/hooks/use-shadow-twin-analysis.ts</code></td>
<td>shadow-twin</td>
<td>React hook for Shadow-Twin analysis</td>
<td><code>useShadowTwinAnalysis</code></td>
<td>File list component</td>
</tr>
</tbody>
</table>
<p><strong>Documentation</strong>: See <a href="#architecture-shadow-twin">Shadow-Twin Architecture</a> and <a href="#architecture-pdf-transformation-phases">PDF Transformation Phases</a></p>
<h2 id="reference-file-index-database-repositories">Database Repositories ✅<a class="headerlink" href="#reference-file-index-database-repositories" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/lib/db/chats-repo.ts</code></td>
<td>chat</td>
<td>MongoDB repository for chat management</td>
<td><code>createChat</code>, <code>listChats</code>, <code>getChatById</code>, <code>touchChat</code>, <code>deleteChat</code></td>
<td>Chat API routes, chat components</td>
</tr>
<tr>
<td><code>src/lib/db/queries-repo.ts</code></td>
<td>chat</td>
<td>MongoDB repository for query logging</td>
<td><code>insertQueryLog</code>, <code>appendRetrievalStep</code>, <code>updateQueryLogPartial</code>, <code>getQueryLogById</code>, <code>listRecentQueries</code>, <code>getFilteredDocumentCount(libraryOrId, filter)</code></td>
<td>Chat API routes, chat modules, query logger</td>
</tr>
<tr>
<td><code>src/lib/repositories/doc-meta-repo.ts</code></td>
<td>chat</td>
<td>MongoDB repository for document metadata</td>
<td><code>computeDocMetaCollectionName</code>, <code>ensureFacetIndexes</code>, <code>upsertDocMeta</code>, <code>findDocs</code>, <code>deleteDocMeta</code></td>
<td>Summary retriever, ingestion service</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-api-routes">API Routes ✅<a class="headerlink" href="#reference-file-index-api-routes" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>File Path</th>
<th>Module</th>
<th>Description</th>
<th>Exports</th>
<th>Used In</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/app/api/storage/filesystem/route.ts</code></td>
<td>storage</td>
<td>Filesystem storage API</td>
<td><code>GET</code>, <code>POST</code>, <code>DELETE</code>, <code>PATCH</code></td>
<td>Storage providers</td>
</tr>
<tr>
<td><code>src/app/api/libraries/route.ts</code></td>
<td>library</td>
<td>Library management API</td>
<td><code>GET</code>, <code>POST</code></td>
<td>Settings, storage context</td>
</tr>
</tbody>
</table>
<h2 id="reference-file-index-notes">Notes<a class="headerlink" href="#reference-file-index-notes" title="Permanent link">&para;</a></h2>
<ul>
<li>Files are organized by functional module</li>
<li>✅ = Fully documented with JSDoc headers</li>
<li>Export information completed for documented files</li>
<li>Usage information updated based on dependency analysis</li>
</ul>
<h2 id="reference-file-index-status">Status<a class="headerlink" href="#reference-file-index-status" title="Permanent link">&para;</a></h2>
<ul>
<li>✅ Core Infrastructure: Documented (6 files)</li>
<li>✅ Storage Layer: Documented (10 files)</li>
<li>✅ Library System: Documented (4 files)</li>
<li>✅ Chat System: Documented (9 files)</li>
<li>✅ External Jobs System: Documented (18 files)</li>
<li>✅ Secretary Service: Documented (9 files)</li>
<li>✅ Event Job System: Documented (6 files)</li>
<li>✅ Transform &amp; Processing: Documented (4 files)</li>
<li>✅ Database Repositories: Documented (3 files)</li>
<li>✅ API Routes: Documented (2 files)</li>
<li><strong>Total Documented: 71 files (~16.7% of ~424 files)</strong></li>
<li>⏳ Remaining Components: Pending</li>
<li>⏳ Remaining API Routes: Pending</li>
</ul></section>
                    <section class='print-page md-section' id='section-5-2' heading-number='5.2'>
                        <h1>Modules<a class='headerlink' href='#section-5-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="reference-modules-library" heading-number="5.2.1"><h1 id="reference-modules-library-library-module">Library Module<a class="headerlink" href="#reference-modules-library-library-module" title="Permanent link">&para;</a></h1>
<p>Complete documentation for the Library module.</p>
<h2 id="reference-modules-library-overview">Overview<a class="headerlink" href="#reference-modules-library-overview" title="Permanent link">&para;</a></h2>
<p>The Library module manages library configuration, state, and UI components. Libraries represent collections of files organized by storage backend and user ownership.</p>
<h2 id="reference-modules-library-key-files">Key Files<a class="headerlink" href="#reference-modules-library-key-files" title="Permanent link">&para;</a></h2>
<h3 id="reference-modules-library-types">Types<a class="headerlink" href="#reference-modules-library-types" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/types/library.ts</code></strong>: Complete library type definitions including <code>Library</code>, <code>ClientLibrary</code>, <code>LibraryChatConfig</code>, <code>StorageConfig</code>, and <code>PublicLibraryConfig</code></li>
</ul>
<h3 id="reference-modules-library-state-management">State Management<a class="headerlink" href="#reference-modules-library-state-management" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/atoms/library-atom.ts</code></strong>: Jotai atoms for library state management including active library, folder navigation, and file caching</li>
</ul>
<h3 id="reference-modules-library-service">Service<a class="headerlink" href="#reference-modules-library-service" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/lib/services/library-service.ts</code></strong>: MongoDB-based library service for CRUD operations</li>
</ul>
<h3 id="reference-modules-library-components">Components<a class="headerlink" href="#reference-modules-library-components" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/components/library/library.tsx</code></strong>: Main library component combining file tree, list, and preview</li>
<li><strong><code>src/components/library/library-header.tsx</code></strong>: Library header with switcher and actions</li>
<li><strong><code>src/components/library/library-switcher.tsx</code></strong>: Library selection component</li>
<li><strong><code>src/components/library/file-list.tsx</code></strong>: File list component with header actions and record-level operations</li>
</ul>
<h2 id="reference-modules-library-exports">Exports<a class="headerlink" href="#reference-modules-library-exports" title="Permanent link">&para;</a></h2>
<h3 id="reference-modules-library-types_1">Types<a class="headerlink" href="#reference-modules-library-types_1" title="Permanent link">&para;</a></h3>
<ul>
<li><code>Library</code>: Complete library configuration type</li>
<li><code>ClientLibrary</code>: Client-side library type</li>
<li><code>LibraryChatConfig</code>: Chat/RAG configuration</li>
<li><code>StorageConfig</code>: Storage provider configuration</li>
<li><code>PublicLibraryConfig</code>: Public publishing configuration</li>
<li><code>StorageProviderType</code>: Supported storage provider types</li>
</ul>
<h3 id="reference-modules-library-atoms">Atoms<a class="headerlink" href="#reference-modules-library-atoms" title="Permanent link">&para;</a></h3>
<ul>
<li><code>libraryAtom</code>: Main library state atom</li>
<li><code>activeLibraryIdAtom</code>: Active library ID atom</li>
<li><code>librariesAtom</code>: Libraries list atom</li>
<li><code>activeLibraryAtom</code>: Active library object atom</li>
<li><code>currentFolderIdAtom</code>: Current folder ID atom</li>
<li><code>folderItemsAtom</code>: Folder items atom family</li>
</ul>
<h3 id="reference-modules-library-service_1">Service<a class="headerlink" href="#reference-modules-library-service_1" title="Permanent link">&para;</a></h3>
<ul>
<li><code>LibraryService</code>: Singleton service class for library operations</li>
</ul>
<h3 id="reference-modules-library-components_1">Components<a class="headerlink" href="#reference-modules-library-components_1" title="Permanent link">&para;</a></h3>
<ul>
<li><code>Library</code>: Main library component</li>
<li><code>LibraryHeader</code>: Library header component</li>
<li><code>LibrarySwitcher</code>: Library switcher component</li>
<li><code>FileList</code>: File list component with actions and batch operations</li>
</ul>
<h2 id="reference-modules-library-usage-examples">Usage Examples<a class="headerlink" href="#reference-modules-library-usage-examples" title="Permanent link">&para;</a></h2>
<h3 id="reference-modules-library-accessing-library-state">Accessing Library State<a class="headerlink" href="#reference-modules-library-accessing-library-state" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useAtomValue</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;jotai&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">activeLibraryAtom</span><span class="p">,</span><span class="w"> </span><span class="nx">librariesAtom</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/atoms/library-atom&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">MyComponent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">activeLibrary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useAtomValue</span><span class="p">(</span><span class="nx">activeLibraryAtom</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useAtomValue</span><span class="p">(</span><span class="nx">librariesAtom</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Use library data</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="reference-modules-library-using-library-service">Using Library Service<a class="headerlink" href="#reference-modules-library-using-library-service" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LibraryService</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/services/library-service&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LibraryService</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">getUserLibraries</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">getLibrary</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
</code></pre></div>
<h3 id="reference-modules-library-library-component">Library Component<a class="headerlink" href="#reference-modules-library-library-component" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Library</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/library/library&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">LibraryPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">Library</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="reference-modules-library-using-root-items-hook">Using Root Items Hook<a class="headerlink" href="#reference-modules-library-using-root-items-hook" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useRootItems</span><span class="p">,</span><span class="w"> </span><span class="nx">useRootItemsSync</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/hooks/use-root-items&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">MyComponent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Get function to load root items (async)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">getRootItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRootItems</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Get root items synchronously if already loaded</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rootItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRootItemsSync</span><span class="p">();</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rootItems</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Load root items if not available</span>
<span class="w">      </span><span class="nx">getRootItems</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">items</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Root items loaded:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">getRootItems</span><span class="p">,</span><span class="w"> </span><span class="nx">rootItems</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="reference-modules-library-dependencies">Dependencies<a class="headerlink" href="#reference-modules-library-dependencies" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Storage Layer</strong>: Uses <code>@/lib/storage/storage-factory</code> for provider access</li>
<li><strong>Database</strong>: Uses <code>@/lib/mongodb-service</code> for persistence</li>
<li><strong>State Management</strong>: Uses Jotai for state management</li>
<li><strong>Chat System</strong>: Uses <code>@/lib/chat/constants</code> for chat configuration types</li>
</ul>
<h2 id="reference-modules-library-library-configuration">Library Configuration<a class="headerlink" href="#reference-modules-library-library-configuration" title="Permanent link">&para;</a></h2>
<p>Libraries support:
- <strong>Storage Configuration</strong>: Provider type and authentication
- <strong>Chat Configuration</strong>: RAG settings, target language, character
- <strong>Public Publishing</strong>: Gallery and story mode configuration
- <strong>Gallery Configuration</strong>: Facets, detail view types</p>
<h2 id="reference-modules-library-state-management_1">State Management<a class="headerlink" href="#reference-modules-library-state-management_1" title="Permanent link">&para;</a></h2>
<p>Library state is managed through Jotai atoms with a centralized caching strategy:</p>
<h3 id="reference-modules-library-state-architecture">State Architecture<a class="headerlink" href="#reference-modules-library-state-architecture" title="Permanent link">&para;</a></h3>
<p>The Library module uses a <strong>centralized state management</strong> approach with Jotai atoms:</p>
<ul>
<li><strong>Global State</strong>: Libraries list, active library</li>
<li><strong>Navigation State</strong>: Current folder, path</li>
<li><strong>UI State</strong>: Loading states, selected files</li>
<li><strong>Cache</strong>: Folder items cache for performance</li>
</ul>
<h3 id="reference-modules-library-central-state-logic">Central State Logic<a class="headerlink" href="#reference-modules-library-central-state-logic" title="Permanent link">&para;</a></h3>
<h4 id="reference-modules-library-1-folder-items-cache-folderitemsatom">1. Folder Items Cache (<code>folderItemsAtom</code>)<a class="headerlink" href="#reference-modules-library-1-folder-items-cache-folderitemsatom" title="Permanent link">&para;</a></h4>
<p>The <code>folderItemsAtom</code> is an <strong>atom family</strong> that caches folder contents by folder ID:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Atom family for folder-specific caching</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">folderItemsAtom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">atomFamily</span><span class="p">((</span><span class="nx">folderId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nx">atom</span><span class="o">&lt;</span><span class="nx">StorageItem</span><span class="p">[]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<p><strong>How it works:</strong>
- Each folder has its own cached state
- When <code>currentFolderId === 'root'</code>, root items are cached
- Components can access cached items synchronously without API calls
- Cache is updated when folders are loaded via <code>StorageContext</code></p>
<p><strong>Benefits:</strong>
- Eliminates duplicate API calls for the same folder
- Provides instant access to already-loaded data
- Reduces server load and improves performance</p>
<h4 id="reference-modules-library-2-root-items-central-management-userootitems">2. Root Items Central Management (<code>useRootItems</code>)<a class="headerlink" href="#reference-modules-library-2-root-items-central-management-userootitems" title="Permanent link">&para;</a></h4>
<p>The <code>useRootItems</code> hook provides centralized access to root items:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Hook automatically uses cache if available</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">getRootItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRootItems</span><span class="p">();</span>

<span class="c1">// Synchronous access if root items are already cached</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">rootItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRootItemsSync</span><span class="p">();</span>
</code></pre></div>
<p><strong>How it works:</strong>
- Checks <code>folderItemsAtom</code> if <code>currentFolderId === 'root'</code>
- Falls back to API call via <code>StorageContext.listItems('root')</code>
- Uses request deduplication from <code>StorageContext</code>
- All components share the same cached root items</p>
<p><strong>Integration with StorageContext:</strong>
- <code>StorageContext</code> loads root items once when library is initialized
- Updates <code>folderItemsAtom</code> when root items are loaded
- <code>useRootItems</code> reads from cache, avoiding duplicate requests</p>
<h4 id="reference-modules-library-3-request-deduplication">3. Request Deduplication<a class="headerlink" href="#reference-modules-library-3-request-deduplication" title="Permanent link">&para;</a></h4>
<p>The <code>StorageContext</code> implements request deduplication:</p>
<ul>
<li>Multiple simultaneous requests for the same folder are merged</li>
<li>Only one API call is made, all callers receive the same promise</li>
<li>Prevents duplicate network requests during rapid navigation</li>
</ul>
<h4 id="reference-modules-library-4-state-flow">4. State Flow<a class="headerlink" href="#reference-modules-library-4-state-flow" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>1. User navigates to folder
   ↓
2. StorageContext.listItems(folderId)
   ↓
3. Request deduplication checks for pending requests
   ↓
4. API call (if not cached/deduplicated)
   ↓
5. folderItemsAtom updated with results
   ↓
6. All components using folderItemsAtom receive updates
</code></pre></div>
<h3 id="reference-modules-library-state-atoms-reference">State Atoms Reference<a class="headerlink" href="#reference-modules-library-state-atoms-reference" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Atom</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>libraryAtom</code></td>
<td><code>LibraryState</code></td>
<td>Main library state container</td>
</tr>
<tr>
<td><code>activeLibraryIdAtom</code></td>
<td><code>string</code></td>
<td>Currently active library ID</td>
</tr>
<tr>
<td><code>librariesAtom</code></td>
<td><code>ClientLibrary[]</code></td>
<td>List of all user libraries</td>
</tr>
<tr>
<td><code>activeLibraryAtom</code></td>
<td><code>ClientLibrary \| undefined</code></td>
<td>Active library object (derived)</td>
</tr>
<tr>
<td><code>currentFolderIdAtom</code></td>
<td><code>string</code></td>
<td>Current folder ID (default: 'root')</td>
</tr>
<tr>
<td><code>folderItemsAtom</code></td>
<td><code>atomFamily</code></td>
<td>Folder items cache by folder ID</td>
</tr>
<tr>
<td><code>libraryStatusAtom</code></td>
<td><code>LibraryStatus</code></td>
<td>Library loading status</td>
</tr>
</tbody>
</table>
<h3 id="reference-modules-library-best-practices">Best Practices<a class="headerlink" href="#reference-modules-library-best-practices" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Always use <code>folderItemsAtom</code> for folder contents</strong> - Don't make direct API calls</li>
<li><strong>Use <code>useRootItems</code> for root items</strong> - Provides cache-aware access</li>
<li><strong>Let StorageContext manage loading</strong> - Components should read from atoms, not trigger loads</li>
<li><strong>Cache is automatically updated</strong> - No manual cache invalidation needed</li>
</ol>
<h2 id="reference-modules-library-file-list-component">File List Component<a class="headerlink" href="#reference-modules-library-file-list-component" title="Permanent link">&para;</a></h2>
<p>The <code>FileList</code> component displays files and folders in a table format with header actions and record-level operations.</p>
<h3 id="reference-modules-library-header-actions">Header Actions<a class="headerlink" href="#reference-modules-library-header-actions" title="Permanent link">&para;</a></h3>
<p>The header bar (visible when not in compact mode) provides batch operations:</p>
<table>
<thead>
<tr>
<th>Button</th>
<th>Icon</th>
<th>Function</th>
<th>When Visible</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Refresh</strong></td>
<td><code>RefreshCw</code></td>
<td>Reloads current folder contents</td>
<td>Always</td>
</tr>
<tr>
<td><strong>File Category Filter</strong></td>
<td>Filter icon</td>
<td>Filters files by category (PDF, Audio, Video, etc.)</td>
<td>Always</td>
</tr>
<tr>
<td><strong>Batch Transcription</strong></td>
<td><code>ScrollText</code></td>
<td>Opens transcription dialog for selected audio/video files</td>
<td>When audio/video files are selected</td>
</tr>
<tr>
<td><strong>Batch Transformation</strong></td>
<td><code>Plus</code></td>
<td>Opens transformation dialog for selected PDF files</td>
<td>When PDF files are selected</td>
</tr>
<tr>
<td><strong>Batch Ingest</strong></td>
<td>Text button</td>
<td>Ingests selected documents into RAG system</td>
<td>When PDF/Markdown files are selected</td>
</tr>
<tr>
<td><strong>Bulk Delete</strong></td>
<td><code>Trash2</code></td>
<td>Deletes all selected files</td>
<td>When any files are selected</td>
</tr>
</tbody>
</table>
<p><strong>Usage:</strong>
1. Select files using checkboxes
2. Header buttons appear automatically based on file types selected
3. Click button to perform batch operation
4. Operation runs in background, progress shown per file</p>
<h3 id="reference-modules-library-record-level-actions">Record-Level Actions<a class="headerlink" href="#reference-modules-library-record-level-actions" title="Permanent link">&para;</a></h3>
<p>Each file row provides the following actions:</p>
<table>
<thead>
<tr>
<th>Element</th>
<th>Function</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Checkbox</strong></td>
<td>Select file for batch operations</td>
<td>Leftmost column, enables batch actions</td>
</tr>
<tr>
<td><strong>File Icon</strong></td>
<td>Visual file type indicator</td>
<td>Shows icon based on MIME type (PDF, Audio, Video, Text)</td>
</tr>
<tr>
<td><strong>File Name</strong></td>
<td>Select/Edit file</td>
<td>Click to select, double-click to rename</td>
</tr>
<tr>
<td><strong>Shadow-Twin Icon</strong></td>
<td>View Shadow-Twin files</td>
<td>Blue <code>FileText</code> icon, shows if Shadow-Twin exists (transcript or transformed file or directory)</td>
</tr>
<tr>
<td><strong>Create Transcript</strong></td>
<td>Create new transcript</td>
<td>Plus icon, only shown for transcribable files without Shadow-Twin</td>
</tr>
<tr>
<td><strong>Delete Button</strong></td>
<td>Delete file</td>
<td>Red <code>Trash2</code> icon, deletes file after confirmation</td>
</tr>
</tbody>
</table>
<p><strong>File Interactions:</strong>
- <strong>Single Click</strong>: Selects file (opens in preview)
- <strong>Double Click</strong>: Enters rename mode
- <strong>Long Press</strong> (touch): Opens context menu
- <strong>Drag &amp; Drop</strong>: Reorder files (if supported)</p>
<p><strong>Shadow-Twin Integration:</strong>
- Shadow-Twin files (transcripts and transformed files) are grouped with their base files
- Single Shadow-Twin icon indicates if Shadow-Twin exists (file or directory)
- Clicking Shadow-Twin icon opens the transformed file (if available) or first transcript file
- Shadow-Twin state is automatically analyzed and displayed</p>
<h3 id="reference-modules-library-file-categories">File Categories<a class="headerlink" href="#reference-modules-library-file-categories" title="Permanent link">&para;</a></h3>
<p>Files are automatically categorized:
- <strong>PDF Files</strong>: Can be transformed, transcribed (OCR), and ingested
- <strong>Audio Files</strong>: Can be transcribed and ingested
- <strong>Video Files</strong>: Can be transcribed and ingested
- <strong>Markdown Files</strong>: Can be ingested, may be transcripts or transformed files
- <strong>Other Files</strong>: Display only, limited operations</p>
<h3 id="reference-modules-library-batch-operations">Batch Operations<a class="headerlink" href="#reference-modules-library-batch-operations" title="Permanent link">&para;</a></h3>
<p>Batch operations support multiple files simultaneously:</p>
<ol>
<li><strong>Batch Transcription</strong>: Transcribes multiple audio/video files in parallel</li>
<li><strong>Batch Transformation</strong>: Transforms multiple PDFs to Markdown</li>
<li><strong>Batch Ingestion</strong>: Ingests multiple documents into RAG system</li>
<li><strong>Bulk Delete</strong>: Deletes multiple files at once</li>
</ol>
<p><strong>Selection:</strong>
- Use checkboxes to select individual files
- Selection persists across folder navigation
- Header shows count of selected files</p>
<h2 id="reference-modules-library-api-integration">API Integration<a class="headerlink" href="#reference-modules-library-api-integration" title="Permanent link">&para;</a></h2>
<p>Libraries are managed through:
- <code>GET /api/libraries</code>: Get user libraries
- <code>POST /api/libraries</code>: Create/update library
- <code>GET /api/libraries/[id]</code>: Get specific library
- <code>PUT /api/libraries/[id]</code>: Update library
- <code>DELETE /api/libraries/[id]</code>: Delete library</p></section><section class="print-page" id="reference-modules-storage" heading-number="5.2.2"><h1 id="reference-modules-storage-storage-module">Storage Module<a class="headerlink" href="#reference-modules-storage-storage-module" title="Permanent link">&para;</a></h1>
<p>Complete documentation for the Storage module.</p>
<h2 id="reference-modules-storage-overview">Overview<a class="headerlink" href="#reference-modules-storage-overview" title="Permanent link">&para;</a></h2>
<p>The Storage module provides an abstraction layer for file storage operations across multiple backends. It supports local filesystem and OneDrive storage, with Nextcloud support in development.</p>
<h2 id="reference-modules-storage-key-files">Key Files<a class="headerlink" href="#reference-modules-storage-key-files" title="Permanent link">&para;</a></h2>
<h3 id="reference-modules-storage-core-types">Core Types<a class="headerlink" href="#reference-modules-storage-core-types" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/lib/storage/types.ts</code></strong>: Core type definitions including <code>StorageProvider</code> interface, <code>StorageItem</code>, and <code>StorageValidationResult</code></li>
</ul>
<h3 id="reference-modules-storage-factory-providers">Factory &amp; Providers<a class="headerlink" href="#reference-modules-storage-factory-providers" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/lib/storage/storage-factory.ts</code></strong>: Main factory for creating storage providers</li>
<li><strong><code>src/lib/storage/filesystem-provider.ts</code></strong>: Local filesystem provider implementation</li>
<li><strong><code>src/lib/storage/onedrive-provider.ts</code></strong>: OneDrive provider implementation</li>
<li><strong><code>src/lib/storage/storage-factory-mongodb.ts</code></strong>: MongoDB-based storage factory</li>
</ul>
<h3 id="reference-modules-storage-client-server">Client &amp; Server<a class="headerlink" href="#reference-modules-storage-client-server" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/lib/storage/filesystem-client.ts</code></strong>: Client-side filesystem provider</li>
<li><strong><code>src/lib/storage/server-provider.ts</code></strong>: Server-side provider helper</li>
</ul>
<h3 id="reference-modules-storage-context-hooks">Context &amp; Hooks<a class="headerlink" href="#reference-modules-storage-context-hooks" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/contexts/storage-context.tsx</code></strong>: React context for storage provider management</li>
<li><strong><code>src/hooks/use-storage-provider.tsx</code></strong>: React hook for storage provider access</li>
</ul>
<h3 id="reference-modules-storage-utilities">Utilities<a class="headerlink" href="#reference-modules-storage-utilities" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/lib/storage/supported-types.ts</code></strong>: Supported library type definitions</li>
</ul>
<h2 id="reference-modules-storage-exports">Exports<a class="headerlink" href="#reference-modules-storage-exports" title="Permanent link">&para;</a></h2>
<h3 id="reference-modules-storage-types">Types<a class="headerlink" href="#reference-modules-storage-types" title="Permanent link">&para;</a></h3>
<ul>
<li><code>StorageProvider</code>: Core interface for storage providers</li>
<li><code>StorageItem</code>: Unified type for files and folders</li>
<li><code>StorageItemMetadata</code>: Metadata for storage items</li>
<li><code>StorageValidationResult</code>: Result of validation operations</li>
<li><code>StorageError</code>: Error type for storage operations</li>
</ul>
<h3 id="reference-modules-storage-classes">Classes<a class="headerlink" href="#reference-modules-storage-classes" title="Permanent link">&para;</a></h3>
<ul>
<li><code>StorageFactory</code>: Singleton factory for creating providers</li>
<li><code>FileSystemProvider</code>: Local filesystem provider</li>
<li><code>OneDriveProvider</code>: OneDrive provider</li>
<li><code>FileSystemClient</code>: Client-side filesystem provider</li>
<li><code>MongoDBStorageFactory</code>: MongoDB-based factory</li>
</ul>
<h3 id="reference-modules-storage-functions">Functions<a class="headerlink" href="#reference-modules-storage-functions" title="Permanent link">&para;</a></h3>
<ul>
<li><code>getServerProvider()</code>: Creates server-side storage provider</li>
<li><code>isSupportedLibraryType()</code>: Type guard for library types</li>
<li><code>getSupportedLibraryTypesString()</code>: UI helper for supported types</li>
</ul>
<h2 id="reference-modules-storage-usage-examples">Usage Examples<a class="headerlink" href="#reference-modules-storage-usage-examples" title="Permanent link">&para;</a></h2>
<h3 id="reference-modules-storage-creating-a-provider-client-side">Creating a Provider (Client-side)<a class="headerlink" href="#reference-modules-storage-creating-a-provider-client-side" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/storage-factory&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">factory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">StorageFactory</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">factory</span><span class="p">.</span><span class="nx">getProvider</span><span class="p">(</span><span class="nx">libraryId</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">);</span>
</code></pre></div>
<h3 id="reference-modules-storage-using-storage-context-react">Using Storage Context (React)<a class="headerlink" href="#reference-modules-storage-using-storage-context-react" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useStorage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/contexts/storage-context&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">MyComponent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">provider</span><span class="p">,</span><span class="w"> </span><span class="nx">listItems</span><span class="p">,</span><span class="w"> </span><span class="nx">currentLibrary</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useStorage</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// Use provider for storage operations</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="reference-modules-storage-server-side-provider">Server-side Provider<a class="headerlink" href="#reference-modules-storage-server-side-provider" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/storage/server-provider&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerProvider</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">libraryId</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">provider</span><span class="p">.</span><span class="nx">listItemsById</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">);</span>
</code></pre></div>
<h2 id="reference-modules-storage-dependencies">Dependencies<a class="headerlink" href="#reference-modules-storage-dependencies" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Core Infrastructure</strong>: Uses <code>@/lib/env</code>, <code>@/lib/auth</code>, <code>@/lib/mongodb-service</code></li>
<li><strong>Library System</strong>: Uses <code>@/types/library</code>, <code>@/lib/services/library-service</code></li>
<li><strong>External</strong>: Uses Clerk for authentication, MongoDB for data storage</li>
</ul>
<h2 id="reference-modules-storage-architecture">Architecture<a class="headerlink" href="#reference-modules-storage-architecture" title="Permanent link">&para;</a></h2>
<p>The storage module follows a layered architecture:</p>
<ol>
<li><strong>Types Layer</strong>: Pure type definitions</li>
<li><strong>Provider Layer</strong>: Concrete provider implementations</li>
<li><strong>Factory Layer</strong>: Provider creation and management</li>
<li><strong>Context Layer</strong>: React integration</li>
<li><strong>API Layer</strong>: Server-side route handlers</li>
</ol>
<h2 id="reference-modules-storage-supported-storage-backends">Supported Storage Backends<a class="headerlink" href="#reference-modules-storage-supported-storage-backends" title="Permanent link">&para;</a></h2>
<ul>
<li>✅ <strong>Local File System</strong>: Direct filesystem access</li>
<li>✅ <strong>OneDrive</strong>: Microsoft OneDrive integration</li>
<li>🚧 <strong>Nextcloud</strong>: In development</li>
</ul>
<h2 id="reference-modules-storage-error-handling">Error Handling<a class="headerlink" href="#reference-modules-storage-error-handling" title="Permanent link">&para;</a></h2>
<p>Storage operations use typed errors (<code>StorageError</code>) with error codes:
- <code>HTTP_ERROR</code>: Network/HTTP errors
- <code>AUTH_ERROR</code>: Authentication failures
- <code>NOT_FOUND</code>: Item not found
- <code>VALIDATION_ERROR</code>: Configuration validation failures</p>
<h2 id="reference-modules-storage-performance-optimizations">Performance Optimizations<a class="headerlink" href="#reference-modules-storage-performance-optimizations" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Caching</strong>: Client-side caching for file listings</li>
<li><strong>Request Deduplication</strong>: Prevents duplicate concurrent requests</li>
<li><strong>Lazy Loading</strong>: Providers created on-demand</li>
<li><strong>Connection Pooling</strong>: MongoDB connection reuse</li>
</ul></section><section class="print-page" id="reference-modules-chat" heading-number="5.2.3"><h1 id="reference-modules-chat-chat-module">Chat Module<a class="headerlink" href="#reference-modules-chat-chat-module" title="Permanent link">&para;</a></h1>
<p>Complete documentation for the Chat module.</p>
<h2 id="reference-modules-chat-overview">Overview<a class="headerlink" href="#reference-modules-chat-overview" title="Permanent link">&para;</a></h2>
<p>The Chat module provides RAG-based chat functionality for knowledge exploration. Supports both regular chat mode and story mode with structured topic exploration.</p>
<h2 id="reference-modules-chat-key-files">Key Files<a class="headerlink" href="#reference-modules-chat-key-files" title="Permanent link">&para;</a></h2>
<h3 id="reference-modules-chat-types">Types<a class="headerlink" href="#reference-modules-chat-types" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/types/chat.ts</code></strong>: Chat interface for conversation management</li>
<li><strong><code>src/types/chat-response.ts</code></strong>: Chat response types</li>
<li><strong><code>src/types/chat-processing.ts</code></strong>: Chat processing step types</li>
<li><strong><code>src/types/retriever.ts</code></strong>: Retriever input/output types</li>
</ul>
<h3 id="reference-modules-chat-constants-configuration">Constants &amp; Configuration<a class="headerlink" href="#reference-modules-chat-constants-configuration" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/lib/chat/constants.ts</code></strong>: Central chat configuration definitions</li>
<li><strong><code>src/lib/chat/config.ts</code></strong>: Chat configuration normalization</li>
</ul>
<h3 id="reference-modules-chat-orchestration">Orchestration<a class="headerlink" href="#reference-modules-chat-orchestration" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/lib/chat/orchestrator.ts</code></strong>: Main orchestration for chat response generation</li>
<li><strong><code>src/lib/chat/loader.ts</code></strong>: Library chat context loading</li>
</ul>
<h3 id="reference-modules-chat-retrievers">Retrievers<a class="headerlink" href="#reference-modules-chat-retrievers" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/lib/chat/retrievers/chunks.ts</code></strong>: Chunk-based retriever</li>
<li><strong><code>src/lib/chat/retrievers/summaries-mongo.ts</code></strong>: Summary-based retriever</li>
<li><strong><code>src/lib/chat/retrievers/metadata-extractor.ts</code></strong>: Metadata extraction</li>
</ul>
<h3 id="reference-modules-chat-common-utilities">Common Utilities<a class="headerlink" href="#reference-modules-chat-common-utilities" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/lib/chat/common/prompt.ts</code></strong>: Prompt building utilities</li>
<li><strong><code>src/lib/chat/common/llm.ts</code></strong>: LLM calling utilities</li>
<li><strong><code>src/lib/chat/common/filters.ts</code></strong>: Filter building utilities</li>
<li><strong><code>src/lib/chat/common/question-analyzer.ts</code></strong>: Question analysis for retriever selection</li>
<li><strong><code>src/lib/chat/common/budget.ts</code></strong>: Budget management for source reduction</li>
</ul>
<h3 id="reference-modules-chat-api-routes">API Routes<a class="headerlink" href="#reference-modules-chat-api-routes" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/app/api/chat/[libraryId]/stream/route.ts</code></strong>: Chat streaming endpoint</li>
</ul>
<h2 id="reference-modules-chat-exports">Exports<a class="headerlink" href="#reference-modules-chat-exports" title="Permanent link">&para;</a></h2>
<h3 id="reference-modules-chat-types_1">Types<a class="headerlink" href="#reference-modules-chat-types_1" title="Permanent link">&para;</a></h3>
<ul>
<li><code>Chat</code>: Chat conversation interface</li>
<li><code>ChatResponse</code>: Chat response structure</li>
<li><code>ChatProcessingStep</code>: Processing step types</li>
<li><code>RetrieverInput</code>: Retriever input interface</li>
<li><code>RetrieverOutput</code>: Retriever output interface</li>
<li><code>OrchestratorInput</code>: Orchestration input</li>
<li><code>OrchestratorOutput</code>: Orchestration output</li>
</ul>
<h3 id="reference-modules-chat-constants">Constants<a class="headerlink" href="#reference-modules-chat-constants" title="Permanent link">&para;</a></h3>
<ul>
<li><code>AnswerLength</code>: Answer length type and values</li>
<li><code>Retriever</code>: Retriever method type and values</li>
<li><code>TargetLanguage</code>: Target language type and values</li>
<li><code>Character</code>: Character type and values</li>
<li><code>SocialContext</code>: Social context type and values</li>
</ul>
<h3 id="reference-modules-chat-functions">Functions<a class="headerlink" href="#reference-modules-chat-functions" title="Permanent link">&para;</a></h3>
<ul>
<li><code>runChatOrchestrated()</code>: Main orchestration function</li>
<li><code>analyzeQuestionForRetriever()</code>: Question analysis function</li>
<li><code>buildPrompt()</code>: Prompt building function</li>
<li><code>callOpenAI()</code>: LLM calling function</li>
<li><code>getVectorIndexForLibrary(library, chatConfig?)</code>: Get vector index name for library</li>
</ul>
<h2 id="reference-modules-chat-usage-examples">Usage Examples<a class="headerlink" href="#reference-modules-chat-usage-examples" title="Permanent link">&para;</a></h2>
<h3 id="reference-modules-chat-chat-streaming-api-route">Chat Streaming (API Route)<a class="headerlink" href="#reference-modules-chat-chat-streaming-api-route" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// POST /api/chat/[libraryId]/stream</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/chat/library-id/stream&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;What is this library about?&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">answerLength</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ausführlich&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">chatId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;optional-chat-id&#39;</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="reference-modules-chat-using-chat-orchestrator">Using Chat Orchestrator<a class="headerlink" href="#reference-modules-chat-using-chat-orchestrator" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">runChatOrchestrated</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/orchestrator&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">runChatOrchestrated</span><span class="p">({</span>
<span class="w">  </span><span class="nx">libraryId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;lib-id&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">question</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;What is this about?&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">retriever</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chunk&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">chatConfig</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">targetLanguage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;de&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="reference-modules-chat-getting-vector-index-name">Getting Vector Index Name<a class="headerlink" href="#reference-modules-chat-getting-vector-index-name" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getVectorIndexForLibrary</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/chat/config&#39;</span><span class="p">;</span>

<span class="c1">// Get vector index name for a library</span>
<span class="c1">// Uses config.vectorStore.indexName if set, otherwise derives from library label</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">indexName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getVectorIndexForLibrary</span><span class="p">(</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;lib-id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;My Library&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">vectorStore</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">indexName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;custom-index&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// optional chat config</span>
<span class="p">);</span>
</code></pre></div>
<h2 id="reference-modules-chat-dependencies">Dependencies<a class="headerlink" href="#reference-modules-chat-dependencies" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Library System</strong>: Uses <code>@/lib/services/library-service</code> for library access</li>
<li><strong>Database</strong>: Uses <code>@/lib/mongodb-service</code> for chat and query persistence</li>
<li><strong>Storage</strong>: Uses storage providers for file access</li>
<li><strong>External</strong>: Uses OpenAI API for LLM calls, MongoDB Atlas Vector Search for vector search</li>
</ul>
<h2 id="reference-modules-chat-chat-flow">Chat Flow<a class="headerlink" href="#reference-modules-chat-chat-flow" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>Question Analysis</strong>: Analyze question to recommend retriever</li>
<li><strong>Retrieval</strong>: Retrieve relevant sources using selected retriever</li>
<li><strong>Prompt Building</strong>: Build prompt with sources and configuration</li>
<li><strong>LLM Call</strong>: Call OpenAI API with prompt</li>
<li><strong>Response Parsing</strong>: Parse structured response</li>
<li><strong>Logging</strong>: Log query and response for analytics</li>
</ol>
<h2 id="reference-modules-chat-retriever-types">Retriever Types<a class="headerlink" href="#reference-modules-chat-retriever-types" title="Permanent link">&para;</a></h2>
<ul>
<li><strong><code>chunk</code></strong>: Semantic search in MongoDB Vector Search for specific chunks</li>
<li><strong><code>summary</code></strong>: MongoDB search for document summaries</li>
<li><strong><code>chunkSummary</code></strong>: Loads all chunks from MongoDB without vector search</li>
<li><strong><code>auto</code></strong>: Automatic retriever selection based on question analysis</li>
</ul>
<h2 id="reference-modules-chat-story-mode">Story Mode<a class="headerlink" href="#reference-modules-chat-story-mode" title="Permanent link">&para;</a></h2>
<p>Story mode provides structured topic exploration:
- TOC (Table of Contents) queries
- Structured topic hierarchy
- Narrative exploration of knowledge</p>
<h2 id="reference-modules-chat-configuration-options">Configuration Options<a class="headerlink" href="#reference-modules-chat-configuration-options" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Answer Length</strong>: kurz, mittel, ausführlich, unbegrenzt</li>
<li><strong>Target Language</strong>: de, en, it, fr, es, ar</li>
<li><strong>Character</strong>: Various character perspectives</li>
<li><strong>Social Context</strong>: Formal, informal, technical</li>
<li><strong>Gender Inclusive</strong>: Gender-neutral formulations</li>
</ul></section></section></section></div><style>.print-site-enumerate-headings #index > h1:before { content: '1 ' }

                .print-site-enumerate-headings #index h2:before { content: '1.' counter(counter-index-2) ' ' }
                .print-site-enumerate-headings #index h2 {  counter-reset: counter-index-3 ;  counter-increment: counter-index-2 }
            
                .print-site-enumerate-headings #index h3:before { content: '1.' counter(counter-index-2) '.' counter(counter-index-3) ' ' }
                .print-site-enumerate-headings #index h3 {  counter-increment: counter-index-3 }
            
.print-site-enumerate-headings #section-2 > h1:before { content: '2 ' }
.print-site-enumerate-headings #architecture-module-hierarchy > h1:before { content: '2.1 ' }

                .print-site-enumerate-headings #architecture-module-hierarchy h2:before { content: '2.1.' counter(counter-architecture-module-hierarchy-2) ' ' }
                .print-site-enumerate-headings #architecture-module-hierarchy h2 {  counter-increment: counter-architecture-module-hierarchy-2 }
            
.print-site-enumerate-headings #architecture-dependency-graph > h1:before { content: '2.2 ' }

                .print-site-enumerate-headings #architecture-dependency-graph h2:before { content: '2.2.' counter(counter-architecture-dependency-graph-2) ' ' }
                .print-site-enumerate-headings #architecture-dependency-graph h2 {  counter-increment: counter-architecture-dependency-graph-2 }
            
.print-site-enumerate-headings #architecture-shadow-twin > h1:before { content: '2.3 ' }

                .print-site-enumerate-headings #architecture-shadow-twin h2:before { content: '2.3.' counter(counter-architecture-shadow-twin-2) ' ' }
                .print-site-enumerate-headings #architecture-shadow-twin h2 {  counter-increment: counter-architecture-shadow-twin-2 }
            
.print-site-enumerate-headings #architecture-pdf-transformation-phases > h1:before { content: '2.4 ' }

                .print-site-enumerate-headings #architecture-pdf-transformation-phases h2:before { content: '2.4.' counter(counter-architecture-pdf-transformation-phases-2) ' ' }
                .print-site-enumerate-headings #architecture-pdf-transformation-phases h2 {  counter-increment: counter-architecture-pdf-transformation-phases-2 }
            
.print-site-enumerate-headings #architecture-mongodb-vector-search > h1:before { content: '2.5 ' }

                .print-site-enumerate-headings #architecture-mongodb-vector-search h2:before { content: '2.5.' counter(counter-architecture-mongodb-vector-search-2) ' ' }
                .print-site-enumerate-headings #architecture-mongodb-vector-search h2 {  counter-increment: counter-architecture-mongodb-vector-search-2 }
            
.print-site-enumerate-headings #section-3 > h1:before { content: '3 ' }
.print-site-enumerate-headings #analysis-shadow-twin-v2-only > h1:before { content: '3.1 ' }

                .print-site-enumerate-headings #analysis-shadow-twin-v2-only h2:before { content: '3.1.' counter(counter-analysis-shadow-twin-v2-only-2) ' ' }
                .print-site-enumerate-headings #analysis-shadow-twin-v2-only h2 {  counter-increment: counter-analysis-shadow-twin-v2-only-2 }
            
.print-site-enumerate-headings #analysis-wizard-and-jobs > h1:before { content: '3.2 ' }

                .print-site-enumerate-headings #analysis-wizard-and-jobs h2:before { content: '3.2.' counter(counter-analysis-wizard-and-jobs-2) ' ' }
                .print-site-enumerate-headings #analysis-wizard-and-jobs h2 {  counter-increment: counter-analysis-wizard-and-jobs-2 }
            
.print-site-enumerate-headings #analysis-audio-jobs-transcript-only > h1:before { content: '3.3 ' }

                .print-site-enumerate-headings #analysis-audio-jobs-transcript-only h2:before { content: '3.3.' counter(counter-analysis-audio-jobs-transcript-only-2) ' ' }
                .print-site-enumerate-headings #analysis-audio-jobs-transcript-only h2 {  counter-increment: counter-analysis-audio-jobs-transcript-only-2 }
            
.print-site-enumerate-headings #analysis-ingestion > h1:before { content: '3.4 ' }

                .print-site-enumerate-headings #analysis-ingestion h2:before { content: '3.4.' counter(counter-analysis-ingestion-2) ' ' }
                .print-site-enumerate-headings #analysis-ingestion h2 {  counter-increment: counter-analysis-ingestion-2 }
            
.print-site-enumerate-headings #analysis-storage > h1:before { content: '3.5 ' }

                .print-site-enumerate-headings #analysis-storage h2:before { content: '3.5.' counter(counter-analysis-storage-2) ' ' }
                .print-site-enumerate-headings #analysis-storage h2 {  counter-increment: counter-analysis-storage-2 }
            
.print-site-enumerate-headings #analysis-markdown-page-splitting > h1:before { content: '3.6 ' }

                .print-site-enumerate-headings #analysis-markdown-page-splitting h2:before { content: '3.6.' counter(counter-analysis-markdown-page-splitting-2) ' ' }
                .print-site-enumerate-headings #analysis-markdown-page-splitting h2 {  counter-increment: counter-analysis-markdown-page-splitting-2 }
            
.print-site-enumerate-headings #section-4 > h1:before { content: '4 ' }
.print-site-enumerate-headings #use-cases-index > h1:before { content: '4.1 ' }

                .print-site-enumerate-headings #use-cases-index h2:before { content: '4.1.' counter(counter-use-cases-index-2) ' ' }
                .print-site-enumerate-headings #use-cases-index h2 {  counter-increment: counter-use-cases-index-2 }
            
.print-site-enumerate-headings #use-cases-library-setup > h1:before { content: '4.2 ' }

                .print-site-enumerate-headings #use-cases-library-setup h2:before { content: '4.2.' counter(counter-use-cases-library-setup-2) ' ' }
                .print-site-enumerate-headings #use-cases-library-setup h2 {  counter-increment: counter-use-cases-library-setup-2 }
            
.print-site-enumerate-headings #use-cases-file-transformation-pdf > h1:before { content: '4.3 ' }

                .print-site-enumerate-headings #use-cases-file-transformation-pdf h2:before { content: '4.3.' counter(counter-use-cases-file-transformation-pdf-2) ' ' }
                .print-site-enumerate-headings #use-cases-file-transformation-pdf h2 {  counter-increment: counter-use-cases-file-transformation-pdf-2 }
            
.print-site-enumerate-headings #use-cases-file-transformation-media > h1:before { content: '4.4 ' }

                .print-site-enumerate-headings #use-cases-file-transformation-media h2:before { content: '4.4.' counter(counter-use-cases-file-transformation-media-2) ' ' }
                .print-site-enumerate-headings #use-cases-file-transformation-media h2 {  counter-increment: counter-use-cases-file-transformation-media-2 }
            
.print-site-enumerate-headings #use-cases-file-to-story > h1:before { content: '4.5 ' }

                .print-site-enumerate-headings #use-cases-file-to-story h2:before { content: '4.5.' counter(counter-use-cases-file-to-story-2) ' ' }
                .print-site-enumerate-headings #use-cases-file-to-story h2 {  counter-increment: counter-use-cases-file-to-story-2 }
            
.print-site-enumerate-headings #use-cases-web-scraping > h1:before { content: '4.6 ' }

                .print-site-enumerate-headings #use-cases-web-scraping h2:before { content: '4.6.' counter(counter-use-cases-web-scraping-2) ' ' }
                .print-site-enumerate-headings #use-cases-web-scraping h2 {  counter-increment: counter-use-cases-web-scraping-2 }
            
.print-site-enumerate-headings #use-cases-publishing > h1:before { content: '4.7 ' }

                .print-site-enumerate-headings #use-cases-publishing h2:before { content: '4.7.' counter(counter-use-cases-publishing-2) ' ' }
                .print-site-enumerate-headings #use-cases-publishing h2 {  counter-increment: counter-use-cases-publishing-2 }
            
.print-site-enumerate-headings #use-cases-chat-exploration > h1:before { content: '4.8 ' }

                .print-site-enumerate-headings #use-cases-chat-exploration h2:before { content: '4.8.' counter(counter-use-cases-chat-exploration-2) ' ' }
                .print-site-enumerate-headings #use-cases-chat-exploration h2 {  counter-increment: counter-use-cases-chat-exploration-2 }
            
.print-site-enumerate-headings #use-cases-batch-operations > h1:before { content: '4.9 ' }

                .print-site-enumerate-headings #use-cases-batch-operations h2:before { content: '4.9.' counter(counter-use-cases-batch-operations-2) ' ' }
                .print-site-enumerate-headings #use-cases-batch-operations h2 {  counter-increment: counter-use-cases-batch-operations-2 }
            
.print-site-enumerate-headings #section-5 > h1:before { content: '5 ' }
.print-site-enumerate-headings #reference-file-index > h1:before { content: '5.1 ' }

                .print-site-enumerate-headings #reference-file-index h2:before { content: '5.1.' counter(counter-reference-file-index-2) ' ' }
                .print-site-enumerate-headings #reference-file-index h2 {  counter-increment: counter-reference-file-index-2 }
            
.print-site-enumerate-headings #section-5-2 > h1:before { content: '5.2 ' }
.print-site-enumerate-headings #reference-modules-library > h1:before { content: '5.2.1 ' }

.print-site-enumerate-headings #reference-modules-storage > h1:before { content: '5.2.2 ' }

.print-site-enumerate-headings #reference-modules-chat > h1:before { content: '5.2.3 ' }
</style>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "/docs/", "features": [], "search": "assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="js/print-site.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js"></script>
      
        <script src="assets/javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>