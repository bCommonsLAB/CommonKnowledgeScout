---
name: Pinecone Doc‑Status Cache und UI‑Status (Minimal-invasiv)
overview: ""
todos:
  - id: e3d2d71b-5991-4abf-9957-ea6842c58611
    content: Neue Route upsert-doc-meta implementieren (zero-vector upsert, merge)
    status: pending
  - id: 27b96d2b-49b3-432b-9135-cf73e4b9b02d
    content: Markdown-Speichern hookt upsert-doc-meta mit Statusfeldern
    status: pending
  - id: 418db3a0-b232-422f-9b82-cde97bc4653b
    content: Docs-API um Statusfelder für Listen erweitern
    status: pending
  - id: 502c2853-9b93-463b-8127-5a592f7c73c4
    content: File-Status-API um Statusfelder erweitern
    status: pending
  - id: 3b338d9a-87d8-4026-90db-b0a6ebe6fd8c
    content: "FileList: Datei-Statusicon + Tooltip (alle Statusfelder)"
    status: pending
  - id: 2e187a1b-e58f-448e-b852-93d02d78eb38
    content: Ordnerstatus on-demand per Klick rekursiv aggregieren
    status: pending
  - id: 49a7eb38-699c-453b-9479-bc2f8c79934e
    content: "Vitest: Serializer, API upsert, File-Status, UI smoke"
    status: pending
---

# Pinecone Doc‑Status Cache und UI‑Status (Minimal-invasiv)

## Ziel

- Alle Statusfelder aus Frontmatter/Job in Pinecone (kind:'doc') speichern, ohne Re‑Chunking.
- Datei‑Status in File‑List per Icon + Tooltip anzeigen.
- Ordner‑Aggregation on‑demand per Klick, zunächst clientseitig.

## Kernideen

- Neuer API‑Handler `/api/chat/[libraryId]/upsert-doc-meta `aktualisiert `${fileId}-meta`:
- Wenn vorhanden: Metadaten mergen und upserten.
- Wenn nicht vorhanden: 0‑Vektor der Index‑Dimension nutzen und upserten (Filter‑only Nutzung).
- Speichert: flache Statusfelder (primitive), komplettes Frontmatter als `docMetaJson`.
- Pipeline‑Hook: Nach Schreiben des Markdown (Frontmatter) den neuen Handler aufrufen.
- APIs:
- `/api/chat/[libraryId]/docs` um Statusfelder erweitern (für Galerie/Listenansicht).
- `/api/chat/[libraryId]/file-status` um Statusfelder erweitern (für Einzeldatei + Debug).
- UI: `src/components/library/file-list.tsx` zeigt Status‑Icon je Datei (Tooltip listet alle Statusfelder). Ordner‑Icon löst on‑demand Rekursion aus, die Child‑Dateien lädt und Status aggregiert.

## Metadaten in Pinecone

- Flach (primitive): `extract_status`, `template_status`, `ingest_status`, `process_status`, `hasError`, `errorCode`, `errorMessage` (max ~512 chars), `lastErrorAt`, `upsertedAt`, `docModifiedAt`.
- Facetten (optional, primitive/strings): `year`, `language`, `region`, `docType`, `source`, `isScan`, `pageCount`, `authors[]`, `tags[]`.
- Voll: `docMetaJson` (Stringified Frontmatter – schemaflexibel, Quelle für Tooltips).

## Wichtige Stellen/Dateien

- API neu: `src/app/api/chat/[libraryId]/upsert-doc-meta/route.ts` (Clerk‑Auth, Index‑dim read, upsertVectorsChunked, Merge‑Logik)
- Pipeline Hook(s):
- `src/lib/transform/transform-service.ts` (nach `createMarkdownWithFrontmatter` und Speichern: fetch Status + call upsert‑doc‑meta)
- Zusätzlich im Secretary‑Flow: `src/app/api/secretary/process-pdf/route.ts` und `src/app/api/external/jobs/[jobId]/route.ts` beim Übergang der Schritte Status upserten
- APIs erweitern:
- `src/app/api/chat/[libraryId]/docs/route.ts `– Statusfelder aus `docMetaJson`/flach mappen
- `src/app/api/chat/[libraryId]/file-status/route.ts` – Statusfelder ergänzen
- UI: `src/components/library/file-list.tsx` – Status‑Icon + Tooltip, on‑demand Ordner‑Aggregation (staged)

## Essenzielle Snippets (vereinfacht)

- Upsert Doc‑Meta (neu):
```ts
// in /api/chat/[libraryId]/upsert-doc-meta/route.ts
const dim = idx.dimension || Number(process.env.OPENAI_EMBEDDINGS_DIMENSION||3072)
const zero = Array(dim).fill(0)
const id = `${fileId}-meta`
const metadata = { kind:'doc', user:userEmail, libraryId, fileId, fileName, upsertedAt:new Date().toISOString(), docMetaJson: JSON.stringify(frontmatter), ...statusFlat }
await upsertVectorsChunked(idx.host, apiKey, [{ id, values: zero, metadata }])
```




- Statusfeldernormierung (nur primitive/strings/list<string>): Kürzen `errorMessage`, `authors`/`tags` zu `string[]`.

## Tests (Vitest, Integration)

- Serializer testet Trunkierung und Typen.
- API upsert‑doc‑meta: erfolgreicher Upsert (mock pinecone).
- File‑Status API gibt Status korrekt zurück.
- Klick im File‑List zeigt Tooltip mit Status.

## Risiken/Follow‑ups

- Datei‑Move: Falls `fileId` path‑basiert ist, Meta kann verwaisen → späteres „Re‑Keying“ bei Move‑Events oder Hash‑Based stable ID.